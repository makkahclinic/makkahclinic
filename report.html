<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ø¥Ø¨Ù„Ø§Øº - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0a4c8b; --secondary: #1a936f; --accent: #f9a826; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; }
        .form-input[readonly] { background-color: #f3f4f6; cursor: not-allowed; color: #4b5563; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #334155; }
        .form-label.required::after { content: " *"; color: #dc2626; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 1rem; transition: all 0.3s ease; background-color: #f8fafc; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(249, 168, 38, 0.3); }
        .form-input.invalid, .form-select.invalid, .form-textarea.invalid, .grid.invalid, #locationSelector.invalid { border-color: #dc2626; }
        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #144c63 100%); color: white; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .radio-card input:checked + label { border-color: var(--primary); background-color: #f0f9ff; box-shadow: 0 0 0 2px var(--accent); }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="container max-w-4xl w-full">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden" id="formContainer">
            <header class="bg-gradient-to-br from-[var(--primary)] to-[var(--secondary)] text-white p-6 sm:p-8 text-center">
                <h1 class="text-2xl sm:text-3xl font-bold">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</h1>
                <p class="text-lg sm:text-xl mt-2 opacity-90">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ø¥Ø¨Ù„Ø§Øº</p>
            </header>
            
            <div id="form-content-wrapper">
                <div class="p-6 sm:p-8">
                    <div id="progressBar" class="mb-8"></div>

                    <form id="unifiedForm" novalidate>
                        <!-- Steps will be populated by JS -->
                        <div class="form-step" data-step="1"></div>
                        <div class="form-step hidden" data-step="2"></div>
                        <div class="form-step hidden" data-step="3"></div>
                        <div class="form-step hidden" data-step="4"></div>
                        <div class="form-step hidden" data-step="5"></div>
                    </form>

                    <div class="form-actions mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                        <button type="button" id="prevBtn" class="btn btn-secondary hidden">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                        <button type="button" id="nextBtn" class="btn btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        <button type="submit" id="submitBtn" form="unifiedForm" class="btn btn-primary hidden">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
                    </div>
                </div>
            </div>

            <div id="success-screen" class="p-8 text-center hidden">
                <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-green-100"><svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h2 class="mt-6 text-2xl font-bold text-slate-800">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§ØºÙƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
                <p class="mt-2 text-slate-600">Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ. Ø³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§Øº.</p>
                <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                    <button type="button" id="newReportBtn" class="btn btn-primary">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</button>
                    <a href="#" onclick="window.location.reload()" class="btn btn-secondary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg flex items-center gap-3 transform translate-x-[150%] transition-transform duration-500 ease-in-out z-50">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span id="toastMessage"></span>
    </div>

    <script>
    (function() {
        let currentStep = 1;
        let totalSteps = 5;
        let selectedLocations = [];
        let attachedFiles = [];
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwkWblpYB4Todpot1E532hU8Ug_JydCwX02g9UHOhS42A7D_1BO3iyQnqUaM-pWCNNKcw/exec";
        const locations = [ { code: "DIR-B-01", name: "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…" }, { code: "ADM-B-01", name: "Ø¨Ù„Ø§Ù„" }, { code: "ADM-B-02", name: "Ø£/ Ø¹Ø¯Ù†Ø§Ù†" }, { code: "INS-B-01", name: "Ø£/ ØµØ§Ø¨Ø±" }, { code: "INS-B-02", name: "Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©" }, { code: "CSSD-B-01", name: "Ø§Ù„ØªØ¹Ù‚ÙŠÙŠÙ…" }, { code: "CSSD-B-02", name: "Ø§Ù„ØºØ³ÙŠÙ„" }, { code: "RAD-B-01", name: "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø§Ø´Ø¹Ø©" }, { code: "RAD-B-02", name: "Ultrasound" }, { code: "RAD-B-03", name: "X-ray and Panorama" }, { code: "FAC-B-01", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡" }, { code: "LAB-B-01", name: "Ø§Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¯Ù…" }, { code: "LAB-B-02", name: "Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø§Ù„Ø­ÙŠÙˆÙŠØ©" }, { code: "LAB-B-03", name: "Ø¹Ù„Ù… Ø§Ù„Ø·ÙÙŠÙ„ÙŠØ§Øª" }, { code: "ADM-B-03", name: "Ù…ÙƒØªØ¨ Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª" }, { code: "REC-G-01", name: "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø§ÙˆÙ„" }, { code: "FAC-G-01", name: "Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª" }, { code: "GP-G-01", name: "Ø¯ÙƒØªÙˆØ± Ø¬Ø¹ÙØ± ÙˆØ­Ø³Ù†" }, { code: "WMF-G-01", name: "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†Ø³Ø§Ø¡" }, { code: "WMR-G-01", name: "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¬Ø§Ù„" }, { code: "MED-G-01", name: "Ø¯ÙƒØªÙˆØ± Ù…Ø­Ù…Ø¯" }, { code: "MED-G-02", name: "Ø¯ÙƒØªÙˆØ± Ù…Ø¬Ø¯ÙŠ" }, { code: "ER-G-01", name: "ØºØ±ÙØ© Ø§Ù„Ø§Ù†Ø¹Ø§Ø´ Ø§Ù„Ù‚Ù„Ø¨ÙŠ Ø§Ù„Ø±Ø¦ÙˆÙŠ" }, { code: "VS-G-01", name: "Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©" }, { code: "BD-G-01", name: "ØºØ±ÙØ© Ø³Ø­Ø¨ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª" }, { code: "OBG-G-01", name: "ØºØ±ÙØ© Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø·Ø¨ÙŠ" }, { code: "OBG-G-02", name: "ØºØ±ÙØ© Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©" }, { code: "OBG-G-03", name: "ØºØ±ÙØ© Ù…Ø§Ø¨Ø¹Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©" }, { code: "ER-G-01", name: "Ø·ÙˆØ§Ø±Ø¦ Ø±Ø¬Ø§Ù„" }, { code: "ER-G-02", name: "Ø·ÙˆØ§Ø±Ø¦ Ù†Ø³Ø§Ø¡" }, { code: "FAC-G-02", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ø±Ø¬Ø§Ù„" }, { code: "FAC-G-03", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ù†Ø³Ø§Ø¡" }, { code: "FAC-G-04", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ù†Ø³Ø§Ø¡" }, { code: "REC-1-01", name: "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù‚Ø³Ù… Ø§Ù„Ø§Ø³Ù†Ø§Ù†" }, { code: "DEN-1-01", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ù…Ø¹Ø§Ø°" }, { code: "DEN-1-02", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ù…Ø¹Ø§Ø°" }, { code: "DEN-1-03", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø¹Ø²Ø§Ù… Ø§Ù„ÙŠØ§Ø³ÙŠ" }, { code: "DEN-1-04", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ù†ÙˆØ±Ø§ Ø­Ø¨Ø´ÙŠ" }, { code: "DEN-1-05", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø§Ù„Ø¹Ù†ÙˆØ¯ Ø§Ù„Ø²Ø¨ÙŠØ¯ÙŠ" }, { code: "DEN-1-06", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø±Ø´Ø§ Ø±Ø¬Ø¨" }, { code: "ORTH-1-07", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø±Ø¨ÙŠØ¹Ø© ØªØ¨Ø³Ù…" }, { code: "ADM-1-01", name: "Ù…ÙƒØªØ¨ Ø¯/Ø®Ø§Ù„Ø¯" }, { code: "WMR-1-01", name: "Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø§Ø³Ù†Ø§Ù†" }, { code: "WMR-1-02", name: "Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø·Ù†Ø©-Ø§Ù„Ø¹ÙŠÙˆÙ†-Ø§Ù„Ø¹Ø¸Ø§Ù…" }, { code: "WMF-1-01", name: "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†Ø³Ø§Ø¡" }, { code: "FAC-1-01", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ø§Ù„Ù†Ø³Ø§Ø¡" }, { code: "FAC-1-02", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ø§Ù„Ø±Ø¬Ø§Ù„" }, { code: "OPH-1-01", name: "Ø¹ÙŠØ§Ø¯Ø©/ Ø´Ø°Ø§" }, { code: "MED-1-01", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø­Ù…Ø§Ø¯Ø© Ù†Ø¬Ø§Ø­" }, { code: "MED-1-02", name: "Ø¹ÙŠØ§Ø¯Ø© Ø§Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¯ÙƒØªÙˆØ± Ø­Ù…Ø§Ø¯Ø©" }, { code: "MED-1-03", name: "Ø¹ÙŠØ§Ø¯Ø© Ù…Ø¬Ù‡Ø²Ø©" }, { code: "ADM-1-02", name: "Ù…ÙƒØªØ¨ ÙØ§Ø±Øº" }, { code: "FAC-1-03", name: "Ø§Ø³ØªØ±Ø§Ø­Ø© Ù…ÙˆØ¸ÙØ§Øª" } ];
        
        const dom = {
            form: document.getElementById('unifiedForm'),
            nextBtn: document.getElementById('nextBtn'),
            prevBtn: document.getElementById('prevBtn'),
            submitBtn: document.getElementById('submitBtn'),
            formContentWrapper: document.getElementById('form-content-wrapper'),
            successScreen: document.getElementById('success-screen'),
            newReportBtn: document.getElementById('newReportBtn'),
            progressBar: document.getElementById('progressBar')
        };

        const getCurrentLocalISOString = () => {
            const now = new Date();
            const timezoneOffset = now.getTimezoneOffset() * 60000;
            return new Date(now - timezoneOffset).toISOString().slice(0, 16);
        };

        const renderProgressBar = () => {
            dom.progressBar.innerHTML = `
                <div class="flex justify-between items-center relative">
                    <div class="absolute top-1/2 -translate-y-1/2 w-full h-1 bg-slate-200"></div>
                    <div id="progress-bar-line" class="absolute top-1/2 -translate-y-1/2 w-0 h-1 bg-[var(--accent)] transition-all duration-500"></div>
                    ${[1, 2, 3, 4, 5].map(i => `
                        <div class="progress-step z-10 flex flex-col items-center" data-step="${i}">
                            <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg transition-all duration-300 bg-slate-200 text-slate-500">${i}</div>
                            <div class="step-label mt-2 text-xs text-center text-slate-500 font-semibold"></div>
                        </div>
                    `).join('')}
                </div>`;
        };

        const renderStepContent = () => {
            document.querySelector('.form-step[data-step="1"]').innerHTML = `
                <h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 1: Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</h2>
                <div class="form-group"><label for="reportCategory" class="form-label required">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label><select id="reportCategory" name="reportCategory" class="form-select" required><option value="" disabled selected>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</option><option value="Ø­Ø§Ø¯Ø«">Ø¨Ù„Ø§Øº Ø­Ø§Ø¯Ø«/Ù…Ø®Ø§Ø·Ø±</option><option value="Ø´ÙƒÙˆÙ‰">Ø´ÙƒÙˆÙ‰ Ù…Ø±ÙŠØ¶/Ù…Ø±Ø§Ø¬ÙØ¹</option></select><p class="error-message"></p></div>`;
            
            document.querySelector('.form-step[data-step="2"]').innerHTML = `
                <h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 2: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h2>
                <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="form-group md:col-span-2"><label class="form-label required">Ù…Ù† Ù‡Ùˆ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¨Ù„Ø§ØºØŸ</label><div class="grid grid-cols-2 gap-4 mt-2"><div class="radio-card"><input type="radio" name="reporterType" id="reporterEmployee" value="employee" class="sr-only" required><label for="reporterEmployee" class="flex flex-col items-center justify-center text-center p-4 border-2 border-slate-200 rounded-lg cursor-pointer"><span>ğŸ‘¨â€âš•ï¸</span><span class="font-semibold mt-2 text-slate-700">Ù…ÙˆØ¸Ù</span></label></div><div class="radio-card"><input type="radio" name="reporterType" id="reporterPatient" value="patient" class="sr-only" required><label for="reporterPatient" class="flex flex-col items-center justify-center text-center p-4 border-2 border-slate-200 rounded-lg cursor-pointer"><span>ğŸ‘¤</span><span class="font-semibold mt-2 text-slate-700">Ù…Ø±ÙŠØ¶/Ø²Ø§Ø¦Ø±</span></label></div></div><p class="error-message"></p></div>
                    <div id="employee-reporter-fields" class="md:col-span-2 grid md:grid-cols-2 gap-x-6 gap-y-4 hidden">
                        <div class="form-group"><label for="reporterName" class="form-label required">Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù„Ù‘Øº</label><input type="text" id="reporterName" name="reporterName" class="form-input"><p class="error-message"></p></div>
                        <div class="form-group">
                            <label for="reporterJob" class="form-label required">Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
                            <select id="reporterJob" name="reporterJob" class="form-select" required>
                                <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¸ÙŠÙØ©...</option>
                                <option value="Ø·Ø¨ÙŠØ¨">Ø·Ø¨ÙŠØ¨</option>
                                <option value="Ù…Ù…Ø±Ø¶">Ù…Ù…Ø±Ø¶</option>
                                <option value="Ø§Ø¯Ø§Ø±ÙŠ">Ø§Ø¯Ø§Ø±ÙŠ</option>
                                <option value="Ø§Ø³ØªÙ‚Ø¨Ø§Ù„">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                                <option value="Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©">Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©</option>
                                <option value="Ø³Ø§Ø¦Ù‚">Ø³Ø§Ø¦Ù‚</option>
                                <option value="other">Ø£Ø®Ø±Ù‰</option>
                            </select>
                            <input type="text" id="reporterJobOther" name="reporterJobOther" class="form-input mt-2 hidden" placeholder="ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ø®Ø±Ù‰">
                            <p class="error-message"></p>
                        </div>
                    </div>
                    <div id="patient-reporter-fields" class="md:col-span-2 grid md:grid-cols-2 gap-x-6 gap-y-4 hidden"><div class="form-group"><label for="patientName" class="form-label required">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶/Ø§Ù„Ø²Ø§Ø¦Ø±</label><input type="text" id="patientName" name="patientName" class="form-input"><p class="error-message"></p></div><div class="form-group"><label for="patientPhone" class="form-label required">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label><input type="tel" id="patientPhone" name="patientPhone" class="form-input"><p class="error-message"></p></div></div>
                    <div class="form-group md:col-span-2 relative"><label for="locationSelector" class="form-label required">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><div id="locationSelector" class="form-input cursor-pointer flex justify-between items-center"><span>Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹...</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-slate-400"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"/></svg></div><div id="locationDropdown" class="absolute top-full right-0 w-full bg-white border border-slate-300 rounded-md shadow-lg max-h-60 overflow-y-auto z-20 hidden"><input type="text" id="locationSearch" placeholder="Ø§Ø¨Ø­Ø«..." class="form-input sticky top-0 m-1 w-[calc(100%-0.5rem)] z-10"><div id="locationOptionsContainer"></div></div><div id="selectedLocations" class="mt-2 flex flex-wrap gap-2"></div><p class="error-message"></p></div>
                    <div class="form-group"><label for="reportNumber" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº</label><input type="text" id="reportNumber" name="reportNumber" class="form-input" readonly></div>
                    <div class="form-group"><label for="reportDateTime" class="form-label">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ù„Ø§Øº</label><input type="datetime-local" id="reportDateTime" name="reportDateTime" class="form-input" readonly></div>
                </div>`;
            
            document.querySelector('.form-step[data-step="5"]').innerHTML = `
                <h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø®ÙŠØ±: Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„</h2>
                <div class="form-group"><label for="attachments" class="form-label">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><div class="mt-2 flex justify-center rounded-lg border border-dashed border-slate-900/25 px-6 py-10 cursor-pointer" id="dropzone"><div class="text-center"><svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg><div class="mt-4 flex text-sm"><label for="attachments" class="relative cursor-pointer rounded-md bg-white font-semibold text-[var(--primary)]"><span>Ø§Ø±ÙØ¹ Ù…Ù„ÙÙ‹Ø§</span><input id="attachments" name="attachments" type="file" class="sr-only" multiple></label><p class="pr-1">Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡ ÙˆØ£ÙÙ„ØªÙ‡ Ù‡Ù†Ø§</p></div><p class="text-xs text-slate-600">PNG, JPG, PDF up to 10MB</p></div></div><div id="file-list" class="mt-4 space-y-2"></div></div>`;
        };

        const initializeForm = () => {
            const reportDateTimeField = document.getElementById('reportDateTime');
            reportDateTimeField.value = getCurrentLocalISOString();
            generateReportNumber();
        };

        const attachEventListeners = () => {
            dom.nextBtn.addEventListener('click', handleNextStep);
            dom.prevBtn.addEventListener('click', handlePrevStep);
            dom.form.addEventListener('submit', handleFormSubmit);
            dom.newReportBtn.addEventListener('click', resetForm);
            document.getElementById('reportCategory').addEventListener('change', () => {
                generateReportNumber();
                setupDynamicSteps();
            });
            document.querySelectorAll('input[name="reporterType"]').forEach(radio => radio.addEventListener('change', handleReporterTypeChange));

            const reporterJobSelect = document.getElementById('reporterJob');
            if (reporterJobSelect) {
                reporterJobSelect.addEventListener('change', e => {
                    const otherInput = document.getElementById('reporterJobOther');
                    if (otherInput) {
                        const isOther = e.target.value === 'other';
                        otherInput.classList.toggle('hidden', !isOther);
                        otherInput.required = isOther;
                        if (!isOther) otherInput.value = '';
                    }
                });
            }

            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('attachments');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropzone.addEventListener(eName, e => {e.preventDefault(); e.stopPropagation();}));
            ['dragenter', 'dragover'].forEach(eName => dropzone.addEventListener(eName, () => dropzone.classList.add('bg-slate-100')));
            ['dragleave', 'drop'].forEach(eName => dropzone.addEventListener(eName, () => dropzone.classList.remove('bg-slate-100')));
            dropzone.addEventListener('drop', e => addFiles(e.dataTransfer.files));
            fileInput.addEventListener('change', e => {
                addFiles(e.target.files);
                e.target.value = '';
            });
            initializeLocationPicker();
        };

        const generateReportNumber = () => {
            const type = document.getElementById('reportCategory').value;
            const year = new Date().getFullYear();
            const serial = Date.now().toString().slice(-5);
            let code = "MMC-REP-";
            if (type === 'Ø­Ø§Ø¯Ø«') code = `IR-RISK-${year}-${serial}`;
            else if (type === 'Ø´ÙƒÙˆÙ‰') code = `RPT-PAT-${year}-${serial}`;
            else code += serial;
            document.getElementById('reportNumber').value = code;
        };

        const isPatientReporter = () => {
            const reporterType = document.querySelector('input[name="reporterType"]:checked');
            return reporterType && reporterType.value === 'patient';
        };

        const handleReporterTypeChange = e => {
            const employeeFields = document.getElementById('employee-reporter-fields');
            const patientFields = document.getElementById('patient-reporter-fields');
            totalSteps = e.target.value === 'employee' ? 5 : 4;
            employeeFields.classList.toggle('hidden', e.target.value !== 'employee');
            patientFields.classList.toggle('hidden', e.target.value !== 'patient');
        };

        const handleNextStep = () => {
            if (validateCurrentStep()) {
                let nextStep = currentStep + 1;
                if (isPatientReporter() && nextStep === 4) nextStep = 5;
                if (nextStep <= 5) showStep(nextStep);
            }
        };

        const handlePrevStep = () => {
            let prevStep = currentStep - 1;
            if (isPatientReporter() && prevStep === 4) prevStep = 3;
            if (prevStep >= 1) showStep(prevStep);
        };
        
        const showStep = stepNumber => {
            currentStep = stepNumber;
            document.querySelectorAll('.form-step').forEach(s => s.classList.add('hidden'));
            document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('hidden');
            updateProgressBar();
            updateNavigationButtons();
        };

        const updateProgressBar = () => {
            const steps = document.querySelectorAll('.progress-step');
            const line = document.getElementById('progress-bar-line');
            const labels = ["Ø§Ù„ØªØµÙ†ÙŠÙ", "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "Ø§Ù„ØªÙØ§ØµÙŠÙ„", "Ø§Ù„ØªØ­Ù„ÙŠÙ„", "Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"];
            
            steps.forEach((step, index) => {
                const stepNum = index + 1;
                const circle = step.querySelector('.step-circle');
                const label = step.querySelector('.step-label');
                
                step.style.display = (isPatientReporter() && stepNum === 4) ? 'none' : 'flex';
                label.textContent = labels[index];
                if (isPatientReporter() && stepNum === 5) {
                    circle.textContent = '4';
                } else {
                    circle.textContent = stepNum;
                }

                let effectiveCurrent = isPatientReporter() && currentStep === 5 ? 4 : currentStep;
                let effectiveStep = isPatientReporter() && stepNum === 5 ? 4 : (isPatientReporter() && stepNum > 4 ? stepNum-1 : stepNum);
                
                circle.classList.remove('bg-green-500', 'bg-[var(--primary)]', 'text-white', 'bg-slate-200', 'text-slate-500');

                if (effectiveStep < effectiveCurrent) {
                    circle.classList.add('bg-green-500', 'text-white');
                    circle.innerHTML = '&#10003;';
                } else if (effectiveStep === effectiveCurrent) {
                    circle.classList.add('bg-[var(--primary)]', 'text-white');
                    if(circle.innerHTML === 'âœ“') circle.textContent = isPatientReporter() && stepNum === 5 ? '4' : stepNum;
                } else {
                    circle.classList.add('bg-slate-200', 'text-slate-500');
                    if(circle.innerHTML === 'âœ“') circle.textContent = isPatientReporter() && stepNum === 5 ? '4' : stepNum;
                }
            });
            const progress = (( (isPatientReporter() && currentStep === 5 ? 4 : currentStep) - 1) / (totalSteps - 1)) * 100;
            line.style.width = `${progress}%`;
        };
        
        const updateNavigationButtons = () => {
            dom.prevBtn.classList.toggle('hidden', currentStep === 1);
            const isLast = (isPatientReporter() && currentStep === 5) || (!isPatientReporter() && currentStep === totalSteps);
            dom.nextBtn.classList.toggle('hidden', isLast);
            dom.submitBtn.classList.toggle('hidden', !isLast);
        };

        const setupDynamicSteps = () => {
            const isComplaint = document.getElementById('reportCategory').value === 'Ø´ÙƒÙˆÙ‰';
            document.querySelector('.form-step[data-step="3"]').innerHTML = isComplaint ? getComplaintHTML() : getIncidentHTML();
            document.querySelector('.form-step[data-step="4"]').innerHTML = getAnalysisHTML();
            attachDynamicListeners();
        };
        
        const getIncidentHTML = () => `<h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 3: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ø¯Ø«</h2><div class="grid md:grid-cols-2 gap-x-6 gap-y-4"><div class="form-group"><label for="incidentDateTime" class="form-label required">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª ÙˆÙ‚ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø«</label><input type="datetime-local" id="incidentDateTime" name="incidentDateTime" class="form-input" value="${getCurrentLocalISOString()}" required><p class="error-message"></p></div><div class="form-group md:col-span-2"><label for="incidentDescription" class="form-label required">ÙˆØµÙ Ù…ÙˆØ¬Ø² Ù„Ù…Ø§ Ø­Ø¯Ø«</label><textarea id="incidentDescription" name="incidentDescription" class="form-textarea" rows="4" placeholder="ØµÙ Ù…Ø§ Ø­Ø¯Ø« Ø¨Ø§Ù„ØªÙØµÙŠÙ„..." required></textarea><p class="error-message"></p></div></div>`;
        const getComplaintHTML = () => `<h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 3: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰</h2><div class="grid md:grid-cols-2 gap-x-6 gap-y-4"><div class="form-group md:col-span-2"><label for="complaintDescription" class="form-label required">ÙˆØµÙ Ø§Ù„Ø´ÙƒÙˆÙ‰</label><textarea id="complaintDescription" name="complaintDescription" class="form-textarea" rows="4" placeholder="ØµÙ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø§Ù„ØªÙØµÙŠÙ„..." required></textarea><p class="error-message"></p></div></div>`;
        const getAnalysisHTML = () => `<h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 4: Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2><div class="space-y-6"><div><h3 class="font-bold text-lg text-slate-700 mb-4">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø·ÙˆØ±Ø© (SAC Matrix)</h3><div class="grid md:grid-cols-2 gap-6"><div class="p-4 rounded-lg"><label for="severity" class="form-label required">Ø´Ø¯Ø© Ø§Ù„Ø¹ÙˆØ§Ù‚Ø¨</label><select id="severity" name="severity" class="form-select mt-1" required><option value="">Ø§Ø®ØªØ±...</option><option value="1">Ù…Ù†Ø®ÙØ¶Ø©</option><option value="2">Ù…ØªÙˆØ³Ø·Ø©</option><option value="3">Ø¹Ø§Ù„ÙŠØ©</option><option value="4">Ø­Ø±Ø¬Ø©</option></select></div><div class="p-4 rounded-lg"><label for="likelihood" class="form-label required">Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø±</label><select id="likelihood" name="likelihood" class="form-select mt-1" required><option value="">Ø§Ø®ØªØ±...</option><option value="1">Ù†Ø§Ø¯Ø±</option><option value="2">Ù…Ù…ÙƒÙ†</option><option value="3">Ù…Ø­ØªÙ…Ù„</option><option value="4">Ø´Ø¨Ù‡ Ù…Ø¤ÙƒØ¯</option></select></div></div><div id="riskLevel" class="mt-4 p-4 rounded-lg font-bold text-center hidden"></div></div><div class="form-group bg-slate-50 p-4 rounded-lg border border-slate-200"><div class="flex items-center"><input type="checkbox" id="rcaRequired" name="rcaRequired" class="h-4 w-4 rounded border-gray-300 text-[var(--primary)] focus:ring-[var(--primary)]"><label for="rcaRequired" class="mr-3 block text-sm font-medium text-slate-800">ÙŠØªØ·Ù„Ø¨ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠØ© (RCA)</label></div></div><div id="rcaSection" class="hidden space-y-4 border-t border-slate-200 pt-6 mt-6"><h3 class="font-bold text-lg text-slate-700">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠØ© (ÙˆÙÙ‚Ù‹Ø§ Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø³Ø¨Ø§Ù‡ÙŠ)</h3><div class="form-group"><label class="form-label">Ø§Ø®ØªØ± Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„:</label><div class="flex gap-x-6"><div class="flex items-center"><input type="radio" id="rcaMethod5Whys" name="rcaMethod" value="5whys" class="h-4 w-4 text-[var(--primary)] focus:ring-[var(--primary)]"><label for="rcaMethod5Whys" class="mr-2">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø®Ù…Ø³Ø© (5 Whys)</label></div><div class="flex items-center"><input type="radio" id="rcaMethodFishbone" name="rcaMethod" value="fishbone" class="h-4 w-4 text-[var(--primary)] focus:ring-[var(--primary)]"><label for="rcaMethodFishbone" class="mr-2">Ù…Ø®Ø·Ø· Ø§Ù„Ø³Ø¨Ø¨ ÙˆØ§Ù„Ø£Ø«Ø± (Fishbone)</label></div></div></div><div id="fiveWhysSection" class="hidden space-y-3">${[1,2,3,4,5].map(i=>`<div class="form-group"><label for="why${i}" class="form-label text-sm font-medium">Ù„Ù…Ø§Ø°Ø§ØŸ (${i})</label><input type="text" id="why${i}" name="why${i}" class="form-input"></div>`).join('')}</div><div id="fishboneSection" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">${['Ø§Ù„Ø£ÙØ±Ø§Ø¯ (People)','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Process)','Ø§Ù„Ù…Ø¹Ø¯Ø§Øª (Equipment)','Ø§Ù„Ø¨ÙŠØ¦Ø© (Environment)','Ø§Ù„Ù…ÙˆØ§Ø¯ (Materials)','Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Management)'].map(c=>`<div class="form-group"><label for="fishbone-${c.split(' ')[0]}" class="form-label text-sm font-medium">${c}</label><textarea id="fishbone-${c.split(' ')[0]}" name="fishbone-${c.split(' ')[0]}" class="form-textarea" rows="2" placeholder="Ø¹ÙˆØ§Ù…Ù„ Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ù€ ${c.split(' ')[0]}..."></textarea></div>`).join('')}</div><textarea id="rcaAnalysis" name="rcaAnalysis" class="hidden"></textarea><p id="rcaError" class="error-message"></p></div><div><h3 class="font-bold text-lg text-slate-700 mb-4">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</h3>${getActionsHTML()}</div></div>`;
        const getActionsHTML = () => `<div class="space-y-4"><div class="form-group"><label for="correctiveActions" class="form-label required">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</label><textarea id="correctiveActions" name="correctiveActions" class="form-textarea" rows="4" required></textarea><p class="error-message"></p></div><div class="grid md:grid-cols-2 gap-x-6 gap-y-4"><div class="form-group"><label for="responsiblePersonSelect" class="form-label required">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªÙ†ÙÙŠØ°</label><select id="responsiblePersonSelect" name="responsiblePersonSelect" class="form-select" required><option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„...</option><option value="Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ</option><option value="Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ…Ø±ÙŠØ¶">Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ…Ø±ÙŠØ¶</option><option value="Ù…Ø¯ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©">Ù…Ø¯ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©</option><option value="Ù…Ø¯ÙŠØ± Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰">Ù…Ø¯ÙŠØ± Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰</option><option value="Ù…Ø´Ø±Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„">Ù…Ø´Ø±Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option><option value="Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ£Ù…ÙŠÙ†">Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ£Ù…ÙŠÙ†</option><option value="Ù…Ø¯ÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª / Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ">Ù…Ø¯ÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª / Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</option><option value="Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©">Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©</option><option value="Ù…Ø´Ø±Ù Ø§Ù„Ù†Ø¸Ø§ÙØ©">Ù…Ø´Ø±Ù Ø§Ù„Ù†Ø¸Ø§ÙØ©</option><option value="other">Ø£Ø®Ø±Ù‰ (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯)</option></select><input type="text" id="responsiblePersonOther" name="responsiblePersonOther" class="form-input mt-2 hidden" placeholder="Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¢Ø®Ø±"><p class="error-message"></p></div><div class="form-group"><label for="completionDate" class="form-label required">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¥ØªÙ…Ø§Ù…</label><input type="date" id="completionDate" name="completionDate" class="form-input" required><p class="error-message"></p></div></div></div>`;

        const attachDynamicListeners = () => {
            document.getElementById('severity')?.addEventListener('change', calculateRiskLevel);
            document.getElementById('likelihood')?.addEventListener('change', calculateRiskLevel);
            document.getElementById('responsiblePersonSelect')?.addEventListener('change', e => {
                const otherInput = document.getElementById('responsiblePersonOther');
                otherInput.classList.toggle('hidden', e.target.value !== 'other');
                otherInput.required = e.target.value === 'other';
                if(e.target.value !== 'other') otherInput.value = '';
            });
            document.getElementById('rcaRequired')?.addEventListener('change', e => {
                const rcaSection = document.getElementById('rcaSection');
                rcaSection.classList.toggle('hidden', !e.target.checked);
                if (!e.target.checked) {
                    document.querySelectorAll('input[name="rcaMethod"]').forEach(r => r.checked = false);
                    document.getElementById('fiveWhysSection').classList.add('hidden');
                    document.getElementById('fishboneSection').classList.add('hidden');
                }
            });
            document.querySelectorAll('input[name="rcaMethod"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    document.getElementById('rcaError').textContent = '';
                    document.getElementById('fiveWhysSection').classList.toggle('hidden', e.target.value !== '5whys');
                    document.getElementById('fishboneSection').classList.toggle('hidden', e.target.value !== 'fishbone');
                });
            });
        };
        
        const calculateRiskLevel = () => {
            const severity = parseInt(document.getElementById('severity').value);
            const likelihood = parseInt(document.getElementById('likelihood').value);
            const riskDiv = document.getElementById('riskLevel');
            if (!severity || !likelihood) { riskDiv.classList.add('hidden'); return; }
            const score = severity * likelihood;
            let level, className;
            if (score >= 9) { level = 'Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ©'; className = 'bg-red-100 text-red-800'; }
            else if (score >= 4) { level = 'Ø®Ø·ÙˆØ±Ø© Ù…ØªÙˆØ³Ø·Ø©'; className = 'bg-yellow-100 text-yellow-800'; }
            else { level = 'Ø®Ø·ÙˆØ±Ø© Ù…Ù†Ø®ÙØ¶Ø©'; className = 'bg-green-100 text-green-800'; }
            riskDiv.textContent = level;
            riskDiv.className = `mt-4 p-4 rounded-lg font-bold text-center ${className}`;
        };
        
        const validateCurrentStep = () => {
            let isValid = true;
            const stepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
            stepEl.querySelectorAll('select[required], input[required], textarea[required]').forEach(field => {
                const formGroup = field.closest('.form-group');
                const isVisible = !!(field.offsetWidth || field.offsetHeight || field.getClientRects().length);
                if (isVisible && formGroup) { // Check if field is visible and within a form-group
                    if (!validateField(field)) isValid = false;
                }
            });
            if (currentStep === 2 && selectedLocations.length === 0) {
                const locSelector = document.getElementById('locationSelector');
                locSelector.classList.add('invalid');
                locSelector.parentElement.querySelector('.error-message').textContent = 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹.';
                isValid = false;
            }
            if (currentStep === 4 && document.getElementById('rcaRequired')?.checked) {
                const selectedMethod = document.querySelector('input[name="rcaMethod"]:checked');
                const rcaError = document.getElementById('rcaError');
                if (!selectedMethod) {
                    rcaError.textContent = 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„.';
                    isValid = false;
                } else {
                    let hasContent = false;
                    if (selectedMethod.value === '5whys') hasContent = !!document.getElementById('why1').value.trim();
                    else if (selectedMethod.value === 'fishbone') document.getElementById('fishboneSection').querySelectorAll('textarea').forEach(ta => { if(ta.value.trim()) hasContent = true; });
                    
                    if (!hasContent) {
                        rcaError.textContent = 'ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø­Ù‚Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.';
                        isValid = false;
                    } else {
                        rcaError.textContent = '';
                    }
                }
            }
            return isValid;
        };

        const validateField = (field) => {
            let valid = true;
            const formGroup = field.closest('.form-group');
            if (!formGroup) return true; 
            const errorP = formGroup.querySelector('.error-message');
            let elementToValidate = field;

            if (field.type === 'radio') {
                const container = field.closest('.form-group');
                elementToValidate = container.querySelector('.grid');
                if (!container.querySelector(`input[name="${field.name}"]:checked`)) valid = false;
            } else if (!field.value.trim()) {
                valid = false;
            }
            
            if (elementToValidate) elementToValidate.classList.toggle('invalid', !valid);
            if (errorP) errorP.textContent = valid ? '' : 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨.';
            return valid;
        };

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!validateCurrentStep()) return;
            dom.submitBtn.innerHTML = '<span>â³</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            dom.submitBtn.disabled = true;

            if (document.getElementById('rcaRequired')?.checked) {
                const selectedMethod = document.querySelector('input[name="rcaMethod"]:checked');
                const rcaAnalysisTextarea = document.getElementById('rcaAnalysis');
                let analysisText = '';
                if (selectedMethod?.value === '5whys') {
                    analysisText = "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠØ© (5 Whys):\n";
                    for (let i = 1; i <= 5; i++) {
                        const input = document.getElementById(`why${i}`);
                        if (input.value.trim()) analysisText += `Ù„Ù…Ø§Ø°Ø§ ${i}: ${input.value.trim()}\n`;
                    }
                } else if (selectedMethod?.value === 'fishbone') {
                    analysisText = "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠØ© (Fishbone):\n";
                    document.getElementById('fishboneSection').querySelectorAll('textarea').forEach(ta => {
                        if (ta.value.trim()) {
                            const label = ta.parentElement.querySelector('label').textContent;
                            analysisText += `${label}: ${ta.value.trim()}\n`;
                        }
                    });
                }
                rcaAnalysisTextarea.value = analysisText;
            }

            const formData = new FormData(dom.form);
            const data = Object.fromEntries(formData.entries());
            data.selectedLocations = selectedLocations.map(l => `${l.code} - ${l.name}`).join(', ');
            if (data.responsiblePersonSelect === 'other') data.responsiblePerson = data.responsiblePersonOther;
            else data.responsiblePerson = data.responsiblePersonSelect;
            if (data.reporterJob === 'other') data.reporterJob = data.reporterJobOther;

            data.attachments = attachedFiles.length > 0 ? await Promise.all(attachedFiles.map(fileToBase64)) : [];
            
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' })
            .then(() => {
                showToast('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­!');
                dom.formContentWrapper.classList.add('hidden');
                dom.successScreen.classList.remove('hidden');
            }).catch(error => {
                console.error('Error:', error);
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.', true);
            }).finally(() => {
                dom.submitBtn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº';
                dom.submitBtn.disabled = false;
            });
        }

        function resetForm() {
            dom.successScreen.classList.add('hidden');
            dom.formContentWrapper.classList.remove('hidden');
            dom.form.reset();
            selectedLocations = []; attachedFiles = [];
            updateFileList();
            document.getElementById('selectedLocations').innerHTML = '';
            document.getElementById('locationSelector').querySelector('span').textContent = 'Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹...';
            document.getElementById('employee-reporter-fields').classList.add('hidden');
            document.getElementById('patient-reporter-fields').classList.add('hidden');
            totalSteps = 5;
            showStep(1);
            initializeForm();
        }

        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            toast.classList.toggle('bg-red-500', isError);
            toast.classList.toggle('bg-green-500', !isError);
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('translate-x-[150%]');
            setTimeout(() => toast.classList.add('translate-x-[150%]'), 3000);
        };
        
        const addFiles = files => {
            const newFiles = Array.from(files).filter(f => !attachedFiles.some(ef => ef.name === f.name && ef.size === f.size));
            attachedFiles.push(...newFiles);
            updateFileList();
        };

        const updateFileList = () => {
            const fileListContainer = document.getElementById('file-list');
            fileListContainer.innerHTML = '';
            attachedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between bg-slate-100 p-2 rounded-md text-sm';
                fileItem.innerHTML = `<div class="flex items-center gap-2 overflow-hidden"><svg class="w-5 h-5 text-slate-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg><span class="font-medium text-slate-700 truncate">${file.name}</span><span class="text-slate-500 flex-shrink-0">(${(file.size/1024).toFixed(1)} KB)</span></div><button type="button" data-index="${index}" class="remove-file-btn text-red-500 hover:text-red-700 font-bold text-xl px-2">&times;</button>`;
                fileListContainer.appendChild(fileItem);
            });
            document.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    attachedFiles.splice(parseInt(e.currentTarget.dataset.index, 10), 1);
                    updateFileList();
                });
            });
        };

        const fileToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve({fileName: file.name, mimeType: file.type, base64: reader.result.split(',')[1]});
            reader.onerror = error => reject(error);
        });

        const initializeLocationPicker = () => {
            const selector = document.getElementById('locationSelector');
            const dropdown = document.getElementById('locationDropdown');
            selector.addEventListener('click', () => dropdown.classList.toggle('hidden'));
            document.addEventListener('click', e => {
                if (!selector.parentElement.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            document.getElementById('locationSearch').addEventListener('input', e => renderLocationOptions(e.target.value));
            renderLocationOptions();
        };

        const renderLocationOptions = (filter = '') => {
            const container = document.getElementById('locationOptionsContainer');
            container.innerHTML = '';
            const filtered = locations.filter(loc => loc.name.toLowerCase().includes(filter.toLowerCase()) || loc.code.toLowerCase().includes(filter.toLowerCase()));
            filtered.forEach(location => {
                const isSelected = selectedLocations.some(sl => sl.code === location.code);
                const option = document.createElement('div');
                option.className = 'p-2 hover:bg-slate-100 cursor-pointer flex items-center';
                option.innerHTML = `<input type="checkbox" id="loc-${location.code}" class="ml-3 accent-[var(--primary)]" ${isSelected ? 'checked' : ''}><label for="loc-${location.code}" class="flex-grow cursor-pointer">${location.code} - ${location.name}</label>`;
                container.appendChild(option);
                option.querySelector('input').addEventListener('change', e => {
                    if (e.target.checked) {
                        if (!selectedLocations.some(l => l.code === location.code)) selectedLocations.push(location);
                    } else {
                        selectedLocations = selectedLocations.filter(l => l.code !== location.code);
                    }
                    updateSelectedLocationTags();
                });
            });
        };
        
        const updateSelectedLocationTags = () => {
            const container = document.getElementById('selectedLocations');
            const selectorSpan = document.getElementById('locationSelector').querySelector('span');
            container.innerHTML = '';
            selectorSpan.textContent = selectedLocations.length === 0 ? 'Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹...' : `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${selectedLocations.length} Ù…ÙˆÙ‚Ø¹`;
            selectedLocations.forEach(location => {
                const tag = document.createElement('div');
                tag.className = 'bg-[var(--accent)] text-white text-sm font-semibold px-3 py-1 rounded-full flex items-center gap-2';
                tag.innerHTML = `<span>${location.code}</span><button type="button" data-code="${location.code}" class="font-bold text-lg leading-none">&times;</button>`;
                container.appendChild(tag);
                tag.querySelector('button').addEventListener('click', e => {
                    const code = e.target.dataset.code;
                    selectedLocations = selectedLocations.filter(l => l.code !== code);
                    const checkbox = document.getElementById(`loc-${code}`);
                    if (checkbox) checkbox.checked = false;
                    updateSelectedLocationTags();
                });
            });
            const locSelector = document.getElementById('locationSelector');
            locSelector.classList.remove('invalid');
            locSelector.parentElement.querySelector('.error-message').textContent = '';
        };
        
        // Initial setup
        renderProgressBar();
        renderStepContent();
        initializeForm();
        attachEventListeners();
        showStep(1);
    })();
    </script>
</body>
</html>

