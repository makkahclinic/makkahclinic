<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±ÙØ¹ Ø¨Ù„Ø§Øº Ø´ÙƒÙˆÙ‰ - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0a4c8b; --secondary: #1a936f; --accent: #f9a826; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; }
        .form-input[readonly] { background-color: #f3f4f6; cursor: not-allowed; color: #4b5563; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #334155; }
        .form-label.required::after { content: " *"; color: #dc2626; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 1rem; transition: all 0.3s ease; background-color: #f8fafc; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(249, 168, 38, 0.3); }
        .form-input.invalid, .form-select.invalid, .form-textarea.invalid, .grid.invalid, #locationSelector.invalid { border-color: #dc2626; }
        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #144c63 100%); color: white; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .radio-card input:checked + label { border-color: var(--primary); background-color: #f0f9ff; box-shadow: 0 0 0 2px var(--accent); }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="container max-w-4xl w-full">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden" id="formContainer">
            <header class="bg-gradient-to-br from-[var(--primary)] to-[var(--secondary)] text-white p-6 sm:p-8 text-center">
                <h1 class="text-2xl sm:text-3xl font-bold">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</h1>
                <p class="text-lg sm:text-xl mt-2 opacity-90">Ø±ÙØ¹ Ø¨Ù„Ø§Øº Ø´ÙƒÙˆÙ‰</p>
            </header>

            <div id="form-content-wrapper">
                <div class="p-6 sm:p-8">
                    <div id="progressBar" class="mb-8"></div>

                    <form id="unifiedForm" novalidate>
                        <div class="form-step" data-step="1"></div>
                        <div class="form-step hidden" data-step="2"></div>
                        <div class="form-step hidden" data-step="3"></div>
                        <div class="form-step hidden" data-step="4"></div>
                    </form>

                    <div class="form-actions mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                        <button type="button" id="prevBtn" class="btn btn-secondary hidden">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                        <button type="button" id="nextBtn" class="btn btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        <button type="submit" id="submitBtn" form="unifiedForm" class="btn btn-primary hidden">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰</button>
                    </div>
                </div>
            </div>

            <div id="success-screen" class="p-8 text-center hidden">
                <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-green-100"><svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h2 class="mt-6 text-2xl font-bold text-slate-800">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø´ÙƒÙˆØ§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
                <p class="mt-2 text-slate-600">Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ. Ø³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØ§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©.</p>
                <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                    <button type="button" id="newReportBtn" class="btn btn-primary">ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©</button>
                    <a href="mega.html" class="btn btn-secondary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ù‚Ù…ÙŠ</a>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg flex items-center gap-3 transform translate-x-[150%] transition-transform duration-500 ease-in-out z-50">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span id="toastMessage"></span>
    </div>

    <script>
    (function() {
        let currentStep = 1;
        let totalSteps = 4;
        let selectedLocations = [];
        let attachedFiles = [];
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE0nbyfYrDZeOHr6TuEQP7ivpOLF1pLmBFoF7fkDmNjQp5g6dW4i0xkcSBJJRaoOCVAw/exec";
        
        // Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ - ØªÙØ­Ù…Ù‘Ù„ Ù…Ù† Google Sheet Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        let locations = [];
        let locationsLoaded = false;
        
        async function loadLocationsFromSheet() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getLocations');
                const data = await response.json();

                if (data.ok && Array.isArray(data.locations) && data.locations.length > 0) {
                    locations = data.locations;
                    locationsLoaded = true;
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„', locations.length, 'Ù…ÙˆÙ‚Ø¹ Ù…Ù† Apps Script');
                    updateLocationSelector();
                    return;
                }

                throw new Error('No locations returned from Apps Script');
            } catch (err) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù† Apps Script:', err);
                locations = [];
                locationsLoaded = true;

                const selector = document.getElementById('locationSelector');
                if (selector) selector.innerHTML = '<div style="color:#dc2626;">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù† Ø§Ù„Ø´ÙŠØª</div>';
            }
        }
        
        function useDefaultLocations() {
            locations = [
                { code: "DENTAL", name: "Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ù†Ø§Ù†" },
                { code: "RAD", name: "Ù‚Ø³Ù… Ø§Ù„Ø£Ø´Ø¹Ø©" },
                { code: "OBGYN", name: "Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø§Ø¡ ÙˆØ§Ù„ÙˆÙ„Ø§Ø¯Ø©" },
                { code: "LAB", name: "Ø§Ù„Ù…Ø®ØªØ¨Ø±" },
                { code: "ER", name: "Ø§Ù„Ø·ÙˆØ§Ø±Ø¦" },
                { code: "CSSD", name: "Ø§Ù„ØªØ¹Ù‚ÙŠÙ…" },
                { code: "EYES", name: "Ù‚Ø³Ù… Ø§Ù„Ø¹ÙŠÙˆÙ†" },
                { code: "PHARMACY", name: "Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©" }
            ];
            locationsLoaded = true;
        }
        
        function updateLocationSelector() {
            const selector = document.getElementById('locationSelector');
            if (selector && locations.length > 0) {
                selector.innerHTML = locations.map(loc => `
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" name="locations" value="${loc.code}" class="location-checkbox w-4 h-4 accent-[var(--primary)]">
                        <span class="text-sm">${loc.name}</span>
                    </label>
                `).join('');
            }
        }

        const dom = {
            form: document.getElementById('unifiedForm'),
            nextBtn: document.getElementById('nextBtn'),
            prevBtn: document.getElementById('prevBtn'),
            submitBtn: document.getElementById('submitBtn'),
            formContentWrapper: document.getElementById('form-content-wrapper'),
            successScreen: document.getElementById('success-screen'),
            newReportBtn: document.getElementById('newReportBtn'),
            progressBar: document.getElementById('progressBar')
        };

        const getCurrentLocalISOString = () => {
            const now = new Date();
            const timezoneOffset = now.getTimezoneOffset() * 60000;
            return new Date(now - timezoneOffset).toISOString().slice(0, 16);
        };
        
        const complaintCategories = [
            { id: 'financial', name: 'Ø´ÙƒÙˆÙ‰ Ù…Ø§Ù„ÙŠØ©', icon: 'ğŸ’°', subs: ['ØªØ£Ø®Ø± Ø±ÙˆØ§ØªØ¨', 'Ø®ØµÙˆÙ…Ø§Øª ØºÙŠØ± Ù…Ø¨Ø±Ø±Ø©', 'Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…ØªØ£Ø®Ø±Ø©', 'Ø£Ø®Ø±Ù‰'] },
            { id: 'equipment', name: 'Ù†Ù‚Øµ Ù…Ø¹Ø¯Ø§Øª', icon: 'ğŸ”§', subs: ['Ø£Ø¬Ù‡Ø²Ø© Ø·Ø¨ÙŠØ©', 'Ù…Ø¹Ø¯Ø§Øª Ù…ÙƒØªØ¨ÙŠØ©', 'Ø£Ø¯ÙˆØ§Øª Ø¹Ù…Ù„', 'Ø£Ø®Ø±Ù‰'] },
            { id: 'staffing', name: 'Ù†Ù‚Øµ ÙƒÙˆØ§Ø¯Ø±', icon: 'ğŸ‘¥', subs: ['ØªÙ…Ø±ÙŠØ¶', 'Ø®Ø¯Ù…ÙŠØ©/Ù†Ø¸Ø§ÙØ©', 'Ø¥Ø¯Ø§Ø±ÙŠ', 'ÙÙ†ÙŠ', 'Ø£Ø®Ø±Ù‰'] },
            { id: 'maintenance', name: 'Ø´ÙƒÙˆÙ‰ ØµÙŠØ§Ù†Ø©', icon: 'ğŸ› ï¸', subs: ['Ù…ÙƒÙŠÙ Ø¹Ø§Ø·Ù„', 'Ø§Ù†Ù‚Ø·Ø§Ø¹ Ù…ÙŠØ§Ù‡', 'Ø­Ù…Ø§Ù… Ø®Ø±Ø¨Ø§Ù†', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'Ù„ÙˆØ­Ø§Øª Ù…ÙƒØ³ÙˆØ±Ø©', 'Ù„Ù…Ø¨Ø§Øª', 'ØªØ´ÙˆÙ‡Ø§Øª Ø¨ØµØ±ÙŠØ©', 'Ù†Ø¸Ø§ÙØ© Ø®Ø§Ø±Ø¬ÙŠØ©', 'Ø£Ø®Ø±Ù‰'] },
            { id: 'behavior', name: 'Ø´ÙƒÙˆÙ‰ Ø³Ù„ÙˆÙƒ', icon: 'âš ï¸', subs: ['ØªØ¹Ø¯ÙŠ Ù„ÙØ¸ÙŠ', 'ØªØ¹Ø¯ÙŠ Ø¬Ø³Ø¯ÙŠ', 'Ø¥Ù‡Ø§Ù†Ø©', 'ØªØ­Ø±Ø´', 'Ø£Ø®Ø±Ù‰'] },
            { id: 'medical', name: 'Ø´ÙƒÙˆÙ‰ Ø·Ø¨ÙŠØ©', icon: 'ğŸ©º', subs: ['Ø¶Ø¯ Ø·Ø¨ÙŠØ¨', 'Ø¶Ø¯ Ù…Ù…Ø±Ø¶', 'Ø¶Ø¯ Ù…Ø±ÙŠØ¶', 'Ø®Ø·Ø£ Ø·Ø¨ÙŠ', 'ØªØ£Ø®Ø± Ø¹Ù„Ø§Ø¬', 'Ø£Ø®Ø±Ù‰'] },
            { id: 'administrative', name: 'Ø´ÙƒÙˆÙ‰ Ø¥Ø¯Ø§Ø±ÙŠØ©', icon: 'ğŸ“‹', subs: ['Ø¶Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„', 'Ø¶Ø¯ Ù…Ø¯ÙŠØ±', 'Ø¶Ø¯ Ù…ÙˆØ¸Ù', 'ØªØ£Ø®Ø± Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª', 'Ø£Ø®Ø±Ù‰'] },
            { id: 'materials', name: 'Ù†Ù‚Øµ Ù…ÙˆØ§Ø¯', icon: 'ğŸ“¦', subs: ['Ù…ÙˆØ§Ø¯ Ø£Ø³Ù†Ø§Ù†', 'Ù…ÙˆØ§Ø¯ Ø·Ø¨ÙŠØ©', 'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ù…Ø®ØªØ¨Ø±', 'Ø£Ø¯ÙˆÙŠØ©', 'Ø£Ø®Ø±Ù‰'] }
        ];
        
        let selectedCategory = null;
        let selectedSeverity = null;
        
        function initCategorySelectors() {
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('border-[var(--accent)]', 'bg-amber-100', 'shadow-lg'));
                    this.classList.add('border-[var(--accent)]', 'bg-amber-100', 'shadow-lg');
                    selectedCategory = this.dataset.category;
                    document.getElementById('primaryCategory').value = selectedCategory;
                    const cat = complaintCategories.find(c => c.id === selectedCategory);
                    if (cat && cat.subs.length > 0) {
                        const subSelect = document.getElementById('subcategory');
                        subSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ...</option>' + cat.subs.map(s => `<option value="${s}">${s}</option>`).join('');
                        document.getElementById('subcategorySection').style.display = 'block';
                    }
                    document.getElementById('categoryError').textContent = '';
                });
            });
            
            document.querySelectorAll('.severity-option input').forEach(input => {
                input.addEventListener('change', function() {
                    document.querySelectorAll('.severity-card').forEach(c => c.classList.remove('ring-4', 'ring-offset-2'));
                    this.nextElementSibling.classList.add('ring-4', 'ring-offset-2');
                    if (this.value === 'high') this.nextElementSibling.classList.add('ring-red-400');
                    else if (this.value === 'medium') this.nextElementSibling.classList.add('ring-yellow-400');
                    else this.nextElementSibling.classList.add('ring-blue-400');
                    selectedSeverity = this.value;
                    document.getElementById('severityError').textContent = '';
                });
            });
        }

        const renderProgressBar = () => {
            dom.progressBar.innerHTML = `
                <div class="flex justify-between items-center relative">
                    <div class="absolute top-1/2 -translate-y-1/2 w-full h-1 bg-slate-200"></div>
                    <div id="progress-bar-line" class="absolute top-1/2 -translate-y-1/2 w-0 h-1 bg-[var(--accent)] transition-all duration-500"></div>
                    ${[1, 2, 3, 4].map(i => `
                        <div class="progress-step z-10 flex flex-col items-center" data-step="${i}">
                            <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg transition-all duration-300 bg-slate-200 text-slate-500">${i}</div>
                            <div class="step-label mt-2 text-xs text-center text-slate-500 font-semibold"></div>
                        </div>
                    `).join('')}
                </div>`;
        };

        const renderStepContent = () => {
            document.querySelector('.form-step[data-step="1"]').innerHTML = `
                <h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 1: ØªØµÙ†ÙŠÙ Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
                
                <div class="form-group mb-4">
                    <label for="complaintType" class="form-label required">Ù†ÙˆØ¹ Ø§Ù„Ø´Ø§ÙƒÙŠ</label>
                    <select id="complaintType" name="complaintType" class="form-select" required>
                        <option value="" disabled selected>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø´Ø§ÙƒÙŠ...</option>
                        <option value="Ø´ÙƒÙˆÙ‰ Ù…ÙˆØ¸Ù">Ø´ÙƒÙˆÙ‰ Ù…ÙˆØ¸Ù</option>
                        <option value="Ø´ÙƒÙˆÙ‰ Ù…Ø±ÙŠØ¶">Ø´ÙƒÙˆÙ‰ Ù…Ø±ÙŠØ¶</option>
                        <option value="Ø´ÙƒÙˆÙ‰ Ø²Ø§Ø¦Ø±">Ø´ÙƒÙˆÙ‰ Ø²Ø§Ø¦Ø±</option>
                    </select>
                    <p class="error-message"></p>
                </div>
                
                <div class="form-group mb-4">
                    <label class="form-label required">ØªØµÙ†ÙŠÙ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                    <div id="categoryGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        ${complaintCategories.map(cat => `
                            <div class="category-card cursor-pointer border-2 border-slate-200 rounded-xl p-4 text-center hover:border-[var(--accent)] hover:bg-amber-50 transition-all" data-category="${cat.id}">
                                <div class="text-3xl mb-2">${cat.icon}</div>
                                <div class="font-bold text-sm text-slate-700">${cat.name}</div>
                            </div>
                        `).join('')}
                    </div>
                    <input type="hidden" id="primaryCategory" name="primaryCategory" required>
                    <p id="categoryError" class="error-message"></p>
                </div>
                
                <div class="form-group mb-4" id="subcategorySection" style="display:none;">
                    <label class="form-label required">Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ</label>
                    <select id="subcategory" name="subcategory" class="form-select">
                        <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ...</option>
                    </select>
                    <p class="error-message"></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©</label>
                    <div id="severitySelector" class="flex gap-4 justify-center flex-wrap">
                        <label class="severity-option cursor-pointer">
                            <input type="radio" name="severity" value="high" class="hidden">
                            <div class="severity-card border-2 border-red-300 rounded-xl p-4 text-center hover:bg-red-50 transition-all" style="min-width:100px;">
                                <div class="text-2xl mb-1">ğŸ”´</div>
                                <div class="font-bold text-red-600">Ø¹Ø§Ù„ÙŠØ©</div>
                                <div class="text-xs text-slate-500">ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„ ÙÙˆØ±ÙŠ</div>
                            </div>
                        </label>
                        <label class="severity-option cursor-pointer">
                            <input type="radio" name="severity" value="medium" class="hidden">
                            <div class="severity-card border-2 border-yellow-300 rounded-xl p-4 text-center hover:bg-yellow-50 transition-all" style="min-width:100px;">
                                <div class="text-2xl mb-1">ğŸŸ¡</div>
                                <div class="font-bold text-yellow-600">Ù…ØªÙˆØ³Ø·Ø©</div>
                                <div class="text-xs text-slate-500">ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</div>
                            </div>
                        </label>
                        <label class="severity-option cursor-pointer">
                            <input type="radio" name="severity" value="low" class="hidden">
                            <div class="severity-card border-2 border-blue-300 rounded-xl p-4 text-center hover:bg-blue-50 transition-all" style="min-width:100px;">
                                <div class="text-2xl mb-1">ğŸ”µ</div>
                                <div class="font-bold text-blue-600">Ù…Ù†Ø®ÙØ¶Ø©</div>
                                <div class="text-xs text-slate-500">Ù„Ù„Ø¹Ù„Ù… ÙÙ‚Ø·</div>
                            </div>
                        </label>
                    </div>
                    <p id="severityError" class="error-message"></p>
                </div>
            `;
            
            initCategorySelectors();

            document.querySelector('.form-step[data-step="2"]').innerHTML = `
                <h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 2: Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù‚Ø¯Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
                <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="form-group">
                        <label for="complainantName" class="form-label required">Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰</label>
                        <input type="text" id="complainantName" name="complainantName" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                        <p class="error-message"></p>
                    </div>
                    <div class="form-group">
                        <label for="complainantPhone" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="tel" id="complainantPhone" name="complainantPhone" class="form-input" placeholder="05xxxxxxxx">
                        <p class="error-message"></p>
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="complainantEmail" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="email" id="complainantEmail" name="complainantEmail" class="form-input" placeholder="example@email.com">
                        <p class="error-message"></p>
                    </div>
                </div>`;

            document.querySelector('.form-step[data-step="3"]').innerHTML = `
                <h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 3: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
                <div class="grid gap-y-4">
                    <div class="form-group">
                        <label for="complaintDateTime" class="form-label required">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø­Ø¯ÙˆØ« Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
                        <input type="datetime-local" id="complaintDateTime" name="complaintDateTime" class="form-input" required>
                        <p class="error-message"></p>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¯Ø«</label>
                        <div id="locationSelector" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto border border-slate-200 rounded-lg p-3">
                            <div style="color:#64748b;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹...</div>
                        </div>
                        <p class="error-message"></p>
                    </div>
                    <div class="form-group">
                        <label for="complaintDescription" class="form-label required">ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø´ÙƒÙˆÙ‰</label>
                        <textarea id="complaintDescription" name="complaintDescription" rows="5" class="form-textarea" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„..." required></textarea>
                        <p class="error-message"></p>
                    </div>
                    <div class="form-group">
                        <label for="complaintAgainst" class="form-label">Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¶Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="complaintAgainst" name="complaintAgainst" class="form-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø£Ùˆ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø´ÙƒÙˆ Ù…Ù†Ù‡">
                        <p class="error-message"></p>
                    </div>
                </div>`;

            document.querySelector('.form-step[data-step="4"]').innerHTML = `
                <h2 class="text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 4: Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
                <div class="grid gap-y-4">
                    <div class="form-group">
                        <label class="form-label">Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ± Ø£Ùˆ Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center">
                            <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx" class="hidden">
                            <button type="button" onclick="document.getElementById('fileInput').click()" class="btn btn-secondary">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª
                            </button>
                            <p class="text-slate-500 text-sm mt-2">ØµÙˆØ±ØŒ PDFØŒ Ø£Ùˆ Ù…Ø³ØªÙ†Ø¯Ø§Øª Word</p>
                        </div>
                        <div id="fileList" class="mt-3 space-y-2"></div>
                    </div>
                    <div class="form-group">
                        <label for="additionalNotes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                        <textarea id="additionalNotes" name="additionalNotes" rows="3" class="form-textarea" placeholder="Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ØªØ±ØºØ¨ ÙÙŠ Ø¥Ø¶Ø§ÙØªÙ‡Ø§..."></textarea>
                    </div>
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-amber-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <p class="font-semibold text-amber-800">Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©</p>
                                <p class="text-amber-700 text-sm mt-1">Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø´ÙƒÙˆØ§Ùƒ Ø¨Ø³Ø±ÙŠØ© ØªØ§Ù…Ø© ÙˆØ³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ø®Ù„Ø§Ù„ 48 Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„.</p>
                            </div>
                        </div>
                    </div>
                </div>`;
        };

        const updateProgressBar = () => {
            const progressLine = document.getElementById('progress-bar-line');
            const percentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressLine.style.width = `${percentage}%`;
            
            document.querySelectorAll('.progress-step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                const circle = step.querySelector('.step-circle');
                if (stepNum < currentStep) {
                    circle.classList.remove('bg-slate-200', 'text-slate-500', 'bg-[var(--accent)]');
                    circle.classList.add('bg-green-500', 'text-white');
                    circle.innerHTML = 'âœ“';
                } else if (stepNum === currentStep) {
                    circle.classList.remove('bg-slate-200', 'text-slate-500', 'bg-green-500');
                    circle.classList.add('bg-[var(--accent)]', 'text-white');
                    circle.innerHTML = stepNum;
                } else {
                    circle.classList.remove('bg-[var(--accent)]', 'bg-green-500', 'text-white');
                    circle.classList.add('bg-slate-200', 'text-slate-500');
                    circle.innerHTML = stepNum;
                }
            });
        };

        const showStep = (step) => {
            document.querySelectorAll('.form-step').forEach(s => s.classList.add('hidden'));
            document.querySelector(`.form-step[data-step="${step}"]`).classList.remove('hidden');
            
            dom.prevBtn.classList.toggle('hidden', step === 1);
            dom.nextBtn.classList.toggle('hidden', step === totalSteps);
            dom.submitBtn.classList.toggle('hidden', step !== totalSteps);
            
            updateProgressBar();
            
            if (step === 3 && locationsLoaded) {
                updateLocationSelector();
            }
        };

        const validateStep = (step) => {
            let isValid = true;
            const currentStepEl = document.querySelector(`.form-step[data-step="${step}"]`);
            
            currentStepEl.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
            currentStepEl.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            
            if (step === 1) {
                const complaintType = document.getElementById('complaintType');
                if (!complaintType.value) {
                    complaintType.classList.add('invalid');
                    complaintType.nextElementSibling.textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø´Ø§ÙƒÙŠ';
                    isValid = false;
                }
                
                const primaryCategory = document.getElementById('primaryCategory');
                if (!primaryCategory.value) {
                    document.getElementById('categoryError').textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ Ø§Ù„Ø´ÙƒÙˆÙ‰';
                    isValid = false;
                }
                
                const subcategory = document.getElementById('subcategory');
                if (document.getElementById('subcategorySection').style.display !== 'none' && !subcategory.value) {
                    subcategory.classList.add('invalid');
                    subcategory.nextElementSibling.textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ';
                    isValid = false;
                }
                
                const severity = document.querySelector('input[name="severity"]:checked');
                if (!severity) {
                    document.getElementById('severityError').textContent = 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©';
                    isValid = false;
                }
            } else if (step === 2) {
                const name = document.getElementById('complainantName');
                if (!name.value.trim()) {
                    name.classList.add('invalid');
                    name.nextElementSibling.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰';
                    isValid = false;
                }
            } else if (step === 3) {
                const dateTime = document.getElementById('complaintDateTime');
                const description = document.getElementById('complaintDescription');
                const locationSelector = document.getElementById('locationSelector');
                const checkedLocations = locationSelector.querySelectorAll('input:checked');
                
                if (!dateTime.value) {
                    dateTime.classList.add('invalid');
                    dateTime.nextElementSibling.textContent = 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø­Ø¯Ø«';
                    isValid = false;
                }
                if (checkedLocations.length === 0) {
                    locationSelector.classList.add('invalid');
                    locationSelector.nextElementSibling.textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
                    isValid = false;
                }
                if (!description.value.trim()) {
                    description.classList.add('invalid');
                    description.nextElementSibling.textContent = 'ÙŠØ±Ø¬Ù‰ ÙˆØµÙ Ø§Ù„Ø´ÙƒÙˆÙ‰';
                    isValid = false;
                }
            }
            
            return isValid;
        };

        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.toggle('bg-green-500', !isError);
            toast.classList.toggle('bg-red-500', isError);
            toast.classList.remove('translate-x-[150%]');
            setTimeout(() => toast.classList.add('translate-x-[150%]'), 3000);
        };

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve({ name: file.name, mimeType: file.type, data: base64 });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const handleFileSelect = (e) => {
            const files = Array.from(e.target.files);
            const fileList = document.getElementById('fileList');
            
            files.forEach(file => {
                if (attachedFiles.length >= 5) {
                    showToast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ù„ÙØ§Øª', true);
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`Ø§Ù„Ù…Ù„Ù ${file.name} Ø£ÙƒØ¨Ø± Ù…Ù† 5 Ù…ÙŠØ¬Ø§`, true);
                    return;
                }
                attachedFiles.push(file);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between bg-slate-50 p-3 rounded-lg';
                fileItem.innerHTML = `
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="text-sm truncate max-w-xs">${file.name}</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="this.parentElement.remove()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        };

        const submitForm = async (e) => {
            e.preventDefault();
            
            if (!validateStep(currentStep)) return;
            
            dom.submitBtn.disabled = true;
            dom.submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            
            const locationSelector = document.getElementById('locationSelector');
            const checkedLocations = Array.from(locationSelector.querySelectorAll('input:checked')).map(cb => cb.value);
            
            let filesBase64 = [];
            if (attachedFiles.length > 0) {
                try {
                    filesBase64 = await Promise.all(attachedFiles.map(f => fileToBase64(f)));
                } catch (err) {
                    console.error('File conversion error:', err);
                }
            }
            
            const severityLabels = { high: 'Ø¹Ø§Ù„ÙŠØ©', medium: 'Ù…ØªÙˆØ³Ø·Ø©', low: 'Ù…Ù†Ø®ÙØ¶Ø©' };
            const selectedSev = document.querySelector('input[name="severity"]:checked');
            const catObj = complaintCategories.find(c => c.id === document.getElementById('primaryCategory').value);
            
            const formData = {
                action: 'submitComplaint',
                payload: {
                    complaintType: document.getElementById('complaintType').value,
                    primaryCategory: catObj ? catObj.name : '',
                    subcategory: document.getElementById('subcategory').value || '',
                    severity: selectedSev ? selectedSev.value : '',
                    severityLabel: selectedSev ? severityLabels[selectedSev.value] : '',
                    complainantName: document.getElementById('complainantName').value,
                    complainantPhone: document.getElementById('complainantPhone').value || '',
                    complainantEmail: document.getElementById('complainantEmail').value || '',
                    complaintDateTime: document.getElementById('complaintDateTime').value,
                    locations: checkedLocations,
                    description: document.getElementById('complaintDescription').value,
                    complaintAgainst: document.getElementById('complaintAgainst').value || '',
                    additionalNotes: document.getElementById('additionalNotes').value || '',
                    files: filesBase64
                }
            };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(formData),
                    redirect: 'follow'
                });
                
                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.error('Response:', text);
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯');
                }
                
                if (!result.ok) {
                    throw new Error(result.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰');
                }
                
                console.log('Success:', result);
                dom.formContentWrapper.classList.add('hidden');
                dom.successScreen.classList.remove('hidden');
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­ - Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰: ' + (result.complaintId || ''));
                
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', true);
                dom.submitBtn.disabled = false;
                dom.submitBtn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰';
            }
        };

        const init = async () => {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù† Ø§Ù„Ø´ÙŠØª Ø£ÙˆÙ„Ø§Ù‹
            await loadLocationsFromSheet();
            
            renderProgressBar();
            renderStepContent();
            showStep(1);
            
            const dateTimeInput = document.getElementById('complaintDateTime');
            if (dateTimeInput) {
                dateTimeInput.value = getCurrentLocalISOString();
            }
            
            dom.nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    currentStep++;
                    showStep(currentStep);
                }
            });
            
            dom.prevBtn.addEventListener('click', () => {
                currentStep--;
                showStep(currentStep);
            });
            
            dom.form.addEventListener('submit', submitForm);
            
            dom.newReportBtn.addEventListener('click', () => {
                window.location.reload();
            });
            
            setTimeout(() => {
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                }
            }, 100);
        };

        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
