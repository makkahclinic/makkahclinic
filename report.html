<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>النموذج الموحد للإبلاغ - مجمع مكة الطبي</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0a4c8b;
            --secondary: #1a936f;
            --accent: #f9a826;
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }
        /* ... (بقية أنماط CSS تبقى كما هي) ... */
        .form-input[readonly], .form-textarea[readonly] {
            background-color: #e5e7eb; /* bg-gray-200 */
            cursor: not-allowed;
            color: #4b5563; /* text-gray-600 */
        }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #334155; }
        .form-label.required::after { content: " *"; color: #dc2626; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 1rem; transition: all 0.3s ease; background-color: #f8fafc; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(249, 168, 38, 0.3); }
        .form-input.invalid, .form-select.invalid, .form-textarea.invalid, .grid.invalid, #locationSelector.invalid { border: 1px solid #dc2626; border-radius: 0.5rem; }
        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #144c63 100%); color: white; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="container max-w-4xl w-full">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden" id="formContainer">
            <header class="bg-gradient-to-br from-[var(--primary)] to-[var(--secondary)] text-white p-6 sm:p-8 text-center">
                <h1 class="text-2xl sm:text-3xl font-bold">مجمع مكة الطبي بالزاهر</h1>
                <p class="text-lg sm:text-xl mt-2 opacity-90">النموذج الموحد للإبلاغ عن الحوادث والشكاوى</p>
            </header>
            
            <div id="form-content-wrapper">
                <div class="p-6 sm:p-8">
                    <div id="progressBar" class="mb-8">
                        </div>

                    <form id="unifiedForm" novalidate>
                        <div class="form-step" data-step="1">
                            </div>

                        <div class="form-step hidden" data-step="2">
                             <h2 class="section-title text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">القسم 2: البيانات الإدارية</h2>
                            <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                                <div class="form-group">
                                    <label for="reportNumber" class="form-label">رقم البلاغ المرجعي</label>
                                    <input type="text" id="reportNumber" name="reportNumber" class="form-input" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="reportDateTime" class="form-label">تاريخ ووقت البلاغ</label>
                                    <input type="datetime-local" id="reportDateTime" name="reportDateTime" class="form-input" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-step hidden" data-step="3"></div>
                        <div class="form-step hidden" data-step="4"></div>
                        <div class="form-step hidden" data-step="5"></div>
                    </form>

                    <div class="form-actions mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                        <button type="button" id="prevBtn" class="btn btn-secondary hidden">السابق</button>
                        <button type="button" id="nextBtn" class="btn btn-primary">التالي</button>
                        <button type="submit" id="submitBtn" form="unifiedForm" class="btn btn-primary hidden">إرسال البلاغ</button>
                    </div>
                </div>
            </div>

            <div id="success-screen" class="p-8 text-center hidden">
                </div>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg flex items-center gap-3 transform translate-x-[150%] transition-transform duration-500 ease-in-out z-50">
        </div>

    <script>
    (function() {
        // --- STATE & CONFIG ---
        let currentStep = 1;
        let totalSteps = 5;
        let selectedLocations = [];
        let attachedFiles = [];
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxtO924GZ3kzKnnjswfn_4lxR5XMjuf15wet0Rh2dXiBhOpYwv00NpiHI9-aKE-12CJqw/exec";
        const locations = [ /* ... (قائمة المواقع تبقى كما هي) ... */ ];

        // --- DOM ELEMENTS ---
        const form = document.getElementById('unifiedForm');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.getElementById('submitBtn');
        // ... (بقية العناصر) ...
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeForm();
            // ... (بقية الدوال) ...
        });

        function getCurrentLocalISOString() {
            const now = new Date();
            // Adjust for timezone offset to get local time in ISO format
            const timezoneOffset = now.getTimezoneOffset() * 60000; // in milliseconds
            const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
            return localISOTime;
        }

        function initializeForm() {
            // **التحديث**: جعل تاريخ البلاغ للقراءة فقط وتعيين قيمته
            const reportDateTimeField = document.getElementById('reportDateTime');
            reportDateTimeField.value = getCurrentLocalISOString();
            reportDateTimeField.readOnly = true;

            // **التحديث**: جعل رقم البلاغ للقراءة فقط
            document.getElementById('reportNumber').readOnly = true;
            generateReportNumber();
        }
        
        // ... (بقية دوال الجافاسكريبت مثل generateReportNumber, handleNextStep, etc.)

        function getIncidentHTML() {
            // **التحديث**: إضافة القيمة الافتراضية لتاريخ الحادث
            return `
                <h2 class="section-title ...">القسم 3: تفاصيل الحادث</h2>
                <div class="grid ...">
                     <div class="form-group">
                        <label for="incidentDateTime" class="form-label required">تاريخ ووقت وقوع الحادث</label>
                        <input type="datetime-local" id="incidentDateTime" name="incidentDateTime" class="form-input" value="${getCurrentLocalISOString()}" required>
                         <p class="error-message"></p>
                    </div>
                     <div class="form-group md:col-span-2">
                        <label for="incidentDescription" class="form-label required">وصف موجز لما حدث</label>
                        <textarea id="incidentDescription" ... required></textarea>
                         <p class="error-message"></p>
                    </div>
                </div>
            `;
        }
        
        // **التحديث**: تعديل دالة تحديث الأزرار
        function updateNavigationButtons() {
            prevBtn.classList.toggle('hidden', currentStep === 1);
            
            const isLastStep = (isPatientReporter() && currentStep === 5) || (!isPatientReporter() && currentStep === totalSteps);
            
            nextBtn.classList.toggle('hidden', isLastStep);
            submitBtn.classList.toggle('hidden', !isLastStep);
        }

        // --- FORM SUBMISSION ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!validateCurrentStep()) return;

            submitBtn.innerHTML = '<span>⏳</span> جاري الإرسال، قد يستغرق بعض الوقت...';
            submitBtn.disabled = true;

            // ... (بقية منطق الإرسال يبقى كما هو)
        }

        // ... (بقية الكود يبقى كما هو)

    })();
    </script>
</body>
</html>
