<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ø¥Ø¨Ù„Ø§Øº - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>
    
    <!-- Tailwind CSS for a modern, utility-first design -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Tajawal for Arabic script -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Heroicons for modern, beautiful icons -->
    <script src="https://unpkg.com/heroicons@2.1.1/24/outline/index.js"></script>

    <style>
        /* Custom styles to complement Tailwind CSS */
        :root {
            --primary: #0a4c8b;
            --secondary: #1a936f;
            --accent: #f9a826;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
        }

        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Animation for form step transitions */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .form-step {
            animation: slideIn 0.5s ease-in-out forwards;
        }
        
        /* Custom focus ring color */
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249, 168, 38, 0.3);
        }
        
        /* Progress bar active line styling */
        .progress-bar-line {
            transition: width 0.4s ease-in-out;
        }

        /* Styling for radio button cards */
        .radio-card {
            transition: all 0.3s ease;
        }

        .radio-card input:checked + label {
            border-color: var(--primary);
            background-color: #f0f9ff; /* sky-50 */
            box-shadow: 0 0 0 2px var(--accent);
        }
        
        /* SAC Matrix styling */
        .sac-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: 4px solid var(--primary);
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="container max-w-4xl w-full">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden" id="formContainer">
            <header class="bg-gradient-to-br from-[var(--primary)] to-[var(--secondary)] text-white p-6 sm:p-8 text-center">
                <h1 class="text-2xl sm:text-3xl font-bold">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</h1>
                <p class="text-lg sm:text-xl mt-2 opacity-90">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ø­ÙˆØ§Ø¯Ø« ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰</p>
                <div class="mt-3 text-xs inline-block bg-white/20 px-3 py-1 rounded-full">Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø³ÙŠØ§Ø³Ø©: POL-LD32-2025-001</div>
            </header>

            <div class="p-6 sm:p-8">
                <!-- Dynamic Progress Bar -->
                <div id="progressBar" class="mb-8">
                    <div class="flex justify-between items-center relative">
                        <div class="absolute top-1/2 -translate-y-1/2 w-full h-1 bg-slate-200"></div>
                        <div id="progress-bar-line" class="absolute top-1/2 -translate-y-1/2 w-0 h-1 bg-[var(--accent)] progress-bar-line"></div>
                        
                        <div class="progress-step z-10" data-step="1">
                            <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg transition-all duration-300">1</div>
                            <div class="step-label mt-2 text-xs text-center text-slate-500 font-semibold">Ø§Ù„ØªØµÙ†ÙŠÙ</div>
                        </div>
                        <div class="progress-step z-10" data-step="2">
                            <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg transition-all duration-300">2</div>
                            <div class="step-label mt-2 text-xs text-center text-slate-500 font-semibold">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                        </div>
                        <div class="progress-step z-10" data-step="3">
                            <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg transition-all duration-300">3</div>
                            <div class="step-label mt-2 text-xs text-center text-slate-500 font-semibold">Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
                        </div>
                        <div class="progress-step z-10" data-step="4">
                            <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg transition-all duration-300">4</div>
                            <div class="step-label mt-2 text-xs text-center text-slate-500 font-semibold">Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>
                        </div>
                        <div class="progress-step z-10" data-step="5">
                            <div class="step-circle w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg transition-all duration-300">5</div>
                            <div class="step-label mt-2 text-xs text-center text-slate-500 font-semibold">Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
                        </div>
                    </div>
                </div>

                <form id="unifiedForm" novalidate>
                    <!-- Step 1: Classification -->
                    <div class="form-step" data-step="1">
                        <h2 class="section-title text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 1: Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</h2>
                        <div class="form-group">
                            <label for="reportCategory" class="form-label required">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
                            <select id="reportCategory" name="reportCategory" class="form-select" required>
                                <option value="" disabled selected>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</option>
                                <option value="Ø­Ø§Ø¯Ø«">Ø¨Ù„Ø§Øº Ø­Ø§Ø¯Ø«/Ù…Ø®Ø§Ø·Ø±</option>
                                <option value="Ø´ÙƒÙˆÙ‰">Ø´ÙƒÙˆÙ‰ Ù…Ø±ÙŠØ¶/Ù…Ø±Ø§Ø¬ÙØ¹</option>
                            </select>
                            <small class="form-hint">Ø§Ø®ØªØ± "Ø­Ø§Ø¯Ø«" Ù„Ù„Ù…Ø®Ø§Ø·Ø±ØŒ Ø£Ùˆ "Ø´ÙƒÙˆÙ‰" Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰.</small>
                            <p class="error-message"></p>
                        </div>
                    </div>

                    <!-- Step 2: Administrative Data -->
                    <div class="form-step hidden" data-step="2">
                        <h2 class="section-title text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 2: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h2>
                        <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                            <!-- Reporter Type Selection -->
                            <div class="form-group md:col-span-2">
                                <label class="form-label required">Ù…Ù† Ù‡Ùˆ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø¨Ù„Ø§ØºØŸ</label>
                                <div class="grid grid-cols-2 gap-4 mt-2">
                                    <div class="radio-card">
                                        <input type="radio" name="reporterType" id="reporterEmployee" value="employee" class="sr-only" required>
                                        <label for="reporterEmployee" class="flex flex-col items-center justify-center text-center p-4 border-2 border-slate-200 rounded-lg cursor-pointer">
                                            <span class="text-2xl">ğŸ‘¨â€âš•ï¸</span>
                                            <span class="font-semibold mt-2 text-slate-700">Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ù…Ø¬Ù…Ø¹</span>
                                        </label>
                                    </div>
                                    <div class="radio-card">
                                        <input type="radio" name="reporterType" id="reporterPatient" value="patient" class="sr-only" required>
                                        <label for="reporterPatient" class="flex flex-col items-center justify-center text-center p-4 border-2 border-slate-200 rounded-lg cursor-pointer">
                                            <span class="text-2xl">ğŸ‘¤</span>
                                            <span class="font-semibold mt-2 text-slate-700">Ù…Ø±ÙŠØ¶ / Ø²Ø§Ø¦Ø±</span>
                                        </label>
                                    </div>
                                </div>
                                <p class="error-message"></p>
                            </div>
                            
                            <!-- Dynamic Reporter Fields -->
                            <div id="employee-reporter-fields" class="md:col-span-2 grid md:grid-cols-2 gap-x-6 gap-y-4 hidden">
                                <div class="form-group md:col-span-2">
                                    <label for="reporterName" class="form-label required">Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù„Ù‘Øº ÙˆÙˆØ¸ÙŠÙØªÙ‡</label>
                                    <input type="text" id="reporterName" name="reporterName" placeholder="Ù…Ø«Ø§Ù„: ÙÙ„Ø§Ù† Ø§Ù„ÙÙ„Ø§Ù†ÙŠØŒ Ù…Ù…Ø±Ø¶" class="form-input">
                                    <p class="error-message"></p>
                                </div>
                                <div class="form-group md:col-span-2">
                                    <label for="verbalReport" class="form-label">ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø´ÙÙ‡ÙŠ Ù„Ù…Ù†ØŸ (Ø¥Ù† ÙˆØ¬Ø¯)</label>
                                    <input type="text" id="verbalReport" name="verbalReport" placeholder="Ù…Ø«Ø§Ù„: Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…ØŒ Ù…Ø´Ø±Ù Ø§Ù„ØªÙ…Ø±ÙŠØ¶" class="form-input">
                                </div>
                            </div>

                            <div id="patient-reporter-fields" class="md:col-span-2 grid md:grid-cols-2 gap-x-6 gap-y-4 hidden">
                                 <div class="form-group">
                                    <label for="patientName" class="form-label required">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ / Ø§Ù„Ø²Ø§Ø¦Ø±</label>
                                    <input type="text" id="patientName" name="patientName" class="form-input">
                                    <p class="error-message"></p>
                                </div>
                                <div class="form-group">
                                    <label for="patientPhone" class="form-label required">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„ØªÙˆØ§ØµÙ„</label>
                                    <input type="tel" id="patientPhone" name="patientPhone" class="form-input">
                                    <p class="error-message"></p>
                                </div>
                            </div>
                            
                            <div class="form-group md:col-span-2 relative">
                                <label for="locationSelector" class="form-label required">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„ØºØ±ÙØ©)</label>
                                <div id="locationSelector" class="form-input cursor-pointer flex justify-between items-center">
                                    <span>Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„Ø´ÙƒÙˆÙ‰...</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-slate-400"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                                </div>
                                <div id="locationDropdown" class="absolute top-full right-0 w-full bg-white border border-slate-300 rounded-md shadow-lg max-h-60 overflow-y-auto z-20 hidden">
                                    <input type="text" id="locationSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." class="form-input sticky top-0 m-1 w-[calc(100%-0.5rem)] z-10">
                                    <div id="locationOptionsContainer"></div>
                                </div>
                                <div id="selectedLocations" class="mt-2 flex flex-wrap gap-2"></div>
                                <p class="error-message"></p>
                            </div>
                            <div class="form-group">
                                <label for="reportNumber" class="form-label required">Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</label>
                                <input type="text" id="reportNumber" name="reportNumber" class="form-input bg-slate-200" readonly>
                                <p class="error-message"></p>
                            </div>
                            <div class="form-group">
                                <label for="reportDateTime" class="form-label required">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ù„Ø§Øº</label>
                                <input type="datetime-local" id="reportDateTime" name="reportDateTime" class="form-input" required>
                                <p class="error-message"></p>
                            </div>
                        </div>
                    </div>


                    <!-- Step 3: Incident/Complaint Details -->
                    <div class="form-step hidden" data-step="3">
                        <!-- This step's content is fully dynamic -->
                    </div>

                    <!-- Step 4: Analysis & Actions -->
                    <div class="form-step hidden" data-step="4">
                       <!-- This step's content is fully dynamic -->
                    </div>

                     <!-- Step 5: Attachments & Submission -->
                    <div class="form-step hidden" data-step="5">
                        <h2 class="section-title text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø®ÙŠØ±: Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„</h2>
                         <div class="form-group">
                            <label for="attachments" class="form-label">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <div class="mt-2 flex justify-center rounded-lg border border-dashed border-slate-900/25 px-6 py-10 cursor-pointer hover:border-[var(--accent)] transition-all" id="dropzone">
                                <div class="text-center">
                                    <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                    <div class="mt-4 flex text-sm leading-6 text-slate-600">
                                        <label for="attachments" class="relative cursor-pointer rounded-md bg-white font-semibold text-[var(--primary)] focus-within:outline-none focus-within:ring-2 focus-within:ring-[var(--accent)] focus-within:ring-offset-2 hover:text-[var(--secondary)]">
                                            <span>Ø§Ø±ÙØ¹ Ù…Ù„ÙÙ‹Ø§</span>
                                            <input id="attachments" name="attachments" type="file" class="sr-only" multiple>
                                        </label>
                                        <p class="pr-1">Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡ ÙˆØ£ÙÙ„ØªÙ‡ Ù‡Ù†Ø§</p>
                                    </div>
                                    <p class="text-xs leading-5 text-slate-600">PNG, JPG, PDF up to 10MB</p>
                                </div>
                            </div>
                            <div id="file-list" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </form>

                <!-- Navigation Buttons -->
                <div class="form-actions mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                    <button type="button" id="prevBtn" class="btn btn-secondary hidden">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button type="button" id="nextBtn" class="btn btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button type="submit" id="submitBtn" form="unifiedForm" class="btn btn-primary hidden">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal for Confirmation -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-yellow-100">
                 <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z"></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-slate-800 mt-4" id="modalTitle"></h3>
            <p class="text-sm text-slate-500 mt-2" id="modalMessage"></p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="modalCancel" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="modalConfirm" class="btn bg-red-600 text-white hover:bg-red-700">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>

    <!-- Custom Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg flex items-center gap-3 transform translate-x-[150%] transition-transform duration-500 ease-in-out">
         <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span id="toastMessage"></span>
    </div>

    <!-- Template for form group styling -->
    <style id="form-styles">
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #334155; /* slate-700 */
        }
        .form-label.required::after {
            content: " *";
            color: #dc2626; /* red-600 */
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #f8fafc; /* slate-50 */
        }
        .form-input.invalid, .form-select.invalid, .form-textarea.invalid, .grid.invalid {
             border: 1px solid #dc2626; /* red-600 */
             border-radius: 0.5rem;
        }
        .form-hint {
            color: #64748b; /* slate-500 */
            font-size: 0.875rem;
            display: block;
            margin-top: 0.3rem;
        }
        .error-message {
            color: #dc2626; /* red-600 */
            font-size: 0.875rem;
            margin-top: 0.25rem;
            min-height: 1.25rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
             background: linear-gradient(135deg, var(--primary) 0%, #144c63 100%);
             color: white;
        }
        .btn-secondary {
            background-color: #e2e8f0; /* slate-200 */
            color: #334155; /* slate-700 */
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* slate-300 */
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>

    <script>
    // Self-invoking function to encapsulate the entire form logic
    (function() {
        // --- STATE MANAGEMENT ---
        let currentStep = 1;
        let totalSteps = 5; // Default for employee
        let selectedLocations = [];
        const locations = [
            { code: "DIR-B-01", name: "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…" }, { code: "ADM-B-01", name: "Ø¨Ù„Ø§Ù„" }, { code: "ADM-B-02", name: "Ø£/ Ø¹Ø¯Ù†Ø§Ù†" }, { code: "INS-B-01", name: "Ø£/ ØµØ§Ø¨Ø±" }, { code: "INS-B-02", name: "Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©" }, { code: "CSSD-B-01", name: "Ø§Ù„ØªØ¹Ù‚ÙŠÙŠÙ…" }, { code: "CSSD-B-02", name: "Ø§Ù„ØºØ³ÙŠÙ„" }, { code: "RAD-B-01", name: "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø§Ø´Ø¹Ø©" }, { code: "RAD-B-02", name: "Ultrasound" }, { code: "RAD-B-03", name: "X-ray and Panorama" }, { code: "FAC-B-01", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡" }, { code: "LAB-B-01", name: "Ø§Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¯Ù…" }, { code: "LAB-B-02", name: "Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø§Ù„Ø­ÙŠÙˆÙŠØ©" }, { code: "LAB-B-03", name: "Ø¹Ù„Ù… Ø§Ù„Ø·ÙÙŠÙ„ÙŠØ§Øª" }, { code: "ADM-B-03", name: "Ù…ÙƒØªØ¨ Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª" }, { code: "REC-G-01", name: "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø§ÙˆÙ„" }, { code: "FAC-G-01", name: "Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª" }, { code: "GP-G-01", name: "Ø¯ÙƒØªÙˆØ± Ø¬Ø¹ÙØ± ÙˆØ­Ø³Ù†" }, { code: "WMF-G-01", name: "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†Ø³Ø§Ø¡" }, { code: "WMR-G-01", name: "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¬Ø§Ù„" }, { code: "MED-G-01", name: "Ø¯ÙƒØªÙˆØ± Ù…Ø­Ù…Ø¯" }, { code: "MED-G-02", name: "Ø¯ÙƒØªÙˆØ± Ù…Ø¬Ø¯ÙŠ" }, { code: "ER-G-01", name: "ØºØ±ÙØ© Ø§Ù„Ø§Ù†Ø¹Ø§Ø´ Ø§Ù„Ù‚Ù„Ø¨ÙŠ Ø§Ù„Ø±Ø¦ÙˆÙŠ" }, { code: "VS-G-01", name: "Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©" }, { code: "BD-G-01", name: "ØºØ±ÙØ© Ø³Ø­Ø¨ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª" }, { code: "OBG-G-01", name: "ØºØ±ÙØ© Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø·Ø¨ÙŠ" }, { code: "OBG-G-02", name: "ØºØ±ÙØ© Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©" }, { code: "OBG-G-03", name: "ØºØ±ÙØ© Ù…Ø§Ø¨Ø¹Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©" }, { code: "ER-G-01", name: "Ø·ÙˆØ§Ø±Ø¦ Ø±Ø¬Ø§Ù„" }, { code: "ER-G-02", name: "Ø·ÙˆØ§Ø±Ø¦ Ù†Ø³Ø§Ø¡" }, { code: "FAC-G-02", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ø±Ø¬Ø§Ù„" }, { code: "FAC-G-03", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ù†Ø³Ø§Ø¡" }, { code: "FAC-G-04", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ù†Ø³Ø§Ø¡" }, { code: "REC-1-01", name: "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù‚Ø³Ù… Ø§Ù„Ø§Ø³Ù†Ø§Ù†" }, { code: "DEN-1-01", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ù…Ø¹Ø§Ø°" }, { code: "DEN-1-02", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ù…Ø¹Ø§Ø°" }, { code: "DEN-1-03", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø¹Ø²Ø§Ù… Ø§Ù„ÙŠØ§Ø³ÙŠ" }, { code: "DEN-1-04", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ù†ÙˆØ±Ø§ Ø­Ø¨Ø´ÙŠ" }, { code: "DEN-1-05", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø§Ù„Ø¹Ù†ÙˆØ¯ Ø§Ù„Ø²Ø¨ÙŠØ¯ÙŠ" }, { code: "DEN-1-06", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø±Ø´Ø§ Ø±Ø¬Ø¨" }, { code: "ORTH-1-07", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø±Ø¨ÙŠØ¹Ø© ØªØ¨Ø³Ù…" }, { code: "ADM-1-01", name: "Ù…ÙƒØªØ¨ Ø¯/Ø®Ø§Ù„Ø¯" }, { code: "WMR-1-01", name: "Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø§Ø³Ù†Ø§Ù†" }, { code: "WMR-1-02", name: "Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø·Ù†Ø©-Ø§Ù„Ø¹ÙŠÙˆÙ†-Ø§Ù„Ø¹Ø¸Ø§Ù…" }, { code: "WMF-1-01", name: "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†Ø³Ø§Ø¡" }, { code: "FAC-1-01", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ø§Ù„Ù†Ø³Ø§Ø¡" }, { code: "FAC-1-02", name: "Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡ Ø§Ù„Ø±Ø¬Ø§Ù„" }, { code: "OPH-1-01", name: "Ø¹ÙŠØ§Ø¯Ø©/ Ø´Ø°Ø§" }, { code: "MED-1-01", name: "Ø¹ÙŠØ§Ø¯Ø© Ø¯/Ø­Ù…Ø§Ø¯Ø© Ù†Ø¬Ø§Ø­" }, { code: "MED-1-02", name: "Ø¹ÙŠØ§Ø¯Ø© Ø§Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¯ÙƒØªÙˆØ± Ø­Ù…Ø§Ø¯Ø©" }, { code: "MED-1-03", name: "Ø¹ÙŠØ§Ø¯Ø© Ù…Ø¬Ù‡Ø²Ø©" }, { code: "ADM-1-02", name: "Ù…ÙƒØªØ¨ ÙØ§Ø±Øº" }, { code: "FAC-1-03", name: "Ø§Ø³ØªØ±Ø§Ø­Ø© Ù…ÙˆØ¸ÙØ§Øª" }
        ];
        // <<<<<<<<<<<< URL HAS BEEN PASTED HERE >>>>>>>>>>>>>>>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEGyZEm1oGE1VSxG_qRkxmVCUUdiBk7u3YvyT3CXWRE9PyWQq7ZsL4iG7L4iqZJ8qkyw/exec"; 


        // --- DOM ELEMENTS ---
        const form = document.getElementById('unifiedForm');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.getElementById('submitBtn');
        const reportCategory = document.getElementById('reportCategory');
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeForm();
            updateProgressBar();
            attachEventListeners();
            initializeLocationPicker();
        });

        function initializeForm() {
            // Set default date and time
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('reportDateTime').value = now.toISOString().slice(0, 16);
            generateReportNumber(); // Generate initial number
        }
        
        // --- EVENT LISTENERS ---
        function attachEventListeners() {
            nextBtn.addEventListener('click', handleNextStep);
            prevBtn.addEventListener('click', handlePrevStep);
            form.addEventListener('submit', handleFormSubmit);
            
            reportCategory.addEventListener('change', () => {
                generateReportNumber();
                setupDynamicSteps();
            });

            document.querySelectorAll('input[name="reporterType"]').forEach(radio => {
                radio.addEventListener('change', handleReporterTypeChange);
            });

            // Drag and Drop for file attachments
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('attachments');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropzone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false));
            ['dragenter', 'dragover'].forEach(eventName => dropzone.addEventListener(eventName, () => dropzone.classList.add('bg-slate-100', 'border-[var(--accent)]'), false));
            ['dragleave', 'drop'].forEach(eventName => dropzone.addEventListener(eventName, () => dropzone.classList.remove('bg-slate-100', 'border-[var(--accent)]'), false));
            dropzone.addEventListener('drop', e => {
                fileInput.files = e.dataTransfer.files;
                updateFileList();
            });
            fileInput.addEventListener('change', updateFileList);
        }

        function generateReportNumber() {
            const type = reportCategory.value;
            const year = new Date().getFullYear();
            const serial = Date.now().toString().slice(-5); // Use a 5-digit slice for better uniqueness
            let code = "MMC-REP-";
            
            if (type === 'Ø­Ø§Ø¯Ø«') {
                code = `IR-RISK-${year}-${serial}`;
            } else if (type === 'Ø´ÙƒÙˆÙ‰') {
                code = `RPT-PAT-${year}-${serial}`;
            } else {
                code += serial; // Fallback
            }
            document.getElementById('reportNumber').value = code;
        }

        function isPatientReporter() {
            const reporterType = document.querySelector('input[name="reporterType"]:checked');
            return reporterType && reporterType.value === 'patient';
        }

        function handleReporterTypeChange(e) {
            const employeeFields = document.getElementById('employee-reporter-fields');
            const patientFields = document.getElementById('patient-reporter-fields');
            const employeeInputs = employeeFields.querySelectorAll('input');
            const patientInputs = patientFields.querySelectorAll('input');

            if (e.target.value === 'employee') {
                totalSteps = 5;
                employeeFields.classList.remove('hidden');
                patientFields.classList.add('hidden');
                employeeInputs.forEach(input => input.required = true);
                patientInputs.forEach(input => { input.required = false; input.value = ''; });
            } else {
                totalSteps = 4;
                employeeFields.classList.add('hidden');
                patientFields.classList.remove('hidden');
                employeeInputs.forEach(input => { input.required = false; input.value = ''; });
                patientInputs.forEach(input => input.required = true);
            }
            updateProgressBar();
            validateField(document.querySelector('input[name="reporterType"]'));
        }

        // --- STEP NAVIGATION ---
        function handleNextStep() {
            if (validateCurrentStep()) {
                let nextStep = currentStep + 1;
                // Skip step 4 for patients
                if (isPatientReporter() && nextStep === 4) {
                    nextStep = 5;
                }
                
                if (nextStep <= 5) { // Always check against max possible steps
                    currentStep = nextStep;
                    showStep(currentStep);
                }
            }
        }

        function handlePrevStep() {
            let prevStep = currentStep - 1;
            // Skip step 4 for patients when going back
            if (isPatientReporter() && prevStep === 4) {
                prevStep = 3;
            }

            if (prevStep >= 1) {
                currentStep = prevStep;
                showStep(currentStep);
            }
        }
        
        function showStep(stepNumber) {
            document.querySelectorAll('.form-step').forEach(step => step.classList.add('hidden'));
            const activeStep = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
            if(activeStep) activeStep.classList.remove('hidden');
            updateProgressBar();
            updateNavigationButtons();
        }

        // --- UI UPDATES ---
        function updateProgressBar() {
            const steps = document.querySelectorAll('.progress-step');
            const line = document.getElementById('progress-bar-line');
            const patientJourney = [1, 2, 3, 5]; // Steps visible to patient

            steps.forEach((step, index) => {
                const stepNum = index + 1;
                const circle = step.querySelector('.step-circle');
                const label = step.querySelector('.step-label');

                // Hide analysis step for patients
                if (stepNum === 4) {
                    step.style.display = isPatientReporter() ? 'none' : 'flex';
                }
                
                // Rename submission step label for patients
                if (stepNum === 5) {
                    label.textContent = isPatientReporter() ? 'Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
                    circle.textContent = isPatientReporter() ? '4' : '5';
                } else if (stepNum !== 4) {
                     label.textContent = getStepLabel(stepNum);
                     circle.textContent = stepNum;
                }

                let effectiveCurrentStep = currentStep;
                if (isPatientReporter() && currentStep === 5) {
                    effectiveCurrentStep = 4;
                }

                let effectiveStepNum = stepNum;
                if (isPatientReporter() && stepNum === 5) {
                    effectiveStepNum = 4;
                }

                if (effectiveStepNum < effectiveCurrentStep) {
                    circle.classList.add('bg-[var(--accent)]', 'text-white');
                    circle.innerHTML = '&#10003;';
                } else if (effectiveStepNum === effectiveCurrentStep) {
                    circle.classList.add('bg-[var(--primary)]', 'text-white');
                    circle.classList.remove('bg-slate-200', 'text-slate-500');
                } else {
                    circle.classList.remove('bg-[var(--primary)]', 'bg-[var(--accent)]', 'text-white');
                    circle.classList.add('bg-slate-200', 'text-slate-500');
                }
            });
            
            const progressPercentage = (( (isPatientReporter() && currentStep === 5 ? 4 : currentStep) - 1) / (totalSteps - 1)) * 100;
            line.style.width = `${progressPercentage}%`;
        }
        
        function getStepLabel(stepNum){
            const labels = ["Ø§Ù„ØªØµÙ†ÙŠÙ", "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "Ø§Ù„ØªÙØ§ØµÙŠÙ„", "Ø§Ù„ØªØ­Ù„ÙŠÙ„", "Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"];
            return labels[stepNum - 1];
        }


        function updateNavigationButtons() {
            prevBtn.classList.toggle('hidden', currentStep === 1);
            
            const isLastStep = isPatientReporter() ? currentStep === 5 : currentStep === totalSteps;
            nextBtn.classList.toggle('hidden', isLastStep);
            submitBtn.classList.toggle('hidden', !isLastStep);
        }

        // --- DYNAMIC CONTENT ---
        function setupDynamicSteps() {
            const isComplaint = reportCategory.value === 'Ø´ÙƒÙˆÙ‰';
            const step3Container = document.querySelector('.form-step[data-step="3"]');
            const step4Container = document.querySelector('.form-step[data-step="4"]');
            
            step3Container.innerHTML = isComplaint ? getComplaintHTML() : getIncidentHTML();
            step4Container.innerHTML = getAnalysisHTML(); // Always populate, but hide the step for patients
            
            attachDynamicListeners();
        }
        
        // Templates for dynamic sections
        function getIncidentHTML() {
            return `
                <h2 class="section-title text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 3: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ø¯Ø«</h2>
                <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                     <div class="form-group">
                        <label for="incidentDateTime" class="form-label required">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª ÙˆÙ‚ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø«</label>
                        <input type="datetime-local" id="incidentDateTime" name="incidentDateTime" class="form-input" required>
                         <p class="error-message"></p>
                    </div>
                     <div class="form-group md:col-span-2">
                        <label for="incidentDescription" class="form-label required">ÙˆØµÙ Ù…ÙˆØ¬Ø² Ù„Ù…Ø§ Ø­Ø¯Ø«</label>
                        <textarea id="incidentDescription" name="incidentDescription" class="form-textarea" rows="4" placeholder="ØµÙ Ù…Ø§ Ø­Ø¯Ø« Ø¨Ø§Ù„ØªÙØµÙŠÙ„: Ù…Ø§Ø°Ø§ Ø­Ø¯Ø«ØŸ Ù…Ù† ÙƒØ§Ù† Ù…ØªÙˆØ§Ø¬Ø¯Ù‹Ø§ØŸ Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¹ÙˆØ§Ù‚Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©ØŸ" required></textarea>
                         <p class="error-message"></p>
                    </div>
                </div>
            `;
        }
        
        function getComplaintHTML() {
            return `
                <h2 class="section-title text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 3: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
                <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                     <div class="form-group md:col-span-2">
                        <label for="complaintDescription" class="form-label required">ÙˆØµÙ Ø§Ù„Ø´ÙƒÙˆÙ‰</label>
                        <textarea id="complaintDescription" name="complaintDescription" class="form-textarea" rows="4" placeholder="ØµÙ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ù…Ø¹ Ø°ÙƒØ± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø¹Ù†ÙŠÙŠÙ†" required></textarea>
                         <p class="error-message"></p>
                    </div>
                </div>
            `;
        }

        function getAnalysisHTML() {
            // This is ONLY for employees
            return `
                <h2 class="section-title text-xl font-bold text-[var(--primary)] border-b-2 border-[var(--accent)] pb-3 mb-6">Ø§Ù„Ù‚Ø³Ù… 4: Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold text-lg text-slate-700 mb-4">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø·ÙˆØ±Ø© (SAC Matrix)</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="sac-item p-4 rounded-lg">
                                <label for="severity" class="form-label required">Ø´Ø¯Ø© Ø§Ù„Ø¹ÙˆØ§Ù‚Ø¨ (Severity)</label>
                                <select id="severity" name="severity" class="form-select mt-1" required>
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¯Ø©...</option>
                                    <option value="1">Ù…Ù†Ø®ÙØ¶Ø© - ØªØ£Ø«ÙŠØ± Ø·ÙÙŠÙ</option>
                                    <option value="2">Ù…ØªÙˆØ³Ø·Ø© - ØªØ£Ø«ÙŠØ± ÙŠØ­ØªØ§Ø¬ Ø¹Ù„Ø§Ø¬ Ø¨Ø³ÙŠØ·</option>
                                    <option value="3">Ø¹Ø§Ù„ÙŠØ© - ØªØ£Ø«ÙŠØ± ÙƒØ¨ÙŠØ±ØŒ ÙŠØ­ØªØ§Ø¬ Ø¹Ù„Ø§Ø¬ Ù…ÙƒØ«Ù</option>
                                    <option value="4">Ø­Ø±Ø¬Ø© - ØªØ£Ø«ÙŠØ± Ø´Ø¯ÙŠØ¯ØŒ Ù‚Ø¯ ÙŠÙ‡Ø¯Ø¯ Ø§Ù„Ø­ÙŠØ§Ø©</option>
                                </select>
                            </div>
                            <div class="sac-item p-4 rounded-lg">
                                 <label for="likelihood" class="form-label required">Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø± (Likelihood)</label>
                                <select id="likelihood" name="likelihood" class="form-select mt-1" required>
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„...</option>
                                    <option value="1">Ù†Ø§Ø¯Ø± - Ù…Ø±Ø© ÙƒÙ„ Ø¹Ø¯Ø© Ø³Ù†ÙˆØ§Øª</option>
                                    <option value="2">Ù…Ù…ÙƒÙ† - Ù…Ø±Ø© ÙÙŠ Ø§Ù„Ø³Ù†Ø©</option>
                                    <option value="3">Ù…Ø­ØªÙ…Ù„ - Ø¹Ø¯Ø© Ù…Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù†Ø©</option>
                                    <option value="4">Ø´Ø¨Ù‡ Ù…Ø¤ÙƒØ¯ - Ø´Ù‡Ø±ÙŠÙ‹Ø§ Ø£Ùˆ Ø£ÙƒØ«Ø±</option>
                                </select>
                            </div>
                        </div>
                        <div id="riskLevel" class="mt-4 p-4 rounded-lg font-bold text-center hidden"></div>
                    </div>
                    <div>
                         <h3 class="font-bold text-lg text-slate-700 mb-4">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</h3>
                         ${getActionsHTML()}
                    </div>
                </div>
            `;
        }

        function getActionsHTML() {
            // Used for both complaints (Step 4) and incidents (within Step 4)
            return `
                <div class="space-y-4">
                    <div class="form-group">
                        <label for="correctiveActions" class="form-label required">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©/Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</label>
                        <textarea id="correctiveActions" name="correctiveActions" class="form-textarea" rows="4" placeholder="Ø§Ø°ÙƒØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰" required></textarea>
                        <p class="error-message"></p>
                    </div>
                    <div class="grid md:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="form-group">
                            <label for="responsiblePerson" class="form-label required">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªÙ†ÙÙŠØ°</label>
                            <select id="responsiblePersonSelect" name="responsiblePersonSelect" class="form-select" required>
                                <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„...</option>
                                <option value="Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ…Ø±ÙŠØ¶">Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ…Ø±ÙŠØ¶</option>
                                <option value="Ù…Ø¯ÙŠØ± Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰">Ù…Ø¯ÙŠØ± Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰</option>
                                <option value="Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©">Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©</option>
                                <option value="Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</option>
                                <option value="Ù…Ø´Ø±Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„">Ù…Ø´Ø±Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                                <option value="Ù…Ø¯ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©">Ù…Ø¯ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©</option>
                                <option value="other">Ø£Ø®Ø±Ù‰ (ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯)</option>
                            </select>
                            <input type="text" id="responsiblePersonOther" name="responsiblePersonOther" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ù‚Ø³Ù…" class="form-input mt-2 hidden">
                            <p class="error-message"></p>
                        </div>
                        <div class="form-group">
                            <label for="completionDate" class="form-label required">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¥ØªÙ…Ø§Ù…</label>
                            <input type="date" id="completionDate" name="completionDate" class="form-input" required>
                            <p class="error-message"></p>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- DYNAMIC LISTENERS ---
        function attachDynamicListeners() {
            const severity = document.getElementById('severity');
            const likelihood = document.getElementById('likelihood');
            if (severity && likelihood) {
                severity.addEventListener('change', calculateRiskLevel);
                likelihood.addEventListener('change', calculateRiskLevel);
            }
            // Add listener for the new select element
            const responsibleSelect = document.getElementById('responsiblePersonSelect');
            if(responsibleSelect) responsibleSelect.addEventListener('change', handleResponsiblePersonChange);
        }

        function handleResponsiblePersonChange(e) {
            const otherInput = document.getElementById('responsiblePersonOther');
            if (e.target.value === 'other') {
                otherInput.classList.remove('hidden');
                otherInput.required = true;
            } else {
                otherInput.classList.add('hidden');
                otherInput.required = false;
                otherInput.value = '';
            }
        }
        
        function calculateRiskLevel() {
            const severity = parseInt(document.getElementById('severity').value);
            const likelihood = parseInt(document.getElementById('likelihood').value);
            const riskDiv = document.getElementById('riskLevel');
            if (!severity || !likelihood) {
                riskDiv.classList.add('hidden');
                return;
            }
            
            const score = severity * likelihood;
            let level, className;

            if (score >= 9) {
                level = 'Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© - ÙŠØªØ·Ù„Ø¨ Ø¥Ø¬Ø±Ø§Ø¡ ÙÙˆØ±ÙŠ';
                className = 'bg-red-100 text-red-800';
            } else if (score >= 4) {
                 level = 'Ø®Ø·ÙˆØ±Ø© Ù…ØªÙˆØ³Ø·Ø© - ÙŠØªØ·Ù„Ø¨ Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØµØ­ÙŠØ­ÙŠØ©';
                 className = 'bg-yellow-100 text-yellow-800';
            } else {
                 level = 'Ø®Ø·ÙˆØ±Ø© Ù…Ù†Ø®ÙØ¶Ø© - ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ Ø¶Ù…Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø±ÙˆØªÙŠÙ†ÙŠØ©';
                 className = 'bg-green-100 text-green-800';
            }
            riskDiv.textContent = level;
            riskDiv.className = `mt-4 p-4 rounded-lg font-bold text-center ${className}`;
        }
        
        // --- VALIDATION LOGIC ---
        function validateCurrentStep() {
            let isValid = true;
            const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');

            requiredFields.forEach(field => {
                const isVisible = !!(field.offsetWidth || field.offsetHeight || field.getClientRects().length);
                if (isVisible && !validateField(field)) {
                    isValid = false;
                }
            });
            
            if (currentStep === 2 && selectedLocations.length === 0) {
                const locationSelector = document.getElementById('locationSelector');
                const errorP = locationSelector.parentElement.querySelector('.error-message');
                locationSelector.classList.add('invalid');
                if (errorP) errorP.textContent = 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
                isValid = false;
            }

            return isValid;
        }

        function validateField(field) {
            let isValid = true;
            const parent = field.closest('.form-group') || field.parentElement;
            const errorP = parent.querySelector('.error-message');
            let fieldElement = field;

            if (field.type === 'radio') {
                const groupName = field.name;
                const selected = document.querySelector(`input[name="${groupName}"]:checked`);
                fieldElement = parent.querySelector('.grid');
                if (!selected) {
                    isValid = false;
                }
            } else if (!field.value.trim()) {
                isValid = false;
            }
            
            fieldElement.classList.remove('invalid');
            if(errorP) errorP.textContent = '';

            if(!isValid) {
                fieldElement.classList.add('invalid');
                if(errorP) errorP.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨.';
            }

            return isValid;
        }

        // --- FORM SUBMISSION ---
        function handleFormSubmit(e) {
            e.preventDefault();
            if (!validateCurrentStep()) return;

            submitBtn.innerHTML = '<span>â³</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            submitBtn.disabled = true;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.selectedLocations = selectedLocations.map(l => `${l.code} - ${l.name}`).join(', ');

            if (data.responsiblePersonSelect === 'other') {
                data.responsiblePerson = data.responsiblePersonOther;
            } else {
                data.responsiblePerson = data.responsiblePersonSelect;
            }
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Important for Apps Script
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(res => {
                 // Even with no-cors, we assume success if no network error
                 showToast('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­!');
                 resetForm();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            })
            .finally(() => {
                submitBtn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº';
                submitBtn.disabled = false;
            });
        }

        function resetForm() {
            form.reset();
            selectedLocations = [];
            document.getElementById('selectedLocations').innerHTML = '';
            document.getElementById('locationSelector').querySelector('span').textContent = 'Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„Ø´ÙƒÙˆÙ‰...';
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('employee-reporter-fields').classList.add('hidden');
            document.getElementById('patient-reporter-fields').classList.add('hidden');
            totalSteps = 5; // Reset to default
            currentStep = 1;
            showStep(1);
            initializeForm();
            setupDynamicSteps();
        }

        // --- CUSTOM MODALS & TOASTS ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-[150%]');
            setTimeout(() => {
                toast.classList.add('translate-x-[150%]');
            }, 3000);
        }

        // --- HELPER FUNCTIONS ---
        function updateFileList() {
            const fileInput = document.getElementById('attachments');
            const fileListContainer = document.getElementById('file-list');
            fileListContainer.innerHTML = '';
            
            Array.from(fileInput.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between bg-slate-100 p-2 rounded-md text-sm';
                fileItem.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <svg class="w-5 h-5 text-slate-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>
                        <span class="font-medium text-slate-700 truncate">${file.name}</span>
                        <span class="text-slate-500 flex-shrink-0">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                `;
                fileListContainer.appendChild(fileItem);
            });
        }
        
        function initializeLocationPicker() {
            const selector = document.getElementById('locationSelector');
            const dropdown = document.getElementById('locationDropdown');
            const searchInput = document.getElementById('locationSearch');
            
            renderLocationOptions();
            selector.addEventListener('click', () => dropdown.classList.toggle('hidden'));
            document.addEventListener('click', e => {
                if (!selector.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            searchInput.addEventListener('input', () => renderLocationOptions(searchInput.value));
        }

        function renderLocationOptions(filter = '') {
            const container = document.getElementById('locationOptionsContainer');
            if(!container) return;
            container.innerHTML = '';
            const filtered = locations.filter(loc => 
                loc.name.toLowerCase().includes(filter.toLowerCase()) || 
                loc.code.toLowerCase().includes(filter.toLowerCase())
            );
            
            filtered.forEach(location => {
                const isSelected = selectedLocations.some(sl => sl.code === location.code);
                const option = document.createElement('div');
                option.className = 'p-2 hover:bg-slate-100 cursor-pointer flex items-center';
                option.innerHTML = `
                    <input type="checkbox" id="loc-${location.code}" value="${location.code}" class="ml-3 accent-[var(--primary)]" ${isSelected ? 'checked' : ''}>
                    <label for="loc-${location.code}" class="flex-grow cursor-pointer">${location.code} - ${location.name}</label>
                `;
                container.appendChild(option);
                option.querySelector('input').addEventListener('change', e => {
                    if (e.target.checked) {
                        if (!selectedLocations.some(l => l.code === location.code)) {
                           selectedLocations.push(location);
                        }
                    } else {
                        selectedLocations = selectedLocations.filter(l => l.code !== location.code);
                    }
                    updateSelectedLocationTags();
                });
            });
        }
        
        function updateSelectedLocationTags() {
            const container = document.getElementById('selectedLocations');
            const selectorSpan = document.getElementById('locationSelector').querySelector('span');
            container.innerHTML = '';
            
            if (selectedLocations.length === 0) {
                selectorSpan.textContent = 'Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„Ø´ÙƒÙˆÙ‰...';
            } else {
                 selectorSpan.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${selectedLocations.length} Ù…ÙˆÙ‚Ø¹`;
            }

            selectedLocations.forEach(location => {
                const tag = document.createElement('div');
                tag.className = 'bg-[var(--accent)] text-white text-sm font-semibold px-3 py-1 rounded-full flex items-center gap-2';
                tag.innerHTML = `
                    <span>${location.code}</span>
                    <button type="button" data-code="${location.code}" class="font-bold text-lg leading-none">&times;</button>
                `;
                container.appendChild(tag);
                tag.querySelector('button').addEventListener('click', e => {
                    const code = e.target.dataset.code;
                    selectedLocations = selectedLocations.filter(l => l.code !== code);
                    const checkbox = document.getElementById(`loc-${code}`);
                    if (checkbox) checkbox.checked = false;
                    updateSelectedLocationTags();
                });
            });

            if (selectedLocations.length > 0) {
                const locationSelector = document.getElementById('locationSelector');
                const errorP = locationSelector.parentElement.querySelector('.error-message');
                locationSelector.classList.remove('invalid');
                if(errorP) errorP.textContent = '';
            }
        }

    })();
    </script>
</body>
</html>

