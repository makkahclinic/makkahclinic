<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-dark: #152a45;
            --gold: #c9a962;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --bg-light: #f8f9fa;
            --sidebar-width: 260px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            display: flex;
        }
        .sidebar, .main-content { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        body.authenticated .sidebar, body.authenticated .main-content { visibility: visible; opacity: 1; }
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 100;
            transition: transform 0.3s;
        }
        .sidebar-header {
            padding: 1.2rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            padding: 5px;
        }
        .sidebar-header h3 {
            color: white;
            margin-top: 0.6rem;
            font-size: 0.95rem;
        }
        .sidebar-header .role-badge {
            display: inline-block;
            background: var(--gold);
            color: var(--primary-dark);
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            margin-top: 0.4rem;
            font-weight: 700;
        }
        .nav-menu { padding: 0.8rem 0; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-right: 4px solid transparent;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-right-color: var(--gold);
        }
        .nav-item i { width: 22px; text-align: center; }
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø°ÙƒÙŠØ© */
        .eoc-nav-item { justify-content: flex-start; position: relative; }
        .eoc-nav-item .eoc-chevron { margin-right: auto; transition: transform 0.3s; font-size: 0.7rem; }
        .eoc-nav-item.open .eoc-chevron { transform: rotate(180deg); }
        .eoc-submenu { 
            display: none; 
            background: rgba(0,0,0,0.25); 
            padding: 8px; 
            border-right: 3px solid var(--gold);
        }
        .eoc-submenu.open { display: block; }
        .eoc-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 6px 0;
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            text-decoration: none;
            color: white;
            transition: all 0.2s;
        }
        .eoc-link:hover { background: rgba(255,255,255,0.15); transform: translateX(-3px); }
        .eoc-link img { width: 45px; height: 45px; border-radius: 6px; background: white; }
        .eoc-link strong { display: block; font-size: 0.85rem; margin-bottom: 2px; }
        .eoc-link small { color: rgba(255,255,255,0.6); font-size: 0.7rem; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 0.8rem 0; }
        .main-content {
            margin-right: var(--sidebar-width);
            flex: 1;
            padding: 1.2rem;
            min-height: 100vh;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.2rem;
        }
        .welcome-text h2 { color: var(--primary); font-size: 1.2rem; }
        .welcome-text p { color: #666; font-size: 0.85rem; }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }

        /* Ù…Ø¤Ø´Ø±Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ© */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.2rem;
        }
        .kpi-card {
            background: white;
            border-radius: 14px;
            padding: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            border: 1px solid rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--gold);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        .kpi-card:hover::before { opacity: 1; }
        .kpi-icon {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .kpi-icon.complaints { background: linear-gradient(135deg, #667eea, #764ba2); }
        .kpi-icon.incidents { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .kpi-icon.risks { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .kpi-icon.rounds { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .kpi-icon.calibration { background: linear-gradient(135deg, #fa709a, #fee140); }
        .kpi-icon.maintenance { background: linear-gradient(135deg, #667eea, #764ba2); }
        .kpi-icon.needlestick { background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333; }
        .kpi-icon.eoc { background: linear-gradient(135deg, #10b981, #059669); transition: all 0.3s; }
        .eoc-smart-card.active-emergency { border: 2px solid #dc2626 !important; }
        .eoc-smart-card.active-emergency .kpi-icon.eoc { 
            background: linear-gradient(135deg, #dc2626, #991b1b) !important;
            animation: eocPulse 1s infinite;
        }
        @keyframes eocPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.6); }
            50% { transform: scale(1.08); box-shadow: 0 0 20px 5px rgba(220, 38, 38, 0.4); }
        }
        .kpi-info h3 { font-size: 1.6rem; color: var(--primary); line-height: 1; font-weight: 700; }
        .kpi-info p { font-size: 0.8rem; color: #555; margin-top: 4px; font-weight: 500; }
        .kpi-info .sub { font-size: 0.75rem; color: #999; display: block; margin-top: 2px; }
        .kpi-info .sub.danger { color: #DC143C !important; font-weight: 700; }

        /* Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .alerts-section {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid #eee;
        }
        .section-header h3 { font-size: 1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .alert-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .alert-item:last-child { margin-bottom: 0; }
        .alert-item.danger { background: #fff5f5; border-right: 4px solid var(--danger); }
        .alert-item.warning { background: #fffbeb; border-right: 4px solid var(--warning); }
        .alert-item.info { background: #f0f9ff; border-right: 4px solid var(--info); }
        .alert-item i { font-size: 1.1rem; }
        .alert-item.danger i { color: var(--danger); }
        .alert-item.warning i { color: var(--warning); }
        .alert-item.info i { color: var(--info); }
        .alert-item .alert-text { flex: 1; }
        .alert-item .alert-count { font-weight: 700; font-size: 1.1rem; }
        .no-alerts { text-align: center; padding: 1.5rem; color: #999; font-size: 0.9rem; }

        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid-detailed {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.2rem;
        }
        .stats-box {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stats-box h4 {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }
        .stats-row:last-child { border-bottom: none; }
        .stats-row .label { color: #666; }
        .stats-row .value { font-weight: 700; color: var(--primary); }
        .stats-row .value.danger { color: var(--danger); }
        .stats-row .value.warning { color: var(--warning); }
        .stats-row .value.success { color: var(--success); }

        /* Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© */
        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
        }
        .quick-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            text-decoration: none;
            color: var(--primary);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 0.8rem;
            text-align: center;
        }
        .quick-link:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        .quick-link i { font-size: 1.5rem; }

        .content-section { display: none; }
        .content-section.active { display: block; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        .loading-overlay.hidden { 
            display: none !important; 
            opacity: 0;
            pointer-events: none;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #eee;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }

        .users-section .user-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
        }
        .user-card:last-child { border-bottom: none; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }
        .user-details h4 { color: var(--primary); font-size: 0.9rem; }
        .user-details p { color: #666; font-size: 0.75rem; }
        select.role-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
        }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; }
            .menu-toggle { display: block !important; }
        }
        .menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .refresh-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .refresh-btn:hover { background: #f0f0f0; }
        .refresh-btn.loading i { animation: spin 1s linear infinite; }
        
        /* ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ */
        .emergency-popup-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        .emergency-popup-overlay.show { display: flex; }
        .emergency-popup {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            color: white;
            box-shadow: 0 20px 60px rgba(220,38,38,0.5);
            animation: popupBounce 0.5s ease-out;
        }
        @keyframes popupBounce {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .emergency-popup-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: pulse 1s infinite;
        }
        .emergency-popup h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .emergency-popup p {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }
        .emergency-popup-details {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: right;
        }
        .emergency-popup-details div {
            margin: 0.3rem 0;
            font-size: 0.9rem;
        }
        .emergency-popup-btn {
            display: inline-block;
            background: white;
            color: #dc2626;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1.1rem;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        .emergency-popup-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .emergency-popup-btn.secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }
        .emergency-popup-sound {
            position: absolute;
        }
        
        /* Ù†Ø§ÙØ°Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ QR */
        .qr-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9998;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .qr-modal-overlay.show { display: flex; }
        .qr-modal {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f1f33 100%);
            border-radius: 20px;
            padding: 2rem;
            max-width: 800px;
            width: 95%;
            position: relative;
            border: 2px solid rgba(201,169,98,0.3);
        }
        .qr-modal h2 { color: white !important; }
        .qr-modal-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .qr-modal-close:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .qr-cards-container {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .qr-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            border-radius: 15px;
            text-decoration: none;
            color: white;
            transition: all 0.3s;
            min-width: 180px;
        }
        .qr-card:hover { transform: translateY(-5px); }
        .qr-card.qr-red { background: rgba(220,38,38,0.5); border: 2px solid rgba(220,38,38,0.8); }
        .qr-card.qr-green { background: rgba(16,185,129,0.5); border: 2px solid rgba(16,185,129,0.8); }
        .qr-card img {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            background: white;
            padding: 8px;
            margin-bottom: 1rem;
        }
        .qr-label {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }
        .qr-card small { opacity: 0.8; font-size: 0.85rem; }
    </style>
</head>
<body>
    <!-- Ù†Ø§ÙØ°Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ QR -->
    <div class="qr-modal-overlay" id="qrCodesModal">
        <div class="qr-modal">
            <button class="qr-modal-close" onclick="closeQrCodesModal()">&times;</button>
            <h2 style="text-align:center; color:#1e3a5f; margin-bottom:1.5rem;">
                <i class="fas fa-qrcode"></i> Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
            </h2>
            <div class="qr-cards-container">
                <a href="emergency-report.html" target="_blank" class="qr-card qr-red">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://m2020m.org/emergency-report.html" alt="QR">
                    <div class="qr-label">
                        <i class="fas fa-exclamation-triangle"></i> Ø¥Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦
                    </div>
                    <small>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨Ù„Ø§Øº</small>
                </a>
                <a href="Emergency.html" target="_blank" class="qr-card qr-green">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://m2020m.org/Emergency.html" alt="QR">
                    <div class="qr-label">
                        <i class="fas fa-tv"></i> Ø§Ù„Ø´Ø§Ø´Ø§Øª
                    </div>
                    <small>Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</small>
                </a>
                <a href="emergency-poster.html" target="_blank" class="qr-card qr-green">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://m2020m.org/emergency-poster.html" alt="QR">
                    <div class="qr-label">
                        <i class="fas fa-image"></i> Ø§Ù„Ø¨ÙˆØ³ØªØ±
                    </div>
                    <small>Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</small>
                </a>
            </div>
        </div>
    </div>

    <!-- overlay ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª -->
    <div id="audioEnableOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <div style="background:linear-gradient(135deg,#1e3a5f,#2c5282);padding:3rem;border-radius:20px;text-align:center;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <div style="font-size:4rem;margin-bottom:1rem;">ğŸ””</div>
            <h2 style="color:#fff;font-size:1.8rem;margin-bottom:1rem;">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ</h2>
            <p style="color:#cbd5e0;margin-bottom:2rem;line-height:1.8;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªÙØ¹ÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ù†Ø°Ø§Ø±<br>Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</p>
            <button onclick="enableAudioAlerts()" style="background:linear-gradient(135deg,#c9a962,#d4af37);color:#1e3a5f;border:none;padding:1rem 3rem;font-size:1.3rem;font-weight:bold;border-radius:12px;cursor:pointer;font-family:inherit;">
                âœ“ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„ØµÙˆØªÙŠ
            </button>
        </div>
    </div>

    <!-- ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ -->
    <div class="emergency-popup-overlay" id="emergencyPopup">
        <div class="emergency-popup">
            <div class="emergency-popup-icon">ğŸš¨</div>
            <h2>ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦!</h2>
            <p id="emergencyPopupMessage">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦ Ø¬Ø¯ÙŠØ¯</p>
            <div class="emergency-popup-details" id="emergencyPopupDetails">
                <div><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> <span id="popupType">-</span></div>
                <div><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> <span id="popupLocation">-</span></div>
                <div><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="popupTime">-</span></div>
            </div>
            <button class="emergency-popup-btn" onclick="openEocCommand()">
                <i class="fas fa-external-link-alt"></i> Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¢Ù†
            </button>
            <button class="emergency-popup-btn secondary" onclick="closeEmergencyPopup()">
                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
            </button>
        </div>
        <audio id="emergencySound" preload="auto">
            <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
        </audio>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©...</p>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo-transparent.png" alt="Logo" onerror="this.style.display='none'">
            <h3 id="staffName">Ø§Ù„Ù…ÙˆØ¸Ù</h3>
            <span class="role-badge" id="roleBadge">Ù…ÙˆØ¸Ù</span>
        </div>
        <nav class="nav-menu">
            <a class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ù‚Ù…ÙŠ</span>
            </a>
            <a class="nav-item system-link" data-system="cbahi" href="cbahi-portal.html" target="_blank">
                <i class="fas fa-award"></i>
                <span>Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ</span>
            </a>
            <div class="nav-divider"></div>
            
            <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª -->
            <div class="nav-dropdown">
                <a class="nav-item dropdown-toggle" onclick="toggleDropdown(this)">
                    <i class="fas fa-bullhorn"></i>
                    <span>Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</span>
                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                </a>
                <div class="dropdown-menu" style="display:none; padding-right:20px;">
                    <a class="nav-item system-link" data-system="needlestick" href="ipc/incidents/report-needlestick.html" target="_blank">
                        <i class="fas fa-syringe"></i>
                        <span>ØªØ¨Ù„ÙŠØº ÙˆØ®Ø² Ø¥Ø¨Ø±ÙŠ</span>
                    </a>
                    <a class="nav-item system-link" data-system="incidents" href="incident-report.html" target="_blank">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>ØªØ¨Ù„ÙŠØº Ø­Ø§Ø¯Ø«Ø©</span>
                    </a>
                    <a class="nav-item system-link" data-system="complaints" href="report.html" target="_blank">
                        <i class="fas fa-comment-dots"></i>
                        <span>ØªØ¨Ù„ÙŠØº Ø´ÙƒÙˆÙ‰</span>
                    </a>
                </div>
            </div>
            
            <a class="nav-item system-link" data-system="training" href="#">
                <i class="fas fa-graduation-cap"></i>
                <span>Ø§Ù„ØªØ¯Ø±ÙŠØ¨</span>
            </a>
            <a class="nav-item system-link" data-system="risks" href="risk-register.html" target="_blank">
                <i class="fas fa-shield-alt"></i>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø±</span>
            </a>
            <a class="nav-item" href="eoc-command.html" target="_blank">
                <i class="fas fa-shield-alt"></i>
                <span>Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© EOC</span>
            </a>
            <!-- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ - ØªÙØªØ­ modal Ø¨Ø§Ù„Ù€ QR codes -->
            <div class="nav-item" onclick="openQrCodesModal()" style="cursor:pointer;">
                <i class="fas fa-qrcode"></i>
                <span>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</span>
            </div>
            <div class="nav-divider"></div>
            <a class="nav-item admin-only" data-section="users">
                <i class="fas fa-users-cog"></i>
                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
            </a>
            <a class="nav-item admin-only" data-section="requests">
                <i class="fas fa-user-clock"></i>
                <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span>
                <span class="badge-count" id="requestsBadge" style="display:none; background:#ef4444; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem; margin-right:auto;"></span>
            </a>
            <a class="nav-item admin-only" data-section="permissions">
                <i class="fas fa-user-shield"></i>
                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="welcome-text">
                <h2>Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø©</h2>
                <p id="dateDisplay"></p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="refresh-btn" id="refreshBtn" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <a href="index.html" class="btn btn-outline">
                    <i class="fas fa-external-link-alt"></i>
                    Ø§Ù„Ù…ÙˆÙ‚Ø¹
                </a>
            </div>
        </div>

        <section class="content-section active" id="section-dashboard">
            <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ© -->
            <div class="kpi-grid">
                <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø°ÙƒÙŠØ© -->
                <a href="eoc-command.html" target="_blank" class="kpi-card system-card eoc-smart-card" id="eocSmartCard" data-system="eoc">
                    <div class="kpi-icon eoc" id="eocSmartIcon"><i class="fas fa-triangle-exclamation"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-eoc-count">-</h3>
                        <p id="kpi-eoc-label">Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦</p>
                        <span class="sub" id="kpi-eoc-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
                    </div>
                </a>
                <a href="complaint_mentoring.html" target="_blank" class="kpi-card system-card" data-system="complaints">
                    <div class="kpi-icon complaints"><i class="fas fa-comment-dots"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-complaints-open">-</h3>
                        <p>Ø´ÙƒÙˆÙ‰ Ù…ÙØªÙˆØ­Ø©</p>
                        <span class="sub" id="kpi-complaints-escalated"></span>
                    </div>
                </a>
                <a href="incident-report-analysis.html" target="_blank" class="kpi-card system-card" data-system="incidents">
                    <div class="kpi-icon incidents"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-incidents-open">-</h3>
                        <p>Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø©</p>
                        <span class="sub" id="kpi-incidents-escalated"></span>
                    </div>
                </a>
                <a href="risk-register.html" target="_blank" class="kpi-card system-card" data-system="risks">
                    <div class="kpi-icon risks"><i class="fas fa-shield-alt"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-risks-active">-</h3>
                        <p>Ø®Ø·Ø± Ù†Ø´Ø·</p>
                        <span class="sub" id="kpi-risks-high"></span>
                    </div>
                </a>
                <a href="Round.html" target="_blank" class="kpi-card system-card" data-system="rounds">
                    <div class="kpi-icon rounds"><i class="fas fa-clipboard-check"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-rounds-today">-</h3>
                        <p>Ø¬ÙˆÙ„Ø© Ø§Ù„ÙŠÙˆÙ…</p>
                        <span class="sub" id="kpi-rounds-delayed"></span>
                    </div>
                </a>
                <a href="calibration.html" target="_blank" class="kpi-card system-card" data-system="calibration">
                    <div class="kpi-icon calibration"><i class="fas fa-cogs"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-calibration-compliance">-</h3>
                        <p>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©</p>
                        <span class="sub" id="kpi-calibration-overdue"></span>
                    </div>
                </a>
                <a href="maintenance.html" target="_blank" class="kpi-card system-card" data-system="maintenance">
                    <div class="kpi-icon maintenance"><i class="fas fa-wrench"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-maintenance-total">-</h3>
                        <p>Ø£Ø¬Ù‡Ø²Ø© Ø¨Ø¯ÙˆÙ† ØµÙŠØ§Ù†Ø©</p>
                        <span class="sub" id="kpi-maintenance-completed" style="color:#28a745"></span>
                        <span class="sub" id="kpi-maintenance-overdue"></span>
                    </div>
                </a>
                <a href="pages/needleÙ€stickÙ€analysis.html" target="_blank" class="kpi-card system-card" data-system="needlestick">
                    <div class="kpi-icon needlestick"><i class="fas fa-syringe"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-needlestick">-</h3>
                        <p>Ø­Ø§Ù„Ø© ÙˆØ®Ø² Ø¥Ø¨Ø±ÙŠ</p>
                        <span class="sub" id="kpi-needlestick-month"></span>
                    </div>
                </a>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© -->
            <div class="alerts-section">
                <div class="section-header">
                    <h3><i class="fas fa-bell"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„ØªØµØ¹ÙŠØ¯Ø§Øª</h3>
                </div>
                <div id="alertsContainer">
                    <div class="no-alerts">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª...</p>
                    </div>
                </div>
            </div>

            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªÙØµÙŠÙ„ÙŠØ© -->
            <div class="stats-grid-detailed">
                <div class="stats-box">
                    <h4><i class="fas fa-comment-dots"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h4>
                    <div class="stats-row">
                        <span class="label">Ø¬Ø¯ÙŠØ¯Ø©</span>
                        <span class="value" id="stat-complaints-new">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
                        <span class="value warning" id="stat-complaints-progress">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ØµØ¹Ù‘Ø¯Ø©</span>
                        <span class="value danger" id="stat-complaints-escalated">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ØºÙ„Ù‚Ø©</span>
                        <span class="value success" id="stat-complaints-closed">-</span>
                    </div>
                </div>
                <div class="stats-box">
                    <h4><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</h4>
                    <div class="stats-row">
                        <span class="label">Ø¬Ø¯ÙŠØ¯Ø©</span>
                        <span class="value" id="stat-incidents-new">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</span>
                        <span class="value warning" id="stat-incidents-progress">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ØµØ¹Ù‘Ø¯Ø©</span>
                        <span class="value danger" id="stat-incidents-escalated">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ØºÙ„Ù‚Ø©</span>
                        <span class="value success" id="stat-incidents-closed">-</span>
                    </div>
                </div>
                <div class="stats-box">
                    <h4><i class="fas fa-shield-alt"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h4>
                    <div class="stats-row">
                        <span class="label">Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ</span>
                        <span class="value danger" id="stat-risks-high">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·</span>
                        <span class="value warning" id="stat-risks-medium">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶</span>
                        <span class="value" id="stat-risks-low">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ÙØ¹Ø§Ù„Ø¬Ø©</span>
                        <span class="value success" id="stat-risks-resolved">-</span>
                    </div>
                </div>
            </div>

            <!-- Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
            <div class="stats-box">
                <h4><i class="fas fa-rocket"></i> Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</h4>
                <div class="quick-links-grid">
                    <a href="report.html" class="quick-link" target="_blank">
                        <i class="fas fa-comment-alt"></i>
                        <span>Ø±ÙØ¹ Ø´ÙƒÙˆÙ‰</span>
                    </a>
                    <a href="incident-report.html" class="quick-link" target="_blank">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Ø¨Ù„Ø§Øº Ø­Ø§Ø¯Ø«Ø©</span>
                    </a>
                    <a href="risk-register.html?action=new" class="quick-link" target="_blank">
                        <i class="fas fa-shield-virus"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø±</span>
                    </a>
                    <a href="ipc/incidents/report-needlestick.html" class="quick-link" target="_blank">
                        <i class="fas fa-syringe"></i>
                        <span>Ø¨Ù„Ø§Øº ÙˆØ®Ø²</span>
                    </a>
                    <a href="mega.html" class="quick-link" target="_blank">
                        <i class="fas fa-th-large"></i>
                        <span>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ù‚Ù…ÙŠ</span>
                    </a>
                    <a href="cbahi-portal.html" class="quick-link" target="_blank">
                        <i class="fas fa-award"></i>
                        <span>Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ</span>
                    </a>
                </div>
            </div>
        </section>

        <section class="content-section" id="section-users">
            <div class="stats-box users-section">
                <h4><i class="fas fa-crown"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø© - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
                <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø¹Ø±Ø¶ØŒ ØªØ¹Ù„ÙŠÙ‚ØŒ Ø­Ø°ÙØŒ Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
                
                <div id="usersStats" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; padding:15px; background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius:12px;">
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #10b981;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#10b981;" id="usersActiveCount">0</div>
                        <div style="font-size:0.8rem; color:#666;">Ù†Ø´Ø·</div>
                    </div>
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #f59e0b;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#f59e0b;" id="usersSuspendedCount">0</div>
                        <div style="font-size:0.8rem; color:#666;">Ù…Ø¹Ù„Ù‚</div>
                    </div>
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #1e3a5f;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#1e3a5f;" id="usersTotalCount">0</div>
                        <div style="font-size:0.8rem; color:#666;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                    </div>
                </div>
                
                <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="usersSearchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." style="flex:1; min-width:200px; padding:10px 15px; border:1px solid #ddd; border-radius:8px; font-family:inherit;">
                    <button onclick="loadUsers()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-family:inherit;">
                        <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
                
                <div id="usersContainer">
                    <div class="no-alerts"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <section class="content-section" id="section-requests">
            <div class="stats-box">
                <h4><i class="fas fa-user-clock"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h4>
                <div id="requestsContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <section class="content-section" id="section-permissions">
            <div class="stats-box">
                <h4><i class="fas fa-user-shield"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„</h4>
                <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¬Ø§Ù† ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù</p>
                
                <div id="permissionsStats" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; padding:15px; background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius:12px;">
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #10b981;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#10b981;" id="statsActive">0</div>
                        <div style="font-size:0.8rem; color:#666;">ÙØ¹Ø§Ù„</div>
                    </div>
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #f59e0b;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#f59e0b;" id="statsSuspended">0</div>
                        <div style="font-size:0.8rem; color:#666;">Ù…Ø¹Ù„Ù‚</div>
                    </div>
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid:#1e3a5f;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#1e3a5f;" id="statsTotal">0</div>
                        <div style="font-size:0.8rem; color:#666;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                    </div>
                </div>
                
                <div id="permissionsContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>
    </main>
    
    <div id="toastNotification" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:15px 30px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.2); display:none; z-index:9999; font-weight:600;">
        <i class="fas fa-check-circle" style="margin-left:8px;"></i>
        <span id="toastMessage">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
            authDomain: "insurance-check-6cec9.firebaseapp.com",
            projectId: "insurance-check-6cec9",
            storageBucket: "insurance-check-6cec9.appspot.com",
            messagingSenderId: "992769471393",
            appId: "1:992769471393:web:c8a9400210a0e7901011e0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        let currentUserRole = null;

        // API URLs
        const APIs = {
            complaints: "https://script.google.com/macros/s/AKfycbyE0nbyfYrDZeOHr6TuEQP7ivpOLF1pLmBFoF7fkDmNjQp5g6dW4i0xkcSBJJRaoOCVAw/exec",
            incidents: "https://script.google.com/macros/s/AKfycbxHW20iOESJdvDuGBjKBVGZ7ZVlNy-PfRY8tJvmsIvtdcSxhbiBYL0CXLVwCjIJz-y8/exec",
            risks: "https://script.google.com/macros/s/AKfycbyDLVS-KI6_EEVE68f9O9ubgUhZtA9LBVofWJ4l6cEDnYTuDvvyQf4cEwQxDFC532Pf/exec",
            rounds: "https://script.google.com/macros/s/AKfycbwjoTetIgrjnESeW3gJlezUbm4ReK3nF1nS5xbs1oItrHMsfTlMfkWCfn45S9sSjf3y/exec",
            needlestick: "https://script.google.com/macros/s/AKfycbyWPna2RXgl_P8xYfnIxG634pS8fVoAtW6X8Ch8-fzM0ASZNz49OIORmYwxjbiVapHEyg/exec",
            calibration: "https://script.google.com/macros/s/AKfycbxhKSq0qMIT85_pUfiba5V5Pi-kO_Df4Qw98MRIM4fmCb-XcheI8uGQccFxuKjigATHlQ/exec",
            maintenance: "https://script.google.com/macros/s/AKfycbxw6oWSHKDjeZI6dsspS3PVVwbO9KO5UnjKGqDa_yP9cYAVjNHh6WMfQrdlpkF_A25--A/exec",
            eoc: "https://script.google.com/macros/s/AKfycbytslZrI7jIgUY0iavZPfgOiEPZKgkjFaNgTBCcWByHLARdEFb4Qkzi4Ecad0v_Q7SL1w/exec"
        };
        
        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ calibration.html)
        function calculateCalibrationStats(data) {
            if (!data || data.status !== 'success' || !data.data) {
                return { compliance: 0, overdue: 0, pass: 0, fail: 0, total: 0, upcoming: 0 };
            }
            
            const assetsMap = data.data.assetsMap || {};
            const records = data.data.records || [];
            
            // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
            let totalTasks = 0;
            Object.values(assetsMap).forEach(arr => totalTasks += arr.length);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ ÙˆØ§Ù„Ù…ØªØ£Ø®Ø±
            let pass = 0, fail = 0, overdue = 0, upcoming = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Ø­Ø¯ Ø§Ù„Ù€ 30 ÙŠÙˆÙ… Ù„Ù„Ù‚Ø§Ø¯Ù…
            const upcomingThreshold = new Date(today);
            upcomingThreshold.setDate(upcomingThreshold.getDate() + 30);
            
            // ØªØ¬Ù…ÙŠØ¹ Ø£Ø­Ø¯Ø« Ø³Ø¬Ù„ Ù„ÙƒÙ„ Ø¬Ù‡Ø§Ø² (Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø­Ø±ÙˆÙ ÙƒØ¨ÙŠØ±Ø© Ù…Ù† Ø§Ù„Ù€ API)
            const latestRecords = {};
            records.forEach(r => {
                const assetID = r.AssetID || r.assetID || r.asset_id;
                const recordDate = r.TestDate || r.Timestamp || r.date;
                if (!assetID) return;
                if (!latestRecords[assetID] || new Date(recordDate) > new Date(latestRecords[assetID].recordDate)) {
                    latestRecords[assetID] = { ...r, recordDate };
                }
            });
            
            Object.values(latestRecords).forEach(r => {
                // Ø­Ø³Ø§Ø¨ Pass/Fail (Result Ø¨Ø­Ø±Ù ÙƒØ¨ÙŠØ±)
                const result = r.Result || r.result;
                if (result === 'Pass') pass++;
                else if (result === 'Fail') fail++;
                
                // Ø­Ø³Ø§Ø¨ Overdue Ùˆ Upcoming (NextDue Ø¨Ø­Ø±Ù ÙƒØ¨ÙŠØ±)
                const nd = r.NextDue || r.nextDue || r.next_due;
                if (nd) {
                    const nextDue = new Date(nd);
                    if (nextDue < today) {
                        overdue++;
                    } else if (nextDue <= upcomingThreshold) {
                        upcoming++;
                    }
                }
            });
            
            // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ = (Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…) * 100
            const compliance = totalTasks > 0 ? Math.round((pass / totalTasks) * 100) : 0;
            
            console.log(`Calibration: Pass=${pass}, Fail=${fail}, Overdue=${overdue}, Total=${totalTasks}, Compliance=${compliance}%`);
            
            return { compliance, overdue, pass, fail, total: totalTasks, upcoming };
        }

        // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ
        const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        }).format(new Date());
        document.getElementById('dateDisplay').textContent = hijriDate;

        async function getUserRole(uid) {
            try {
                const docRef = doc(db, "staff_roles", uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data(); // Ù†Ø±Ø¬Ø¹ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                }
                return null;
            } catch (e) {
                console.error('Role check error:', e);
                return null;
            }
        }
        
        let userAllowedSystems = [];
        
        function applySystemsFilter(role, allowedSystems) {
            // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø«Ø§Ø¨ØªØ© Ù„Ù„Ø¬Ù…ÙŠØ¹ - Ù„Ø§ ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ø±ÙˆØ§Ø¨Ø·
            console.log('Sidebar is fixed for all users - no filtering applied');
            // Ù„Ø§ Ù†Ø®ÙÙŠ Ø£ÙŠ Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
        }

        async function apiCall(url, action, payload = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, payload }),
                    redirect: 'follow'
                });
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('Parse error:', text.substring(0, 200));
                    return { ok: false, error: 'Invalid response' };
                }
            } catch (e) {
                console.error(`API Error (${action}):`, e);
                return { ok: false, error: e.message };
            }
        }

        async function fetchJsonp(url) {
            const r = await fetch(url, { redirect: 'follow' });
            const text = await r.text();
            const m = text.match(/^[a-zA-Z_$][\w$]*\s*\((.*)\)\s*;?\s*$/s);
            if (m && m[1]) return JSON.parse(m[1]);
            return JSON.parse(text);
        }

        async function loadDashboardData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            
            console.log('Loading dashboard data...');

            try {
                const [complaintsRes, incidentsRes, risksRes, roundsRes, needlestickRes, calibrationRes, maintenanceRes] = await Promise.all([
                    apiCall(APIs.complaints, 'getComplaintStats', {}),
                    apiCall(APIs.incidents, 'getIncidentStats', {}),
                    fetch(APIs.risks + '?action=metrics').then(r => r.json()).catch(e => { console.error('Risks error:', e); return { success: false }; }),
                    apiCall(APIs.rounds, 'getMetrics', {}),
                    fetchJsonp(APIs.needlestick + '?action=data').catch(e => { console.error('Needlestick error:', e); return { success: false }; }),
                    fetch(APIs.calibration).then(r => r.json()).catch(e => { console.error('Calibration error:', e); return { status: 'error' }; }),
                    apiCall(APIs.maintenance, 'getKPIs', {})
                ]);

                console.log('Complaints:', complaintsRes);
                console.log('Incidents:', incidentsRes);
                console.log('Risks:', risksRes);
                console.log('Rounds:', roundsRes);
                console.log('Calibration:', calibrationRes);
                console.log('Maintenance:', maintenanceRes);

                // Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ±Ø¬Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙ„ÙŠØ³ ÙÙŠ stats
                if (complaintsRes.ok) {
                    const s = complaintsRes;
                    const openComplaints = (s.new || 0) + (s.in_progress || 0);
                    document.getElementById('kpi-complaints-open').textContent = openComplaints;
                    const escEl = document.getElementById('kpi-complaints-escalated');
                    if (s.escalated > 0) {
                        escEl.textContent = `${s.escalated} Ù…ØµØ¹Ù‘Ø¯Ø©`;
                        escEl.classList.add('danger');
                    } else {
                        escEl.textContent = '';
                        escEl.classList.remove('danger');
                    }
                    document.getElementById('stat-complaints-new').textContent = s.new || 0;
                    document.getElementById('stat-complaints-progress').textContent = s.in_progress || 0;
                    document.getElementById('stat-complaints-escalated').textContent = s.escalated || 0;
                    document.getElementById('stat-complaints-closed').textContent = s.closed || 0;
                } else {
                    console.warn('Complaints API failed:', complaintsRes);
                }

                // Ø§Ù„Ø­ÙˆØ§Ø¯Ø« - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ±Ø¬Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ byStatus Ù„Ù„ØªØµØ¹ÙŠØ¯Ø§Øª
                if (incidentsRes.ok) {
                    const s = incidentsRes;
                    const openIncidents = s.open || ((s.new || 0) + (s.in_progress || 0) + (s.under_review || 0));
                    const escalatedCount = s.byStatus?.escalated?.count || s.escalated || 0;
                    
                    document.getElementById('kpi-incidents-open').textContent = openIncidents;
                    const incEscEl = document.getElementById('kpi-incidents-escalated');
                    if (escalatedCount > 0) {
                        incEscEl.textContent = `${escalatedCount} Ù…ØµØ¹Ù‘Ø¯Ø©`;
                        incEscEl.classList.add('danger');
                    } else {
                        incEscEl.textContent = '';
                        incEscEl.classList.remove('danger');
                    }
                    document.getElementById('stat-incidents-new').textContent = s.new || s.open || 0;
                    document.getElementById('stat-incidents-progress').textContent = s.in_progress || 0;
                    document.getElementById('stat-incidents-escalated').textContent = escalatedCount;
                    document.getElementById('stat-incidents-closed').textContent = s.closed || 0;
                } else {
                    console.warn('Incidents API failed:', incidentsRes);
                }

                // Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± - ÙŠØ³ØªØ®Ø¯Ù… ok ÙˆÙ„ÙŠØ³ success
                if (risksRes.ok) {
                    const r = risksRes;
                    // ext = Ø®Ø§Ø±Ø¬ÙŠØŒ total = Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ high/med/low = Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
                    const activeRisks = r.total || (r.high || 0) + (r.med || 0) + (r.low || 0);
                    document.getElementById('kpi-risks-active').textContent = activeRisks;
                    document.getElementById('kpi-risks-high').textContent = r.high ? `${r.high} Ø¹Ø§Ù„ÙŠ` : (r.ext ? `${r.ext} Ø®Ø§Ø±Ø¬ÙŠ` : '');
                    document.getElementById('stat-risks-high').textContent = r.high || 0;
                    document.getElementById('stat-risks-medium').textContent = r.med || r.medium || 0;
                    document.getElementById('stat-risks-low').textContent = r.low || 0;
                    document.getElementById('stat-risks-resolved').textContent = r.resolved || r.closed || 0;
                } else {
                    console.warn('Risks API failed:', risksRes);
                }

                // Ø§Ù„Ø¬ÙˆÙ„Ø§Øª - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ±Ø¬Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø©
                if (roundsRes.ok) {
                    const rd = roundsRes;
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    document.getElementById('kpi-rounds-today').textContent = rd.completed || 0;
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¨ÙˆØ¶ÙˆØ­
                    if (rd.delayed > 0) {
                        document.getElementById('kpi-rounds-delayed').textContent = `${rd.delayed} Ù…ØªØ£Ø®Ø±Ø©`;
                        document.getElementById('kpi-rounds-delayed').style.color = '#DC143C';
                    } else if (rd.violations > 0) {
                        document.getElementById('kpi-rounds-delayed').textContent = `${rd.violations} Ù…Ø®Ø§Ù„ÙØ©`;
                        document.getElementById('kpi-rounds-delayed').style.color = '#f0ad4e';
                    } else {
                        document.getElementById('kpi-rounds-delayed').textContent = '';
                    }
                } else {
                    console.warn('Rounds API failed:', roundsRes);
                }

                // Ø§Ù„ÙˆØ®Ø² Ø§Ù„Ø¥Ø¨Ø±ÙŠ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ±Ø¬Ø¹ ÙƒÙ€ array ÙÙŠ rows Ø£Ùˆ data
                console.log('Needlestick:', needlestickRes);
                const needleData = needlestickRes.rows || needlestickRes.data;
                if ((needlestickRes.success || needlestickRes.status === 'success') && Array.isArray(needleData)) {
                    const records = needleData;
                    const total = records.length;
                    const now = new Date();
                    const thisMonth = records.filter(r => {
                        const d = new Date(r.date || r.timestamp);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    }).length;
                    document.getElementById('kpi-needlestick').textContent = total;
                    document.getElementById('kpi-needlestick-month').textContent = thisMonth > 0 ? `${thisMonth} Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±` : '';
                } else if (needlestickRes.total !== undefined) {
                    document.getElementById('kpi-needlestick').textContent = needlestickRes.total || 0;
                    document.getElementById('kpi-needlestick-month').textContent = needlestickRes.thisMonth ? `${needlestickRes.thisMonth} Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±` : '';
                } else {
                    document.getElementById('kpi-needlestick').textContent = '-';
                    console.warn('Needlestick API failed:', needlestickRes);
                }

                // Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©/Ø§Ù„ØµÙŠØ§Ù†Ø© - Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const calStats = calculateCalibrationStats(calibrationRes);
                console.log('Calibration Stats:', calStats);
                
                if (calStats.total > 0) {
                    // Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ ÙƒØ±Ù‚Ù… Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø¹Ù„Ø§Ù…Ø© %
                    const compEl = document.getElementById('kpi-calibration-compliance');
                    compEl.textContent = calStats.compliance + '%';
                    
                    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù†Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©
                    if (calStats.compliance >= 80) {
                        compEl.style.color = '#28a745'; // Ø£Ø®Ø¶Ø±
                    } else if (calStats.compliance >= 70) {
                        compEl.style.color = '#ff9800'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                    } else {
                        compEl.style.color = '#DC143C'; // Ø£Ø­Ù…Ø±
                    }
                    
                    // Ø§Ù„ØªÙØ§ØµÙŠÙ„: Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ø¨Ø§Ù„Ø£Ø­Ù…Ø±
                    const overdueEl = document.getElementById('kpi-calibration-overdue');
                    if (calStats.overdue > 0) {
                        overdueEl.textContent = `${calStats.overdue} Ø¬Ù‡Ø§Ø² Ù…ØªØ£Ø®Ø±`;
                        overdueEl.classList.add('danger');
                    } else {
                        overdueEl.textContent = `${calStats.total} Ø¬Ù‡Ø§Ø² Ù…ÙØµØ§Ù†`;
                        overdueEl.classList.remove('danger');
                        overdueEl.style.color = '#28a745';
                    }
                } else {
                    document.getElementById('kpi-calibration-compliance').textContent = '--';
                    document.getElementById('kpi-calibration-overdue').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
                }

                // Ø§Ù„ØµÙŠØ§Ù†Ø© - Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© (Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§Øª ØµÙØ­Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©)
                console.log('Processing Maintenance:', maintenanceRes);
                if (maintenanceRes && (maintenanceRes.success || maintenanceRes.ok || maintenanceRes.notServiced !== undefined || maintenanceRes.totalDevices !== undefined)) {
                    const m = maintenanceRes.data || maintenanceRes;
                    // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ØºÙŠØ± Ø§Ù„Ù…ØµØ§Ù†Ø© (Ù…Ø«Ù„ ØµÙØ­Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©)
                    const notServiced = m.notServiced ?? m.notServicedDevices ?? 0;
                    const completed = m.completed ?? m.servicedDevices ?? 0;
                    const overdue = m.overdue ?? m.overdueDevices ?? 0;
                    
                    document.getElementById('kpi-maintenance-total').textContent = notServiced;
                    
                    const completedEl = document.getElementById('kpi-maintenance-completed');
                    const overdueEl = document.getElementById('kpi-maintenance-overdue');
                    
                    completedEl.textContent = `Ù…ÙƒØªÙ…Ù„Ø© ${completed}`;
                    completedEl.style.color = '#28a745';
                    
                    if (overdue > 0) {
                        overdueEl.textContent = `Ù…ØªØ£Ø®Ø±Ø© ${overdue}`;
                        overdueEl.style.color = '#DC143C';
                        overdueEl.classList.add('danger');
                    } else {
                        overdueEl.textContent = '';
                        overdueEl.classList.remove('danger');
                    }
                } else {
                    document.getElementById('kpi-maintenance-total').textContent = '--';
                    document.getElementById('kpi-maintenance-completed').textContent = '';
                    document.getElementById('kpi-maintenance-overdue').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª - Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                updateAlerts(complaintsRes, incidentsRes, risksRes, roundsRes, calStats);

                // Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø°ÙƒÙŠØ©
                updateEocSmartCard();

            } catch (e) {
                console.error('Dashboard load error:', e);
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø°ÙƒÙŠØ©
        async function updateEocSmartCard() {
            const card = document.getElementById('eocSmartCard');
            const countEl = document.getElementById('kpi-eoc-count');
            const labelEl = document.getElementById('kpi-eoc-label');
            const statusEl = document.getElementById('kpi-eoc-status');
            
            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const [activeRes, reportsRes] = await Promise.all([
                    fetchJsonp(APIs.eoc + '?action=getActiveCommand&callback=_'),
                    fetchJsonp(APIs.eoc + '?action=getEmergencyReports&limit=100&callback=_')
                ]);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·Ø© (Ù…Ø«Ù„ Emergency.html)
                // Ø§Ù„Ù€ API ÙŠÙØ±Ø¬Ø¹: { ok: true, command: { status: 'active', sessionId: '...' } }
                const cmd = activeRes.command || {};
                const isActive = activeRes.ok && 
                    (cmd.status === 'active' || activeRes.status === 'active') && 
                    cmd.sessionId;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                let totalReports = 0;
                let openReports = 0;
                let thisMonthReports = 0;
                
                if (reportsRes.ok && Array.isArray(reportsRes.reports)) {
                    const reports = reportsRes.reports;
                    totalReports = reports.length;
                    openReports = reports.filter(r => r.status !== 'Ù…ØºÙ„Ù‚').length;
                    
                    const now = new Date();
                    const thisMonth = now.getMonth();
                    const thisYear = now.getFullYear();
                    thisMonthReports = reports.filter(r => {
                        const d = new Date(r.date);
                        return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
                    }).length;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© - ØªÙ†Ø¨Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ù…Ø± Ù†Ø´Ø· Ø£Ùˆ Ø¨Ù„Ø§ØºØ§Øª Ù…ÙØªÙˆØ­Ø©
                const shouldAlert = isActive || openReports > 0;
                
                if (shouldAlert) {
                    card.classList.add('active-emergency');
                    if (isActive) {
                        countEl.textContent = 'âš ï¸';
                        labelEl.textContent = 'Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·Ø©!';
                        // Ø¹Ø±Ø¶ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø£Ù…Ø±
                        const cmd = activeRes.command || {};
                        statusEl.textContent = cmd.responseType || cmd.type || 'Ø­Ø§Ù„Ø© Ø¬Ø§Ø±ÙŠØ©';
                    } else {
                        countEl.textContent = openReports;
                        labelEl.textContent = 'Ø¨Ù„Ø§Øº Ù…ÙØªÙˆØ­!';
                        statusEl.textContent = 'ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©';
                    }
                    statusEl.style.color = '#dc2626';
                    statusEl.style.fontWeight = '700';
                } else {
                    card.classList.remove('active-emergency');
                    countEl.textContent = totalReports;
                    labelEl.textContent = 'Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦';
                    if (thisMonthReports > 0) {
                        statusEl.textContent = thisMonthReports + ' Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±';
                        statusEl.style.color = '#10b981';
                    } else {
                        statusEl.textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ âœ“';
                        statusEl.style.color = '#10b981';
                    }
                    statusEl.style.fontWeight = '600';
                }
            } catch (e) {
                console.error('EOC Smart Card error:', e);
                countEl.textContent = '-';
                statusEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
                statusEl.style.color = '#999';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ (Ù…Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª)
        setInterval(updateEocSmartCard, 5000);

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦
        let lastKnownReportId = localStorage.getItem('lastKnownReportId') || '';
        let lastKnownActiveSession = localStorage.getItem('lastKnownActiveSession') || '';
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ - Ù…ØªØ§Ø­Ø© globally Ù„Ù„Ù€ onclick
        // ====== Ù†Ø¸Ø§Ù… ØµÙˆØª Ø³ÙŠØ±ÙŠÙ† Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Web Audio API ======
        let alarmRepeatInterval = null;
        let audioCtx = null;
        let audioEnabled = localStorage.getItem('admin_audio_enabled') === '1';
        let sirenPlaying = false;
        let sirenOscillators = [];
        
        // Ø¥Ø®ÙØ§Ø¡ overlay Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹
        if (audioEnabled) {
            document.getElementById('audioEnableOverlay').style.display = 'none';
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch(e) { console.log('AudioContext init error:', e); }
        }
        
        // Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª (ØªÙØ³ØªØ¯Ø¹Ù‰ Ù…Ù† Ø§Ù„Ø²Ø±)
        window.enableAudioAlerts = function() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªØ¬Ø±ÙŠØ¨ÙŠ ÙÙˆØ±ÙŠ
                playEmergencySiren();
                audioEnabled = true;
                localStorage.setItem('admin_audio_enabled', '1');
                document.getElementById('audioEnableOverlay').style.display = 'none';
            } catch(e) {
                alert('ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª: ' + e.message);
            }
        };
        
        // ØµÙˆØª Ø³ÙŠØ±ÙŠÙ† Ø¥Ø³Ø¹Ø§Ù Ø§Ø­ØªØ±Ø§ÙÙŠ (Hi-Lo Siren)
        function playEmergencySiren() {
            if (!audioEnabled || !audioCtx) {
                console.log('Audio not enabled or no context');
                return;
            }
            try {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ AudioContext Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ù„Ù‚Ø§Ù‹
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø³ÙŠØ±ÙŠÙ† Ø³Ø§Ø¨Ù‚
                stopSiren();
                
                const now = audioCtx.currentTime;
                const duration = 2.5; // Ù…Ø¯Ø© Ø§Ù„Ø³ÙŠØ±ÙŠÙ† 2.5 Ø«Ø§Ù†ÙŠØ©
                
                // Ø¥Ù†Ø´Ø§Ø¡ 3 Ø¯ÙˆØ±Ø§Øª Ø³ÙŠØ±ÙŠÙ† (Hi-Lo)
                for (let cycle = 0; cycle < 3; cycle++) {
                    const cycleStart = now + (cycle * duration);
                    
                    // Oscillator Ù„Ù„Ù†ØºÙ…Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© (Hi)
                    const oscHi = audioCtx.createOscillator();
                    const gainHi = audioCtx.createGain();
                    oscHi.type = 'sawtooth';
                    oscHi.frequency.setValueAtTime(800, cycleStart);
                    oscHi.frequency.linearRampToValueAtTime(1000, cycleStart + 0.6);
                    oscHi.frequency.linearRampToValueAtTime(800, cycleStart + 1.2);
                    gainHi.gain.setValueAtTime(0, cycleStart);
                    gainHi.gain.linearRampToValueAtTime(0.5, cycleStart + 0.1);
                    gainHi.gain.setValueAtTime(0.5, cycleStart + 1.1);
                    gainHi.gain.linearRampToValueAtTime(0, cycleStart + 1.25);
                    oscHi.connect(gainHi);
                    gainHi.connect(audioCtx.destination);
                    oscHi.start(cycleStart);
                    oscHi.stop(cycleStart + 1.25);
                    sirenOscillators.push(oscHi);
                    
                    // Oscillator Ù„Ù„Ù†ØºÙ…Ø© Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© (Lo)
                    const oscLo = audioCtx.createOscillator();
                    const gainLo = audioCtx.createGain();
                    oscLo.type = 'sawtooth';
                    oscLo.frequency.setValueAtTime(600, cycleStart + 1.25);
                    oscLo.frequency.linearRampToValueAtTime(700, cycleStart + 1.85);
                    oscLo.frequency.linearRampToValueAtTime(600, cycleStart + 2.45);
                    gainLo.gain.setValueAtTime(0, cycleStart + 1.25);
                    gainLo.gain.linearRampToValueAtTime(0.5, cycleStart + 1.35);
                    gainLo.gain.setValueAtTime(0.5, cycleStart + 2.35);
                    gainLo.gain.linearRampToValueAtTime(0, cycleStart + 2.5);
                    oscLo.connect(gainLo);
                    gainLo.connect(audioCtx.destination);
                    oscLo.start(cycleStart + 1.25);
                    oscLo.stop(cycleStart + 2.5);
                    sirenOscillators.push(oscLo);
                }
                
                sirenPlaying = true;
                console.log('Emergency siren playing!');
                
            } catch(e) { 
                console.error('Siren error:', e); 
            }
        }
        
        function stopSiren() {
            sirenOscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            sirenOscillators = [];
            sirenPlaying = false;
        }
        
        function startAlarmRepeat() {
            // Ø´ØºÙ„ Ø§Ù„Ø³ÙŠØ±ÙŠÙ† ÙÙˆØ±Ø§Ù‹
            playEmergencySiren();
            // ÙƒØ±Ø± ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (60000ms)
            if (alarmRepeatInterval) clearInterval(alarmRepeatInterval);
            alarmRepeatInterval = setInterval(playEmergencySiren, 60000);
        }
        
        function stopAlarmRepeat() {
            if (alarmRepeatInterval) {
                clearInterval(alarmRepeatInterval);
                alarmRepeatInterval = null;
            }
            stopSiren();
        }
        
        window.showEmergencyPopup = function(type, message, details) {
            const popup = document.getElementById('emergencyPopup');
            
            document.getElementById('emergencyPopupMessage').textContent = message;
            document.getElementById('popupType').textContent = details.type || '-';
            document.getElementById('popupLocation').textContent = details.location || '-';
            document.getElementById('popupTime').textContent = details.time || new Date().toLocaleTimeString('ar-SA');
            
            popup.classList.add('show');
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (ÙŠØªÙƒØ±Ø± ÙƒÙ„ 3 Ø¯Ù‚Ø§Ø¦Ù‚)
            startAlarmRepeat();
        };
        
        window.closeEmergencyPopup = function() {
            document.getElementById('emergencyPopup').classList.remove('show');
            // Ø¥ÙŠÙ‚Ø§Ù ØªÙƒØ±Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            stopAlarmRepeat();
        };
        
        // Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ QR
        window.openQrCodesModal = function() {
            document.getElementById('qrCodesModal').classList.add('show');
        };
        
        window.closeQrCodesModal = function() {
            document.getElementById('qrCodesModal').classList.remove('show');
        };
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.getElementById('qrCodesModal').addEventListener('click', function(e) {
            if (e.target === this) window.closeQrCodesModal();
        });
        
        window.openEocCommand = function() {
            window.closeEmergencyPopup();
            window.open('eoc-command.html', '_blank');
        };
        
        // ÙØ­Øµ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        // Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: Ø£ÙŠ Ø¨Ù„Ø§Øº Ù…ÙØªÙˆØ­ = ØªÙ†Ø¨ÙŠÙ‡ (Ø­ØªÙ‰ Ù„Ùˆ Ù‚Ø¯ÙŠÙ…)
        let currentAlertedReport = null; // Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹
        
        async function checkNewEmergencies() {
            try {
                const [activeRes, reportsRes] = await Promise.all([
                    fetchJsonp(APIs.eoc + '?action=getActiveCommand&callback=_'),
                    fetchJsonp(APIs.eoc + '?action=getEmergencyReports&limit=10&callback=_')
                ]);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù…Ø± Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·
                if (activeRes.ok && activeRes.status === 'active' && activeRes.command?.sessionId) {
                    const currentSession = activeRes.command.sessionId;
                    if (currentSession !== lastKnownActiveSession) {
                        lastKnownActiveSession = currentSession;
                        localStorage.setItem('lastKnownActiveSession', currentSession);
                        showEmergencyPopup('command', 'Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·Ø©!', {
                            type: activeRes.command.responseType || activeRes.command.type || 'Ø·ÙˆØ§Ø±Ø¦',
                            location: activeRes.command.floor || 'Ø§Ù„Ù…Ø¨Ù†Ù‰ ÙƒØ§Ù…Ù„Ø§Ù‹',
                            time: new Date().toLocaleTimeString('ar-SA')
                        });
                        return; // Ù„Ø§ ØªØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ù…Ø± Ø·ÙˆØ§Ø±Ø¦
                    }
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ù„Ø§ØºØ§Øª Ù…ÙØªÙˆØ­Ø©
                if (reportsRes.ok && Array.isArray(reportsRes.reports) && reportsRes.reports.length > 0) {
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¨Ù„Ø§Øº Ù…ÙØªÙˆØ­
                    const openReport = reportsRes.reports.find(r => r.status !== 'Ù…ØºÙ„Ù‚');
                    
                    if (openReport) {
                        const reportKey = openReport.id || (openReport.date + openReport.type);
                        
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„Ø§Øº
                        if (reportKey !== currentAlertedReport) {
                            currentAlertedReport = reportKey;
                            lastKnownReportId = reportKey;
                            localStorage.setItem('lastKnownReportId', reportKey);
                            showEmergencyPopup('report', 'Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦ Ù…ÙØªÙˆØ­!', {
                                type: openReport.type || 'Ø¨Ù„Ø§Øº',
                                location: openReport.location || openReport.floor || '-',
                                time: openReport.time || new Date().toLocaleTimeString('ar-SA')
                            });
                        }
                    } else {
                        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…ÙØªÙˆØ­Ø© - Ø£ØºÙ„Ù‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø±ÙˆØ¶Ø§Ù‹
                        currentAlertedReport = null;
                    }
                }
            } catch (e) {
                console.log('Check emergencies error:', e);
            }
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ (ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ)
        setTimeout(() => {
            checkNewEmergencies();
            setInterval(checkNewEmergencies, 5000);
        }, 1000);

        // Ø¯Ø§Ù„Ø© ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
        function toggleEocSubmenu() {
            const navItem = document.getElementById('eocNavItem');
            const submenu = document.getElementById('eocSubmenu');
            navItem.classList.toggle('open');
            submenu.classList.toggle('open');
        }

        function updateAlerts(complaints, incidents, risks, rounds, calibration) {
            const container = document.getElementById('alertsContainer');
            const alerts = [];

            // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ø§Ù„Ù…ØµØ¹Ù‘Ø¯Ø©
            if (complaints.ok && complaints.escalated > 0) {
                alerts.push({
                    type: 'danger',
                    icon: 'fa-comment-dots',
                    text: 'Ø´ÙƒØ§ÙˆÙ‰ Ù…ØµØ¹Ù‘Ø¯Ø© ØªØ­ØªØ§Ø¬ Ø§Ù‡ØªÙ…Ø§Ù… ÙÙˆØ±ÙŠ',
                    count: complaints.escalated,
                    link: 'complaint_mentoring.html'
                });
            }

            // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…ØµØ¹Ù‘Ø¯Ø© - Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† byStatus.escalated.count
            const incidentEscalated = incidents.byStatus?.escalated?.count || incidents.escalated || 0;
            if (incidents.ok && incidentEscalated > 0) {
                alerts.push({
                    type: 'danger',
                    icon: 'fa-exclamation-triangle',
                    text: 'Ø­ÙˆØ§Ø¯Ø« Ù…ØµØ¹Ù‘Ø¯Ø© ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©',
                    count: incidentEscalated,
                    link: 'incident-report-analysis.html'
                });
            }

            // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¹Ø§Ù„ÙŠØ©
            const risksHigh = risks.high || risks.data?.high || 0;
            if (risksHigh > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fa-shield-alt',
                    text: 'Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„',
                    count: risksHigh,
                    link: 'risk-register.html'
                });
            }

            // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
            if (rounds && rounds.ok && rounds.delayed > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fa-clipboard-check',
                    text: 'Ø¬ÙˆÙ„Ø§Øª Ù…ØªØ£Ø®Ø±Ø© ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©',
                    count: rounds.delayed,
                    link: 'Round.html'
                });
            }

            // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
            if (calibration && calibration.overdue > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fa-tools',
                    text: 'Ø£Ø¬Ù‡Ø²Ø© ØªØ¬Ø§ÙˆØ²Øª Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©',
                    count: calibration.overdue,
                    link: 'calibration.html'
                });
            }

            // Ø´ÙƒØ§ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©
            if (complaints.ok && complaints.new > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'fa-inbox',
                    text: 'Ø´ÙƒØ§ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                    count: complaints.new,
                    link: 'complaint_mentoring.html'
                });
            }

            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="no-alerts">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 10px; display: block;"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ø§Ø¬Ù„Ø© - ÙƒÙ„ Ø´ÙŠØ¡ ØªØ­Øª Ø§Ù„Ø³ÙŠØ·Ø±Ø©</p>
                    </div>
                `;
            } else {
                container.innerHTML = alerts.map(a => `
                    <a href="${a.link}" target="_blank" class="alert-item ${a.type}" style="text-decoration: none;">
                        <i class="fas ${a.icon}"></i>
                        <span class="alert-text">${a.text}</span>
                        <span class="alert-count">${a.count}</span>
                    </a>
                `).join('');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'admin-login.html';
                return;
            }

            console.log('User UID:', user.uid);
            console.log('User Email:', user.email);
            
            const roleData = await getUserRole(user.uid);
            console.log('Role data found:', roleData);
            
            if (!roleData || !roleData.role || !['admin', 'chair', 'member', 'viewer', 'staff'].includes(roleData.role)) {
                console.log('Role rejected! Signing out...');
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª. Ø§Ù„Ø¯ÙˆØ±: ' + (roleData ? roleData.role : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'));
                await signOut(auth);
                window.location.href = 'admin-login.html';
                return;
            }

            currentUserRole = roleData.role;
            userAllowedSystems = roleData.allowedSystems || [];
            
            const roleLabels = { 
                admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', 
                chair: 'Ø±Ø¦ÙŠØ³ Ù„Ø¬Ù†Ø©',
                member: 'Ø¹Ø¶Ùˆ',
                staff: 'Ù…ÙˆØ¸Ù Ø¬ÙˆØ¯Ø©', 
                viewer: 'Ù…Ø´Ø§Ù‡Ø¯' 
            };
            
            document.getElementById('staffName').textContent = user.email.split('@')[0];
            document.getElementById('roleBadge').textContent = roleLabels[roleData.role] || roleData.role;
            
            if (roleData.role === 'admin') document.body.classList.add('is-admin');
            
            // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
            applySystemsFilter(roleData.role, roleData.allowedSystems);

            document.body.classList.add('authenticated');
            loadingOverlay.classList.add('hidden');
            loadingOverlay.style.display = 'none';
            loadDashboardData();
            
            // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 3 Ø¯Ù‚Ø§Ø¦Ù‚ (180000 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
            setInterval(() => {
                console.log('ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                loadDashboardData();
            }, 180000);
        });

        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById('section-' + section).classList.add('active');
                if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('open');
            });
        });

        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });

        document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            localStorage.clear();
            window.location.href = 'admin-login.html';
        });
        
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        window.toggleDropdown = function(element) {
            const dropdown = element.nextElementSibling;
            const arrow = element.querySelector('.dropdown-arrow');
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        let allUsersData = [];
        
        async function loadUsers() {
            if (currentUserRole !== 'admin') {
                document.getElementById('usersContainer').innerHTML = '<div class="no-alerts" style="color:#dc3545;"><i class="fas fa-lock"></i> ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·</div>';
                return;
            }
            
            const container = document.getElementById('usersContainer');
            container.innerHTML = '<div class="no-alerts"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>';
            
            try {
                console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† staff_roles...');
                const rolesSnap = await getDocs(collection(db, "staff_roles"));
                
                allUsersData = [];
                rolesSnap.forEach(docSnap => {
                    const data = docSnap.data();
                    allUsersData.push({ 
                        uid: docSnap.id, 
                        email: data.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        fullName: data.fullName || '',
                        role: data.role || 'viewer',
                        status: data.status || 'active',
                        committee: data.committee || '',
                        allowedSystems: data.allowedSystems || [],
                        createdAt: data.createdAt || '',
                        updatedAt: data.updatedAt || ''
                    });
                });
                
                console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', allUsersData.length, 'Ù…Ø³ØªØ®Ø¯Ù…');
                
                const activeCount = allUsersData.filter(u => u.status === 'active').length;
                const suspendedCount = allUsersData.filter(u => u.status === 'suspended').length;
                
                document.getElementById('usersActiveCount').textContent = activeCount;
                document.getElementById('usersSuspendedCount').textContent = suspendedCount;
                document.getElementById('usersTotalCount').textContent = allUsersData.length;
                
                renderUsers(allUsersData);
                
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', e);
                container.innerHTML = `
                    <div class="no-alerts" style="color:#dc3545;">
                        <i class="fas fa-exclamation-triangle"></i> ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        <br><small style="color:#666;">${e.message}</small>
                        <br><button onclick="loadUsers()" style="margin-top:10px; padding:8px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">
                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>`;
            }
        }
        window.loadUsers = loadUsers;
        
        function renderUsers(users) {
            const container = document.getElementById('usersContainer');
            const searchTerm = document.getElementById('usersSearchInput')?.value?.toLowerCase() || '';
            
            const filtered = users.filter(u => 
                u.email.toLowerCase().includes(searchTerm) || 
                u.fullName.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="no-alerts"><i class="fas fa-users-slash"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>';
                return;
            }
            
            const roleLabels = { admin: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', chair: 'Ø±Ø¦ÙŠØ³ Ù„Ø¬Ù†Ø©', member: 'Ø¹Ø¶Ùˆ', viewer: 'Ù…Ø´Ø§Ù‡Ø¯' };
            const roleColors = { admin: '#dc3545', chair: '#1e3a5f', member: '#17a2b8', viewer: '#6c757d' };
            
            container.innerHTML = filtered.map(u => {
                const isActive = u.status === 'active';
                const statusColor = isActive ? '#10b981' : '#f59e0b';
                const statusLabel = isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ù„Ù‚';
                const systemsCount = u.allowedSystems?.length || 0;
                
                return `
                <div class="user-card" style="background:#fff; border-radius:12px; padding:20px; margin-bottom:15px; border-right:4px solid ${statusColor}; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:15px;">
                        <div style="flex:1; min-width:250px;">
                            <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                                <div style="width:50px; height:50px; border-radius:50%; background:linear-gradient(135deg, var(--primary), var(--gold)); display:flex; align-items:center; justify-content:center; color:white; font-size:1.3rem; font-weight:bold;">
                                    ${(u.fullName || u.email).charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 style="color:var(--primary); margin:0; font-size:1.1rem;">${u.fullName || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</h4>
                                    <p style="margin:0; color:#666; font-size:0.85rem;">${u.email}</p>
                                </div>
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
                                <span style="padding:4px 12px; border-radius:20px; font-size:0.75rem; background:${roleColors[u.role]}20; color:${roleColors[u.role]}; font-weight:600;">
                                    ${roleLabels[u.role] || u.role}
                                </span>
                                <span style="padding:4px 12px; border-radius:20px; font-size:0.75rem; background:${statusColor}20; color:${statusColor}; font-weight:600;">
                                    ${statusLabel}
                                </span>
                                ${u.committee ? `<span style="padding:4px 12px; border-radius:20px; font-size:0.75rem; background:#e0e7ff; color:#4f46e5;">Ù„Ø¬Ù†Ø©: ${u.committee}</span>` : ''}
                                <span style="padding:4px 12px; border-radius:20px; font-size:0.75rem; background:#f3f4f6; color:#374151;">${systemsCount} Ø£Ù†Ø¸Ù…Ø©</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px; min-width:150px;">
                            <button onclick="toggleUserStatus('${u.uid}', '${u.status}')" style="padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-family:inherit; font-size:0.8rem; background:${isActive ? '#fef3c7' : '#d1fae5'}; color:${isActive ? '#92400e' : '#065f46'};">
                                <i class="fas fa-${isActive ? 'pause' : 'play'}"></i> ${isActive ? 'ØªØ¹Ù„ÙŠÙ‚' : 'ØªÙØ¹ÙŠÙ„'}
                            </button>
                            <button onclick="sendPasswordReset('${u.email}')" style="padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-family:inherit; font-size:0.8rem; background:#dbeafe; color:#1e40af;">
                                <i class="fas fa-key"></i> Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                            </button>
                            <button onclick="deleteUser('${u.uid}', '${u.email}')" style="padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-family:inherit; font-size:0.8rem; background:#fee2e2; color:#991b1b;">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        document.getElementById('usersSearchInput')?.addEventListener('input', () => renderUsers(allUsersData));
        
        window.toggleUserStatus = async function(uid, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
            const action = newStatus === 'suspended' ? 'ØªØ¹Ù„ÙŠÙ‚' : 'ØªÙØ¹ÙŠÙ„';
            
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${action} Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;
            
            try {
                await updateDoc(doc(db, "staff_roles", uid), {
                    status: newStatus,
                    updatedAt: new Date().toISOString(),
                    updatedBy: auth.currentUser.email
                });
                showToast(`ØªÙ… ${action} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`);
                loadUsers();
            } catch (e) {
                console.error('Ø®Ø·Ø£:', e);
                alert('ÙØ´Ù„ ÙÙŠ ' + action + ' Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        };
        
        window.sendPasswordReset = async function(email) {
            if (!confirm(`Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰:\n${email}`)) return;
            
            try {
                const { sendPasswordResetEmail } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                await sendPasswordResetEmail(auth, email);
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            } catch (e) {
                console.error('Ø®Ø·Ø£:', e);
                alert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ' + e.message);
            }
        };
        
        window.deleteUser = async function(uid, email) {
            if (uid === auth.currentUser.uid) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ!');
                return;
            }
            
            if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù†:\nâ€¢ Firebase Auth (Ø§Ù„Ø­Ø³Ø§Ø¨)\nâ€¢ Firestore staff_roles (Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)\nâ€¢ Firestore membershipRequests (Ø§Ù„Ø·Ù„Ø¨Ø§Øª)\n\n${email}\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) return;
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) return;
            
            try {
                // 1. Delete from Firebase Auth via server API
                const apiResponse = await fetch(`/api/admin/user/${encodeURIComponent(email)}`, {
                    method: 'DELETE'
                });
                const apiResult = await apiResponse.json();
                console.log('Server delete result:', apiResult);
                
                // 2. Delete from Firestore staff_roles
                await deleteDoc(doc(db, "staff_roles", uid));
                
                // 3. Delete from membershipRequests (find by email)
                const requestsSnap = await getDocs(collection(db, "membershipRequests"));
                for (const docSnap of requestsSnap.docs) {
                    if (docSnap.data().email === email) {
                        await deleteDoc(doc(db, "membershipRequests", docSnap.id));
                        console.log('Deleted from membershipRequests:', docSnap.id);
                    }
                }
                
                if (apiResult.authDeleted) {
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©');
                } else {
                    showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Firestore (Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ø­Ø°ÙˆÙ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù…Ù† Auth)', '#f59e0b');
                }
                loadUsers();
            } catch (e) {
                console.error('Ø®Ø·Ø£:', e);
                alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + e.message);
            }
        };

        document.querySelector('[data-section="users"]')?.addEventListener('click', loadUsers);

        // ===== Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© =====
        async function loadMembershipRequests() {
            if (currentUserRole !== 'admin') return;
            const container = document.getElementById('requestsContainer');
            
            try {
                const requestsSnap = await getDocs(collection(db, "membershipRequests"));
                const requests = [];
                requestsSnap.forEach(doc => requests.push({ id: doc.id, ...doc.data() }));
                
                // ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ø£Ø­Ø¯Ø«
                requests.sort((a, b) => {
                    if (a.status === 'pending' && b.status !== 'pending') return -1;
                    if (a.status !== 'pending' && b.status === 'pending') return 1;
                    return (b.requestedAt?.toDate?.() || 0) - (a.requestedAt?.toDate?.() || 0);
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                const pendingCount = requests.filter(r => r.status === 'pending').length;
                const badge = document.getElementById('requestsBadge');
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
                
                if (requests.length === 0) {
                    container.innerHTML = `<div class="no-alerts"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¹Ø¶ÙˆÙŠØ©</p></div>`;
                    return;
                }
                
                container.innerHTML = requests.map(r => {
                    const statusColors = { pending: '#f59e0b', approved: '#10b981', rejected: '#ef4444' };
                    const statusLabels = { pending: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', approved: 'Ù…Ù‚Ø¨ÙˆÙ„', rejected: 'Ù…Ø±ÙÙˆØ¶' };
                    const date = r.requestedAt?.toDate?.() ? r.requestedAt.toDate().toLocaleDateString('ar-SA') : '-';
                    
                    return `
                        <div class="request-card" style="background:#fff; border-radius:12px; padding:20px; margin-bottom:15px; border-right:4px solid ${statusColors[r.status]}; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:15px;">
                                <div style="flex:1; min-width:200px;">
                                    <h4 style="color:var(--primary); margin-bottom:8px; font-size:1.1rem;">
                                        <i class="fas fa-user" style="margin-left:8px; color:var(--gold);"></i>
                                        ${r.fullName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                                    </h4>
                                    <p style="margin:5px 0; color:#666; font-size:0.9rem;">
                                        <i class="fas fa-envelope" style="margin-left:5px; width:16px;"></i> ${r.email}
                                    </p>
                                    <p style="margin:5px 0; color:#666; font-size:0.9rem;">
                                        <i class="fas fa-phone" style="margin-left:5px; width:16px;"></i> ${r.phone || '-'}
                                    </p>
                                    <p style="margin:5px 0; color:#666; font-size:0.9rem;">
                                        <i class="fas fa-building" style="margin-left:5px; width:16px;"></i> ${r.department} - ${r.jobTitle}
                                    </p>
                                    ${r.reason ? `<p style="margin:10px 0 5px; color:#555; font-size:0.85rem; background:#f8f9fa; padding:8px; border-radius:6px;"><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${r.reason}</p>` : ''}
                                </div>
                                <div style="text-align:center;">
                                    <span style="display:inline-block; padding:5px 15px; border-radius:20px; font-size:0.8rem; font-weight:600; background:${statusColors[r.status]}20; color:${statusColors[r.status]};">
                                        ${statusLabels[r.status]}
                                    </span>
                                    <p style="color:#999; font-size:0.75rem; margin-top:8px;">
                                        <i class="fas fa-calendar"></i> ${date}
                                    </p>
                                </div>
                            </div>
                            ${r.status === 'pending' ? `
                                <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; display:flex; gap:10px; flex-wrap:wrap;">
                                    <button onclick="approveRequest('${r.id}', '${r.uid}', '${r.email}')" style="flex:1; min-width:120px; padding:10px 20px; background:#10b981; color:white; border:none; border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600;">
                                        <i class="fas fa-check"></i> Ù‚Ø¨ÙˆÙ„
                                    </button>
                                    <button onclick="rejectRequest('${r.id}')" style="flex:1; min-width:120px; padding:10px 20px; background:#ef4444; color:white; border:none; border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600;">
                                        <i class="fas fa-times"></i> Ø±ÙØ¶
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Error loading requests:', e);
                container.innerHTML = `<div class="no-alerts"><p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p></div>`;
            }
        }
        
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ø±ÙØ¶
        window.approveRequest = async function(requestId, uid, email) {
            // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±
            const roleChoice = prompt(`Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${email}:\n\n1 = Ø¹Ø¶Ùˆ (member)\n2 = Ø±Ø¦ÙŠØ³ Ù„Ø¬Ù†Ø© (chair)\n3 = Ù…Ø´Ø§Ù‡Ø¯ (viewer)\n4 = Ù…ÙˆØ¸Ù (staff)\n\nØ£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù…:`);
            
            if (!roleChoice) return;
            
            const roleMap = { '1': 'member', '2': 'chair', '3': 'viewer', '4': 'staff' };
            const selectedRole = roleMap[roleChoice];
            
            if (!selectedRole) {
                alert('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ù† 1-4');
                return;
            }
            
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø¨ÙˆÙ„ ${email} ÙƒÙ€ "${selectedRole}"ØŸ`)) return;
            
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
                await updateDoc(doc(db, "membershipRequests", requestId), {
                    status: 'approved',
                    reviewedAt: new Date(),
                    reviewedBy: auth.currentUser.email,
                    assignedRole: selectedRole
                });
                
                // Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ UID Ø§Ù„ØµØ­ÙŠØ­
                await setDoc(doc(db, "staff_roles", uid), {
                    role: selectedRole,
                    email: email,
                    status: 'active',
                    approvedAt: new Date().toISOString(),
                    approvedBy: auth.currentUser.email
                });
                
                alert(`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¯ÙˆØ±: ${selectedRole}\nÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„.`);
                loadMembershipRequests();
            } catch (e) {
                console.error('Error approving:', e);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø¨ÙˆÙ„');
            }
        };
        
        window.rejectRequest = async function(requestId) {
            const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):');
            if (reason === null) return; // Ø£Ù„ØºÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            
            try {
                await updateDoc(doc(db, "membershipRequests", requestId), {
                    status: 'rejected',
                    reviewedAt: new Date(),
                    reviewedBy: auth.currentUser.email,
                    rejectionReason: reason || ''
                });
                
                alert('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨');
                loadMembershipRequests();
            } catch (e) {
                console.error('Error rejecting:', e);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¶');
            }
        };

        document.querySelector('[data-section="requests"]')?.addEventListener('click', loadMembershipRequests);
        
        // ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        setTimeout(async () => {
            if (currentUserRole === 'admin') {
                try {
                    const snap = await getDocs(collection(db, "membershipRequests"));
                    const pending = [];
                    snap.forEach(d => { if (d.data().status === 'pending') pending.push(d); });
                    const badge = document.getElementById('requestsBadge');
                    if (pending.length > 0) {
                        badge.textContent = pending.length;
                        badge.style.display = 'inline';
                    }
                } catch(e) {}
            }
        }, 2000);

        // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© =====
        function showToast(message, isError = false) {
            const toast = document.getElementById('toastNotification');
            const toastMsg = document.getElementById('toastMessage');
            toastMsg.textContent = message;
            toast.style.background = isError ? '#ef4444' : '#10b981';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }
        
        const COMMITTEES = [
            { id: 'RM', name: 'Ù„Ø¬Ù†Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±' },
            { id: 'FMS', name: 'Ù„Ø¬Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚' },
            { id: 'PSC', name: 'Ù„Ø¬Ù†Ø© Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰' },
            { id: 'IPC', name: 'Ù„Ø¬Ù†Ø© Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰' },
            { id: 'QI', name: 'Ù„Ø¬Ù†Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†' },
            { id: 'EOC', name: 'Ù„Ø¬Ù†Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆØ§Ù„ÙƒÙˆØ§Ø±Ø«' },
            { id: 'OTHER', name: 'Ø£Ø®Ø±Ù‰' }
        ];
        
        const SYSTEMS = [
            { id: 'complaints', name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰', icon: 'comment-dots' },
            { id: 'incidents', name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØ§Ø¯Ø«', icon: 'exclamation-triangle' },
            { id: 'risks', name: 'Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±', icon: 'shield-alt' },
            { id: 'rounds', name: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬ÙˆÙ„Ø§Øª', icon: 'clipboard-check' },
            { id: 'calibration', name: 'Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©', icon: 'tools' },
            { id: 'maintenance', name: 'Ø§Ù„ØµÙŠØ§Ù†Ø©', icon: 'wrench' },
            { id: 'needlestick', name: 'Ø§Ù„ØªØ¹Ø±Ø¶ Ø§Ù„ÙˆØ®Ø²ÙŠ', icon: 'syringe' },
            { id: 'cbahi', name: 'Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ', icon: 'award' },
            { id: 'dashboard', name: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', icon: 'tachometer-alt' }
        ];
        
        const ROLES = [
            { id: 'admin', name: 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…', color: '#dc3545' },
            { id: 'chair', name: 'Ø±Ø¦ÙŠØ³ Ù„Ø¬Ù†Ø©', color: '#c9a962' },
            { id: 'member', name: 'Ø¹Ø¶Ùˆ', color: '#17a2b8' },
            { id: 'viewer', name: 'Ù…Ø´Ø§Ù‡Ø¯ ÙÙ‚Ø·', color: '#6c757d' }
        ];
        
        async function loadPermissions() {
            if (currentUserRole !== 'admin') return;
            const container = document.getElementById('permissionsContainer');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            container.innerHTML = `<div style="text-align:center; padding:40px;"><i class="fas fa-spinner fa-spin fa-2x" style="color:var(--gold);"></i><p style="margin-top:15px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p></div>`;
            
            try {
                console.log('Loading permissions from Firestore...');
                const rolesSnap = await getDocs(collection(db, "staff_roles"));
                const users = [];
                rolesSnap.forEach(docSnap => users.push({ uid: docSnap.id, ...docSnap.data() }));
                console.log('Loaded users:', users.length, users);
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const activeCount = users.filter(u => u.status !== 'suspended').length;
                const suspendedCount = users.filter(u => u.status === 'suspended').length;
                
                const statsActiveEl = document.getElementById('statsActive');
                const statsSuspendedEl = document.getElementById('statsSuspended');
                const statsTotalEl = document.getElementById('statsTotal');
                
                if (statsActiveEl) statsActiveEl.textContent = activeCount;
                if (statsSuspendedEl) statsSuspendedEl.textContent = suspendedCount;
                if (statsTotalEl) statsTotalEl.textContent = users.length;
                
                if (users.length === 0) {
                    container.innerHTML = `<div class="no-alerts"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</p></div>`;
                    return;
                }
                
                container.innerHTML = users.map(u => {
                    const currentRole = ROLES.find(r => r.id === u.role) || ROLES[3];
                    const allowedSystems = u.allowedSystems || [];
                    const committee = u.committee || '';
                    const isSuspended = u.status === 'suspended';
                    const statusColor = isSuspended ? '#f59e0b' : '#10b981';
                    const statusText = isSuspended ? 'Ù…Ø¹Ù„Ù‚' : 'ÙØ¹Ø§Ù„';
                    const statusBg = isSuspended ? '#fef3c7' : '#d1fae5';
                    
                    return `
                        <div class="permission-card" style="background:#fff; border-radius:12px; padding:20px; margin-bottom:15px; border-right:4px solid ${isSuspended ? '#f59e0b' : currentRole.color}; box-shadow:0 2px 8px rgba(0,0,0,0.08); ${isSuspended ? 'opacity:0.7;' : ''}">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
                                <div>
                                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                                        <h4 style="color:var(--primary); margin:0;">
                                            <i class="fas fa-user" style="margin-left:8px; color:var(--gold);"></i>
                                            ${u.fullName || u.email || u.uid}
                                        </h4>
                                        <span style="background:${statusBg}; color:${statusColor}; padding:3px 10px; border-radius:20px; font-size:0.75rem; font-weight:600;">
                                            <i class="fas fa-${isSuspended ? 'pause-circle' : 'check-circle'}"></i> ${statusText}
                                        </span>
                                    </div>
                                    <p style="color:#666; font-size:0.85rem;">${u.email || ''}</p>
                                    <p style="color:#999; font-size:0.8rem;">${u.department || ''} - ${u.jobTitle || ''}</p>
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <button onclick="toggleUserStatus('${u.uid}', ${isSuspended})" style="background:${isSuspended ? '#d1fae5' : '#fef3c7'}; color:${isSuspended ? '#10b981' : '#f59e0b'}; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-family:inherit;">
                                        <i class="fas fa-${isSuspended ? 'play-circle' : 'pause-circle'}"></i> ${isSuspended ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ù„ÙŠÙ‚'}
                                    </button>
                                    <button onclick="deleteUserFromPermissions('${u.uid}', '${u.email || ''}')" style="background:#fee2e2; color:#dc3545; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-family:inherit;">
                                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
                                <div>
                                    <label style="font-weight:600; color:var(--primary); display:block; margin-bottom:8px;">
                                        <i class="fas fa-user-tag"></i> Ø§Ù„Ø¯ÙˆØ±
                                    </label>
                                    <select onchange="updateUserField('${u.uid}', 'role', this.value)" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-family:inherit;">
                                        ${ROLES.map(r => `<option value="${r.id}" ${u.role === r.id ? 'selected' : ''}>${r.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:var(--primary); display:block; margin-bottom:8px;">
                                        <i class="fas fa-users"></i> Ø§Ù„Ù„Ø¬Ù†Ø©
                                    </label>
                                    <select onchange="updateUserField('${u.uid}', 'committee', this.value)" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-family:inherit;">
                                        <option value="">-- Ø¨Ø¯ÙˆÙ† Ù„Ø¬Ù†Ø© --</option>
                                        ${COMMITTEES.map(c => `<option value="${c.id}" ${committee === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-weight:600; color:var(--primary); display:block; margin-bottom:10px;">
                                    <i class="fas fa-th-large"></i> Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© (Ø§Ø®ØªØ± Ù…Ø§ ØªØ±ÙŠØ¯)
                                </label>
                                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                    ${SYSTEMS.map(s => `
                                        <label style="display:flex; align-items:center; gap:6px; background:${allowedSystems.includes(s.id) ? '#d1fae5' : '#f3f4f6'}; padding:8px 12px; border-radius:8px; cursor:pointer; transition:all 0.2s;">
                                            <input type="checkbox" ${allowedSystems.includes(s.id) ? 'checked' : ''} onchange="toggleSystem('${u.uid}', '${s.id}', this.checked)" style="cursor:pointer;">
                                            <i class="fas fa-${s.icon}" style="color:${allowedSystems.includes(s.id) ? '#10b981' : '#9ca3af'};"></i>
                                            <span style="font-size:0.85rem;">${s.name}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Error loading permissions:', e);
                container.innerHTML = `
                    <div class="no-alerts" style="text-align:center; padding:30px;">
                        <i class="fas fa-exclamation-triangle fa-2x" style="color:#f59e0b; margin-bottom:15px;"></i>
                        <p style="margin-bottom:10px;">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</p>
                        <p style="font-size:0.85rem; color:#888;">${e.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'}</p>
                        <button onclick="loadPermissions()" style="margin-top:15px; padding:10px 25px; background:var(--gold); color:#fff; border:none; border-radius:8px; cursor:pointer; font-family:inherit;">
                            <i class="fas fa-sync"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>`;
            }
        }
        window.loadPermissions = loadPermissions;
        
        window.updateUserField = async function(uid, field, value) {
            if (currentUserRole !== 'admin') {
                showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', true);
                return;
            }
            try {
                await updateDoc(doc(db, "staff_roles", uid), {
                    [field]: value,
                    updatedAt: new Date().toISOString(),
                    updatedBy: auth.currentUser.email
                });
                showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (e) {
                console.error('Error updating:', e);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«', true);
            }
        };
        
        window.toggleUserStatus = async function(uid, currentlySuspended) {
            if (currentUserRole !== 'admin') {
                showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', true);
                return;
            }
            const newStatus = currentlySuspended ? 'active' : 'suspended';
            const message = currentlySuspended ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ù„ÙŠÙ‚';
            
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${message} Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ`)) return;
            
            try {
                await updateDoc(doc(db, "staff_roles", uid), {
                    status: newStatus,
                    updatedAt: new Date().toISOString(),
                    updatedBy: auth.currentUser.email
                });
                showToast(currentlySuspended ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ' : 'ØªÙ… ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø¹Ø¶Ùˆ');
                loadPermissions();
            } catch (e) {
                console.error('Error toggling status:', e);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', true);
            }
        };
        
        window.toggleSystem = async function(uid, systemId, checked) {
            if (currentUserRole !== 'admin') {
                showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', true);
                return;
            }
            try {
                const docRef = doc(db, "staff_roles", uid);
                const docSnap = await getDoc(docRef);
                let allowedSystems = docSnap.exists() ? (docSnap.data().allowedSystems || []) : [];
                
                if (checked && !allowedSystems.includes(systemId)) {
                    allowedSystems.push(systemId);
                } else if (!checked) {
                    allowedSystems = allowedSystems.filter(s => s !== systemId);
                }
                
                await updateDoc(docRef, {
                    allowedSystems: allowedSystems,
                    updatedAt: new Date().toISOString(),
                    updatedBy: auth.currentUser.email
                });
                showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
            } catch (e) {
                console.error('Error toggling system:', e);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', true);
            }
        };
        
        window.deleteUserFromPermissions = async function(uid, email) {
            if (currentUserRole !== 'admin') {
                showToast('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', true);
                return;
            }
            if (!confirm(`âš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù†:\nâ€¢ Firebase Auth\nâ€¢ staff_roles\nâ€¢ membershipRequests\n\n${email}`)) return;
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!')) return;
            
            try {
                // 1. Ø­Ø°Ù Ù…Ù† Firebase Auth Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±
                if (email) {
                    await fetch(`/api/admin/user/${encodeURIComponent(email)}`, { method: 'DELETE' });
                }
                // 2. Ø­Ø°Ù Ù…Ù† Firestore staff_roles
                await deleteDoc(doc(db, "staff_roles", uid));
                
                // 3. Ø­Ø°Ù Ù…Ù† membershipRequests
                if (email) {
                    const requestsSnap = await getDocs(collection(db, "membershipRequests"));
                    for (const docSnap of requestsSnap.docs) {
                        if (docSnap.data().email === email) {
                            await deleteDoc(doc(db, "membershipRequests", docSnap.id));
                        }
                    }
                }
                
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©');
                loadPermissions();
            } catch (e) {
                console.error('Error deleting:', e);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', true);
            }
        };
        
        document.querySelector('[data-section="permissions"]')?.addEventListener('click', loadPermissions);
    </script>
</body>
</html>
