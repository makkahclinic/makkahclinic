<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تقييم الحالة الطبية - بوابة الطبيب</title>
  <style>
    :root{
      --primary:#0b4ea2; --primary-600:#0a448f;
      --secondary:#6c757d; --danger:#dc3545;
      --bg:#eef3f8; --card:#ffffff; --text:#1f2937;
      --muted:#6b7280; --border:#e5e7eb; --focus:rgba(11,78,162,.25);
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      margin:0;color:var(--text);
      background:
        radial-gradient(1200px 800px at 120% -10%, #cfe0f6 0%, transparent 60%),
        radial-gradient(1200px 800px at -10% 120%, #e8f0ff 0%, transparent 60%),
        var(--bg);
      min-height:100dvh;
    }
    .home-fab{
      position:fixed; left:16px; top:16px; width:48px;height:48px; border-radius:12px;
      background:var(--primary); color:#fff; display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 25px rgba(11,78,162,.25), 0 2px 8px rgba(0,0,0,.08);
      cursor:pointer; z-index:50; transition:transform .12s, background .2s, box-shadow .2s;
    }
    .home-fab:hover{ background:var(--primary-600); transform:translateY(-1px); }
    .home-fab:active{ transform:translateY(0); }
    .home-fab:focus-visible{ outline:3px solid var(--focus); outline-offset:3px; }

    .container{ max-width:960px; margin:72px auto 36px; padding:0 16px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 12px 30px rgba(16,24,40,.05), 0 4px 10px rgba(16,24,40,.04);
      padding:28px;
    }
    h2{ margin:0 0 18px; text-align:center; color:var(--primary); font-weight:700; letter-spacing:.2px; }
    #user-info{ text-align:center; color:var(--muted); margin-bottom:18px; font-size:.95rem; }

    .section-title{ font-size:1.05rem; color:var(--primary); font-weight:700; border-bottom:2px solid var(--primary); padding-bottom:8px; margin:26px 0 16px; }
    label{ font-weight:600; font-size:.95rem; margin:.6rem 0 .35rem; display:block; color:#0f172a; }
    input, select, textarea{
      width:100%; border:1px solid var(--border); border-radius:10px; padding:.8rem 1rem; font-size:1rem; background:#fff;
      transition:border-color .2s, box-shadow .2s, transform .02s;
    }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 4px var(--focus); }
    textarea{ min-height:120px; resize:vertical; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; }

    .image-upload{ margin-top:10px; border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; color:var(--muted); cursor:pointer; transition:border-color .2s, background .2s; }
    .image-upload:hover{ border-color:var(--primary); background:#f8fbff; }
    #image-upload-input{ display:none; }
    #image-preview{ max-width:100%; max-height:300px; border-radius:10px; border:1px solid var(--border); display:none; margin-top:10px; }
    #image-meta{ display:none; font-size:.9rem; color:var(--muted); margin-top:6px; }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:24px; }
    button{
      appearance:none; border:none; color:#fff; font-weight:700; cursor:pointer; border-radius:12px; padding:.85rem 1.25rem; min-width:200px;
      transition:transform .05s, background .2s, box-shadow .2s; box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    button:active{ transform:translateY(1px); }
    .btn-primary{ background:var(--primary); } .btn-primary:hover{ background:var(--primary-600); }
    .btn-secondary{ background:var(--secondary); } .btn-secondary:hover{ background:#5b636a; }
    .btn-danger{ background:var(--danger); } .btn-danger:hover{ background:#c72637; }

    .notification{ margin-top:14px; border-radius:12px; padding:14px 16px; text-align:center; display:none; font-weight:600; }
    .notification.info{ background:#e9f3ff; color:#0b3a7a; border:1px solid #cfe4ff; }
    .notification.error{ background:#fde7ea; color:#7a0b1c; border:1px solid #f6ccd2; }

    #response-container{ margin-top:22px; padding:18px; background:#fff; border:1px solid var(--border); border-radius:14px; display:none; }
    #response-container h3{ color:var(--primary); border-bottom:2px solid var(--primary); padding-bottom:.5rem; margin-top:0; }
    #response-container h4{ color:#0a58ca; margin-top:1.25rem; }
    #response-container p{ line-height:1.85; }
    #response-container ul{ padding-right:20px; }
    #response-container li{ margin:.55rem 0; }
    #response-container .risk-high{ color:#7a1020; background:#fde7ea; border:1px solid #f6ccd2; padding:.25rem .55rem; border-radius:8px; font-weight:700; }
    #response-container .risk-medium{ color:#7a5a00; background:#fff3cd; border:1px solid #ffe39a; padding:.25rem .55rem; border-radius:8px; font-weight:700; }
    #response-container .risk-low{ color:#0d5c33; background:#daf5e7; border:1px solid #b8ebd6; padding:.25rem .55rem; border-radius:8px; font-weight:700; }
  </style>
</head>
<body>
  <!-- زر “البيت” -->
  <button class="home-fab" onclick="goToHome()" aria-label="الشاشة الرئيسية" title="الشاشة الرئيسية">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M3 11.2 12 4l9 7.2V20a2 2 0 0 1-2 2h-4.5a1.5 1.5 0 0 1-1.5-1.5V16h-4v4.5A1.5 1.5 0 0 1 7.5 22H5a2 2 0 0 1-2-2v-8.8Z" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <div class="container">
    <div class="card">
      <h2>تقييم الحالة الطبية وطلبات التأمين</h2>
      <div id="user-info">جاري التحقق من المستخدم...</div>

      <!-- (1) معلومات المريض -->
      <div class="section-title">1) معلومات المريض (اختياري)</div>
      <div class="grid">
        <div>
          <label for="gender">الجنس</label>
          <select id="gender">
            <option value="" disabled selected>اختر...</option>
            <option value="male">ذكر</option>
            <option value="female">أنثى</option>
          </select>
        </div>
        <div>
          <label for="age">العمر (سنة)</label>
          <input type="number" id="age" placeholder="مثال: 63">
        </div>

        <!-- حمل -->
        <div id="pregnancy-status-container" style="display:none;">
          <label for="pregnancy-status">هل المريضة حامل؟</label>
          <select id="pregnancy-status">
            <option value="" disabled selected>اختر...</option>
            <option value="no">لا</option>
            <option value="yes">نعم</option>
          </select>
        </div>
        <div id="pregnancy-month-container" style="display:none;">
          <label for="pregnancy-month">شهر الحمل</label>
          <input type="number" id="pregnancy-month" min="1" max="9" placeholder="مثال: 5">
        </div>

        <div>
          <label for="height">الطول (سم)</label>
          <input type="number" id="height" placeholder="مثال: 175">
        </div>
        <div>
          <label for="weight">الوزن (كجم)</label>
          <input type="number" id="weight" placeholder="مثال: 80">
        </div>
        <div>
          <label for="temperature">الحرارة (°م)</label>
          <input type="text" id="temperature" placeholder="مثال: 37.5">
        </div>
        <div>
          <label for="blood-pressure">ضغط الدم</label>
          <input type="text" id="blood-pressure" placeholder="مثال: 120/80">
        </div>
      </div>

      <!-- (2) عوامل خطر تنفّسية وبصرية -->
      <div class="section-title">2) عوامل خطر تنفّسية وبصرية</div>
      <div class="grid">
        <div>
          <label for="is-smoker">هل المريض مدخّن؟</label>
          <select id="is-smoker">
            <option value="" disabled selected>اختر...</option>
            <option value="no">لا</option>
            <option value="yes">نعم</option>
          </select>
        </div>
        <div id="pack-years-wrap" style="display:none;">
          <label for="pack-years">الباك-سنة (Pack-Years)</label>
          <input type="number" id="pack-years" placeholder="مثال: 35">
        </div>
        <div>
          <label for="cough-weeks">مدة السعال (بالأسابيع)</label>
          <input type="number" id="cough-weeks" placeholder="مثال: 12">
        </div>

        <div>
          <label for="has-visual-sx">هل توجد أعراض بصرية؟</label>
          <select id="has-visual-sx">
            <option value="" disabled selected>اختر...</option>
            <option value="no">لا</option>
            <option value="yes">نعم</option>
          </select>
        </div>
        <div id="visual-sx-wrap" style="display:none;">
          <label for="visual-sx">تفاصيل الأعراض البصرية</label>
          <textarea id="visual-sx" placeholder="مثال: زغللة، بقع سوداء، تشوّش مفاجئ..."></textarea>
        </div>
        <div id="last-eye-exam-wrap" style="display:none;">
          <label for="last-eye-exam">تاريخ آخر فحص عين</label>
          <input type="date" id="last-eye-exam">
        </div>
        <div id="visual-acuity-wrap" style="display:none;">
          <label for="visual-acuity">حدة الإبصار (مثال: 6/9 أو 20/40)</label>
          <input type="text" id="visual-acuity" placeholder="مثال: 6/9">
        </div>
      </div>

      <!-- (3) تفاصيل الحالة -->
      <div class="section-title">3) تفاصيل الحالة</div>
      <div>
        <label for="case-description">وصف الحالة</label>
        <textarea id="case-description" placeholder="مثال: مريض سكري نوع 2 مع التهاب قدم..."></textarea>
      </div>
      <div>
        <label for="diagnosis">التشخيصات</label>
        <textarea id="diagnosis" placeholder="مثال: T2DM, HTN, UTI, dermatitis..."></textarea>
      </div>
      <div>
        <label for="lab-results">نتائج التحاليل/الأشعة</label>
        <textarea id="lab-results" placeholder="مثال: HbA1c, eGFR, CRP, Culture..."></textarea>
      </div>
      <div>
        <label for="medications-procedures">الأدوية والإجراءات الحالية</label>
        <textarea id="medications-procedures" placeholder="مثال: Diovan 40 qd, Xigduo XR bid, ..."></textarea>
      </div>

      <!-- (4) رفع الملفات -->
      <div class="section-title">4) رفع الملفات (اختياري)</div>
      <label class="image-upload" for="image-upload-input">اضغط أو اسحب لرفع صورة (وصفة/تقرير/أشعة)</label>
      <input id="image-upload-input" type="file" accept="image/*">
      <img id="image-preview" alt="معاينة الصورة"/>
      <div id="image-meta"></div>

      <!-- أزرار -->
      <div class="actions">
        <button class="btn-primary" id="analyzeBtn" onclick="analyzeCase()">تحليل الحالة وتقديم التقرير</button>
        <button class="btn-secondary" onclick="goToHome()">الشاشة الرئيسية</button>
        <button class="btn-danger" onclick="logout()">تسجيل الخروج</button>
      </div>

      <div id="notification-area" class="notification"></div>
      <div id="response-container"></div>
    </div>
  </div>

  <script type="module">
    /* ===== Firebase ===== */
    const firebaseConfig={
      apiKey:"AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
      authDomain:"insurance-check-6cec9.firebaseapp.com",
      projectId:"insurance-check-6cec9",
      storageBucket:"insurance-check-6cec9.appspot.com",
      messagingSenderId:"992769471393",
      appId:"1:992769471393:web:c8a9400210a0e7901011e0"
    };
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getAuth, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);

    onAuthStateChanged(auth,(user)=>{
      const ui=document.getElementById("user-info");
      if(user){ ui.textContent=`مرحبًا بك، ${user.email}`; }
      else{ window.location.href="https://www.m2020m.org/login.html"; }
    });

    window.logout=()=>signOut(auth).then(()=>{
      showNote("info","تم تسجيل الخروج بنجاح.");
      setTimeout(()=>window.location.href="https://www.m2020m.org/login.html",1200);
    });

    window.goToHome=()=>{ window.location.href="https://www.m2020m.org/portal.html"; };

    /* ===== منطق الإظهار/الإخفاء ===== */
    const gender=document.getElementById('gender');
    const pregWrap=document.getElementById('pregnancy-status-container');
    const pregMonthWrap=document.getElementById('pregnancy-month-container');
    const pregStatus=document.getElementById('pregnancy-status');

    gender.addEventListener('change',()=>{
      const isF = gender.value==='female';
      pregWrap.style.display = isF ? '' : 'none';
      pregMonthWrap.style.display='none';
      if(!isF){ pregStatus.value=""; document.getElementById('pregnancy-month').value=""; }
    });
    pregStatus.addEventListener('change',()=>{
      pregMonthWrap.style.display = pregStatus.value==='yes' ? '' : 'none';
      if(pregStatus.value!=='yes'){ document.getElementById('pregnancy-month').value=""; }
    });

    // تدخين
    const isSmokerSel=document.getElementById('is-smoker');
    const packWrap=document.getElementById('pack-years-wrap');
    isSmokerSel.addEventListener('change',()=>{
      packWrap.style.display = isSmokerSel.value==='yes' ? '' : 'none';
      if(isSmokerSel.value!=='yes'){ document.getElementById('pack-years').value=""; }
    });

    // أعراض بصرية
    const hasVisualSel=document.getElementById('has-visual-sx');
    const visualWrap=document.getElementById('visual-sx-wrap');
    const eyeDateWrap=document.getElementById('last-eye-exam-wrap');
    const acuityWrap=document.getElementById('visual-acuity-wrap');
    hasVisualSel.addEventListener('change',()=>{
      const show = hasVisualSel.value==='yes';
      visualWrap.style.display = show ? '' : 'none';
      eyeDateWrap.style.display = show ? '' : 'none';
      acuityWrap.style.display = show ? '' : 'none';
      if(!show){
        document.getElementById('visual-sx').value="";
        document.getElementById('last-eye-exam').value="";
        document.getElementById('visual-acuity').value="";
      }
    });

    /* ===== معاينة الصورة + ضغط ===== */
    const imgInput=document.getElementById('image-upload-input');
    const imgPrev=document.getElementById('image-preview');
    const imgMeta=document.getElementById('image-meta');
    let imageBase64=null;

    imgInput.addEventListener('change', async (e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      try{
        const { base64, info } = await compressImage(file,{maxW:1280,maxH:1280,quality:.65});
        imageBase64=base64;
        imgPrev.src='data:image/jpeg;base64,'+base64;
        imgPrev.style.display='block';
        imgMeta.textContent=`${info.w}×${info.h} | ${(info.sizeKB).toFixed(1)} KB`;
        imgMeta.style.display='block';
      }catch(err){ console.error(err); showNote('error','تعذّر معالجة الصورة.'); }
    });

    async function compressImage(file,{maxW=1280,maxH=1280,quality:.65}={}){
      const dataURL = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
      const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL; });
      let {width:w,height:h}=img; const ratio=Math.min(maxW/w,maxH/h,1);
      w=Math.round(w*ratio); h=Math.round(h*ratio);
      const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      const out=canvas.toDataURL('image/jpeg',quality);
      const base64=out.split(',')[1]; const sizeKB=(base64.length*3/4)/1024;
      return { base64, info:{w,h,sizeKB} };
    }

    /* ===== إشعارات ===== */
    function showNote(type,msg){
      const n=document.getElementById('notification-area');
      n.className='notification '+type; n.textContent=msg; n.style.display='block';
    }
    function clearNote(){ const n=document.getElementById('notification-area'); n.style.display='none'; n.textContent=''; }

    /* ===== إرسال وتحليل ===== */
    window.analyzeCase = async function(){
      const btn=document.getElementById('analyzeBtn');
      const box=document.getElementById('response-container');
      clearNote(); box.style.display='none'; box.innerHTML='';

      const caseData={
        userType:'doctor',
        age:document.getElementById('age').value,
        gender:document.getElementById('gender').value,
        isPregnant:document.getElementById('pregnancy-status').value,
        pregnancyMonth:document.getElementById('pregnancy-month').value,
        height:document.getElementById('height').value,
        weight:document.getElementById('weight').value,
        temperature:document.getElementById('temperature').value,
        bloodPressure:document.getElementById('blood-pressure').value,

        // الحقول الجديدة ↓↓↓
        isSmoker: (document.getElementById('is-smoker').value==='yes') ? true :
                  (document.getElementById('is-smoker').value==='no') ? false : undefined,
        smokingPackYears: document.getElementById('pack-years').value,
        coughDurationWeeks: document.getElementById('cough-weeks').value,
        visualSymptoms: document.getElementById('has-visual-sx').value==='yes' ? document.getElementById('visual-sx').value : '',
        lastEyeExamDate: document.getElementById('has-visual-sx').value==='yes' ? document.getElementById('last-eye-exam').value : '',
        visualAcuity: document.getElementById('has-visual-sx').value==='yes' ? document.getElementById('visual-acuity').value : '',

        // القديمة
        notes:document.getElementById('case-description').value,
        diagnosis:document.getElementById('diagnosis').value,
        labResults:document.getElementById('lab-results').value,
        medications:document.getElementById('medications-procedures').value,
        imageData: imageBase64 ? [imageBase64] : []
      };

      if(!caseData.notes && !caseData.diagnosis && !caseData.labResults && !caseData.medications && caseData.imageData.length===0){
        showNote('error','الرجاء إدخال تفاصيل أو رفع صورة أولاً.'); return;
      }

      showNote('info','جاري التحليل… قد يستغرق بعض الوقت.'); btn.disabled=true;

      try{
        if(!auth.currentUser) throw new Error('المستخدم غير مسجّل الدخول.');
        const token=await auth.currentUser.getIdToken();

        const res=await fetch('/api/gpt',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`}, body:JSON.stringify(caseData) });
        const text=await res.text();

        if(!res.ok){
          if(res.status===413 || /Too Large|Entity Too Large/i.test(text)){ throw new Error('الصورة/البيانات كبيرة. قلّل دقّة الصورة أو الجودة ثم أعد المحاولة.'); }
          throw new Error(`فشل الطلب (${res.status}): ${text.slice(0,200)}…`);
        }

        let data; try{ data=JSON.parse(text); }catch{ throw new Error('الرد ليس JSON صالحًا.'); }
        if(data.htmlReport){
          clearNote(); box.innerHTML=data.htmlReport; box.style.display='block'; box.scrollIntoView({behavior:'smooth'});
        }else{ throw new Error('لم يصل تقرير من الخادم.'); }
      }catch(err){ console.error(err); showNote('error','حدث خطأ أثناء التحليل: '+err.message); }
      finally{ btn.disabled=false; }
    }
  </script>
</body>
</html>
