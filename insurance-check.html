<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>تحليل الحالات الطبية — Gemini & GPT‑4o</title>
  <style>
    :root { --bg:#f8f9fb; --card:#fff; --border:#e5e7eb; --muted:#6b7280; --ink:#111827;}
    body{font-family:Arial,system-ui,-apple-system; background:var(--bg); color:#111; margin:24px}
    h1{margin:0 0 12px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin:16px 0}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row>*{flex:1; min-width:260px}
    label{display:block; margin:10px 0 6px}
    input[type="file"]{margin:6px 0 12px}
    input,select,textarea{padding:10px; border:1px solid var(--border); border-radius:8px; width:100%}
    button{padding:10px 16px; border:0; border-radius:8px; background:var(--ink); color:#fff; cursor:pointer}
    button:disabled{opacity:.5; cursor:not-allowed}
    .muted{color:var(--muted); font-size:13px}
    .report{white-space:pre-wrap; background:#fff; border:1px dashed #cbd5e1; padding:12px; border-radius:8px; min-height:64px}
    .log{white-space:pre-wrap; background:#0b1020; color:#c7d2fe; padding:12px; border-radius:8px; max-height:280px; overflow:auto}
    progress{width:100%; height:14px}
  </style>

  <!-- تحميل PDF.js كـ ES Module من CDN -->
  <script>
    // تحميل PDF.js مرة واحدة عند الحاجة (إصدار يتضمن pdf.min.mjs و pdf.worker.min.mjs)
    let __pdfjsModule;
    async function getPdfJs(){
      if(!__pdfjsModule){
        __pdfjsModule = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.54/pdf.min.mjs');
        __pdfjsModule.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.54/pdf.worker.min.mjs';
      }
      return __pdfjsModule;
    }

    // تحميل دالة الرفع من حزمة Vercel Blob (متوافق مع المتصفح عبر esm.sh)
    let __vercelUpload;
    async function getVercelUpload(){
      if(!__vercelUpload){
        const mod = await import('https://esm.sh/@vercel/blob@0.25.1/client?bundle');
        __vercelUpload = mod.upload;
      }
      return __vercelUpload;
    }
  </script>
</head>
<body>
  <h1>تحليل الحالات الطبية (Gemini & GPT‑4o)</h1>
  <div class="muted">
    * يتم رفع الملفات مباشرةً إلى Vercel Blob لتجاوز حد 4.5MB على دوال السيرفرلس.<br/>
    * التقرير لغرض تحسين الجودة فقط ويجب مراجعته من طبيب مرخّص قبل أي قرار سريري/مالي.
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>اختر ملفات (صورة/‏PDF — عربي/إنجليزي، خط يدوي أو مطبوع):</label>
        <input id="fileInput" type="file" accept=".pdf,image/*" multiple />
        <div class="muted">سَيحوَّل أي PDF إلى صور صفحات داخل المتصفح.</div>
      </div>
      <div>
        <label>اللغة المطلوبة للتقرير:</label>
        <select id="lang">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
        <label>النموذج المستخدم:</label>
        <select id="model">
          <option value="both" selected>كلاهما (Gemini + GPT‑4o)</option>
          <option value="openai">GPT‑4o فقط</option>
          <option value="gemini">Gemini فقط</option>
        </select>
        <label>التخصص (اختياري):</label>
        <input id="specialty" placeholder="أسنان، جلدية، قلب، ..." />
      </div>
    </div>

    <label>وصف مختصر للحالة/سياق التأمين (اختياري):</label>
    <textarea id="context" rows="4"></textarea>

    <div class="row" style="align-items:center">
      <div><button id="analyzeBtn">تحليل الحالة</button></div>
      <div><progress id="prog" value="0" max="100" hidden></progress></div>
    </div>

    <div id="uploadSummary" class="muted"></div>
  </div>

  <div class="card">
    <h3>النتيجة المدمجة</h3>
    <div id="merged" class="report"></div>
  </div>

  <div class="card">
    <h3>مخرجات GPT‑4o</h3>
    <div id="openaiOut" class="report"></div>
  </div>

  <div class="card">
    <h3>مخرجات Gemini</h3>
    <div id="geminiOut" class="report"></div>
  </div>

  <div class="card">
    <h3>السجل</h3>
    <div id="log" class="log"></div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const log = (...a)=>{ $('log').textContent += a.join(' ') + '\n'; };

async function pdfPageToBlob(pdf, pageNumber, scale=2){
  const page = await pdf.getPage(pageNumber);
  const viewport = page.getViewport({ scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  return new Promise(resolve => canvas.toBlob(b=>resolve(b), 'image/png', 0.92));
}

async function uploadFileToBlob(file){
  const upload = await getVercelUpload();
  const put = await upload(file.name, file, {
    access: 'public',
    contentType: file.type || 'application/octet-stream',
    handleUploadUrl: '/api/gpt?action=sign',
    addRandomSuffix: true
  });
  return { url: put.url, mimeType: file.type || 'application/octet-stream', name: file.name };
}

async function handleFiles(files){
  const prog = $('prog'); prog.hidden = false; prog.value = 0;
  const uploaded = [];
  let processed = 0, totalSteps = files.length;

  for(const file of files){
    const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
    if(isPdf){
      log(`> تحويل PDF: ${file.name}`);
      const pdfjsLib = await getPdfJs();
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const maxPages = Math.min(pdf.numPages, 15); // حد افتراضي
      totalSteps += (maxPages - 1);
      for(let i=1;i<=maxPages;i++){
        const blob = await pdfPageToBlob(pdf, i, 2);
        const pageFile = new File([blob], `${file.name.replace(/\.pdf$/i,'')}-p${i}.png`, {type:'image/png'});
        const up = await uploadFileToBlob(pageFile);
        uploaded.push(up);
        processed++; prog.value = Math.round(processed*100/totalSteps);
        log(`✓ رُفعت صفحة ${i}/${maxPages} من ${file.name}`);
      }
    }else{
      const up = await uploadFileToBlob(file);
      uploaded.push(up);
      processed++; prog.value = Math.round(processed*100/totalSteps);
      log(`✓ رُفعت الصورة: ${file.name}`);
    }
  }
  prog.hidden = true;
  $('uploadSummary').textContent = `تم تجهيز ${uploaded.length} صورة/صفحة للتحليل.`;
  return uploaded;
}

async function analyze(filesMeta, options){
  const res = await fetch('/api/gpt?action=analyze', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      files: filesMeta,
      language: options.language,
      model: options.model,
      specialty: options.specialty || '',
      context: options.context || ''
    })
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error('API error: ' + t);
  }
  return res.json();
}

$('analyzeBtn').addEventListener('click', async ()=>{
  try{
    const files = Array.from($('fileInput').files || []);
    if(!files.length){ alert('اختر ملفاً واحداً على الأقل.'); return; }
    $('analyzeBtn').disabled = true;
    log('بدء الرفع/التحويل ...');
    const uploaded = await handleFiles(files);
    log('بدء التحليل عبر النماذج ...');
    const result = await analyze(uploaded, {
      language: $('lang').value,
      model: $('model').value,
      specialty: $('specialty').value.trim(),
      context: $('context').value.trim()
    });
    $('merged').textContent = result.merged || '';
    $('openaiOut').textContent = result.openai || '—';
    $('geminiOut').textContent = result.gemini || '—';
    log('اكتمل التحليل.');
  }catch(e){
    log('خطأ: ' + e.message);
    alert(e.message);
  }finally{
    $('analyzeBtn').disabled = false;
  }
});
</script>
</body>
</html>
