<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:24px; background:#fafafa; color:#222}
    h1{margin:8px 0 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
    label{font-size:14px;color:#444;margin-inline-end:8px}
    select,textarea,input[type="text"]{font:inherit;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:#fff}
    textarea{width:100%;min-height:110px;direction:rtl}
    button{padding:10px 16px;border:0;border-radius:10px;background:#0ea5e9;color:#fff;cursor:pointer}
    button.secondary{background:#10b981}
    button:disabled{opacity:.6;cursor:not-allowed}
    pre{white-space:pre-wrap;word-wrap:break-word;background:#0b1220;color:#dbeafe;border-radius:10px;padding:14px;min-height:80px}
    .col{flex:1 1 300px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;padding:2px 8px;border-radius:999px;font-size:12px;margin-inline-start:8px}
    .copy{float:left;margin-top:-6px}
  </style>

  <!-- PDF.js عبر CDN + worker (حل خطأ pdfjsLib) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-GTjZr1b2c0X0C61J6mMYJ6jO3m4FCA9j0w+0p3aYf0VEX6bC5M3g+K2b3pU8yAIVJwS+X7u0gX0P9s2OZ3j10Q==" crossorigin="anonymous"></script>
  <script>
    // نضبط مسار عامل PDF.js بمجرد تحميله
    document.addEventListener('DOMContentLoaded', () => {
      if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
    });
  </script>
</head>
<body>
  <h1>تحليل الحالات الطبية <span class="pill">Gemini & GPT‑4o</span></h1>
  <div class="card">
    <div class="row">
      <div class="col">
        <label>اختر ملفات (صورة/‏PDF):</label>
        <input id="files" type="file" accept="application/pdf,image/*" multiple />
      </div>
      <div class="col">
        <label>اللغة:</label>
        <select id="lang">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
      </div>
      <div class="col">
        <label>النموذج:</label>
        <select id="model">
          <option value="both" selected>Gemini + GPT‑4o</option>
          <option value="gpt">GPT‑4o فقط</option>
          <option value="gemini">Gemini فقط</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>التخصص (اختياري):</label>
        <input id="spec" type="text" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
      </div>
      <div class="col">
        <label>وصف مختصر/سياق التأمين (اختياري):</label>
        <input id="ctx" type="text" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="prepBtn">تحضير الملفات</button>
      <button id="analyzeBtn" class="secondary" disabled>تحليل الحالة</button>
    </div>

    <div id="prepStatus" class="mono" style="margin-top:10px;color:#0369a1;">لم يتم التحضير بعد.</div>
  </div>

  <div class="card">
    <h3>السجل</h3>
    <pre id="log"></pre>
  </div>

  <div class="card">
    <div class="row">
      <h3 class="col">النتيجة المدمجة</h3>
      <button id="copyMerged" class="copy">نسخ JSON</button>
    </div>
    <pre id="merged" class="mono"></pre>
  </div>

  <div class="card">
    <h3>مخرجات GPT‑4o</h3>
    <pre id="gptOut" class="mono"></pre>
  </div>

  <div class="card">
    <h3>مخرجات Gemini</h3>
    <pre id="geminiOut" class="mono"></pre>
  </div>

<script>
  // ـــــــــــــــــــــــــــــــــــــــــــــــــــــــــــــ
  // أدوات عامة
  // ـــــــــــــــــــــــــــــــــــــــــــــــــــــــــــــ
  const logEl = document.getElementById('log');
  const mergedEl = document.getElementById('merged');
  const gptEl = document.getElementById('gptOut');
  const geminiEl = document.getElementById('geminiOut');
  const prepStatus = document.getElementById('prepStatus');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const copyMerged = document.getElementById('copyMerged');

  function log(msg){ logEl.textContent += (msg + '\n'); logEl.scrollTop = logEl.scrollHeight; }
  function toDataURL(canvas, mime='image/jpeg', quality=0.82){
    return new Promise(resolve => canvas.toBlob(b => {
      const r = new FileReader();
      r.onloadend = () => resolve(r.result);
      r.readAsDataURL(b);
    }, mime, quality));
  }

  let prepared = { images:[], texts:[] };

  // ـــــــــــــــــــــــــــــــــــــــــــــــــــــــــــــ
  // تحويل PDF إلى صور + استخراج نص (PDF.js) أو حمل الصور كما هي
  // ـــــــــــــــــــــــــــــــــــــــــــــــــــــــــــــ
  async function prepareFiles(){
    prepared = { images:[], texts:[] };
    const files = document.getElementById('files').files;
    if(!files || !files.length){ alert('الرجاء اختيار ملف واحد على الأقل.'); return; }

    if(!window.pdfjsLib){
      alert('فشل التحضير: pdfjsLib is not defined — تأكد أن كود PDF.js تم تحميله (حلّناه بإضافة CDN).');
      return;
    }

    log('بدء التحضير ... < تحويل PDF واستخراج نص (إن وُجد) >');

    for (const file of files){
      if (file.type === 'application/pdf'){
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: buf}).promise;
        let allText = '';
        const maxPages = Math.min(pdf.numPages, 6); // حد معقول للطلب

        for (let p=1; p<=maxPages; p++){
          const page = await pdf.getPage(p);
          // عرض معقول لتقليل الحجم
          const viewport = page.getViewport({ scale: 1.6 });
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = Math.min(1400, viewport.width);
          canvas.height = (canvas.width/viewport.width)*viewport.height;
          const renderContext = { canvasContext: ctx, viewport: page.getViewport({ scale: canvas.width/viewport.width }) };
          await page.render(renderContext).promise;
          const dataUrl = await toDataURL(canvas, 'image/jpeg', 0.82);
          prepared.images.push({ dataUrl, contentType:'image/jpeg' });

          const textContent = await page.getTextContent();
          const text = textContent.items.map(it=>it.str).join(' ');
          allText += '\n' + text;
        }
        if (allText.trim()) prepared.texts.push(allText.trim());
        log(`✓ رُفعت ${maxPages}/${pdf.numPages} صفحة من ${file.name}`);
      } else if (file.type.startsWith('image/')){
        const dataUrl = await new Promise(r=>{
          const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsDataURL(file);
        });
        prepared.images.push({ dataUrl, contentType: file.type });
        log(`✓ أُضيفت صورة: ${file.name}`);
      } else {
        log(`تجاهُل ملف غير مدعوم: ${file.name}`);
      }
    }

    prepStatus.textContent = `تم تجهيز ${prepared.images.length} صورة/صفحة + ${prepared.texts.length} نص PDF للتحليل.`;
    analyzeBtn.disabled = prepared.images.length===0 && prepared.texts.length===0;
  }

  // ـــــــــــــــــــــــــــــــــــــــــــــــــــــــــــــ
  // استدعاء الخادم /api/gpt
  // ـــــــــــــــــــــــــــــــــــــــــــــــــــــــــــــ
  async function analyze(){
    if (prepared.images.length===0 && prepared.texts.length===0){
      alert('رجاءً اضغط "تحضير الملفات" أولًا.'); return;
    }
    analyzeBtn.disabled = true;
    mergedEl.textContent = gptEl.textContent = geminiEl.textContent = '';
    log('بدء التحليل ...');

    const payload = {
      language: document.getElementById('lang').value,
      modelChoice: document.getElementById('model').value,
      specialty: document.getElementById('spec').value.trim(),
      insuranceContext: document.getElementById('ctx').value.trim(),
      images: prepared.images,
      texts: prepared.texts
    };

    try{
      const res = await fetch('/api/gpt', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok){
        const t = await res.text();
        throw new Error(`HTTP ${res.status}: ${t}`);
      }
      const data = await res.json();
      mergedEl.textContent = JSON.stringify(data.merged, null, 2);
      gptEl.textContent    = data.gpt   ? JSON.stringify(data.gpt, null, 2)    : '—';
      geminiEl.textContent = data.gemini? JSON.stringify(data.gemini, null, 2) : '—';
      log('اكتمل التحليل.');
    }catch(err){
      log('خطأ: ' + err.message);
      alert('فشل التحليل: ' + err.message);
    }finally{
      analyzeBtn.disabled = false;
    }
  }

  document.getElementById('prepBtn').addEventListener('click', prepareFiles);
  document.getElementById('analyzeBtn').addEventListener('click', analyze);
  copyMerged.addEventListener('click', ()=>{
    navigator.clipboard.writeText(mergedEl.textContent||'');
  });
</script>
</body>
</html>
