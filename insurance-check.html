<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تقييم الحالة الطبية - بوابة الطبيب</title>
  <style>
    :root{
      --primary:#0056b3; --secondary:#6c757d; --danger:#dc3545;
      --bg:#f4f7f9; --text:#333; --card:#fff; --border:#dee2e6; --focus:rgba(0,86,179,.25)
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:1rem}
    .container{max-width:960px;margin:2rem auto;background:var(--card);padding:2.2rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);border:1px solid var(--border)}
    h2{text-align:center;color:var(--primary);margin:0 0 1.6rem;font-weight:700}
    .section-title{font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:.5rem;margin:1.75rem 0 1rem}
    label{font-weight:600;display:block;margin:.8rem 0 .45rem}
    textarea,input,select{width:100%;padding:.75rem 1rem;font-size:1rem;border:1px solid var(--border);border-radius:8px;transition:border-color .3s,box-shadow .3s}
    textarea:focus,input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--focus)}
    textarea{min-height:110px;resize:vertical}
    .grid{display:grid;gap:1rem}
    .cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .cols-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .btns{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;margin-top:2rem}
    button{padding:.85rem 1.3rem;font-size:1.05rem;font-weight:700;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:background .25s,transform .05s}
    button:active{transform:scale(.985)}
    .btn-primary{background:var(--primary)} .btn-primary:hover{background:#004494}
    .btn-secondary{background:var(--secondary)} .btn-secondary:hover{background:#5a6268}
    .btn-danger{background:var(--danger)} .btn-danger:hover{background:#c82333}
    .drop{border:2px dashed var(--border);border-radius:10px;padding:1.2rem;text-align:center;cursor:pointer}
    .drop:hover{border-color:var(--primary);background:#f8f9fa}
    .preview{margin-top:.75rem;text-align:center}
    .preview img{max-width:100%;max-height:300px;border:1px solid var(--border);border-radius:8px;display:none}
    .meta{font-size:.9rem;color:#555;margin-top:.4rem;display:none}
    #user-info{margin-bottom:1rem;text-align:center;color:#555}
    #response-container{margin-top:1.2rem;padding:1.2rem;border:1px solid #eee;border-radius:10px;background:#fff;display:none}
    .notification{padding:1rem;margin-top:1rem;border-radius:8px;text-align:center;display:none}
    .notification.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .notification.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}

    /* ألوان المخاطر التي يرجعها التقرير */
    #response-container .risk-high{color:#721c24;background:#f8d7da;padding:.2rem .6rem;border-radius:6px;font-weight:700;border:1px solid #f5c6cb}
    #response-container .risk-medium{color:#856404;background:#fff3cd;padding:.2rem .6rem;border-radius:6px;font-weight:700;border:1px solid #ffeeba}
    #response-container .risk-low{color:#155724;background:#d4edda;padding:.2rem .6rem;border-radius:6px;font-weight:700;border:1px solid #c3e6cb}

    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <h2>تقييم الحالة الطبية وطلبات التأمين</h2>
    <div id="user-info">جاري التحقق من المستخدم...</div>

    <!-- 1) معلومات المريض -->
    <h3 class="section-title">1) معلومات المريض</h3>
    <div class="grid cols-3">
      <div>
        <label for="gender">الجنس</label>
        <select id="gender">
          <option value="" disabled selected>اختر...</option>
          <option value="male">ذكر</option>
          <option value="female">أنثى</option>
        </select>
      </div>

      <div>
        <label for="age">العمر (سنة)</label>
        <input type="number" id="age" placeholder="مثال: 63">
      </div>

      <div id="pregnancy-status-container" class="hidden">
        <label for="pregnancy-status">هل المريضة حامل؟</label>
        <select id="pregnancy-status">
          <option value="" disabled selected>اختر...</option>
          <option value="no">لا</option>
          <option value="yes">نعم</option>
        </select>
      </div>

      <div id="pregnancy-month-container" class="hidden">
        <label for="pregnancy-month">شهر الحمل</label>
        <input type="number" id="pregnancy-month" min="1" max="9" placeholder="مثال: 5">
      </div>

      <div>
        <label for="height">الطول (سم)</label>
        <input type="number" id="height" placeholder="مثال: 175">
      </div>
      <div>
        <label for="weight">الوزن (كجم)</label>
        <input type="number" id="weight" placeholder="مثال: 80">
      </div>
      <div>
        <label for="temperature">الحرارة (°م)</label>
        <input type="text" id="temperature" placeholder="مثال: 37.5">
      </div>
      <div>
        <label for="blood-pressure">ضغط الدم</label>
        <input type="text" id="blood-pressure" placeholder="مثال: 120/80">
      </div>
    </div>

    <!-- 2) عوامل خطر تنفّسية -->
    <h3 class="section-title">2) عوامل خطر تنفّسية</h3>
    <div class="grid cols-3">
      <div>
        <label for="isSmoker">مدخّن؟</label>
        <select id="isSmoker">
          <option value="" selected disabled>اختر...</option>
          <option value="yes">نعم</option>
          <option value="no">لا</option>
        </select>
      </div>

      <div id="packYearsContainer" class="hidden">
        <label for="packYears">باك-سنة</label>
        <input type="number" id="packYears" placeholder="مثال: 25">
      </div>

      <div id="coughWeeksContainer" class="hidden">
        <label for="coughWeeks">مدة السعال (أسابيع)</label>
        <input type="number" id="coughWeeks" placeholder="مثال: 10">
      </div>
    </div>

    <!-- 3) عيون -->
    <h3 class="section-title">3) عيون (للسكري/الكبار/أعراض بصرية)</h3>
    <div class="grid cols-3">
      <div>
        <label for="visualSymptoms">أعراض بصرية؟</label>
        <select id="visualSymptoms">
          <option value="" selected disabled>اختر...</option>
          <option value="none">لا</option>
          <option value="blur">تشوّش/انخفاض الرؤية</option>
          <option value="floaters">عوائم/ومضات</option>
        </select>
      </div>
      <div>
        <label for="lastEyeExamDate">آخر فحص عين</label>
        <input type="date" id="lastEyeExamDate">
      </div>
      <div>
        <label for="visualAcuity">حدة الإبصار</label>
        <input type="text" id="visualAcuity" placeholder="مثال: 6/9 أو 20/40">
      </div>
    </div>

    <!-- 4) تشخيصات/تحاليل/أدوية -->
    <h3 class="section-title">4) تشخيصات/تحاليل/أدوية</h3>
    <label for="case-description">وصف الحالة</label>
    <textarea id="case-description" placeholder="مثال: مريض سكري نوع 2 مع دوار/التهاب جلد..."></textarea>

    <label for="diagnosis">التشخيصات</label>
    <textarea id="diagnosis" placeholder="مثال: T2DM, HTN, Vertigo, Dermatitis"></textarea>

    <label for="lab-results">نتائج تحاليل/أشعة (نص حر)</label>
    <textarea id="lab-results" placeholder="مثال: eGFR 55, HbA1c 8.2%, CRP مرتفع..."></textarea>

    <div class="grid cols-3">
      <input id="egfr" placeholder="eGFR: مثال 55"/>
      <input id="hba1c" placeholder="HbA1c: مثال 8.2%"/>
      <input id="k" placeholder="Potassium: مثال 5.1"/>
      <input id="cr" placeholder="Creatinine: مثال 1.3"/>
      <input id="ua" placeholder="Uric Acid: مثال 8.0"/>
    </div>

    <label for="medications-procedures" style="margin-top:.6rem">الأدوية/الإجراءات الحالية</label>
    <textarea id="medications-procedures" placeholder="مثال: Xigduo XR 5/1000 1x2x90, Diovan 40 1x1x90, ..."></textarea>

    <!-- 5) رفع صورة -->
    <h3 class="section-title">5) رفع الملفات (اختياري)</h3>
    <div class="drop" id="drop">اضغط أو اسحب لرفع صورة (وصفة/تقرير)</div>
    <input type="file" id="image-upload-input" accept="image/*" hidden>
    <div class="preview">
      <img id="image-preview" alt="معاينة" />
      <div id="image-meta" class="meta"></div>
    </div>

    <!-- أزرار -->
    <div class="btns">
      <button id="analyzeBtn" class="btn-primary" onclick="analyzeCase()">تحليل الحالة وتقديم التقرير</button>
      <button class="btn-secondary" onclick="goToHome()">الشاشة الرئيسية</button>
      <button class="btn-danger" onclick="logout()">تسجيل الخروج</button>
    </div>

    <!-- إشعارات/نتيجة -->
    <div id="notification-area"></div>
    <div id="response-container"></div>
  </div>

  <script type="module">
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey:"AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
      authDomain:"insurance-check-6cec9.firebaseapp.com",
      projectId:"insurance-check-6cec9",
      storageBucket:"insurance-check-6cec9.appspot.com",
      messagingSenderId:"992769471393",
      appId:"1:992769471393:web:c8a9400210a0e7901011e0"
    };
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getAuth, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
      if (user) document.getElementById("user-info").textContent = `مرحبًا بك، ${user.email}`;
      else window.location.href = "https://www.m2020m.org/login.html";
    });

    window.logout = () => signOut(auth).then(() => {
      showNotification("info","تم تسجيل الخروج بنجاح.");
      setTimeout(()=> window.location.href="https://www.m2020m.org/login.html",1500);
    });

    window.goToHome = () => { window.location.href = "https://www.m2020m.org/portal.html"; };

    // ===== مراجع العناصر =====
    const genderSelect = document.getElementById('gender');
    const pregnancyStatusContainer = document.getElementById('pregnancy-status-container');
    const pregnancyMonthContainer = document.getElementById('pregnancy-month-container');
    const pregnancyStatusSelect = document.getElementById('pregnancy-status');

    const smokerSelect = document.getElementById('isSmoker');
    const packYearsContainer = document.getElementById('packYearsContainer');
    const coughWeeksContainer = document.getElementById('coughWeeksContainer');

    // ===== منطق الحمل =====
    function togglePregnancyFields() {
      if (genderSelect.value === 'female') {
        pregnancyStatusContainer.classList.remove('hidden');
        if (pregnancyStatusSelect.value === 'yes') {
          pregnancyMonthContainer.classList.remove('hidden');
        } else {
          pregnancyMonthContainer.classList.add('hidden');
          document.getElementById('pregnancy-month').value = '';
        }
      } else {
        pregnancyStatusContainer.classList.add('hidden');
        pregnancyMonthContainer.classList.add('hidden');
        pregnancyStatusSelect.value = '';
        document.getElementById('pregnancy-month').value = '';
      }
    }
    genderSelect.addEventListener('change', togglePregnancyFields);
    pregnancyStatusSelect.addEventListener('change', togglePregnancyFields);

    // ===== منطق التدخين =====
    function toggleSmokingFields() {
      const v = smokerSelect.value;
      if (v === 'yes') {
        packYearsContainer.classList.remove('hidden');
        coughWeeksContainer.classList.remove('hidden');
      } else {
        packYearsContainer.classList.add('hidden');
        coughWeeksContainer.classList.add('hidden');
        const packYears = document.getElementById('packYears');
        const coughWeeks = document.getElementById('coughWeeks');
        if (packYears) packYears.value = '';
        if (coughWeeks) coughWeeks.value = '';
      }
    }
    smokerSelect.addEventListener('change', toggleSmokingFields);

    // ===== تهيئة الحقول عند التحميل =====
    function initConditionalFields(){
      togglePregnancyFields();
      toggleSmokingFields();
    }
    initConditionalFields();

    // ===== رفع/ضغط الصورة =====
    const imageInput = document.getElementById('image-upload-input');
    const imagePreview = document.getElementById('image-preview');
    const imageMeta = document.getElementById('image-meta');
    const drop = document.getElementById('drop');
    let imageBase64 = null; // بدون البادئة

    drop.addEventListener('click', ()=> imageInput.click());
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#f8f9fa';});
    drop.addEventListener('dragleave', ()=> drop.style.background='transparent');
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.style.background='transparent';
      const f = e.dataTransfer.files?.[0]; if (f) handleImageFile(f);
    });
    imageInput.addEventListener('change', e=>{
      const f = e.target.files?.[0]; if (f) handleImageFile(f);
    });

    async function handleImageFile(file){
      try{
        showNotification('info','جاري ضغط الصورة...');
        const { base64, info } = await compressImage(file, { maxW: 1400, maxH: 1400, quality: 0.75 });
        imageBase64 = base64;
        imagePreview.src = 'data:image/jpeg;base64,'+base64;
        imagePreview.style.display='inline-block';
        imageMeta.textContent = `الحجم بعد الضغط: ${info.sizeKB.toFixed(1)} KB — الأبعاد: ${info.w}×${info.h}`;
        imageMeta.style.display='block';
        clearNotifications();
      }catch(err){
        console.error(err);
        showNotification('error','تعذر معالجة الصورة.');
      }
    }

    async function compressImage(file, { maxW=1400, maxH=1400, quality=0.75 } = {}){
      const dataURL = await new Promise((res,rej)=>{
        const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
      });
      const img = await new Promise((res,rej)=>{
        const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL;
      });
      let {width:w, height:h} = img;
      const ratio = Math.min(maxW/w, maxH/h, 1);
      w = Math.round(w*ratio); h = Math.round(h*ratio);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      const out = canvas.toDataURL('image/jpeg', quality);
      const b64 = out.split(',')[1];
      const sizeKB = (b64.length * 3) / 4 / 1024;
      return { base64: b64, info: { w, h, sizeKB } };
    }

    // ===== إشعارات =====
    function showNotification(type, message){
      const area = document.getElementById('notification-area');
      area.innerHTML = '';
      const d = document.createElement('div');
      d.className = `notification ${type}`;
      d.textContent = message;
      area.appendChild(d);
      d.style.display = 'block';
    }
    function clearNotifications(){ document.getElementById('notification-area').innerHTML = ''; }

    // ===== إرسال الطلب وتحليل =====
    window.analyzeCase = async function(){
      const btn = document.getElementById('analyzeBtn');
      const responseContainer = document.getElementById('response-container');
      clearNotifications(); responseContainer.style.display='none'; responseContainer.innerHTML='';

      const caseData = {
        userType: 'doctor',
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        isPregnant: document.getElementById('pregnancy-status').value,
        pregnancyMonth: document.getElementById('pregnancy-month').value,
        height: document.getElementById('height').value,
        weight: document.getElementById('weight').value,
        temperature: document.getElementById('temperature').value,
        bloodPressure: document.getElementById('blood-pressure').value,

        notes: document.getElementById('case-description').value,
        diagnosis: document.getElementById('diagnosis').value,
        labResults: document.getElementById('lab-results').value,
        medications: document.getElementById('medications-procedures').value,

        // حقل التدخين الذكي
        isSmoker: document.getElementById('isSmoker').value === 'yes'
          ? true
          : (document.getElementById('isSmoker').value === 'no' ? false : undefined),
        smokingPackYears: toNumber(document.getElementById('packYears').value),
        coughDurationWeeks: toNumber(document.getElementById('coughWeeks').value),

        // عيون
        visualSymptoms: document.getElementById('visualSymptoms').value || undefined,
        lastEyeExamDate: document.getElementById('lastEyeExamDate').value || undefined,
        visualAcuity: document.getElementById('visualAcuity').value || undefined,

        // مخبري اختياري
        eGFR: document.getElementById('egfr').value || undefined,
        hba1c: document.getElementById('hba1c').value || undefined,
        k: document.getElementById('k').value || undefined,
        cr: document.getElementById('cr').value || undefined,
        ua: document.getElementById('ua').value || undefined,

        imageData: imageBase64 ? [imageBase64] : []
      };

      if (
        !caseData.notes && !caseData.diagnosis && !caseData.labResults &&
        !caseData.medications && caseData.imageData.length === 0
      ){
        showNotification('error','الرجاء إدخال بعض تفاصيل الحالة أو رفع صورة.');
        return;
      }

      showNotification('info','جاري تحليل الحالة، قد يستغرق الأمر دقيقة...');
      btn.disabled = true;

      try{
        if (!auth.currentUser) throw new Error('المستخدم غير مسجل الدخول.');

        const token = await auth.currentUser.getIdToken();
        const res = await fetch('/api/gpt', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
          body: JSON.stringify(caseData)
        });

        const text = await res.text();
        if (!res.ok){
          if (res.status === 413 || /Content Too Large|Entity Too Large/i.test(text)){
            throw new Error('حجم البيانات كبير: صغّر/قلّل جودة الصورة أو ارفع صورة واحدة فقط.');
          }
          throw new Error(`فشل الطلب (${res.status}): ${text.slice(0,200)}...`);
        }

        let data;
        try { data = JSON.parse(text); }
        catch { throw new Error('الرد من الخادم ليس JSON صالحاً.'); }

        if (data.htmlReport){
          clearNotifications();
          responseContainer.innerHTML = data.htmlReport;
          responseContainer.style.display = 'block';
          responseContainer.scrollIntoView({ behavior:'smooth' });
        } else {
          throw new Error('لم يتم استلام تقرير من الخادم.');
        }
      }catch(err){
        console.error(err);
        showNotification('error','حدث خطأ أثناء التحليل: ' + err.message);
      }finally{
        btn.disabled = false;
      }
    };

    function toNumber(v){ const n = Number(v); return Number.isFinite(n) ? n : undefined; }
  </script>
</body>
</html>
