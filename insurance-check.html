<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="app-title">تقييم الحالة الطبية وطلبات التأمين</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --primary-50: #f0f9ff; --primary-100: #e0f2fe; --primary-200: #bae6fd; --primary-300: #7dd3fc; --primary-400: #38bdf8; --primary-500: #0ea5e9; --primary-600: #0284c7; --primary-700: #0369a1; --primary-800: #075985; --primary-900: #0c4a6e;
      --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1; --gray-400: #94a3b8; --gray-500: #64748b; --gray-600: #475569; --gray-700: #334155; --gray-800: #1e293b;
      --ok: #16a34a; --warn: #f59e0b; --bad: #dc2626;
      --card-bg: #ffffff;
      --body-bg: #f8fafc;
      --text-color: var(--gray-800);
      --muted-text: var(--gray-500);
      --border-color: var(--gray-200);
      --ring-color: #a5d8ff;
    }
    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: "Tajawal", system-ui, sans-serif;
      background-color: var(--body-bg);
      color: var(--text-color);
      margin: 0;
      padding-top: 80px; /* Space for the fixed header */
    }
    html[dir="ltr"] body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 24px;
    }
    .topbar {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .home {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--primary-600);
      color: #fff;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    .home:hover { background: var(--primary-700); }
    .home svg { width: 20px; height: 20px; }
    .chip {
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
      color: var(--gray-600);
      transition: all 0.2s ease;
    }
    .chip:hover {
        border-color: var(--primary-400);
        color: var(--primary-600);
    }

    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 24px;
    }
    .title-section {
        text-align: center;
        margin-bottom: 24px;
    }
    .title-section h1 {
      font-size: 32px;
      color: var(--primary-800);
      margin: 0 0 4px;
    }
    .subtitle {
      color: var(--muted-text);
      font-size: 16px;
      max-width: 500px;
      margin: 0 auto 24px;
    }
    .evidence-banner {
      background: var(--primary-50);
      border: 1px solid var(--primary-200);
      color: var(--primary-800);
      padding: 12px 16px;
      border-radius: 14px;
      margin-bottom: 24px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section { margin-top: 24px; }
    .section h2 {
      font-size: 20px;
      color: var(--primary-700);
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 0 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }
    .card {
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 8px;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: #fff;
      outline: none;
      font-size: 15px;
      transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-400);
      box-shadow: 0 0 0 3px var(--ring-color);
    }
    textarea { min-height: 100px; resize: vertical; }

    .uploader {
      border: 2px dashed var(--primary-200);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      color: var(--gray-500);
      background-color: var(--primary-50);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .uploader:hover, .uploader.drag {
        background-color: var(--primary-100);
        border-color: var(--primary-400);
        color: var(--primary-700);
    }
    .uploader input { display: none; }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .fileCard {
      position: relative;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease;
    }
    .fileCard:hover { transform: translateY(-3px); }
    .thumb {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
      background: var(--gray-100);
    }
    .meta {
      padding: 12px;
      font-size: 13px;
      color: var(--gray-700);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .remove {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(220, 38, 38, 0.9);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s ease;
    }
    .fileCard:hover .remove {
      opacity: 1;
      transform: scale(1);
    }

    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      padding: 14px 24px;
      border-radius: 14px;
      background: var(--primary-600);
      color: #fff;
      font-weight: 700;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    .btn:hover:not(:disabled) {
      background: var(--primary-700);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(2, 132, 199, 0.2);
    }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-secondary { background: var(--gray-700); }
    .btn-secondary:hover:not(:disabled) { background: var(--gray-800); box-shadow: 0 4px 15px rgba(30, 41, 59, 0.2); }

    #reportWrap { margin-top: 32px; }
    .report-toolbar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    #busy { color: var(--muted-text); font-weight: 500; }
    .avoid-break, .card, table, tr, td, th { break-inside: avoid; page-break-inside: avoid; }
    .page-break { break-before: page; page-break-before: always; }

    @media (max-width: 768px) {
      .grid .col-6, .grid .col-4 { grid-column: span 12; }
      body { padding-top: 70px; }
      .container { padding: 0 16px; margin-top: 16px; }
      .app-header { padding: 12px 16px; }
    }

    @media print {
      .no-print, .app-header { display: none !important; }
      body { background: #fff; padding-top: 0; }
      .container { box-shadow: none; border: none; margin: 0; padding: 0; max-width: 100%; }
      .page-break { break-before: page; }
    }
  </style>
</head>

<body>
  <header class="app-header">
    <div class="topbar">
      <a class="home" href="https://www.m2020m.org/portal.html" target="_blank" rel="noopener">
        <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" /></svg>
        <span>الصفحة الرئيسية</span>
      </a>
      <span class="chip" id="lang-switcher">English</span>
    </div>
  </header>

  <main class="container">
    <div class="title-section">
      <h1>تقييم الحالة الطبية وطلبات التأمين</h1>
      <p class="subtitle">واجهة إدخال سريرية سهلة — تحليل عميق متناغم مع احتياجات التأمين</p>
    </div>

    <div class="evidence-banner">
      <svg viewBox="0 0 24 24" fill="currentColor" height="24" width="24" style="flex-shrink:0"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2V8h2v5z"/></svg>
      <div>يستند الحكم التأميني إلى أدلة موجزة من <b>WHO</b> و<b>CDC</b> و<b>Medscape</b>—ويظهر التبرير داخل الجدول.</div>
    </div>

    <div class="section">
      <h2>1) معلومات المريض</h2>
      <div class="card avoid-break">
        <div class="grid">
          <div class="col-4"><label for="name">الاسم (اختياري)</label><input id="name" placeholder="مثال: أحمد خالد" /></div>
          <div class="col-4"><label for="gender">الجنس</label><select id="gender"><option value="">اختر</option><option value="ذكر">ذكر</option><option value="أنثى">أنثى</option></select></div>
          <div class="col-4"><label for="age">العمر (بالسنوات)</label><input id="age" type="number" min="0" placeholder="مثال: 63" /></div>
          <div class="col-4"><label for="pregnant">هل المريضة حامل؟</label><select id="pregnant"><option value="no">لا</option><option value="yes">نعم</option><option value="na">غير منطبق</option></select></div>
          <div class="col-4"><label for="pregnancyMonths">شهر الحمل (إن وُجد)</label><input id="pregnancyMonths" type="number" min="1" max="10" placeholder="مثال: 5" /></div>
          <div class="col-4"><label for="smoking">هل المريض مدخّن؟</label><select id="smoking"><option value="">اختر</option><option value="مدخن">مدخن</option><option value="غير مدخن">غير مدخن</option><option value="سابق">سابق</option></select></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>2) خطّ الحياة والأعراض</h2>
      <div class="card avoid-break">
        <div class="grid">
          <div class="col-12"><label for="freeText">وصف الحالة (نص حر)</label><textarea id="freeText" placeholder="مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن بسيط..."></textarea></div>
          <div class="col-6"><label for="initialDx">التشخيصات المبدئية (نص)</label><textarea id="initialDx" placeholder="مثال: T2DM, HTN, COPD? Dermatitis"></textarea></div>
          <div class="col-6"><label for="labsImaging">تحاليل/الأشعة المذكورة (نص)</label><textarea id="labsImaging" placeholder="مثال: HbA1c 8.7%, eGFR 38→62, K 5.6 ..."></textarea></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>3) رفع ملفات (صور/PDF) — اختياري</h2>
      <label class="uploader no-print" for="fileInput" id="dropZone">
        <div>
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary-500); margin-bottom: 8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        </div>
        اسحب وأفلت الملفات هنا، أو انقر للاختيار
        <input id="fileInput" type="file" multiple accept="image/*,application/pdf" />
      </label>
      <div id="cards" class="cards" aria-live="polite"></div>
    </div>

    <div class="section no-print" style="display:flex; gap:16px; flex-wrap:wrap; align-items:center; margin-top: 32px;">
      <button class="btn" id="analyzeBtn">تحليل الحالة</button>
      <span id="busy" style="display:none">
        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="var(--primary-600)"><circle cx="12" cy="12" r="0" fill-opacity="1"><animate attributeName="r" from="0" to="10" dur="1.5s" begin="0s" repeatCount="indefinite" calcMode="spline" keySplines="0.165, 0.84, 0.44, 1" values="0; 10"/><animate attributeName="fill-opacity" from="1" to="0" dur="1.5s" begin="0s" repeatCount="indefinite" calcMode="spline" keySplines="0.3, 0.61, 0.355, 1" values="1; 0"/></circle></svg>
        <span style="margin-right: 8px;">جاري التحليل…</span>
      </span>
    </div>

    <div id="reportWrap" class="section" style="display:none">
      <div class="report-toolbar no-print">
        <button class="btn-secondary btn" id="exportHqBtn">تصدير PDF (جودة عالية)</button>
      </div>
      <div id="reportHTML" class="avoid-break"></div>
      <details style="margin-top:16px" class="no-print">
        <summary style="cursor:pointer; color: var(--gray-600);">إظهار JSON (للبحث/الإحصاءات)</summary>
        <pre id="jsonOut" style="white-space:pre-wrap; background:var(--gray-50); padding:16px; border-radius:12px; border:1px solid var(--border-color); margin-top: 8px;"></pre>
      </details>
    </div>
  </main>

<script>
    const filesState = [];
    const fileInput = document.getElementById('fileInput');
    const dropZone  = document.getElementById('dropZone');
    const cardsBox  = document.getElementById('cards');

    ['dragenter','dragover','dragleave','drop'].forEach(evName => {
        dropZone.addEventListener(evName, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });
    dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
    dropZone.addEventListener('drop', e => {
        dropZone.classList.remove('drag');
        handleFiles(Array.from(e.dataTransfer.files));
    });
    fileInput.addEventListener('change', () => handleFiles(Array.from(fileInput.files)));

    async function handleFiles(files) {
        for(const f of files){
            const base64Url = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = reject;
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(f);
            });
            filesState.push({ name: f.name, mimeType: f.type || 'application/octet-stream', data: base64Url });
        }
        renderCards();
        fileInput.value = '';
    }

    function renderCards() {
        cardsBox.innerHTML = '';
        filesState.forEach((f, i) => {
            const isImg = (f.mimeType||'').startsWith('image/');
            const thumb = isImg ? f.data : `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="%23f1f5f9"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="18" fill="%2364748b">${f.name}</text></svg>`;
            const el = document.createElement('div');
            el.className = 'fileCard avoid-break';
            el.innerHTML = `<button class="remove" data-index="${i}">×</button><img class="thumb" src="${thumb}" alt="${f.name}"><div class="meta">${f.name}</div>`;
            cardsBox.appendChild(el);
        });
        cardsBox.querySelectorAll('.remove').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const i = +e.currentTarget.dataset.index;
                filesState.splice(i, 1);
                renderCards();
            });
        });
    }

    document.getElementById('analyzeBtn').addEventListener('click', async () => {
        const analyzeBtn = document.getElementById('analyzeBtn');
        const busy = document.getElementById('busy');
        analyzeBtn.disabled = true;
        busy.style.display = 'inline-flex';
        busy.style.alignItems = 'center';

        try {
            const textParts = [
                `التشخيصات المبدئية: ${document.getElementById('initialDx').value.trim()}`,
                `وصف الحالة: ${document.getElementById('freeText').value.trim()}`,
                `تحاليل/أشعة: ${document.getElementById('labsImaging').value.trim()}`
            ];

            const payload = {
                text: textParts.filter(p => p.split(':')[1].trim()).join('\n'),
                patientInfo: {
                    ageYears: +document.getElementById('age').value || null,
                    gender: document.getElementById('gender').value || null,
                    pregnant: { isPregnant: document.getElementById('pregnant').value === 'yes' },
                    smoking: { status: document.getElementById('smoking').value || null }
                },
                files: filesState.map(f => ({ name: f.name, mimeType: f.mimeType, data: f.data.split(',')[1] })),
                lang: document.documentElement.lang || 'ar'
            };

            // This is a placeholder for your actual API call.
            // Replace this with your fetch logic.
            const data = await new Promise(resolve => setTimeout(() => {
                resolve({
                    html: `<h3>تقرير تحليلي</h3><p>تم استلام البيانات بنجاح. هذا هو التقرير الذي تم إنشاؤه بناءً على المدخلات.</p><table><thead><tr><th>المعيار</th><th>القيمة</th></tr></thead><tbody><tr><td>العمر</td><td>${payload.patientInfo.ageYears || 'N/A'}</td></tr><tr><td>الجنس</td><td>${payload.patientInfo.gender || 'N/A'}</td></tr><tr><td>عدد الملفات</td><td>${payload.files.length}</td></tr></tbody></table>`,
                    structured: payload
                });
            }, 1500));
            // End of placeholder

            document.getElementById('reportWrap').style.display = 'block';
            document.getElementById('reportHTML').innerHTML = `<div id="reportContent" class="card">${data.html || ''}</div>`;
            document.getElementById('jsonOut').textContent = JSON.stringify(data.structured || {}, null, 2);
            
            // Scroll to the report
            document.getElementById('reportWrap').scrollIntoView({ behavior: 'smooth' });

        } catch (err) {
            alert(`خطأ: ${err.message}`);
        } finally {
            analyzeBtn.disabled = false;
            busy.style.display = 'none';
        }
    });

    document.getElementById('exportHqBtn').addEventListener('click', async () => {
        const busy = document.getElementById('busy');
        busy.style.display = 'inline-flex';
        try {
            const element = document.getElementById('reportContent');
            if (!element) throw new Error('التقرير غير جاهز للتصدير.');
            
            html2pdf().from(element).set({
                margin: 1,
                filename: 'Medical_Audit_Report-HQ.pdf',
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            }).save();

        } catch (e) {
            alert(`خطأ في التصدير: ${e.message}`);
        } finally {
            // Add a small delay to allow the download prompt to appear
            setTimeout(() => {
                busy.style.display = 'none';
            }, 1000);
        }
    });
</script>
</body>
</html>

