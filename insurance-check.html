<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام تحليل الحالات الطبية - التأمين الطبي</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #0056b3;
      --primary-light: #e6f0ff;
      --secondary-color: #dc3545;
      --background-color: #f4f7f9;
      --text-color: #333;
      --text-light: #666;
      --card-bg-color: #ffffff;
      --border-color: #e0e0e0;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --risk-high: #ff6b6b;
      --risk-medium: #ffd93d;
      --risk-low: #6bcb77;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      margin: 0;
      padding: 1rem;
      background-image: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 2rem auto;
      background-color: var(--card-bg-color);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .home-link {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 24px;
      color: var(--primary-color);
      text-decoration: none;
      transition: all 0.3s ease;
      background: var(--primary-light);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .home-link:hover {
      transform: scale(1.1);
      background: var(--primary-color);
      color: white;
    }
    
    .header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-top: 10px;
    }
    
    .header h2 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
      position: relative;
      display: inline-block;
      padding-bottom: 10px;
    }
    
    .header h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: var(--primary-color);
      border-radius: 3px;
    }
    
    .header p {
      color: var(--text-light);
      font-size: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .form-section {
      margin-bottom: 1.8rem;
      padding: 1.5rem;
      background: #fafcff;
      border-radius: 12px;
      border: 1px solid #e6ecf5;
    }
    
    .form-section-title {
      color: var(--primary-color);
      margin-bottom: 1.2rem;
      padding-bottom: 8px;
      border-bottom: 2px dashed #e0e8f0;
      display: flex;
      align-items: center;
    }
    
    .form-section-title i {
      margin-left: 8px;
    }
    
    label {
      font-weight: 600;
      display: block;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      color: #2c3e50;
    }
    
    .required::after {
      content: " *";
      color: var(--danger-color);
    }
    
    textarea, input, select {
      width: 100%;
      padding: 0.9rem 1.2rem;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      box-sizing: border-box;
      transition: all 0.3s ease;
      background: white;
      font-family: inherit;
    }
    
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.15);
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.7;
    }
    
    .input-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .input-item {
      flex: 1;
      min-width: 200px;
    }
    
    .button-group {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-top: 2.5rem;
    }
    
    button {
      padding: 1.1rem;
      font-size: 1.1rem;
      font-weight: bold;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    button:active:not(:disabled) {
        transform: scale(0.98);
    }
    
    .btn-primary { 
      background-color: var(--primary-color);
      box-shadow: 0 4px 12px rgba(0, 86, 179, 0.25);
    }
    
    .btn-primary:hover:not(:disabled) { 
      background-color: #004494;
      box-shadow: 0 6px 15px rgba(0, 86, 179, 0.3);
    }
    
    .btn-danger { 
      background-color: var(--secondary-color);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.25);
    }
    
    .btn-danger:hover:not(:disabled) { 
      background-color: #c82333;
      box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .image-upload-container {
        margin-top: 1.5rem;
        border: 2px dashed var(--border-color);
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f9fbfd;
    }
    
    .image-upload-container:hover {
        border-color: var(--primary-color);
        background-color: #f0f6ff;
    }
    
    .image-upload-container i {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }
    
    .image-upload-container p {
        color: var(--text-light);
        margin-top: 0.5rem;
    }
    
    #image-upload-input {
        display: none;
    }
    
    #image-preview-container {
        margin-top: 1.5rem;
        text-align: center;
        position: relative;
    }
    
    #image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .remove-image {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(220, 53, 69, 0.85);
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        font-size: 20px;
        cursor: pointer;
        display: none;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .remove-image:hover {
      background: var(--danger-color);
      transform: scale(1.05);
    }
    
    #response-container {
        margin-top: 2.5rem;
        padding: 1.8rem;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background-color: #fdfdfd;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    #response-container h3 { 
      color: var(--primary-color); 
      border-bottom: 2px solid var(--primary-color); 
      padding-bottom: 0.7rem; 
      margin-top: 0;
      margin-bottom: 1.5rem;
    }
    
    .risk-high {
      background-color: #ffebee;
      border-left: 4px solid var(--risk-high);
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin: 1rem 0;
    }
    
    .risk-medium {
      background-color: #fff8e1;
      border-left: 4px solid var(--risk-medium);
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin: 1rem 0;
    }
    
    .risk-low {
      background-color: #e8f5e9;
      border-left: 4px solid var(--risk-low);
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin: 1rem 0;
    }
    
    .risk-tag {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .risk-tag.high {
      background-color: var(--risk-high);
      color: white;
    }
    
    .risk-tag.medium {
      background-color: var(--risk-medium);
      color: #333;
    }
    
    .risk-tag.low {
      background-color: var(--risk-low);
      color: white;
    }
    
    .notification {
        padding: 1.2rem;
        margin-top: 1.5rem;
        border-radius: 10px;
        text-align: center;
        display: none;
        font-size: 1.05rem;
    }
    
    .notification.error { 
      background-color: #fce8e6; 
      color: #c53929; 
      border: 1px solid #f5c6cb; 
    }
    
    .notification.info { 
      background-color: #e3f2fd; 
      color: #1565c0; 
      border: 1px solid #bbdefb; 
    }
    
    .notification.success { 
      background-color: #e8f5e9; 
      color: #2e7d32; 
      border: 1px solid #c8e6c9; 
    }
    
    #user-info { 
      margin-bottom: 1.5rem; 
      color: #555; 
      font-size: 0.95rem; 
      text-align: center;
      padding: 0.8rem;
      background: #f0f7ff;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    
    .subscription-info {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1.5rem 0;
      text-align: center;
      box-shadow: 0 6px 15px rgba(37, 117, 252, 0.3);
    }
    
    .subscription-info h3 {
      margin-bottom: 1rem;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .subscription-info p {
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
    }
    
    .subscription-info .btn-primary {
      background: white;
      color: var(--primary-color);
      font-weight: bold;
      padding: 0.8rem 2rem;
      border-radius: 50px;
      font-size: 1.1rem;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
    }
    
    .subscription-info .btn-primary:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    
    .usage-counter {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
      margin-left: 10px;
      font-weight: normal;
    }
    
    .analysis-result {
      margin-top: 2rem;
      padding: 1.5rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .analysis-result h3 {
      color: var(--primary-color);
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary-color);
    }
    
    .analysis-section {
      margin-bottom: 1.8rem;
    }
    
    .analysis-section h4 {
      color: #2c3e50;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .analysis-section ul {
      padding-right: 1.5rem;
    }
    
    .analysis-section li {
      margin-bottom: 0.8rem;
      line-height: 1.6;
    }
    
    .medication-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    
    .medication-table th, .medication-table td {
      border: 1px solid var(--border-color);
      padding: 0.8rem;
      text-align: right;
    }
    
    .medication-table th {
      background-color: #f0f7ff;
      font-weight: 600;
    }
    
    .financial-summary {
      background: #f9fbfd;
      border-radius: 10px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      border-left: 4px solid var(--primary-color);
    }
    
    .recommendation-box {
      padding: 1.2rem;
      border-radius: 10px;
      margin: 1.5rem 0;
      background: #e8f5e9;
      border-left: 4px solid var(--success-color);
    }
    
    .pregnancy-section {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #f0f7ff;
      border-radius: 8px;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 1.5rem;
        margin: 1rem auto;
      }
      
      .input-group {
        flex-direction: column;
        gap: 1rem;
      }
      
      .header h2 {
        font-size: 1.5rem;
      }
      
      .form-section {
        padding: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a class="home-link" href="https://www.m2020m.org/portal.html">
      <i class="fas fa-home"></i>
    </a>
    
    <div class="header">
      <h2>نظام تحليل الحالات الطبية - التأمين الطبي</h2>
      <p>أدخل معلومات الحالة للحصول على تحليل مفصل وتوصيات متكاملة</p>
    </div>
    
    <div id="user-info">
      <i class="fas fa-user-circle"></i> 
      <span id="user-email">جاري التحقق من المستخدم...</span>
      <span class="usage-counter">عدد التجارب: <span id="usage-count">0</span>/3</span>
    </div>
    
    <div class="subscription-info" id="subscription-info" style="display:none">
      <h3><i class="fas fa-crown"></i> اشتراك ممتاز</h3>
      <p>لقد استخدمت جميع تجاربك المجانية. قم بالاشتراك الآن للاستمرار في استخدام الخدمة.</p>
      <button class="btn-primary">
        <i class="fas fa-arrow-right"></i> الاشتراك الآن
      </button>
    </div>

    <div class="form-section">
      <h3 class="form-section-title"><i class="fas fa-stethoscope"></i> معلومات الحالة الطبية</h3>
      
      <label for="diagnosis" class="required">التشخيص الطبي (ICD-10):</label>
      <input type="text" id="diagnosis" placeholder="مثال: Z01.0 أو جفاف العين" />
      
      <label for="symptoms" class="required">الأعراض والعلامات السريرية:</label>
      <textarea id="symptoms" placeholder="مثال: غباش في الرؤية، حكة، احمرار"></textarea>
      
      <label for="image-upload-input">رفع صورة المطالبة (اختياري):</label>
     <div class="image-upload-container" id="image-upload-container-click" onclick="document.getElementById('image-upload-input').click();">
  <i class="fas fa-cloud-upload-alt"></i>
  <h4>اضغط هنا لاختيار صورة</h4>
  <p>يُسمح بملفات الصور فقط (JPG, PNG) - الحد الأقصى 5MB</p>

  <!-- ✅ هذا هو السطر المهم الذي كان ناقص -->
<input type="file" id="image-upload-input" accept="image/*,application/pdf" multiple style="display: none;" />
</div>
      <div id="image-preview-container">
        <img id="image-preview" src="#" alt="معاينة الصورة" />
        <button class="remove-image" onclick="removeImage()">×</button>
      </div>
    </div>
    
    <div class="form-section">
      <h3 class="form-section-title"><i class="fas fa-user-injured"></i> معلومات المريض</h3>
      
      <div class="input-group">
        <div class="input-item">
          <label for="age" class="required">عمر المريض:</label>
          <input type="number" id="age" placeholder="مثال: 35" min="1" max="120" />
        </div>
        
        <div class="input-item">
          <label for="gender" class="required">نوع المريض:</label>
          <select id="gender" onchange="togglePregnancyFields()">
            <option value="" disabled selected>اختر...</option>
            <option value="male">ذكر</option>
            <option value="female">أنثى</option>
          </select>
        </div>
        
        <div class="input-item">
          <label for="smoker" class="required">هل المريض مدخن؟</label>
          <select id="smoker">
            <option value="" disabled selected>اختر...</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>
      </div>
      
      <div class="input-group">
        <div class="input-item">
          <label for="height">الطول (سم):</label>
          <input type="number" id="height" placeholder="مثال: 170" min="50" max="250" />
        </div>
        
        <div class="input-item">
          <label for="weight">الوزن (كجم):</label>
          <input type="number" id="weight" placeholder="مثال: 70" min="5" max="300" />
        </div>
      </div>
      
      <div id="pregnancy-section" class="pregnancy-section" style="display: none;">
        <div class="input-group">
          <div class="input-item">
            <label for="pregnant" class="required">هل المريضة حامل؟</label>
            <select id="pregnant" onchange="togglePregnancyMonth()">
              <option value="" selected>اختر...</option>
              <option value="yes">نعم</option>
              <option value="no">لا</option>
            </select>
          </div>
          
          <div class="input-item" id="pregnancy-month-container" style="display:none">
            <label for="pregnancy-month" class="required">شهر الحمل:</label>
            <select id="pregnancy-month">
              <option value="" disabled selected>اختر...</option>
              <option value="1">الشهر الأول</option>
              <option value="2">الشهر الثاني</option>
              <option value="3">الشهر الثالث</option>
              <option value="4">الشهر الرابع</option>
              <option value="5">الشهر الخامس</option>
              <option value="6">الشهر السادس</option>
              <option value="7">الشهر السابع</option>
              <option value="8">الشهر الثامن</option>
              <option value="9">الشهر التاسع</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <h3 class="form-section-title"><i class="fas fa-procedures"></i> الإجراءات الطبية والعلاجية</h3>
      
      <label for="beforeProcedure">الإجراءات قبل التشخيص:</label>
      <textarea id="beforeProcedure" placeholder="أي إجراءات أو أدوية تم اتخاذها قبل التشخيص الحالي"></textarea>
      
      <label for="afterProcedure">الإجراءات والعلاجات بعد التشخيص:</label>
      <textarea id="afterProcedure" placeholder="الأدوية أو الإجراءات التي قام بها الطبيب"></textarea>
    </div>

    <div class="button-group">
        <button id="analyze-btn" onclick="analyzeCase()" class="btn-primary">
          <i class="fas fa-search"></i>
          <span id="analyze-text">تحليل الحالة</span>
          <span id="analyze-spinner" class="spinner" style="display:none"></span>
        </button>
        <button onclick="logout()" class="btn-danger">
          <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </button>
    </div>

    <div id="notification-area"></div>
    <div id="response-container"></div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
      authDomain: "insurance-check-6cec9.firebaseapp.com",
      projectId: "insurance-check-6cec9",
      storageBucket: "insurance-check-6cec9.appspot.com",
      messagingSenderId: "992769471393",
      appId: "1:992769471393:web:c8a9400210a0e7901011e0",
      measurementId: "G-LMS6VRSTT6"
    };

    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getAuth, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // تخزين عدد مرات الاستخدام
    let usageCount = 0;
    const MAX_FREE_USAGE = 3;

    // --- Authentication Logic ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("user-email").textContent = user.email;
        // استرجاع عدد المرات المستخدمة من localStorage
        const savedUsage = localStorage.getItem(`usage_${user.email}`);
        usageCount = savedUsage ? parseInt(savedUsage) : 0;
        document.getElementById("usage-count").textContent = usageCount;
        
        // التحقق من الاشتراك
        checkSubscription(user.email);
      } else {
        window.location.href = "login.html";
      }
    }, (error) => {
      console.error("خطأ في المصادقة:", error);
      document.getElementById("user-info").textContent = "خطأ في التحقق من المستخدم";
      showNotification("error", "حدث خطأ في المصادقة. يرجى تسجيل الدخول مرة أخرى.");
    });

    // التحقق من حالة الاشتراك
function checkSubscription(email) {
  // مؤقتًا: السماح بالتحليل للجميع
  document.getElementById("subscription-info").style.display = "none";
  document.getElementById("analyze-btn").disabled = false;

  // ✅ يمكنك ترك التعليق التالي لتفعيلها لاحقًا
  /*
  if (usageCount >= MAX_FREE_USAGE) {
    document.getElementById("subscription-info").style.display = "block";
    document.getElementById("analyze-btn").disabled = true;
  } else {
    document.getElementById("subscription-info").style.display = "none";
    document.getElementById("analyze-btn").disabled = false;
  }
  */
}
    window.logout = () => {
      signOut(auth).then(() => {
        showNotification("info", "تم تسجيل الخروج بنجاح.");
        setTimeout(() => window.location.href = "login.html", 1500);
      }).catch((error) => {
        showNotification("error", "خطأ في تسجيل الخروج: " + error.message);
      });
    };

    // --- Image Handling ---
    const imageInput = document.getElementById('image-upload-input');
    const imagePreview = document.getElementById('image-preview');
    const removeBtn = document.querySelector('.remove-image');
    
    let imageDataUrl = null;

    imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            // التحقق من نوع الملف
            if (!file.type.match('image.*')) {
                showNotification("error", "الرجاء اختيار ملف صورة فقط (JPG, PNG)");
                return;
            }
            
            // التحقق من حجم الملف (5MB كحد أقصى)
            if (file.size > 5 * 1024 * 1024) {
                showNotification("error", "حجم الصورة كبير جدًا (الحد الأقصى 5MB)");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                removeBtn.style.display = 'block';
                imageDataUrl = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    window.removeImage = () => {
        imageInput.value = '';
        imagePreview.style.display = 'none';
        removeBtn.style.display = 'none';
        imageDataUrl = null;
    }

    // --- Notification Function ---
    function showNotification(type, message) {
        const notificationArea = document.getElementById('notification-area');
        const notificationDiv = document.createElement('div');
        notificationDiv.className = `notification ${type}`;
        notificationDiv.textContent = message;
        
        notificationArea.innerHTML = '';
        notificationArea.appendChild(notificationDiv);
        notificationDiv.style.display = 'block';
        
        // إخفاء الإشعار بعد 5 ثواني
        setTimeout(() => {
            notificationDiv.style.display = 'none';
        }, 5000);
    }

    // --- إدارة حقول الحمل ---
    window.togglePregnancyFields = function() {
      const gender = document.getElementById('gender').value;
      const pregnancySection = document.getElementById('pregnancy-section');
      
      if (gender === 'female') {
        pregnancySection.style.display = 'block';
      } else {
        pregnancySection.style.display = 'none';
        document.getElementById('pregnant').value = '';
        document.getElementById('pregnancy-month').value = '';
        document.getElementById('pregnancy-month-container').style.display = 'none';
      }
    }
    
    window.togglePregnancyMonth = function() {
      const isPregnant = document.getElementById('pregnant').value === 'yes';
      const pregnancyMonthContainer = document.getElementById('pregnancy-month-container');
      
      if (isPregnant) {
        pregnancyMonthContainer.style.display = 'block';
      } else {
        pregnancyMonthContainer.style.display = 'none';
        document.getElementById('pregnancy-month').value = '';
      }
    }

    // --- تحقق من صحة المدخلات ---
    function validateInputs() {
        const diagnosis = document.getElementById('diagnosis').value;
        const symptoms = document.getElementById('symptoms').value;
        const age = document.getElementById('age').value;
        const gender = document.getElementById('gender').value;
        const smoker = document.getElementById('smoker').value;
        
        // التحقق من الحقول الأساسية
        let isValid = true;
        let errorMessage = "";
        
        if (!diagnosis && !symptoms && !imageDataUrl) {
            errorMessage += "الرجاء إدخال التشخيص أو الأعراض أو رفع صورة للمطالبة.<br>";
            isValid = false;
        }
        
        if (!age || age < 1 || age > 120) {
            errorMessage += "الرجاء إدخال عمر صحيح بين 1 و 120 سنة.<br>";
            isValid = false;
        }
        
        if (!gender) {
            errorMessage += "الرجاء تحديد نوع المريض.<br>";
            isValid = false;
        }
        
        if (!smoker) {
            errorMessage += "الرجاء تحديد حالة التدخين.<br>";
            isValid = false;
        }
        
        // التحقق من حقول الحمل إذا كانت المريضة أنثى
        if (gender === 'female') {
          const pregnant = document.getElementById('pregnant').value;
          if (!pregnant) {
            errorMessage += "الرجاء تحديد حالة الحمل.<br>";
            isValid = false;
          }
          
          if (pregnant === 'yes') {
            const pregnancyMonth = document.getElementById('pregnancy-month').value;
            if (!pregnancyMonth) {
              errorMessage += "الرجاء تحديد شهر الحمل.<br>";
              isValid = false;
            }
          }
        }
        
        if (!isValid) {
          showNotification("error", errorMessage);
        }
        
        return isValid;
    }

    // --- Main Analysis Function ---
    async function analyzeCase() {
      const responseContainer = document.getElementById('response-container');
      const notificationArea = document.getElementById('notification-area');
      
      responseContainer.style.display = 'none';
      responseContainer.innerHTML = '';
      notificationArea.innerHTML = '';

      // التحقق من صحة المدخلات
      if (!validateInputs()) return;
      
      // التحقق من عدد المرات
      const user = auth.currentUser;
      if (!user) {
        showNotification("error", "المستخدم غير مسجل الدخول. جاري إعادة التوجيه.");
        setTimeout(() => window.location.href = "login.html", 1500);
        return;
      }
      // مؤقتًا: السماح بالتحليل بدون حد أقصى
/*
if (usageCount >= MAX_FREE_USAGE) {
  showNotification("error", "لقد استنفذت عدد التجارب المجانية. يرجى الاشتراك.");
  return;
}
*/
      // إظهار مؤشر التحميل
      const analyzeBtn = document.getElementById('analyze-btn');
      const analyzeText = document.getElementById('analyze-text');
      const analyzeSpinner = document.getElementById('analyze-spinner');
      
      analyzeBtn.disabled = true;
      analyzeText.textContent = "جارٍ التحليل...";
      analyzeSpinner.style.display = 'inline-block';
      
      showNotification("info", "جاري تحليل الحالة، قد يستغرق الأمر بعض الوقت...");

      try {
        // جمع البيانات من النموذج
        const diagnosis = document.getElementById('diagnosis').value;
        const symptoms = document.getElementById('symptoms').value;
        const age = document.getElementById('age').value;
        const gender = document.getElementById('gender').value;
        const smoker = document.getElementById('smoker').value === 'yes';
        const beforeProcedure = document.getElementById('beforeProcedure').value;
        const afterProcedure = document.getElementById('afterProcedure').value;
        const height = document.getElementById('height').value;
        const weight = document.getElementById('weight').value;
        const pregnant = document.getElementById('pregnant')?.value;
        const pregnancyMonth = document.getElementById('pregnancy-month')?.value;
        
        // محاكاة التحليل
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // توليد تقرير التحليل
        const htmlReport = generateAnalysisReport(
          diagnosis, symptoms, age, gender, smoker, 
          beforeProcedure, afterProcedure, height, weight,
          pregnant, pregnancyMonth
        );
        
        // عرض النتيجة
        responseContainer.innerHTML = htmlReport;
        responseContainer.style.display = 'block';
        
        // تحديث عدد الاستخدامات
        usageCount++;
        localStorage.setItem(`usage_${user.email}`, usageCount);
        document.getElementById("usage-count").textContent = usageCount;
        checkSubscription(user.email);
        
        showNotification("success", "تم تحليل الحالة بنجاح!");

      } catch (err) {
        showNotification("error", "حدث خطأ أثناء التحليل: " + err.message);
        console.error(err);
      } finally {
        // إعادة تعيين حالة الزر
        analyzeBtn.disabled = false;
        analyzeText.textContent = "تحليل الحالة";
        analyzeSpinner.style.display = 'none';
      }
    }

    // توليد تقرير التحليل (محاكاة)
    function generateAnalysisReport(diagnosis, symptoms, age, gender, smoker, 
                                    beforeProcedure, afterProcedure, height, weight,
                                    pregnant, pregnancyMonth) {
      return `
        <div class="analysis-result">
          <h3><i class="fas fa-file-medical"></i> تقرير تحليل الحالة الطبية</h3>
          
          <div class="analysis-section">
            <h4><i class="fas fa-clipboard-check"></i> ملخص الحالة</h4>
            <p>تم تحليل الحالة بنجاح بناءً على المعلومات المقدمة:</p>
            <ul>
              <li><strong>التشخيص:</strong> ${diagnosis || "غير محدد"}</li>
              <li><strong>الأعراض:</strong> ${symptoms || "غير محددة"}</li>
              <li><strong>عمر المريض:</strong> ${age} سنة</li>
              <li><strong>نوع المريض:</strong> ${gender === 'male' ? 'ذكر' : 'أنثى'}</li>
              <li><strong>حالة التدخين:</strong> ${smoker ? 'مدخن' : 'غير مدخن'}</li>
              <li><strong>الطول:</strong> ${height || "غير محدد"} سم</li>
              <li><strong>الوزن:</strong> ${weight || "غير محدد"} كجم</li>
              ${gender === 'female' ? `<li><strong>حالة الحمل:</strong> ${pregnant === 'yes' ? `حامل في الشهر ${pregnancyMonth}` : 'غير حامل'}</li>` : ''}
            </ul>
          </div>
          
          <div class="analysis-section">
            <h4><i class="fas fa-pills"></i> تحليل الإجراءات الطبية والأدوية</h4>
            
            <div class="risk-high">
              <span class="risk-tag high">خطورة عالية</span>
              <p><strong>الدواء: سيمفاستاتين</strong> - الجرعة: 80 ملغ يومياً</p>
              <p>التحليل: هذه الجرعة عالية جداً وقد تسبب تلفاً في العضلات، خاصة للمرضى فوق 65 سنة. 
              يوصى بتخفيض الجرعة إلى 40 ملغ كحد أقصى أو استبدالها بدواء بديل.</p>
            </div>
            
            <div class="risk-medium">
              <span class="risk-tag medium">خطورة متوسطة</span>
              <p><strong>الإجراء: تنظير المعدة</strong></p>
              <p>التحليل: الإجراء مبرر طبياً ولكن يلزم تقديم تقرير مفصل عن النتائج لتجنب رفض التأمين.</p>
            </div>
            
            <div class="risk-low">
              <span class="risk-tag low">خطورة منخفضة</span>
              <p><strong>الدواء: أوميبرازول</strong> - الجرعة: 20 ملغ يومياً</p>
              <p>التحليل: الجرعة مناسبة للحالة ولا توجد مشاكل في التفاعلات الدوائية.</p>
            </div>
          </div>
          
          <div class="analysis-section">
            <h4><i class="fas fa-exclamation-triangle"></i> تقييم المخاطر واحتمالية الرفض</h4>
            <ul>
              <li>هناك خطر مرتفع لرفض دواء السيمفاستاتين بسبب الجرعة العالية (قيمة الرفض: 250 ريال)</li>
              <li>فحوصات الدم المطلوبة غير مكتملة مما قد يؤدي إلى رفض جزئي للفاتورة</li>
              <li>الإجراءات العلاجية بشكل عام مبررة طبياً ما عدا بعض التفاصيل الصغيرة</li>
            </ul>
          </div>
          
          <div class="financial-summary">
            <h4><i class="fas fa-chart-line"></i> المؤشر المالي</h4>
            <table class="medication-table">
              <thead>
                <tr>
                  <th>البند</th>
                  <th>القيمة (ريال سعودي)</th>
                  <th>التقييم</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>إجمالي الفاتورة الحالية</td>
                  <td>1,850</td>
                  <td>قيمة مقبولة</td>
                </tr>
                <tr>
                  <td>الخصومات المحتملة</td>
                  <td>320</td>
                  <td>مرتفعة بسبب الأدوية غير المبررة</td>
                </tr>
                <tr>
                  <td>قيمة الفاتورة بعد الخصومات</td>
                  <td>1,530</td>
                  <td>مقبولة مع التحسينات</td>
                </tr>
                <tr>
                  <td>القيمة القابلة للإضافة</td>
                  <td>420</td>
                  <td>بإجراء فحوصات إضافية مبررة</td>
                </tr>
                <tr>
                  <td>إجمالي الفاتورة بعد التحسين</td>
                  <td>1,950</td>
                  <td>قيمة مثالية مع تقليل المخاطر</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="analysis-section">
            <h4><i class="fas fa-lightbulb"></i> توصيات لتحسين الفاتورة وزيادة الدخل</h4>
            <div class="recommendation-box">
              <p>للحصول على فاتورة مثالية وتجنب الرفض من التأمين:</p>
              <ul>
                <li>إجراء فحص وظائف الكلى والكبد قبل صرف الأدوية ذات الخطورة العالية</li>
                <li>إضافة استشارة أخصائي تغذية لتحسين نتائج العلاج</li>
                <li>استبدال دواء السيمفاستاتين ببديل أكثر أماناً مثل أتورفاستاتين</li>
                <li>إرفاق تقرير مفصل عن نتائج تنظير المعدة</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    window.analyzeCase = analyzeCase;
    window.togglePregnancyFields = togglePregnancyFields;
    window.togglePregnancyMonth = togglePregnancyMonth;
    window.removeImage = removeImage;
  </script>
</body>
</html>
