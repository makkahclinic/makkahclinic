<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نموذج تقييم الحالة الطبية - التأمين الطبي</title>

  <!-- ====== التنسيق ====== -->
  <style>
    :root{--primary:#0056b3;--secondary:#dc3545;--bg:#f4f7f9;--text:#333;--card:#fff;--border:#e0e0e0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:1rem}
    .home-icon-link{position:absolute;top:25px;right:30px;z-index:1000}
    .home-icon-link svg{width:32px;height:32px;fill:var(--primary);transition:opacity .3s}
    .home-icon-link:hover svg{opacity:.7}
    .container{max-width:900px;margin:2rem auto;background:var(--card);padding:2rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    h2{text-align:center;color:var(--primary);margin-bottom:2rem}
    label{font-weight:600;display:block;margin:1.5rem 0 .5rem}
    textarea,input,select{width:100%;padding:.8rem 1rem;font-size:1rem;border:1px solid var(--border);border-radius:8px;box-sizing:border-box;transition:border-color .3s,box-shadow .3s}
    textarea:focus,input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,86,179,.2)}
    textarea{min-height:100px;resize:vertical}
    .button-group{display:grid;gap:1rem;margin-top:2rem}
    button{padding:1rem;font-size:1.1rem;font-weight:bold;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:background-color .3s,transform .1s}
    button:active{transform:scale(.98)}
    .btn-primary{background:var(--primary)}.btn-primary:hover{background:#004494}
    .btn-danger{background:var(--secondary)}.btn-danger:hover{background:#c82333}
    /* رفع الملفات */
    .file-upload-container{margin-top:1.5rem;border:2px dashed var(--border);border-radius:8px;padding:1.5rem;text-align:center;cursor:pointer;transition:border-color .3s,background .3s}
    .file-upload-container:hover{border-color:var(--primary);background:#f8f9fa}
    #file-upload-input{display:none}
    #preview-wrapper{display:flex;flex-wrap:wrap;gap:1rem;margin-top:1rem}
    .preview-thumb{width:120px;height:120px;object-fit:cover;border:1px solid var(--border);border-radius:6px}
    .preview-pdf{display:flex;align-items:center;justify-content:center;width:120px;height:120px;border:1px solid var(--border);border-radius:6px;background:#fafafa;font-size:.85rem}
    /* إشعارات */
    .notification{padding:1rem;margin-top:1rem;border-radius:8px;text-align:center;display:none}
    .notification.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .notification.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    /* التقرير */
    #response-container{margin-top:2rem;padding:1.5rem;border:1px solid var(--border);border-radius:8px;background:#fdfdfd;display:none}
    #response-container h3{color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:.5rem;margin-top:0}
  </style>
</head>
<body>
  <a href="https://www.m2020m.org/portal.html" class="home-icon-link" title="الرجوع إلى البوابة">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
  </a>

  <div class="container">
    <h2>نموذج تقييم الحالة الطبية - التأمين الطبي</h2>
    <div id="user-info">جاري التحقق من المستخدم...</div>

    <!-- البيانات النصية -->
    <label for="diagnosis">تشخيص المرض (ICD‑10):</label>
    <input type="text" id="diagnosis" placeholder="مثال: Z01.0 أو جفاف العين" />

    <label for="symptoms">الأعراض:</label>
    <textarea id="symptoms" placeholder="غباش، حكة، احمرار"></textarea>

    <!-- رفع عدة ملفات -->
    <label>رفع صور أو ملفات PDF (اختياري):</label>
    <div class="file-upload-container" onclick="document.getElementById('file-upload-input').click();">
      اضغط لاختيار ملفات
      <input type="file" id="file-upload-input" accept="image/*,application/pdf" multiple>
    </div>
    <div id="preview-wrapper"></div>

    <!-- بيانات إضافية -->
    <label for="age">عمر المريض:</label>
    <input type="number" id="age" placeholder="مثال: 35" />

    <label for="gender">نوع المريض:</label>
    <select id="gender">
      <option value="" disabled selected>اختر...</option>
      <option value="male">ذكر</option>
      <option value="female">أنثى</option>
    </select>

    <label for="smoker">هل المريض مدخن؟</label>
    <select id="smoker">
      <option value="" disabled selected>اختر...</option>
      <option value="yes">نعم</option>
      <option value="no">لا</option>
    </select>

    <label for="beforeProcedure">إجراءات قبل التشخيص:</label>
    <textarea id="beforeProcedure"></textarea>

    <label for="afterProcedure">إجراءات بعد التشخيص:</label>
    <textarea id="afterProcedure"></textarea>

    <!-- الأزرار -->
    <div class="button-group">
      <button class="btn-primary" onclick="analyzeCase()">تحليل الحالة</button>
      <button class="btn-danger"   onclick="logout()">تسجيل الخروج</button>
    </div>

    <!-- الإشعارات والتقرير -->
    <div id="notification-area"></div>
    <div id="response-container"></div>
  </div>

  <!-- ====== البرمجة ====== -->
  <script type="module">
    /* Firebase */
    const firebaseConfig = { apiKey:"AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",authDomain:"insurance-check-6cec9.firebaseapp.com",projectId:"insurance-check-6cec9",storageBucket:"insurance-check-6cec9.appspot.com",messagingSenderId:"992769471393",appId:"1:992769471393:web:c8a9400210a0e7901011e0",measurementId:"G-LMS6VRSTT6" };
    const { initializeApp }  = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getAuth, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth,user=>{
      document.getElementById("user-info").textContent =
        user ? `مرحبًا ${user.email}` : (location.href="http://www.m2020m.org/login.html");
    });
    window.logout = ()=>signOut(auth).then(()=>{
      showNotification("info","تم تسجيل الخروج بنجاح.");
      setTimeout(()=>location.href="http://www.m2020m.org/login.html",1500);
    });

    /* تخزين الملفات */
    let uploadedFiles = [];   // [{data,mime_type,filename}]
    const fileInput = document.getElementById("file-upload-input");
    const preview   = document.getElementById("preview-wrapper");

    /* أداة تحويل ملف إلى Base64 */
    const fileToBase64 = (file)=> new Promise((resolve,rej)=>{
      const reader = new FileReader();
      reader.onload = e=>resolve(e.target.result);
      reader.onerror= rej;
      reader.readAsDataURL(file);
    });

    fileInput.addEventListener("change",async e=>{
      preview.innerHTML="";           // مسح المعاينات السابقة
      uploadedFiles = [];             // إعادة الضبط
      const files = Array.from(e.target.files).slice(0,10);  // حد أقصى 10
      for (const f of files){
        const b64 = await fileToBase64(f);
        uploadedFiles.push({ data:b64.split(",")[1], mime_type:f.type, filename:f.name });

        /* معاينة */
        if(f.type.startsWith("image/")){
          const img=document.createElement("img");
          img.src = b64;
          img.className="preview-thumb";
          preview.appendChild(img);
        }else if(f.type==="application/pdf"){
          const div=document.createElement("div");
          div.className="preview-pdf";
          div.textContent = f.name.split(".").slice(0,-1).join(".");
          preview.appendChild(div);
        }
      }
    });

    /* إشعارات */
    function showNotification(type,msg){
      const area=document.getElementById("notification-area");
      area.innerHTML="";
      const div=document.createElement("div");
      div.className=`notification ${type}`;
      div.textContent=msg;
      area.appendChild(div);
      div.style.display="block";
    }

    /* إرسال البيانات */
    async function analyzeCase(){
      const diagnosis=document.getElementById("diagnosis").value;
      const symptoms =document.getElementById("symptoms").value;
      const age      =document.getElementById("age").value;
      const gender   =document.getElementById("gender").value;
      const smoker   =document.getElementById("smoker").value==="yes";
      const beforeProcedure=document.getElementById("beforeProcedure").value;
      const afterProcedure =document.getElementById("afterProcedure").value;

      const responseBox=document.getElementById("response-container");
      document.getElementById("notification-area").innerHTML="";
      responseBox.style.display="none"; responseBox.innerHTML="";

      if(!diagnosis && !symptoms && uploadedFiles.length===0){
        showNotification("error","الرجاء ملء الحقول أو رفع ملفات.");
        return;
      }
      showNotification("info","جاري التحليل، يرجى الانتظار...");

      try{
        if(!auth.currentUser) throw new Error("المستخدم غير مسجل.");
        const token=await auth.currentUser.getIdToken();

        const body={ diagnosis,symptoms,age,gender,smoker,beforeProcedure,afterProcedure,
                     userEmail:auth.currentUser.email, imageData:uploadedFiles };

        const res = await fetch("/api/gpt",{method:"POST",
          headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${token}` },
          body:JSON.stringify(body)
        });

        if(!res.ok) throw new Error((await res.json()).detail||`خطأ: ${res.status}`);
        const json=await res.json();
        if(json.htmlReport){
          responseBox.innerHTML=json.htmlReport;
          responseBox.style.display="block";
          document.getElementById("notification-area").innerHTML="";
        }else throw new Error("لم يصل تقرير من الخادم.");
      }catch(err){
        showNotification("error","حدث خطأ: "+err.message);
        console.error(err);
      }
    }
    window.analyzeCase = analyzeCase;
  </script>
</body>
</html>
