// pages/api/gpt.js
// الإصدار النهائي باستخدام FormData و Formidable لمعالجة الملفات بشكل آمن

import { formidable } from 'formidable';
import fs from 'fs';

// --- دوال المساعدة (Utils) ---
// (نفس دوال المساعدة السابقة: fetchWithRetry, detectMimeFromB64, geminiUpload, nowIso, sleep)
// ... تأكد من وجودها هنا ...

// --- الأمر الرئيسي (System Prompt) - نسخة موجزة ومستقرة ---
const systemInstruction = `
أنت خبير تدقيق طبي، مهمتك إنشاء تقرير بصيغة HTML بسيطة ومنظمة.
يجب أن يحتوي التقرير على الأقسام التالية بالترتيب وباستخدام الوسوم المحددة:
1.  \`<h4>ملخص الحالة</h4>\` مع فقرة \`<p>\`.
2.  \`<h4>تحليل الملفات المرفوعة</h4>\` مع فقرة \`<p>\`.
3.  \`<h4>التحليل السريري العميق</h4>\` مع فقرة \`<p>\`.
4.  \`<h4>جدول الأدوية والإجراءات</h4>\` مع جدول \`<table>\` يحتوي على الأعمدة: "بند الخدمة" و "قرار التأمين".
    - لكل خدمة، أنشئ صف \`<tr>\` واحد.
    - لقرار التأمين، استخدم \`<span>\` مع الكلاس المناسب ('status-green', 'status-yellow', 'status-red') واذكر السبب بوضوح للحالات الصفراء والحمراء.
5.  \`<h4>التحليل التفصيلي والتوصيات</h4>\` وبداخله العناوين الفرعية \`<h5>\` المرقمة (1. خدمات طبية ضرورية... إلخ) مع فقرة \`<p>\` لكل منها.
    - يجب أن يكون تحليلك عميقاً ومدعوماً بالأدلة.
6.  \`<h5>5. الخاتمة والتوصيات النهائية</h5>\` مع فقرة \`<p>\`.
7.  فقرة أخيرة تحتوي على التنويه القانوني.

التزم بهذا الهيكل البسيط والنظيف. لا تقم بإضافة أي تنسيقات CSS أو \`<style>\` أو \`<html>\` أو \`<body>\`.
`;

// --- المعالج الرئيسي للطلب (API Handler) ---
export const config = {
    api: {
        bodyParser: false, // مهم جداً: تعطيل body parser الافتراضي
    },
};

export default async function handler(req, res) {
    if (req.method !== 'POST') {
        res.setHeader('Allow', ['POST']);
        return res.status(405).end(`Method ${req.method} Not Allowed`);
    }

    const geminiKey = process.env.GEMINI_API_KEY;
    if (!geminiKey) {
        return res.status(500).json({ ok: false, detail: "GEMINI_API_KEY is not configured." });
    }

    try {
        const data = await new Promise((resolve, reject) => {
            const form = formidable({});
            form.parse(req, (err, fields, files) => {
                if (err) reject(err);
                resolve({ fields, files });
            });
        });

        const { fields, files } = data;
        
        // تحويل البيانات النصية من مصفوفات إلى سلاسل نصية
        const body = {};
        for (const key in fields) {
            body[key] = Array.isArray(fields[key]) ? fields[key][0] : fields[key];
        }

        const uploadedFiles = files.files || [];

        // تجهيز الملفات لـ Gemini
        const filePartsPromises = (Array.isArray(uploadedFiles) ? uploadedFiles : [uploadedFiles]).map(async (file) => {
            try {
                const fileContent = fs.readFileSync(file.filepath);
                const base64Data = fileContent.toString('base64');
                const uri = await geminiUpload(geminiKey, base64Data, file.mimetype);
                return uri ? { fileData: { mimeType: file.mimetype, fileUri: uri } } : null;
            } catch (e) {
                console.warn(`File processing failed for ${file.originalFilename}:`, e.message);
                return null;
            }
        });

        const processedFileParts = (await Promise.all(filePartsPromises)).filter(Boolean);

        const userPrompt = `
        Please analyze the following medical case.
        **--- Patient Data ---**
        - **Age:** ${body.age || 'Not specified'}
        - **Gender:** ${body.gender || 'Not specified'}
        - **Is Pregnant?:** ${body.isPregnant === 'true' ? `Yes, ${body.pregnancyMonth || 'N/A'} months` : 'No'}
        - **Smoker:** ${body.isSmoker === 'true' ? `Yes (Pack-Years: ${body.packYears || 'N/A'})` : 'No'}
        - **Has Visual Symptoms?:** ${body.visualSymptoms === 'yes' ? `Yes (Last Exam: ${body.lastEyeExamDate || 'N/A'}, Acuity: ${body.visualAcuity || 'N/A'})` : 'No'}
        - **Cough Duration:** ${body.coughDurationWeeks ? `${body.coughDurationWeeks} weeks` : 'N/A'}
        **--- Clinical Notes & Details from Doctor ---**
        ${body.notes || "No additional notes provided."}
        **--- Attached Files ---**
        ${processedFileParts.length > 0 ? `${processedFileParts.length} files are attached.` : "No files were attached."}
        Please begin your detailed analysis now.
        `;
        
        const parts = [{ text: userPrompt }, ...processedFileParts];
        const htmlReport = await geminiGenerate(geminiKey, parts);

        return res.status(200).json({ ok: true, htmlReport });

    } catch (err) {
        console.error("--- SERVER ERROR ---", err);
        return res.status(500).json({
            ok: false,
            error: "An internal server error occurred.",
            detail: err.message,
        });
    }
}
