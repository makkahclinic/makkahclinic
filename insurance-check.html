<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial,sans-serif; margin:24px;}
  h1{margin-bottom:6px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .col{flex:1 1 280px}
  textarea, select, input[type="text"]{width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px}
  input[type="file"]{padding:8px}
  button{padding:10px 16px; border:0; border-radius:8px; background:#0b6; color:#fff; cursor:pointer; font-weight:600}
  button.secondary{background:#345}
  button:disabled{opacity:.5; cursor:not-allowed}
  .panel{border:1px solid #eee; border-radius:12px; padding:14px; margin:16px 0}
  .muted{color:#666; font-size:13px}
  .log{background:#0b1020; color:#d6e7ff; border-radius:10px; padding:12px; min-height:90px; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef; margin-inline-start:8px; font-size:12px}
  .section-title{display:flex; align-items:center; justify-content:space-between}
  .jsonbox{background:#f8fafc; border:1px dashed #cbd5e1; border-radius:10px; padding:10px; min-height:70px; white-space:pre-wrap; font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
<!-- PDF.js (UMD) + Worker: إصلاح "pdfjsLib is not defined" -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.20/pdf.min.js" integrity="sha512-0oU5ZTW1kCqRjzLfgF9x0xk1KQycs7dC3zIYd2J8T1m+8nW0B8oYz5hZl0qkM6hQmWfW9w3vn2nYc0m3E0uZSQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  // عيّن مسار العامل (الويركر) قبل الاستعمال
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.20/pdf.worker.min.js";
</script>
</head>
<body>
  <h1>تحليل الحالات الطبية <small class="badge">Gemini & GPT‑4o</small></h1>
  <div class="muted">* تتم معالجة PDF إلى صور + نص محليًا (PDF.js) وتُزال PHI على الخادم. * التقرير تعليمي ويُراجع سريريًا قبل أي قرار.</div>

  <div class="panel">
    <div class="row">
      <div class="col">
        <label>اختر ملفات (صورة/‏PDF):</label>
        <input id="files" type="file" multiple accept="image/*,.pdf" />
        <div id="prepStatus" class="muted"></div>
      </div>
      <div class="col">
        <label>اللغة:</label>
        <select id="lang">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
      </div>
      <div class="col">
        <label>النموذج:</label>
        <select id="modelSel">
          <option value="both" selected>Gemini + GPT‑4o</option>
          <option value="gpt">GPT‑4o فقط</option>
          <option value="gemini">Gemini فقط</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>التخصص (اختياري):</label>
        <input id="spec" type="text" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
      </div>
      <div class="col">
        <label>وصف مختصر/سياق التأمين (اختياري):</label>
        <input id="ctx" type="text" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="btnPrep" class="secondary">تحضير الملفات</button>
      <button id="btnGo">تحليل الحالة</button>
      <span id="apiV" class="muted">API Version: v6.1</span>
    </div>
  </div>

  <div class="panel">
    <div class="section-title"><strong>النتيجة المدمجة</strong>
      <button id="copyCombined" class="secondary" style="padding:6px 10px">نسخ JSON</button>
    </div>
    <div id="combined" class="jsonbox"></div>
  </div>

  <div class="panel">
    <strong>مخرجات GPT‑4o</strong>
    <div id="gptOut" class="jsonbox"></div>
  </div>

  <div class="panel">
    <strong>مخرجات Gemini</strong>
    <div id="gemOut" class="jsonbox"></div>
  </div>

  <div class="panel">
    <strong>السجل</strong>
    <div id="log" class="log"></div>
  </div>

<script>
(() => {
  const logEl = document.getElementById('log');
  const filesEl = document.getElementById('files');
  const btnPrep = document.getElementById('btnPrep');
  const btnGo = document.getElementById('btnGo');
  const prepStatus = document.getElementById('prepStatus');
  const combinedEl = document.getElementById('combined');
  const gptEl = document.getElementById('gptOut');
  const gemEl = document.getElementById('gemOut');
  const copyCombined = document.getElementById('copyCombined');

  let prepared = { images: [], texts: "" }; // images: [{dataUrl, contentType}], texts: string
  const MAX_PAGES = 2;       // يمكن زيادتها لكن احذر حجم الطلب على Vercel
  const MAX_DIM = 1400;      // أقصى بُعد للصورة (ضغط)
  const JPEG_QUALITY = 0.78; // ضغط الصور

  function log(msg){ logEl.textContent += (msg + "\n"); logEl.scrollTop = logEl.scrollHeight; }
  function toast(msg){ alert(msg); }

  function toDataURLFromImageFile(file){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      const reader = new FileReader();
      reader.onload = () => {
        img.onload = () => {
          const { width, height } = img;
          const scale = Math.min(1, MAX_DIM/Math.max(width,height));
          const w = Math.round(width*scale), h = Math.round(height*scale);
          const can = document.createElement('canvas'); can.width=w; can.height=h;
          const ctx = can.getContext('2d'); ctx.drawImage(img,0,0,w,h);
          // نستخدم JPEG عادة لتقليل الحجم – لو أردت PNG غيّر النوع
          const dataUrl = can.toDataURL('image/jpeg', JPEG_QUALITY);
          resolve({ dataUrl, contentType: 'image/jpeg' });
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function pdfToImagesAndText(file){
    const arr = new Uint8Array(await file.arrayBuffer());
    const pdf = await pdfjsLib.getDocument({ data: arr }).promise;
    let outImgs = [];
    let textsAll = [];
    const pages = Math.min(pdf.numPages, MAX_PAGES);
    for(let i=1;i<=pages;i++){
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 1.7 }); // دقة أعلى قليلاً
      const can = document.createElement('canvas');
      can.width = viewport.width; can.height = viewport.height;
      const ctx = can.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;
      // ضغط إلى JPEG لتقليل الحجم
      const dataUrl = can.toDataURL('image/jpeg', JPEG_QUALITY);
      outImgs.push({ dataUrl, contentType: 'image/jpeg' });
      // استخراج نص
      const textContent = await page.getTextContent();
      const text = textContent.items.map(it => it.str).join(' ').replace(/\s+/g,' ').trim();
      textsAll.push(`(صفحة ${i}) ${text}`);
    }
    return { images: outImgs, text: textsAll.join('\n') };
  }

  btnPrep.addEventListener('click', async () => {
    try{
      combinedEl.textContent = gptEl.textContent = gemEl.textContent = '';
      prepared = { images: [], texts: "" };
      const files = Array.from(filesEl.files || []);
      if(!files.length){ toast('اختر ملفًا واحدًا على الأقل'); return; }
      log('بدء التحضير ... < تحويل PDF واستخراج نص (إن وجد)');
      let total = 0;
      for(const f of files){
        if(f.type === 'application/pdf' || /\.pdf$/i.test(f.name)){
          const { images, text } = await pdfToImagesAndText(f);
          prepared.images.push(...images);
          prepared.texts += (text ? (text + '\n') : '');
          total += images.length;
          log(`✓ رُفعت ${images.length}/${images.length} صفحة من ${f.name}`);
        }else if(f.type.startsWith('image/')){
          prepared.images.push(await toDataURLFromImageFile(f));
          total += 1;
          log(`✓ جُهِّزت صورة: ${f.name}`);
        }else{
          log(`تخطي ملف غير مدعوم: ${f.name}`);
        }
      }
      prepStatus.textContent = `تم تجهيز ${total} صورة/صفحة + نص PDF للتحليل.`;
    }catch(err){
      console.error(err);
      toast('فشل التحضير: ' + (err && err.message ? err.message : err));
    }
  });

  btnGo.addEventListener('click', async () => {
    try{
      btnGo.disabled = true;
      log('بدء التحليل ...');
      const payload = {
        language: document.getElementById('lang').value,
        modelChoice: document.getElementById('modelSel').value,
        specialty: document.getElementById('spec').value || 'عام',
        insuranceContext: document.getElementById('ctx').value || '',
        images: prepared.images,  // [{dataUrl, contentType}]
        texts: prepared.texts || ''
      };
      if((payload.images?.length||0)===0 && !payload.texts){
        toast('لم يتم تجهيز أي صور أو نص. اضغط "تحضير الملفات" أولاً.');
        btnGo.disabled = false; return;
      }
      const res = await fetch('/api/case-analyzer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok){ throw new Error(data?.error || res.statusText); }
      combinedEl.textContent = JSON.stringify(data.combined, null, 2);
      gptEl.textContent      = data.gpt?.error ? ('[Error] ' + data.gpt.error) : JSON.stringify(data.gpt?.parsed || data.gpt?.raw || {}, null, 2);
      gemEl.textContent      = data.gemini?.error ? ('[Error] ' + data.gemini.error) : JSON.stringify(data.gemini?.parsed || data.gemini?.raw || {}, null, 2);
      log('اكتمل التحليل.');
      btnGo.disabled = false;
    }catch(err){
      console.error(err);
      toast('فشل التحليل: ' + (err && err.message ? err.message : err));
      btnGo.disabled = false;
    }
  });

  copyCombined.addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(combinedEl.textContent || '');
      toast('تم النسخ');
    }catch{ /* no-op */ }
  });
})();
</script>
</body>
</html>
