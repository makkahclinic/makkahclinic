<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تقييم الحالة الطبية وطلبات التأمين</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{--primary-600:#0284c7;--primary-700:#0369a1;--primary-800:#075985;--gray-50:#f8fafc;--gray-100:#f1f5f9;--gray-200:#e2e8f0;--gray-300:#cbd5e1;--gray-500:#64748b;--gray-700:#334155;--gray-900:#0f172a}
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;background:var(--gray-50);color:var(--gray-900);margin:0}
    .container{max-width:1100px;margin:24px auto;padding:24px;background:#fff;border:1px solid var(--gray-200);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:20px}
    .home-link{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:var(--primary-600);color:#fff;border-radius:12px;text-decoration:none;font-weight:600}
    .home-link:hover{background:var(--primary-700)}
    .chip{display:inline-flex;align-items:center;padding:6px 14px;border-radius:9999px;background:var(--gray-100);color:#475569;font-size:14px;font-weight:500;cursor:pointer}
    h1.main-title{font-size:32px;text-align:center;color:var(--primary-800);margin:0 0 8px}
    p.subtitle{font-size:15px;color:var(--gray-500);text-align:center;margin:0 0 24px}
    .banner{display:flex;gap:12px;padding:16px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;color:#0c4a6e;margin-bottom:24px}
    .section{margin-top:24px}
    .section-title{font-size:20px;color:#075985;display:flex;align-items:center;gap:10px;margin:0 0 16px}
    .card{padding:24px;border-radius:16px;border:1px solid var(--gray-200);background:#f8fafc}
    .grid{display:grid;gap:20px;grid-template-columns:repeat(1,1fr)}
    @media(min-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
    label{display:block;font-size:15px;color:#334155;font-weight:500;margin-bottom:8px}
    input,select,textarea{width:100%;padding:14px;border:1px solid var(--gray-300);border-radius:12px;background:#fff;font-size:15px;color:#111827;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#38bdf8;box-shadow:0 0 0 4px #93c5fd}
    textarea{min-height:100px;resize:vertical}
    .uploader{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;border:2px dashed #7dd3fc;border-radius:16px;background:#eff6ff;color:#075985;font-weight:500;cursor:pointer}
    .file-cards{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));margin-top:16px}
    .file-card{position:relative;background:#fff;border:1px solid var(--gray-200);border-radius:14px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    .file-thumb{width:100%;height:140px;object-fit:cover;background:#f1f5f9}
    .file-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .remove-btn{position:absolute;top:8px;right:8px;width:32px;height:32px;border-radius:50%;background:#ef4444;color:#fff;border:none;font-weight:700;font-size:16px;cursor:pointer}
    .btn{border:none;cursor:pointer;padding:14px 24px;border-radius:12px;font-weight:700}
    .btn-primary{background:#0284c7;color:#fff}.btn-primary:hover{background:#0369a1}
    .btn-outline{background:#fff;color:#111827;border:1px solid var(--gray-300)}
    .busy-text{color:#64748b;font-size:14px}
    .report-wrap{margin-top:32px;display:none}
    .report-content{width:100%;max-width:850px;margin:0 auto;padding:24px;border:1px solid var(--gray-200);border-radius:16px;background:#fff}
    .audit-table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:14px}
    .audit-table th,.audit-table td{padding:12px;text-align:right;border-bottom:1px solid #e5e7eb;vertical-align:top;word-wrap:break-word}
    .audit-table th{background:#f8fafc}
    .risk-critical td{background:#fce8e6}.risk-warning td{background:#fff0e1}.risk-ok td{background:#e6f4ea}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="home-link" href="https://www.m2020m.org/portal.html" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>الصفحة الرئيسية</span>
      </a>
      <span class="chip" id="lang-switcher">English</span>
      <button class="btn btn-outline" id="newCaseBtn" title="ابدأ حالة جديدة">حالة جديدة</button>
    </div>

    <h1 class="main-title">تقييم الحالة الطبية وطلبات التأمين</h1>
    <p class="subtitle">واجهة إدخال سريرية — تحليل عميق + توصيات إكلينيكية + جدول تأميني</p>

    <div class="banner">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2 1 21h22L12 2Zm1 15h-2v-2h2v2Zm0-4h-2V8h2v5Z"/></svg>
      يعتمد التحليل على نماذج ذكاء اصطناعي خادمية معزولة لكل حالة (Case Isolation) لضمان عدم امتزاج النتائج.
    </div>

    <!-- 1) معلومات المريض -->
    <div class="section">
      <h2 class="section-title">1) معلومات المريض</h2>
      <div class="card">
        <div class="grid">
          <div><label>الاسم (اختياري)</label><input id="name" placeholder="مثال: أحمد خالد" /></div>
          <div><label>الجنس</label><select id="gender"><option value="">اختر</option><option value="ذكر">ذكر</option><option value="أنثى">أنثى</option></select></div>
          <div><label>العمر (بالسنوات)</label><input id="age" type="number" min="0" placeholder="مثال: 63"/></div>
          <div><label>هل المريضة حامل؟</label><select id="pregnant"><option value="no">لا</option><option value="yes">نعم</option><option value="na">غير منطبق</option></select></div>
          <div><label>شهر الحمل (إن وُجد)</label><input id="pregnancyMonths" type="number" min="1" max="10" placeholder="مثال: 5" /></div>
          <div><label>هل المريض مدخّن؟</label><select id="smoking"><option value="">اختر</option><option value="مدخن">مدخن</option><option value="غير مدخن">غير مدخن</option><option value="سابق">سابق</option></select></div>
          <div><label>Pack‑Years (إن وُجد)</label><input id="packYears" type="number" min="0" step="0.5" placeholder="مثال: 15" /></div>
          <div><label>الوزن (كجم)</label><input id="weight" type="number" step="0.1" placeholder="مثال: 78" /></div>
          <div><label>الطول (سم)</label><input id="height" type="number" step="0.5" placeholder="مثال: 172" /></div>
          <div><label>درجة الحرارة (°م)</label><input id="temp" type="number" step="0.1" placeholder="مثال: 37.4" /></div>
          <div><label>هل يوجد سُعال؟</label><select id="hasCough"><option value="">اختر</option><option>نعم</option><option>لا</option></select></div>
          <div><label>مدة السعال (أسابيع)</label><input id="coughWeeks" type="number" min="0" placeholder="مثال: 12" /></div>
          <div><label>نوع السعال</label><select id="coughType"><option value="">اختر</option><option>جاف</option><option>ببلغم</option><option>بدم</option></select></div>
        </div>
      </div>
    </div>

    <!-- 2) الأعراض والنصوص -->
    <div class="section">
      <h2 class="section-title">2) خطّ الحياة والأعراض</h2>
      <div class="card">
        <div class="grid">
          <div style="grid-column:1/-1"><label>وصف الحالة (نص حر)</label><textarea id="freeText" placeholder="مثال: سعال مزمن 12 أسبوعًا..."></textarea></div>
          <div><label>التشخيصات المبدئية</label><textarea id="initialDx" placeholder="مثال: T2DM, HTN, COPD? Dermatitis"></textarea></div>
          <div><label>تحاليل/أشعة مذكورة</label><textarea id="labsImaging" placeholder="مثال: HbA1c 8.7%, eGFR 38→62, K 5.6 ..."></textarea></div>
          <div style="grid-column:1/-1"><label>الأدوية/الإجراءات المقرّرة</label><textarea id="orders" placeholder="مثال: Xigduo XR bid, Metformin 1000 tid ..."></textarea></div>
        </div>
      </div>
    </div>

    <!-- 3) رفع ملفات -->
    <div class="section">
      <h2 class="section-title">3) رفع ملفات (صور/PDF) — اختياري</h2>
      <label class="uploader" for="fileInput" id="dropZone">اضغط هنا لرفع ملف واحد أو أكثر
        <input id="fileInput" type="file" multiple accept="image/*,application/pdf"/>
      </label>
      <div id="cards" class="file-cards" aria-live="polite"></div>
      <div id="fileList" style="margin-top:8px;color:#475569"></div>
    </div>

    <div class="section" style="display:flex;gap:12px;align-items:center">
      <button class="btn btn-primary" id="analyzeBtn">تحليل الحالة</button>
      <button class="btn btn-outline" id="exportServerBtn">تصدير PDF (الخادم)</button>
      <button class="btn btn-outline" id="exportPdfBtn">تصدير PDF (العميل)</button>
      <span id="busy" class="busy-text" style="display:none">جاري التحليل…</span>
    </div>

    <div id="reportWrap" class="report-wrap">
      <div id="reportHTML" class="report-content"></div>
      <details style="margin-top:16px">
        <summary style="font-size:14px;color:#075985;cursor:pointer">إظهار JSON (للبحث/الإحصاءات)</summary>
        <pre id="jsonOut" style="white-space:pre-wrap;background:#f1f5f9;padding:16px;border-radius:12px;border:1px solid #e2e8f0;margin-top:12px;font-size:13px"></pre>
      </details>
    </div>
  </div>

  <script>
    // ——— تبديل اللغة مبسط ———
    let currentLang = 'ar';
    document.getElementById('lang-switcher').addEventListener('click', () => {
      currentLang = currentLang === 'ar' ? 'en' : 'ar';
      document.documentElement.lang = currentLang;
      document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
      document.getElementById('lang-switcher').textContent = currentLang === 'ar' ? 'English' : 'العربية';
    });

    // ——— حالة جديدة: تفريغ كل شيء لمنع امتزاج الحالات ———
    const initialFields = ['name','gender','age','pregnant','pregnancyMonths','smoking','packYears','weight','height','temp','hasCough','coughWeeks','coughType','freeText','initialDx','labsImaging','orders'];
    function startNewCase(){
      initialFields.forEach(id => { const el=document.getElementById(id); if(!el) return; if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; });
      filesState.splice(0, filesState.length);
      document.getElementById('cards').innerHTML = '';
      document.getElementById('fileList').textContent = '';
      document.getElementById('reportWrap').style.display = 'none';
      document.getElementById('reportHTML').innerHTML = '';
      document.getElementById('jsonOut').textContent = '';
    }
    document.getElementById('newCaseBtn').addEventListener('click', startNewCase);

    // ——— رفع الملفات ———
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const cardsBox = document.getElementById('cards');
    const fileList = document.getElementById('fileList');
    const filesState = []; // { name, mimeType, data (base64) }

    ['dragenter','dragover','dragleave','drop'].forEach(ev => window.addEventListener(ev, e => e.preventDefault()));
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('drop', async e => { e.preventDefault(); await handleFiles(Array.from(e.dataTransfer.files)); });
    fileInput.addEventListener('change', async () => { await handleFiles(Array.from(fileInput.files)); fileInput.value=''; });

    async function handleFiles(files){
      for (const f of files){
        const base64Url = await fileToDataURL(f);
        filesState.push({ name: f.name, mimeType: f.type || 'application/octet-stream', data: base64Url.split('base64,').pop() });
      }
      renderCards();
      fileList.textContent = filesState.map(f => '• ' + f.name).join('\\n');
    }
    function renderCards(){
      cardsBox.innerHTML = '';
      filesState.forEach((f,i) => {
        const isImg = (f.mimeType || '').startsWith('image/');
        const thumbSrc = isImg
          ? `data:${f.mimeType};base64,${f.data}`
          : `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="140" viewBox="0 0 200 140"><rect width="100%" height="100%" fill="#e2e8f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="12" fill="#64748b">'+f.name+'</text></svg>')}`;
        const card = document.createElement('div');
        card.className = 'file-card';
        card.innerHTML = `
          <button class="remove-btn" data-i="${i}" title="إزالة">×</button>
          <img class="file-thumb" src="${thumbSrc}" alt="${f.name}">
          <div style="padding:12px;font-size:13px;color:#475569"><div class="file-name" title="${f.name}">${f.name}</div></div>`;
        cardsBox.appendChild(card);
      });
      cardsBox.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const i = +e.currentTarget.dataset.i; filesState.splice(i,1); renderCards(); fileList.textContent = filesState.map(f => '• ' + f.name).join('\\n');
      }));
    }
    function fileToDataURL(file){ return new Promise((resolve,reject) => { const r=new FileReader(); r.onerror=()=>reject(new Error('failed to read file')); r.onload=()=>resolve(r.result); r.readAsDataURL(file); }); }

    function buildPatientInfo(){
      const gender = document.getElementById('gender').value || null;
      const pVal = document.getElementById('pregnant').value;
      return {
        name: document.getElementById('name').value || null,
        ageYears: document.getElementById('age').value ? Number(document.getElementById('age').value) : null,
        gender,
        pregnant: (gender === 'أنثى') ? { isPregnant: pVal === 'yes', gestationalWeeks: (pVal === 'yes' && document.getElementById('pregnancyMonths').value) ? Number(document.getElementById('pregnancyMonths').value) * 4 : null } : null,
        smoking: (() => { const s=document.getElementById('smoking').value || null; const py=document.getElementById('packYears').value ? Number(document.getElementById('packYears').value) : null; return s ? { status: s, packYears: py } : null; })(),
        temperatureC: document.getElementById('temp').value ? Number(document.getElementById('temp').value) : null,
        weightKg: document.getElementById('weight').value ? Number(document.getElementById('weight').value) : null,
        heightCm: document.getElementById('height').value ? Number(document.getElementById('height').value) : null,
        cough: { has: document.getElementById('hasCough').value || null, weeks: document.getElementById('coughWeeks').value ? Number(document.getElementById('coughWeeks').value) : null, type: document.getElementById('coughType').value || null }
      };
    }

    function makeCaseId(){ return (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()); }

    // ——— التحليل ———
    async function analyze(){
      const analyzeBtn = document.getElementById('analyzeBtn');
      const busy = document.getElementById('busy');
      analyzeBtn.disabled = true; busy.style.display = 'inline';
      try{
        const textParts = [];
        const ft = document.getElementById('freeText').value.trim(); if (ft) textParts.push(`وصف الحالة: ${ft}`);
        const dx = document.getElementById('initialDx').value.trim(); if (dx) textParts.push(`التشخيصات المبدئية: ${dx}`);
        const labs = document.getElementById('labsImaging').value.trim(); if (labs) textParts.push(`تحاليل/أشعة: ${labs}`);
        const orders = document.getElementById('orders').value.trim(); if (orders) textParts.push(`الأدوية/الإجراءات: ${orders}`);
        const mergedText = textParts.join('\\n');

        const payload = { text: mergedText, patientInfo: buildPatientInfo(), files: filesState, lang: currentLang, caseId: makeCaseId() };
        const resp = await fetch('/api/gpt', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await resp.json().catch(()=> ({}));
        if(!resp.ok) throw new Error(data?.error || ('HTTP '+resp.status));

        document.getElementById('reportWrap').style.display = 'block';
        document.getElementById('reportHTML').innerHTML = data.html || '';
        document.getElementById('jsonOut').textContent = JSON.stringify(data.structured || {}, null, 2);
      }catch(err){
        alert('خطأ: ' + (err.message || 'غير معروف'));
      }finally{
        analyzeBtn.disabled = false; busy.style.display = 'none';
      }
    }
    document.getElementById('analyzeBtn').addEventListener('click', analyze);

    // ——— تصدير PDF (الخادم) ———
    document.getElementById('exportServerBtn').addEventListener('click', async () => {
      const reportElement = document.getElementById('reportHTML');
      if(!reportElement){ alert('التقرير غير جاهز للتصدير.'); return; }
      try{
        const html = `<!DOCTYPE html><html lang="${currentLang}" dir="${currentLang==='ar'?'rtl':'ltr'}"><head><meta charset="UTF-8"><title>Medical Audit Report</title>
          <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
          <style>body{font-family:'Tajawal',sans-serif;padding:2cm;color:#212529}.audit-table{width:100%;border-collapse:collapse}.audit-table th,.audit-table td{border:1px solid #dee2e6;padding:10px}</style></head>
          <body>${reportElement.innerHTML}</body></html>`;
        const resp = await fetch('/api/pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ html, lang: currentLang }) });
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const blob = await resp.blob(); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='Medical_Audit_Report.pdf'; a.click(); URL.revokeObjectURL(url);
      }catch(e){ alert('حدث خطأ في التصدير: ' + e.message); }
    });

    // ——— تصدير PDF (العميل) ———
    document.getElementById('exportPdfBtn').addEventListener('click', async () => {
      const el = document.getElementById('reportHTML'); if(!el){ alert('التقرير غير جاهز للتصدير.'); return; }
      const opt = { filename:'Medical_Audit_Report.pdf', margin:10, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'mm', format:'a4', orientation:'portrait'} };
      try{ await html2pdf().set(opt).from(el).save(); } catch(e){ alert('خطأ في التصدير (عميل): ' + e.message); }
    });
  </script>
</body>
</html>
