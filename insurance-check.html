<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- PDF.js (المكتبة + العامل). استخدم نفس الإصدار في الاثنين -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js" defer></script>
  <style>
    :root{--bg:#0b1020;--ink:#111827;--muted:#6b7280;--ring:#2563eb;--card:#0f172a}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#0b1324; color:#e5e7eb; margin:0; padding:24px}
    h1{margin:0 0 8px; font-size:1.4rem}
    .wrap{max-width:1100px; margin-inline:auto}
    .panel{background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:14px 16px; margin:12px 0}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    label{font-size:.95rem; color:#cbd5e1}
    select, input[type="text"], textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb}
    textarea{min-height:96px; resize:vertical}
    button{background:#2563eb; color:#fff; border:0; padding:10px 16px; border-radius:10px; cursor:pointer}
    button[disabled]{opacity:.5; cursor:not-allowed}
    .btn-secondary{background:#334155}
    .muted{color:#9ca3af; font-size:.88rem}
    pre{white-space:pre-wrap; background:#060a16; border:1px dashed #334155; border-radius:10px; padding:12px; max-height:420px; overflow:auto}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .badge{display:inline-block; padding:3px 8px; border:1px solid #334155; border-radius:999px; font-size:.8rem; color:#a5b4fc}
  </style>
</head>
<body>
<div class="wrap">
  <h1>تحليل الحالات الطبية <span class="badge">Gemini & GPT‑4o</span></h1>
  <p class="muted">* تتم معالجة PDF لصور + نص محليًا عبر <strong>PDF.js</strong> ثم يُرسل ملخّص النص والصور للنماذج. * التقرير تعليمي ويُراجع سريريًا قبل أي قرار.</p>

  <div class="panel">
    <div class="row">
      <label style="flex:1 1 280px">اختر ملفات (صورة/‏PDF):
        <input id="files" type="file" accept="application/pdf,image/*" multiple />
      </label>
      <label style="flex:1 1 160px">اللغة:
        <select id="lang">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
      </label>
      <label style="flex:1 1 220px">النموذج:
        <select id="model">
          <option value="both" selected>Gemini + GPT‑4o</option>
          <option value="gemini">Gemini فقط</option>
          <option value="openai">GPT‑4o فقط</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label style="flex:1 1 240px">التخصص (اختياري):
        <input id="specialty" type="text" placeholder="أسنان، جلدية، قلب، ..." />
      </label>
      <label style="flex:1 1 100%">
        وصف مختصر/سياق التأمين (اختياري):
        <textarea id="insCtx" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما"></textarea>
      </label>
    </div>
    <div class="row">
      <button id="btnPrep" class="btn-secondary">تحضير الملفات</button>
      <button id="btnAnalyze" disabled>تحليل الحالة</button>
      <span id="prepInfo" class="muted"></span>
    </div>
  </div>

  <div class="panel">
    <strong>السجل</strong>
    <pre id="log">جاهز.</pre>
  </div>

  <div class="panel">
    <h3 style="margin-top:0">النتيجة المدمجة</h3>
    <pre id="merged"></pre>
  </div>

  <div class="grid">
    <div class="panel">
      <h3 style="margin-top:0">مخرجات GPT‑4o</h3>
      <pre id="gptOut"></pre>
    </div>
    <div class="panel">
      <h3 style="margin-top:0">مخرجات Gemini</h3>
      <pre id="geminiOut"></pre>
    </div>
  </div>
</div>

<script>
(function(){
  const logEl = document.getElementById('log');
  const filesEl = document.getElementById('files');
  const btnPrep = document.getElementById('btnPrep');
  const btnAnalyze = document.getElementById('btnAnalyze');
  const prepInfo = document.getElementById('prepInfo');
  const mergedEl = document.getElementById('merged');
  const gptEl = document.getElementById('gptOut');
  const gemEl = document.getElementById('geminiOut');

  // PDF.js worker setup (هذا أصل مشكلة pdfjsLib is not defined)
  window.addEventListener('load', () => {
    if (typeof window.pdfjsLib === 'undefined') {
      alert('فشل التحضير: pdfjsLib is not defined — تأكد من تحميل CDN.');
      return;
    }
    // طابق نفس الإصدار في رابطَي المكتبة والـ worker
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  });

  const state = { images: [], texts: [], prepared: false };

  function log(msg){ logEl.textContent += '\n' + msg; logEl.scrollTop = logEl.scrollHeight; }
  function resetResults(){ mergedEl.textContent=''; gptEl.textContent=''; gemEl.textContent=''; }

  async function fileToDataURL(file, maxDim=1600){
    const blobURL = URL.createObjectURL(file);
    const img = new Image();
    img.src = blobURL;
    await img.decode();
    const [w,h] = [img.naturalWidth, img.naturalHeight];
    const scale = Math.min(1, maxDim/Math.max(w,h));
    const canvas = document.createElement('canvas');
    canvas.width = Math.max(1, Math.round(w*scale));
    canvas.height = Math.max(1, Math.round(h*scale));
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0,0, canvas.width, canvas.height);
    URL.revokeObjectURL(blobURL);
    return canvas.toDataURL('image/png', 0.92);
  }

  async function pdfToImagesAndText(file, maxDim=1600){
    const ab = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: ab }).promise;
    const out = { images: [], text: '' };
    for (let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const vp = page.getViewport({ scale: 1.5 });
      const scale = Math.min(1, maxDim / Math.max(vp.width, vp.height));
      const viewport = page.getViewport({ scale: 1.5 * scale });

      const canvas = document.createElement('canvas');
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;
      out.images.push(canvas.toDataURL('image/png', 0.92));

      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(i => i.str).join(' ').replace(/\s+/g,' ').trim();
      out.text += (p>1? '\n\n---\n\n' : '') + pageText;
    }
    return out;
  }

  btnPrep.addEventListener('click', async () => {
    try{
      resetResults();
      logEl.textContent = 'بدء التحضير ...';
      const files = Array.from(filesEl.files || []);
      if (!files.length){ alert('اختر ملفًا واحدًا على الأقل'); return; }

      state.images = []; state.texts = []; state.prepared = false;
      for (const f of files){
        if (f.type === 'application/pdf'){
          log('• تحويل PDF واستخراج النص: ' + f.name);
          const r = await pdfToImagesAndText(f);
          state.images.push(...r.images.map(d => ({ dataUrl: d, contentType: 'image/png', from: f.name })));
          state.texts.push(r.text);
          log('✓ رُفعت ' + r.images.length + ' صفحة من ' + f.name);
        } else if (f.type.startsWith('image/')){
          log('• ضغط صورة: ' + f.name);
          const d = await fileToDataURL(f);
          state.images.push({ dataUrl: d, contentType: 'image/png', from: f.name });
        } else {
          log('تخطّي ملف غير مدعوم: ' + f.name);
        }
      }
      state.prepared = state.images.length > 0 || state.texts.length > 0;
      prepInfo.textContent = state.prepared
        ? `تم تجهيز ${state.images.length} صورة/صفحة + ${state.texts.length} نص PDF للتحليل.`
        : 'لم يتم تجهيز أي شيء.';
      btnAnalyze.disabled = !state.prepared;
      log('انتهى التحضير.');
    }catch(err){
      console.error(err);
      alert('فشل التحضير: ' + (err?.message || err));
    }
  });

  btnAnalyze.addEventListener('click', async () => {
    try{
      if (!state.prepared){ alert('حضّر الملفات أولاً.'); return; }
      btnAnalyze.disabled = true;
      log('بدء التحليل ...');
      const payload = {
        language: document.getElementById('lang').value,
        model: document.getElementById('model').value,
        specialty: document.getElementById('specialty').value || '',
        insuranceContext: document.getElementById('insCtx').value || '',
        images: state.images,
        texts: state.texts
      };
      const res = await fetch('/api/gpt', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || 'Server error');
      log('اكتمل التحليل.');

      mergedEl.textContent = JSON.stringify(json.merged, null, 2);
      gptEl.textContent = json.gpt ? JSON.stringify(json.gpt, null, 2) : '—';
      gemEl.textContent = json.gemini ? JSON.stringify(json.gemini, null, 2) : '—';
    }catch(err){
      console.error(err);
      alert('خطأ: ' + (err?.message || err));
      log('خطأ: ' + (err?.message || err));
    }finally{
      btnAnalyze.disabled = false;
    }
  });
})();
</script>
</body>
</html>
