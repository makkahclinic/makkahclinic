<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© - Medical Case & Insurance</title>
  <style>
    :root{
      --primary:#0b63c2; --primary-dark:#084e97; --accent:#00a7c7;
      --danger:#dc3545; --muted:#66768a; --text:#243143; --border:#e2e8f0;
      --card:#fff; --bg1:#e9f3ff; --bg2:#f6fbff; --shadow:0 10px 25px rgba(15,57,105,.08);
      --radius:16px; --home-offset-y:16px; --home-offset-x:16px; --ta-min:220px;
      --container: 1080px;
    }
    html,body{height:100%}
    body{
      margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--text); background: radial-gradient(1200px 800px at 80% 0%, var(--bg1), var(--bg2));
      padding: 2rem .75rem;
    }
    .container{
      max-width: var(--container); margin:0 auto; background:var(--card);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      position:relative; overflow:hidden;
    }
    .shell{ padding: 28px 26px 30px; }
    .top-ribbon{ position:absolute; inset:0 0 auto 0; height:6px; background:linear-gradient(90deg,var(--primary),var(--accent)); }

    /* header */
    .header{
      display:flex; align-items:center; gap:12px; justify-content:space-between; margin:6px 0 16px;
    }
    .title{
      font-weight:800; color:var(--primary); letter-spacing:.2px; margin:0; font-size:1.35rem;
    }
    .subtext{ color:var(--muted); margin-top:2px; font-size:.92rem; }

    .home-icon{
      position:absolute; inset-block-start:var(--home-offset-y); inset-inline-start:var(--home-offset-x);
      width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,#0b63c2,#00a7c7);
      color:#fff;font-size:24px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 6px 18px rgba(11,99,194,.22); cursor:pointer; user-select:none;
      transition:transform .14s ease, filter .25s ease; z-index:5;
    }
    .home-icon:hover{ transform:translateY(-1px) scale(1.04); filter:brightness(.98); }

    /* toolbar */
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; margin-bottom:6px;
    }
    .seg{
      display:inline-flex; background:#f3f7fb; border:1px solid var(--border); border-radius:999px; padding:4px;
    }
    .seg button{ border:none; background:transparent; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-weight:700; color:#3b5168; }
    .seg button.active{ background:#fff; border:1px solid var(--border); color:var(--primary); }

    .btn{
      display:inline-flex; align-items:center; gap:.5rem; border:none; border-radius:10px; color:#fff;
      padding:.55rem .9rem; font-weight:700; font-size:.95rem; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.08);
      transition:transform .06s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); }
    .btn-danger{ background:var(--danger); }
    .btn-ghost{ background:#eff5fb; color:#114a86; border:1px solid var(--border); }
    .btn-print{ background:#0f766e; } /* teal */

    .card{
      border:1px solid var(--border); border-radius:14px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.03);
      padding:16px; margin:14px 0;
    }
    .section-title{
      font-size:1.02rem; font-weight:800; color:#243143; display:flex; align-items:center; gap:.5rem; margin-bottom:12px;
      border-bottom:2px solid #dbe8f5; padding-bottom:.5rem;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; }

    label{font-weight:700; display:block; margin:.65rem 0 .35rem;}
    .hint{font-size:.86rem; color:#8496ab; margin-top:.15rem;}

    input, select, textarea{
      width:100%; box-sizing:border-box; border:1px solid var(--border); border-radius:10px; padding:.72rem .9rem; background:#fff;
      transition:border-color .2s, box-shadow .2s, background .2s; font-size:1rem;
    }
    input::placeholder, textarea::placeholder{ color:#9aa8b8; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(11,99,194,.18); background:#fbfdff; }
    textarea{ min-height:120px; resize:vertical; }

    .grid{ display:grid; gap:14px; }
    .grid-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
    .grid-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
    @media (max-width:900px){ .grid-3{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
    @media (max-width:720px){ .grid-2,.grid-3{ grid-template-columns: 1fr; } }

    .tall{ min-height: var(--ta-min); }
    .span-2{ grid-column: 1 / -1; }

    /* uploads */
    .drop{
      border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; color:#6c7f95;
      transition:border-color .25s, background .25s;
    }
    .drop:hover{ border-color:var(--primary); background:#f6fbff; }
    #file-input{ display:none; }

    .file-list{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin-top:10px; }
    .thumb{
      position:relative; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff;
      display:flex; align-items:center; justify-content:center; min-height:140px;
    }
    .thumb img{ max-width:100%; max-height:200px; display:block; }
    .thumb .badge{
      position:absolute; inset-block-start:8px; inset-inline-start:8px; background:#eef5ff; color:#1e3a8a;
      border:1px solid #cfe6ff; font-size:.78rem; padding:.12rem .45rem; border-radius:999px;
    }
    .thumb .remove{
      position:absolute; inset-block-start:8px; inset-inline-end:8px; width:30px;height:30px; border:none; border-radius:50%;
      background:var(--danger); color:#fff; font-size:18px; cursor:pointer; box-shadow:0 4px 10px rgba(220,53,69,.25);
    }
    .thumb .meta{ position:absolute; inset-block-end:8px; inset-inline-start:8px; color:#4b5563; background:#ffffffd0; border-radius:6px; padding:.15rem .4rem; font-size:.78rem; }

    .actions{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top: 10px; flex-wrap:wrap; }

    .notification{ margin-top:16px; padding:12px 14px; border-radius:10px; display:none; text-align:center; font-weight:600; }
    .notification.info{ background:#e9f4ff; color:#114a86; border:1px solid #cfe6ff; }
    .notification.error{ background:#fde8ea; color:#7a1f27; border:1px solid #f5c6cb; }

    #response-container{ margin-top: 16px; padding:16px; border:1px solid var(--border); border-radius:12px; background:#fff; display:none; box-shadow: var(--shadow); }

    /* print/export */
    @media print{
      body{ padding:0; background:#fff; }
      .home-icon, .toolbar, .actions, .notification{ display:none !important; }
      .container{ border:none; box-shadow:none; }
      #response-container{ display:block !important; }
    }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-ribbon"></div>
    <div class="home-icon" title="Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Home" onclick="goToHome()">ğŸ </div>

    <div class="shell">
      <div class="header">
        <div>
          <h1 class="title" id="app-title">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© â€¢ Medical Case</h1>
          <div class="subtext" id="app-sub">ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ±ÙŠØ© â€” Clinical intake & insurance</div>
        </div>

        <div class="toolbar">
          <!-- Language toggle -->
          <div class="seg" role="tablist" aria-label="Language">
            <button id="lang-ar" class="active" onclick="setLang('ar')" type="button">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
            <button id="lang-en" onclick="setLang('en')" type="button">English</button>
            <button id="lang-both" onclick="setLang('both')" type="button">Both</button>
          </div>

          <!-- Export -->
          <div class="seg">
            <button class="btn-ghost" type="button" onclick="exportHTML()">Export HTML</button>
            <button class="btn-ghost" type="button" onclick="exportJSON()">Export JSON</button>
            <button class="btn-print" type="button" onclick="window.print()">PDF / Print</button>
          </div>
        </div>
      </div>

      <!-- Patient info -->
      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-t="pinfo">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</span> / <span data-t="pinfo_en">Patient Info</span></div>
        <div class="grid grid-3">
          <div>
            <label for="gender" data-t="genderLbl">Ø§Ù„Ø¬Ù†Ø³</label><label for="gender" data-t="genderLbl_en" class="muted hidden">Gender</label>
            <select id="gender">
              <option value="" selected disabled data-t="choose">Ø§Ø®ØªØ±</option>
              <option value="male" data-t="male">Ø°ÙƒØ±</option>
              <option value="female" data-t="female">Ø£Ù†Ø«Ù‰</option>
            </select>
            <div class="hint" data-t="pregHint">Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø±ÙŠØ¶Ø© Ø£Ù†Ø«Ù‰ØŒ Ø³ØªØ¸Ù‡Ø± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
            <div class="hint hidden" data-t="pregHint_en">If female, pregnancy questions will appear automatically.</div>
          </div>

          <div>
            <label for="age" data-t="ageLbl">Ø§Ù„Ø¹Ù…Ø±</label><label for="age" data-t="ageLbl_en" class="muted hidden">Age</label>
            <input id="age" type="number" placeholder="63">
          </div>

          <div id="pregnancy-status-wrap" class="hidden">
            <label for="pregnancy-status" data-t="pregLbl">Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶Ø© Ø­Ø§Ù…Ù„ØŸ</label><label for="pregnancy-status" data-t="pregLbl_en" class="muted hidden">Pregnant?</label>
            <select id="pregnancy-status">
              <option value="" selected disabled data-t="choose">Ø§Ø®ØªØ±</option>
              <option value="yes" data-t="yes">Ù†Ø¹Ù…</option>
              <option value="no" data-t="no">Ù„Ø§</option>
            </select>
          </div>

          <div id="pregnancy-month-wrap" class="hidden">
            <label for="pregnancy-month" data-t="pregMonth">Ø´Ù‡Ø± Ø§Ù„Ø­Ù…Ù„</label><label for="pregnancy-month" data-t="pregMonth_en" class="muted hidden">Pregnancy Month</label>
            <input id="pregnancy-month" type="number" min="1" max="9" placeholder="5">
          </div>

          <div>
            <label for="height" data-t="heightLbl">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label><label for="height" data-t="heightLbl_en" class="muted hidden">Height (cm)</label>
            <input id="height" type="number" placeholder="175">
          </div>

          <div>
            <label for="weight" data-t="weightLbl">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><label for="weight" data-t="weightLbl_en" class="muted hidden">Weight (kg)</label>
            <input id="weight" type="number" placeholder="80">
          </div>

          <div>
            <label for="temperature" data-t="tempLbl">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°Ù…)</label><label for="temperature" data-t="tempLbl_en" class="muted hidden">Temperature (Â°C)</label>
            <input id="temperature" type="text" placeholder="37.6">
          </div>

          <div>
            <label for="blood-pressure" data-t="bpLbl">Ø¶ØºØ· Ø§Ù„Ø¯Ù…</label><label for="blood-pressure" data-t="bpLbl_en" class="muted hidden">Blood Pressure</label>
            <input id="blood-pressure" type="text" placeholder="120/80">
          </div>
        </div>
      </div>

      <!-- Lifestyle & symptoms -->
      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-t="life">Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ø£Ø¹Ø±Ø§Ø¶</span> / <span data-t="life_en">Lifestyle & Symptoms</span></div>
        <div class="grid grid-3">
          <div>
            <label for="smoker" data-t="smokerLbl">Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¯Ø®Ù‘Ù†ØŸ</label><label for="smoker" data-t="smokerLbl_en" class="muted hidden">Smoker?</label>
            <select id="smoker">
              <option value="" selected disabled data-t="choose">Ø§Ø®ØªØ±</option>
              <option value="yes" data-t="yes">Ù†Ø¹Ù…</option>
              <option value="no" data-t="no">Ù„Ø§</option>
            </select>
          </div>

          <div id="pack-years-wrap" class="hidden">
            <label for="pack-years" data-t="packLbl">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§Ùƒ-Ø³Ù†Ø©</label><label for="pack-years" data-t="packLbl_en" class="muted hidden">Pack-Years</label>
            <input id="pack-years" type="number" placeholder="35">
            <div class="hint" data-t="packHint">Ø§Ù„Ø¨Ø§Ùƒ-Ø³Ù†Ø© = (Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù„Ø¨ ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ã— Ø³Ù†ÙˆØ§Øª Ø§Ù„ØªØ¯Ø®ÙŠÙ†)</div>
            <div class="hint hidden" data-t="packHint_en">Pack-years = packs/day Ã— years smoked.</div>
          </div>

          <div>
            <label for="cough-duration" data-t="coughLbl">Ù…Ø¯Ø© Ø§Ù„Ø³Ø¹Ø§Ù„ (Ø£Ø³Ø§Ø¨ÙŠØ¹)</label><label for="cough-duration" data-t="coughLbl_en" class="muted hidden">Cough Duration (weeks)</label>
            <input id="cough-duration" type="number" placeholder="12">
          </div>

          <div>
            <label for="visual-symptoms" data-t="visionLbl">Ø£Ø¹Ø±Ø§Ø¶ Ø¨ØµØ±ÙŠØ©ØŸ</label><label for="visual-symptoms" data-t="visionLbl_en" class="muted hidden">Visual symptoms?</label>
            <select id="visual-symptoms">
              <option value="" selected disabled data-t="choose">Ø§Ø®ØªØ±</option>
              <option value="yes" data-t="yes">Ù†Ø¹Ù…</option>
              <option value="no" data-t="no">Ù„Ø§</option>
            </select>
          </div>

          <div id="eye-wrap" class="hidden">
            <label for="last-eye-exam" data-t="fundLbl">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙØ­Øµ Ù‚Ø§Ø¹ Ø¹ÙŠÙ†</label><label for="last-eye-exam" data-t="fundLbl_en" class="muted hidden">Last Fundus Exam</label>
            <input id="last-eye-exam" type="date">
            <label for="visual-acuity" data-t="acuLbl">Ø­Ø¯Ø© Ø§Ù„Ø¨ØµØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><label for="visual-acuity" data-t="acuLbl_en" class="muted hidden">Visual Acuity (optional)</label>
            <input id="visual-acuity" type="text" placeholder="6/12 or 20/40">
          </div>
        </div>
      </div>

      <!-- Medical details -->
      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-t="details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</span> / <span data-t="details_en">Medical Case Details</span></div>
        <div class="grid grid-2">
          <div>
            <label for="case-description" data-t="caseLbl">ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø©</label><label for="case-description" data-t="caseLbl_en" class="muted hidden">Case Description</label>
            <textarea id="case-description" class="tall" placeholder="Ù…Ø«Ø§Ù„ / e.g.: Ø³Ø¹Ø§Ù„ Ù…Ø²Ù…Ù† 12 Ø£Ø³Ø¨ÙˆØ¹Ù‹Ø§ ..."></textarea>
          </div>
          <div>
            <label for="diagnosis" data-t="dxLbl">Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©</label><label for="diagnosis" data-t="dxLbl_en" class="muted hidden">Initial Diagnoses</label>
            <textarea id="diagnosis" class="tall" placeholder="T2DM, HTN, COPD? Dermatitis"></textarea>
          </div>
          <div>
            <label for="lab-results" data-t="labLbl">Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„/Ø§Ù„Ø£Ø´Ø¹Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø©</label><label for="lab-results" data-t="labLbl_en" class="muted hidden">Labs / Imaging</label>
            <textarea id="lab-results" class="tall" placeholder="HbA1c 8.7%, eGFR 38â†’62, K 5.6, â€¦"></textarea>
          </div>
          <div class="span-2">
            <label for="medications-procedures" data-t="medLbl">Ø§Ù„Ø£Ø¯ÙˆÙŠØ©/Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø©</label><label for="medications-procedures" data-t="medLbl_en" class="muted hidden">Medications / Procedures</label>
            <textarea id="medications-procedures" class="tall" placeholder="Xigduo XR bid, Metformin 1000 tid, â€¦"></textarea>
          </div>
        </div>
      </div>

      <!-- Uploads -->
      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-t="uploads">Ø±ÙØ¹ Ù…Ù„ÙØ§Øª (ÙˆØµÙØ©/ØªÙ‚Ø±ÙŠØ±)</span> / <span data-t="uploads_en">Upload Files (Rx/Report)</span></div>
        <div class="drop" onclick="document.getElementById('file-input').click()" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
          <div data-t="drop">Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ ØµÙˆØ± (PNG/JPG) Ø£Ùˆ PDF</div>
          <div class="hidden" data-t="drop_en">Click or drop images (PNG/JPG) or PDF</div>
          <input id="file-input" type="file" accept="image/*,.pdf" multiple>
          <div class="hint" data-t="dropHint">Ù†Ù†ØµØ­ Ø¨Ù…Ù„Ù Ø£Ùˆ Ø§Ø«Ù†ÙŠÙ† ÙˆØ§Ø¶Ø­ÙŠÙ† â€” Ø§Ù„ØµÙˆØ± ØªÙØ¶ØºØ· ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
          <div class="hint hidden" data-t="dropHint_en">Prefer 1â€“2 clear files â€” images are auto-compressed</div>
        </div>
        <div id="file-list" class="file-list"></div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="analyzeBtn" class="btn btn-primary" onclick="analyzeCase()">ØªØ­Ù„ÙŠÙ„ / Analyze</button>
        <button class="btn btn-danger" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ / Logout</button>
      </div>

      <div id="notification-area" class="notification info"></div>
      <div id="response-container"></div>
    </div>
  </div>

  <script>
    /************** i18n (AR / EN / BOTH) **************/
    let currentLang = 'ar';
    function setLang(mode){
      currentLang = mode;
      // toggle which text nodes show
      const showAr = mode === 'ar' || mode === 'both';
      const showEn = mode === 'en' || mode === 'both';
      document.querySelectorAll('[data-t$="_en"]').forEach(el => el.classList.toggle('hidden', !showEn));
      document.querySelectorAll('[data-t]:not([data-t$="_en"])').forEach(el => el.classList.toggle('hidden', !showAr));
      // toolbar active
      document.getElementById('lang-ar').classList.toggle('active', mode==='ar');
      document.getElementById('lang-en').classList.toggle('active', mode==='en');
      document.getElementById('lang-both').classList.toggle('active', mode==='both');
      // direction: keep RTL by default; if EN only, we flip for comfort
      document.documentElement.dir = (mode==='en') ? 'ltr' : 'rtl';
      document.documentElement.lang = (mode==='en') ? 'en' : 'ar';
    }
    setLang('ar');

    /************** conditional fields **************/
    const genderEl = document.getElementById('gender');
    const pregStatWrap = document.getElementById('pregnancy-status-wrap');
    const pregMonthWrap = document.getElementById('pregnancy-month-wrap');
    const pregStatEl = document.getElementById('pregnancy-status');

    genderEl.addEventListener('change', () => {
      const isFemale = genderEl.value === 'female';
      pregStatWrap.classList.toggle('hidden', !isFemale);
      if (!isFemale){ pregMonthWrap.classList.add('hidden'); pregStatEl.value = ""; document.getElementById('pregnancy-month').value=""; }
    });
    pregStatEl.addEventListener('change', () => {
      const showMonth = pregStatEl.value === 'yes';
      pregMonthWrap.classList.toggle('hidden', !showMonth);
      if (!showMonth){ document.getElementById('pregnancy-month').value=""; }
    });

    const smokerEl = document.getElementById('smoker');
    const packYearsWrap = document.getElementById('pack-years-wrap');
    smokerEl.addEventListener('change', () => {
      packYearsWrap.classList.toggle('hidden', smokerEl.value !== 'yes');
      if (smokerEl.value !== 'yes') document.getElementById('pack-years').value="";
    });

    const visualEl = document.getElementById('visual-symptoms');
    const eyeWrap = document.getElementById('eye-wrap');
    visualEl.addEventListener('change', () => {
      eyeWrap.classList.toggle('hidden', visualEl.value !== 'yes');
      if (visualEl.value !== 'yes'){ document.getElementById('last-eye-exam').value=""; document.getElementById('visual-acuity').value=""; }
    });

    /************** uploads (images + PDFs) **************/
    const fileInput = document.getElementById('file-input');
    const fileListEl = document.getElementById('file-list');
    const noteArea = document.getElementById('notification-area');

    // internal state
    let filesState = []; // [{id,name,type,base64,width,height,sizeKB,isImage}]
    let nextId = 1;

    fileInput.addEventListener('change', async (e) => {
      if (!e.target.files?.length) return;
      await addFiles([...e.target.files]);
      fileInput.value = "";
    });

    async function handleDrop(ev){
      ev.preventDefault();
      const dtFiles = [...(ev.dataTransfer?.files || [])];
      if (!dtFiles.length) return;
      await addFiles(dtFiles);
    }

    async function addFiles(files){
      for (const file of files){
        const type = file.type || '';
        try{
          if (type.startsWith('image/')){
            const { base64, info } = await compressImage(file, { maxW: 1600, maxH: 1600, quality: 0.72 });
            filesState.push({ id: nextId++, name:file.name, type, base64, width:info.w, height:info.h, sizeKB:info.sizeKB, isImage:true });
          } else if (type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')){
            const base64 = await fileToBase64(file);
            const sizeKB = (base64.length * 3) / 4 / 1024;
            filesState.push({ id: nextId++, name:file.name, type:'application/pdf', base64, sizeKB, isImage:false });
          } else {
            showNote('error','Only images or PDF are supported / ÙŠØ¯Ø¹Ù… ØµÙˆØ± Ùˆ PDF ÙÙ‚Ø·');
          }
        }catch(err){
          console.error(err);
          showNote('error','File could not be processed / ØªØ¹Ø°Ù‘Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù');
        }
      }
      renderFiles();
    }

    function renderFiles(){
      fileListEl.innerHTML = '';
      filesState.forEach(f=>{
        const card = document.createElement('div');
        card.className = 'thumb';
        const badge = document.createElement('div');
        badge.className='badge';
        badge.textContent = f.isImage ? 'IMAGE' : 'PDF';
        card.appendChild(badge);

        const remove = document.createElement('button');
        remove.className='remove'; remove.textContent='âœ•';
        remove.title='Remove'; remove.onclick=()=>{ filesState = filesState.filter(x=>x.id!==f.id); renderFiles(); };
        card.appendChild(remove);

        if (f.isImage){
          const img = new Image();
          img.src = 'data:image/jpeg;base64,' + f.base64;
          card.appendChild(img);
          const meta = document.createElement('div');
          meta.className='meta';
          meta.textContent = `${f.width}Ã—${f.height} â€¢ ${f.sizeKB.toFixed(1)} KB`;
          card.appendChild(meta);
        } else {
          const pdfIcon = document.createElement('div');
          pdfIcon.style.fontSize='56px'; pdfIcon.style.color='#64748b'; pdfIcon.textContent='ğŸ“„';
          card.appendChild(pdfIcon);
          const meta = document.createElement('div');
          meta.className='meta';
          meta.textContent = `${f.name} â€¢ ${f.sizeKB.toFixed(1)} KB`;
          card.appendChild(meta);
        }

        fileListEl.appendChild(card);
      });
    }

    async function fileToBase64(file){
      return await new Promise((res, rej)=>{
        const r = new FileReader(); r.onload = ()=> res(r.result.split(',')[1]); r.onerror = rej; r.readAsDataURL(file);
      });
    }

    async function compressImage(file, { maxW=1600, maxH=1600, quality=0.72 } = {}){
      const dataURL = await new Promise((res, rej)=>{
        const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror = rej; r.readAsDataURL(file);
      });
      const img = await new Promise((res, rej)=>{
        const i = new Image(); i.onload = ()=> res(i); i.onerror = rej; i.src = dataURL;
      });
      let { width:w, height:h } = img;
      const ratio = Math.min(maxW/w, maxH/h, 1);
      w = Math.round(w*ratio); h = Math.round(h*ratio);
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      const out = canvas.toDataURL('image/jpeg', quality);
      const base64 = out.split(',')[1];
      const sizeKB = (base64.length * 3) / 4 / 1024;
      return { base64, info:{ w,h,sizeKB } };
    }

    /************** notifications **************/
    function showNote(type, text){
      noteArea.className = 'notification ' + (type === 'error' ? 'error' : 'info');
      noteArea.textContent = text;
      noteArea.style.display = 'block';
    }
    function clearNote(){ noteArea.style.display='none'; noteArea.textContent=''; }

    /************** routing & auth placeholders **************/
    function goToHome(){ window.location.href = 'https://www.m2020m.org/portal.html'; }
    function logout(){ showNote('info','ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ / Logged out (demo).'); }

    /************** export **************/
    function exportJSON(){
      const payload = buildPayload();
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `case-export-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
    }
    function exportHTML(){
      const html = document.getElementById('response-container').innerHTML || '<p>No report yet.</p>';
      const doc = `<!DOCTYPE html><html lang="${document.documentElement.lang}" dir="${document.documentElement.dir}">
      <head><meta charset="utf-8"><title>Report</title>
      <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;color:#1f2937}
      .report{max-width:920px;margin:0 auto} .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
      </style></head><body><div class="report">${html}</div></body></html>`;
      const blob = new Blob([doc], {type:'text/html'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `case-report-${Date.now()}.html`; a.click(); URL.revokeObjectURL(a.href);
    }

    /************** analyze (API call) **************/
    function buildPayload(){
      return {
        uiLang: currentLang, // 'ar' | 'en' | 'both'
        userType:'doctor',
        age: val('age'),
        gender: val('gender'),
        isSmoker: sel('smoker'),
        smokingPackYears: val('pack-years'),
        coughDurationWeeks: val('cough-duration'),
        visualSymptoms: val('visual-symptoms'),
        lastEyeExamDate: val('last-eye-exam'),
        visualAcuity: val('visual-acuity'),
        height: val('height'),
        weight: val('weight'),
        temperature: val('temperature'),
        bloodPressure: val('blood-pressure'),
        notes: val('case-description', true),
        diagnosis: val('diagnosis', true),
        labResults: val('lab-results', true),
        medications: val('medications-procedures', true),
        files: filesState.map(f=>({name:f.name,type:f.type,base64:f.base64}))
      };
    }
    function val(id, allowEmpty=false){
      const v = (document.getElementById(id)?.value || '').trim();
      return (allowEmpty? v : (v || undefined));
    }
    function sel(id){
      const v = document.getElementById(id)?.value;
      if (v==='yes') return true;
      if (v==='no') return false;
      return undefined;
    }

    async function analyzeCase(){
      const responseContainer = document.getElementById('response-container');
      const btn = document.getElementById('analyzeBtn');
      clearNote(); responseContainer.style.display='none'; responseContainer.innerHTML='';

      const payload = buildPayload();
      if (!payload.notes && !payload.diagnosis && !payload.labResults && !payload.medications && (!payload.files || payload.files.length===0)){
        showNote('error','Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ø£Ø±ÙÙ‚ Ù…Ù„ÙÙ‹Ø§ / Provide case details or attach a file.');
        return;
      }

      showNote('info','Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„â€¦ / Analyzingâ€¦');
      btn.disabled = true;

      const controller = new AbortController();
      const t = setTimeout(()=> controller.abort(), 90000);

      try{
        const res = await fetch('/api/gpt', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload), signal: controller.signal
        });
        const text = await res.text();
        if (!res.ok){
          if (res.status === 413 || /Entity Too Large|Content Too Large/i.test(text)){
            throw new Error('Payload too large â€” Ù‚Ù„Ù‘Ù„ Ø¹Ø¯Ø¯/Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª');
          }
          throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}â€¦`);
        }
        let data; try{ data = JSON.parse(text); } catch{ throw new Error('Invalid JSON from server'); }

        if (data?.htmlReport){
          clearNote();
          responseContainer.innerHTML = data.htmlReport;
          responseContainer.style.display = 'block';
          responseContainer.scrollIntoView({ behavior:'smooth', block:'start' });
        } else {
          throw new Error('Server did not return htmlReport');
        }
      } catch(err){
        console.error(err);
        showNote('error','Error: ' + err.message);
      } finally {
        clearTimeout(t);
        btn.disabled = false;
      }
    }

    // init text visibility for BOTH mode on load if needed
    window.setLang = setLang;
    window.goToHome = goToHome;
  </script>
</body>
</html>
