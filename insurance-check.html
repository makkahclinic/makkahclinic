<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>تحليل الحالات الطبية — Gemini & GPT‑4o</title>
  <style>
    :root{--bg:#f8f9fb;--card:#fff;--border:#e5e7eb;--muted:#6b7280;--ink:#111827}
    body{font-family:Arial,system-ui,-apple-system;background:var(--bg);color:#111;margin:24px}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1;min-width:260px}
    label{display:block;margin:10px 0 6px}
    input[type=file]{margin:6px 0 12px}
    input,select,textarea{padding:10px;border:1px solid var(--border);border-radius:8px;width:100%}
    button{padding:10px 16px;border:0;border-radius:8px;background:var(--ink);color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .warn{padding:10px;background:#fff7ed;border:1px solid #f59e0b;border-radius:8px;margin:8px 0;color:#92400e}
    .report{white-space:pre-wrap;background:#fff;border:1px dashed #cbd5e1;padding:12px;border-radius:8px;min-height:64px}
    .log{white-space:pre-wrap;background:#0b1020;color:#c7d2fe;padding:12px;border-radius:8px;max-height:280px;overflow:auto}
    progress{width:100%;height:14px}
  </style>

  <!-- PDF.js (ES Modules) + worker عبر CDN -->
  <script>
    let __pdfjsModule;
    async function getPdfJs(){
      if(!__pdfjsModule){
        __pdfjsModule = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.54/pdf.min.mjs');
        __pdfjsModule.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.54/pdf.worker.min.mjs';
      }
      return __pdfjsModule;
    }
    // @vercel/blob/client للرفع المباشر (Client Uploads)
    async function getVercelUpload(){
      const mod = await import('https://esm.sh/@vercel/blob@0.25.1/client?bundle');
      return mod.upload;
    }
  </script>
</head>
<body>
  <h1>تحليل الحالات الطبية (Gemini & GPT‑4o)</h1>
  <div id="ver" class="muted"></div>
  <div id="health" class="warn" style="display:none"></div>
  <div class="muted">
    * الرفع مباشر إلى Vercel Blob. *التقرير تعليمي ويُراجع طبيًا قبل أي قرار*.  
    * يتم استخراج نص PDF داخليًا وإرساله مع الصور لرفع الدقة (PDF.js).
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>اختر ملفات (صورة/‏PDF):</label>
        <input id="fileInput" type="file" accept=".pdf,image/*" multiple />
        <div class="muted">أي PDF سيتحوّل إلى صور + يُستخرج نصّه.</div>
      </div>
      <div>
        <label>اللغة:</label>
        <select id="lang"><option value="ar" selected>العربية</option><option value="en">English</option></select>
        <label>النموذج:</label>
        <select id="model">
          <option value="both" selected>Gemini + GPT‑4o</option>
          <option value="openai">GPT‑4o فقط</option>
          <option value="gemini">Gemini فقط</option>
        </select>
        <label>التخصص (اختياري):</label>
        <input id="specialty" placeholder="أسنان، جلدية، قلب، ..." />
      </div>
    </div>
    <label>وصف مختصر/سياق التأمين (اختياري):</label>
    <textarea id="context" rows="3"></textarea>

    <div class="row" style="align-items:center">
      <div><button id="analyzeBtn">تحليل الحالة</button></div>
      <div><progress id="prog" value="0" max="100" hidden></progress></div>
    </div>
    <div id="uploadSummary" class="muted"></div>
  </div>

  <div class="card"><h3>النتيجة المدمجة</h3><div id="merged" class="report"></div></div>
  <div class="card"><h3>مخرجات GPT‑4o</h3><div id="openaiOut" class="report"></div></div>
  <div class="card"><h3>مخرجات Gemini</h3><div id="geminiOut" class="report"></div></div>
  <div class="card"><h3>السجل</h3><div id="log" class="log"></div></div>

<script>
const $ = id => document.getElementById(id);
const log = (...a)=>{ $('log').textContent += a.join(' ') + '\n'; };

// فحص صحة البيئة + نسخة الـAPI
(async()=>{
  try{
    const v = await fetch('/api/gpt?action=version'); if(v.ok){ const j=await v.json(); $('ver').textContent = `API Version: ${j.apiVersion}`; }
    const r = await fetch('/api/gpt?action=health');
    if(r.ok){
      const j = await r.json();
      const probs=[];
      if(!j.hasBlobToken) probs.push('BLOB_READ_WRITE_TOKEN مفقود (اربط Blob Store).');
      if(!j.pkgBlob) probs.push('الحزمة @vercel/blob غير مثبتة.');
      if(!j.hasOpenAI) probs.push('OPENAI_API_KEY مفقود.');
      if(!j.hasGemini) probs.push('GEMINI_API_KEY مفقود.');
      if(probs.length){ const el=$('health'); el.style.display='block'; el.textContent='تحذير: '+probs.join(' | '); }
    }
  }catch{}
})();

function redactLinesBasic(s){
  if(!s) return s;
  const patterns = [
    /^.*\b(Name|Patient\s*File\s*No|ID\s*No|D\.?O\.?B|Provider Name|Insurance Co\.|TPA Name)\b.*$/gmi,
    /^.*\b(الاسم|رقم\s*الملف|رقم\s*الهوية|تاريخ\s*الميلاد|مزود\s*الخدمة|شركة\s*التأمين)\b.*$/gmi,
    /\b\d{8,}\b/g
  ];
  let out = s; for(const p of patterns) out = out.replace(p,''); return out;
}

async function pdfPageToBlob(pdf, pageNumber, scale=2){
  const page = await pdf.getPage(pageNumber);
  const viewport = page.getViewport({ scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  return new Promise(resolve => canvas.toBlob(b=>resolve(b), 'image/png', 0.92));
}
async function extractPdfText(pdf){
  let chunks = [];
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const tc = await page.getTextContent();
    chunks.push(tc.items.map(it=>it.str).join(' '));
  }
  return redactLinesBasic(chunks.join('\n\n'));
}

async function uploadFileToBlob(file){
  const upload = await getVercelUpload();
  const res = await upload(file.name, file, {
    access:'public',
    handleUploadUrl:'/api/gpt?action=sign',
    multipart: file.size >= 10*1024*1024,
    onUploadProgress: ({ percentage })=>{
      const p=$('prog'); if(!p.hidden && typeof percentage==='number'){ p.value=Math.min(99, Math.floor(percentage)); }
    }
  });
  return { url: res.url, mimeType: file.type || 'application/octet-stream', name: file.name };
}

async function handleFiles(files){
  const prog = $('prog'); prog.hidden=false; prog.value=0;
  const uploaded=[]; let docText=[]; let processed=0; let totalSteps=files.length;

  for(const file of files){
    const isPdf = file.type==='application/pdf' || file.name.toLowerCase().endsWith('.pdf');
    if(isPdf){
      log(`> تحويل PDF واستخراج نص: ${file.name}`);
      const pdfjsLib = await getPdfJs();
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      const text = await extractPdfText(pdf); if(text) docText.push(text);
      const maxPages = Math.min(pdf.numPages, 15); totalSteps += (maxPages - 1);
      for(let i=1;i<=maxPages;i++){
        const blob = await pdfPageToBlob(pdf, i, 2);
        const pageFile = new File([blob], `${file.name.replace(/\.pdf$/i,'')}-p${i}.png`, {type:'image/png'});
        const up = await uploadFileToBlob(pageFile);
        uploaded.push(up);
        processed++; prog.value=Math.round(processed*100/totalSteps);
        log(`✓ رُفعت صفحة ${i}/${maxPages} من ${file.name}`);
      }
    }else{
      const up = await uploadFileToBlob(file);
      uploaded.push(up); processed++; prog.value=Math.round(processed*100/totalSteps);
      log(`✓ رُفعت الصورة: ${file.name}`);
    }
  }
  prog.hidden=true;
  $('uploadSummary').textContent = `تم تجهيز ${uploaded.length} صورة/صفحة + نص PDF للتحليل.`;
  return { images: uploaded, docText: docText.join('\n\n') };
}

async function analyze(payload){
  const r = await fetch('/api/gpt?action=analyze', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error('API error: '+await r.text());
  return r.json();
}

$('analyzeBtn').addEventListener('click', async ()=>{
  try{
    const files = Array.from($('fileInput').files||[]); if(!files.length){ alert('اختر ملفاً واحداً على الأقل.'); return; }
    $('analyzeBtn').disabled=true; $('prog').hidden=false; log('بدء الرفع/التحويل ...');
    const { images, docText } = await handleFiles(files);
    log('بدء التحليل ...');
    const result = await analyze({
      files: images,
      docText,
      language: $('lang').value,
      model: $('model').value,
      specialty: $('specialty').value.trim(),
      context: $('context').value.trim()
    });
    $('merged').textContent   = result.merged || '';
    $('openaiOut').textContent = result.openai || '—';
    $('geminiOut').textContent = result.gemini || '—';
    $('prog').hidden=true; log('اكتمل التحليل.');
  }catch(e){ log('خطأ: '+e.message); alert(e.message); }
  finally{ $('analyzeBtn').disabled=false; }
});
</script>
</body>
</html>
