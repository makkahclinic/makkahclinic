<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>تقييم الحالة الطبية وطلبات التأمين</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- html2pdf bundle (يوفّر html2canvas + jsPDF داخليًا) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

  <!-- PDF.js لتحويل PDF إلى صور -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <script>
    // تعيين العامل (worker) لـ PDF.js
    window.addEventListener('DOMContentLoaded', () => {
      if (window["pdfjsLib"]) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }
    });
  </script>

  <style>
    :root{--p:#0ea5e9;--bg:#f8fafc;--b:#e2e8f0;--text:#0f172a;--muted:#64748b}
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{font-family:'Tajawal',system-ui,sans-serif;background:var(--bg);color:var(--text);margin:0}
    .container{max-width:1100px;margin:24px auto;padding:24px;background:#fff;border:1px solid var(--b);border-radius:20px}
    h1{margin:0 0 6px 0;color:#075985}
    .subtitle{color:#475569;margin:0 0 14px 0}
    .topbar{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    .chip{background:#eef2ff;border:1px solid #c7d2fe;padding:6px 12px;border-radius:999px;cursor:pointer}
    .btn{border:none;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn-primary{background:#0284c7;color:#fff}
    .btn-outline{background:#fff;border:1px solid var(--b);color:#0f172a}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .col-span-3{grid-column:span 3}
    label{font-weight:600;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:12px;border:1px solid var(--b);border-radius:10px;background:#fff}
    textarea{min-height:90px}
    .uploader{border:2px dashed #93c5fd;border-radius:12px;padding:20px;text-align:center;color:#075985;background:#eff6ff}
    .file-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:10px}
    .file-card{border:1px solid var(--b);border-radius:12px;overflow:hidden;background:#fff;position:relative}
    .file-card img{display:block;width:100%;height:140px;object-fit:cover;background:#f1f5f9}
    .remove{position:absolute;top:6px;right:6px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer}
    .banner{background:#ecfeff;border:1px solid #a5f3fc;padding:10px;border-radius:10px;margin:10px 0;color:#155e75}
    .report-wrap{margin-top:20px;display:none}
    .report-content{background:#fff;border:1px solid var(--b);border-radius:12px;padding:18px}
    details{margin-top:10px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <button id="langSwitcher" class="chip" data-translate="lang_english">English</button>
      <button id="newCaseBtn" class="chip" data-translate="new_case">حالة جديدة</button>
    </div>

    <h1 data-translate="title">تقييم الحالة الطبية وطلبات التأمين</h1>
    <p class="subtitle" data-translate="subtitle">واجهة إدخال سريرية — تحليل عميق مثل ChatGPT برؤية مباشرة</p>

    <div class="banner" data-translate="banner">التحليل يتم مباشرةً من الصور (أو PDF بعد تحويله لصور)، مع مخرجات JSON وفق مخطط صارم.</div>

    <!-- Patient info -->
    <h3 data-translate="section_patient">1) معلومات المريض</h3>
    <div class="grid">
      <div><label data-translate="label_name">الاسم (اختياري)</label><input id="name" placeholder="أحمد"/></div>
      <div><label data-translate="label_gender">الجنس</label>
        <select id="gender">
          <option value="" data-translate="opt_select">اختر</option>
          <option value="ذكر" data-translate="opt_male">ذكر</option>
          <option value="أنثى" data-translate="opt_female">أنثى</option>
        </select>
      </div>
      <div><label data-translate="label_age">العمر</label><input id="age" type="number" placeholder="45"/></div>
      <div><label data-translate="label_temp">درجة الحرارة (°م)</label><input id="temp" type="number" step="0.1" placeholder="37.0"/></div>
      <div><label data-translate="label_weight">الوزن (كجم)</label><input id="weight" type="number" step="0.1" placeholder="70"/></div>
      <div><label data-translate="label_height">الطول (سم)</label><input id="height" type="number" step="0.5" placeholder="170"/></div>
      <div class="col-span-3"><label data-translate="label_free">وصف الحالة (نص حر)</label><textarea id="freeText" placeholder="أعراض/ملاحظات..."></textarea></div>
    </div>

    <!-- Files -->
    <h3 style="margin-top:18px" data-translate="section_files">2) رفع ملفات (صور/PDF)</h3>
    <div class="uploader">
      <button id="chooseFilesBtn" class="btn btn-outline" data-translate="choose_files">اختيار ملفات</button>
      <input id="fileInput" type="file" accept="image/*,application/pdf" multiple style="display:none"/>
      <div style="margin-top:8px;color:#475569" data-translate="uploader_hint">يمكن سحب وإفلات الملفات هنا أيضًا</div>
    </div>
    <div id="fileCards" class="file-cards"></div>

    <!-- Actions -->
    <div style="display:flex;gap:10px;align-items:center;margin-top:16px">
      <button id="analyzeBtn" class="btn btn-primary" data-translate="analyze">تحليل الحالة</button>
      <span id="busy" style="display:none;color:#64748b" data-translate="busy">جاري التحليل…</span>
    </div>

    <!-- Report -->
    <div id="reportWrap" class="report-wrap">
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <button id="exportServerBtn" class="btn btn-primary" data-translate="export_server">تصدير PDF (الخادم)</button>
        <button id="exportClientBtn" class="btn btn-outline" data-translate="export_client">تصدير PDF (العميل)</button>
      </div>
      <div id="reportHTML" class="report-content"></div>
      <details>
        <summary data-translate="show_json">إظهار JSON</summary>
        <pre id="jsonOut" style="white-space:pre-wrap;background:#f1f5f9;padding:10px;border-radius:10px;border:1px solid #e2e8f0"></pre>
      </details>
    </div>
  </div>

<script>
/* ===== i18n ===== */
const translations = {
  ar: {
    lang_english:"English", new_case:"حالة جديدة", title:"تقييم الحالة الطبية وطلبات التأمين",
    subtitle:"واجهة إدخال سريرية — تحليل عميق مثل ChatGPT برؤية مباشرة",
    banner:"التحليل يتم مباشرةً من الصور (أو PDF بعد تحويله لصور)، مع مخرجات JSON وفق مخطط صارم.",
    section_patient:"1) معلومات المريض", label_name:"الاسم (اختياري)", label_gender:"الجنس",
    opt_select:"اختر", opt_male:"ذكر", opt_female:"أنثى", label_age:"العمر", label_temp:"درجة الحرارة (°م)",
    label_weight:"الوزن (كجم)", label_height:"الطول (سم)", label_free:"وصف الحالة (نص حر)",
    section_files:"2) رفع ملفات (صور/PDF)", choose_files:"اختيار ملفات", uploader_hint:"يمكن سحب وإفلات الملفات هنا أيضًا",
    analyze:"تحليل الحالة", busy:"جاري التحليل…", export_server:"تصدير PDF (الخادم)", export_client:"تصدير PDF (العميل)",
    show_json:"إظهار JSON"
  },
  en: {
    lang_english:"العربية", new_case:"New Case", title:"Medical Case & Insurance Assessment",
    subtitle:"Simple clinical input — Deep, ChatGPT‑level vision analysis",
    banner:"The model analyzes images directly (PDFs are auto-converted to images) and returns strict JSON per schema.",
    section_patient:"1) Patient Information", label_name:"Name (Optional)", label_gender:"Gender",
    opt_select:"Select", opt_male:"Male", opt_female:"Female", label_age:"Age", label_temp:"Temperature (°C)",
    label_weight:"Weight (kg)", label_height:"Height (cm)", label_free:"Case Description (Free Text)",
    section_files:"2) Upload Files (Images/PDF)", choose_files:"Choose Files", uploader_hint:"You can also drag & drop here",
    analyze:"Analyze Case", busy:"Analyzing…", export_server:"Export PDF (Server)", export_client:"Export PDF (Client)",
    show_json:"Show JSON"
  }
};
let currentLang = "ar";
function setLanguage(lang){
  currentLang = lang;
  document.documentElement.lang = lang;
  document.documentElement.dir  = (lang==="ar"?"rtl":"ltr");
  document.querySelectorAll("[data-translate]").forEach(el=>{
    const k = el.getAttribute("data-translate"); el.textContent = translations[lang][k] || el.textContent;
  });
  // placeholders
  if (lang==="ar"){
    document.getElementById("name").placeholder="أحمد";
    document.getElementById("freeText").placeholder="أعراض/ملاحظات...";
  } else {
    document.getElementById("name").placeholder="John";
    document.getElementById("freeText").placeholder="Symptoms/notes...";
  }
}
document.getElementById("langSwitcher").addEventListener("click", ()=>{
  setLanguage(currentLang==="ar" ? "en" : "ar");
});
setLanguage("ar");

/* ===== Files state ===== */
const fileInput  = document.getElementById("fileInput");
const chooseBtn  = document.getElementById("chooseFilesBtn");
const fileCards  = document.getElementById("fileCards");
const filesState = []; // { name, mimeType, data (base64 w/o prefix) }

chooseBtn.addEventListener("click", ()=> fileInput.click());
fileInput.addEventListener("change", async ()=>{
  await handleFiles(Array.from(fileInput.files));
  fileInput.value = ""; // عدم تكرار الحاجة للضغط مرة ثانية
});

// Drag & Drop
["dragenter","dragover","dragleave","drop"].forEach(ev => {
  window.addEventListener(ev, e=>e.preventDefault());
});
document.querySelector(".uploader").addEventListener("drop", async (e)=>{
  await handleFiles(Array.from(e.dataTransfer.files));
});

async function handleFiles(files){
  for (const f of files){
    if (f.type === "application/pdf"){
      const imgs = await pdfFileToImages(f); // تحويل PDF إلى صور
      for (const img of imgs) filesState.push(img);
    } else if (f.type.startsWith("image/")){
      const dataUrl = await fileToDataURL(f);
      const optimized = await maybeCompressImage(dataUrl, 1800); // تقليل الحجم للصورة الكبيرة
      filesState.push({ name: f.name, mimeType: (optimized.mimeType || f.type), data: optimized.base64 });
    }
  }
  renderCards();
}

/* PDF.js: تحويل PDF إلى صور PNG Base64 */
async function pdfFileToImages(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  const results = [];
  for (let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({ scale: 2 }); // جودة أعلى
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width; canvas.height = viewport.height;
    const ctx = canvas.getContext("2d");
    await page.render({ canvasContext: ctx, viewport }).promise;
    const dataUrl = canvas.toDataURL("image/png");
    results.push({ name: `${file.name}_page_${p}.png`, mimeType: "image/png", data: dataUrl.split("base64,").pop() });
  }
  return results;
}

/* أدوات */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onerror = ()=> reject(new Error("Failed to read file"));
    r.onload  = ()=> resolve(r.result);
    r.readAsDataURL(file);
  });
}

// ضغط اختياري للصور الكبيرة > maxW
async function maybeCompressImage(dataUrl, maxW=1800){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      let { width, height } = img;
      if (width <= maxW) return resolve({ base64: dataUrl.split("base64,").pop(), mimeType: dataUrl.match(/^data:(.*?);/)[1] });
      const ratio = maxW / width; width = maxW; height = Math.round(height * ratio);
      const canvas = document.createElement("canvas");
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
      const out = canvas.toDataURL("image/jpeg", 0.92);
      resolve({ base64: out.split("base64,").pop(), mimeType: "image/jpeg" });
    };
    img.src = dataUrl;
  });
}

function renderCards(){
  fileCards.innerHTML = "";
  filesState.forEach((f, i)=>{
    const el = document.createElement("div");
    el.className = "file-card";
    const thumb = (f.mimeType||"").startsWith("image/") ? `data:${f.mimeType};base64,${f.data}` :
      `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="140"><rect width="100%" height="100%" fill="#e2e8f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="12" fill="#64748b">FILE</text></svg>')}`;
    el.innerHTML = `
      <button class="remove" title="Remove" data-i="${i}">×</button>
      <img src="${thumb}" alt="${f.name || "file"}"/>
      <div style="padding:10px"><div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${f.name || "file"}</div></div>
    `;
    fileCards.appendChild(el);
  });
  fileCards.querySelectorAll(".remove").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const idx = +e.currentTarget.dataset.i;
      filesState.splice(idx, 1);
      renderCards();
    });
  });
}

/* ===== تحليل الحالة ===== */
let currentCaseId = null;

function buildPatientInfo(){
  const val = id => document.getElementById(id)?.value || "";
  const asNum = x => x!=="" ? Number(x) : null;
  return {
    name: val("name") || null,
    gender: document.getElementById("gender").value || null,
    ageYears: asNum(val("age")),
    temperatureC: asNum(val("temp")),
    weightKg: asNum(val("weight")),
    heightCm: asNum(val("height"))
  };
}

async function analyze(){
  const analyzeBtn = document.getElementById("analyzeBtn");
  const busy = document.getElementById("busy");
  analyzeBtn.disabled = true; busy.style.display = "inline";

  try{
    currentCaseId = String(Date.now());
    const payload = {
      text: document.getElementById("freeText").value || "",
      files: filesState, // صور (وملفات PDF التي تحولت لصور)
      patientInfo: buildPatientInfo(),
      lang: currentLang
    };

    const resp = await fetch("/api/audit-onecall", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const data = await resp.json().catch(()=> ({}));
    if (!resp.ok) throw new Error(data?.error || ("HTTP "+resp.status));

    // سباق زمني: اعرض فقط إذا caseId موجود ومتوافق
    if (!data?.caseId) throw new Error("Missing caseId");
    // (هنا caseId من الخادم يختلف عن currentCaseId المحلي، لكننا لا نُطلق طلبين بالتوازي. يكفي قبول الرد.)
    document.getElementById("reportHTML").innerHTML = data.html || "";
    document.getElementById("jsonOut").textContent = JSON.stringify(data.structured || {}, null, 2);
    document.getElementById("reportWrap").style.display = "block";
    // Scroll into view (يساعد html2pdf)
    document.getElementById("reportHTML").scrollIntoView({ behavior:"smooth", block:"start" });
  } catch (e){
    alert((currentLang==="ar"?"خطأ: ":"Error: ")+ e.message);
  } finally {
    analyzeBtn.disabled = false; busy.style.display = "none";
  }
}
document.getElementById("analyzeBtn").addEventListener("click", analyze);

/* ===== تصدير PDF (الخادم) ===== */
document.getElementById("exportServerBtn").addEventListener("click", async ()=>{
  const el = document.getElementById("reportHTML");
  if (!el || !el.innerHTML.trim()){ return alert(currentLang==="ar"?"التقرير غير جاهز.":"Report not ready."); }
  try{
    const r = await fetch("/api/pdf", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ html: el.innerHTML, lang: currentLang }) });
    if (!r.ok) throw new Error("HTTP "+r.status);
    const blob = await r.blob();
    const url  = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "Medical_Audit_Report.pdf"; a.click();
    URL.revokeObjectURL(url);
  } catch(e){
    alert((currentLang==="ar"?"فشل التصدير: ":"Export failed: ")+e.message);
  }
});

/* ===== تصدير PDF (العميل) — حل مشكلة الصفحة البيضاء ===== */
document.getElementById("exportClientBtn").addEventListener("click", async ()=>{
  const el = document.getElementById("reportHTML");
  if (!el || !el.innerHTML.trim()){ return alert(currentLang==="ar"?"التقرير غير جاهز.":"Report not ready."); }
  try{
    // انتظر تحميل الخطوط قبل الالتقاط
    if (document.fonts && document.fonts.ready){ await document.fonts.ready; } // MDN
    // تأكد أن العنصر مرئي وله أبعاد
    el.style.background = "#fff";
    el.style.minHeight  = "100px";
    // html2pdf
    const opt = {
      filename: "Medical_Audit_Report.pdf",
      margin: 10,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true }, // وثائق html2canvas
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };
    await html2pdf().set(opt).from(el).save();
  } catch(e){
    alert((currentLang==="ar"?"فشل التصدير (عميل): ":"Export failed (client): ")+e.message);
  }
});

/* ===== حالة جديدة ===== */
document.getElementById("newCaseBtn").addEventListener("click", ()=>{
  // تصفير الحقول والحالة
  ["name","age","temp","weight","height","freeText"].forEach(id => { const el = document.getElementById(id); if (el) el.value=""; });
  document.getElementById("gender").value="";
  filesState.splice(0, filesState.length);
  renderCards();
  document.getElementById("reportWrap").style.display = "none";
  document.getElementById("reportHTML").innerHTML = "";
  document.getElementById("jsonOut").textContent = "";
  window.scrollTo({ top: 0, behavior: "smooth" });
});
</script>
</body>
</html>
