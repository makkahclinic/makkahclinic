<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
  <style>
    :root{--fg:#111;--muted:#6b7280;--border:#e5e7eb;--bg:#f8fafc}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic","Noto Sans Arabic",Tahoma,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0}
    header{padding:16px 20px;border-bottom:1px solid var(--border);background:#fff}
    h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:10px;margin-bottom:16px}
    .card header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding:12px 16px}
    .card .body{padding:14px 16px}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input[type=file],select,textarea,button{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .muted{color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .area{min-height:160px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
    .btn.sec{background:#fff;color:#111}
    .log{background:#0b1220;color:#cbd5e1;border-radius:10px;padding:12px;min-height:120px;white-space:pre-wrap;overflow:auto}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px dashed var(--border);border-radius:999px;background:#fafafa}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .foot{font-size:12px;color:var(--muted);padding:6px 0}
  </style>

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js" crossorigin="anonymous"></script>
  <script>
    // تعيين عامل PDF.js الصحيح — يمنع خطأ "pdfjsLib is not defined"
    // Official guidance: set GlobalWorkerOptions.workerSrc to the same version as the pdf.js script.  :contentReference[oaicite:5]{index=5}
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js";
  </script>
</head>
<body>
  <header>
    <h1>تحليل الحالات الطبية (Gemini &amp; GPT‑4o)</h1>
  </header>

  <main>
    <div class="card">
      <header>
        <div>
          <div class="muted">* المعالجة على الجهاز + الخادم؛ * التقرير تعليمي ويُراجع سريريًا قبل أي قرار؛ * إزالة PHI تلقائيًا.</div>
        </div>
        <span class="badge">API Version: v6.0</span>
      </header>
      <div class="body">
        <div class="row">
          <div class="col-12">
            <label>اختر ملفات (صورة/‏PDF):</label>
            <input id="fileInput" type="file" accept=".pdf,image/*" multiple />
            <div class="foot">سيُحوَّل أي PDF إلى صور، ويُستخرج نصّه لرفع الدقة (PDF.js).</div>
          </div>

          <div class="col-4">
            <label>اللغة:</label>
            <select id="lang">
              <option value="ar" selected>العربية</option>
              <option value="en">English</option>
            </select>
          </div>

          <div class="col-4">
            <label>النموذج:</label>
            <select id="model">
              <option value="both" selected>Gemini + GPT‑4o</option>
              <option value="gpt">GPT‑4o فقط</option>
              <option value="gemini">Gemini فقط</option>
            </select>
          </div>

          <div class="col-4">
            <label>التخصص (اختياري):</label>
            <input id="specialty" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
          </div>

          <div class="col-12">
            <label>وصف مختصر/سياق التأمين (اختياري):</label>
            <textarea id="context" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما"></textarea>
          </div>

          <div class="col-12 actions">
            <button id="prepBtn" class="btn sec">تحضير الملفات</button>
            <button id="analyzeBtn" class="btn">تحليل الحالة</button>
            <span class="pill"><span id="prepBadge">لم يتم التحضير</span></span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <header><strong>النتيجة المدمجة</strong></header>
      <div class="body">
        <textarea id="merged" class="mono area" placeholder="—"></textarea>
        <div class="actions">
          <button class="btn sec" onclick="copyText('merged')">نسخ</button>
          <button class="btn sec" onclick="downloadJSON('merged','merged_report.json')">تنزيل JSON</button>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <header><strong>مخرجات GPT‑4o</strong></header>
        <div class="body">
          <textarea id="gptOut" class="mono area" placeholder="—"></textarea>
          <div class="actions">
            <button class="btn sec" onclick="copyText('gptOut')">نسخ</button>
            <button class="btn sec" onclick="downloadJSON('gptOut','gpt_report.json')">تنزيل</button>
          </div>
        </div>
      </div>

      <div class="card">
        <header><strong>مخرجات Gemini</strong></header>
        <div class="body">
          <textarea id="gmOut" class="mono area" placeholder="—"></textarea>
          <div class="actions">
            <button class="btn sec" onclick="copyText('gmOut')">نسخ</button>
            <button class="btn sec" onclick="downloadJSON('gmOut','gemini_report.json')">تنزيل</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <header><strong>السجل</strong></header>
      <div class="body">
        <div id="log" class="log">جاهز.</div>
      </div>
    </div>

    <div class="foot">
      * يدعم إدخال **صور + PDF** وتحليل متعدد الصفحات/الزيارات داخل الورقة نفسها.  
      * استخدام الصور مع Chat Completions عبر `image_url` (بيانات base64) موثق رسميًا، وإرسال الصور لـGemini عبر `inlineData`. الروابط في **المراجع** أدناه. :contentReference[oaicite:6]{index=6}
    </div>
  </main>

  <script>
    const logEl = document.getElementById('log');
    const fileInput = document.getElementById('fileInput');
    const prepBadge = document.getElementById('prepBadge');

    let prepared = { images: [], pdfText: "", totalBytes: 0, pages: 0 };

    function log(msg){ logEl.textContent += "\\n" + msg; logEl.scrollTop = logEl.scrollHeight; }
    function copyText(id){ const ta=document.getElementById(id); ta.select(); document.execCommand('copy'); }
    function downloadJSON(id, name){
      try {
        const obj = JSON.parse(document.getElementById(id).value || "{}");
        const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
      } catch(e){ alert('JSON غير صالح'); }
    }

    document.getElementById('prepBtn').addEventListener('click', prepFiles);
    document.getElementById('analyzeBtn').addEventListener('click', analyze);

    async function prepFiles(){
      prepared = { images: [], pdfText: "", totalBytes: 0, pages: 0 };
      const files = Array.from(fileInput.files || []);
      if (!files.length){ alert('اختر ملفًا واحدًا على الأقل'); return; }
      log('بدء التحضير ...');

      for (const f of files){
        if (f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')){
          await handlePDF(f);
        } else if (f.type.startsWith('image/')){
          const img = await imageToDataURL(f, 1400, 0.82);
          prepared.images.push(img.dataURL);
          prepared.totalBytes += img.bytes;
          prepared.pages += 1;
          log(`✓ صورة: ${f.name} (${(img.bytes/1024).toFixed(0)} KB)`);
        } else {
          log(`تجاهل ${f.name} (ليس صورة/‏PDF).`);
        }
      }

      prepBadge.textContent = `جُهّز ${prepared.pages} صورة/صفحة + نص PDF للتحليل. الحجم ≈ ${(prepared.totalBytes/1024).toFixed(0)} KB`;
      log('اكتمل التحضير.');
    }

    async function handlePDF(file){
      const arrayBuf = await file.arrayBuffer();
      prepared.totalBytes += arrayBuf.byteLength;

      const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
      log(`> تحويل PDF واستخراج نص: ${file.name} — ${pdf.numPages} صفحة`);

      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 2.0 });    // جودة جيدة للصورة
        // رسم إلى canvas ثم تحويل إلى JPEG مضغوط
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = Math.min(1600, viewport.width);
        const scale = canvas.width / viewport.width;
        canvas.height = Math.floor(viewport.height * scale);
        await page.render({ canvasContext: ctx, viewport: page.getViewport({ scale }) }).promise;

        const dataURL = canvas.toDataURL('image/jpeg', 0.82);
        prepared.images.push(dataURL);
        prepared.totalBytes += Math.ceil((dataURL.length*3)/4);
        prepared.pages += 1;

        // استخراج النص من الصفحة
        const textContent = await page.getTextContent();
        const text = textContent.items.map(it => it.str).join(' ');
        prepared.pdfText += `\\n\\n[PDF Page ${p}]\\n` + redactPHI(text);
        log(`✓ رُفعت صفحة ${p}/${pdf.numPages} من ${file.name}`);
      }
    }

    function redactPHI(text){
      // حذف أسماء/أرقام/تواريخ ظاهرة (إخفاء خفيف، التحليل لا يعتمد عليها)
      return (text || "")
        .replace(/[A-Z]{2,}[A-Za-z\\s]+\\d{2,}|\\b\\d{9,}\\b/g, '[REDACTED]')
        .replace(/\\b\\d{2}\\/\\d{2}\\/\\d{2,4}\\b/g, '[REDACTED-DATE]');
    }

    function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

    async function analyze(){
      if (!prepared.images.length && !prepared.pdfText.trim()){
        alert('اضغط "تحضير الملفات" أولًا'); return;
      }
      const model = document.getElementById('model').value;
      const lang = document.getElementById('lang').value;
      const specialty = document.getElementById('specialty').value.trim();
      const context = document.getElementById('context').value.trim();

      log('بدء التحليل ...');

      const payload = {
        language: lang, model, specialty, context,
        images: prepared.images, pdfText: prepared.pdfText.slice(0, 80_000) // حِماية حجم الطلب
      };

      const res = await fetch('/api/gpt', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const data = await res.json().catch(()=> ({}));

      if (data.error){ alert(data.error); log('خطأ: '+data.error); return; }

      // عرض المخرجات
      document.getElementById('gptOut').value   = data.gpt_json ? JSON.stringify(data.gpt_json, null, 2) : '';
      document.getElementById('gmOut').value    = data.gem_json ? JSON.stringify(data.gem_json, null, 2) : '';
      document.getElementById('merged').value   = data.merged   ? JSON.stringify(data.merged, null, 2)   : '';

      log('اكتمل التحليل.');
    }

    // أداة مساعدة: تحويل صورة ملف إلى DataURL مضغوط
    async function imageToDataURL(file, maxW=1400, quality=0.82){
      const img = document.createElement('img');
      const reader = new FileReader();
      const dataURL = await new Promise((resolve,reject)=>{
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
      img.src = dataURL;
      await new Promise(r => img.onload = r);

      const scale = Math.min(1, maxW / img.naturalWidth);
      const canvas = document.createElement('canvas');
      canvas.width = Math.floor(img.naturalWidth * scale);
      canvas.height = Math.floor(img.naturalHeight * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      const out = canvas.toDataURL('image/jpeg', quality);
      const bytes = Math.ceil((out.length*3)/4);
      return { dataURL: out, bytes };
    }
  </script>
</body>
</html>
