<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© - GPT</title>
  <style>
    :root {
      --primary-color: #0056b3;
      --secondary-color: #dc3545;
      --background-color: #f4f7f9;
      --text-color: #333;
      --card-bg-color: #ffffff;
      --border-color: #e0e0e0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 1rem;
    }
    .container {
      max-width: 900px;
      margin: 2rem auto;
      background-color: var(--card-bg-color);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 2rem;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    textarea, input, select {
      width: 100%;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2);
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .button-group {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-top: 2rem;
    }
    button {
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
    }
    button:active {
        transform: scale(0.98);
    }
    .btn-primary { background-color: var(--primary-color); }
    .btn-primary:hover { background-color: #004494; }
    .btn-danger { background-color: var(--secondary-color); }
    .btn-danger:hover { background-color: #c82333; }

    /* --- NEW STYLES FOR IMAGE UPLOAD --- */
    .image-upload-container {
        margin-top: 1.5rem;
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s, background-color 0.3s;
    }
    .image-upload-container:hover {
        border-color: var(--primary-color);
        background-color: #f8f9fa;
    }
    #image-upload-input {
        display: none;
    }
    #image-preview-container {
        margin-top: 1rem;
        text-align: center;
    }
    #image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        display: none; /* Hidden by default */
    }
    
    /* Report Styles */
    #response-container {
        margin-top: 2rem;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: #fdfdfd;
        display: none; /* Hidden by default */
    }
    #response-container h3 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; margin-top: 0; }
    #response-container h4 { color: #17a2b8; margin-top: 1.5rem; }
    #response-container p { line-height: 1.7; }
    #response-container .section { margin-bottom: 1.5rem; }
    #response-container .risk-high { color: #dc3545; font-weight: bold; }
    #response-container .risk-medium { color: #ffc107; font-weight: bold; }
    #response-container .risk-low { color: #28a745; font-weight: bold; }
    #response-container ul { padding-right: 20px; }
    #response-container li { margin-bottom: 0.75rem; }
    #response-container .financial-summary table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    #response-container .financial-summary th, #response-container .financial-summary td { border: 1px solid var(--border-color); padding: 0.8rem; text-align: right; }
    #response-container .financial-summary th { background-color: #f8f9fa; font-weight: 600; }
    #response-container .recommendation { background: #e9f7fd; padding: 1rem; border-radius: 8px; border-right: 4px solid #17a2b8; margin-bottom: 1rem; }
    
    /* Notification Styles */
    .notification {
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 8px;
        text-align: center;
        display: none; /* Hidden by default */
    }
    .notification.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .notification.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    
    #user-info { margin-bottom: 2rem; color: #555; font-size: 0.9rem; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© - Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠ</h2>
    <div id="user-info">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</div>

    <label for="diagnosis">ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø±Ø¶ (ICD-10):</label>
    <input type="text" id="diagnosis" placeholder="Ù…Ø«Ø§Ù„: Z01.0 Ø£Ùˆ Ø¬ÙØ§Ù Ø§Ù„Ø¹ÙŠÙ†" />

    <label for="symptoms">Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶:</label>
    <textarea id="symptoms" placeholder="Ù…Ø«Ø§Ù„: ØºØ¨Ø§Ø´ ÙÙŠ Ø§Ù„Ø±Ø¤ÙŠØ©ØŒ Ø­ÙƒØ©ØŒ Ø§Ø­Ù…Ø±Ø§Ø±"></textarea>

    <!-- --- NEW IMAGE UPLOAD SECTION --- -->
    <label for="image-upload-input">Ø£Ùˆ Ù‚Ù… Ø¨Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
    <div class="image-upload-container" onclick="document.getElementById('image-upload-input').click();">
        <span>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</span>
        <input type="file" id="image-upload-input" accept="image/*">
    </div>
    <div id="image-preview-container">
        <img id="image-preview" src="#" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" />
    </div>
    <!-- --- END OF NEW SECTION --- -->

    <label for="age">Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶:</label>
    <input type="number" id="age" placeholder="Ù…Ø«Ø§Ù„: 35" />

    <label for="gender">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙŠØ¶:</label>
    <select id="gender">
      <option value="" disabled selected>Ø§Ø®ØªØ±...</option>
      <option value="male">Ø°ÙƒØ±</option>
      <option value="female">Ø£Ù†Ø«Ù‰</option>
    </select>

    <label for="smoker">Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¯Ø®Ù†ØŸ</label>
    <select id="smoker">
      <option value="" disabled selected>Ø§Ø®ØªØ±...</option>
      <option value="yes">Ù†Ø¹Ù…</option>
      <option value="no">Ù„Ø§</option>
    </select>

    <label for="beforeProcedure">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ:</label>
    <textarea id="beforeProcedure" placeholder="Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ùˆ Ø£Ø¯ÙˆÙŠØ© ØªÙ… Ø§ØªØ®Ø§Ø°Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø­Ø§Ù„ÙŠ"></textarea>

    <label for="afterProcedure">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´Ø®ÙŠØµ:</label>
    <textarea id="afterProcedure" placeholder="Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙŠ Ù‚Ø§Ù… Ø¨Ù‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨"></textarea>

    <div class="button-group">
        <button onclick="analyzeCase()" class="btn-primary">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
        <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="notification-area"></div>
    <div id="response-container"></div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
      authDomain: "insurance-check-6cec9.firebaseapp.com",
      projectId: "insurance-check-6cec9",
      storageBucket: "insurance-check-6cec9.appspot.com",
      messagingSenderId: "992769471393",
      appId: "1:992769471393:web:c8a9400210a0e7901011e0",
      measurementId: "G-LMS6VRSTT6"
    };

    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getAuth, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- Authentication Logic ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("user-info").textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${user.email}`;
      } else {
        // FIX: Use a hardcoded, full URL to ensure validity in all environments.
        // Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· ÙƒØ§Ù…Ù„ ÙˆØ«Ø§Ø¨Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª.
        window.location.href = "http://www.m2020m.org/login.html";
      }
    });

    window.logout = () => {
      signOut(auth).then(() => {
        showNotification("info", "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.");
        // FIX: Use a hardcoded, full URL to ensure validity in all environments.
        // Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· ÙƒØ§Ù…Ù„ ÙˆØ«Ø§Ø¨Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª.
        setTimeout(() => window.location.href = "http://www.m2020m.org/login.html", 1500);
      });
    };

    // --- NEW SCRIPT FOR IMAGE PREVIEW ---
    const imageInput = document.getElementById('image-upload-input');
    const imagePreview = document.getElementById('image-preview');
    
    let imageDataUrl = null; // Variable to store the image data

    imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                // Store the Base64 string, removing the prefix
                imageDataUrl = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }
    });

    // --- Notification Function ---
    function showNotification(type, message) {
        const notificationArea = document.getElementById('notification-area');
        const notificationDiv = document.createElement('div');
        notificationDiv.className = `notification ${type}`;
        notificationDiv.textContent = message;
        
        notificationArea.innerHTML = '';
        notificationArea.appendChild(notificationDiv);
        notificationDiv.style.display = 'block';
    }

    // --- Main Analysis Function ---
    async function analyzeCase() {
      const diagnosis = document.getElementById('diagnosis').value;
      const symptoms = document.getElementById('symptoms').value;
      const age = document.getElementById('age').value;
      const gender = document.getElementById('gender').value;
      const smoker = document.getElementById('smoker').value === 'yes';
      const beforeProcedure = document.getElementById('beforeProcedure').value;
      const afterProcedure = document.getElementById('afterProcedure').value;

      const responseContainer = document.getElementById('response-container');
      const notificationArea = document.getElementById('notification-area');
      
      responseContainer.style.display = 'none';
      responseContainer.innerHTML = '';
      notificationArea.innerHTML = '';

      // MODIFIED: Check if either text fields OR an image is provided.
      if ((!diagnosis && !symptoms) && !imageDataUrl) {
        showNotification("error", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ØµÙŠØ© Ø£Ùˆ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ù…Ø·Ø§Ù„Ø¨Ø©.");
        return;
      }
      
      showNotification("info", "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„Ø£Ù…Ø± Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª...");

      try {
        if (!auth.currentUser) {
            throw new Error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡.");
        }
        const token = await auth.currentUser.getIdToken();
        const userEmail = auth.currentUser.email;

        const requestBody = { 
            diagnosis, 
            symptoms, 
            age, 
            gender, 
            smoker, 
            beforeProcedure, 
            afterProcedure,
            userEmail,
            imageData: imageDataUrl // Send the Base64 image data
        };

        const result = await fetch("/api/gpt", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(requestBody)
        });
        // Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ÙƒØªÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
if (!result.ok) {
    let errorMessage = `Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: ${result.status} ${result.statusText}`;
    try {
        // Ø­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙƒÙ€ JSONØŒ ÙÙ‡Ø°Ø§ Ù…Ø§ ÙŠØ±Ø³Ù„Ù‡ ÙƒÙˆØ¯ api/gpt.js Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const errorData = await result.json();
        // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        errorMessage = errorData.detail || errorData.error || errorMessage;
    } catch (e) {
        // Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ JSONØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø±Ø³Ù„ Ø®Ø·Ø£ Ù†ØµÙŠÙ‹Ø§ Ø£Ùˆ HTML
        // Ø§Ù‚Ø±Ø£Ù‡ ÙƒÙ†Øµ Ø¹Ø§Ø¯ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ
        const errorText = await result.text();
        errorMessage = errorText || errorMessage;
    }
    // Ø§Ø±Ù…Ù Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªÙ…ÙƒÙ†Ø§ Ù…Ù† Ø§Ø³ØªØ®Ù„Ø§ØµÙ‡Ø§
    throw new Error(errorMessage);
}

        const json = await result.json();

        if (json.htmlReport) {
            notificationArea.innerHTML = '';
            responseContainer.innerHTML = json.htmlReport;
            responseContainer.style.display = 'block';
        } else {
            throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….");
        }

      } catch (err) {
        showNotification("error", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: " + err.message);
        console.error(err);
      }
    }

    window.analyzeCase = analyzeCase;
  </script>
</body>
</html>
/* --- ğŸš€ NEW EXPERT REPORT STYLES --- */
.audit-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.95rem;
}
.audit-table th, .audit-table td {
    border: 1px solid var(--border-color);
    padding: 0.8rem 1rem;
    text-align: right;
    vertical-align: top;
}
.audit-table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
.audit-table td strong {
    font-weight: 700;
}
/* Color coding for table rows */
.audit-table .risk-red { background-color: #f8d7da; }
.audit-table .risk-yellow { background-color: #fff3cd; }
.audit-table .risk-green { background-color: #d4edda; }

.recommendation-card {
    background-color: #e9f7fd;
    border: 1px solid #bee5eb;
    border-right: 5px solid #17a2b8;
    padding: 1.5rem;
    margin-top: 1rem;
    border-radius: 8px;
}
.recommendation-card h5 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: #0c5460;
    font-size: 1.1rem;
}
.financial-summary .financial-red {
    color: #721c24;
    font-weight: bold;
}
.financial-summary .financial-green {
    color: #155724;
    font-weight: bold;
}
#response-container h3 svg {
    width: 28px;
    height: 28px;
    vertical-align: middle;
    margin-left: 10px;
}
