<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام مراجعة جودة الرعاية الطبية - مجمع مكة الطبي</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>

  <style>
    :root {
      --primary: #1e3a5f;
      --primary-light: #2d4a6f;
      --gold: #c9a962;
      --gold-light: #d4b872;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #eab308;
      --info: #3b82f6;
      --bg: #0f1a2b;
      --card-bg: #1a2d4a;
      --text: #ffffff;
      --text-muted: #94a3b8;
      --border: rgba(201, 169, 98, 0.3);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Tajawal", sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #152238 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      padding: 1.5rem 0;
      border-bottom: 3px solid var(--gold);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .header-content {
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;
    }
    .logo-section { display: flex; align-items: center; gap: 1rem; }
    .logo-section img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--gold); }
    .logo-section h1 { font-size: 1.5rem; color: var(--gold); }
    .logo-section p { font-size: 0.9rem; color: var(--text-muted); }
    .home-btn {
      display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem;
      background: var(--gold); color: var(--primary); border-radius: 12px; text-decoration: none;
      font-weight: 700; transition: all 0.3s;
    }
    .home-btn:hover { background: var(--gold-light); transform: translateY(-2px); }

    .main-content { padding: 2rem 0; }
    
    .hero-card {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 2rem; margin-bottom: 2rem;
      border: 1px solid var(--border);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      text-align: center;
    }
    .hero-card h2 { font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem; }
    .hero-card p { color: var(--text-muted); font-size: 1.1rem; max-width: 700px; margin: 0 auto; }
    .hero-icons { display: flex; justify-content: center; gap: 2rem; margin-top: 1.5rem; flex-wrap: wrap; }
    .hero-icon {
      display: flex; flex-direction: column; align-items: center; gap: 0.5rem;
      padding: 1rem; background: rgba(201, 169, 98, 0.1); border-radius: 12px;
      min-width: 100px;
    }
    .hero-icon i { font-size: 2rem; color: var(--gold); }
    .hero-icon span { font-size: 0.85rem; color: var(--text-muted); }

    .upload-section {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 2rem; margin-bottom: 2rem;
      border: 1px solid var(--border);
    }
    .section-title {
      display: flex; align-items: center; gap: 0.75rem;
      font-size: 1.3rem; color: var(--gold); margin-bottom: 1.5rem;
      padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);
    }
    .section-title i { font-size: 1.5rem; }

    .uploader {
      border: 2px dashed var(--gold);
      border-radius: 16px;
      padding: 3rem 2rem;
      text-align: center;
      background: rgba(201, 169, 98, 0.05);
      cursor: pointer;
      transition: all 0.3s;
    }
    .uploader:hover, .uploader.drag {
      background: rgba(201, 169, 98, 0.15);
      border-color: var(--gold-light);
      transform: scale(1.01);
    }
    .uploader input { display: none; }
    .uploader i { font-size: 3rem; color: var(--gold); margin-bottom: 1rem; display: block; }
    .uploader h3 { color: var(--text); margin-bottom: 0.5rem; }
    .uploader p { color: var(--text-muted); font-size: 0.9rem; }
    .file-types { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
    .file-type {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.8rem;
    }
    .file-type i { color: var(--gold); }

    .files-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .file-card {
      position: relative;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }
    .file-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .file-card img {
      width: 100%; height: 140px; object-fit: cover;
      border-bottom: 1px solid var(--border);
    }
    .file-card .meta {
      padding: 0.75rem; font-size: 0.8rem; color: var(--text-muted);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .file-card .remove {
      position: absolute; top: 8px; right: 8px;
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--error); color: white; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; transition: all 0.2s;
    }
    .file-card .remove:hover { background: #dc2626; transform: scale(1.1); }

    .analyze-section {
      display: flex; gap: 1rem; align-items: center; justify-content: center;
      flex-wrap: wrap; margin: 2rem 0;
    }
    .analyze-btn {
      display: inline-flex; align-items: center; gap: 0.75rem;
      padding: 1rem 2.5rem; font-size: 1.2rem; font-weight: 700;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: var(--primary); border: none; border-radius: 14px;
      cursor: pointer; transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(201, 169, 98, 0.4);
    }
    .analyze-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(201, 169, 98, 0.5);
    }
    .analyze-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .analyze-btn i { font-size: 1.3rem; }
    
    .status-msg {
      display: flex; align-items: center; gap: 0.5rem;
      color: var(--gold); font-size: 1rem;
    }
    .status-msg i { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .report-section {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 2rem; margin-top: 2rem;
      border: 1px solid var(--border);
      display: none;
    }
    .report-section.show { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .report-content {
      background: #ffffff;
      color: #1e293b;
      border-radius: 16px;
      padding: 2rem;
      line-height: 1.8;
    }
    .report-content h1 { color: var(--primary); font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; border-bottom: 3px solid var(--gold); padding-bottom: 1rem; }
    .report-content h2 { color: var(--primary); font-size: 1.4rem; margin: 1.5rem 0 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .report-content h3 { color: #334155; font-size: 1.1rem; margin: 1rem 0 0.5rem; }
    .report-content p { color: #475569; margin: 0.5rem 0; }
    .report-content ul { list-style: none; padding: 0; }
    .report-content li { padding: 0.75rem 1rem; margin: 0.5rem 0; border-radius: 8px; background: #f8fafc; border-right: 4px solid #cbd5e1; }
    .report-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    .report-content th, .report-content td { padding: 0.75rem; text-align: right; border: 1px solid #e2e8f0; }
    .report-content th { background: var(--primary); color: white; }
    .report-content tr:nth-child(even) { background: #f8fafc; }

    .report-actions {
      display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; flex-wrap: wrap;
    }
    .report-actions button {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.75rem 1.5rem; border-radius: 10px; border: none;
      cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.3s;
    }
    .btn-print { background: var(--info); color: white; }
    .btn-print:hover { background: #2563eb; }
    .btn-new { background: var(--success); color: white; }
    .btn-new:hover { background: #16a34a; }

    .powered-by {
      text-align: center; margin-top: 2rem; padding: 1rem;
      color: var(--text-muted); font-size: 0.85rem;
    }
    .powered-by img { height: 24px; vertical-align: middle; margin-right: 0.5rem; }

    @media (max-width: 768px) {
      .header-content { justify-content: center; text-align: center; }
      .logo-section { flex-direction: column; }
      .hero-card h2 { font-size: 1.5rem; }
      .uploader { padding: 2rem 1rem; }
      .analyze-btn { width: 100%; justify-content: center; }
    }

    @media print {
      body { background: white; }
      .header, .upload-section, .analyze-section, .report-actions, .powered-by { display: none !important; }
      .report-section { margin: 0; padding: 0; border: none; box-shadow: none; }
      .report-content { padding: 0; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo-section">
          <img src="https://www.m2020m.org/logo-transparent.png" alt="شعار المجمع">
          <div>
            <h1>نظام مراجعة جودة الرعاية الطبية</h1>
            <p>مجمع مكة الطبي بالزاهر</p>
          </div>
        </div>
        <a class="home-btn" href="https://www.m2020m.org/portal.html">
          <i class="fas fa-home"></i>
          <span>الرئيسية</span>
        </a>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      
      <div class="hero-card">
        <h2><i class="fas fa-stethoscope"></i> تحليل الحالات الطبية بالذكاء الاصطناعي</h2>
        <p>ارفع ملفات الحالة الطبية (وصفات، تحاليل، أشعة) واحصل على تقرير شامل لمراجعة جودة العلاج ومطابقة البروتوكولات الطبية</p>
        <div class="hero-icons">
          <div class="hero-icon">
            <i class="fas fa-prescription-bottle"></i>
            <span>الوصفات</span>
          </div>
          <div class="hero-icon">
            <i class="fas fa-vial"></i>
            <span>التحاليل</span>
          </div>
          <div class="hero-icon">
            <i class="fas fa-x-ray"></i>
            <span>الأشعة</span>
          </div>
          <div class="hero-icon">
            <i class="fas fa-clipboard-list"></i>
            <span>التقارير</span>
          </div>
        </div>
      </div>

      <div class="upload-section">
        <h3 class="section-title">
          <i class="fas fa-cloud-upload-alt"></i>
          رفع ملفات الحالة الطبية
        </h3>
        
        <label class="uploader" for="fileInput" id="dropZone">
          <i class="fas fa-file-upload"></i>
          <h3>اسحب وأفلت الملفات هنا</h3>
          <p>أو انقر للاختيار من جهازك</p>
          <input id="fileInput" type="file" multiple accept="image/*,application/pdf" />
          <div class="file-types">
            <span class="file-type"><i class="fas fa-image"></i> صور</span>
            <span class="file-type"><i class="fas fa-file-pdf"></i> PDF</span>
            <span class="file-type"><i class="fas fa-camera"></i> كاميرا</span>
          </div>
        </label>

        <div id="filesGrid" class="files-grid"></div>
      </div>

      <div class="analyze-section">
        <button class="analyze-btn" id="analyzeBtn" disabled>
          <i class="fas fa-brain"></i>
          <span>تحليل الحالة</span>
        </button>
        <div class="status-msg" id="statusMsg" style="display:none;">
          <i class="fas fa-spinner"></i>
          <span id="statusText">جاري التحليل...</span>
        </div>
      </div>

      <div class="report-section" id="reportSection">
        <h3 class="section-title">
          <i class="fas fa-clipboard-check"></i>
          تقرير مراجعة جودة الرعاية الطبية
        </h3>
        <div class="report-content" id="reportContent"></div>
        <div class="report-actions">
          <button class="btn-print" onclick="window.print()">
            <i class="fas fa-print"></i> طباعة التقرير
          </button>
          <button class="btn-new" onclick="resetAnalysis()">
            <i class="fas fa-plus"></i> تحليل جديد
          </button>
        </div>
      </div>

      <div class="powered-by">
        <i class="fas fa-robot"></i> مدعوم بالذكاء الاصطناعي Gemini 2.5 Flash
      </div>
    </div>
  </main>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

const API_URL = window.location.hostname.includes('m2020m.org') 
  ? 'https://makkahclinic.replit.app/api/medical-audit'
  : '/api/medical-audit';

const filesState = [];
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const filesGrid = document.getElementById('filesGrid');
const analyzeBtn = document.getElementById('analyzeBtn');
const statusMsg = document.getElementById('statusMsg');
const statusText = document.getElementById('statusText');
const reportSection = document.getElementById('reportSection');
const reportContent = document.getElementById('reportContent');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
});
dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag'));
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
dropZone.addEventListener('drop', e => {
  dropZone.classList.remove('drag');
  handleFiles(Array.from(e.dataTransfer.files));
});
fileInput.addEventListener('change', () => handleFiles(Array.from(fileInput.files)));

async function handleFiles(files) {
  statusText.textContent = 'جاري معالجة الملفات...';
  statusMsg.style.display = 'flex';

  for (const f of files) {
    if (f.type === 'application/pdf') {
      try {
        const arrayBuffer = await f.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(new Uint8Array(arrayBuffer)).promise;
        
        for (let i = 1; i <= pdf.numPages; i++) {
          statusText.textContent = `جاري معالجة صفحة ${i} من ${pdf.numPages}...`;
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          await page.render({ canvasContext: context, viewport: viewport }).promise;
          
          const base64Url = canvas.toDataURL('image/jpeg', 0.8);
          filesState.push({ 
            name: `${f.name} - صفحة ${i}`, 
            mimeType: 'image/jpeg', 
            data: base64Url 
          });
          renderFiles();
        }
      } catch(err) {
        console.error("PDF error:", err);
        alert(`خطأ في معالجة PDF: ${err.message}`);
      }
    } else {
      const base64Url = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = reject;
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(f);
      });
      filesState.push({ 
        name: f.name, 
        mimeType: f.type || 'image/jpeg', 
        data: base64Url 
      });
    }
  }
  
  renderFiles();
  statusMsg.style.display = 'none';
  fileInput.value = '';
}

function renderFiles() {
  filesGrid.innerHTML = '';
  filesState.forEach((f, i) => {
    const el = document.createElement('div');
    el.className = 'file-card';
    el.innerHTML = `
      <button class="remove" data-index="${i}" title="إزالة"><i class="fas fa-times"></i></button>
      <img src="${f.data}" alt="${f.name}">
      <div class="meta">${f.name}</div>
    `;
    filesGrid.appendChild(el);
  });
  
  filesGrid.querySelectorAll('.remove').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const i = +e.currentTarget.dataset.index;
      filesState.splice(i, 1);
      renderFiles();
    });
  });
  
  analyzeBtn.disabled = filesState.length === 0;
}

analyzeBtn.addEventListener('click', async () => {
  if (filesState.length === 0) return;
  
  analyzeBtn.disabled = true;
  statusText.textContent = 'جاري تحليل الحالة بالذكاء الاصطناعي...';
  statusMsg.style.display = 'flex';
  reportSection.classList.remove('show');

  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        files: filesState, 
        lang: 'ar' 
      })
    });

    const data = await resp.json();
    
    if (data.success) {
      reportContent.innerHTML = data.html;
      reportSection.classList.add('show');
      reportSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      throw new Error(data.error || 'فشل في التحليل');
    }

  } catch (err) {
    console.error('Analysis error:', err);
    reportContent.innerHTML = `
      <div style="background:#fee2e2;border:2px solid #ef4444;padding:2rem;border-radius:12px;text-align:center;">
        <h3 style="color:#dc2626;margin:0 0 1rem;"><i class="fas fa-exclamation-triangle"></i> حدث خطأ</h3>
        <p style="color:#7f1d1d;">${err.message}</p>
      </div>
    `;
    reportSection.classList.add('show');
  } finally {
    analyzeBtn.disabled = false;
    statusMsg.style.display = 'none';
  }
});

function resetAnalysis() {
  filesState.length = 0;
  renderFiles();
  reportSection.classList.remove('show');
  reportContent.innerHTML = '';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
</body>
</html>
