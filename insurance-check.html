<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="app-title">تقييم الحالة الطبية وطلبات التأمين</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* CSS Variables for a modern color scheme */
    :root {
      --primary-50: #f0f9ff; --primary-100: #e0f2fe; --primary-200: #bae6fd; --primary-300: #7dd3fc;
      --primary-400: #38bdf8; --primary-500: #0ea5e9; --primary-600: #0284c7; --primary-700: #0369a1;
      --primary-800: #075985; --primary-900: #0c4a6e;
      --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1;
      --gray-400: #94a3b8; --gray-500: #64748b; --gray-600: #475569; --gray-700: #334155;
      --gray-800: #1e293b; --gray-900: #0f172a;
      --success: #22c55e; --warning: #facc15; --danger: #ef4444;
      --card-bg: #fff; --ring: #93c5fd;
    }

    /* Base and Typography */
    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    body { font-family: "Tajawal", system-ui, sans-serif; background-color: var(--gray-50); color: var(--gray-900); margin: 0; padding: 0; line-height: 1.6; }
    html[dir="ltr"] body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
    h1, h2, h3 { font-weight: 700; margin: 0; line-height: 1.2; }

    /* Container & Layout */
    .container {
      max-width: 1100px; margin: 24px auto; padding: 24px; background: var(--card-bg);
      border: 1px solid var(--gray-200); border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }
    .topbar { display: flex; gap: 12px; align-items: center; margin-bottom: 20px; }
    .chip {
      display: inline-flex; align-items: center; padding: 6px 14px; border-radius: 9999px;
      background-color: var(--gray-100); color: var(--gray-600); font-size: 14px; font-weight: 500;
      cursor: pointer; transition: all 0.2s ease-in-out;
    }
    .chip:hover { background-color: var(--gray-200); color: var(--gray-700); }
    .home-link {
      display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px;
      background-color: var(--primary-600); color: #fff; border-radius: 12px;
      text-decoration: none; font-weight: 600; transition: all 0.2s ease-in-out;
    }
    .home-link:hover { background-color: var(--primary-700); }
    .home-link svg { width: 20px; height: 20px; fill: currentColor; }
    .main-title { font-size: 32px; text-align: center; color: var(--primary-800); margin-bottom: 8px; }
    .subtitle { font-size: 15px; color: var(--gray-500); text-align: center; margin-bottom: 24px; }
    .banner {
      display: flex; align-items: flex-start; gap: 12px; padding: 16px; background: var(--primary-50);
      border: 1px solid var(--primary-200); border-radius: 12px; color: var(--primary-900);
      font-size: 14px; margin-bottom: 24px;
    }
    .banner svg { flex-shrink: 0; width: 20px; height: 20px; fill: currentColor; }
    .section { margin-top: 24px; }
    .section-title {
      font-size: 20px; color: var(--primary-700); display: flex; align-items: center;
      gap: 10px; margin-bottom: 16px;
    }
    .section-title::before { content: ''; display: block; width: 10px; height: 10px; background-color: var(--primary-500); border-radius: 50%; }
    .card { padding: 24px; border-radius: 16px; border: 1px solid var(--gray-200); background: var(--gray-50); page-break-inside: avoid; }
    .grid { display: grid; gap: 20px; grid-template-columns: repeat(1, 1fr); }
    @media (min-width: 768px) { .grid { grid-template-columns: repeat(2, 1fr); } .grid .col-4 { grid-column: span 1; } .grid .col-6 { grid-column: span 1; } .grid .col-12 { grid-column: span 2; } }
    @media (min-width: 1024px) { .grid { grid-template-columns: repeat(3, 1fr); } .grid .col-4 { grid-column: span 1; } .grid .col-6 { grid-column: span 2; } .grid .col-12 { grid-column: span 3; } }
    
    /* Form Elements */
    label { display: block; font-size: 15px; color: var(--gray-700); font-weight: 500; margin-bottom: 8px; }
    input, select, textarea {
      width: 100%; padding: 14px; border: 1px solid var(--gray-300); border-radius: 12px;
      background: var(--card-bg); font-size: 15px; color: var(--gray-800); outline: none; transition: all 0.2s ease-in-out;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-500); box-shadow: 0 0 0 4px var(--ring); }
    textarea { min-height: 100px; resize: vertical; }
    
    /* File Uploader */
    .uploader {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 30px; border: 2px dashed var(--primary-300); border-radius: 16px;
      background: var(--primary-50); color: var(--primary-800); font-weight: 500; cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    .uploader:hover { border-color: var(--primary-400); background-color: var(--primary-100); }
    .uploader.drag { background-color: var(--primary-200); border-color: var(--primary-500); }
    .uploader input { display: none; }
    .file-cards {
      display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-top: 16px;
    }
    .file-card {
      position: relative; background: var(--card-bg); border: 1px solid var(--gray-200); border-radius: 14px;
      overflow: hidden; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); page-break-inside: avoid;
    }
    .file-thumb { width: 100%; height: 140px; object-fit: cover; display: block; background: var(--gray-100); }
    .file-meta { padding: 12px; font-size: 13px; color: var(--gray-700); }
    .file-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; direction: rtl; }
    .remove-btn {
      position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; border-radius: 50%;
      background: var(--danger); color: #fff; border: none; cursor: pointer; font-weight: 700; font-size: 16px;
    }

    /* Buttons */
    .btn {
      appearance: none; border: none; cursor: pointer; padding: 14px 24px; border-radius: 12px; font-weight: 700; transition: all 0.2s ease-in-out;
    }
    .btn-primary { background: var(--primary-600); color: #fff; }
    .btn-primary:hover { background: var(--primary-700); }
    .btn-secondary { background: var(--primary-900); color: #fff; }
    .btn-secondary:hover { background: var(--gray-800); }
    .btn-outline { background: #fff; color: var(--gray-800); border: 1px solid var(--gray-300); }
    .btn-outline:hover { background: var(--gray-100); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .busy-text { color: var(--gray-500); font-size: 14px; }

    /* Report Section */
    .report-wrap { margin-top: 32px; display: none; }
    .report-toolbar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    .report-content { width: 100%; max-width: 850px; margin: 0 auto; padding: 24px; border: 1px solid var(--gray-200); border-radius: 16px; background: #fff; }
    
    /* === هذا هو التعديل الأساسي === */
    /* قم بنقل قاعدة no-print إلى داخل media query لكي لا يتم تطبيقها إلا عند الطباعة */
    @media print {
      .no-print {
        display: none !important;
      }
      body {
        background: #fff;
      }
      .container, .container .report-wrap {
        box-shadow: none;
        border: none;
        padding: 0;
        margin: 0;
      }
      .report-wrap {
        display: block !important;
      }
      .report-content {
        border: none;
        padding: 0;
        margin: 0;
      }
      .avoid-break {
        page-break-inside: avoid;
        break-inside: avoid;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar no-print">
      <a class="home-link" href="https://www.m2020m.org/portal.html" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span data-translate="home_page">الصفحة الرئيسية</span>
      </a>
      <span class="chip" id="lang-switcher" data-translate="lang_english">English</span>
    </div>

    <h1 class="main-title" data-translate="main_title">تقييم الحالة الطبية وطلبات التأمين</h1>
    <p class="subtitle" data-translate="subtitle">واجهة إدخال سريرية سهلة — تحليل عميق متناغم مع احتياجات التأمين</p>

    <div class="banner">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2 1 21h22L12 2Zm1 15h-2v-2h2v2Zm0-4h-2V8h2v5Z"/></svg>
      <div data-translate="evidence_banner">يستند الحكم التأميني إلى أدلة موجزة من <b>WHO</b> و<b>CDC</b> و<b>Medscape</b>—ويظهر التبرير داخل الجدول.</div>
    </div>

    <div class="section">
      <h2 class="section-title"><span data-translate="patient_info_title"> 1) معلومات المريض</span></h2>
      <div class="card avoid-break">
        <div class="grid">
          <div class="col-4"><label data-translate="label_name">الاسم (اختياري)</label><input id="name" data-translate-placeholder="placeholder_name" placeholder="مثال: أحمد خالد" /></div>
          <div class="col-4">
            <label data-translate="label_gender">الجنس</label>
            <select id="gender">
              <option value="" data-translate="option_select">اختر</option>
              <option value="ذكر" data-translate="option_male">ذكر</option>
              <option value="أنثى" data-translate="option_female">أنثى</option>
            </select>
          </div>
          <div class="col-4"><label data-translate="label_age">العمر (بالسنوات)</label><input id="age" type="number" min="0" data-translate-placeholder="placeholder_age" placeholder="مثال: 63" /></div>
          <div class="col-4">
            <label data-translate="label_pregnant">هل المريضة حامل؟</label>
            <select id="pregnant">
              <option value="no" data-translate="option_no">لا</option>
              <option value="yes" data-translate="option_yes">نعم</option>
              <option value="na" data-translate="option_na">غير منطبق</option>
            </select>
          </div>
          <div class="col-4"><label data-translate="label_pregnancy_months">شهر الحمل (إن وُجد)</label><input id="pregnancyMonths" type="number" min="1" max="10" data-translate-placeholder="placeholder_pregnancy_months" placeholder="مثال: 5" /></div>
          <div class="col-4">
            <label data-translate="label_smoking">هل المريض مدخّن؟</label>
            <select id="smoking">
              <option value="" data-translate="option_select">اختر</option>
              <option value="مدخن" data-translate="option_smoker">مدخن</option>
              <option value="غير مدخن" data-translate="option_non_smoker">غير مدخن</option>
              <option value="سابق" data-translate="option_ex_smoker">سابق</option>
            </select>
          </div>
          <div class="col-4"><label data-translate="label_pack_years">Pack-Years (إن وُجد)</label><input id="packYears" type="number" min="0" step="0.5" data-translate-placeholder="placeholder_pack_years" placeholder="مثال: 15" /></div>
          <div class="col-4"><label data-translate="label_weight">الوزن (كجم)</label><input id="weight" type="number" min="0" step="0.1" data-translate-placeholder="placeholder_weight" placeholder="مثال: 78" /></div>
          <div class="col-4"><label data-translate="label_height">الطول (سم)</label><input id="height" type="number" min="0" step="0.5" data-translate-placeholder="placeholder_height" placeholder="مثال: 172" /></div>
          <div class="col-4"><label data-translate="label_temp">درجة الحرارة (°م)</label><input id="temp" type="number" step="0.1" data-translate-placeholder="placeholder_temp" placeholder="مثال: 37.4" /></div>
          <div class="col-4">
            <label data-translate="label_has_cough">هل يوجد سُعال؟</label>
            <select id="hasCough">
              <option value="" data-translate="option_select">اختر</option>
              <option value="نعم" data-translate="option_yes">نعم</option>
              <option value="لا" data-translate="option_no">لا</option>
            </select>
          </div>
          <div class="col-4"><label data-translate="label_cough_weeks">مدة السعال (أسابيع)</label><input id="coughWeeks" type="number" min="0" data-translate-placeholder="placeholder_cough_weeks" placeholder="مثال: 12" /></div>
          <div class="col-4">
            <label data-translate="label_cough_type">نوع السعال</label>
            <select id="coughType">
              <option value="" data-translate="option_select">اختر</option>
              <option value="جاف" data-translate="option_dry">جاف</option>
              <option value="ببلغم" data-translate="option_productive">ببلغم</option>
              <option value="بدم" data-translate="option_hemoptysis">بدم</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title"><span data-translate="timeline_symptoms_title"> 2) خطّ الحياة والأعراض</span></h2>
      <div class="card avoid-break">
        <div class="grid">
          <div class="col-12"><label data-translate="label_free_text">وصف الحالة (نص حر)</label><textarea id="freeText" data-translate-placeholder="placeholder_free_text" placeholder="مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن بسيط..."></textarea></div>
          <div class="col-6"><label data-translate="label_initial_dx">التشخيصات المبدئية (نص)</label><textarea id="initialDx" data-translate-placeholder="placeholder_initial_dx" placeholder="مثال: T2DM, HTN, COPD? Dermatitis"></textarea></div>
          <div class="col-6"><label data-translate="label_labs_imaging">تحاليل/الأشعة المذكورة (نص)</label><textarea id="labsImaging" data-translate-placeholder="placeholder_labs_imaging" placeholder="مثال: HbA1c 8.7%, eGFR 38→62, K 5.6 ..."></textarea></div>
          <div class="col-12"><label data-translate="label_orders">الأدوية/الإجراءات المقرّرة (إن وُجدت)</label><textarea id="orders" data-translate-placeholder="placeholder_orders" placeholder="مثال: Xigduo XR bid, Metformin 1000 tid ..."></textarea></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title"><span data-translate="file_upload_title"> 3) رفع ملفات (صور/PDF) — اختياري</span></h2>
      <label class="uploader" for="fileInput" id="dropZone" data-translate="uploader_text">
        اضغط هنا لرفع ملف واحد أو أكثر
        <input id="fileInput" type="file" multiple accept="image/*,application/pdf" />
      </label>
      <div id="cards" class="file-cards" aria-live="polite"></div>
      <div id="fileList" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="section btn-group no-print" style="margin-top: 24px;">
      <button class="btn btn-primary" id="analyzeBtn" data-translate="analyze_button">تحليل الحالة</button>
      <span id="busy" class="busy-text" style="display:none">
        <span class="spinner"></span>
        <span data-translate="analyzing_text">جاري التحليل…</span>
      </span>
    </div>

    <div id="reportWrap" class="report-wrap">
      <div class="report-toolbar no-print">
        <button class="btn btn-primary" id="exportServerBtn" data-translate="export_server_button">تصدير PDF (الخادم)</button>
        <button class="btn btn-outline" id="exportPdfBtn" data-translate="export_client_button">تصدير PDF (العميل)</button>
      </div>
      <div id="reportHTML" class="report-content avoid-break"></div>
      <details style="margin-top:16px" class="no-print">
        <summary style="font-size:14px; color:var(--primary-700); cursor:pointer;" data-translate="show_json_summary">إظهار JSON (للبحث/الإحصاءات)</summary>
        <pre id="jsonOut" style="white-space:pre-wrap; background:var(--gray-100); padding:16px; border-radius:12px; border:1px solid var(--gray-200); margin-top:12px; font-size:13px;"></pre>
      </details>
    </div>
  </div>

  <script>
    // ===== Internationalization (i18n) =====
    const translations = {
      ar: {
        app_title: "تقييم الحالة الطبية وطلبات التأمين", home_page: "الصفحة الرئيسية", lang_english: "English",
        main_title: "تقييم الحالة الطبية وطلبات التأمين", subtitle: "واجهة إدخال سريرية سهلة — تحليل عميق متناغم مع احتياجات التأمين",
        evidence_banner: "يستند الحكم التأميني إلى أدلة موجزة من <b>WHO</b> و<b>CDC</b> و<b>Medscape</b>—ويظهر التبرير داخل الجدول.",
        patient_info_title: "1) معلومات المريض", label_name: "الاسم (اختياري)", placeholder_name: "مثال: أحمد خالد",
        label_gender: "الجنس", option_select: "اختر", option_male: "ذكر", option_female: "أنثى",
        label_age: "العمر (بالسنوات)", placeholder_age: "مثال: 63", label_pregnant: "هل المريضة حامل؟",
        option_no: "لا", option_yes: "نعم", option_na: "غير منطبق", label_pregnancy_months: "شهر الحمل (إن وُجد)",
        placeholder_pregnancy_months: "مثال: 5", label_smoking: "هل المريض مدخّن؟", option_smoker: "مدخن",
        option_non_smoker: "غير مدخن", option_ex_smoker: "سابق", label_pack_years: "Pack-Years (إن وُجد)",
        placeholder_pack_years: "مثال: 15", label_weight: "الوزن (كجم)", placeholder_weight: "مثال: 78",
        label_height: "الطول (سم)", placeholder_height: "مثال: 172", label_temp: "درجة الحرارة (°م)",
        placeholder_temp: "مثال: 37.4", label_has_cough: "هل يوجد سُعال؟", label_cough_weeks: "مدة السعال (أسابيع)",
        placeholder_cough_weeks: "مثال: 12", label_cough_type: "نوع السعال", option_dry: "جاف",
        option_productive: "ببلغم", option_hemoptysis: "بدم", timeline_symptoms_title: "2) خطّ الحياة والأعراض",
        label_free_text: "وصف الحالة (نص حر)", placeholder_free_text: "مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن بسيط...",
        label_initial_dx: "التشخيصات المبدئية (نص)", placeholder_initial_dx: "مثال: T2DM, HTN, COPD? Dermatitis",
        label_labs_imaging: "تحاليل/الأشعة المذكورة (نص)", placeholder_labs_imaging: "مثال: HbA1c 8.7%, eGFR 38→62, K 5.6 ...",
        label_orders: "الأدوية/الإجراءات المقرّرة (إن وُجدت)", placeholder_orders: "مثال: Xigduo XR bid, Metformin 1000 tid ...",
        file_upload_title: "3) رفع ملفات (صور/PDF) — اختياري", uploader_text: "اضغط هنا لرفع ملف واحد أو أكثر",
        analyze_button: "تحليل الحالة", analyzing_text: "جاري التحليل…", export_server_button: "تصدير PDF (الخادم)",
        export_client_button: "تصدير PDF (العميل)", show_json_summary: "إظهار JSON (للبحث/الإحصاءات)",
      },
      en: {
        app_title: "Medical Case & Insurance Claim Assessment", home_page: "Home Page", lang_english: "العربية",
        main_title: "Medical Case & Insurance Claim Assessment", subtitle: "Easy clinical entry interface — Deep analysis aligned with insurance needs",
        evidence_banner: "Insurance judgment is based on concise evidence from <b>WHO</b>, <b>CDC</b>, and <b>Medscape</b>—justification appears within the table.",
        patient_info_title: "1) Patient Information", label_name: "Name (Optional)", placeholder_name: "e.g., John Doe",
        label_gender: "Gender", option_select: "Select", option_male: "Male", option_female: "Female",
        label_age: "Age (Years)", placeholder_age: "e.g., 63", label_pregnant: "Is the patient pregnant?",
        option_no: "No", option_yes: "Yes", option_na: "N/A", label_pregnancy_months: "Month of Pregnancy (if any)",
        placeholder_pregnancy_months: "e.g., 5", label_smoking: "Is the patient a smoker?", option_smoker: "Smoker",
        option_non_smoker: "Non-smoker", option_ex_smoker: "Ex-smoker", label_pack_years: "Pack-Years (if any)",
        placeholder_pack_years: "e.g., 15", label_weight: "Weight (kg)", placeholder_weight: "e.g., 78",
        label_height: "Height (cm)", placeholder_height: "e.g., 172", label_temp: "Temperature (°C)",
        placeholder_temp: "e.g., 37.4", label_has_cough: "Is there a cough?", label_cough_weeks: "Cough Duration (weeks)",
        placeholder_cough_weeks: "e.g., 12", label_cough_type: "Cough Type", option_dry: "Dry",
        option_productive: "Productive", option_hemoptysis: "Hemoptysis", timeline_symptoms_title: "2) Timeline & Symptoms",
        label_free_text: "Case Description (Free Text)", placeholder_free_text: "e.g., Chronic cough for 12 weeks with slight weight loss...",
        label_initial_dx: "Initial Diagnoses (Text)", placeholder_initial_dx: "e.g., T2DM, HTN, COPD? Dermatitis",
        label_labs_imaging: "Mentioned Labs/Imaging (Text)", placeholder_labs_imaging: "e.g., HbA1c 8.7%, eGFR 38→62, K 5.6 ...",
        label_orders: "Prescribed Meds/Procedures (if any)", placeholder_orders: "e.g., Xigduo XR bid, Metformin 1000 tid ...",
        file_upload_title: "3) Upload Files (Images/PDF) — Optional", uploader_text: "اضغط هنا لرفع ملف واحد أو أكثر",
        analyze_button: "تحليل الحالة", analyzing_text: "جاري التحليل…", export_server_button: "تصدير PDF (الخادم)",
        export_client_button: "تصدير PDF (العميل)", show_json_summary: "إظهار JSON (للبحث/الإحصاءات)",
      }
    };
    let currentLang = 'ar';
    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        if (translations[lang] && translations[lang][key]) el.innerHTML = translations[lang][key];
      });
      document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
        const key = el.getAttribute('data-translate-placeholder');
        if (translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
      });
      document.title = translations[lang].app_title;
    }
    document.getElementById('lang-switcher').addEventListener('click', () => {
      const newLang = currentLang === 'ar' ? 'en' : 'ar';
      setLanguage(newLang);
    });

    // Sync pregnancy with gender
    const genderEl = document.getElementById('gender');
    const pregSel = document.getElementById('pregnant');
    const pregMonths = document.getElementById('pregnancyMonths');
    function syncPregnancyControls() {
      const g = genderEl.value;
      if (g !== 'أنثى') {
        pregSel.value = 'na'; pregSel.disabled = true; pregMonths.value = ''; pregMonths.disabled = true;
      } else {
        pregSel.disabled = false;
        pregMonths.disabled = pregSel.value !== 'yes';
      }
    }
    genderEl.addEventListener('change', syncPregnancyControls);
    pregSel.addEventListener('change', () => { pregMonths.disabled = pregSel.value !== 'yes'; });
    syncPregnancyControls();

    // File Uploader Logic
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const cardsBox = document.getElementById('cards');
    const fileList = document.getElementById('fileList');
    const filesState = []; // { name, mimeType, data (base64) }
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => { window.addEventListener(ev, e => e.preventDefault()); });
    
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragenter', e => { e.preventDefault(); dropZone.classList.add('drag'); });
    dropZone.addEventListener('dragover', e => { e.preventDefault(); });
    dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('drag'); });
    dropZone.addEventListener('drop', async e => {
      e.preventDefault(); dropZone.classList.remove('drag');
      await handleFiles(Array.from(e.dataTransfer.files));
    });
    fileInput.addEventListener('change', async () => {
      await handleFiles(Array.from(fileInput.files));
      fileInput.value = '';
    });
    async function handleFiles(files) {
      for (const f of files) {
        const base64Url = await fileToDataURL(f);
        filesState.push({ name: f.name, mimeType: f.type || 'application/octet-stream', data: base64Url.split('base64,').pop() });
      }
      renderCards();
      fileList.textContent = filesState.map((f) => `• ${f.name}`).join('\n');
    }
    function renderCards() {
      cardsBox.innerHTML = '';
      filesState.forEach((f, i) => {
        const isImg = (f.mimeType || '').startsWith('image/');
        const thumbSrc = isImg ? `data:${f.mimeType};base64,${f.data}` : `data:image/svg+xml;utf8,${encodeURIComponent(
          `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="140" viewBox="0 0 200 140"><rect width="100%" height="100%" fill="#e2e8f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="12" fill="#64748b">${f.name}</text></svg>`
        )}`;
        const el = document.createElement('div');
        el.className = 'file-card avoid-break';
        el.innerHTML = `
          <button class="remove-btn" data-i="${i}" title="إزالة">×</button>
          <img class="file-thumb" src="${thumbSrc}" alt="${f.name}">
          <div class="file-meta">
            <div class="file-name" title="${f.name}">${f.name}</div>
          </div>`;
        cardsBox.appendChild(el);
      });
      cardsBox.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const i = +e.currentTarget.dataset.i;
        filesState.splice(i, 1);
        renderCards();
        fileList.textContent = filesState.map(f => `• ${f.name}`).join('\n');
      }));
    }
    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onerror = () => { console.error('Failed to read file', file?.name); reject(new Error('failed to read file')); };
        r.onload = () => resolve(r.result);
        r.readAsDataURL(file);
      });
    }

    // Build patientInfo object
    function buildPatientInfo() {
      const ageYears = Number(document.getElementById('age').value || NaN);
      const gender = document.getElementById('gender').value || null;
      const smokingStatus = document.getElementById('smoking').value || null;
      const packYears = document.getElementById('packYears').value ? Number(document.getElementById('packYears').value) : null;
      const temp = document.getElementById('temp').value ? Number(document.getElementById('temp').value) : null;
      const weight = document.getElementById('weight').value ? Number(document.getElementById('weight').value) : null;
      const height = document.getElementById('height').value ? Number(document.getElementById('height').value) : null;
      const hasCough = document.getElementById('hasCough').value || null;
      const coughWeeks = document.getElementById('coughWeeks').value ? Number(document.getElementById('coughWeeks').value) : null;
      const coughType = document.getElementById('coughType').value || null;
      const pVal = pregSel.value;
      const pregnant = (gender === 'أنثى') ? {
        isPregnant: pVal === 'yes',
        gestationalWeeks: (pVal === 'yes' && document.getElementById('pregnancyMonths').value) ? Number(document.getElementById('pregnancyMonths').value) * 4 : null
      } : null;
      return {
        name: document.getElementById('name').value || null, ageYears: isNaN(ageYears) ? null : ageYears, gender, pregnant,
        smoking: smokingStatus ? { status: smokingStatus, packYears } : null, temperatureC: temp, weightKg: weight, heightCm: height,
        cough: { has: hasCough, weeks: coughWeeks, type: coughType }
      };
    }

    // Main Analysis Function
    async function analyze() {
      const analyzeBtn = document.getElementById('analyzeBtn');
      const busy = document.getElementById('busy');
      analyzeBtn.disabled = true;
      busy.style.display = 'inline';
      try {
        const textParts = [];
        const ft = document.getElementById('freeText').value.trim(); if (ft) textParts.push(`وصف الحالة: ${ft}`);
        const dx = document.getElementById('initialDx').value.trim(); if (dx) textParts.push(`التشخيصات المبدئية: ${dx}`);
        const labs = document.getElementById('labsImaging').value.trim(); if (labs) textParts.push(`تحاليل/أشعة: ${labs}`);
        const orders = document.getElementById('orders').value.trim(); if (orders) textParts.push(`الأدوية/الإجراءات: ${orders}`);
        const mergedText = textParts.join('\n');

        const payload = {
          text: mergedText,
          patientInfo: buildPatientInfo(),
          files: filesState,
          lang: currentLang
        };

        const resp = await fetch('/api/gpt', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) {
           // هذا هو التحسين الجديد: عرض رسالة خطأ أكثر وضوحاً
           alert(`خطأ: ${resp.statusText || 'خطأ غير معروف'}. تفاصيل: ${data?.error || 'لا توجد تفاصيل.'}`);
           throw new Error(data?.error || `HTTP ${resp.status}`);
        }

        document.getElementById('reportWrap').style.display = 'block';
        document.getElementById('reportHTML').innerHTML = data.html || '';
        document.getElementById('jsonOut').textContent = JSON.stringify(data.structured || {}, null, 2);
      } catch (err) {
        // رسالة الخطأ هنا ستكون أكثر تفصيلاً الآن
        alert('خطأ: ' + err.message);
      } finally {
        analyzeBtn.disabled = false;
        busy.style.display = 'none';
      }
    }
    document.getElementById('analyzeBtn').addEventListener('click', analyze);

    // PDF Export (Server-side)
    document.getElementById('exportServerBtn').addEventListener('click', async () => {
      const reportElement = document.getElementById('reportHTML');
      if (!reportElement) { alert('التقرير غير جاهز للتصدير.'); return; }
      
      const btn = document.getElementById('exportServerBtn');
      btn.disabled = true;
      try {
        const html = `
          <!DOCTYPE html>
          <html lang="${currentLang}" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Medical Audit Report</title>
            <style>
              @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
              html, body {
                font-family: 'Tajawal', sans-serif;
                direction: ${currentLang === 'ar' ? 'rtl' : 'ltr'};
                color: #212529;
                margin: 0;
                padding: 0;
                line-height: 1.6;
              }
              body {
                padding: 2cm;
                box-sizing: border-box;
              }
              .report-section { margin-bottom: 24px; page-break-inside: avoid; }
              .report-section h2 { font-size: 20px; font-weight: bold; color: #0d47a1; border-bottom: 2px solid #0d47a1; padding-bottom: 8px; margin-bottom: 16px; }
              .audit-table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 14px; margin-top: 10px; }
              .audit-table th, .audit-table td { border: 1px solid #dee2e6; padding: 10px; text-align: ${currentLang === 'ar' ? 'right' : 'left'}; vertical-align: top; word-wrap: break-word; }
              .audit-table th { background-color: #f8f9fa; font-weight: bold; }
              .audit-table tr { page-break-inside: avoid; }
              .audit-table tr.risk-critical td { background-color: #fce8e6; }
              .audit-table tr.risk-warning td { background-color: #fff0e1; }
              .audit-table tr.risk-ok td { background-color: #e6f4ea; }
              .decision-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
              .rec-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; border-radius: 8px; background: #f8f9fa; border-right: 4px solid; margin-bottom: 12px; page-break-inside: avoid; }
              .rec-priority { flex-shrink: 0; font-weight: bold; padding: 4px 10px; border-radius: 8px; font-size: 12px; color: #fff; }
              .rec-priority.urgent, .rec-priority.عاجلة { background: #d93025; }
              .rec-priority.best-practice, .rec-priority.أفضل { background: #1e8e3e; }
              .rec-desc { color: #212529; font-size: 14px; }
            </style>
          </head>
          <body>
            ${reportElement.innerHTML}
          </body>
          </html>
        `;

        const resp = await fetch('/api/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ html, lang: currentLang })
        });
        if (!resp.ok) { throw new Error('HTTP ' + resp.status); }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Medical_Audit_Report.pdf';
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('حدث خطأ في تصدير الخادم: ' + e.message);
      } finally {
        btn.disabled = false;
      }
    });

    // PDF Export (Client-side, kept for compatibility but with a warning)
    document.getElementById('exportPdfBtn').addEventListener('click', async () => {
      const reportElement = document.getElementById('reportHTML');
      if (!reportElement) { alert('التقرير غير جاهز للتصدير.'); return; }
      
      const btn = document.getElementById('exportPdfBtn');
      btn.disabled = true;
      alert('قد يواجه هذا الخيار مشاكل في عرض الحروف العربية أو قص التقرير. يوصى باستخدام خيار "تصدير PDF (الخادم)".');
      const opt = {
        filename: 'Medical_Audit_Report.pdf', margin: 10, image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      try {
        await html2pdf().set(opt).from(reportElement).save();
      } catch (e) {
        alert('خطأ في التصدير (عميل): ' + e.message);
      } finally {
        btn.disabled = false;
      }
    });
    setLanguage('ar');
  </script>
</body>
</html>
