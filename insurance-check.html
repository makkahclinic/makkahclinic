// =================================================================================
// API ANALYSIS - FINAL CORRECTED VERSION
// =================================================================================
async function analyzeCase() {
  const responseContainer = document.getElementById('response-container');
  const btn = document.getElementById('analyzeBtn');
  const exportContainer = document.getElementById('export-container');
  
  clearNote();
  responseContainer.style.display = 'none';
  responseContainer.innerHTML = '';
  exportContainer.classList.add('hidden');

  // Combine all textual details into one rich notes field for the AI
  const detailedNotes = [
    document.getElementById('case-description').value,
    `Provisional Diagnoses: ${document.getElementById('diagnosis').value}`,
    `Available Lab Results: ${document.getElementById('lab-results').value}`,
    `Prescribed Medications/Procedures: ${document.getElementById('medications-procedures').value}`
  ].filter(text => text.trim() !== '' && !text.endsWith(': ')).join('\n---\n');

  // This object now collects data from ALL relevant form fields
  const caseData = {
    // Patient Info
    age: document.getElementById('age').value || null,
    gender: document.getElementById('gender').value || null,
    
    // Lifestyle & Symptoms
    isSmoker: document.getElementById('smoker').value === 'yes',
    packYears: document.getElementById('pack-years-result').textContent === '--' ? null : document.getElementById('pack-years-result').textContent,
    
    // All medical text is now in the 'notes' field
    notes: detailedNotes,
    
    // Files
    files: uploadedFiles.map(f => ({ name: f.file.name, type: f.file.type, data: f.base64 }))
  };

  const hasAnyInput = caseData.notes || caseData.files.length > 0;
  if (!hasAnyInput) {
    showNote('error', getTranslation('validation.error_formIncomplete'));
    return;
  }

  showNote('info', getTranslation('validation.info_analyzing'));
  btn.disabled = true;

  try {
    const response = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(caseData),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ detail: response.statusText }));
      throw new Error(`${response.status}: ${errorData.detail || 'Unknown server error'}`);
    }

    const result = await response.json();

    if (result?.htmlReport) {
      clearNote();
      // This is where you would inject the report into a div with the class "report-container"
      // to apply the front-end styling you asked about earlier.
      responseContainer.innerHTML = `<div class="report-container">${result.htmlReport}</div>`;
      responseContainer.style.display = 'block';
      exportContainer.classList.remove('hidden');
      responseContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      throw new Error(getTranslation('validation.error_missingReport'));
    }
  } catch (err) {
    console.error(err);
    showNote('error', getTranslation('validation.error_requestFailed') + err.message);
  } finally {
    btn.disabled = false;
  }
}
