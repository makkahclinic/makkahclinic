<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© - GPT</title>
Â  <style>
    /* ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø³ÙŠØ· Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø²Ø± Ø§Ù„Ù…Ø¹Ø·Ù„ */
Â  Â  :root {
Â  Â  Â  --primary-color: #0056b3;
Â  Â  Â  --secondary-color: #dc3545;
Â  Â  Â  --background-color: #f4f7f9;
Â  Â  Â  --text-color: #333;
Â  Â  Â  --card-bg-color: #ffffff;
Â  Â  Â  --border-color: #e0e0e0;
Â  Â  }
Â  Â  body {
Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
Â  Â  Â  background-color: var(--background-color);
Â  Â  Â  color: var(--text-color);
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 1rem;
Â  Â  }
Â  Â  .home-icon-link {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 25px;
Â  Â  Â  Â  right: 30px;
Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  display: block;
Â  Â  }
Â  Â  .home-icon-link svg {
Â  Â  Â  Â  width: 32px;
Â  Â  Â  Â  height: 32px;
Â  Â  Â  Â  fill: var(--primary-color);
Â  Â  Â  Â  transition: opacity 0.3s;
Â  Â  }
Â  Â  .home-icon-link:hover svg {
Â  Â  Â  Â  opacity: 0.7;
Â  Â  }
Â  Â  .container {
Â  Â  Â  max-width: 900px;
Â  Â  Â  margin: 2rem auto;
Â  Â  Â  background-color: var(--card-bg-color);
Â  Â  Â  padding: 2rem;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
Â  Â  }
Â  Â  h2 {
Â  Â  Â  text-align: center;
Â  Â  Â  color: var(--primary-color);
Â  Â  Â  margin-bottom: 2rem;
Â  Â  }
Â  Â  label {
Â  Â  Â  font-weight: 600;
Â  Â  Â  display: block;
Â  Â  Â  margin-top: 1.5rem;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  }
Â  Â  textarea, input, select {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.8rem 1rem;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  transition: border-color 0.3s, box-shadow 0.3s;
Â  Â  }
Â  Â  textarea:focus, input:focus, select:focus {
Â  Â  Â  outline: none;
Â  Â  Â  border-color: var(--primary-color);
Â  Â  Â  box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2);
Â  Â  }
Â  Â  textarea {
Â  Â  Â  min-height: 100px;
Â  Â  Â  resize: vertical;
Â  Â  }
Â  Â  .button-group {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  gap: 1rem;
Â  Â  Â  margin-top: 2rem;
Â  Â  }
Â  Â  button {
Â  Â  Â  padding: 1rem;
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  font-weight: bold;
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.3s, transform 0.1s;
Â  Â  }
    button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }
Â  Â  button:active {
Â  Â  Â  Â  transform: scale(0.98);
Â  Â  }
Â  Â  .btn-primary { background-color: var(--primary-color); }
Â  Â  .btn-primary:hover:not(:disabled) { background-color: #004494; }
Â  Â  .btn-danger { background-color: var(--secondary-color); }
Â  Â  .btn-danger:hover { background-color: #c82333; }
Â  Â  .file-upload-container {
Â  Â  Â  Â  margin-top: 1.5rem;
Â  Â  Â  Â  border: 2px dashed var(--border-color);
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  padding: 1.5rem;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: border-color 0.3s, background-color 0.3s;
Â  Â  }
Â  Â  .file-upload-container:hover {
Â  Â  Â  Â  border-color: var(--primary-color);
Â  Â  Â  Â  background-color: #f8f9fa;
Â  Â  }
Â  Â  #file-upload-input {
Â  Â  Â  Â  display: none;
Â  Â  }
Â  Â  #file-list-container {
Â  Â  Â  Â  margin-top: 1rem;
        padding: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid var(--border-color);
Â  Â  }
    #file-list-container p {
        margin: 0.5rem 0;
        font-size: 0.9rem;
    }
Â  Â  #response-container {
Â  Â  Â  Â  margin-top: 2rem;
Â  Â  Â  Â  padding: 1.5rem;
Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  background-color: #fdfdfd;
Â  Â  Â  Â  display: none;
Â  Â  }
Â  Â  /* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù„Ù… ØªØªØºÙŠØ± ... */
Â  </style>
</head>
<body>
Â  <a href="https://www.m2020m.org/portal.html" class="home-icon-link" title="Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
Â  </a>
Â  <div class="container">
Â  Â  <h2>Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© - Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠ</h2>
Â  Â  <div id="user-info">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</div>

Â  Â  <label for="diagnosis">ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø±Ø¶ (ICD-10):</label>
Â  Â  <input type="text" id="diagnosis" placeholder="Ù…Ø«Ø§Ù„: Z01.0 Ø£Ùˆ Ø¬ÙØ§Ù Ø§Ù„Ø¹ÙŠÙ†" />

Â  Â  <label for="symptoms">Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶:</label>
Â  Â  <textarea id="symptoms" placeholder="Ù…Ø«Ø§Ù„: ØºØ¨Ø§Ø´ ÙÙŠ Ø§Ù„Ø±Ø¤ÙŠØ©ØŒ Ø­ÙƒØ©ØŒ Ø§Ø­Ù…Ø±Ø§Ø±"></textarea>

    Â  Â  <label for="file-upload-input">Ø£Ùˆ Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© (ØµÙˆØ± Ø£Ùˆ PDF):</label>
Â  Â  <div class="file-upload-container" onclick="document.getElementById('file-upload-input').click();">
Â  Â  Â  Â  <span>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª</span>
        Â  Â  Â  Â  <input type="file" id="file-upload-input" accept="image/*,application/pdf" multiple>
Â  Â  </div>
    Â  Â  <div id="file-list-container" style="display: none;"></div>

Â  Â  Â  Â  <label for="age">Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶:</label>
Â  Â  <input type="number" id="age" placeholder="Ù…Ø«Ø§Ù„: 35" />

Â  Â  <label for="gender">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙŠØ¶:</label>
Â  Â  <select id="gender">
Â  Â  Â  <option value="" disabled selected>Ø§Ø®ØªØ±...</option>
Â  Â  Â  <option value="male">Ø°ÙƒØ±</option>
Â  Â  Â  <option value="female">Ø£Ù†Ø«Ù‰</option>
Â  Â  </select>

Â  Â  <label for="smoker">Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¯Ø®Ù†ØŸ</label>
Â  Â  <select id="smoker">
Â  Â  Â  <option value="" disabled selected>Ø§Ø®ØªØ±...</option>
Â  Â  Â  <option value="yes">Ù†Ø¹Ù…</option>
Â  Â  Â  <option value="no">Ù„Ø§</option>
Â  Â  </select>

Â  Â  <label for="beforeProcedure">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ:</label>
Â  Â  <textarea id="beforeProcedure" placeholder="Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ùˆ Ø£Ø¯ÙˆÙŠØ© ØªÙ… Ø§ØªØ®Ø§Ø°Ù‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø­Ø§Ù„ÙŠ"></textarea>

Â  Â  <label for="afterProcedure">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´Ø®ÙŠØµ:</label>
Â  Â  <textarea id="afterProcedure" placeholder="Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙŠ Ù‚Ø§Ù… Ø¨Ù‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨"></textarea>

Â  Â  <div class="button-group">
Â  Â  Â  Â  <button id="analyze-button" onclick="analyzeCase()" class="btn-primary">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
Â  Â  Â  Â  <button onclick="logout()" class="btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
Â  Â  </div>

Â  Â  <div id="notification-area"></div>
Â  Â  <div id="response-container"></div>
Â  </div>

Â  <script type="module">
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
Â  Â  Â  authDomain: "insurance-check-6cec9.firebaseapp.com",
Â  Â  Â  projectId: "insurance-check-6cec9",
Â  Â  Â  storageBucket: "insurance-check-6cec9.appspot.com",
Â  Â  Â  messagingSenderId: "992769471393",
Â  Â  Â  appId: "1:992769471393:web:c8a9400210a0e7901011e0",
Â  Â  Â  measurementId: "G-LMS6VRSTT6"
Â  Â  };

Â  Â  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
Â  Â  const { getAuth, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
Â  Â Â 
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const auth = getAuth(app);

Â  Â  // ... Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù… ÙŠØªØºÙŠØ± ...
    onAuthStateChanged(auth, (user) => { if (!user) { window.location.href = "http://www.m2020m.org/login.html"; } else { document.getElementById("user-info").textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${user.email}`; } });
    window.logout = () => { signOut(auth).then(() => { showNotification("info", "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­."); setTimeout(() => window.location.href = "http://www.m2020m.org/login.html", 1500); }); };

    // --- <<< ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ù…Ù†Ø·Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ >>> ---
Â  Â  const fileInput = document.getElementById('file-upload-input');
    const analyzeButton = document.getElementById('analyze-button');
    const fileListContainer = document.getElementById('file-list-container');
Â  Â Â 
Â  Â  let fileDataArray = []; // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª

Â  Â  fileInput.addEventListener('change', async (event) => {
        const files = event.target.files;
        if (!files || files.length === 0) {
            fileListContainer.style.display = 'none';
            fileDataArray = [];
            return;
        }

        analyzeButton.disabled = true;
        analyzeButton.textContent = `Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² ${files.length} Ù…Ù„Ù...`;
        fileListContainer.innerHTML = '<h4>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</h4>';
        fileListContainer.style.display = 'block';
        fileDataArray = [];

        // ğŸ‘‰ Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø²ÙŠØ¯ Ø¹Ù† `FileReader` Ù‡Ù†Ø§: https://developer.mozilla.org/en-US/docs/Web/API/FileReader
        const fileReadPromises = Array.from(files).map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const fileItem = document.createElement('p');
                    fileItem.textContent = `âœ… ${file.name} (${Math.round(file.size / 1024)} KB)`;
                    fileListContainer.appendChild(fileItem);
                    
                    // Ù†Ø±Ø³Ù„ ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†ÙØ³Ù‡Ø§
                    resolve({
                        mime_type: file.type,
                        data: reader.result.split(',')[1]
                    });
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        });

        try {
            fileDataArray = await Promise.all(fileReadPromises);
            analyzeButton.disabled = false;
            analyzeButton.textContent = 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©';
        } catch (error) {
            console.error("Error reading files:", error);
            showNotification('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø£Ø­Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª.');
            analyzeButton.disabled = false;
            analyzeButton.textContent = 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©';
        }
Â  Â  });

Â  Â  function showNotification(type, message) {
        const notificationArea = document.getElementById('notification-area');
        notificationArea.innerHTML = `<div class="notification ${type}" style="display: block;">${message}</div>`;
Â  Â  }

Â  Â  async function analyzeCase() {
Â  Â  Â  const diagnosis = document.getElementById('diagnosis').value;
Â  Â  Â  const symptoms = document.getElementById('symptoms').value;
Â  Â  Â  const age = document.getElementById('age').value;
Â  Â  Â  const gender = document.getElementById('gender').value;
Â  Â  Â  const smoker = document.getElementById('smoker').value === 'yes';
Â  Â  Â  const beforeProcedure = document.getElementById('beforeProcedure').value;
Â  Â  Â  const afterProcedure = document.getElementById('afterProcedure').value;

Â  Â  Â  const responseContainer = document.getElementById('response-container');
Â  Â  Â  const notificationArea = document.getElementById('notification-area');
Â  Â  Â Â 
Â  Â  Â  responseContainer.style.display = 'none';
Â  Â  Â  responseContainer.innerHTML = '';
Â  Â  Â  notificationArea.innerHTML = '';

Â  Â  Â  if ((!diagnosis && !symptoms) && fileDataArray.length === 0) {
Â  Â  Â  Â  showNotification("error", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ØµÙŠØ© Ø£Ùˆ Ø±ÙØ¹ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  showNotification("info", "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„Ø£Ù…Ø± Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª...");

Â  Â  Â  try {
Â  Â  Â  Â  if (!auth.currentUser) { throw new Error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡."); }
Â  Â  Â  Â  const token = await auth.currentUser.getIdToken();
Â  Â  Â  Â  const userEmail = auth.currentUser.email;
        
Â  Â  Â  Â  const requestBody = {Â 
Â  Â  Â  Â  Â  Â  diagnosis,Â 
Â  Â  Â  Â  Â  Â  symptoms,Â 
Â  Â  Â  Â  Â  Â  age,Â 
Â  Â  Â  Â  Â  Â  gender,Â 
Â  Â  Â  Â  Â  Â  smoker,Â 
Â  Â  Â  Â  Â  Â  beforeProcedure,Â 
Â  Â  Â  Â  Â  Â  afterProcedure,
Â  Â  Â  Â  Â  Â  userEmail,
            // <<< ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© `analysisType` ÙˆØ¥Ø±Ø³Ø§Ù„ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª >>>
            analysisType: 'doctor', // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
Â  Â  Â  Â  Â  Â  imageData: fileDataArray 
Â  Â  Â  Â  };

Â  Â  Â  Â  const result = await fetch("/api/gpt", {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
Â  Â  Â  Â  Â  body: JSON.stringify(requestBody)
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!result.ok) {
Â  Â  Â  Â  Â  const errorData = await result.json();
Â  Â  Â  Â  Â  throw new Error(errorData.detail || `Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: ${result.status}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  const json = await result.json();
Â  Â  Â  Â  if (json.htmlReport) {
Â  Â  Â  Â  Â  Â  notificationArea.innerHTML = '';
Â  Â  Â  Â  Â  Â  responseContainer.innerHTML = json.htmlReport;
Â  Â  Â  Â  Â  Â  responseContainer.style.display = 'block';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….");
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  showNotification("error", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: " + err.message);
Â  Â  Â  Â  console.error(err);
Â  Â  Â  }
Â  Â  }

Â  Â  window.analyzeCase = analyzeCase;
Â  </script>
</body>
</html>
