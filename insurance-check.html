<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تقييم الحالة الطبية وطلبات التأمين</title>
  <style>
    :root{
      --sea:#0ea5e9; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --soft:#f1f5f9; --dash:#cbd5e1;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Arabic", sans-serif; background:#f8fafc; color:var(--ink); margin:0}
    .wrap{max-width:1100px; margin:28px auto; padding:0 16px}
    h1{font-size:28px; color:#075985; margin:0 0 18px}

    /* Uploader */
    .upload-zone{border:2px dashed var(--dash); border-radius:16px; padding:22px; text-align:center; background:#f8fbff; color:var(--muted)}
    .upload-zone.drag{background:#eef6ff}
    .btn{appearance:none; border:0; border-radius:12px; padding:10px 16px; background:var(--sea); color:#fff; cursor:pointer; font-weight:700}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn-ghost{appearance:none; border:0; background:transparent; color:#075985; cursor:pointer}

    .grid{display:grid; gap:16px}
    .cards{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:16px; margin-top:16px}
    .card{position:relative; background:var(--card); border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; box-shadow:0 8px 20px rgba(2,6,23,.06)}
    .thumb{width:100%; height:150px; object-fit:cover; display:block; background:#f1f5f9}
    .meta{padding:10px 12px; font-size:13px; color:#334155; line-height:1.4}
    .remove{position:absolute; top:10px; left:10px; width:30px; height:30px; border-radius:50%; background:var(--bad); color:#fff; border:none; cursor:pointer; font-weight:700; display:flex; align-items:center; justify-content:center}
    .remove:hover{background:#dc2626}

    .panel{background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:14px 16px}
    textarea,input,select{width:100%; border:1px solid #e2e8f0; border-radius:12px; padding:10px 12px; background:#fff}

    .result{margin-top:22px}
    .result .panel{overflow:auto}
    .muted{color:var(--muted)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>تقييم الحالة الطبية وطلبات التأمين</h1>

    <div class="grid" style="margin-bottom:16px">
      <div class="panel">
        <label for="freeText" class="muted">وصف الحالة / ملاحظات إضافية (اختياري)</label>
        <textarea id="freeText" rows="4" placeholder="اكتب ملخص الحالة أو الصياغة السريرية هنا..."></textarea>
      </div>
    </div>

    <div class="panel">
      <div class="upload-zone" id="uploadZone">
        <input id="fileInput" type="file" multiple accept=".pdf,image/*" hidden>
        <button type="button" class="btn-ghost" id="pickFilesBtn">اضغط هنا لرفع ملف واحد أو أكثر</button>
      </div>
      <div class="cards" id="uploadsList" aria-live="polite"></div>
      <div style="margin-top:14px; display:flex; gap:10px; justify-content:flex-start">
        <button class="btn" id="analyzeBtn">تحليل الحالة</button>
        <span id="hint" class="muted"></span>
      </div>
    </div>

    <div class="result" id="result">
      <div class="panel muted">لم يتم التحليل بعد.</div>
    </div>
  </div>

  <script>
    // ===== الحالة المشتركة =====
    const filesState = []; // عناصر: { name, mimeType, data }

    // عناصر DOM
    const fileInput   = document.getElementById('fileInput');
    const pickBtn     = document.getElementById('pickFilesBtn');
    const uploadsList = document.getElementById('uploadsList');
    const uploadZone  = document.getElementById('uploadZone');
    const analyzeBtn  = document.getElementById('analyzeBtn');
    const resultBox   = document.getElementById('result');
    const hint        = document.getElementById('hint');

    // فتح المنتقي
    pickBtn.addEventListener('click', () => fileInput.click());

    // سحب وإفلات
    ['dragenter','dragover'].forEach(evt => uploadZone.addEventListener(evt, (e)=>{ e.preventDefault(); uploadZone.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(evt => uploadZone.addEventListener(evt, (e)=>{ e.preventDefault(); uploadZone.classList.remove('drag'); }));
    uploadZone.addEventListener('drop', (e)=> handleFiles(Array.from(e.dataTransfer.files)));

    // اختيار ملفات
    fileInput.addEventListener('change', (e)=>{ handleFiles(Array.from(e.target.files)); fileInput.value=''; });

    async function handleFiles(files){
      for (const f of files){
        const base64 = await fileToDataURL(f); // data:<mime>;base64,....
        filesState.push({ name: f.name, mimeType: f.type || 'application/octet-stream', data: base64 });
      }
      renderUploads();
    }

    function renderUploads(){
      uploadsList.innerHTML = '';
      filesState.forEach((f, i)=>{
        const card = document.createElement('div');
        card.className = 'card';
        const isImage = (f.mimeType||'').startsWith('image/');
        const thumbSrc = isImage ? f.data : 'data:image/svg+xml;utf8,'+encodeURIComponent(
          `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300">
             <rect width="100%" height="100%" fill="#f1f5f9"/>
             <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="18" fill="#64748b">${f.name}</text>
           </svg>`);
        card.innerHTML = `
          <button class="remove" title="حذف" aria-label="حذف" data-i="${i}">×</button>
          <img class="thumb" src="${thumbSrc}" alt="${f.name}">
          <div class="meta">
            <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${f.name}">${f.name}</div>
            <div class="muted">${(f.mimeType||'—')}</div>
          </div>`;
        uploadsList.appendChild(card);
      });
      uploadsList.querySelectorAll('.remove').forEach(btn=>btn.addEventListener('click', (e)=>{ const i = +e.currentTarget.dataset.i; filesState.splice(i,1); renderUploads(); }));
    }

    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onerror=()=>reject(new Error('failed to read file')); r.onload=()=>resolve(r.result); r.readAsDataURL(file); });
    }

    // ===== استدعاء الباك-إند =====
    analyzeBtn.addEventListener('click', async () => {
      const text = document.getElementById('freeText').value || '';
      const payload = { text, files: filesState, patientInfo: null };
      hint.textContent = 'جاري التحليل...'; analyzeBtn.disabled = true;
      try{
        const resp = await fetch('/api/gpt', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await resp.json().catch(()=>({}));
        if(!resp.ok || data.ok===false){ throw new Error(data?.error || ('HTTP '+resp.status)); }
        const html = data.html || '<div class="muted">لا توجد نتيجة.</div>';
        resultBox.innerHTML = `<div class="panel">${html}</div>`;
      }catch(err){
        console.error(err); resultBox.innerHTML = `<div class="panel" style="border-color:#fecaca; background:#fff1f2; color:#991b1b">خطأ: ${err.message}</div>`;
      }finally{
        analyzeBtn.disabled = false; hint.textContent = '';
      }
    });
  </script>
</body>
</html>
