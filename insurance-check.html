<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تقييم الحالة الطبية - بوابة الطبيب</title>
  <style>
    :root { --primary-color:#0056b3; --secondary-color:#6c757d; --danger-color:#dc3545;
      --background-color:#f4f7f9; --text-color:#333; --card-bg-color:#fff;
      --border-color:#dee2e6; --input-focus-color:rgba(0,86,179,.25); }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--background-color);color:var(--text-color);margin:0;padding:1rem}
    .container{max-width:900px;margin:2rem auto;background:var(--card-bg-color);padding:2.5rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);border:1px solid var(--border-color)}
    h2{text-align:center;color:var(--primary-color);margin-bottom:2rem;font-weight:600}
    .section-title{font-size:1.2rem;color:var(--primary-color);border-bottom:2px solid var(--primary-color);padding-bottom:.5rem;margin:2rem 0 1.5rem}
    label{font-weight:600;display:block;margin:.8rem 0 .5rem}
    textarea,input,select{width:100%;padding:.8rem 1rem;font-size:1rem;border:1px solid var(--border-color);border-radius:8px;box-sizing:border-box;transition:border-color .3s,box-shadow .3s}
    textarea:focus,input:focus,select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px var(--input-focus-color)}
    textarea{min-height:120px;resize:vertical}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}
    .btns{display:flex;justify-content:center;gap:1rem;margin-top:2.0rem}
    button{padding:.8rem 1.5rem;font-size:1.05rem;font-weight:bold;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:background-color .3s,transform .1s}
    button:active{transform:scale(.98)}
    .btn-primary{background:var(--primary-color)} .btn-primary:hover{background:#004494}
    .btn-secondary{background:var(--secondary-color)} .btn-secondary:hover{background:#5a6268}
    .btn-danger{background:var(--danger-color)} .btn-danger:hover{background:#c82333}
    .upload{margin-top:1.5rem;border:2px dashed var(--border-color);border-radius:8px;padding:1.2rem;text-align:center;cursor:pointer}
    .upload:hover{border-color:var(--primary-color);background:#f8f9fa}
    #image-upload-input{display:none}
    #image-preview{max-width:100%;max-height:300px;border-radius:8px;border:1px solid var(--border-color);display:none;margin-top:.6rem}
    #image-meta{font-size:.9rem;color:#555;margin-top:.4rem;display:none}
    #response{margin-top:2rem;padding:1.2rem;border:1px solid #e0e0e0;border-radius:8px;background:#fdfdfd;display:none}
    .note{padding:1rem;margin-top:1rem;border-radius:8px;text-align:center;display:none}
    .note.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .note.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    #user{margin-bottom:1rem;color:#555;font-size:.9rem;text-align:center}
    /* تلوين كلاس المخاطر (الذكاء يضيفها داخل HTML الناتج) */
    #response .risk-high{color:#721c24;background:#f8d7da;padding:.2rem .6rem;border-radius:6px;font-weight:bold;border:1px solid #f5c6cb}
    #response .risk-medium{color:#856404;background:#fff3cd;padding:.2rem .6rem;border-radius:6px;font-weight:bold;border:1px solid #ffeeba}
    #response .risk-low{color:#155724;background:#d4edda;padding:.2rem .6rem;border-radius:6px;font-weight:bold;border:1px solid #c3e6cb}
  </style>
</head>
<body>
  <div class="container">
    <h2>تقييم الحالة الطبية وطلبات التأمين</h2>
    <div id="user">جاري التحقق من المستخدم...</div>

    <h3 class="section-title">1) معلومات المريض</h3>
    <div class="grid">
      <div>
        <label for="gender">الجنس</label>
        <select id="gender">
          <option value="" disabled selected>اختر...</option>
          <option value="male">ذكر</option>
          <option value="female">أنثى</option>
        </select>
      </div>
      <div>
        <label for="age">العمر (سنة)</label>
        <input type="number" id="age" placeholder="مثال: 63">
      </div>
      <div id="preg-status-wrap" class="hide">
        <label for="preg-status">هل المريضة حامل؟</label>
        <select id="preg-status">
          <option value="" disabled selected>اختر...</option>
          <option value="no">لا</option>
          <option value="yes">نعم</option>
        </select>
      </div>
      <div id="preg-month-wrap" class="hide">
        <label for="preg-month">شهر الحمل</label>
        <input type="number" id="preg-month" min="1" max="9" placeholder="مثال: 5">
      </div>
      <div>
        <label for="height">الطول (سم)</label>
        <input type="number" id="height" placeholder="مثال: 175">
      </div>
      <div>
        <label for="weight">الوزن (كجم)</label>
        <input type="number" id="weight" placeholder="مثال: 80">
      </div>
      <div>
        <label for="temp">الحرارة (°م)</label>
        <input type="text" id="temp" placeholder="مثال: 37.5">
      </div>
      <div>
        <label for="bp">ضغط الدم</label>
        <input type="text" id="bp" placeholder="مثال: 120/80">
      </div>
    </div>

    <h3 class="section-title">2) تفاصيل الحالة</h3>
    <div>
      <label for="desc">وصف الحالة</label>
      <textarea id="desc" placeholder="مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن..."></textarea>
    </div>
    <div>
      <label for="dx">التشخيصات</label>
      <textarea id="dx" placeholder="مثال: T2DM, HTN, Chronic cough"></textarea>
    </div>
    <div>
      <label for="labs">نتائج التحاليل/الأشعة</label>
      <textarea id="labs" placeholder="مثال: eGFR 38, HbA1c 8.2%, K 5.1..."></textarea>
    </div>
    <div>
      <label for="meds">الأدوية/الإجراءات الحالية</label>
      <textarea id="meds" placeholder="مثال: Xigduo XR 5/1000 bid, Diovan 40 qd..."></textarea>
    </div>

    <h3 class="section-title">3) رفع الملفات (اختياري)</h3>
    <div class="upload" id="uploadBox">اضغط أو اسحب لرفع صورة (وصفة/تقرير/الخ)</div>
    <input type="file" id="image-upload-input" accept="image/*">
    <img id="image-preview" alt="معاينة الصورة" />
    <div id="image-meta"></div>

    <div class="btns">
      <button id="analyzeBtn" class="btn-primary">تحليل الحالة وتقديم التقرير</button>
      <button id="homeBtn" class="btn-secondary">الشاشة الرئيسية</button>
      <button id="logoutBtn" class="btn-danger">تسجيل الخروج</button>
    </div>

    <div id="notes"></div>
    <div id="response"></div>
  </div>

  <script type="module">
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey:"AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
      authDomain:"insurance-check-6cec9.firebaseapp.com",
      projectId:"insurance-check-6cec9",
      storageBucket:"insurance-check-6cec9.appspot.com",
      messagingSenderId:"992769471393",
      appId:"1:992769471393:web:c8a9400210a0e7901011e0"
    };
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getAuth, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const userDiv = document.getElementById('user');
    onAuthStateChanged(auth, (user) => {
      if (user) userDiv.textContent = `مرحبًا بك، ${user.email}`;
      else window.location.href = "https://www.m2020m.org/login.html";
    });

    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(()=>{
      notify('info','تم تسجيل الخروج.');
      setTimeout(()=> location.href="https://www.m2020m.org/login.html", 1200);
    });
    document.getElementById('homeBtn').onclick = () => location.href="https://www.m2020m.org/portal.html";

    // ===== إظهار/إخفاء أسئلة الحمل حسب الجنس =====
    const genderSel = document.getElementById('gender');
    const pregWrap = document.getElementById('preg-status-wrap');
    const pregMonthWrap = document.getElementById('preg-month-wrap');
    const pregSel = document.getElementById('preg-status');

    function hide(el){ el.style.display='none'; }
    function show(el){ el.style.display='block'; }

    hide(pregWrap); hide(pregMonthWrap);
    genderSel.addEventListener('change', ()=>{
      if (genderSel.value === 'female'){ show(pregWrap); }
      else { hide(pregWrap); hide(pregMonthWrap); pregSel.value=''; document.getElementById('preg-month').value=''; }
    });
    pregSel?.addEventListener('change', ()=>{
      if (pregSel.value === 'yes') show(pregMonthWrap); else { hide(pregMonthWrap); document.getElementById('preg-month').value=''; }
    });

    // ===== رفع/ضغط صورة =====
    const uploadBox = document.getElementById('uploadBox');
    const fileInput  = document.getElementById('image-upload-input');
    const previewImg = document.getElementById('image-preview');
    const metaDiv    = document.getElementById('image-meta');
    uploadBox.onclick = () => fileInput.click();
    uploadBox.ondragover = e => { e.preventDefault(); uploadBox.style.borderColor = '#0056b3'; };
    uploadBox.ondragleave = e => { uploadBox.style.borderColor = ''; };
    uploadBox.ondrop = e => { e.preventDefault(); fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event('change')); };

    let imageBase64 = null;

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const { base64, info } = await compressImage(file, { maxW: 1024, maxH: 1024, quality: 0.5 });
        imageBase64 = base64;
        previewImg.src = 'data:image/jpeg;base64,' + base64;
        previewImg.style.display = 'block';
        metaDiv.style.display = 'block';
        metaDiv.textContent = `الحجم بعد الضغط: ${info.sizeKB.toFixed(1)} KB — الأبعاد: ${info.w}×${info.h}`;
      } catch (err) {
        console.error(err);
        notify('error','تعذر معالجة الصورة.');
      }
    });

    async function compressImage(file, { maxW=1024, maxH=1024, quality=0.5 } = {}) {
      const dataURL = await new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
      const img = await new Promise((res, rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL; });
      let { width:w, height:h } = img;
      const ratio = Math.min(maxW / w, maxH / h, 1);
      w = Math.round(w * ratio); h = Math.round(h * ratio);
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      const out = canvas.toDataURL('image/jpeg', quality);
      const base64 = out.split(',')[1];
      const sizeKB = (base64.length * 3) / 4 / 1024;
      return { base64, info: { w, h, sizeKB } };
    }

    // ===== إشعارات =====
    function notify(type, msg){
      const notes = document.getElementById('notes');
      notes.innerHTML = '';
      const d = document.createElement('div');
      d.className = `note ${type}`;
      d.textContent = msg;
      notes.appendChild(d);
      d.style.display = 'block';
    }

    // ===== إرسال الطلب =====
    document.getElementById('analyzeBtn').onclick = analyzeCase;

    async function analyzeCase(){
      const response = document.getElementById('response');
      const btn = document.getElementById('analyzeBtn');
      const caseData = {
        userType:'doctor',
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        isPregnant: document.getElementById('preg-status').value,
        pregnancyMonth: document.getElementById('preg-month')?.value,
        height: document.getElementById('height').value,
        weight: document.getElementById('weight').value,
        temperature: document.getElementById('temp').value,
        bloodPressure: document.getElementById('bp').value,
        notes: document.getElementById('desc').value,
        diagnosis: document.getElementById('dx').value,
        labResults: document.getElementById('labs').value,
        medications: document.getElementById('meds').value,
        imageData: imageBase64 ? [imageBase64] : []
      };

      // تحقق: لازم يكون في نص أو صورة
      if (!caseData.notes && !caseData.diagnosis && !caseData.labResults &&
          !caseData.medications && caseData.imageData.length === 0){
        notify('error','الرجاء إدخال تفاصيل الحالة أو رفع صورة.');
        return;
      }

      response.style.display='none'; response.innerHTML=''; notify('info','جاري التحليل... قد يستغرق دقيقة أو اثنتين.');
      btn.disabled = true;

      try {
        if (!auth.currentUser) throw new Error('المستخدم غير مسجل الدخول.');
        const token = await auth.currentUser.getIdToken();

        const res = await fetch('/api/gpt', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
          body: JSON.stringify(caseData)
        });

        const text = await res.text();

        if (!res.ok){
          if (res.status === 413 || /Content Too Large|Entity Too Large/i.test(text)){
            throw new Error('حجم البيانات كبير: قلّل جودة/دقّة الصورة أو أرسل صورة واحدة فقط.');
          }
          if (res.status === 504 || /timeout|timed out|deadline/i.test(text)){
            throw new Error('⏳ انتهت مهلة التحليل. صغّر الصورة أو أعد المحاولة.');
          }
          throw new Error(`فشل الطلب (${res.status}): ${text.slice(0,200)}...`);
        }

        let data;
        try { data = JSON.parse(text); }
        catch { throw new Error('الرد من الخادم ليس JSON صالحاً.'); }

        if (data.htmlReport){
          document.getElementById('notes').innerHTML = '';
          response.innerHTML = data.htmlReport;
          response.style.display = 'block';
          response.scrollIntoView({ behavior:'smooth' });
        } else {
          throw new Error('لم يتم استلام تقرير من الخادم.');
        }

      } catch (err) {
        console.error(err);
        const msg = (err && err.message) ? err.message : String(err || 'خطأ غير معروف');
        if (/aborted|timeout|timed out|signal/i.test(msg)) {
          notify('error','⏳ انتهت مهلة التحليل. جرّب تصغير الصورة أو أعد المحاولة.');
        } else {
          notify('error','حدث خطأ أثناء التحليل: ' + msg);
        }
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
