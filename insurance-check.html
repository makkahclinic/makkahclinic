<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
<style>
  body {font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic UI", Tahoma, Arial; background:#fafafa; color:#222; margin:0; padding:2rem;}
  h1,h2{margin:0 0 .5rem}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 2px 6px rgba(0,0,0,.03)}
  label{font-weight:600;display:block;margin:.25rem 0}
  input[type="file"]{display:block;margin:.5rem 0 1rem}
  select, input[type="text"], textarea, button{width:100%;padding:.7rem;border:1px solid #d1d5db;border-radius:10px;background:#fff}
  textarea{min-height:110px;resize:vertical}
  button{cursor:pointer;font-weight:700}
  button.primary{background:#2563eb;color:#fff;border-color:#1d4ed8}
  button:disabled{opacity:.6;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  pre{white-space:pre-wrap;word-wrap:break-word;background:#0b1220;color:#cbd5e1;border-radius:10px;padding:12px;min-height:120px}
  .muted{color:#666;font-size:.9rem}
  .pill{display:inline-block;padding:.15rem .5rem;border:1px solid #ddd;border-radius:999px;background:#f3f4f6;margin-inline:.2rem}
  .log{font-size:.9rem;max-height:200px;overflow:auto;background:#0b1220;color:#cbd5e1;border-radius:10px;padding:10px}
</style>
</head>
<body>

<h1>تحليل الحالات الطبية <span class="pill">Gemini & GPT‑4o</span></h1>
<p class="muted">* تتم المعالجة على الجهاز + الخادم؛ * التقرير تعليمي ويُراجع سريريًا قبل أي قرار؛ * إزالة PHI تُطلب من النماذج. PDF يُحوَّل محليًا إلى صور + يُستخرج نصّه (PDF.js).</p>

<div class="card">
  <label>اختر ملفات (صورة/‏PDF):</label>
  <input id="fileInput" type="file" accept="image/*,.pdf" multiple />
  <div class="row">
    <div>
      <label>اللغة:</label>
      <select id="lang">
        <option value="ar" selected>العربية</option>
        <option value="en">English</option>
      </select>
    </div>
    <div>
      <label>النموذج:</label>
      <select id="modelChoice">
        <option value="both" selected>Gemini + GPT‑4o</option>
        <option value="gpt">GPT‑4o فقط</option>
        <option value="gemini">Gemini فقط</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label>التخصص (اختياري):</label>
      <input id="specialty" type="text" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
    </div>
    <div>
      <label>وصف مختصر/سياق التأمين (اختياري):</label>
      <input id="context" type="text" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما" />
    </div>
  </div>

  <div class="row" style="margin-top:.5rem">
    <button id="prepBtn" type="button">تحضير الملفات</button>
    <button id="analyzeBtn" type="button" class="primary">تحليل الحالة</button>
  </div>

  <p id="prepStatus" class="muted">—</p>
  <div class="log mono" id="log"></div>
</div>

<div class="card">
  <h2>النتيجة المدمجة</h2>
  <pre id="mergedBox" class="mono"></pre>
</div>

<div class="row">
  <div class="card">
    <h2>مخرجات GPT‑4o</h2>
    <pre id="gptBox" class="mono"></pre>
  </div>
  <div class="card">
    <h2>مخرجات Gemini</h2>
    <pre id="geminiBox" class="mono"></pre>
  </div>
</div>

<!-- PDF.js عبر CDN + تهيئة الـ worker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-U2Q4i6o3ZPkbGQdNZqVb2Kp4wS9WvWv7mTZ8o9uJw0t0pgs3QZ8m7e8sQ4mTss6X3c0xx0tW5mGxFI6b5M+5wg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  // اضبط workerSrc لنفس نسخة PDF.js
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<script>
(() => {
  const $ = id => document.getElementById(id);

  const state = {
    files: [],
    images: [],       // dataURL (jpeg) مضغوطة
    pdfText: "",      // نص مُستخرج من صفحات PDF
    prepared: false
  };

  function log(msg){ const el=$("log"); el.textContent += (msg + "\n"); el.scrollTop = el.scrollHeight; }
  function setPrepStatus(t){ $("prepStatus").textContent = t; }

  $("fileInput").addEventListener("change", (e) => {
    state.files = Array.from(e.target.files || []);
    state.prepared = false;
    state.images = [];
    state.pdfText = "";
    setPrepStatus(state.files.length ? `تم اختيار ${state.files.length} ملف(ات).` : "—");
  });

  $("prepBtn").addEventListener("click", async () => { await prepareFiles(); });

  $("analyzeBtn").addEventListener("click", async () => {
    try{
      $("analyzeBtn").disabled = true;
      $("analyzeBtn").textContent = "جارٍ التحليل...";
      if(!state.prepared) await prepareFiles();

      if(!state.images.length && !state.pdfText.trim()){
        alert("لم يتم تجهيز بيانات (صور/نص). رجاءً اختر ملف PDF/صورة ثم اضغط تحضير أو تحليل.");
        return;
      }
      const body = {
        language: $("lang").value,
        modelChoice: $("modelChoice").value,
        specialty: $("specialty").value || "",
        insuranceContext: $("context").value || "",
        images: state.images,     // dataURL (jpeg)
        pdfText: state.pdfText
      };

      log("بدء استدعاء /api/gpt ...");
      const res = await fetch("/api/gpt", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });

      if(!res.ok){
        const t = await res.text();
        throw new Error(`فشل طلب الخادم: ${res.status} — ${t}`);
      }
      const data = await res.json();
      $("mergedBox").textContent = toPrettyJSON(data.merged || data);
      $("gptBox").textContent    = toPrettyJSON(data.gpt || {note:"لا يوجد ناتج"});
      $("geminiBox").textContent = toPrettyJSON(data.gemini || {note:"لا يوجد ناتج"});

      log("اكتمل التحليل.");
    }catch(err){
      console.error(err);
      alert(err.message);
      log("خطأ: " + err.message);
    }finally{
      $("analyzeBtn").disabled = false;
      $("analyzeBtn").textContent = "تحليل الحالة";
    }
  });

  function toPrettyJSON(x){
    try{
      if(typeof x === "string"){
        // حاول استخراج JSON داخل ``` ```
        const m = x.match(/```json([\s\S]*?)```/i) || x.match(/```([\s\S]*?)```/i);
        const raw = m ? m[1] : x;
        return JSON.stringify(JSON.parse(raw), null, 2);
      }
      return JSON.stringify(x, null, 2);
    }catch{ return typeof x === "string" ? x : JSON.stringify(x); }
  }

  async function prepareFiles(){
    try{
      if(!state.files.length){ alert("اختر ملفًا أو أكثر أولاً."); return; }
      log("بدء التحضير ...");
      const images = [];
      const texts  = [];

      for(const file of state.files){
        if(file.type === "application/pdf" || /\.pdf$/i.test(file.name)){
          log(`> تحويل PDF واستخراج نص: ${file.name}`);
          const ab = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
          for(let p=1; p<=pdf.numPages; p++){
            const page = await pdf.getPage(p);
            // تحويل الصفحة إلى صورة مُضغّطة
            const viewport = page.getViewport({ scale: 1.6 }); // جودة جيدة
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width  = viewport.width;
            canvas.height = viewport.height;
            await page.render({canvasContext: ctx, viewport}).promise;

            // تصغير (إن لزم) إلى عرض أقصى 1600 بكسل
            const maxW = 1600;
            const scale = Math.min(1, maxW / canvas.width);
            let dataURL;
            if(scale < 1){
              const c2 = document.createElement("canvas");
              c2.width = Math.round(canvas.width * scale);
              c2.height = Math.round(canvas.height * scale);
              c2.getContext("2d").drawImage(canvas, 0, 0, c2.width, c2.height);
              dataURL = c2.toDataURL("image/jpeg", 0.82);
            }else{
              dataURL = canvas.toDataURL("image/jpeg", 0.82);
            }
            images.push(dataURL);

            // نص PDF (رفع الدقة للنماذج)
            const txt = await page.getTextContent();
            texts.push(txt.items.map(i => i.str).join(" "));
          }
        }else if(file.type.startsWith("image/")){
          log(`> تجهيز صورة: ${file.name}`);
          const dataURL = await fileToCompressedDataURL(file);
          images.push(dataURL);
        }else{
          log(`> تم تجاهل ملف غير مدعوم: ${file.name}`);
        }
      }

      state.images = images;
      state.pdfText = textsJoin(texts);
      state.prepared = true;

      setPrepStatus(`تم تجهيز ${images.length} صورة/صفحة + نص PDF للتحليل.`);
      log("اكتمل التحضير.");
    }catch(err){
      console.error(err);
      alert("فشل التحضير: " + err.message);
      log("خطأ في التحضير: " + err.message);
    }
  }

  function textsJoin(arr){ 
    return (arr||[]).join("\n").replace(/[ \t]{2,}/g,' ').trim();
  }

  function fileToCompressedDataURL(file){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => {
        const img = new Image();
        img.onload = () => {
          const maxW = 1600, maxH = 1600;
          let {width:w, height:h} = img;
          const s = Math.min(1, maxW/w, maxH/h);
          const cw = Math.round(w*s), ch = Math.round(h*s);
          const canvas = document.createElement("canvas");
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, cw, ch);
          resolve(canvas.toDataURL("image/jpeg", 0.82));
        };
        img.onerror = () => reject(new Error("تعذر قراءة الصورة"));
        img.src = fr.result;
      };
      fr.onerror = () => reject(new Error("تعذر قراءة الملف"));
      fr.readAsDataURL(file);
    });
  }

})();
</script>
</body>
</html>
