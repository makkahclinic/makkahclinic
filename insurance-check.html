<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ุจูุงุจุฉ ุงูุทุจูุจ โ ุชูููู ุงูุญุงูุฉ ุงูุทุจูุฉ</title>
<style>
  :root{
    --primary:#0b63c2; --primary-dark:#084e97; --accent:#00a7c7;
    --danger:#dc3545; --muted:#66768a; --text:#243143; --border:#e2e8f0;
    --card:#fff; --bg1:#e9f3ff; --bg2:#f6fbff; --shadow:0 10px 25px rgba(15,57,105,.08);
    --radius:16px;
    --focus-outline: 3px solid #0b63c2;
    --focus-ring: 0 0 0 3px rgba(11,99,194,.28);
  }
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    color:var(--text);
    background: radial-gradient(1200px 800px at 80% 0%, var(--bg1), var(--bg2));
    padding: 2rem .75rem;
  }
  .container{
    max-inline-size:1080px; margin-inline:auto; background:var(--card);
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    position:relative; overflow:hidden;
  }
  .top-ribbon{ position:absolute; inset-block-start:0; inset-inline:0; height:6px; background:linear-gradient(90deg,var(--primary),var(--accent)); }
  .shell{ padding: 28px 26px 30px; }

  /* Header */
  .header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-block:6px 8px; }
  .title-wrap{ display:flex; align-items:center; gap:12px; min-block-size:52px; }
  .title{ margin:0; font-weight:800; color:var(--primary); letter-spacing:.2px; font-size:1.35rem; }
  .subtext{ color:var(--muted); margin-block-start:2px; font-size:.92rem; }

  /* Home icon + tooltip */
  .home-icon{
    inline-size:52px; block-size:52px; border-radius:14px;
    background:linear-gradient(135deg,#0b63c2,#00a7c7); color:#fff; font-size:24px;
    display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
    box-shadow:0 6px 18px rgba(11,99,194,.22);
  }
  .home-icon:hover{ filter:brightness(.98); transform:translateY(-1px); }
  .home-icon:focus-visible{ outline: var(--focus-outline); box-shadow: var(--focus-ring); }
  .tooltip{
    position:absolute; z-index:10; background:#111827; color:#fff; padding:.35rem .55rem; border-radius:8px; font-size:.85rem;
    opacity:0; pointer-events:none; transition:opacity .15s ease;
    inset-block-start:calc(6px + 52px); inset-inline-start:16px;
  }
  .tooltip[data-show="true"]{ opacity:1; }

  /* Bars */
  .langbar, .exportbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
  .langbar{ margin-block:6px 10px; }
  .divider{ block-size:1px; background:#e6eef8; margin-block:8px; inline-size:100%; }

  /* Language segmented */
  .seg{ display:inline-flex; background:#f3f7fb; border:1px solid var(--border); border-radius:999px; padding:4px; }
  .seg button{ border:none; background:transparent; padding:.45rem .9rem; border-radius:999px; cursor:pointer; font-weight:700; color:#3b5168; }
  .seg button.active{ background:#fff; border:1px solid var(--border); color:var(--primary); }
  .seg button:focus-visible{ outline: var(--focus-outline); box-shadow: var(--focus-ring); }

  /* Export toolbar (menu button) */
  .exportbar{ justify-content:flex-end; }
  .menu{ position:relative; }
  .menu-btn{
    background:var(--primary); color:#fff; border:none; border-radius:10px; padding:.55rem .9rem; font-weight:700; cursor:pointer;
    min-block-size:44px;  /* โฅ WCAG target size */
  }
  .menu-btn:focus-visible{ outline: var(--focus-outline); box-shadow: var(--focus-ring); }
  .menu-list{
    position:absolute; inset-block-start:calc(100% + 6px); inset-inline-end:0; background:#fff;
    border:1px solid var(--border); border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,.08);
    min-inline-size:240px; padding:.35rem; display:none;
  }
  .menu-list[aria-hidden="false"]{ display:block; }
  .menuitem{ display:flex; align-items:center; gap:8px; inline-size:100%; border:none; background:transparent;
    padding:.6rem .7rem; border-radius:8px; text-align:start; cursor:pointer; }
  .menuitem:hover{ background:#f5f9ff; }
  .menuitem:focus-visible{ outline: var(--focus-outline); box-shadow: var(--focus-ring); }

  /* Cards & inputs */
  .card{ border:1px solid var(--border); border-radius:14px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.03); padding:16px; margin-block:14px; }
  .section-title{ font-size:1.02rem; font-weight:800; color:#243143; display:flex; align-items:center; gap:.5rem; margin-block-end:12px; border-bottom:2px solid #dbe8f5; padding-block-end:.5rem; }
  .dot{ inline-size:8px; block-size:8px; border-radius:50%; background:var(--accent); display:inline-block; }
  label{ font-weight:700; display:block; margin:.65rem 0 .35rem; }
  .hint{ font-size:.86rem; color:#8496ab; margin-block-start:.15rem; }
  input, select, textarea{
    inline-size:100%; box-sizing:border-box; border:1px solid var(--border); border-radius:10px; padding:.72rem .9rem; background:#fff; font-size:1rem;
    transition:border-color .2s, box-shadow .2s, background .2s;
  }
  input::placeholder, textarea::placeholder{ color:#9aa8b8; }
  input:focus-visible, select:focus-visible, textarea:focus-visible{ outline: var(--focus-outline); box-shadow: var(--focus-ring); }
  textarea{ min-block-size:120px; resize:vertical; }
  .grid{ display:grid; gap:14px; }
  .grid-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
  .grid-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
  .tall{ min-block-size:220px; }
  .span-2{ grid-column: 1 / -1; }

  /* Uploads */
  .drop{ border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; color:#6c7f95; transition:border-color .25s, background .25s; cursor:pointer; }
  .drop:hover{ border-color:var(--primary); background:#f6fbff; }
  #file-input{ display:none; }
  .file-list{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin-block-start:10px; }
  .thumb{ position:relative; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff; min-block-size:140px; display:flex; align-items:center; justify-content:center; }
  .thumb img{ max-inline-size:100%; max-block-size:200px; display:block; }
  .thumb .badge{ position:absolute; inset-block-start:8px; inset-inline-start:8px; background:#eef5ff; color:#1e3a8a; border:1px solid #cfe6ff; font-size:.78rem; padding:.12rem .45rem; border-radius:999px; }
  .thumb .remove{ position:absolute; inset-block-start:8px; inset-inline-end:8px; inline-size:30px; block-size:30px; border:none; border-radius:50%; background:var(--danger); color:#fff; font-size:18px; cursor:pointer; box-shadow:0 4px 10px rgba(220,53,69,.25); }
  .thumb .remove:focus-visible{ outline: var(--focus-outline); box-shadow: var(--focus-ring); }
  .thumb .meta{ position:absolute; inset-block-end:8px; inset-inline-start:8px; color:#4b5563; background:#ffffffd0; border-radius:6px; padding:.15rem .4rem; font-size:.78rem; }

  /* Actions */
  .actions{ display:flex; gap:12px; justify-content:center; align-items:center; margin-block-start:14px; flex-wrap:wrap; }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:.6rem; border:none; border-radius:12px; color:#fff; cursor:pointer;
    padding:.9rem 1.25rem; font-weight:800; font-size:1.06rem; min-inline-size: 11rem; min-block-size: 48px; /* โฅ 44px ููุณูุฉ */
    box-shadow: 0 6px 14px rgba(0,0,0,.08); transition: transform .06s ease, filter .2s ease, background .25s ease;
  }
  .btn:active{ transform: translateY(1px); }
  .btn:focus-visible{ outline: var(--focus-outline); box-shadow: var(--focus-ring); }
  .btn-primary{ background: var(--primary); }
  .btn-primary:hover{ background: var(--primary-dark); }
  .btn-danger{ background: var(--danger); }
  .btn-danger:hover{ filter: brightness(.95); }

  .notification{ margin-block-start:16px; padding:12px 14px; border-radius:10px; display:none; text-align:center; font-weight:600; }
  .notification.info{ background:#e9f4ff; color:#114a86; border:1px solid #cfe6ff; }
  .notification.error{ background:#fde8ea; color:#7a1f27; border:1px solid #f5c6cb; }

  /* Report container */
  #response-container{ margin-block-start:16px; border:1px solid var(--border); border-radius:14px; background:#fff; display:none; box-shadow: var(--shadow); overflow:hidden;}
  #response-container .report-wrap{ overflow:auto; }
  #response-container table{ border-collapse:separate; border-spacing:0; inline-size:100%; table-layout:fixed; font-size:.98rem; direction:inherit; }
  #response-container thead th{
    position:sticky; inset-block-start:0; background:#f6fbff; color:#0b3766; z-index:1; font-weight:800; text-align:start;
    padding-block:.85rem; padding-inline:.9rem; border-block-end:2px solid #dbe8f5;
  }
  #response-container td{
    padding-block:.7rem; padding-inline:.9rem; vertical-align:top; border-block-end:1px solid #eef2f7;
    overflow-wrap:anywhere; white-space:break-spaces;
  }
  #response-container tbody tr:nth-child(odd){ background:#fafcff; }
  #response-container td.risk-low   { background:#eaf8f0; color:#0f5132; font-weight:800; }
  #response-container td.risk-medium{ background:#fff6db; color:#7a5b00; font-weight:800; }
  #response-container td.risk-high  { background:#fde7ea; color:#842029; font-weight:800; }
  #response-container h3, #response-container h4{ margin-block:1rem .4rem; margin-inline:1rem; }
  #response-container p{ margin-inline:1rem; }

  /* โุชูุณูุนโ ุขุฎุฑ ุนููุฏ (ูุฑุงุฑ ุงูุชุฃููู) ูุชุซุจูุช ุนุฑุถู */
  #response-container table tr > :last-child{ inline-size: clamp(12rem, 23vw, 22rem); }

  /* Print: show only the report */
  @media print{
    body{ padding:0; background:#fff; }
    .langbar, .exportbar, .actions, .sticky-actions, .notification, .drop, .file-list, .section-title, .header .home-icon { display:none !important; }
    .container{ border:none; box-shadow:none; }
    #response-container{ display:block !important; }
  }

  /* Responsive */
  @media (max-width: 900px){ .grid-3{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
  @media (max-width: 720px){
    .grid-2, .grid-3{ grid-template-columns: 1fr; }
    .menu-btn{ inline-size:100%; }
    .btn{ inline-size:100%; }
  }
  .hidden{ display:none !important; }

  /* Sticky action dock */
  .sticky-actions{
    position:fixed; inset-inline:0; inset-block-end:12px; display:none; justify-content:center; gap:10px; z-index:50;
  }
  .sticky-actions .btn{ border-radius:999px; box-shadow:0 8px 24px rgba(0,0,0,.18); }
  .sticky-actions[data-show="true"]{ display:flex; }
</style>
</head>
<body>
  <div class="container">
    <div class="top-ribbon"></div>
    <div class="shell">
      <!-- Header -->
      <div class="header">
        <div class="title-wrap">
          <button id="homeBtn" class="home-icon" type="button" aria-label="ุงูุงูุชูุงู ุฅูู ุงูุฑุฆูุณูุฉ" aria-describedby="homeTip">๐</button>
          <div id="homeTip" class="tooltip" role="tooltip">ุงูุงูุชูุงู ุฅูู ุงูุฑุฆูุณูุฉ</div>
          <div>
            <h1 class="title" id="app-title">ุชูููู ุงูุญุงูุฉ ุงูุทุจูุฉ</h1>
            <div class="subtext" id="app-sub">ูุงุฌูุฉ ุฅุฏุฎุงู ุณุฑูุฑูุฉ ูุฑุจุท ูุน ุงูุชุฃููู</div>
          </div>
        </div>

        <!-- Language -->
        <div class="langbar" aria-label="Language Switcher">
          <div class="seg" role="tablist" aria-label="Language">
            <button id="lang-ar" class="active" type="button">ุงูุนุฑุจูุฉ</button>
            <button id="lang-en" type="button">English</button>
          </div>
        </div>
      </div>

      <div class="divider" aria-hidden="true"></div>

      <!-- Export bar (PDF only) -->
      <div class="exportbar">
        <div class="menu">
          <button id="exportBtn" class="menu-btn" type="button" aria-haspopup="menu" aria-expanded="false" aria-controls="exportMenu">PDF / ุทุจุงุนุฉ</button>
          <div id="exportMenu" class="menu-list" role="menu" aria-hidden="true">
            <button class="menuitem" role="menuitem" data-mode="ar">Arabic PDF</button>
            <button class="menuitem" role="menuitem" data-mode="en">English PDF</button>
            <button class="menuitem" role="menuitem" data-mode="both">Bilingual PDF</button>
          </div>
        </div>
      </div>

      <!-- Patient Info -->
      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-i="pinfo">ูุนูููุงุช ุงููุฑูุถ</span></div>
        <div class="grid grid-3">
          <div>
            <label for="gender" data-i="gender">ุงูุฌูุณ</label>
            <select id="gender">
              <option value="" selected disabled data-i="choose">ุงุฎุชุฑ</option>
              <option value="male" data-i="male">ุฐูุฑ</option>
              <option value="female" data-i="female">ุฃูุซู</option>
            </select>
            <div class="hint" data-i="pregHint">ูู ูุงูุช ุงููุฑูุถุฉ ุฃูุซูุ ุณุชุธูุฑ ุฃุณุฆูุฉ ุงูุญูู ุชููุงุฆููุง.</div>
          </div>
          <div>
            <label for="age" data-i="age">ุงูุนูุฑ</label>
            <input id="age" type="number" placeholder="63">
          </div>
          <div id="pregnancy-status-wrap" class="hidden">
            <label for="pregnancy-status" data-i="pregLbl">ูู ุงููุฑูุถุฉ ุญุงููุ</label>
            <select id="pregnancy-status">
              <option value="" selected disabled data-i="choose">ุงุฎุชุฑ</option>
              <option value="yes" data-i="yes">ูุนู</option>
              <option value="no" data-i="no">ูุง</option>
            </select>
          </div>
          <div id="pregnancy-month-wrap" class="hidden">
            <label for="pregnancy-month" data-i="pregMonth">ุดูุฑ ุงูุญูู</label>
            <input id="pregnancy-month" type="number" min="1" max="9" placeholder="5">
          </div>
          <div>
            <label for="height" data-i="height">ุงูุทูู (ุณู)</label>
            <input id="height" type="number" placeholder="175">
          </div>
          <div>
            <label for="weight" data-i="weight">ุงููุฒู (ูุฌู)</label>
            <input id="weight" type="number" placeholder="80">
          </div>
          <div>
            <label for="temperature" data-i="temperature">ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ (ยฐู)</label>
            <input id="temperature" type="text" placeholder="37.6">
          </div>
          <div>
            <label for="blood-pressure" data-i="bp">ุถุบุท ุงูุฏู</label>
            <input id="blood-pressure" type="text" placeholder="120/80">
          </div>
        </div>
      </div>

      <!-- Lifestyle & symptoms -->
      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-i="life">ููุท ุงูุญูุงุฉ ูุงูุฃุนุฑุงุถ</span></div>
        <div class="grid grid-3">
          <div>
            <label for="smoker" data-i="smoker">ูู ุงููุฑูุถ ูุฏุฎููุ</label>
            <select id="smoker">
              <option value="" selected disabled data-i="choose">ุงุฎุชุฑ</option>
              <option value="yes" data-i="yes">ูุนู</option>
              <option value="no" data-i="no">ูุง</option>
            </select>
          </div>
          <div id="pack-years-wrap" class="hidden">
            <label for="pack-years" data-i="packYears">ุนุฏุฏ ุงูุจุงู-ุณูุฉ</label>
            <input id="pack-years" type="number" placeholder="35">
            <div class="hint" data-i="packHint">ุงูุจุงู-ุณูุฉ = (ุนุฏุฏ ุงูุนูุจ ูููููุง ร ุณููุงุช ุงูุชุฏุฎูู)</div>
          </div>
          <div>
            <label for="cough-duration" data-i="cough">ูุฏุฉ ุงูุณุนุงู (ุฃุณุงุจูุน)</label>
            <input id="cough-duration" type="number" placeholder="12">
          </div>
          <div>
            <label for="visual-symptoms" data-i="vision">ุฃุนุฑุงุถ ุจุตุฑูุฉุ</label>
            <select id="visual-symptoms">
              <option value="" selected disabled data-i="choose">ุงุฎุชุฑ</option>
              <option value="yes" data-i="yes">ูุนู</option>
              <option value="no" data-i="no">ูุง</option>
            </select>
          </div>
          <div id="eye-wrap" class="hidden">
            <label for="last-eye-exam" data-i="fundus">ุชุงุฑูุฎ ุขุฎุฑ ูุญุต ูุงุน ุนูู</label>
            <input id="last-eye-exam" type="date">
            <label for="visual-acuity" data-i="acuity">ุญุฏุฉ ุงูุจุตุฑ (ุงุฎุชูุงุฑู)</label>
            <input id="visual-acuity" type="text" placeholder="6/12 ุฃู 20/40">
          </div>
        </div>
      </div>

      <!-- Medical details -->
      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-i="details">ุชูุงุตูู ุงูุญุงูุฉ ุงูุทุจูุฉ</span></div>
        <div class="grid grid-2">
          <div>
            <label for="case-description" data-i="caseDesc">ูุตู ุงูุญุงูุฉ</label>
            <textarea id="case-description" class="tall" placeholder="ูุซุงู: ุณุนุงู ูุฒูู 12 ุฃุณุจูุนูุง..."></textarea>
          </div>
          <div>
            <label for="diagnosis" data-i="dx">ุงูุชุดุฎูุตุงุช ุงููุจุฏุฆูุฉ</label>
            <textarea id="diagnosis" class="tall" placeholder="T2DM, HTN, COPD? Dermatitis"></textarea>
          </div>
          <div>
            <label for="lab-results" data-i="labs">ุงูุชุญุงููู/ุงูุฃุดุนุฉ ุงููุชููุฑุฉ</label>
            <textarea id="lab-results" class="tall" placeholder="HbA1c 8.7%, eGFR 38โ62, โฆ"></textarea>
          </div>
          <div class="span-2">
            <label for="medications-procedures" data-i="meds">ุงูุฃุฏููุฉ/ุงูุฅุฌุฑุงุกุงุช ุงูููุชูุจุฉ</label>
            <textarea id="medications-procedures" class="tall" placeholder="Xigduo XR bid, Metformin 1000 tid, โฆ"></textarea>
          </div>
        </div>
      </div>

      <!-- Uploads -->
      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-i="uploads">ุฑูุน ูููุงุช (ุตูุฑุฉ/PDF)</span></div>
        <div class="drop" onclick="document.getElementById('file-input').click()" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
          <div data-i="drop">ุงุถุบุท ุฃู ุงุณุญุจ ุตูุฑ (PNG/JPG) ุฃู PDF</div>
          <input id="file-input" type="file" accept="image/*,.pdf" multiple>
          <div class="hint" data-i="dropHint">ููุตุญ ุจููู ุฃู ุงุซููู ูุงุถุญูู โ ุงูุตูุฑ ุชูุถุบุท ุชููุงุฆููุง</div>
        </div>
        <div id="file-list" class="file-list"></div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="analyzeBtn" class="btn btn-primary" type="button">ุชุญููู ุงูุญุงูุฉ</button>
        <button id="logoutBtn" class="btn btn-danger" type="button">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
      </div>

      <div id="notification-area" class="notification info"></div>
      <div id="response-container"></div>
    </div>
  </div>

  <!-- Sticky action dock -->
  <div id="stickyBar" class="sticky-actions" aria-hidden="true">
    <button id="stickyAnalyze" class="btn btn-primary" type="button">ุชุญููู ุงูุญุงูุฉ</button>
    <button id="stickyPDF" class="btn btn-primary" type="button">PDF</button>
  </div>

<script>
/* ================== Helpers (config + i18n) ================== */
const urlParams = new URLSearchParams(location.search);
const API_OVERRIDE = urlParams.get('api');
const API_ENDPOINTS = [API_OVERRIDE, '/api/gpt', '/.netlify/functions/gpt', '/api/gemini'].filter(Boolean);

const I18N = {
  ar: {
    title:'ุชูููู ุงูุญุงูุฉ ุงูุทุจูุฉ', sub:'ูุงุฌูุฉ ุฅุฏุฎุงู ุณุฑูุฑูุฉ ูุฑุจุท ูุน ุงูุชุฃููู',
    pinfo:'ูุนูููุงุช ุงููุฑูุถ', gender:'ุงูุฌูุณ', choose:'ุงุฎุชุฑ', male:'ุฐูุฑ', female:'ุฃูุซู',
    pregHint:'ูู ูุงูุช ุงููุฑูุถุฉ ุฃูุซูุ ุณุชุธูุฑ ุฃุณุฆูุฉ ุงูุญูู ุชููุงุฆููุง.',
    age:'ุงูุนูุฑ', pregLbl:'ูู ุงููุฑูุถุฉ ุญุงููุ', pregMonth:'ุดูุฑ ุงูุญูู',
    height:'ุงูุทูู (ุณู)', weight:'ุงููุฒู (ูุฌู)', temperature:'ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ (ยฐู)', bp:'ุถุบุท ุงูุฏู',
    life:'ููุท ุงูุญูุงุฉ ูุงูุฃุนุฑุงุถ', smoker:'ูู ุงููุฑูุถ ูุฏุฎููุ', yes:'ูุนู', no:'ูุง',
    packYears:'ุนุฏุฏ ุงูุจุงู-ุณูุฉ', packHint:'ุงูุจุงู-ุณูุฉ = (ุนุฏุฏ ุงูุนูุจ ูููููุง ร ุณููุงุช ุงูุชุฏุฎูู)',
    cough:'ูุฏุฉ ุงูุณุนุงู (ุฃุณุงุจูุน)', vision:'ุฃุนุฑุงุถ ุจุตุฑูุฉุ', fundus:'ุชุงุฑูุฎ ุขุฎุฑ ูุญุต ูุงุน ุนูู', acuity:'ุญุฏุฉ ุงูุจุตุฑ (ุงุฎุชูุงุฑู)',
    details:'ุชูุงุตูู ุงูุญุงูุฉ ุงูุทุจูุฉ', caseDesc:'ูุตู ุงูุญุงูุฉ', dx:'ุงูุชุดุฎูุตุงุช ุงููุจุฏุฆูุฉ', labs:'ุงูุชุญุงููู/ุงูุฃุดุนุฉ ุงููุชููุฑุฉ', meds:'ุงูุฃุฏููุฉ/ุงูุฅุฌุฑุงุกุงุช ุงูููุชูุจุฉ',
    uploads:'ุฑูุน ูููุงุช (ุตูุฑุฉ/PDF)', drop:'ุงุถุบุท ุฃู ุงุณุญุจ ุตูุฑ (PNG/JPG) ุฃู PDF', dropHint:'ููุตุญ ุจููู ุฃู ุงุซููู ูุงุถุญูู โ ุงูุตูุฑ ุชูุถุบุท ุชููุงุฆููุง',
    analyze:'ุชุญููู ุงูุญุงูุฉ', logout:'ุชุณุฌูู ุงูุฎุฑูุฌ',
    pdfBtn:'PDF / ุทุจุงุนุฉ', pdfAr:'Arabic PDF', pdfEn:'English PDF', pdfBi:'Bilingual PDF',
    tooltipHome:'ุงูุงูุชูุงู ุฅูู ุงูุฑุฆูุณูุฉ',
    needData:'ุฃุฏุฎู ุชูุงุตูู ุงูุญุงูุฉ ุฃู ุฃุฑูู ููููุง.', analyzing:'ุฌุงุฑู ุงูุชุญูููโฆ',
    apiMissing:'ูุงุฌูุฉ ุงูุจุฑูุฌุฉ ุบูุฑ ููุฌูุฏุฉ ุนูู ูุฐุง ุงููุทุงู. ุฌุฑูุจ ุจุงุฑุงููุชุฑ ?api= ุฃู ุงูุดุฑ /api/gpt.'
  },
  en: {
    title:'Medical Case Assessment', sub:'Clinical intake with insurance linkage',
    pinfo:'Patient Info', gender:'Gender', choose:'Choose', male:'Male', female:'Female',
    pregHint:'If female, pregnancy questions appear automatically.',
    age:'Age', pregLbl:'Pregnant?', pregMonth:'Pregnancy Month',
    height:'Height (cm)', weight:'Weight (kg)', temperature:'Temperature (ยฐC)', bp:'Blood Pressure',
    life:'Lifestyle & Symptoms', smoker:'Smoker?', yes:'Yes', no:'No',
    packYears:'Pack-Years', packHint:'Pack-years = packs/day ร years smoked',
    cough:'Cough Duration (weeks)', vision:'Visual symptoms?', fundus:'Last Fundus Exam', acuity:'Visual Acuity (optional)',
    details:'Medical Case Details', caseDesc:'Case Description', dx:'Initial Diagnoses', labs:'Labs / Imaging', meds:'Medications / Procedures',
    uploads:'Upload Files (Image/PDF)', drop:'Click or drop images (PNG/JPG) or PDF', dropHint:'Prefer 1โ2 clear files โ images are auto-compressed',
    analyze:'Analyze', logout:'Logout',
    pdfBtn:'PDF / Print', pdfAr:'Arabic PDF', pdfEn:'English PDF', pdfBi:'Bilingual PDF',
    tooltipHome:'Go to Home',
    needData:'Provide case details or attach a file.', analyzing:'Analyzingโฆ',
    apiMissing:'API endpoint not found on this host. Use ?api= or deploy /api/gpt.'
  }
};
let currentLang = (localStorage.getItem('uiLang') === 'en') ? 'en' : 'ar';
applyLang(currentLang);
document.getElementById('lang-ar').addEventListener('click', ()=> setLang('ar'));
document.getElementById('lang-en').addEventListener('click', ()=> setLang('en'));
function setLang(lang){ currentLang=lang; localStorage.setItem('uiLang', lang); applyLang(lang); }
function applyLang(lang){
  document.documentElement.lang = (lang==='en'?'en':'ar');
  document.documentElement.dir  = (lang==='en'?'ltr':'rtl');
  const t = I18N[lang];
  document.getElementById('app-title').textContent = t.title;
  document.getElementById('app-sub').textContent   = t.sub;
  document.getElementById('exportBtn').textContent = t.pdfBtn;
  document.getElementById('homeTip').textContent   = t.tooltipHome;
  document.getElementById('analyzeBtn').textContent = t.analyze;
  document.getElementById('logoutBtn').textContent  = t.logout;
  document.querySelectorAll('[data-i]').forEach(el=>{ const key=el.getAttribute('data-i'); el.textContent = t[key] ?? el.textContent; });
  document.getElementById('lang-ar').classList.toggle('active', lang==='ar');
  document.getElementById('lang-en').classList.toggle('active', lang==='en');
  document.getElementById('stickyAnalyze').textContent = t.analyze;
}

/* ================== Tooltip & Home ================== */
const homeBtn = document.getElementById('homeBtn');
const homeTip = document.getElementById('homeTip');
homeBtn.addEventListener('mouseenter', ()=> showTip(true));
homeBtn.addEventListener('mouseleave', ()=> showTip(false));
homeBtn.addEventListener('focus', ()=> showTip(true));
homeBtn.addEventListener('blur',  ()=> showTip(false));
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { showTip(false); closeMenu(); }});
function showTip(on){ homeTip.setAttribute('data-show', on?'true':'false'); }
homeBtn.addEventListener('click', ()=> { window.location.href='https://www.m2020m.org/portal.html'; });

/* ================== Conditional fields ================== */
const genderEl = document.getElementById('gender');
const pregStatWrap = document.getElementById('pregnancy-status-wrap');
const pregMonthWrap = document.getElementById('pregnancy-month-wrap');
const pregStatEl = document.getElementById('pregnancy-status');
genderEl.addEventListener('change', () => {
  const isFemale = genderEl.value === 'female';
  pregStatWrap.classList.toggle('hidden', !isFemale);
  if (!isFemale){ pregMonthWrap.classList.add('hidden'); pregStatEl.value = ""; document.getElementById('pregnancy-month').value=""; }
});
pregStatEl.addEventListener('change', () => {
  const showMonth = pregStatEl.value === 'yes';
  pregMonthWrap.classList.toggle('hidden', !showMonth);
  if (!showMonth){ document.getElementById('pregnancy-month').value=""; }
});
const smokerEl = document.getElementById('smoker');
const packYearsWrap = document.getElementById('pack-years-wrap');
smokerEl.addEventListener('change', () => {
  packYearsWrap.classList.toggle('hidden', smokerEl.value !== 'yes');
  if (smokerEl.value !== 'yes') document.getElementById('pack-years').value="";
});
const visualEl = document.getElementById('visual-symptoms');
const eyeWrap = document.getElementById('eye-wrap');
visualEl.addEventListener('change', () => {
  eyeWrap.classList.toggle('hidden', visualEl.value !== 'yes');
  if (visualEl.value !== 'yes'){ document.getElementById('last-eye-exam').value=""; document.getElementById('visual-acuity').value=""; }
});

/* ================== Uploads ================== */
const fileInput = document.getElementById('file-input');
const fileListEl = document.getElementById('file-list');
let filesState = []; // {id,name,type,base64,width,height,sizeKB,isImage}
let nextId = 1;
fileInput.addEventListener('change', async (e) => {
  if (!e.target.files?.length) return;
  await addFiles([...e.target.files]); fileInput.value="";
});
async function handleDrop(ev){
  ev.preventDefault();
  const dtFiles = [...(ev.dataTransfer?.files || [])];
  if (!dtFiles.length) return;
  await addFiles(dtFiles);
}
async function addFiles(files){
  for (const file of files){
    const type = file.type || '';
    try{
      if (type.startsWith('image/')){
        const { base64, info } = await compressImage(file, { maxW: 1600, maxH: 1600, quality: 0.72 });
        filesState.push({ id: nextId++, name:file.name, type, base64, width:info.w, height:info.h, sizeKB:info.sizeKB, isImage:true });
      } else if (type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')){
        const base64 = await fileToBase64(file);
        const sizeKB = (base64.length * 3) / 4 / 1024;
        filesState.push({ id: nextId++, name:file.name, type:'application/pdf', base64, sizeKB, isImage:false });
      } else {
        showNote('error', (currentLang==='ar'?'ุงููููุงุช ุงููุฏุนููุฉ: ุตูุฑ/PDF':'Supported files: images/PDF only'));
      }
    }catch(err){
      console.error(err); showNote('error','ุชุนุฐูุฑ ูุนุงูุฌุฉ ุงูููู / File could not be processed');
    }
  }
  renderFiles();
}
function renderFiles(){
  fileListEl.innerHTML = '';
  filesState.forEach(f=>{
    const card = document.createElement('div'); card.className='thumb';
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = f.isImage ? 'IMAGE' : 'PDF'; card.appendChild(badge);
    const remove = document.createElement('button'); remove.className='remove'; remove.textContent='โ';
    remove.title='Remove'; remove.onclick=()=>{ filesState = filesState.filter(x=>x.id!==f.id); renderFiles(); }; card.appendChild(remove);
    if (f.isImage){
      const img = new Image(); img.src = 'data:image/jpeg;base64,' + f.base64; card.appendChild(img);
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${f.width}ร${f.height} โข ${f.sizeKB.toFixed(1)} KB`; card.appendChild(meta);
    } else {
      const pdfIcon = document.createElement('div'); pdfIcon.style.fontSize='56px'; pdfIcon.style.color='#64748b'; pdfIcon.textContent='๐'; card.appendChild(pdfIcon);
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${f.name} โข ${f.sizeKB.toFixed(1)} KB`; card.appendChild(meta);
    }
    fileListEl.appendChild(card);
  });
}
async function fileToBase64(file){
  return await new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file); });
}
async function compressImage(file, { maxW=1600, maxH=1600, quality=0.72 } = {}){
  const dataURL = await new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  const img = await new Promise((res, rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL; });
  let { width:w, height:h } = img;
  const ratio = Math.min(maxW/w, maxH/h, 1); w=Math.round(w*ratio); h=Math.round(h*ratio);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const out=canvas.toDataURL('image/jpeg', quality);
  const base64=out.split(',')[1]; const sizeKB=(base64.length*3)/4/1024;
  return { base64, info:{ w,h,sizeKB } };
}

/* ================== API + Analyze ================== */
const analyzeBtn = document.getElementById('analyzeBtn');
const stickyAnalyze = document.getElementById('stickyAnalyze');
const stickyPDF = document.getElementById('stickyPDF');
analyzeBtn.addEventListener('click', analyzeCase);
stickyAnalyze.addEventListener('click', analyzeCase);
document.getElementById('logoutBtn').addEventListener('click', ()=> showNote('info', currentLang==='ar'?'ุชู ุชุณุฌูู ุงูุฎุฑูุฌ (ูููุฐุฌ).':'Logged out (demo).'));

function buildPayload(uiLangOverride){
  return {
    uiLang: uiLangOverride || currentLang, // 'ar' | 'en' | 'both'
    userType:'doctor',
    age: val('age'), gender: val('gender'),
    isSmoker: sel('smoker'),
    smokingPackYears: val('pack-years'), coughDurationWeeks: val('cough-duration'),
    visualSymptoms: val('visual-symptoms'), lastEyeExamDate: val('last-eye-exam'), visualAcuity: val('visual-acuity'),
    height: val('height'), weight: val('weight'), temperature: val('temperature'), bloodPressure: val('blood-pressure'),
    notes: val('case-description', true), diagnosis: val('diagnosis', true), labResults: val('lab-results', true), medications: val('medications-procedures', true),
    files: filesState.map(f=>({name:f.name,type:f.type,base64:f.base64}))  // images + PDFs
  };
}
function val(id, allowEmpty=false){ const v=(document.getElementById(id)?.value||'').trim(); return (allowEmpty?v:(v||undefined)); }
function sel(id){ const v=document.getElementById(id)?.value; if(v==='yes') return true; if(v==='no') return false; return undefined; }

async function firstWorkingEndpoint(){
  for (const url of API_ENDPOINTS){
    try{
      const r = await fetch(url, { method:'HEAD' });
      if (r.ok || r.status===405) return url; // 405 (method not allowed) ูุนูู ุงููุณุงุฑ ููุฌูุฏ
    } catch {}
  }
  return null;
}
async function apiCall(payload){
  // ุฌุฑูุจ endpoints ุจุงูุชุฑุชูุจ
  const tried = [];
  for (const url of API_ENDPOINTS){
    try{
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (res.ok) return await res.json();
      tried.push({url, status:res.status});
    }catch(e){ tried.push({url, status:'NET_ERR'}); }
  }
  const t = I18N[currentLang];
  throw new Error(t.apiMissing + `\nTried: ${tried.map(x=>`${x.url} [${x.status}]`).join(' , ')}`);
}

async function analyzeCase(){
  const t = I18N[currentLang];
  const responseContainer = document.getElementById('response-container');
  const btns = [document.getElementById('analyzeBtn'), document.getElementById('stickyAnalyze')];

  clearNote(); responseContainer.style.display='none'; responseContainer.innerHTML='';
  const payload = buildPayload();
  if (!payload.notes && !payload.diagnosis && !payload.labResults && !payload.medications && (!payload.files || !payload.files.length)){
    showNote('error', t.needData); return;
  }
  showNote('info', t.analyzing); btns.forEach(b=>b.disabled=true);

  try{
    const data = await apiCall(payload);
    if (data?.htmlReport){
      clearNote();
      renderReport(data.htmlReport);
      // ุงุญูุธ ุขุฎุฑ ุชูุฑูุฑ ููุงุณุชุฑุฌุงุน ุจุนุฏ ุงูุชุญุฏูุซ
      localStorage.setItem('lastReportHTML', data.htmlReport);
    } else { throw new Error('No htmlReport'); }
  } catch(err){
    console.error(err); showNote('error','Error: '+ err.message);
  } finally {
    btns.forEach(b=>b.disabled=false);
  }
}

function renderReport(html){
  const responseContainer = document.getElementById('response-container');
  responseContainer.innerHTML = `<div class="report-wrap">${html}</div>`;
  responseContainer.style.display = 'block';
  tuneTableWidths(responseContainer);
  responseContainer.scrollIntoView({ behavior:'smooth', block:'start' });
}
function tuneTableWidths(container){
  // ุฃุฏุฎู colgroup ุฏููุงูููููุง ูู ุงุณุชุทุนุช ุงูุชุนุฑู ุนูู ุงูุนูุงููู
  const table = container.querySelector('table');
  if (!table) return;
  const thead = table.querySelector('thead');
  if (!thead) return;
  const ths = [...thead.querySelectorAll('th')].map(th=>th.textContent.trim());
  const widthMap = {
    'ุงูุฏูุงุก/ุงูุฅุฌุฑุงุก': '16rem', 'Drug/Procedure': '16rem',
    'ุงูุฌุฑุนุฉ ุงูููุตููุฉ': '12rem', 'Prescribed Dose': '12rem',
    'ุงูุฌุฑุนุฉ ุงูุตุญูุญุฉ ุงูููุชุฑุญุฉ': '13rem', 'Correct Dose': '13rem',
    'ุงูุชุตููู': '9rem', 'Class': '9rem',
    'ุงูุบุฑุถ ุงูุทุจู': '11rem', 'Indication': '11rem',
    'ุงูุชุฏุงุฎูุงุช': '12rem', 'Interactions': '12rem',
    'ุฏุฑุฌุฉ ุงูุฎุทูุฑุฉ (%)': '10rem', 'Risk Score (%)': '10rem',
    'ูุฑุงุฑ ุงูุชุฃููู': '18rem', 'Insurance Decision': '18rem'
  };
  const cg = document.createElement('colgroup');
  ths.forEach(h=>{
    const col = document.createElement('col');
    const w = widthMap[h] || '';
    if (w) col.style.width = w;
    cg.appendChild(col);
  });
  table.insertBefore(cg, thead);
}

/* ================== Export PDF (menu) ================== */
const exportBtn  = document.getElementById('exportBtn');
const exportMenu = document.getElementById('exportMenu');
exportBtn.addEventListener('click', toggleMenu);
exportBtn.addEventListener('keydown', (e)=>{ if(e.key==='ArrowDown'){ openMenu(); focusFirst(); } });
document.addEventListener('click', (e)=>{ if(!exportMenu.contains(e.target) && e.target!==exportBtn) closeMenu(); });
[...exportMenu.querySelectorAll('.menuitem')].forEach((item, idx, arr)=>{
  item.addEventListener('click', ()=> exportPDF(item.dataset.mode));
  item.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' || e.key===' ') { e.preventDefault(); exportPDF(item.dataset.mode); }
    else if(e.key==='ArrowDown'){ e.preventDefault(); (arr[idx+1]||arr[0]).focus(); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); (arr[idx-1]||arr[arr.length-1]).focus(); }
  });
});
function toggleMenu(){ const open = exportMenu.getAttribute('aria-hidden')!=='false'; open?openMenu():closeMenu(); }
function openMenu(){ exportMenu.setAttribute('aria-hidden','false'); exportBtn.setAttribute('aria-expanded','true'); }
function closeMenu(){ exportMenu.setAttribute('aria-hidden','true'); exportBtn.setAttribute('aria-expanded','false'); }
function focusFirst(){ const first = exportMenu.querySelector('.menuitem'); first && first.focus(); }

stickyPDF.addEventListener('click', ()=> exportPDF(currentLang));

async function exportPDF(mode){
  closeMenu();
  const savedLang = currentLang;
  const responseContainer = document.getElementById('response-container');
  const originalHTML = responseContainer.innerHTML;
  const originalDir  = document.documentElement.dir;
  const originalLang = document.documentElement.lang;

  try{
    const payload = buildPayload(mode); // 'ar' | 'en' | 'both'
    const data = await apiCall(payload);
    if (!data?.htmlReport) throw new Error('Export generation failed');

    // Temporarily set doc dir/lang to requested print language (bilingual keeps RTL shell)
    if (mode==='en'){ document.documentElement.dir='ltr'; document.documentElement.lang='en'; }
    else { document.documentElement.dir='rtl'; document.documentElement.lang='ar'; }

    renderReport(data.htmlReport);

    // Robust print (afterprint + matchMedia fallback)
    await new Promise(resolve=>{
      const done = ()=>{ media?.removeListener(mqHandler); window.removeEventListener('afterprint', done); resolve(); };
      window.addEventListener('afterprint', done);
      const media = window.matchMedia ? window.matchMedia('print') : null;
      const mqHandler = (m)=>{ if(!m.matches) setTimeout(done, 150); };
      if (media) media.addListener(mqHandler);
      window.print();
      setTimeout(done, 2500); // ultimate fallback
    });

  } catch (e){
    console.error(e);
    showNote('error', currentLang==='ar'?'ูุดู ุฅูุดุงุก PDF':'Failed to create PDF');
  } finally {
    // Restore UI language and report
    responseContainer.innerHTML = originalHTML;
    if (originalHTML) responseContainer.style.display='block'; else responseContainer.style.display='none';
    document.documentElement.dir = originalDir;
    document.documentElement.lang = originalLang;
    setLang(savedLang);
  }
}

/* ================== Notes & sticky bar ================== */
function showNote(type, text){
  const note = document.getElementById('notification-area');
  note.className = 'notification ' + (type === 'error' ? 'error' : 'info');
  note.textContent = text;
  note.style.display = 'block';
}
function clearNote(){ const note = document.getElementById('notification-area'); note.style.display='none'; note.textContent=''; }

(function restoreLastReport(){
  const html = localStorage.getItem('lastReportHTML');
  if (html){
    renderReport(html);
  }
})();

// sticky bar after scrolled
const stickyBar = document.getElementById('stickyBar');
function updateSticky(){
  const scrolled = window.scrollY || document.documentElement.scrollTop;
  stickyBar.setAttribute('data-show', scrolled > 480 ? 'true' : 'false');
}
window.addEventListener('scroll', updateSticky, { passive:true });
updateSticky();
</script>
</body>
</html>
