// api/gpt.js
// Vercel Serverless Function (لا نستخدم SDKs حتى لا نصطدم بقيود Edge).
// يتطلب: OPENAI_API_KEY, GEMINI_API_KEY

const OPENAI_MODEL = 'gpt-4o-2024-08-06'; // يدعم رؤية عبر chat.completions
const GEMINI_MODEL = 'gemini-1.5-pro';

function extractJson(text='') {
  // يلتقط كتلة JSON حتى لو كانت بين ```json ... ```
  const m = text.match(/\{[\s\S]*\}$/) || text.match(/```json([\s\S]*?)```/i);
  const raw = m ? (m[1] ? m[1] : m[0]) : text;
  try { return JSON.parse(raw); } catch { return null; }
}

function buildSchema(language='ar'){
  // مخطط تقرير موحّد غني (مفاتيح ثابتة تُسهّل العرض والفوترة)
  const safetyNote = language === 'ar'
    ? "هذا المحتوى مُعَدّ لتحسين الجودة والتدقيق التأميني، ويُراجع من طبيب مرخّص قبل أي قرار سريري."
    : "This content is for quality-improvement and payer audit support; a licensed clinician must review before decisions.";
  return {
    schemaNote:
`أعد JSON صارمًا فقط دون أي نص خارجه. المفاتيح المطلوبة:
{
 "executive_summary": "",
 "patient_summary": "",
 "physician_actions": {
   "chief_complaint": "", "vitals": [], "significant_signs": [], "diagnoses": [], "orders": [], "meds": [], "icd10_codes": []
 },
 "key_findings": [],
 "contradictions": [ { "item":"", "evidence":"", "impact":"" } ],
 "differential_diagnoses": [ { "dx":"", "why":"" } ],
 "severity_red_flags": [],
 "procedural_issues": [ { "issue":"", "impact":"", "evidence":"" } ],
 "missed_opportunities": [ { "what":"", "why_it_matters":"" } ],
 "revenue_quality_opportunities": [ { "opportunity":"", "category":"documentation|diagnostics|procedure|coding|follow-up", "rationale":"", "risk_note":"" } ],
 "icd_suggestions": [ { "code":"", "label":"", "why":"" } ],
 "cpt_suggestions": [ { "code":"", "label":"", "why":"" } ],
 "should_have_been_done": [ { "step":"", "reason":"" } ],
 "suggested_next_steps": [ { "action":"", "justification":"" } ],
 "references": [ { "title":"", "org":"", "link":"" } ],
 "patient_safety_note": "${safetyNote}"
}`,
    guardrails:
`قواعد:
1) لا تكشف PHI/الأسماء/المعرّفات؛ استخدم [REDACTED].
2) اعتمد أدلة WHO/NICE/CDC/IDSA عند الاقتضاء واذكر روابط قصيرة في "references".
3) لا تُرجِع نصًا خارج JSON ولا تضع فواصل زائدة.
`
  };
}

function buildClinicalInstruction({language='ar', specialty='', insuranceContext='', texts=[]}){
  const lang = language === 'en' ? 'English' : 'العربية';
  const spec = specialty ? `التخصص السريري: ${specialty}` : 'التخصص: عام';
  const ctx  = insuranceContext ? `سياق تأميني/وصف مقدم: ${insuranceContext}` : '—';
  const ocr  = texts?.length ? `\n\n[نص مُستخرج من PDF (ملخّص)]:\n${texts.join('\n---\n').slice(0, 12000)}` : '';
  return (
`${spec} — اللغة المطلوبة للتقرير: ${lang}.
أنت مساعد سريري للتدقيق وتحسين الدخل المعتمد على الأدلة. قدّم تقييمًا دقيقًا ومُنظّمًا، مع إبراز التناقضات الترميزية/السلوكية وماذا كان يجب فعله لرفع دخل العيادة بشكل مقبول تأمينيًا.
${ctx}
${ocr}
إرجاع JSON فقط حسب المخطط المطلوب أدناه.`
  );
}

function toGeminiParts({instruction, images=[], texts=[]}){
  const parts = [{ text: instruction }];
  // images: array of { dataUrl, contentType }
  for (const img of images){
    const m = String(img.dataUrl).match(/^data:(.+?);base64,(.*)$/);
    if (!m) continue;
    parts.push({
      inlineData: { mimeType: m[1] || img.contentType || 'image/png', data: m[2] }
    });
  }
  if (texts?.length) parts.push({ text: texts.join('\n---\n').slice(0, 12000) });
  return parts;
}

async function callOpenAI({ apiKey, instruction, images=[], temperature=0.2 }){
  const content = [{ type: 'text', text: instruction }];
  for (const img of images){
    content.push({
      type: 'image_url',
      image_url: { url: img.dataUrl } // Data URL مدعومة عبر image_url
    });
  }
  const body = {
    model: OPENAI_MODEL,
    temperature,
    messages: [
      { role: 'system', content: 'You are a meticulous clinical quality & revenue-improvement assistant. Return STRICT JSON only.' },
      { role: 'user', content }
    ],
    response_format: { type: 'json_object' } // يفرض JSON
  };
  const r = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data?.error?.message || 'OpenAI error');
  const text = data?.choices?.[0]?.message?.content || '';
  return extractJson(text) || null;
}

async function callGemini({ apiKey, instruction, images=[], texts=[], temperature=0.2 }){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(apiKey)}`;
  const body = {
    contents: [{ role:'user', parts: toGeminiParts({ instruction, images, texts }) }],
    generationConfig: { temperature, responseMimeType: "application/json" }
  };
  const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  const data = await r.json();
  if (!r.ok) throw new Error(data?.error?.message || 'Gemini error');
  const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
  return extractJson(text) || null;
}

function mergeReports(a, b){
  // دمج بسيط: يختار الحقول الأطول/الأغنى ويجمع المصفوفات بدون تكرار
  const pick = (key, fallback='') => (a?.[key] && String(a[key]).length > String(b?.[key]||'').length ? a[key] : (b?.[key] ?? fallback));
  const uniqArr = (arr=[]) => Array.from(new Map(arr.map(x=>[JSON.stringify(x), x])).values());

  const merged = {
    executive_summary: pick('executive_summary'),
    patient_summary: pick('patient_summary'),
    physician_actions: { ...(a?.physician_actions||{}), ...(b?.physician_actions||{}) },
    key_findings: uniqArr([...(a?.key_findings||[]), ...(b?.key_findings||[])]),
    contradictions: uniqArr([...(a?.contradictions||[]), ...(b?.contradictions||[])]),
    differential_diagnoses: uniqArr([...(a?.differential_diagnoses||[]), ...(b?.differential_diagnoses||[])]),
    severity_red_flags: uniqArr([...(a?.severity_red_flags||[]), ...(b?.severity_red_flags||[])]),
    procedural_issues: uniqArr([...(a?.procedural_issues||[]), ...(b?.procedural_issues||[])]),
    missed_opportunities: uniqArr([...(a?.missed_opportunities||[]), ...(b?.missed_opportunities||[])]),
    revenue_quality_opportunities: uniqArr([...(a?.revenue_quality_opportunities||[]), ...(b?.revenue_quality_opportunities||[])]),
    icd_suggestions: uniqArr([...(a?.icd_suggestions||[]), ...(b?.icd_suggestions||[])]),
    cpt_suggestions: uniqArr([...(a?.cpt_suggestions||[]), ...(b?.cpt_suggestions||[])]),
    should_have_been_done: uniqArr([...(a?.should_have_been_done||[]), ...(b?.should_have_been_done||[])]),
    suggested_next_steps: uniqArr([...(a?.suggested_next_steps||[]), ...(b?.suggested_next_steps||[])]),
    references: uniqArr([...(a?.references||[]), ...(b?.references||[])]),
    patient_safety_note: a?.patient_safety_note || b?.patient_safety_note || ''
  };
  return merged;
}

export default async function handler(req, res){
  try{
    if (req.method !== 'POST') { res.status(405).json({ error: 'Only POST allowed' }); return; }

    const { language='ar', model='both', specialty='', insuranceContext='', images=[], texts=[] } = req.body || {};
    const { schemaNote, guardrails } = buildSchema(language);
    const instruction = buildClinicalInstruction({ language, specialty, insuranceContext, texts })
      + '\n\n' + guardrails + '\n\n' + schemaNote;

    const wantOpenAI = (model === 'both' || model === 'openai') && !!process.env.OPENAI_API_KEY;
    const wantGemini = (model === 'both' || model === 'gemini') && !!process.env.GEMINI_API_KEY;

    let [gpt, gemini] = [null, null];
    // نفّذ بالتوازي حسب المفاتيح المتاحة
    const tasks = [];
    if (wantOpenAI) tasks.push(callOpenAI({ apiKey: process.env.OPENAI_API_KEY, instruction, images }));
    else tasks.push(Promise.resolve(null));
    if (wantGemini) tasks.push(callGemini({ apiKey: process.env.GEMINI_API_KEY, instruction, images, texts }));
    else tasks.push(Promise.resolve(null));

    [gpt, gemini] = await Promise.all(tasks);

    const base = gpt || gemini || { executive_summary:'', patient_summary:'', key_findings:[], references:[] };
    const merged = gpt && gemini ? mergeReports(gpt, gemini) : base;

    res.status(200).json({ merged, gpt, gemini, model_used: { openai: !!gpt, gemini: !!gemini } });
  } catch (err){
    console.error(err);
    res.status(500).json({ error: String(err?.message || err) });
  }
}
