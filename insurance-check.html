<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</title>
  <style>
    :root{
      --container-max: 1100px;
      --gap-xxs: 4px;
      --gap-xs: 8px;
      --gap-s: 12px;
      --gap-m: 16px;
      --gap-l: 20px;
      --radius: 14px;
      --shadow: 0 6px 20px rgba(20,20,50,.08);
      --line: rgba(0,0,0,.08);
      --brand: #0d6efd;
      --danger: #e63946;
      --bg: #f6f8fb;
      --card: #fff;
      --text: #1b2a3a;
      --muted: #5f6b7a;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic UI", "Tajawal", "Cairo", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .wrap{
      max-width: var(--container-max);
      margin-inline:auto;
      padding-inline: clamp(12px,4vw,20px);
      padding-block: 20px 80px; /* Ù…Ø³Ø§Ø­Ø© Ø³ÙÙ„ÙŠÙ‘Ø© Ù…Ø±ÙŠØ­Ø© Ø¨Ø¯ÙˆÙ† Ø¥ÙØ±Ø§Ø· */
    }
    header{
      display:flex; align-items:center; gap:var(--gap-s);
      margin-block: 4px 16px;
    }
    .home{
      inline-size:44px; block-size:44px; border-radius:12px;
      display:grid; place-items:center;
      background:linear-gradient(180deg,#2aa7f7,#0d6efd);
      box-shadow: var(--shadow);
      color:#fff; font-size:22px; text-decoration:none;
    }
    h1{
      font-size: clamp(18px,3.8vw,26px);
      margin:0; font-weight:800; color:#0b2239;
    }
    .hint{ color:var(--muted); font-size:14px; }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
      padding: 14px; /* ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Øº Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª */
      margin-block: 12px; /* Ù…Ø³Ø§ÙØ© Ø¹Ù…ÙˆØ¯ÙŠØ© Ù…Ø¹Ù‚ÙˆÙ„Ø© */
    }
    .drop-title{
      display:flex; align-items:center; justify-content:space-between;
      font-weight:700; padding-block:6px 10px;
    }

    /* Dropzone */
    .dropzone{
      display:flex; align-items:center; justify-content:center;
      border:2px dashed #c8d3e1;
      border-radius:12px;
      background:#fbfdff;
      min-block-size: 150px; /* Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙØ±Ø§Øº */
      padding: 8px;
      transition: background .2s, border-color .2s;
    }
    .dropzone.drag{ background:#f0f6ff; border-color:#9bbcf4;}
    .dropzone p{ margin:0; color:var(--muted); text-align:center; }
    .preview{
      display:grid; place-items:center; padding:10px; margin-block:10px 0;
      border:1px solid var(--line); border-radius:12px; background:#fff;
    }
    .preview figure{ margin:0; }
    .preview img{ max-inline-size: 360px; border-radius:10px; display:block; }

    /* Actions (Ø´Ø±ÙŠØ· ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©) */
    .actions{
      display:flex; gap:var(--gap-m); justify-content:center; flex-wrap:wrap;
      margin-block: 12px 6px;
    }
    button.btn{
      border:0; border-radius: 12px; padding: 11px 18px;
      font-weight:800; font-size:16px; cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease;
      box-shadow: var(--shadow);
      min-inline-size: 140px; /* Ù‡Ø¯Ù Ù„Ù…Ø³ Ù…ÙÙ†Ø§Ø³Ø¨ */
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background:var(--brand); color:#fff; }
    .btn.danger{ background:var(--danger); color:#fff; }
    .btn.ghost{ background:#eef2f8; color:#0b2239; }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª */
    #response-container{
      max-block-size: 60vh; overflow:auto;
      padding: 10px; border-radius:12px; border:1px solid var(--line);
      background:#fff;
    }

    /* Ø´Ø±ÙŠØ· Ø¹Ø§Ø¦Ù… Ø°ÙƒÙŠ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø¨ØªØ¹Ø§Ø¯ Ø¹Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
    .fab{
      position: fixed; inset-inline:0; bottom: 14px;
      display:none; justify-content:center; gap:10px;
      pointer-events: none; /* ØªÙ…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
      z-index: 50;
    }
    .fab .btn{ pointer-events:auto; }
    .fab.show{ display:flex; }

    /* Ø·Ø¨Ø§Ø¹Ø©: Ù†ÙˆØ­Ù‘Ø¯ ØªÙ‚Ø±ÙŠØ± Ù†Ø¸ÙŠÙ */
    @media print {
      body{ background:#fff; }
      .no-print, header, .fab{ display:none !important; }
      #print-root{ display:block !important; }
    }
    /* Ø¬Ø¯ÙˆÙ„Ø© Ø¨Ø³ÙŠØ·Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
    .report table{ width:100%; border-collapse: collapse; font-size:14px; }
    .report th, .report td{ border-block:1px solid #e6ecf3; padding:10px 8px; text-align: start; }
    .report th{ background:#f6f9ff; white-space:nowrap; }
    .risk-hi{ color:#b00020; font-weight:700; }
    .risk-mid{ color:#a05a00; font-weight:700; }
    .risk-lo{ color:#0b7a34; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="no-print">
      <a class="home" href="/" aria-label="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ </a>
      <div>
        <h1>ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
        <div class="hint">Ø§Ø±ÙØ¹ ØµÙˆØ±Ø©/â€PDF Ù„Ù„ÙˆØµÙØ©ØŒ Ø«Ù… Ø§Ø¶ØºØ· â€œØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©â€.</div>
      </div>
    </header>

    <section class="card no-print" aria-labelledby="uploaderTitle">
      <div class="drop-title">
        <div id="uploaderTitle">Ø±ÙØ¹ Ù…Ù„ÙØ§Øª (ØµÙˆØ±Ø©/â€PDF)</div>
        <span style="color:#36b37e;font-weight:700">â—</span>
      </div>
      <div id="drop" class="dropzone" tabindex="0" role="button" aria-label="Ø§Ù†Ù‚Ø± Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„ÙÙ‹Ø§">
        <p>Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ ØµÙˆØ± PNG/JPG Ø£Ùˆ Ù…Ù„ÙØ§Øª PDF Ù‡Ù†Ø§</p>
        <input id="file-input" type="file" accept=".png,.jpg,.jpeg,.pdf" multiple hidden />
      </div>
      <div id="preview" class="preview" hidden></div>
    </section>

    <div class="actions no-print" id="top-actions">
      <button class="btn danger" id="resetBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      <button class="btn primary" id="analyzeBtn">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
      <button class="btn ghost" id="pdfBtn" title="ØªØµØ¯ÙŠØ±/Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±">PDF</button>
    </div>

    <section class="card" aria-live="polite" aria-busy="false">
      <div id="response-container">â€” Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‡Ù†Ø§ â€”</div>
    </section>

    <!-- Ø´Ø±ÙŠØ· Ø¹Ø§Ø¦Ù… ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø¨ØªØ¹Ø§Ø¯ Ø¹Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
    <div class="fab no-print" id="fab">
      <button class="btn primary" id="fabAnalyze">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
      <button class="btn ghost" id="fabPdf">PDF</button>
    </div>

    <footer class="no-print" style="margin-block:20px 0;color:#6b778c;font-size:13px">
      <div>Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ù…ÙØ³ØªÙ†Ø¯Ø© Ø¥Ù„Ù‰ WCAG ÙˆMDN/Material.</div>
      <div>
        Ù…Ø±Ø§Ø¬Ø¹: WCAG Quickref Â· CSS Logical Properties (MDN) Â· Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„Ù…ØªØµÙØ­ (MDN) Â· Gemini generateContent (Google AI).
      </div>
    </footer>
  </div>

  <script>
    // ====== Ø¹Ù†Ø§ØµØ± DOM
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('preview');
    const responseEl = document.getElementById('response-container');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const resetBtn = document.getElementById('resetBtn');
    const fab = document.getElementById('fab');
    const fabAnalyze = document.getElementById('fabAnalyze');
    const fabPdf = document.getElementById('fabPdf');

    // ====== Ø­Ø§Ù„Ø©
    const state = { files: [] };

    // ====== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª
    const toBase64 = (file) => new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result.split(',')[1]);
      r.onerror = reject;
      r.readAsDataURL(file);
    });

    const humanSize = (n) => n>1024*1024 ? (n/1024/1024).toFixed(1)+' MB' : Math.round(n/1024)+' KB';

    function showPreview() {
      if (!state.files.length) { preview.hidden = true; preview.innerHTML=''; return; }
      const f = state.files[0]; // Ø£ÙˆÙ„ Ù…Ø±ÙÙ‚ Ù„Ù„Ø¹Ø±Ø¶
      const isImg = /^image\//i.test(f.type);
      preview.hidden = false;
      preview.innerHTML = `<figure>
        ${isImg ? `<img alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" src="${URL.createObjectURL(f)}"/>`
                : `<div style="padding:20px;text-align:center">ğŸ“„ Ù…Ù„Ù PDF â€” ${f.name}</div>`}
      </figure>
      <div style="color:#6b778c;font-size:12px;margin-block:6px 0">${humanSize(f.size)} Â· ${f.type}</div>`;
    }

    function pickFiles() { fileInput.click(); }
    drop.addEventListener('click', pickFiles);
    drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); pickFiles(); } });
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', (e)=>{
      e.preventDefault(); drop.classList.remove('drag');
      const files = Array.from(e.dataTransfer.files || []);
      state.files = files;
      showPreview();
    });
    fileInput.addEventListener('change', (e)=>{
      state.files = Array.from(e.target.files || []);
      showPreview();
    });

    // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
    resetBtn.addEventListener('click', ()=>{
      state.files = [];
      fileInput.value = '';
      preview.hidden = true; preview.innerHTML = '';
      responseEl.innerHTML = 'â€” ØªÙ… Ø§Ù„Ù…Ø³Ø­ØŒ Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© â€”';
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // Ø´Ø±ÙŠØ· Ø¹Ø§Ø¦Ù… Ø°ÙƒÙŠ (Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø¶Ù…Ù† Ù…Ø¬Ø§Ù„ Ø§Ù„Ø±Ø¤ÙŠØ©)
    function updateFabVisibility() {
      const rect = document.getElementById('top-actions').getBoundingClientRect();
      const inView = rect.top >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight);
      fab.classList.toggle('show', !inView);
    }
    window.addEventListener('scroll', updateFabVisibility, {passive:true});
    window.addEventListener('resize', updateFabVisibility);
    updateFabVisibility();

    // Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„
    async function analyzeCase(){
      try{
        const filesOut = [];
        for(const f of state.files){
          filesOut.push({
            name: f.name,
            type: f.type,
            data: await toBase64(f)
          });
        }
        responseEl.innerHTML = 'â³ ÙŠØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„â€¦';
        const res = await fetch('/api/gpt', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            language: 'ar',
            notes: '',
            files: filesOut
          })
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(`HTTP ${res.status}: ${txt}`);
        }
        const data = await res.json();
        responseEl.innerHTML = `<div class="report">${data.htmlReport || 'ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.'}</div>`;
        updateFabVisibility();
      }catch(err){
        console.error(err);
        responseEl.innerHTML = `<div style="color:#b00020">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©:<br>${err.message}</div>`;
      }
    }
    analyzeBtn.addEventListener('click', analyzeCase);
    fabAnalyze.addEventListener('click', analyzeCase);

    // ØªØµØ¯ÙŠØ±/Ø·Ø¨Ø§Ø¹Ø© PDF â€” Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù†Ø¸ÙŠÙØ© ÙˆÙ†Ø·Ø¨Ø¹Ù‡Ø§ (Ø­Ø³Ø¨ ØªÙˆØµÙŠØ© MDN)
    async function exportPDF(){
      try{
        // Ø¥Ù† ÙˆÙØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ù†Ø³ØªØ¹Ù…Ù„Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        const current = responseEl.innerHTML.trim();
        if(!current || current.includes('Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±')){
          // Ù„Ù… ÙŠÙÙ†Ø´Ø£ ØªÙ‚Ø±ÙŠØ± Ø¨Ø¹Ø¯ â€” Ù†Ø³ØªØ¯Ø¹ÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø£ÙˆÙ„Ù‹Ø§
          await analyzeCase();
        }
        const html = `<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø·Ø¨ÙŠ</title>
<style>
  body{font-family:system-ui,"Noto Naskh Arabic UI","Cairo",sans-serif;color:#111;margin:0;padding:24px;}
  h1,h2{margin:.2em 0;}
  .report table{width:100%;border-collapse:collapse;font-size:12.5px}
  .report th,.report td{border:1px solid #e3e7ed;padding:8px 6px;text-align:start}
  .report th{background:#f6f9ff}
  .meta{color:#555;font-size:12px;margin-bottom:8px}
  @page{size:auto;margin:16mm}
</style>
</head>
<body>
  <div class="meta">ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯: ${new Date().toLocaleString('ar')}</div>
  <div class="report">${responseEl.innerHTML}</div>
  <script>window.onload=()=>{window.print(); setTimeout(()=>window.close(), 250);};<\/script>
</body></html>`;
        const w = window.open('', '_blank', 'noopener,noreferrer');
        w.document.open(); w.document.write(html); w.document.close();
      }catch(err){
        console.error(err);
        alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + err.message);
      }
    }
    pdfBtn.addEventListener('click', exportPDF);
    fabPdf.addEventListener('click', exportPDF);
  </script>
</body>
</html>
