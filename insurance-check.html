<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>عيادة — تقييم الحالة الطبية وطلبات التأمين</title>
  <style>
    :root{
      --primary:#0b63c2; --primary-dark:#084e97; --accent:#00a7c7;
      --secondary:#6c757d; --danger:#dc3545;
      --bg1:#eaf4ff; --bg2:#f6fbff;
      --card:#ffffff; --text:#243143; --muted:#66768a; --border:#e2e8f0;
      --focus:rgba(11,99,194,.18); --shadow:0 10px 24px rgba(11,99,194,.09);
      --radius:16px;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background: radial-gradient(1100px 700px at 80% -10%, var(--bg1), var(--bg2));
      color:var(--text); padding: 22px 12px;
    }
    .container{
      max-width: 1020px; margin: 0 auto; background: var(--card);
      border:1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 28px 26px; position: relative;
    }
    .brand{
      display:flex; align-items:center; gap:12px; margin-bottom:10px;
    }
    .brand .logo{
      width:56px; height:56px; border-radius:14px;
      background: linear-gradient(135deg, #39b7ff, #0b63c2);
      display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900; font-size:18px;
      box-shadow: 0 10px 22px rgba(11,99,194,.22);
    }
    .brand .title{
      font-size:1.35rem; font-weight:800; letter-spacing:.3px; color:#0b63c2;
    }
    .brand .subtitle{ color:var(--muted); font-size:.93rem; margin-top:2px; }

    .home-fab{
      position:absolute; left:16px; top:16px; width:56px; height:56px; border-radius:14px;
      background: #0b63c2; color:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 22px rgba(11,99,194,.22); cursor:pointer; user-select:none;
      transition: transform .12s ease, background .25s ease; font-size:24px;
    }
    .home-fab:hover{ background:#084e97; transform: translateY(-1px); }

    .userline{ text-align:right; color:var(--muted); font-size:.92rem; margin: -4px 0 12px; }

    .section-title{
      font-size:1.02rem; font-weight:800; color:var(--primary);
      border-bottom:2px solid var(--primary);
      padding-bottom:.4rem; margin: 22px 0 14px; display:flex; align-items:center; gap:.5rem;
    }
    .dot{ width:9px; height:9px; border-radius:50%; background:var(--accent); }

    label{font-weight:700; display:block; margin:.8rem 0 .35rem;}
    .hint{font-size:.84rem; color:var(--muted); margin-top:.15rem;}
    input, select, textarea{
      width:100%; box-sizing:border-box; border:1px solid var(--border); border-radius:12px; padding:.7rem .9rem;
      font-size:1rem; background:#fff; transition:border-color .2s, box-shadow .2s, background .2s;
    }
    input::placeholder, textarea::placeholder{ color:#97a7b8; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--primary); box-shadow: 0 0 0 3px var(--focus); background:#fbfdff; }
    textarea{ min-height:120px; resize:vertical; }
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }

    .image-upload{
      border:2px dashed var(--border); border-radius:12px; padding:16px; text-align:center; color:var(--muted);
      transition: border-color .25s, background .25s; cursor:pointer;
    }
    .image-upload:hover{ border-color:var(--primary); background:#f6fbff; }
    #image-upload-input{ display:none; }
    #image-preview{ max-width:100%; max-height:320px; display:none; border-radius:10px; border:1px solid var(--border); }
    #image-meta{ font-size:.9rem; color:var(--muted); margin-top:8px; display:none; }

    .actions{ display:flex; gap:8px; justify-content:flex-end; align-items:center; margin-top: 14px; flex-wrap:wrap; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.45rem; border:none; border-radius:10px; color:#fff; cursor:pointer;
      padding:.45rem .8rem; font-weight:800; font-size:.9rem; transition: transform .06s ease, filter .2s ease, background .25s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--primary); }
    .btn-primary:hover{ background: var(--primary-dark); }
    .btn-danger{ background: var(--danger); }
    .btn-danger:hover{ filter: brightness(.95); }

    .notification{ margin-top:12px; padding:10px 12px; border-radius:10px; display:none; text-align:center; font-weight:700; }
    .notification.info{ background:#e9f4ff; color:#114a86; border:1px solid #cfe6ff; }
    .notification.error{ background:#fde8ea; color:#7a1f27; border:1px solid #f5c6cb; }

    #response-container{ margin-top: 16px; padding:14px; border:1px solid var(--border); border-radius:12px; background:#fff; display:none; box-shadow: var(--shadow); }
    #response-container .risk-high{ color:#721c24; background:#f8d7da; padding:.18rem .5rem; border-radius:6px; border:1px solid #f5c6cb; font-weight:700; }
    #response-container .risk-medium{ color:#856404; background:#fff3cd; padding:.18rem .5rem; border-radius:6px; border:1px solid #ffeeba; font-weight:700; }
    #response-container .risk-low{ color:#155724; background:#d4edda; padding:.18rem .5rem; border-radius:6px; border:1px solid #c3e6cb; font-weight:700; }

    .muted-mini{ font-size:.8rem; color:#92a3b6; text-align:right; margin-top:6px; }
    .hidden{ display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="home-fab" title="العودة للبوابة" onclick="goToHome()">🏠</div>

    <div class="brand">
      <div class="logo">CL</div>
      <div>
        <div class="title">عيادة</div>
        <div class="subtitle">تقييم الحالة الطبية وطلبات التأمين — واجهة الطبيب</div>
      </div>
    </div>

    <div id="user-info" class="userline">جاري التحقق من المستخدم…</div>

    <!-- 1) معلومات المريض -->
    <div class="section-title"><span class="dot"></span> 1) معلومات المريض</div>
    <div class="grid">
      <div>
        <label for="gender">الجنس</label>
        <select id="gender">
          <option value="" selected disabled>اختر الجنس</option>
          <option value="male">ذكر</option>
          <option value="female">أنثى</option>
        </select>
        <div class="hint">لو كانت المريضة أنثى، ستظهر أسئلة الحمل تلقائيًا.</div>
      </div>
      <div>
        <label for="age">العمر</label>
        <input id="age" type="number" placeholder="مثال: 63">
      </div>
      <div id="pregnancy-status-wrap" class="hidden">
        <label for="pregnancy-status">هل المريضة حامل؟</label>
        <select id="pregnancy-status">
          <option value="" selected disabled>اختر</option>
          <option value="yes">نعم</option>
          <option value="no">لا</option>
        </select>
      </div>
      <div id="pregnancy-month-wrap" class="hidden">
        <label for="pregnancy-month">شهر الحمل</label>
        <input id="pregnancy-month" type="number" min="1" max="9" placeholder="مثال: 5">
      </div>
      <div>
        <label for="height">الطول (سم)</label>
        <input id="height" type="number" placeholder="مثال: 175">
      </div>
      <div>
        <label for="weight">الوزن (كجم)</label>
        <input id="weight" type="number" placeholder="مثال: 80">
      </div>
      <div>
        <label for="temperature">درجة الحرارة (°م)</label>
        <input id="temperature" type="text" placeholder="مثال: 37.6">
      </div>
      <div>
        <label for="blood-pressure">ضغط الدم</label>
        <input id="blood-pressure" type="text" placeholder="مثال: 120/80">
      </div>
    </div>

    <!-- 2) نمط الحياة والأعراض -->
    <div class="section-title"><span class="dot"></span> 2) نمط الحياة والأعراض</div>
    <div class="grid">
      <div>
        <label for="smoker">هل المريض مدخّن؟</label>
        <select id="smoker">
          <option value="" selected disabled>اختر</option>
          <option value="yes">نعم</option>
          <option value="no">لا</option>
        </select>
      </div>
      <div id="pack-years-wrap" class="hidden">
        <label for="pack-years">عدد الباك-سنة</label>
        <input id="pack-years" type="number" placeholder="مثال: 35">
        <div class="hint">الباك-سنة = (عدد العلب يوميًا × سنوات التدخين)</div>
      </div>
      <div>
        <label for="cough-duration">مدة السعال (أسابيع)</label>
        <input id="cough-duration" type="number" placeholder="مثال: 12">
      </div>
      <div>
        <label for="visual-symptoms">أعراض بصرية؟</label>
        <select id="visual-symptoms">
          <option value="" selected disabled>اختر</option>
          <option value="yes">نعم</option>
          <option value="no">لا</option>
        </select>
      </div>
      <div id="eye-wrap" class="hidden">
        <label for="last-eye-exam">تاريخ آخر فحص قاع عين</label>
        <input id="last-eye-exam" type="date">
        <label for="visual-acuity">حدة البصر (اختياري)</label>
        <input id="visual-acuity" type="text" placeholder="مثال: 6/12 أو 20/40">
      </div>
    </div>

    <!-- 3) تفاصيل الحالة الطبية -->
    <div class="section-title"><span class="dot"></span> 3) تفاصيل الحالة الطبية</div>
    <div class="grid">
      <div>
        <label for="case-description">وصف الحالة</label>
        <textarea id="case-description" placeholder="مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن بسيط ودوخة متقطعة..."></textarea>
      </div>
      <div>
        <label for="diagnosis">التشخيصات المبدئية</label>
        <textarea id="diagnosis" placeholder="مثال: T2DM, HTN, COPD? Dermatitis"></textarea>
      </div>
      <div>
        <label for="lab-results">التحاليل/الأشعة المتوفرة</label>
        <textarea id="lab-results" placeholder="مثال: HbA1c 8.7%, eGFR 38→62, K 5.6, INR غير متاح..."></textarea>
      </div>
      <div>
        <label for="medications-procedures">الأدوية/الإجراءات المكتوبة</label>
        <textarea id="medications-procedures" placeholder="مثال: Xigduo XR bid, Metformin 1000 tid, Ramipril 10 bid, Spironolactone 50 bid, Ibuprofen 400 tid, Warfarin + Aspirin + Clopidogrel + Rivaroxaban, Clarithromycin + Ciprofloxacin, Allopurinol 300 qd, CT contrast اليوم, قسطرة قلب عاجلة..."></textarea>
      </div>
    </div>

    <!-- 4) رفع ملفات -->
    <div class="section-title"><span class="dot"></span> 4) رفع ملفات (اختياري)</div>
    <div class="image-upload" onclick="document.getElementById('image-upload-input').click()">
      اضغط هنا لرفع صورة (PNG/JPG)
      <input id="image-upload-input" type="file" accept="image/*">
      <div class="hint">سيتم ضغط الصورة تلقائياً لتفادي أخطاء الحجم.</div>
    </div>
    <div style="margin-top:10px;">
      <img id="image-preview" alt="معاينة الصورة">
      <div id="image-meta"></div>
    </div>

    <!-- أزرار -->
    <div class="actions">
      <button id="analyzeBtn" class="btn btn-primary" onclick="analyzeCase()">تحليل الحالة</button>
      <button id="logoutBtn" class="btn btn-danger" onclick="logout()">تسجيل الخروج</button>
    </div>
    <div class="muted-mini">ستُرسل المدخلات مع توكن الدخول لتوليد تقرير HTML متكامل وتصنيفه بصريًا.</div>

    <div id="notification-area" class="notification info"></div>
    <div id="response-container"></div>
  </div>

  <script type="module">
    // ===== Firebase (Modules) =====
    // ⚠️ استبدل القيم بقيم مشروعك من Firebase Console
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const { getAuth, onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const userInfoEl = document.getElementById('user-info');
    onAuthStateChanged(auth, (user) => {
      if (user) userInfoEl.textContent = `مرحبًا بك، ${user.email}`;
      else window.location.href = "https://www.m2020m.org/login.html";
    });

    // ===== منطق الحقول الشرطية =====
    const genderEl = document.getElementById('gender');
    const pregStatWrap = document.getElementById('pregnancy-status-wrap');
    const pregMonthWrap = document.getElementById('pregnancy-month-wrap');
    const pregStatEl = document.getElementById('pregnancy-status');

    genderEl.addEventListener('change', () => {
      const isFemale = genderEl.value === 'female';
      pregStatWrap.classList.toggle('hidden', !isFemale);
      if (!isFemale){ pregMonthWrap.classList.add('hidden'); pregStatEl.value = ""; document.getElementById('pregnancy-month').value=""; }
    });
    pregStatEl.addEventListener('change', () => {
      const showMonth = pregStatEl.value === 'yes';
      pregMonthWrap.classList.toggle('hidden', !showMonth);
      if (!showMonth){ document.getElementById('pregnancy-month').value=""; }
    });

    const smokerEl = document.getElementById('smoker');
    const packYearsWrap = document.getElementById('pack-years-wrap');
    smokerEl.addEventListener('change', () => {
      packYearsWrap.classList.toggle('hidden', smokerEl.value !== 'yes');
      if (smokerEl.value !== 'yes') document.getElementById('pack-years').value="";
    });

    const visualEl = document.getElementById('visual-symptoms');
    const eyeWrap = document.getElementById('eye-wrap');
    visualEl.addEventListener('change', () => {
      eyeWrap.classList.toggle('hidden', visualEl.value !== 'yes');
      if (visualEl.value !== 'yes'){ document.getElementById('last-eye-exam').value=""; document.getElementById('visual-acuity').value=""; }
    });

    // ===== معاينة/ضغط الصورة =====
    const imageInput = document.getElementById('image-upload-input');
    const imagePreview = document.getElementById('image-preview');
    const imageMeta = document.getElementById('image-meta');
    let imageBase64 = null;

    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const { base64, info } = await compressImage(file, { maxW: 1400, maxH: 1400, quality: 0.7 });
        imageBase64 = base64;
        imagePreview.src = 'data:image/jpeg;base64,' + base64;
        imagePreview.style.display = 'block';
        imageMeta.style.display = 'block';
        imageMeta.textContent = `الحجم بعد الضغط: ${info.sizeKB.toFixed(1)} KB — الأبعاد: ${info.w}×${info.h}`;
      } catch (err) {
        showNote('error','تعذر معالجة الصورة. حاول صورة أصغر/أوضح.');
        console.error(err);
      }
    });

    async function compressImage(file, { maxW=1400, maxH=1400, quality=0.7 } = {}){
      const dataURL = await new Promise((res, rej)=>{
        const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror = rej; r.readAsDataURL(file);
      });
      const img = await new Promise((res, rej)=>{
        const i = new Image(); i.onload = ()=> res(i); i.onerror = rej; i.src = dataURL;
      });
      let { width:w, height:h } = img;
      const ratio = Math.min(maxW/w, maxH/h, 1);
      w = Math.round(w*ratio); h = Math.round(h*ratio);
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      const out = canvas.toDataURL('image/jpeg', quality);
      const base64 = out.split(',')[1];
      const sizeKB = (base64.length * 3) / 4 / 1024;
      return { base64, info:{ w,h,sizeKB } };
    }

    // ===== إشعارات =====
    const noteArea = document.getElementById('notification-area');
    function showNote(type, text){
      noteArea.className = 'notification ' + (type === 'error' ? 'error' : 'info');
      noteArea.textContent = text;
      noteArea.style.display = 'block';
    }
    function clearNote(){ noteArea.style.display='none'; noteArea.textContent=''; }

    // ===== تنقل =====
    window.goToHome = () => window.location.href = 'https://www.m2020m.org/portal.html';

    // ===== خروج =====
    window.logout = () => {
      signOut(auth).then(()=>{
        showNote('info','تم تسجيل الخروج.');
        setTimeout(()=> window.location.href = 'https://www.m2020m.org/login.html', 700);
      }).catch(err=>{
        console.error(err);
        showNote('error','تعذر تسجيل الخروج: ' + err.message);
      });
    };

    // ===== التحليل + فرز الجدول حسب الخطورة =====
    window.analyzeCase = async function(){
      const responseContainer = document.getElementById('response-container');
      const btn = document.getElementById('analyzeBtn');
      clearNote(); responseContainer.style.display='none'; responseContainer.innerHTML='';

      const user = auth.currentUser;
      if (!user){ showNote('error','المستخدم غير مسجّل.'); return; }

      // جمع البيانات
      const caseData = {
        userType:'doctor',
        age: document.getElementById('age').value || undefined,
        gender: document.getElementById('gender').value || undefined,
        isSmoker: document.getElementById('smoker').value === 'yes' ? true : (document.getElementById('smoker').value === 'no' ? false : undefined),
        smokingPackYears: document.getElementById('pack-years').value || undefined,
        coughDurationWeeks: document.getElementById('cough-duration').value || undefined,
        visualSymptoms: document.getElementById('visual-symptoms').value || undefined,
        lastEyeExamDate: document.getElementById('last-eye-exam').value || undefined,
        visualAcuity: document.getElementById('visual-acuity').value || undefined,

        height: document.getElementById('height').value || undefined,
        weight: document.getElementById('weight').value || undefined,
        temperature: document.getElementById('temperature').value || undefined,
        bloodPressure: document.getElementById('blood-pressure').value || undefined,

        notes: document.getElementById('case-description').value || '',
        diagnosis: document.getElementById('diagnosis').value || '',
        labResults: document.getElementById('lab-results').value || '',
        medications: document.getElementById('medications-procedures').value || '',
        imageData: imageBase64 ? [imageBase64] : []
      };

      if (!caseData.notes && !caseData.diagnosis && !caseData.labResults && !caseData.medications && caseData.imageData.length === 0){
        showNote('error','الرجاء إدخال تفاصيل الحالة أو رفع صورة.');
        return;
      }

      showNote('info','جاري تحليل الحالة…');
      btn.disabled = true;

      const controller = new AbortController();
      const timer = setTimeout(()=> controller.abort(), 60000);

      try{
        const idToken = await user.getIdToken(false);

        const res = await fetch('/api/gpt', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${idToken}`
          },
          body: JSON.stringify(caseData),
          signal: controller.signal
        });

        const text = await res.text();
        if (!res.ok){
          if (res.status === 413 || /Entity Too Large|Content Too Large/i.test(text))
            throw new Error('الحجم كبير: قلّل جودة/عدد الصور ثم أعد المحاولة.');
          throw new Error(`فشل (${res.status}): ${text.slice(0,240)}…`);
        }

        let data;
        try{ data = JSON.parse(text); }
        catch{ throw new Error('الرد ليس JSON صالحًا من الخادم.'); }

        if (data?.htmlReport){
          clearNote();
          responseContainer.innerHTML = data.htmlReport;
          responseContainer.style.display = 'block';

          // بعد الإدراج: فرز جدول الأدوية حسب "درجة الخطورة (%)" نزولياً
          try { sortRiskTable(responseContainer); } catch(e){ console.warn('Sorting skipped:', e); }

          responseContainer.scrollIntoView({ behavior:'smooth', block:'start' });
        } else {
          throw new Error('لم يتم استلام تقرير HTML من الخادم.');
        }
      } catch(err){
        console.error(err);
        showNote('error','حدث خطأ أثناء التحليل: ' + err.message);
      } finally {
        clearTimeout(timer);
        btn.disabled = false;
      }
    }

    // ===== فرز الجدول حسب درجة الخطورة نزولياً =====
    function sortRiskTable(container){
      const table = container.querySelector('table');
      if (!table) return;
      const headerCells = Array.from(table.querySelectorAll('thead tr th'));
      const riskIdx = headerCells.findIndex(th => th.textContent.trim().includes('درجة الخطورة'));
      if (riskIdx === -1) return;

      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a,b)=>{
        const av = extractPercent(a.cells[riskIdx]?.textContent || '');
        const bv = extractPercent(b.cells[riskIdx]?.textContent || '');
        return bv - av; // نزولياً
      });
      rows.forEach(r => tbody.appendChild(r));
    }
    function extractPercent(txt){
      const m = String(txt).match(/(\d{1,3})\s*%/); return m ? parseInt(m[1],10) : -1;
    }
  </script>
</body>
</html>
