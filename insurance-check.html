<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>

  <!-- PDF.js عبر CDN + worker (يحل مشكلة pdfjsLib is not defined) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js" crossorigin="anonymous"></script>
  <script>
    // اضبط مسار العامل (الـ worker) قبل أي استخدام لـ PDF.js
    (function ensureWorker() {
      const w = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
      if (window.pdfjsLib) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = w;
      } else {
        // حِماية إضافية لو تأخر تحميل الـ CDN
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js";
        s.crossOrigin = "anonymous";
        s.onload = () => window.pdfjsLib && (window.pdfjsLib.GlobalWorkerOptions.workerSrc = w);
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    body{font-family:system-ui,Segoe UI,Tahoma,Arial; margin:0; background:#fafafa; color:#222}
    header{padding:18px 20px; background:#0f172a; color:#fff}
    main{padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .card{background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:14px; margin:10px 0}
    label{font-weight:600; margin-inline-end:8px}
    select, input[type="text"], textarea{font:inherit; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; width:100%}
    textarea{min-height:100px}
    .btn{cursor:pointer; border:0; border-radius:10px; padding:10px 16px; font-weight:700}
    .btn-primary{background:#2563eb; color:#fff}
    .btn-secondary{background:#0ea5e9; color:#fff}
    .btn-ghost{background:#eef2ff; color:#111827}
    .muted{color:#6b7280; font-size:13px}
    .cols{display:grid; grid-template-columns:1fr; gap:14px}
    @media(min-width:1024px){.cols{grid-template-columns:1.1fr 1fr}}
    pre {background:#0b1220; color:#d1e7ff; padding:12px; border-radius:10px; overflow:auto; min-height:110px}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f5f9; font-size:12px; margin-inline-start:6px}
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <div>
      <div style="font-size:20px; font-weight:800">تحليل الحالات الطبية (Gemini & GPT‑4o)</div>
      <div class="muted">* تحويل PDF محليًا إلى صور + استخراج نص (PDF.js). * إزالة PHI تتم على الخادم. * التقرير تعليمي ويُراجع سريريًا قبل أي قرار.</div>
    </div>
    <div class="pill">API Version: v6.1</div>
  </div>
</header>

<main class="cols">
  <!-- اللوحة اليسرى: إدخال وإعداد -->
  <section class="card">
    <div class="row">
      <label>اختر ملفات (صورة/‏PDF):</label>
      <input id="files" type="file" accept="image/*,.pdf" multiple />
    </div>

    <div class="row">
      <div style="flex:1">
        <label>اللغة:</label>
        <select id="lang">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
      </div>
      <div style="flex:1">
        <label>النموذج:</label>
        <select id="model">
          <option value="both" selected>Gemini + GPT‑4o</option>
          <option value="gpt">GPT‑4o فقط</option>
          <option value="gemini">Gemini فقط</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div style="flex:1">
        <label>التخصص (اختياري):</label>
        <input id="spec" type="text" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
      </div>
    </div>

    <div class="row">
      <label>وصف مختصر/سياق التأمين (اختياري):</label>
      <textarea id="ctx" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما"></textarea>
    </div>

    <div class="row">
      <button id="prepBtn" class="btn btn-secondary">تحضير الملفات</button>
      <button id="analyzeBtn" class="btn btn-primary">تحليل الحالة</button>
      <button id="prepOnly" class="btn btn-ghost">تحضير الملفات فقط</button>
    </div>

    <div class="muted" id="prepStatus">لم يتم التحضير بعد.</div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:700; margin-bottom:8px">السجل</div>
      <pre id="log"></pre>
    </div>
  </section>

  <!-- اللوحة اليمنى: النتائج -->
  <section class="card">
    <div style="display:flex; align-items:center; gap:8px">
      <div style="font-weight:800">النتيجة المدمجة</div>
      <button id="copyMerged" class="btn btn-ghost">نسخ JSON</button>
    </div>
    <pre id="mergedOut"></pre>

    <div class="card">
      <div style="font-weight:800">مخرجات GPT‑4o</div>
      <pre id="gptOut"></pre>
    </div>

    <div class="card">
      <div style="font-weight:800">مخرجات Gemini</div>
      <pre id="gemOut"></pre>
    </div>
  </section>
</main>

<script type="module">
  const $ = (s)=>document.querySelector(s);
  const filesEl = $('#files');
  const logEl = $('#log');
  const mergedOut = $('#mergedOut');
  const gptOut = $('#gptOut');
  const gemOut = $('#gemOut');
  const prepStatus = $('#prepStatus');

  let prepared = { images:[], texts:[] };

  function log(line){ logEl.textContent += (line + '\\n'); logEl.scrollTop = logEl.scrollHeight; }
  function resetOutputs(){ mergedOut.textContent = gptOut.textContent = gemOut.textContent = ''; }

  async function ensurePdfjs() {
    if (!window.pdfjsLib) throw new Error('pdfjsLib is not defined');
    // إذا كانت workerSrc لم تُضبط لسبب ما:
    if (!window.pdfjsLib.GlobalWorkerOptions.workerSrc) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }
  }

  function dataUrlToBase64(dataUrl){ return dataUrl.split(',')[1]; }

  async function imageFileToDataUrl(file, maxW=1600) {
    const buf = await file.arrayBuffer();
    const blob = new Blob([buf], {type:file.type || 'image/png'});
    const img = new Image();
    const url = URL.createObjectURL(blob);
    await new Promise((res, rej)=>{ img.onload=()=>res(); img.onerror=e=>rej(e); img.src=url; });
    const scale = Math.min(1, maxW / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height* scale);
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);
    URL.revokeObjectURL(url);
    // استخدم JPEG لتقليل الحجم
    const mime = file.type && file.type.startsWith('image/') ? file.type : 'image/jpeg';
    const dataUrl = canvas.toDataURL(mime, 0.85);
    return { dataUrl, contentType: mime };
  }

  async function pdfFileToImagesAndText(file, scale=1.6) {
    await ensurePdfjs();
    const ab = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: ab }).promise;
    const images = [];
    const texts = [];
    for (let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width; canvas.height = viewport.height;
      const ctx2d = canvas.getContext('2d', { willReadFrequently:true });
      await page.render({ canvasContext: ctx2d, viewport }).promise;
      const dataUrl = canvas.toDataURL('image/png', 0.92);
      images.push({ dataUrl, contentType: 'image/png' });

      // استخراج نص الصفحة
      const tc = await page.getTextContent();
      const t = tc.items.map(i=>i.str).join(' ');
      texts.push(t);
      log(`✓ رُفعت صفحة ${p}/${pdf.numPages} من ${file.name}`);
    }
    return { images, text: texts.join('\\n') };
  }

  async function prepareFiles() {
    resetOutputs();
    logEl.textContent = '';
    prepared = { images:[], texts:[] };

    const files = Array.from(filesEl.files || []);
    if (!files.length){ alert('لم يتم اختيار ملفات.'); return; }

    log('بدء التحضير ... < تحويل PDF واستخراج نص (إن وجد)');
    for (const f of files){
      try{
        if (f.type === 'application/pdf' || /\.pdf$/i.test(f.name)) {
          const { images, text } = await pdfFileToImagesAndText(f);
          prepared.images.push(...images);
          if (text && text.trim()) prepared.texts.push(text);
        } else if ((f.type||'').startsWith('image/')) {
          const o = await imageFileToDataUrl(f);
          prepared.images.push(o);
        } else {
          log(`تخطي ملف غير مدعوم: ${f.name}`);
        }
      } catch(err){
        console.error(err);
        alert(`فشل التحضير: ${err.message} — تأكد أن كود PDF.js تم تحميله (حِلاه بإضافة CDN).`);
        throw err;
      }
    }
    prepStatus.textContent = `تم تجهيز ${prepared.images.length} صورة/صفحة + ${prepared.texts.length?'نص PDF':''} للتحليل.`;
  }

  async function analyze(nowPrep=false) {
    try{
      if (nowPrep || prepared.images.length===0){
        await prepareFiles();
      }

      const body = {
        language: $('#lang').value || 'ar',
        model: $('#model').value || 'both',
        specialty: $('#spec').value || '',
        insuranceContext: $('#ctx').value || '',
        images: prepared.images,   // [{dataUrl, contentType}]
        texts: prepared.texts      // [string]
      };

      log('بدء التحليل ...');
      const res = await fetch('/api/gpt', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || 'فشل الطلب');

      mergedOut.textContent = JSON.stringify(data.merged, null, 2);
      gptOut.textContent    = data.gpt ? JSON.stringify(data.gpt, null, 2) : '';
      gemOut.textContent    = data.gemini ? JSON.stringify(data.gemini, null, 2) : '';
      log('اكتمل التحليل.');
    } catch(err){
      console.error(err);
      alert(err.message || 'حدث خطأ');
    }
  }

  // أزرار
  $('#prepBtn').addEventListener('click', ()=>prepareFiles());
  $('#prepOnly').addEventListener('click', ()=>prepareFiles());
  $('#analyzeBtn').addEventListener('click', ()=>analyze(true));
  $('#copyMerged').addEventListener('click', ()=>{
    const t = mergedOut.textContent || '';
    navigator.clipboard.writeText(t).then(()=>alert('تم نسخ JSON'));
  });
</script>
</body>
</html>
