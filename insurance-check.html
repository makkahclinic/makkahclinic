<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
  <style>
    :root { --bg:#0b1220; --card:#101a2b; --ink:#e6edf3; --muted:#9bb0c8; --accent:#3b82f6; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:#0b1220; color:var(--ink); }
    header { padding:18px 16px; border-bottom:1px solid #1f2a3c; display:flex; gap:12px; align-items:center; justify-content:space-between;}
    header .left { display:flex; gap:10px; align-items:center; font-weight:700; }
    header small { color:var(--muted); }
    main { max-width:1100px; margin:24px auto; padding:0 12px 72px; display:grid; grid-template-columns: 1fr; gap:16px; }
    .card { background:var(--card); border:1px solid #1f2a3c; border-radius:14px; padding:16px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label { font-size:.92rem; color:var(--muted); display:block; margin-bottom:6px; }
    select, textarea, input[type="text"] { width:100%; background:#0d1726; color:var(--ink); border:1px solid #223047; border-radius:10px; padding:10px 12px; outline:none; }
    textarea { min-height:110px; resize:vertical; }
    input[type="file"] { width:100%; }
    .btn { appearance:none; border:none; border-radius:11px; padding:12px 16px; font-weight:700; cursor:pointer; }
    .btn.primary { background:var(--accent); color:white; }
    .btn.ghost { background:#0d1726; color:var(--ink); border:1px dashed #2b3b55; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0a0f1a; color:#cce2ff; padding:12px; border-radius:10px; height:160px; overflow:auto; border:1px solid #1f2a3c; }
    h3 { margin:0 0 12px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #1f2a3c; background:#0d1726; color:var(--muted); font-size:.85rem; }
    .ok { color:#22c55e; }
    .warn { color:#f59e0b; }
    .bad { color:#ef4444; }
    pre { margin:0; white-space:pre-wrap; word-break:break-word; }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width:900px){ .row,.cols{ grid-template-columns: 1fr; } }
  </style>

  <!-- PDF.js (نسخة ثابتة تُعرّف pdfjsLib عالميًا) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js" defer></script>
  <script>
    // تأكيد مسار الـ worker
    window.addEventListener('DOMContentLoaded', () => {
      if (window['pdfjsLib']) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js';
      }
    });
  </script>
</head>
<body>
  <header>
    <div class="left">
      <span>تحليل الحالات الطبية (Gemini & GPT‑4o)</span>
      <small class="pill">API Version: <b id="apiVersion">v6.0</b></small>
    </div>
    <small class="pill"> * المعالجة على الجهاز + الخادم؛ * التقرير تعليمي ويُراجع سريريًا؛ * إزالة PHI.</small>
  </header>

  <main>
    <section class="card">
      <h3>اختر ملفات (صورة/‏PDF):</h3>
      <input id="fileInput" type="file" multiple accept="image/*,.pdf" />
      <small style="color:var(--muted)">سيُحوَّل أي PDF إلى صور، ويُستخرج نصّه لرفع الدقة.</small>

      <div class="row" style="margin-top:14px">
        <div>
          <label>اللغة:</label>
          <select id="langSel">
            <option value="ar" selected>العربية</option>
            <option value="en">English</option>
          </select>
        </div>
        <div>
          <label>النموذج:</label>
          <select id="modelSel">
            <option value="both" selected>Gemini + GPT‑4o</option>
            <option value="gpt">GPT‑4o فقط</option>
            <option value="gemini">Gemini فقط</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>التخصص (اختياري):</label>
          <input id="specInput" type="text" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
        </div>
        <div>
          <label>وصف مختصر/سياق التأمين (اختياري):</label>
          <input id="ctxInput" type="text" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="prepBtn" class="btn ghost">تحضير الملفات</button>
        <button id="analyzeBtn" class="btn primary">تحليل الحالة</button>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center">
        <span id="prepState" class="pill">الحالة: لم يتم التحضير</span>
        <span id="pagesState" class="pill"></span>
      </div>

      <div style="margin-top:12px">
        <label>السجل</label>
        <div class="log" id="log"></div>
      </div>
    </section>

    <section class="card">
      <h3>النتيجة المدمجة</h3>
      <div id="merged" class="log" style="height:auto; min-height:140px;"></div>
    </section>

    <div class="cols">
      <section class="card">
        <h3>مخرجات GPT‑4o</h3>
        <div id="gptOut" class="log" style="height:280px;"></div>
      </section>
      <section class="card">
        <h3>مخرجات Gemini</h3>
        <div id="gemOut" class="log" style="height:280px;"></div>
      </section>
    </div>
  </main>

<script>
/* ========= حالة الواجهة ========= */
const els = {
  file: document.getElementById('fileInput'),
  prepBtn: document.getElementById('prepBtn'),
  analyzeBtn: document.getElementById('analyzeBtn'),
  prepState: document.getElementById('prepState'),
  pagesState: document.getElementById('pagesState'),
  log: document.getElementById('log'),
  merged: document.getElementById('merged'),
  gptOut: document.getElementById('gptOut'),
  gemOut: document.getElementById('gemOut'),
  lang: document.getElementById('langSel'),
  model: document.getElementById('modelSel'),
  spec: document.getElementById('specInput'),
  ctx: document.getElementById('ctxInput'),
};

let PREPARED = { images: [], text: "", bytes: 0 };

function log(msg) {
  els.log.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg)) + '\n';
  els.log.scrollTop = els.log.scrollHeight;
}

function fmtBytes(n){
  if(!n) return '0 B';
  const u=['B','KB','MB','GB']; let i=0; while(n>=1024&&i<u.length-1){ n/=1024; i++; }
  return n.toFixed(1)+' '+u[i];
}

/* ========= أدوات مساعدة ========= */

// تحويل Canvas إلى JPEG DataURL مضغوط
function canvasToJpegDataURL(canvas, q=0.72){
  return canvas.toDataURL('image/jpeg', q);
}

// ملف صورة -> DataURL (JPEG إن أمكن)
function imageFileToDataURL(file, maxSide=1600, q=0.72){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvasToJpegDataURL(c, q));
      };
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

// PDF -> { images[dataURL[]], text[string] }
async function pdfToImagesAndText(file, maxSide=1600, q=0.72){
  if (!window.pdfjsLib) {
    throw new Error('PDF.js غير جاهز (pdfjsLib غير معرّف).');
  }
  const arrBuf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrBuf }).promise;
  const pages = [];
  let textAll = [];
  for (let i=1; i<=pdf.numPages; i++){
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 2.0 }); // دقة جيدة
    // ضبط القياسات لتحديد أقصى ضلع
    const scale = Math.min(1, maxSide / Math.max(viewport.width, viewport.height));
    const v2 = page.getViewport({ scale: 2.0 * scale });
    const canvas = document.createElement('canvas');
    canvas.width = Math.ceil(v2.width);
    canvas.height = Math.ceil(v2.height);
    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport: v2 }).promise;
    const dataURL = canvasToJpegDataURL(canvas, q);
    pages.push(dataURL);

    // استخراج نص
    const txt = await page.getTextContent();
    const t = (txt.items || []).map(it => it.str).join(' ').replace(/\s+/g, ' ').trim();
    if (t) textAll.push(`[صفحة ${i}] ${t}`);
  }
  return { images: pages, text: textAll.join('\n') };
}

/* ========= التحضير ========= */

async function prepareFiles(){
  PREPARED = { images: [], text: "", bytes: 0 };
  const files = Array.from(els.file.files || []);
  if (files.length === 0) {
    throw new Error('الرجاء اختيار ملف واحد على الأقل.');
  }
  log(`بدء التحضير لعدد ${files.length} ملف(ات) ...`);

  for (const f of files){
    if (f.type === 'application/pdf') {
      const { images, text } = await pdfToImagesAndText(f);
      PREPARED.images.push(...images);
      PREPARED.text += (PREPARED.text ? '\n' : '') + text;
    } else if (f.type.startsWith('image/')) {
      const url = await imageFileToDataURL(f);
      PREPARED.images.push(url);
    } else {
      log(`تخطّي ملف غير مدعوم: ${f.name}`);
    }
  }

  // تقدير الحجم
  PREPARED.bytes = PREPARED.images.reduce((sum, d)=> sum + Math.ceil((d.length*3)/4), 0);
  els.prepState.innerHTML = `الحالة: <span class="ok">تم التحضير</span> (${PREPARED.images.length} صورة, ${fmtBytes(PREPARED.bytes)})`;
  els.pagesState.textContent = PREPARED.text ? 'نص PDF مُستخرج ✓' : 'لا يوجد نص مُستخرج';
  log('اكتمل التحضير.');
}

/* ========= التحليل ========= */

async function runAnalysis(){
  // في حال نسي المستخدم الضغط على "تحضير الملفات"، نُحضّر تلقائيًا
  if (!PREPARED.images.length && !(els.file.files && els.file.files.length)){
    throw new Error('لم يتم اختيار ملفات.');
  }
  if (!PREPARED.images.length) {
    await prepareFiles();
  }

  const payload = {
    language: els.lang.value,
    modelChoice: els.model.value,    // both | gpt | gemini
    specialty: els.spec.value || "",
    context: els.ctx.value || "",
    images: PREPARED.images,         // data URLs (jpeg)
    pdf_text: PREPARED.text || "",
    api_version: document.getElementById('apiVersion').textContent || "v6.0"
  };

  log('بدء التحليل عبر الخادم ...');
  els.analyzeBtn.disabled = true;

  const res = await fetch('/api/gpt', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const errTxt = await res.text().catch(()=>res.statusText);
    throw new Error(`HTTP ${res.status}: ${errTxt}`);
  }

  const data = await res.json();
  els.merged.innerHTML = `<pre>${JSON.stringify(data.merged, null, 2)}</pre>`;
  els.gptOut.textContent = data.gpt4o?.text || (data.gpt4o?.json ? JSON.stringify(data.gpt4o.json, null, 2) : '—');
  els.gemOut.textContent = data.gemini?.text || (data.gemini?.json ? JSON.stringify(data.gemini.json, null, 2) : '—');
  log('اكتمل التحليل.');
}

/* ========= ربط الأزرار ========= */

els.prepBtn.addEventListener('click', async ()=>{
  try {
    els.prepBtn.disabled = true;
    await prepareFiles();
  } catch (e) {
    alert(e.message || e);
    log('خطأ التحضير: ' + (e.message||e));
  } finally {
    els.prepBtn.disabled = false;
  }
});

els.analyzeBtn.addEventListener('click', async ()=>{
  try {
    await runAnalysis();
  } catch (e){
    alert(e.message || e);
    log('خطأ التحليل: ' + (e.message||e));
  } finally {
    els.analyzeBtn.disabled = false;
  }
});

// أي تغيير في الملفات يُعيد الحالة إلى "لم يتم التحضير"
els.file.addEventListener('change', ()=>{
  PREPARED = { images: [], text: "", bytes: 0 };
  els.prepState.textContent = 'الحالة: لم يتم التحضير';
  els.pagesState.textContent = '';
  els.log.textContent = '';
  els.merged.textContent = '';
  els.gptOut.textContent = '';
  els.gemOut.textContent = '';
});
</script>
</body>
</html>
