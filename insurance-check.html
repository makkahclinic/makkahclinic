<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© - Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</title>
  <style>
    :root{
      --primary:#0b63c2;         /* Ø£Ø²Ø±Ù‚ Ø¹ÙŠØ§Ø¯ÙŠ */
      --primary-dark:#084e97;
      --accent:#00a7c7;
      --secondary:#6c757d;
      --danger:#dc3545;
      --bg-grad-1:#e9f3ff;       /* Ø®Ù„ÙÙŠØ© ØªØ¯Ø±Ù‘Ø¬ */
      --bg-grad-2:#f6fbff;
      --card:#ffffff;
      --text:#243143;
      --muted:#66768a;
      --border:#e2e8f0;
      --focus:rgba(11,99,194,.18);
      --shadow:0 10px 25px rgba(15, 57, 105, .08);
      --radius:16px;

      /* === ØªØ­Ø±ÙŠÙƒ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‡ÙˆÙ… Ø¨Ø³Ù‡ÙˆÙ„Ø© === */
      --home-offset-y: 18px;   /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ù†Ø²Ù‘Ù„Ù‡Ø§ Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ø±Ù‚Ù…) */
      --home-offset-x: 18px;   /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø£ÙÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ ÙÙŠ RTL */
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 80% 0%, var(--bg-grad-1), var(--bg-grad-2));
      padding: 2rem 1rem;
    }
    .container{
      max-width: 980px;
      margin: 0 auto;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px 26px 30px;
      position: relative;
      overflow: hidden;
    }
    /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ù„Ø·ÙŠÙ */
    .top-ribbon{
      position:absolute; inset:0 0 auto 0; height:6px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‡ÙˆÙ… - ØªØµÙ…ÙŠÙ… Ù…ÙØ­Ø³Ù‘Ù† ÙˆØªØ­Ø±Ù‘Ùƒ Ù…Ù†Ø·Ù‚ÙŠ RTL */
    .home-icon{
      position:absolute;
      inset-block-start: var(--home-offset-y);   /* Ø¨Ø¯ÙŠÙ„ top */
      inset-inline-start: var(--home-offset-x);  /* ÙÙŠ RTL = ÙŠÙ…ÙŠÙ† */
      width:54px; height:54px;
      border-radius:14px;                         /* Ø²ÙˆØ§ÙŠØ§ Ù†Ø§Ø¹Ù…Ø© */
      background: linear-gradient(135deg, #0b63c2, #00a7c7);
      color:#fff; font-size:24px; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 6px 18px rgba(11, 99, 194, .22);
      cursor:pointer; user-select:none;
      transition: transform .14s ease, background .25s ease, box-shadow .25s ease;
      z-index: 5;
    }
    .home-icon:hover{
      background: linear-gradient(135deg, #084e97, #0091a8);
      transform: translateY(-1px) scale(1.04);
      box-shadow: 0 10px 24px rgba(11, 99, 194, .28);
    }

    h2{
      margin: 10px 0 24px;
      font-weight:700;
      letter-spacing:.2px;
      color:var(--primary);
      text-align:center;
    }
    .subtext{
      text-align:center; color:var(--muted); margin-top:-10px; margin-bottom:22px; font-size:.95rem;
    }
    .section-title{
      font-size:1.08rem; font-weight:700; color:var(--primary);
      border-bottom:2px solid var(--primary);
      display:flex; align-items:center; gap:.5rem;
      padding-bottom:.5rem; margin: 26px 0 16px;
    }
    .section-title .dot{ width:9px; height:9px; border-radius:50%; background:var(--accent); display:inline-block; }

    label{font-weight:600; display:block; margin:.8rem 0 .35rem;}
    .hint{font-size:.86rem; color:var(--muted); margin-top:.15rem;}

    input, select, textarea{
      width:100%; box-sizing:border-box;
      border:1px solid var(--border); border-radius:10px; padding:.75rem .9rem;
      font-size:1rem; background:#fff;
      transition:border-color .2s, box-shadow .2s, background .2s;
    }
    input::placeholder, textarea::placeholder{ color:#9aa8b8; }
    input:focus, select:focus, textarea:focus{
      outline:none; border-color:var(--primary);
      box-shadow: 0 0 0 3px var(--focus);
      background:#fbfdff;
    }
    textarea{ min-height:120px; resize:vertical; }

    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    /* Ø²Ø±Ù‘Ø§Ù† Ø£Ù†Ø­Ù ÙˆØ£Ù†ÙŠÙ‚ */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      border:none; border-radius:10px; color:#fff; cursor:pointer;
      padding:.6rem 1rem; font-weight:700; font-size:.98rem;
      transition: transform .06s ease, filter .2s ease, background .25s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--primary); }
    .btn-primary:hover{ background: var(--primary-dark); }
    .btn-danger{ background: var(--danger); }
    .btn-danger:hover{ filter: brightness(.95); }
    .btn-compact{ padding:.5rem .9rem; font-size:.95rem; border-radius:9px; }

    .actions{
      display:flex; gap:10px; justify-content: center; align-items:center;
      margin-top: 20px;
    }

    .image-upload{
      border:2px dashed var(--border); border-radius:12px; padding:18px;
      text-align:center; color:var(--muted);
      transition: border-color .25s, background .25s;
      cursor:pointer;
    }
    .image-upload:hover{ border-color:var(--primary); background: #f6fbff; }
    #image-upload-input{ display:none; }
    #image-preview{ max-width:100%; max-height:320px; display:none; border-radius:10px; border:1px solid var(--border); }
    #image-meta{ font-size:.9rem; color:var(--muted); margin-top:8px; display:none; }

    .note{
      padding:12px 14px; border:1px dashed var(--border); border-radius:10px;
      background:#fcfdff; color:var(--muted); font-size:.92rem; margin-top:8px;
    }

    .notification{
      margin-top:16px; padding:12px 14px; border-radius:10px; display:none; text-align:center; font-weight:600;
    }
    .notification.info{ background:#e9f4ff; color:#114a86; border:1px solid #cfe6ff; }
    .notification.error{ background:#fde8ea; color:#7a1f27; border:1px solid #f5c6cb; }

    #response-container{
      margin-top: 20px;
      padding:16px; border:1px solid var(--border); border-radius:12px; background:#fff; display:none;
      box-shadow: var(--shadow);
    }

    /* ØªÙ„ÙˆÙŠÙ† ÙƒØ±ÙˆØª Ø§Ù„Ù‚Ø±Ø§Ø±/Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
    #response-container .risk-high{ color:#721c24; background:#f8d7da; padding:.18rem .5rem; border-radius:6px; border:1px solid #f5c6cb; font-weight:700; }
    #response-container .risk-medium{ color:#856404; background:#fff3cd; padding:.18rem .5rem; border-radius:6px; border:1px solid #ffeeba; font-weight:700; }
    #response-container .risk-low{ color:#155724; background:#d4edda; padding:.18rem .5rem; border-radius:6px; border:1px solid #c3e6cb; font-weight:700; }

    .muted-mini{ font-size:.82rem; color:#92a3b6; text-align:center; margin-top:10px; }

    /* Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ: Ù†Ø­ØªØ§Ø¬ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© .hidden */
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-ribbon"></div>
    <div class="home-icon" title="Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" onclick="goToHome()">ğŸ </div>

    <h2>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ†</h2>
    <div class="subtext">ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ±ÙŠØ© Ø³Ù‡Ù„Ø© â€” ØªØ­Ù„ÙŠÙ„ Ù…Ø¤ØªÙ…Øª ÙˆØ±Ø¨Ø· Ù…Ø¹ Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ†</div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    <div class="section-title"><span class="dot"></span> 1) Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</div>
    <div class="grid">
      <div>
        <label for="gender">Ø§Ù„Ø¬Ù†Ø³</label>
        <select id="gender">
          <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
          <option value="male">Ø°ÙƒØ±</option>
          <option value="female">Ø£Ù†Ø«Ù‰</option>
        </select>
        <div class="hint">Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø±ÙŠØ¶Ø© Ø£Ù†Ø«Ù‰ØŒ Ø³ØªØ¸Ù‡Ø± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
      </div>

      <div>
        <label for="age">Ø§Ù„Ø¹Ù…Ø±</label>
        <input id="age" type="number" placeholder="Ù…Ø«Ø§Ù„: 63">
      </div>

      <div id="pregnancy-status-wrap" class="hidden">
        <label for="pregnancy-status">Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶Ø© Ø­Ø§Ù…Ù„ØŸ</label>
        <select id="pregnancy-status">
          <option value="" selected disabled>Ø§Ø®ØªØ±</option>
          <option value="yes">Ù†Ø¹Ù…</option>
          <option value="no">Ù„Ø§</option>
        </select>
      </div>

      <div id="pregnancy-month-wrap" class="hidden">
        <label for="pregnancy-month">Ø´Ù‡Ø± Ø§Ù„Ø­Ù…Ù„</label>
        <input id="pregnancy-month" type="number" min="1" max="9" placeholder="Ù…Ø«Ø§Ù„: 5">
      </div>

      <div>
        <label for="height">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label>
        <input id="height" type="number" placeholder="Ù…Ø«Ø§Ù„: 175">
      </div>

      <div>
        <label for="weight">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
        <input id="weight" type="number" placeholder="Ù…Ø«Ø§Ù„: 80">
      </div>

      <div>
        <label for="temperature">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°Ù…)</label>
        <input id="temperature" type="text" placeholder="Ù…Ø«Ø§Ù„: 37.6">
      </div>

      <div>
        <label for="blood-pressure">Ø¶ØºØ· Ø§Ù„Ø¯Ù…</label>
        <input id="blood-pressure" type="text" placeholder="Ù…Ø«Ø§Ù„: 120/80">
      </div>
    </div>

    <!-- ØªÙ†ÙØ³ ÙˆØªØ¯Ø®ÙŠÙ† ÙˆØ¹ÙŠÙˆÙ† -->
    <div class="section-title"><span class="dot"></span> 2) Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ø£Ø¹Ø±Ø§Ø¶</div>
    <div class="grid">
      <div>
        <label for="smoker">Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¯Ø®Ù‘Ù†ØŸ</label>
        <select id="smoker">
          <option value="" selected disabled>Ø§Ø®ØªØ±</option>
          <option value="yes">Ù†Ø¹Ù…</option>
          <option value="no">Ù„Ø§</option>
        </select>
      </div>

      <div id="pack-years-wrap" class="hidden">
        <label for="pack-years">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§Ùƒ-Ø³Ù†Ø©</label>
        <input id="pack-years" type="number" placeholder="Ù…Ø«Ø§Ù„: 35">
        <div class="hint">Ø§Ù„Ø¨Ø§Ùƒ-Ø³Ù†Ø© = (Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù„Ø¨ ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ã— Ø¹Ø¯Ø¯ Ø³Ù†ÙˆØ§Øª Ø§Ù„ØªØ¯Ø®ÙŠÙ†)</div>
      </div>

      <div>
        <label for="cough-duration">Ù…Ø¯Ø© Ø§Ù„Ø³Ø¹Ø§Ù„ (Ø£Ø³Ø§Ø¨ÙŠØ¹)</label>
        <input id="cough-duration" type="number" placeholder="Ù…Ø«Ø§Ù„: 12">
      </div>

      <div>
        <label for="visual-symptoms">Ø£Ø¹Ø±Ø§Ø¶ Ø¨ØµØ±ÙŠØ©ØŸ</label>
        <select id="visual-symptoms">
          <option value="" selected disabled>Ø§Ø®ØªØ±</option>
          <option value="yes">Ù†Ø¹Ù…</option>
          <option value="no">Ù„Ø§</option>
        </select>
      </div>

      <div id="eye-wrap" class="hidden">
        <label for="last-eye-exam">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙØ­Øµ Ù‚Ø§Ø¹ Ø¹ÙŠÙ†</label>
        <input id="last-eye-exam" type="date">
        <label for="visual-acuity">Ø­Ø¯Ø© Ø§Ù„Ø¨ØµØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="visual-acuity" type="text" placeholder="Ù…Ø«Ø§Ù„: 6/12 Ø£Ùˆ 20/40">
      </div>
    </div>

    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div class="section-title"><span class="dot"></span> 3) ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</div>
    <div class="grid">
      <div>
        <label for="case-description">ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <textarea id="case-description" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¹Ø§Ù„ Ù…Ø²Ù…Ù† 12 Ø£Ø³Ø¨ÙˆØ¹Ù‹Ø§ Ù…Ø¹ ÙÙ‚Ø¯Ø§Ù† ÙˆØ²Ù† Ø¨Ø³ÙŠØ· ÙˆØ¯ÙˆØ®Ø© Ù…ØªÙ‚Ø·Ø¹Ø©..."></textarea>
      </div>
      <div>
        <label for="diagnosis">Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©</label>
        <textarea id="diagnosis" placeholder="Ù…Ø«Ø§Ù„: T2DM, HTN, COPD? Dermatitis"></textarea>
      </div>
      <div>
        <label for="lab-results">Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„/Ø§Ù„Ø£Ø´Ø¹Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø©</label>
        <textarea id="lab-results" placeholder="Ù…Ø«Ø§Ù„: HbA1c 8.7%, eGFR 38â†’62, K 5.6, INR ØºÙŠØ± Ù…ØªØ§Ø­..."></textarea>
      </div>
      <div>
        <label for="medications-procedures">Ø§Ù„Ø£Ø¯ÙˆÙŠØ©/Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø©</label>
        <textarea id="medications-procedures" placeholder="Ù…Ø«Ø§Ù„: Xigduo XR bid, Metformin 1000 tid, Ramipril 10 bid, Spironolactone 50 bid, Ibuprofen 400 tid, Warfarin + Aspirin + Clopidogrel + Rivaroxaban, Clarithromycin + Ciprofloxacin, Allopurinol 300 qd, CT contrast Ø§Ù„ÙŠÙˆÙ…, Ù‚Ø³Ø·Ø±Ø© Ù‚Ù„Ø¨ Ø¹Ø§Ø¬Ù„Ø©..."></textarea>
      </div>
    </div>

    <!-- Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª -->
    <div class="section-title"><span class="dot"></span> 4) Ø±ÙØ¹ Ù…Ù„ÙØ§Øª (ÙˆØµÙØ©/ØªÙ‚Ø±ÙŠØ±) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ</div>
    <div class="image-upload" onclick="document.getElementById('image-upload-input').click()">
      Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© (PNG/JPG)
      <input id="image-upload-input" type="file" accept="image/*">
      <div class="note">Ù†Ù†ØµØ­ Ø¨Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ø¶Ø­Ø©. Ø³Ù†Ø¶ØºØ·Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ØªÙØ§Ø¯ÙŠ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ø¬Ù….</div>
    </div>
    <div style="margin-top:10px;">
      <img id="image-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
      <div id="image-meta"></div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± -->
    <div class="actions">
      <button id="analyzeBtn" class="btn btn-primary btn-compact" onclick="analyzeCase()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
      <button class="btn btn-danger btn-compact" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="muted-mini">Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©" Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù„ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± HTML Ø´Ø§Ù…Ù„ Ù„Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆØ§Ù„ØªØ£Ù…ÙŠÙ†.</div>

    <div id="notification-area" class="notification info"></div>
    <div id="response-container"></div>
  </div>

  <script>
    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø´Ø±Ø·ÙŠØ©
    const genderEl = document.getElementById('gender');
    const pregStatWrap = document.getElementById('pregnancy-status-wrap');
    const pregMonthWrap = document.getElementById('pregnancy-month-wrap');
    const pregStatEl = document.getElementById('pregnancy-status');

    genderEl.addEventListener('change', () => {
      const isFemale = genderEl.value === 'female';
      pregStatWrap.classList.toggle('hidden', !isFemale);
      if (!isFemale){
        pregMonthWrap.classList.add('hidden');
        pregStatEl.value = "";
        document.getElementById('pregnancy-month').value="";
      }
    });
    pregStatEl.addEventListener('change', () => {
      const showMonth = pregStatEl.value === 'yes';
      pregMonthWrap.classList.toggle('hidden', !showMonth);
      if (!showMonth){ document.getElementById('pregnancy-month').value=""; }
    });

    const smokerEl = document.getElementById('smoker');
    const packYearsWrap = document.getElementById('pack-years-wrap');
    smokerEl.addEventListener('change', () => {
      packYearsWrap.classList.toggle('hidden', smokerEl.value !== 'yes');
      if (smokerEl.value !== 'yes') document.getElementById('pack-years').value="";
    });

    const visualEl = document.getElementById('visual-symptoms');
    const eyeWrap = document.getElementById('eye-wrap');
    visualEl.addEventListener('change', () => {
      eyeWrap.classList.toggle('hidden', visualEl.value !== 'yes');
      if (visualEl.value !== 'yes'){
        document.getElementById('last-eye-exam').value="";
        document.getElementById('visual-acuity').value="";
      }
    });

    // Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
    const imageInput = document.getElementById('image-upload-input');
    const imagePreview = document.getElementById('image-preview');
    const imageMeta = document.getElementById('image-meta');
    let imageBase64 = null;

    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const { base64, info } = await compressImage(file, { maxW: 1400, maxH: 1400, quality: 0.7 });
        imageBase64 = base64;
        imagePreview.src = 'data:image/jpeg;base64,' + base64;
        imagePreview.style.display = 'block';
        imageMeta.style.display = 'block';
        imageMeta.textContent = `Ø§Ù„Ø­Ø¬Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ·: ${info.sizeKB.toFixed(1)} KB â€” Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: ${info.w}Ã—${info.h}`;
      } catch (err) {
        showNote('error', 'ØªØ¹Ø°Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. Ø­Ø§ÙˆÙ„ ØµÙˆØ±Ø© Ø£ØµØºØ±/Ø£ÙˆØ¶Ø­.');
        console.error(err);
      }
    });

    async function compressImage(file, { maxW=1400, maxH=1400, quality=0.7 } = {}){
      const dataURL = await new Promise((res, rej)=>{
        const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror = rej; r.readAsDataURL(file);
      });
      const img = await new Promise((res, rej)=>{
        const i = new Image(); i.onload = ()=> res(i); i.onerror = rej; i.src = dataURL;
      });
      let { width:w, height:h } = img;
      const ratio = Math.min(maxW/w, maxH/h, 1);
      w = Math.round(w*ratio); h = Math.round(h*ratio);
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      const out = canvas.toDataURL('image/jpeg', quality);
      const base64 = out.split(',')[1];
      const sizeKB = (base64.length * 3) / 4 / 1024;
      return { base64, info:{ w,h,sizeKB } };
    }

    // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    const noteArea = document.getElementById('notification-area');
    function showNote(type, text){
      noteArea.className = 'notification ' + (type === 'error' ? 'error' : 'info');
      noteArea.textContent = text;
      noteArea.style.display = 'block';
    }
    function clearNote(){ noteArea.style.display='none'; noteArea.textContent=''; }

    // Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª
    function goToHome(){ window.location.href = 'https://www.m2020m.org/portal.html'; }
    function logout(){ /* Ø§Ø±Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ù†Ø§ */ showNote('info','ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù†Ù…ÙˆØ°Ø¬).'); }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„
    async function analyzeCase(){
      const responseContainer = document.getElementById('response-container');
      const btn = document.getElementById('analyzeBtn');
      clearNote(); responseContainer.style.display='none'; responseContainer.innerHTML='';

      // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const caseData = {
        userType:'doctor',
        age: document.getElementById('age').value || undefined,
        gender: document.getElementById('gender').value || undefined,
        isSmoker: document.getElementById('smoker').value === 'yes' ? true : (document.getElementById('smoker').value === 'no' ? false : undefined),
        smokingPackYears: document.getElementById('pack-years').value || undefined,
        coughDurationWeeks: document.getElementById('cough-duration').value || undefined,
        visualSymptoms: document.getElementById('visual-symptoms').value || undefined,
        lastEyeExamDate: document.getElementById('last-eye-exam').value || undefined,
        visualAcuity: document.getElementById('visual-acuity').value || undefined,
        height: document.getElementById('height').value || undefined,
        weight: document.getElementById('weight').value || undefined,
        temperature: document.getElementById('temperature').value || undefined,
        bloodPressure: document.getElementById('blood-pressure').value || undefined,

        notes: document.getElementById('case-description').value || '',
        diagnosis: document.getElementById('diagnosis').value || '',
        labResults: document.getElementById('lab-results').value || '',
        medications: document.getElementById('medications-procedures').value || '',
        imageData: imageBase64 ? [imageBase64] : []
      };

      if (
        !caseData.notes && !caseData.diagnosis && !caseData.labResults &&
        !caseData.medications && caseData.imageData.length === 0
      ){
        showNote('error','Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ø±ÙØ¹ ØµÙˆØ±Ø©.');
        return;
      }

      showNote('info','Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©â€¦ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„Ø£Ù…Ø± Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
      btn.disabled = true;

      // Ø·Ù„Ø¨ Ù…Ø¹ Ù…Ù‡Ù„Ø© (timeout)
      const controller = new AbortController();
      const t = setTimeout(()=> controller.abort(), 60000);

      try{
        const res = await fetch('/api/gpt', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(caseData),
          signal: controller.signal
        });

        const text = await res.text();
        if (!res.ok){
          // Ø£Ø­Ø¬Ø§Ù… ÙƒØ¨ÙŠØ±Ø©
          if (res.status === 413 || /Entity Too Large|Content Too Large/i.test(text)){
            throw new Error('Ø§Ù„Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±: Ù‚Ù„Ù‘Ù„ Ø¬ÙˆØ¯Ø©/Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
          }
          // Ø®Ø·Ø£ Ø¹Ø§Ù…
          throw new Error(`ÙØ´Ù„ (${res.status}): ${text.slice(0,200)}â€¦`);
        }

        let data;
        try{ data = JSON.parse(text); }
        catch{ throw new Error('Ø§Ù„Ø±Ø¯ Ù„ÙŠØ³ JSON ØµØ§Ù„Ø­Ù‹Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….');
        }

        if (data?.htmlReport){
          clearNote();
          responseContainer.innerHTML = data.htmlReport;
          responseContainer.style.display = 'block';
          responseContainer.scrollIntoView({ behavior:'smooth', block:'start' });
        } else {
          throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ØªÙ‚Ø±ÙŠØ± HTML Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….');
        }
      } catch(err){
        console.error(err);
        showNote('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ' + err.message);
      } finally {
        clearTimeout(t);
        btn.disabled = false;
      }
    }
    window.analyzeCase = analyzeCase;
  </script>
</body>
</html>
