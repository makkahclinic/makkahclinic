<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1220; --ink:#d5e1ff; --muted:#7982a9; --box:#0f1830; --accent:#3b82f6; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", sans-serif; background:#0b1220; color:#dfe7ff; margin:0; }
    header { padding:16px 20px; border-bottom:1px solid #1f2a44; }
    main { max-width:1100px; margin:24px auto; padding:0 16px 100px; }
    fieldset { border:1px solid #1f2a44; border-radius:12px; padding:16px; margin:14px 0; background: #0f1830; }
    legend { color:#9db0ff; padding:0 8px; }
    label { display:block; margin:.4rem 0 .2rem; color:#baceff; }
    select, input[type="text"], textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #263455; background:#0b1328; color:#dfe7ff; }
    textarea { min-height:92px; resize:vertical; }
    .row { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .btn { appearance:none; border:1px solid #3352a3; background:#1b2d66; color:#e7efff; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:hover { background:#24408d; }
    .btn.secondary { background:#132243; border-color:#2a3f7a; }
    .pill { display:inline-block; padding:2px 8px; background:#132243; border:1px solid #2a3f7a; border-radius:999px; color:#a8c3ff; font-size:.8rem; }
    .stack { display:flex; gap:10px; flex-wrap:wrap; }
    pre { background:#070d1a; color:#d6e4ff; padding:12px; border:1px dashed #28407a; border-radius:10px; max-height:400px; overflow:auto; }
    .grid { display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width:1000px){ .grid { grid-template-columns: 1fr 1fr; } }
    .copy { float:left; margin-top:6px; }
    small.muted { color:#96a6d8; }
  </style>

  <!-- PDF.js (ثابت وموثوق) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    // مهم: ضبط عامل العمل للـ PDF.js حتى لا يظهر خطأ pdfjsLib is not defined / أو فشل العامل
    // راجع توثيق Mozilla PDF.js حول ضرورة تحديد الـ workerSrc عند التحميل عبر CDN.
    // https://mozilla.github.io/pdf.js/examples/  و  https://stackoverflow.com/a/67242471
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>
</head>
<body>
<header>
  <div class="stack">
    <span class="pill">API Version: v6.2</span>
    <span class="pill">PDF → صور + نص (محليًا)</span>
    <span class="pill">إزالة PHI على الخادم</span>
  </div>
</header>

<main>
  <fieldset>
    <legend>اختر ملفات (صورة/‏PDF)</legend>
    <input id="fileInput" type="file" accept="image/*,.pdf" multiple />
    <small class="muted">سيحوَّل أي PDF إلى صور، ويُستخرج نصّه لرفع الدقة.</small>
  </fieldset>

  <div class="row">
    <fieldset>
      <legend>اللغة</legend>
      <select id="language">
        <option value="ar">العربية</option>
        <option value="en">English</option>
      </select>
    </fieldset>

    <fieldset>
      <legend>النموذج</legend>
      <select id="whichModel">
        <option value="both">Gemini + GPT‑4o</option>
        <option value="gpt">GPT‑4o فقط</option>
        <option value="gemini">Gemini فقط</option>
      </select>
    </fieldset>

    <fieldset>
      <legend>التخصص (اختياري)</legend>
      <input id="specialty" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
    </fieldset>
  </div>

  <fieldset>
    <legend>وصف مختصر/سياق التأمين (اختياري)</legend>
    <textarea id="context" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما"></textarea>
  </fieldset>

  <div class="stack">
    <button class="btn secondary" id="prepBtn">تحضير الملفات</button>
    <button class="btn" id="analyzeBtn">تحليل الحالة</button>
  </div>

  <fieldset>
    <legend>السجل</legend>
    <pre id="log">لم يتم التحضير بعد.</pre>
  </fieldset>

  <fieldset>
    <legend>النتيجة المدمجة <button class="btn secondary copy" data-copy="#mergedOut">نسخ JSON</button></legend>
    <pre id="mergedOut"></pre>
  </fieldset>

  <div class="grid">
    <fieldset>
      <legend>مخرجات GPT‑4o <button class="btn secondary copy" data-copy="#gptOut">نسخ JSON</button></legend>
      <pre id="gptOut"></pre>
    </fieldset>
    <fieldset>
      <legend>مخرجات Gemini <button class="btn secondary copy" data-copy="#gemOut">نسخ JSON</button></legend>
      <pre id="gemOut"></pre>
    </fieldset>
  </div>
</main>

<script>
  const $ = sel => document.querySelector(sel);
  const log = (...args) => { const el = $('#log'); el.textContent += (el.textContent.trim()? '\n' : '') + args.join(' '); };

  const state = { images: [], texts: [] };

  // ضغط صورة (مع احترام العرض الأقصى لتقليل حجم الطلب)
  async function compressImageToDataURL(fileOrUrl, maxW = 1400) {
    const img = new Image();
    img.crossOrigin = 'anonymous';

    const url = typeof fileOrUrl === 'string' ? fileOrUrl : URL.createObjectURL(fileOrUrl);
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = url; });

    const scale = Math.min(1, maxW / img.naturalWidth);
    const canvas = document.createElement('canvas');
    canvas.width  = Math.round(img.naturalWidth * scale);
    canvas.height = Math.round(img.naturalHeight * scale);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/png', 0.9);
    if (typeof fileOrUrl !== 'string') URL.revokeObjectURL(url);
    return { dataUrl, contentType: 'image/png' };
  }

  async function pdfToImagesAndText(file) {
    const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
    const pdf = await loadingTask.promise;
    log(`> PDF: ${file.name}، صفحات: ${pdf.numPages}`);

    const images = [], texts = [];
    for (let p = 1; p <= pdf.numPages; p++) {
      const page = await pdf.getPage(p);
      const viewport = page.getViewport({ scale: 1 });
      const scale = Math.min(1.8, 1200 / viewport.width); // يحدد العرض ~1200px
      const v = page.getViewport({ scale });

      const canvas = document.createElement('canvas');
      canvas.width = v.width|0; canvas.height = v.height|0;
      await page.render({ canvasContext: canvas.getContext('2d'), viewport: v }).promise;
      images.push({ dataUrl: canvas.toDataURL('image/png', 0.9), contentType: 'image/png' });

      const txt = await page.getTextContent();
      texts.push(txt.items.map(i => i.str).join(' ').replace(/\s+/g,' ').trim());
      log(`✓ رُفعت صفحة ${p}/${pdf.numPages} من ${file.name}`);
    }
    return { images, texts };
  }

  async function prepareFiles() {
    try {
      if (typeof pdfjsLib === 'undefined') {
        alert('فشل التحضير: pdfjsLib is not defined — تأكّد أن كود PDF.js تم تحميله (حملناه من CDN).');
        return;
      }
      state.images = []; state.texts = [];
      const files = $('#fileInput').files;
      if (!files.length) { alert('اختر ملفات أولًا.'); return; }

      $('#log').textContent = 'بدء التحضير ... < تحويل PDF واستخراج نص (إن وجد)';
      for (const f of files) {
        if (f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')) {
          const { images, texts } = await pdfToImagesAndText(f);
          state.images.push(...images);
          state.texts.push(...texts);
        } else {
          const img = await compressImageToDataURL(f, 1400);
          state.images.push(img);
          log(`✓ صورة: ${f.name}`);
        }
      }
      const msg = `تم تجهيز ${state.images.length} صورة/صفحة + ${state.texts.length ? 'نص PDF' : 'بدون نص' } للتحليل.`;
      $('#log').textContent += `\n${msg}`;
    } catch (e) {
      console.error(e);
      alert('حدث خطأ أثناء التحضير: ' + (e?.message || e));
    }
  }

  async function analyze() {
    if (!state.images.length && !state.texts.length) {
      alert('حضّر الملفات أولًا.');
      return;
    }
    $('#mergedOut').textContent = ''; $('#gptOut').textContent = ''; $('#gemOut').textContent = '';
    log('بدء التحليل ...');

    const body = {
      language: $('#language').value,
      model: $('#whichModel').value,
      specialty: $('#specialty').value || 'عام',
      insuranceContext: $('#context').value || '',
      images: state.images, texts: state.texts
    };

    try {
      const res = await fetch('/api/gpt', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || 'فشل التحليل');

      $('#mergedOut').textContent = JSON.stringify(data.merged, null, 2);
      if (data.gpt) $('#gptOut').textContent = JSON.stringify(data.gpt, null, 2);
      if (data.gemini) $('#gemOut').textContent = JSON.stringify(data.gemini, null, 2);
      log('اكتمل التحليل.');
    } catch (e) {
      console.error(e);
      alert('فشل التحليل: ' + (e?.message || e));
    }
  }

  document.addEventListener('click', (ev) => {
    if (ev.target.matches('.copy')) {
      const t = document.querySelector(ev.target.dataset.copy).textContent;
      navigator.clipboard.writeText(t || '').then(() => {
        ev.target.textContent = 'نُسخ ✓';
        setTimeout(() => ev.target.textContent = 'نسخ JSON', 1200);
      });
    }
  });

  $('#prepBtn').addEventListener('click', prepareFiles);
  $('#analyzeBtn').addEventListener('click', analyze);
</script>
</body>
</html>
