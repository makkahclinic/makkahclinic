# واجهة كاملة (كل الميزات) + تصدير PDF من الخادم فقط

> هذه نسخة شاملة تُبقي كل الميزات التي كانت عندك (النماذج، الرفع، التحليل، الإظهار المهيكل، i18n عربي/إنجليزي، RTL) لكن **تستبدل التصدير بالكامل** بمسار خادمي ثابت لضمان PDF مطابق للمعاينة.

---

## 1) صفحة الواجهة (HTML كاملة)

```html
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="app-title">تقييم الحالة الطبية وطلبات التأمين</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --sea-50:#eef7ff; --sea-100:#d9efff; --sea-200:#b6dfff; --sea-300:#87c7ff; --sea-400:#4aa6ff; --sea-500:#1e90ff; --sea-600:#1677d3; --sea-700:#105ca5; --sea-800:#0b4479; --sea-900:#082f55;
      --ok:#2e7d32; --warn:#f9a825; --bad:#d93025; --muted:#6b7280; --card:#ffffff; --ring:#d1e8ff; --ink:#202124; --ink2:#3c4043;
    }
    *{box-sizing:border-box}
    body{font-family:"Tajawal",system-ui; background:linear-gradient(180deg,var(--sea-50),#fff); color:var(--ink); margin:0}
    html[dir="ltr"] body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
    .container{max-width:1050px; margin:24px auto; padding:16px}
    .title{display:flex; align-items:center; justify-content:center; gap:10px; color:var(--sea-800)}
    h1{font-size:28px; margin:8px 0 2px}
    .subtitle{color:var(--muted); font-size:14px; text-align:center; margin-bottom:14px}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px}
    .chip{border:1px solid #e5e7eb; padding:8px 10px; border-radius:12px; font-size:14px; background:#fff; cursor: pointer;}
    .home{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:var(--sea-500); color:#fff; border-radius:12px; text-decoration:none; border:1px solid var(--sea-600)}
    .home svg{width:18px; height:18px; fill:#fff}

    .evidence-banner{background:#eef6ff; border:1px solid #bfdbfe; color:#0b4479; padding:10px 12px; border-radius:12px; margin-bottom:12px; font-size:13px; display:flex; align-items:center; gap:8px}
    .evidence-banner svg{width:18px; height:18px; flex:0 0 auto}

    .section{margin-top:18px}
    .section h2{font-size:18px; color:var(--sea-700); display:flex; align-items:center; gap:8px; margin:0 0 10px}
    .dot{width:8px; height:8px; background:var(--sea-500); border-radius:50%}
    .card{border:1px dashed #dbeafe; background:#f8fbff; border-radius:14px; padding:14px}

    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}

    label{display:block; font-size:14px; color:#0f172a; margin-bottom:6px}
    input, select, textarea{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; outline:none}
    input:focus, select:focus, textarea:focus{border-color:var(--sea-400); box-shadow:0 0 0 4px var(--ring)}
    textarea{min-height:90px; resize:vertical}

    .uploader{border:2px dashed #cfe6ff; border-radius:16px; padding:26px; text-align:center; color:#64748b; background:#f5faff; cursor:pointer}
    .uploader.drag{background:#eef6ff}
    .uploader input{display:none}
    .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin-top:12px}
    .fileCard{position:relative; background:#fff; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; box-shadow:0 8px 22px rgba(2,6,23,.05)}
    .thumb{width:100%; height:150px; object-fit:cover; display:block; background:#f1f5f9}
    .meta{padding:10px 12px; font-size:13px; color:#334155}
    .remove{position:absolute; top:10px; right:10px; width:30px; height:30px; border-radius:50%; background:var(--bad); color:#fff; border:none; cursor:pointer; font-weight:700}

    .btn{appearance:none; border:none; cursor:pointer; padding:14px 18px; border-radius:14px; background:var(--sea-600); color:#fff; font-weight:700}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn-secondary{background:#0b4479}
    .btn-outline{background:#fff; color:var(--sea-700); border:1px solid #cbd5e1}

    #reportWrap{margin-top:24px}
    .report-toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
    .muted{color:var(--muted)}

    /* ====== معاينة/طباعة A4 ثابتة ====== */
    .print-page{ width:190mm; min-height:257mm; margin:0 auto; background:#fff; color:var(--ink2); border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 8px 32px rgba(2,6,23,.08); padding:10mm; overflow:visible }
    .print-section{ margin-bottom:12mm }
    .avoid-break, .card, table, tr, td, th, img { break-inside: avoid; page-break-inside: avoid; }

    @page{ size:A4; margin:10mm }
    @media print{ .no-print{display:none !important} body{background:#fff} .container{box-shadow:none; border:none} .print-page{ box-shadow:none; border:none; border-radius:0; width:auto; min-height:auto; margin:0; padding:0 } }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="home" href="https://www.m2020m.org/portal.html" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span data-translate="home_page">الصفحة الرئيسية</span>
      </a>
      <div style="display:flex; gap:10px; align-items:center">
        <span class="chip" id="lang-switcher" data-translate="lang_english">English</span>
        <button class="btn-secondary btn no-print" id="exportPdfBtn" data-translate="export_button">تصدير PDF</button>
      </div>
    </div>

    <div class="title"><h1 data-translate="main_title">تقييم الحالة الطبية وطلبات التأمين</h1></div>
    <p class="subtitle" data-translate="subtitle">واجهة إدخال سريرية سهلة — تحليل عميق متناغم مع احتياجات التأمين</p>

    <div class="evidence-banner">
      <svg viewBox="0 0 24 24"><path fill="#0b4479" d="M12 2 1 21h22L12 2Zm1 15h-2v-2h2v2Zm0-4h-2V8h2v5Z"/></svg>
      <div data-translate="evidence_banner">يستند الحكم التأميني إلى أدلة موجزة من <b>WHO</b> و<b>CDC</b> و<b>Medscape</b>—ويظهر التبرير داخل الجدول.</div>
    </div>

    <!-- (1) معلومات المريض -->
    <div class="section">
      <h2><span class="dot"></span><span data-translate="patient_info_title"> 1) معلومات المريض</span></h2>
      <div class="card avoid-break">
        <div class="grid">
          <div class="col-4"><label data-translate="label_name">الاسم (اختياري)</label><input id="name" data-translate-placeholder="placeholder_name" placeholder="مثال: أحمد خالد" /></div>
          <div class="col-4">
            <label data-translate="label_gender">الجنس</label>
            <select id="gender">
              <option value="" data-translate="option_select">اختر</option>
              <option value="ذكر" data-translate="option_male">ذكر</option>
              <option value="أنثى" data-translate="option_female">أنثى</option>
            </select>
          </div>
          <div class="col-4"><label data-translate="label_age">العمر (بالسنوات)</label><input id="age" type="number" min="0" data-translate-placeholder="placeholder_age" placeholder="مثال: 63" /></div>

          <div class="col-4">
            <label data-translate="label_pregnant">هل المريضة حامل؟</label>
            <select id="pregnant">
              <option value="no" data-translate="option_no">لا</option>
              <option value="yes" data-translate="option_yes">نعم</option>
              <option value="na" data-translate="option_na">غير منطبق</option>
            </select>
          </div>
          <div class="col-4"><label data-translate="label_pregnancy_months">شهر الحمل (إن وُجد)</label><input id="pregnancyMonths" type="number" min="1" max="10" data-translate-placeholder="placeholder_pregnancy_months" placeholder="مثال: 5" /></div>

          <div class="col-4">
            <label data-translate="label_smoking">هل المريض مدخّن؟</label>
            <select id="smoking">
              <option value="" data-translate="option_select">اختر</option>
              <option value="مدخن" data-translate="option_smoker">مدخن</option>
              <option value="غير مدخن" data-translate="option_non_smoker">غير مدخن</option>
              <option value="سابق" data-translate="option_ex_smoker">سابق</option>
            </select>
          </div>

          <div class="col-4"><label data-translate="label_pack_years">Pack-Years (إن وُجد)</label><input id="packYears" type="number" min="0" step="0.5" data-translate-placeholder="placeholder_pack_years" placeholder="مثال: 15" /></div>
          <div class="col-4"><label data-translate="label_weight">الوزن (كجم)</label><input id="weight" type="number" min="0" step="0.1" data-translate-placeholder="placeholder_weight" placeholder="مثال: 78" /></div>
          <div class="col-4"><label data-translate="label_height">الطول (سم)</label><input id="height" type="number" min="0" step="0.5" data-translate-placeholder="placeholder_height" placeholder="مثال: 172" /></div>

          <div class="col-4"><label data-translate="label_temp">درجة الحرارة (°م)</label><input id="temp" type="number" step="0.1" data-translate-placeholder="placeholder_temp" placeholder="مثال: 37.4" /></div>
          <div class="col-4">
            <label data-translate="label_has_cough">هل يوجد سُعال؟</label>
            <select id="hasCough">
              <option value="" data-translate="option_select">اختر</option>
              <option value="نعم" data-translate="option_yes">نعم</option>
              <option value="لا" data-translate="option_no">لا</option>
            </select>
          </div>
          <div class="col-4"><label data-translate="label_cough_weeks">مدة السعال (أسابيع)</label><input id="coughWeeks" type="number" min="0" data-translate-placeholder="placeholder_cough_weeks" placeholder="مثال: 12" /></div>
          <div class="col-4">
            <label data-translate="label_cough_type">نوع السعال</label>
            <select id="coughType">
              <option value="" data-translate="option_select">اختر</option>
              <option value="جاف" data-translate="option_dry">جاف</option>
              <option value="ببلغم" data-translate="option_productive">ببلغم</option>
              <option value="بدم" data-translate="option_hemoptysis">بدم</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- (2) خطّ الحياة والأعراض -->
    <div class="section">
      <h2><span class="dot"></span><span data-translate="timeline_symptoms_title"> 2) خطّ الحياة والأعراض</span></h2>
      <div class="card avoid-break">
        <div class="grid">
          <div class="col-12"><label data-translate="label_free_text">وصف الحالة (نص حر)</label><textarea id="freeText" data-translate-placeholder="placeholder_free_text" placeholder="مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن بسيط..."></textarea></div>
          <div class="col-6"><label data-translate="label_initial_dx">التشخيصات المبدئية (نص)</label><textarea id="initialDx" data-translate-placeholder="placeholder_initial_dx" placeholder="مثال: T2DM, HTN, COPD? Dermatitis"></textarea></div>
          <div class="col-6"><label data-translate="label_labs_imaging">تحاليل/الأشعة المذكورة (نص)</label><textarea id="labsImaging" data-translate-placeholder="placeholder_labs_imaging" placeholder="مثال: HbA1c 8.7%, eGFR 38→62, K 5.6 ..."></textarea></div>
          <div class="col-12"><label data-translate="label_orders">الأدوية/الإجراءات المقرّرة (إن وُجدت)</label><textarea id="orders" data-translate-placeholder="placeholder_orders" placeholder="مثال: Xigduo XR bid, Metformin 1000 tid ..."></textarea></div>
        </div>
      </div>
    </div>

    <!-- (3) رفع ملفات (صور/PDF) -->
    <div class="section">
      <h2><span class="dot"></span><span data-translate="file_upload_title"> 3) رفع ملفات (صور/PDF) — اختياري</span></h2>
      <label class="uploader no-print" for="fileInput" id="dropZone" data-translate="uploader_text">
        اضغط هنا لرفع ملف واحد أو أكثر
        <input id="fileInput" type="file" multiple accept="image/*,application/pdf" />
      </label>
      <div id="cards" class="cards" aria-live="polite"></div>
      <div id="fileList" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="section no-print" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <button class="btn" id="analyzeBtn" data-translate="analyze_button">تحليل الحالة</button>
      <span id="busy" class="muted" style="display:none" data-translate="analyzing_text">جاري التحليل…</span>
    </div>

    <!-- التقرير (معاينة داخل صفحة A4 ثابتة) -->
    <div id="reportWrap" class="section" style="display:none">
      <div class="report-toolbar no-print">
        <button class="btn-secondary btn" id="exportPdfBtnTop" data-translate="export_button">تصدير PDF</button>
      </div>
      <article id="reportPrintPage" class="print-page" aria-label="A4 preview"></article>
      <details style="margin-top:10px" class="no-print">
        <summary data-translate="show_json_summary">إظهار JSON (للبحث/الإحصاءات)</summary>
        <pre id="jsonOut" style="white-space:pre-wrap; background:#0b44790b; padding:12px; border-radius:12px; border:1px solid #e5e7eb"></pre>
      </details>
      <div class="report-toolbar no-print" style="margin-top:10px">
        <button class="btn-secondary btn" id="exportPdfBtnBottom" data-translate="export_button">تصدير PDF</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Internationalization (i18n) =====
    const translations = {
      ar: {
        app_title: "تقييم الحالة الطبية وطلبات التأمين",
        home_page: "الصفحة الرئيسية",
        lang_english: "English",
        main_title: "تقييم الحالة الطبية وطلبات التأمين",
        subtitle: "واجهة إدخال سريرية سهلة — تحليل عميق متناغم مع احتياجات التأمين",
        evidence_banner: "يستند الحكم التأميني إلى أدلة موجزة من <b>WHO</b> و<b>CDC</b> و<b>Medscape</b>—ويظهر التبرير داخل الجدول.",
        patient_info_title: " 1) معلومات المريض",
        label_name: "الاسم (اختياري)",
        placeholder_name: "مثال: أحمد خالد",
        label_gender: "الجنس",
        option_select: "اختر",
        option_male: "ذكر",
        option_female: "أنثى",
        label_age: "العمر (بالسنوات)",
        placeholder_age: "مثال: 63",
        label_pregnant: "هل المريضة حامل؟",
        option_no: "لا",
        option_yes: "نعم",
        option_na: "غير منطبق",
        label_pregnancy_months: "شهر الحمل (إن وُجد)",
        placeholder_pregnancy_months: "مثال: 5",
        label_smoking: "هل المريض مدخّن؟",
        option_smoker: "مدخن",
        option_non_smoker: "غير مدخن",
        option_ex_smoker: "سابق",
        label_pack_years: "Pack-Years (إن وُجد)",
        placeholder_pack_years: "مثال: 15",
        label_weight: "الوزن (كجم)",
        placeholder_weight: "مثال: 78",
        label_height: "الطول (سم)",
        placeholder_height: "مثال: 172",
        label_temp: "درجة الحرارة (°م)",
        placeholder_temp: "مثال: 37.4",
        label_has_cough: "هل يوجد سُعال؟",
        label_cough_weeks: "مدة السعال (أسابيع)",
        placeholder_cough_weeks: "مثال: 12",
        label_cough_type: "نوع السعال",
        option_dry: "جاف",
        option_productive: "ببلغم",
        option_hemoptysis: "بدم",
        timeline_symptoms_title: " 2) خطّ الحياة والأعراض",
        label_free_text: "وصف الحالة (نص حر)",
        placeholder_free_text: "مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن بسيط...",
        label_initial_dx: "التشخيصات المبدئية (نص)",
        placeholder_initial_dx: "مثال: T2DM, HTN, COPD? Dermatitis",
        label_labs_imaging: "تحاليل/الأشعة المذكورة (نص)",
        placeholder_labs_imaging: "مثال: HbA1c 8.7%, eGFR 38→62, K 5.6 ...",
        label_orders: "الأدوية/الإجراءات المقرّرة (إن وُجدت)",
        placeholder_orders: "مثال: Xigduo XR bid, Metformin 1000 tid ...",
        file_upload_title: " 3) رفع ملفات (صور/PDF) — اختياري",
        uploader_text: "اضغط هنا لرفع ملف واحد أو أكثر",
        analyze_button: "تحليل الحالة",
        analyzing_text: "جاري التحليل…",
        export_button: "تصدير PDF",
        show_json_summary: "إظهار JSON (للبحث/الإحصاءات)",
      },
      en: {
        app_title: "Medical Case & Insurance Claim Assessment",
        home_page: "Home Page",
        lang_english: "العربية",
        main_title: "Medical Case & Insurance Claim Assessment",
        subtitle: "Easy clinical entry interface — Deep analysis aligned with insurance needs",
        evidence_banner: "Insurance judgment is based on concise evidence from <b>WHO</b>, <b>CDC</b>, and <b>Medscape</b>—justification appears within the table.",
        patient_info_title: " 1) Patient Information",
        label_name: "Name (Optional)",
        placeholder_name: "e.g., John Doe",
        label_gender: "Gender",
        option_select: "Select",
        option_male: "Male",
        option_female: "Female",
        label_age: "Age (Years)",
        placeholder_age: "e.g., 63",
        label_pregnant: "Is the patient pregnant?",
        option_no: "No",
        option_yes: "Yes",
        option_na: "N/A",
        label_pregnancy_months: "Month of Pregnancy (if any)",
        placeholder_pregnancy_months: "e.g., 5",
        label_smoking: "Is the patient a smoker?",
        option_smoker: "Smoker",
        option_non_smoker: "Non-smoker",
        option_ex_smoker: "Ex-smoker",
        label_pack_years: "Pack-Years (if any)",
        placeholder_pack_years: "e.g., 15",
        label_weight: "Weight (kg)",
        placeholder_weight: "e.g., 78",
        label_height: "Height (cm)",
        placeholder_height: "e.g., 172",
        label_temp: "Temperature (°C)",
        placeholder_temp: "e.g., 37.4",
        label_has_cough: "Is there a cough?",
        label_cough_weeks: "Cough Duration (weeks)",
        placeholder_cough_weeks: "e.g., 12",
        label_cough_type: "Cough Type",
        option_dry: "Dry",
        option_productive: "Productive",
        option_hemoptysis: "Hemoptysis",
        timeline_symptoms_title: " 2) Timeline & Symptoms",
        label_free_text: "Case Description (Free Text)",
        placeholder_free_text: "e.g., Chronic cough for 12 weeks with slight weight loss...",
        label_initial_dx: "Initial Diagnoses (Text)",
        placeholder_initial_dx: "e.g., T2DM, HTN, COPD? Dermatitis",
        label_labs_imaging: "Mentioned Labs/Imaging (Text)",
        placeholder_labs_imaging: "e.g., HbA1c 8.7%, eGFR 38→62, K 5.6 ...",
        label_orders: "Prescribed Meds/Procedures (if any)",
        file_upload_title: " 3) Upload Files (Images/PDF) — Optional",
        uploader_text: "Click here to upload one or more files",
        analyze_button: "Analyze Case",
        analyzing_text: "Analyzing…",
        export_button: "Export PDF",
        show_json_summary: "Show JSON (for search/analytics)",
      }
    };

    let currentLang = 'ar';
    function setLanguage(lang) {
      currentLang = lang; document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      document.querySelectorAll('[data-translate]').forEach(el => { const key = el.getAttribute('data-translate'); if (translations[lang][key]) { el.innerHTML = translations[lang][key]; } });
      document.querySelectorAll('[data-translate-placeholder]').forEach(el => { const key = el.getAttribute('data-translate-placeholder'); if (translations[lang][key]) { el.placeholder = translations[lang][key]; } });
      document.title = translations[lang].app_title;
    }
    document.getElementById('lang-switcher').addEventListener('click', () => { setLanguage(currentLang === 'ar' ? 'en' : 'ar'); });
    setLanguage('ar');

    // ===== مزامنة الحمل مع الجنس =====
    const genderEl = document.getElementById('gender');
    const pregSel = document.getElementById('pregnant');
    const pregMonths = document.getElementById('pregnancyMonths');
    function syncPregnancyControls(){ const g = genderEl.value; if(g !== 'أنثى'){ pregSel.value = 'na'; pregSel.disabled = true; pregMonths.value = ''; pregMonths.disabled = true; } else { pregSel.disabled = false; pregMonths.disabled = pregSel.value !== 'yes'; } }
    genderEl.addEventListener('change', syncPregnancyControls);
    pregSel.addEventListener('change', ()=>{ pregMonths.disabled = pregSel.value !== 'yes'; });
    syncPregnancyControls();

    // ===== رافع الملفات =====
    const fileInput = document.getElementById('fileInput');
    const dropZone  = document.getElementById('dropZone');
    const cardsBox  = document.getElementById('cards');
    const fileList  = document.getElementById('fileList');
    ['dragenter','dragover','dragleave','drop'].forEach(ev => { window.addEventListener(ev, e => e.preventDefault()); });
    const filesState = []; // { name, mimeType, data (dataURL) }
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragenter', e=>{ e.preventDefault(); dropZone.classList.add('drag'); });
    dropZone.addEventListener('dragover',  e=>{ e.preventDefault(); });
    dropZone.addEventListener('dragleave', e=>{ e.preventDefault(); dropZone.classList.remove('drag'); });
    dropZone.addEventListener('drop', async e=>{ e.preventDefault(); dropZone.classList.remove('drag'); await handleFiles(Array.from(e.dataTransfer.files)); });
    fileInput.addEventListener('change', async ()=>{ await handleFiles(Array.from(fileInput.files)); fileInput.value = ''; });
    async function handleFiles(files){ for(const f of files){ const base64Url = await fileToDataURL(f); filesState.push({ name: f.name, mimeType: f.type || 'application/octet-stream', data: base64Url }); } renderCards(); fileList.textContent = filesState.map((f)=>`• ${f.name}`).join('
'); }
    function renderCards(){ cardsBox.innerHTML = ''; filesState.forEach((f, i)=>{ const isImg = (f.mimeType||'').startsWith('image/'); const thumb = isImg ? f.data : 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="#f1f5f9"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="18" fill="#64748b">${f.name}</text></svg>`); const el = document.createElement('div'); el.className = 'fileCard avoid-break'; el.innerHTML = `
          <button class="remove" data-i="${i}" title="إزالة">×</button>
          <img class="thumb" src="${thumb}" alt="${f.name}">
          <div class="meta">
            <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis" title="${f.name}">${f.name}</div>
            <div class="muted">${f.mimeType||'—'}</div>
          </div>`; cardsBox.appendChild(el); }); cardsBox.querySelectorAll('.remove').forEach(btn=>btn.addEventListener('click', (e)=>{ const i = +e.currentTarget.dataset.i; filesState.splice(i,1); renderCards(); fileList.textContent = filesState.map(f=>`• ${f.name}`).join('
'); })); }
    function fileToDataURL(file){ return new Promise((resolve,reject)=>{ const r = new FileReader(); r.onerror = () => { console.error('Failed to read file', file?.name); alert('تعذّر قراءة الملف: ' + (file?.name || '')); reject(new Error('failed to read file')); }; r.onload = () => resolve(r.result); r.readAsDataURL(file); }); }

    // ===== بناء patientInfo =====
    function buildPatientInfo(){ const ageYears = Number(document.getElementById('age').value || NaN); const gender = document.getElementById('gender').value || null; const smokingStatus = document.getElementById('smoking').value || null; const packYears = document.getElementById('packYears').value ? Number(document.getElementById('packYears').value) : null; const temp = document.getElementById('temp').value ? Number(document.getElementById('temp').value) : null; const weight = document.getElementById('weight').value ? Number(document.getElementById('weight').value) : null; const height = document.getElementById('height').value ? Number(document.getElementById('height').value) : null; const hasCough = document.getElementById('hasCough').value || null; const coughWeeks = document.getElementById('coughWeeks').value ? Number(document.getElementById('coughWeeks').value) : null; const coughType = document.getElementById('coughType').value || null; const pVal = pregSel.value; const pregnant = (gender === 'أنثى') ? { isPregnant: pVal === 'yes', gestationalWeeks: (pVal === 'yes' && document.getElementById('pregnancyMonths').value) ? Number(document.getElementById('pregnancyMonths').value) * 4 : null } : null; return { name: document.getElementById('name').value || null, ageYears: isNaN(ageYears) ? null : ageYears, gender, pregnant, smoking: smokingStatus ? { status: smokingStatus, packYears } : null, temperatureC: temp, weightKg: weight, heightCm: height, cough: { has: hasCough, weeks: coughWeeks, type: coughType } }; }

    // ===== تحليل واستلام التقرير من الباك-إند =====
    async function analyze(){ const analyzeBtn = document.getElementById('analyzeBtn'); const busy = document.getElementById('busy'); analyzeBtn.disabled = true; busy.style.display = 'inline'; try{ const textParts = []; const ft = document.getElementById('freeText').value.trim(); if(ft) textParts.push(`وصف الحالة: ${ft}`); const dx = document.getElementById('initialDx').value.trim(); if(dx) textParts.push(`التشخيصات المبدئية: ${dx}`); const labs = document.getElementById('labsImaging').value.trim(); if(labs) textParts.push(`تحاليل/أشعة: ${labs}`); const orders = document.getElementById('orders').value.trim(); if(orders) textParts.push(`الأدوية/الإجراءات: ${orders}`); const mergedText = textParts.join('
'); const filesPayload = filesState.map(f=>({ name: f.name, mimeType: f.mimeType, data: f.data.split('base64,').pop() })); const payload = { text: mergedText, patientInfo: buildPatientInfo(), files: filesPayload, lang: currentLang };
        const resp = await fetch('/api/gpt', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await resp.json().catch(()=> ({})); if(!resp.ok){ throw new Error(data?.error || `HTTP ${resp.status}`); }
        document.getElementById('reportWrap').style.display = 'block';
        const contentHtml = data.html || '';
        document.getElementById('reportPrintPage').innerHTML = `<section class="print-section avoid-break">${contentHtml}</section>`;
        document.getElementById('jsonOut').textContent = JSON.stringify(data.structured || {}, null, 2);
      }catch(err){ alert('خطأ: ' + err.message); }finally{ analyzeBtn.disabled = false; busy.style.display = 'none'; } }
    document.getElementById('analyzeBtn').addEventListener('click', analyze);

    // ===== تصدير PDF (خادم فقط) =====
    function hookExport(btnId){ const btn = document.getElementById(btnId); btn.addEventListener('click', async ()=>{ const pageEl = document.getElementById('reportPrintPage'); if(!pageEl || !pageEl.firstElementChild){ return alert('التقرير غير جاهز للتصدير.'); } const html = pageEl.outerHTML; try{ const resp = await fetch('/api/pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ html, lang: currentLang }) }); if(!resp.ok){ throw new Error('HTTP '+resp.status); } const blob = await resp.blob(); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'Medical_Audit_Report.pdf'; a.click(); URL.revokeObjectURL(url); }catch(e){ alert('فشل توليد PDF: '+ e.message); } }); }
    hookExport('exportPdfBtn'); hookExport('exportPdfBtnTop'); hookExport('exportPdfBtnBottom');
  </script>
</body>
</html>
```

---

## 2) مسار خادمي للطباعة `/pages/api/pdf.ts`

> هذا المسار لا يغيّر باك-إند التحليل عندك (`/api/gpt`). فقط مسؤول عن التوليد الموثوق للـPDF.

```ts
// pages/api/pdf.ts
import type { NextApiRequest, NextApiResponse } from 'next'

export const config = { api: { bodyParser: { sizeLimit: '50mb' } } }

async function launchBrowser(){
  try {
    const chromium = await import('chrome-aws-lambda');
    const puppeteerCore = await import('puppeteer-core');
    const browser = await puppeteerCore.default.launch({
      args: chromium.args,
      defaultViewport: chromium.defaultViewport,
      executablePath: await chromium.executablePath,
      headless: chromium.headless
    });
    return browser;
  } catch { // تشغيل محلي
    const puppeteer = await import('puppeteer');
    return puppeteer.default.launch({ headless: 'new' });
  }
}

export default async function handler(req: NextApiRequest, res: NextApiResponse){
  if(req.method !== 'POST') return res.status(405).json({ ok:false, error:'Method Not Allowed' });
  const { html = '', lang = 'ar' } = (req.body||{});
  if(!html) return res.status(400).json({ ok:false, error:'Missing html' });

  const doc = `<!doctype html>
<html lang="${lang}" dir="${lang==='ar'?'rtl':'ltr'}">
<head>
<meta charset="utf-8" />
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  @page{ size: A4; margin:10mm }
  html,body{ margin:0; padding:0; background:#fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .print-page, .avoid-break, table, tr, td, th, img { break-inside: avoid; page-break-inside: avoid; }
  img{ max-width:100%; height:auto }
</style>
</head>
<body>
${html}
</body>
</html>`

  let browser: any;
  try{
    browser = await launchBrowser();
    const page = await browser.newPage();
    await page.emulateMediaType('screen');
    await page.setContent(doc, { waitUntil: 'networkidle0' });
    const pdf = await page.pdf({
      format: 'A4', printBackground: true, preferCSSPageSize: true,
      margin: { top:'10mm', right:'10mm', bottom:'10mm', left:'10mm' }
    });
    res.setHeader('Content-Type','application/pdf');
    res.setHeader('Content-Disposition','attachment; filename="Medical_Audit_Report.pdf"');
    return res.status(200).send(pdf);
  }catch(err:any){
    console.error('PDF error:', err);
    return res.status(500).send('PDF generation failed: '+(err?.message||'unknown'));
  }finally{ try{ await browser?.close(); }catch{} }
}
```
