<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="ui.appTitle">تقييم الحالة الطبية - بوابة الطبيب</title>

  <script src="[https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js](https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js)"></script>
  <script src="[https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js](https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js)"></script>

  <link rel="preconnect" href="[https://fonts.googleapis.com](https://fonts.googleapis.com)">
  <link rel="preconnect" href="[https://fonts.gstatic.com](https://fonts.gstatic.com)" crossorigin>
  <link href="[https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@400;700&display=swap](https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@400;700&display=swap)" rel="stylesheet">

  <style>
    :root {
      --primary: #0b63c2; --primary-dark: #084e97; --accent: #00a7c7;
      --secondary: #6c757d; --danger: #dc3545; --bg-grad-1: #e9f3ff;
      --bg-grad-2: #f6fbff; --card: #ffffff; --text: #243143;
      --muted: #66768a; --border: #e2e8f0; --focus: rgba(11, 99, 194, .18);
      --shadow: 0 10px 25px rgba(15, 57, 105, .08); --radius: 16px;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: 'Roboto', sans-serif; color: var(--text);
      background: radial-gradient(1200px 800px at 80% 0%, var(--bg-grad-1), var(--bg-grad-2));
      padding: 2rem 1rem; line-height: 1.6;
    }
    [lang="ar"] body, [lang="ar"] h1, [lang="ar"] h2, [lang="ar"] button, [lang="ar"] label, [lang="ar"] input, [lang="ar"] select, [lang="ar"] textarea {
        font-family: 'Amiri', serif;
    }
    .container {
      max-width: 980px; margin: 0 auto; background: var(--card);
      border: 1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 28px 26px 30px;
      position: relative; overflow: hidden;
    }
    .top-ribbon {
      position: absolute; inset: 0 0 auto 0; height: 6px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }
    .header-controls {
      position: absolute; top: 14px; inset-inline-end: 14px;
      display: flex; gap: 10px; align-items: center;
    }
    .home-btn {
        display: flex; align-items: center; justify-content: center;
        width: 40px; height: 40px; border-radius: 50%; background-color: #fff;
        border: 1px solid var(--border); color: var(--primary); text-decoration: none;
        transition: background-color .2s, color .2s;
    }
    .home-btn:hover { background-color: var(--bg-grad-1); color: var(--primary-dark); }
    .home-btn svg { stroke: currentColor; }
    .lang-switcher {
      font-size: 14px; font-weight: 700; padding: 8px 12px;
      border-radius: 8px; border: 1px solid var(--border);
      background-color: #fff; cursor: pointer; transition: background-color .2s, box-shadow .2s;
    }
    .lang-switcher:hover { background-color: #f6fbff; border-color: var(--primary); }
    h2 { margin: 10px 0 24px; font-weight: 700; color: var(--primary); text-align: center; }
    .subtext { text-align: center; color: var(--muted); margin-top: -10px; margin-bottom: 22px; font-size: .95rem; }
    .section-title {
      font-size: 1.08rem; font-weight: 700; color: var(--primary);
      border-bottom: 2px solid var(--primary); display: flex;
      align-items: center; gap: .5rem; padding-bottom: .5rem; margin: 26px 0 16px;
    }
    .section-title .dot { width: 9px; height: 9px; border-radius: 50%; background: var(--accent); }
    label { font-weight: 600; display: block; margin: .8rem 0 .35rem; }
    .hint { font-size: .86rem; color: var(--muted); margin-top: .15rem; }
    input, select, textarea {
      width: 100%; box-sizing: border-box; border: 1px solid var(--border);
      border-radius: 10px; padding: .75rem .9rem; font-size: 1rem;
      background: #fff; transition: border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--focus);
    }
    textarea { min-height: 120px; resize: vertical; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
      border: none; border-radius: 10px; color: #fff; cursor: pointer; padding: .6rem 1rem;
      font-weight: 700; font-size: .98rem; transition: transform .06s ease, filter .2s ease, background .25s ease;
      box-shadow: 0 6px 14px rgba(0, 0, 0, .08);
    }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { background-color: var(--secondary); cursor: not-allowed; filter: brightness(1); }
    .btn-primary { background: var(--primary); }
    .btn-primary:not(:disabled):hover { background: var(--primary-dark); }
    .actions { display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 20px; position: relative; }
    .export-dropdown {
      display: none; position: absolute; bottom: 100%; margin-bottom: 10px;
      background-color: white; border: 1px solid var(--border); border-radius: 10px;
      box-shadow: var(--shadow); z-index: 10; min-width: 220px; padding: 5px;
    }
    .export-dropdown.show { display: block; }
    .export-option {
      display: block; width: 100%; padding: 10px 15px; text-align: start;
      border: none; background: none; cursor: pointer; font-size: 0.95rem; border-radius: 6px;
    }
    .export-option:hover { background-color: var(--bg-grad-1); color: var(--primary); }
    .muted-mini { font-size: .82rem; color: #92a3b6; text-align: center; margin-top: 10px; }
    .notification { margin-top: 16px; padding: 12px 14px; border-radius: 10px; display: none; text-align: center; font-weight: 600; }
    .notification.info { background: #e9f4ff; color: #114a86; border: 1px solid #cfe6ff; }
    .notification.error { background: #fde8ea; color: #7a1f27; border: 1px solid #f5c6cb; }
    #response-container { margin-top: 20px; display: none; }
    .hidden { display: none !important; }
    .file-upload-area {
      border: 2px dashed var(--border); border-radius: 12px; padding: 18px;
      text-align: center; color: var(--muted); transition: border-color .25s, background .25s; cursor: pointer;
    }
    .file-upload-area:hover { border-color: var(--primary); background: #f6fbff; }
    #file-upload-input { display: none; }
    #file-preview-container {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px; margin-top: 15px;
    }
    .file-preview-item {
        position: relative; border: 1px solid var(--border); border-radius: 10px;
        background: #fcfdff; padding: 8px; font-size: 0.85rem; overflow: hidden;
    }
    .file-preview-item .thumb {
        width: 100%; height: 100px; border-radius: 6px; background-color: #f0f4f8;
        display: flex; align-items: center; justify-content: center; margin-bottom: 5px;
    }
    .file-preview-item .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .file-preview-item .thumb svg { width: 40px; height: 40px; color: var(--danger); }
    .file-preview-item .file-name { word-break: break-all; color: var(--text); text-align: center; }
    .file-remove-btn {
        position: absolute; top: 2px; inset-inline-end: 2px;
        width: 24px; height: 24px; border-radius: 50%; border: none;
        background-color: rgba(220, 53, 69, 0.8); color: white; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 16px; line-height: 1; transition: background-color .2s;
    }
    .file-remove-btn:hover { background-color: var(--danger); }
    .pack-years-calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: end; }
    .pack-years-result-box {
        background-color: var(--bg-grad-1); border: 1px solid var(--border);
        border-radius: 10px; padding: 0.75rem 0.9rem; text-align: center;
    }
    .pack-years-result-box span { font-weight: 700; font-size: 1.2rem; color: var(--primary); }
    .form-group-box {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.25rem 1rem 1rem 1rem;
      margin-top: 1rem;
      background-color: #fcfdff;
    }
    /* --- STYLES FOR THE GENERATED REPORT --- */
    .report-container { max-width: 900px; margin: auto; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .report-container h3, .report-container h4, .report-container h5 { color: #1e3a8a; border-bottom: 2px solid #e0e7ff; padding-bottom: 8px; margin-top: 24px; }
    .report-container h4 { font-size: 1.25rem; }
    .report-container h5 { font-size: 1.1rem; color: #1e40af; border-bottom: 1px solid #e5e7eb; }
    .report-container table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 0.9rem; }
    .report-container th, .report-container td { border: 1px solid #e5e7eb; padding: 10px; text-align: start; vertical-align: top; }
    .report-container thead th { background-color: #f3f4f6; color: #1f2937; font-weight: 600; }
    .report-container tbody tr:nth-child(even) { background-color: #f9fafb; }
    .report-container .status-green, .report-container .status-yellow, .report-container .status-red { display: inline-block; padding: 4px 10px; border-radius: 9999px; font-weight: 600; font-size: 0.8rem; border: 1px solid; }
    .report-container .status-green { background-color: #dcfce7; color: #166534; border-color: #a7f3d0; }
    .report-container .status-yellow { background-color: #fefce8; color: #854d0e; border-color: #fde68a; }
    .report-container .status-red { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-ribbon"></div>
    <div class="header-controls">
        <a href="[https://www.m2020m.org/portal.html](https://www.m2020m.org/portal.html)" class="home-btn" data-i18n-title="ui.homeTooltip" title="الشاشة الرئيسية">
            <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </a>
        <button id="lang-switcher" class="lang-switcher">English</button>
    </div>

    <h2 data-i18n="ui.pageHeader">تقييم الحالة الطبية وطلبات التأمين</h2>
    <div class="subtext" data-i18n="ui.subHeader">واجهة إدخال سريرية سهلة — تحليل مؤتمت وربط مع احتياجات التأمين</div>

    <div class="section-title"><span class="dot"></span> <span data-i18n="ui.section1Title">1) معلومات المريض</span></div>
    <div class="grid">
      <div>
        <label for="gender" data-i18n="ui.label_gender">الجنس</label>
        <select id="gender">
          <option value="" selected disabled data-i18n="ui.option_gender_placeholder">اختر الجنس</option>
          <option value="male" data-i18n="ui.option_gender_male">ذكر</option>
          <option value="female" data-i18n="ui.option_gender_female">أنثى</option>
        </select>
        <div class="hint" data-i18n="ui.hint_gender">لو كانت المريضة أنثى، ستظهر أسئلة الحمل تلقائيًا.</div>
      </div>
      <div>
        <label for="age" data-i18n="ui.label_age">العمر</label>
        <input id="age" type="number" data-i18n-placeholder="ui.placeholder_age" placeholder="مثال: 63">
      </div>
      <div id="pregnancy-status-wrap" class="hidden">
        <label for="pregnancy-status" data-i18n="ui.label_pregnancy_status">هل المريضة حامل؟</label>
        <select id="pregnancy-status">
          <option value="" selected disabled data-i18n="ui.option_pregnancy_placeholder">اختر</option>
          <option value="yes" data-i18n="ui.option_yes">نعم</option>
          <option value="no" data-i18n="ui.option_no">لا</option>
        </select>
      </div>
      <div id="pregnancy-month-wrap" class="hidden">
        <label for="pregnancy-month" data-i18n="ui.label_pregnancy_month">شهر الحمل</label>
        <input id="pregnancy-month" type="number" min="1" max="9" data-i18n-placeholder="ui.placeholder_pregnancy_month" placeholder="مثال: 5">
      </div>
    </div>

    <div class="section-title"><span class="dot"></span> <span data-i18n="ui.section2Title">2) نمط الحياة والأعراض</span></div>
    
    <div class="form-group-box">
        <div>
            <label for="smoker" data-i18n="ui.label_smoker">هل المريض مدخّن؟</label>
            <select id="smoker">
              <option value="" selected disabled data-i18n="ui.option_pregnancy_placeholder">اختر</option>
              <option value="yes" data-i18n="ui.option_yes">نعم</option>
              <option value="no" data-i18n="ui.option_no">لا</option>
            </select>
        </div>
        
        <div id="pack-years-section" class="hidden">
            <div class="pack-years-calc-grid">
                <div>
                    <label for="packs-per-day" data-i18n="ui.label_packs_per_day">عدد العلب يوميًا</label>
                    <input id="packs-per-day" type="number" min="0" step="0.5" data-i18n-placeholder="ui.placeholder_packs_per_day" placeholder="مثال: 1.5">
                </div>
                <div>
                    <label for="smoking-years" data-i18n="ui.label_smoking_years">عدد سنوات التدخين</label>
                    <input id="smoking-years" type="number" min="0" data-i18n-placeholder="ui.placeholder_smoking_years" placeholder="مثال: 20">
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <label data-i18n="ui.label_pack_years_result">النتيجة (باك-سنة)</label>
                <div class="pack-years-result-box">
                    <span id="pack-years-result">--</span>
                </div>
                <div class="hint" data-i18n="ui.hint_pack_years">الباك-سنة هو مقياس لتقدير كمية التدخين مدى الحياة.</div>
            </div>
        </div>
    </div>

    <div class="grid">
      <div>
        <label for="cough-duration" data-i18n="ui.label_cough_duration">مدة السعال (أسابيع)</label>
        <input id="cough-duration" type="number" data-i18n-placeholder="ui.placeholder_cough_duration" placeholder="مثال: 12">
      </div>
      <div>
        <label for="visual-symptoms" data-i18n="ui.label_visual_symptoms">أعراض بصرية؟</label>
        <select id="visual-symptoms">
          <option value="" selected disabled data-i18n="ui.option_pregnancy_placeholder">اختر</option>
          <option value="yes" data-i18n="ui.option_yes">نعم</option>
          <option value="no" data-i18n="ui.option_no">لا</option>
        </select>
      </div>
      <div id="eye-wrap" class="hidden">
        <label for="last-eye-exam" data-i18n="ui.label_last_eye_exam">تاريخ آخر فحص قاع عين</label>
        <input id="last-eye-exam" type="date">
        <label for="visual-acuity" data-i18n="ui.label_visual_acuity">حدة البصر (اختياري)</label>
        <input id="visual-acuity" type="text" data-i18n-placeholder="ui.placeholder_visual_acuity" placeholder="مثال: 6/12 أو 20/40">
      </div>
    </div>

    <div class="section-title"><span class="dot"></span> <span data-i18n="ui.section3Title">3) تفاصيل الحالة الطبية</span></div>
    <div class="grid">
      <div>
        <label for="case-description" data-i18n="ui.label_case_description">وصف الحالة</label>
        <textarea id="case-description" data-i18n-placeholder="ui.placeholder_case_description" placeholder="مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن بسيط ودوخة متقطعة..."></textarea>
      </div>
      <div>
        <label for="diagnosis" data-i18n="ui.label_diagnosis">التشخيصات المبدئية</label>
        <textarea id="diagnosis" data-i18n-placeholder="ui.placeholder_diagnosis" placeholder="مثال: T2DM, HTN, COPD? Dermatitis"></textarea>
      </div>
      <div>
        <label for="lab-results" data-i18n="ui.label_lab_results">التحاليل/الأشعة المتوفرة</label>
        <textarea id="lab-results" data-i18n-placeholder="ui.placeholder_lab_results" placeholder="مثال: HbA1c 8.7%, eGFR 38→62, K 5.6, INR غير متاح..."></textarea>
      </div>
      <div>
        <label for="medications-procedures" data-i18n="ui.label_medications">الأدوية/الإجراءات المكتوبة</label>
        <textarea id="medications-procedures" data-i18n-placeholder="ui.placeholder_medications" placeholder="مثال: Xigduo XR bid, Metformin 1000 tid..."></textarea>
      </div>
    </div>

    <div class="section-title"><span class="dot"></span> <span data-i18n="ui.section4Title">4) رفع ملفات (صور/PDF) — اختياري</span></div>
    <div class="file-upload-area" onclick="document.getElementById('file-upload-input').click()">
      <span data-i18n="ui.upload_cta">اضغط هنا لرفع ملف واحد أو أكثر</span>
      <input id="file-upload-input" type="file" accept="image/*,application/pdf" multiple>
    </div>
    <div id="file-preview-container"></div>

    <div class="actions">
      <button id="analyzeBtn" class="btn btn-primary" data-i18n="ui.btn_analyze">تحليل الحالة</button>
      <div id="export-container" class="hidden">
        <button id="exportBtn" class="btn btn-primary" data-i18n="export.exportButtonLabel">تصدير التقرير</button>
        <div id="export-dropdown" class="export-dropdown">
            <button class="export-option" onclick="exportPDF('ar')" data-i18n="export.pdf_ar_only">PDF (عربي فقط)</button>
        </div>
      </div>
    </div>
    <div class="muted-mini" data-i18n="ui.hint_analyze">بالضغط على "تحليل الحالة" سيتم إرسال المدخلات لتوليد تقرير شامل.</div>

    <div id="notification-area" class="notification info"></div>
    <div id="response-container"></div>
  </div>

<script>
// =================================================================================
// CONFIGURATION & STATE
// =================================================================================
const API_ENDPOINT = '/api/gpt';
let uploadedFiles = [];
let currentLang = 'ar';

// =================================================================================
// TRANSLATIONS (i18n)
// =================================================================================
const translations = {
  ar: {
    ui: {
      appTitle: "تقييم الحالة الطبية - بوابة الطبيب", pageHeader: "تقييم الحالة الطبية وطلبات التأمين", subHeader: "واجهة إدخال سريرية سهلة — تحليل مؤتمت وربط مع احتياجات التأمين", homeTooltip: "الشاشة الرئيسية", section1Title: "1) معلومات المريض", label_gender: "الجنس", option_gender_placeholder: "اختر الجنس", option_gender_male: "ذكر", option_gender_female: "أنثى", hint_gender: "لو كانت المريضة أنثى، ستظهر أسئلة الحمل تلقائيًا.", label_age: "العمر", placeholder_age: "مثال: 63", label_pregnancy_status: "هل المريضة حامل؟", option_pregnancy_placeholder: "اختر", option_yes: "نعم", option_no: "لا", label_pregnancy_month: "شهر الحمل", placeholder_pregnancy_month: "مثال: 5", section2Title: "2) نمط الحياة والأعراض", label_smoker: "هل المريض مدخّن؟", label_packs_per_day: "عدد العلب يوميًا", placeholder_packs_per_day: "مثال: 1.5", label_smoking_years: "عدد سنوات التدخين", placeholder_smoking_years: "مثال: 20", label_pack_years_result: "النتيجة (باك-سنة)", hint_pack_years: "الباك-سنة هو مقياس لتقدير كمية التدخين مدى الحياة.", label_cough_duration: "مدة السعال (أسابيع)", placeholder_cough_duration: "مثال: 12", label_visual_symptoms: "أعراض بصرية؟", label_last_eye_exam: "تاريخ آخر فحص قاع عين", label_visual_acuity: "حدة البصر (اختياري)", placeholder_visual_acuity: "مثال: 6/12 أو 20/40", section3Title: "3) تفاصيل الحالة الطبية", label_case_description: "وصف الحالة", placeholder_case_description: "مثال: سعال مزمن 12 أسبوعًا مع فقدان وزن بسيط...", label_diagnosis: "التشخيصات المبدئية", placeholder_diagnosis: "مثال: T2DM, HTN, COPD? Dermatitis", label_lab_results: "التحاليل/الأشعة المتوفرة", placeholder_lab_results: "مثال: HbA1c 8.7%, eGFR 38→62, K 5.6...", label_medications: "الأدوية/الإجراءات المكتوبة", placeholder_medications: "مثال: Xigduo XR bid, Metformin 1000 tid...", section4Title: "4) رفع ملفات (صور/PDF) — اختياري", upload_cta: "اضغط هنا لرفع ملف واحد أو أكثر", btn_analyze: "تحليل الحالة", hint_analyze: "بالضغط على 'تحليل الحالة' سيتم إرسال المدخلات لتوليد تقرير شامل.", remove_file: "إزالة الملف"
    },
    validation: { error_formIncomplete: "الرجاء إدخال تفاصيل الحالة أو رفع ملف.", error_requestFailed: "حدث خطأ أثناء التحليل: ", info_analyzing: "جاري تحليل الحالة... قد يستغرق الأمر لحظات." },
    export: { exportButtonLabel: "تصدير التقرير", pdf_ar_only: "PDF (عربي فقط)" }
  },
  en: { /* ... English translations can be added here ... */ }
};

function setLanguage(lang) {
  currentLang = lang;
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  const langSwitcher = document.getElementById('lang-switcher');
  langSwitcher.textContent = lang === 'ar' ? 'English' : 'العربية';
  // This is a simplified i18n function for the example
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const translation = key.split('.').reduce((obj, k) => obj && obj[k], translations[currentLang]);
    if (translation) el.textContent = translation;
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    const translation = key.split('.').reduce((obj, k) => obj && obj[k], translations[currentLang]);
    if (translation) el.placeholder = translation;
  });
}
// =================================================================================
// FILE HANDLING
// =================================================================================
function handleFilesSelect(event) {
    const files = event.target.files;
    for (const file of files) {
        const fileId = Date.now() + '-' + Math.random();
        const fileReader = new FileReader();
        fileReader.onload = (e) => {
            const base64 = e.target.result.split(',')[1];
            uploadedFiles.push({ id: fileId, file: file, base64: base64 });
            renderFilePreview(fileId, file, e.target.result);
        };
        fileReader.readAsDataURL(file);
    }
    event.target.value = '';
}
function renderFilePreview(fileId, file, dataUrl) {
    const previewContainer = document.getElementById('file-preview-container');
    const item = document.createElement('div');
    item.className = 'file-preview-item';
    item.dataset.fileId = fileId;
    let thumbHtml = file.type.startsWith('image/')
        ? `<img src="${dataUrl}" alt="${file.name}">`
        : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>`;
    item.innerHTML = `<div class="thumb">${thumbHtml}</div><div class="file-name">${file.name}</div><button class="file-remove-btn" onclick="removeFile('${fileId}')">&times;</button>`;
    previewContainer.appendChild(item);
}
function removeFile(fileId) {
    uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
    const itemToRemove = document.querySelector(`.file-preview-item[data-file-id="${fileId}"]`);
    if (itemToRemove) itemToRemove.remove();
}
// =================================================================================
// NOTIFICATION UTILITIES
// =================================================================================
function clearNote() {
  const noteArea = document.getElementById('notification-area');
  noteArea.style.display = 'none';
  noteArea.textContent = '';
}
function showNote(type, text) {
  const noteArea = document.getElementById('notification-area');
  noteArea.className = 'notification ' + (type === 'error' ? 'error' : 'info');
  noteArea.textContent = text;
  noteArea.style.display = 'block';
}

// =================================================================================
// DYNAMIC UI EVENT LISTENERS
// =================================================================================
function attachEventListeners() {
    document.getElementById('analyzeBtn').addEventListener('click', analyzeCase);
    document.getElementById('file-upload-input').addEventListener('change', handleFilesSelect);
    document.getElementById('lang-switcher').addEventListener('click', () => setLanguage(currentLang === 'ar' ? 'en' : 'ar'));

    // --- Dynamic form visibility ---
    document.getElementById('gender').addEventListener('change', (e) => {
        const isFemale = e.target.value === 'female';
        document.getElementById('pregnancy-status-wrap').classList.toggle('hidden', !isFemale);
        if (!isFemale) {
            document.getElementById('pregnancy-month-wrap').classList.add('hidden');
        }
    });
    document.getElementById('pregnancy-status').addEventListener('change', (e) => {
        document.getElementById('pregnancy-month-wrap').classList.toggle('hidden', e.target.value !== 'yes');
    });
    document.getElementById('smoker').addEventListener('change', (e) => {
        document.getElementById('pack-years-section').classList.toggle('hidden', e.target.value !== 'yes');
    });
    document.getElementById('visual-symptoms').addEventListener('change', (e) => {
        document.getElementById('eye-wrap').classList.toggle('hidden', e.target.value !== 'yes');
    });

    // --- Pack-years calculation ---
    document.getElementById('packs-per-day').addEventListener('input', updatePackYears);
    document.getElementById('smoking-years').addEventListener('input', updatePackYears);
}

function updatePackYears() {
    const packsPerDay = parseFloat(document.getElementById('packs-per-day').value) || 0;
    const smokingYears = parseFloat(document.getElementById('smoking-years').value) || 0;
    const resultEl = document.getElementById('pack-years-result');
    if (packsPerDay > 0 && smokingYears > 0) {
        resultEl.textContent = (packsPerDay * smokingYears).toFixed(1);
    } else {
        resultEl.textContent = '--';
    }
}

// =================================================================================
// API ANALYSIS FUNCTION (Corrected and Final Version)
// =================================================================================
async function analyzeCase() {
  const responseContainer = document.getElementById('response-container');
  const btn = document.getElementById('analyzeBtn');
  const exportContainer = document.getElementById('export-container');
  
  clearNote();
  responseContainer.style.display = 'none';
  responseContainer.innerHTML = '';
  exportContainer.classList.add('hidden');

  // Combine all textual details into one rich notes field for the AI
  const detailedNotes = [
    `Case Description: ${document.getElementById('case-description').value}`,
    `Provisional Diagnoses: ${document.getElementById('diagnosis').value}`,
    `Available Lab Results: ${document.getElementById('lab-results').value}`,
    `Prescribed Medications/Procedures: ${document.getElementById('medications-procedures').value}`
  ].map(s => s.trim()).filter(s => !s.endsWith(':')).join('\n---\n');

  // This object now collects ALL data from your form
  const caseData = {
    age: document.getElementById('age').value || null,
    gender: document.getElementById('gender').value || null,
    isPregnant: document.getElementById('pregnancy-status').value === 'yes',
    pregnancyMonth: document.getElementById('pregnancy-month').value || null,
    isSmoker: document.getElementById('smoker').value === 'yes',
    packYears: document.getElementById('pack-years-result').textContent === '--' ? null : document.getElementById('pack-years-result').textContent,
    coughDurationWeeks: document.getElementById('cough-duration').value || null,
    visualSymptoms: document.getElementById('visual-symptoms').value || null,
    lastEyeExamDate: document.getElementById('last-eye-exam').value || null,
    visualAcuity: document.getElementById('visual-acuity').value || '',
    notes: detailedNotes,
    files: uploadedFiles.map(f => ({ name: f.file.name, type: f.file.type, data: f.base64 }))
  };

  const hasAnyInput = caseData.notes || caseData.files.length > 0;
  if (!hasAnyInput) {
    showNote('error', "Please enter case details or upload a file."); // Replace with getTranslation if you have it
    return;
  }

  showNote('info', "Analyzing case... This may take a moment."); // Replace with getTranslation
  btn.disabled = true;

  try {
    const response = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(caseData),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ detail: response.statusText }));
      throw new Error(`${response.status}: ${errorData.detail || 'Unknown server error'}`);
    }

    const result = await response.json();

    if (result?.htmlReport) {
      clearNote();
      responseContainer.innerHTML = result.htmlReport;
      responseContainer.style.display = 'block';
      exportContainer.classList.remove('hidden');
      responseContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      throw new Error("Did not receive a valid report from the server.");
    }
  } catch (err) {
    console.error(err);
    showNote('error', "An error occurred during analysis: " + err.message); // Replace with getTranslation
  } finally {
    btn.disabled = false;
  }
}

// =================================================================================
// PDF EXPORT LOGIC
// =================================================================================
const { jsPDF } = window.jspdf;
const exportBtn = document.getElementById('exportBtn');
const exportDropdown = document.getElementById('export-dropdown');
exportBtn.addEventListener('click', (event) => {
    event.stopPropagation();
    exportDropdown.classList.toggle('show');
});
window.addEventListener('click', (event) => {
    if (exportBtn && !exportBtn.contains(event.target) && exportDropdown && !exportDropdown.contains(event.target)) {
        exportDropdown.classList.remove('show');
    }
});
async function exportPDF(mode) {
  showNote('info', 'Generating PDF...');
  exportDropdown.classList.remove('show');
  const reportContainer = document.getElementById('response-container').querySelector('.report-container');
  if (!reportContainer) {
    showNote('error', 'No report content to export.');
    return;
  }
  const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
  await addContentToPdf(doc, reportContainer, currentLang);
  doc.save(`Medical-Report-${new Date().toISOString().slice(0,10)}.pdf`);
  clearNote();
}
async function addContentToPdf(doc, element, lang) {
    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL('image/png');
    const imgProps = doc.getImageProperties(imgData);
    const pdfWidth = doc.internal.pageSize.getWidth() - 20;
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    let heightLeft = pdfHeight;
    let position = 10;
    doc.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
    heightLeft -= doc.internal.pageSize.getHeight();
    while (heightLeft >= 0) {
      position = heightLeft - pdfHeight + 10;
      doc.addPage();
      doc.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
      heightLeft -= doc.internal.pageSize.getHeight();
    }
}
// =================================================================================
// INITIALIZATION
// =================================================================================
document.addEventListener('DOMContentLoaded', attachEventListeners);

</script>
</body>
</html>
