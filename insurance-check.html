<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>منصة التدقيق السريري المتقدمة (Gemini & GPT‑4o)</title>
  <style>
    :root{--bg:#0b1020;--card:#fff;--muted:#667085;--brand:#0ea5e9;--err-color:#dc2626}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial,sans-serif;background:#f6f7fb;margin:0;color:#111;line-height: 1.6;}
    header{padding:18px 20px;background:linear-gradient(90deg,#0ea5e9,#2563eb);color:#fff}
    header h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:22px auto;padding:0 14px 60px}
    .card{background:var(--card);border:1px solid #e6e8f0;border-radius:14px;padding:18px;margin:16px 0;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:14px;color:#334155;margin-bottom: 4px; display: block;}
    input[type="file"],select,textarea,button,input[type="text"]{
      width:100%;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px;background:#fff;font-size:14px;font-family: inherit;
    }
    select{width:auto;min-width:210px}
    textarea{min-height:90px;resize:vertical}
    button{background:#0ea5e9;border:none;color:#fff;cursor:pointer;transition: background 0.2s;}
    button:hover{background: #0284c7;}
    button:disabled{opacity:.6;cursor:not-allowed}
    small.muted{color:#667085}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px;margin-inline:2px;font-weight: 500;}
    pre{background:#0b1020;color:#e2e8f0;border-radius:12px;padding:14px;overflow:auto;font-size: 13px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    @media (max-width: 800px) { .grid, .grid-3 { grid-template-columns: 1fr; } }
    .log{background:#0b1020;color:#bcd;min-height:100px;border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size: 13px;}
    .ok{color:#10b981}.warn{color:#f59e0b}.err{color:var(--err-color)}
    .pill{background:#eef2ff;color:#1d4ed8;border-radius:999px;padding:4px 10px;font-size:13px}
    .ref a{color:#0ea5e9;text-decoration:none}
    .ref a:hover{text-decoration: underline;}
    #exec h4{margin-top: 18px; margin-bottom: 8px; color: #334155;}
    #exec ul{padding-inline-start: 18px; margin-top: 5px;}
    #exec li{margin-bottom: 8px;}
    hr{border: none; border-top: 1px solid #e6e8f0; margin: 18px 0;}
  </style>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.3.136/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.3.136/build/pdf.worker.min.js";
  </script>
</head>
<body>
<header>
  <h1>منصة التدقيق السريري المتقدمة (Gemini & GPT‑4o)</h1>
  <div style="font-size:13px;opacity:.95">* التقرير لأغراض تعليمية وتدقيق الجودة فقط؛ * يُراجع سريريًا قبل أي قرار؛ * إزالة PHI تلقائيًا.</div>
</header>

<main>
  <section class="card">
        <div class="row" style="margin-bottom: 12px;">
      <div style="flex:1; min-width: 300px;">
        <label>اختر ملفات (صور/‏PDF):</label>
        <input id="fileInput" type="file" multiple accept="image/*,.pdf" />
        <small class="muted">يتم تحويل PDF إلى صور عالية الدقة واستخراج نصه مع الحفاظ على بنيته لضمان أعلى دقة تحليل.</small>
      </div>
    </div>
    <div class="row" style="margin-bottom: 12px; align-items: flex-end;">
      <div><label>لغة التقرير:</label>
        <select id="lang">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
      </div>
      <div><label>النموذج:</label>
        <select id="model">
          <option value="both" selected>Gemini + GPT‑4o (موصى به)</option>
          <option value="gpt">GPT‑4o فقط</option>
          <option value="gemini">Gemini فقط</option>
        </select>
      </div>
      <div style="min-width:260px;flex:1">
        <label>التخصص (اختياري، لتركيز التحليل):</label>
        <input id="specialty" type="text" placeholder="مثل: جلدية، قلب، طب طوارئ، أسنان..." />
      </div>
    </div>
    <div style="margin-bottom: 15px;">
      <label>سياق المراجعة أو تفاصيل المطالبة التأمينية (اختياري):</label>
      <textarea id="context" placeholder="مثال: مراجعة رفض مطالبة لزيارة أكزيما، أو تدقيق جودة توثيق لحالة التهاب رئوي."></textarea>
    </div>
    <div class="row">
      <button id="analyzeBtn">بدء تحليل الحالة</button>
      <span class="pill" id="prepInfo" style="display:none"></span>
    </div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">التقرير المدمج (Executive Overview)</h3>
    <div id="exec" class="card" style="background:#f8fafc;border:1px dashed #d0d5dd;padding: 20px;">
        <div class="muted" style="text-align: center;">النتائج ستظهر هنا بعد اكتمال التحليل.</div>
    </div>
    <details style="margin-top: 15px;">
        <summary style="cursor: pointer; color: var(--brand);">عرض بيانات JSON الخام المدمجة</summary>
       <pre id="merged" dir="ltr"></pre>
    </details>
  </section>

  <div class="grid">
    <section class="card">
      <h3 style="margin-top:0">مخرجات GPT‑4o (Raw)</h3>
      <pre id="gpt" dir="ltr"></pre>
    </section>
    <section class="card">
      <h3 style="margin-top:0">مخرجات Gemini (Raw)</h3>
      <pre id="gemini" dir="ltr"></pre>
    </section>
  </div>

  <section class="card">
    <h3 style="margin-top:0">سجل العمليات (Log)</h3>
    <div id="log" class="log"></div>
  </section>
</main>

<script>
const logEl = document.getElementById('log');
const btn = document.getElementById('analyzeBtn');
const prepInfo = document.getElementById('prepInfo');
const preMerged = document.getElementById('merged');
const preGPT = document.getElementById('gpt');
const preGemini = document.getElementById('gemini');
const execDiv = document.getElementById('exec');

// دالة مساعدة للسماح بتحديث واجهة المستخدم أثناء العمليات الثقيلة
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

function log(msg, cls=""){ 
  const span = document.createElement('div'); 
  span.className = cls; 
  const timestamp = new Date().toLocaleTimeString();
  span.textContent = `[${timestamp}] ${msg}`; 
  logEl.appendChild(span); 
  logEl.scrollTop = logEl.scrollHeight;
}

// تحسين 1: زيادة جودة ودقة الصور المرسلة
function b64FromCanvas(canvas, mime="image/jpeg", quality=0.85, maxW=1800){
  const scale = Math.min(1, maxW / canvas.width);
  if (scale >= 1) {
    return canvas.toDataURL(mime, quality).split(',')[1];
  }
  const tmp = document.createElement('canvas');
  tmp.width = Math.max(1, Math.round(canvas.width * scale));
  tmp.height = Math.max(1, Math.round(canvas.height * scale));
  const ctx = tmp.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(canvas, 0, 0, tmp.width, tmp.height);
  return tmp.toDataURL(mime, quality).split(',')[1];
}

async function imageFileToB64(file){
    const img = new Image();
    const url = URL.createObjectURL(file);
    try {
        await new Promise((res, rej)=>{
            img.onload = ()=>res();
            img.onerror = (e) => rej(new Error(`فشل تحميل الصورة: ${file.name}`));
            img.src = url;
        });
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
        canvas.getContext('2d').drawImage(img,0,0);
        return b64FromCanvas(canvas, file.type.includes('png')?'image/png':'image/jpeg', 0.85, 1800);
    } finally {
        URL.revokeObjectURL(url);
    }
}

// تحسين 2: استخراج نص PDF بشكل يحافظ على التنسيق وزيادة دقة الصور
async function pdfToImagesAndText(file){
  const arr = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arr}).promise;
  const images = [];
  let fullText = '';
  const scale = 2.2; // زيادة الدقة من 1.8

  for(let p=1;p<=pdf.numPages;p++){
    btn.textContent = `... معالجة صفحة ${p}/${pdf.numPages}`;
    await sleep(15);

    log(`> تحويل صفحة ${p}/${pdf.numPages} من ${file.name} ...`);
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({scale: scale});
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = viewport.width; canvas.height = viewport.height;
    
    // ضمان خلفية بيضاء
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    await page.render({canvasContext:ctx, viewport}).promise;
    images.push(b64FromCanvas(canvas, "image/jpeg", 0.85, 1800));
    
    // استخراج نص متقدم يحافظ على الأسطر
    const tc = await page.getTextContent();
    let pageText = '';
    let lastY = -1;
    for (const item of tc.items) {
        if (!item.str || item.str.trim() === '') continue;
        // استخدام التموضع الرأسي (transform[5]) لتحديد فواصل الأسطر
        if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > item.height * 0.5) {
            pageText += '\n';
        }
        pageText += item.str + ' ';
        lastY = item.transform[5];
    }
    pageText = pageText.replace(/[ \t]+/g, ' ').trim();
    fullText += `\n\n[BEGIN PAGE ${p}]\n${pageText}\n[END PAGE ${p}]\n\n`;
    log(`> اكتملت صفحة ${p}.`, 'ok');
  }
  return {images, text: fullText.trim()};
}

// تحسين 3: زيادة الحد الأقصى للنص المدخل
function sanitize(str, max=100000){
  const sanitized = (str||'').replace(/[\u2028\u2029]/g,' ');
  if (sanitized.length > max) {
    log(`تحذير: تم اقتصاص النص المدخل لطوله الزائد (${sanitized.length} حرف). الحد الأقصى ${max}.`, 'warn');
    return sanitized.slice(0, max) + "\n\n[...CONTENT TRUNCATED...]";
  }
  return sanitized;
}

// دالة مساعدة لتأمين عرض النص في HTML
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return String(unsafe || '');
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

// تحسين 4: عرض البيانات المنظمة الجديدة (Schema V6)
function renderExecutive(report){
  const lang = document.getElementById('lang').value || 'ar';
  const L = (ar, en) => lang === 'ar' ? ar : en;

  if(!report || Object.keys(report).length === 0) { 
    execDiv.innerHTML=`<div class="muted" style="text-align: center;">${L('لم يتم توليد تقرير صالح.', 'No valid report generated.')}</div>`;
    return; 
  }

  const renderList = (items, mapper, limit=5) => {
    if (!items || items.length === 0) return '<li>—</li>';
    return items.slice(0, limit).map(mapper).join('');
  };

  // الوصول إلى البيانات وفق المخطط الجديد (V6)
  const actions = report.physician_actions || {};
  const analysis = report.analysis || {};
  const recommendations = report.recommendations || {};

  // استخراج البيانات المنظمة
  const vitals = renderList(actions.vitals, v => `<li><b>${escapeHtml(v.metric)}:</b> ${escapeHtml(v.value)} ${escapeHtml(v.unit||'')}</li>`);
  const meds = renderList(actions.meds, m => `<li><b>${escapeHtml(m.name)}</b> (${escapeHtml(m.dose||'N/A')}, ${escapeHtml(m.route||'N/A')})</li>`);
  const diagnoses = renderList(actions.diagnoses, d => `<li>${escapeHtml(d)}</li>`);
  const codes = (actions.icd10_codes||[]).map(c => `<span class="chip">${escapeHtml(c)}</span>`).join('') || '—';

  // استخراج التحليل والتوصيات
  const refs = renderList(report.references, r=>`<li class="ref"><a href="${escapeHtml(r.link)}" target="_blank" rel="noopener">${escapeHtml(r.title||r.org||r.link)}</a></li>`, 10);
  const kf = renderList(report.key_findings, k=>`<li>${escapeHtml(k)}</li>`, 7);
  const ddx = renderList(analysis.differential_diagnoses, d=>`<li><b>${escapeHtml(d.dx)}</b> — ${escapeHtml(d.why)}</li>`);
  const issues = renderList(analysis.procedural_issues, i=>`<li><b>${escapeHtml(i.issue)}</b><br><em>${L('التأثير', 'Impact')}:</em> ${escapeHtml(i.impact)}</li>`);
  const opp = renderList(recommendations.revenue_quality_opportunities, o=>`<li><b>${escapeHtml(o.opportunity)}</b> <span class="chip">${escapeHtml(o.category)}</span><br><em>${L('المبرر', 'Rationale')}:</em> ${escapeHtml(o.rationale)}</li>`);
  const next = renderList(recommendations.suggested_next_steps, s=>`<li><b>${escapeHtml(s.action)}</b><br><em>${L('التبرير', 'Justification')}:</em> ${escapeHtml(s.justification)}</li>`);
  const contrad = renderList(analysis.contradictions, c=>`<li><b>${escapeHtml(c.item||L('تناقض', 'Contradiction'))}</b><br><em>${L('الدليل', 'Evidence')}:</em> ${escapeHtml(c.evidence)}<br><em style="color: var(--err-color);">${L('التأثير', 'Impact')}:</em> ${escapeHtml(c.impact||'')}</li>`);
  
  const summary = escapeHtml(report.executive_summary || report.patient_summary || L('لا يوجد ملخص.', 'No summary available.'));

  // هيكل عرض محسن
  execDiv.innerHTML = `
    <div style="font-size: 15px;"><h4>${L('ملخص تنفيذي شامل', 'Comprehensive Executive Summary')}</h4><div>${summary}</div></div>
    <hr>
    <h4>${L('ملخص الحالة والإجراءات المتخذة', 'Case Summary & Actions Taken')}</h4>
    <div class="grid-3">
        <div><b>${L('الشكوى الرئيسية','Chief Complaint')}</b><p>${escapeHtml(actions.chief_complaint) || '—'}</p></div>
        <div><b>${L('التشخيصات الموثقة','Documented Diagnoses')}</b><ul>${diagnoses}</ul></div>
        <div><b>${L('الأكواد المستخدمة (ICD-10)','Codes Used (ICD-10)')}</b><p>${codes}</p></div>
    </div>
    <div class="grid-3">
        <div><b>${L('العلامات الحيوية','Vitals')}</b><ul>${vitals}</ul></div>
        <div><b>${L('الأدوية الموصوفة','Prescribed Medications')}</b><ul>${meds}</ul></div>
        <div><b>${L('نتائج سريرية هامة','Key Clinical Findings')}</b><ul>${kf}</ul></div>
    </div>
    <hr>
    <h4>${L('التحليل والتدقيق السريري', 'Clinical Analysis & Audit')}</h4>
    <div class="grid-3">
      <div><b>${L('تناقضات أو أخطاء (توثيق/ترميز)', 'Contradictions/Errors (Doc/Coding)')}</b><ul>${contrad}</ul></div>
      <div><b>${L('مشكلات إجرائية/توثيقية', 'Procedural/Documentation Issues')}</b><ul>${issues}</ul></div>
      <div><b>${L('تشاخيص تفاضلية مقترحة', 'Suggested Differential Dx')}</b><ul>${ddx}</ul></div>
    </div>
    <hr>
    <h4>${L('التوصيات وفرص التحسين (CDI/RCM)', 'Recommendations & Opportunities')}</h4>
    <div class="grid-3">
      <div><b>${L('فرص تحسين الجودة/الدخل', 'Quality/Revenue Opportunities')}</b><ul>${opp}</ul></div>
      <div><b>${L('الخطوات التالية الموصى بها', 'Recommended Next Steps')}</b><ul>${next}</ul></div>
      <div><b>${L('المراجع والإرشادات الداعمة', 'References & Guidelines')}</b><ul>${refs}</ul></div>
    </div>
    <div style="margin-top: 20px;"><small class="muted" style="font-style: italic;">${escapeHtml(report.patient_safety_note||'')}</small></div>
  `;
}

async function prepareFiles(files){
  const images = []; let textChunks = [];
  let startTime = Date.now();
  for(const f of files){
    try {
        if(f.type === 'application/pdf'){
          const {images:imgs,text} = await pdfToImagesAndText(f);
          images.push(...imgs);
          textChunks.push(`\n\n# BEGIN DOCUMENT: ${f.name} (Type: PDF)\n${text}\n# END DOCUMENT: ${f.name}\n\n`);
        }else if (f.type.startsWith('image/')){
          btn.textContent = `... تحويل ${f.name}`;
          await sleep(10);
          log(`> تحويل صورة: ${f.name} ...`);
          images.push(await imageFileToB64(f));
          log(`> اكتمل تحويل الصورة.`, 'ok');
          textChunks.push(`\n\n# IMAGE CONTEXT: ${f.name} (Type: Image)\n[Visual Content Provided Separately]\n\n`);
        } else {
          log(`> تخطي نوع ملف غير مدعوم: ${f.name}`, 'warn');
        }
    } catch (error) {
        log(`فشل في معالجة الملف ${f.name}. الخطأ: ${error.message}`, 'err');
    }
  }
  if (images.length === 0 && textChunks.length === 0) {
    throw new Error("لم يتم تجهيز أي محتوى للتحليل. يرجى مراجعة سجل الأخطاء.");
  }
  log(`اكتمل تحضير الملفات في ${((Date.now() - startTime)/1000).toFixed(1)} ثانية.`, 'ok');
  return { images, text: sanitize(textChunks.join('\n')) };
}

function download(name, obj){
  if (!obj || Object.keys(obj).length === 0) {
    log('لا يوجد بيانات صالحة للتنزيل.', 'warn');
    return;
  }
  const url = URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}));
  const a = document.createElement('a');
  const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
  a.href = url; a.download = `${name}-${timestamp}.json`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
}

document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
  const lang = document.getElementById('lang').value || 'ar';
  const L = (ar, en) => lang === 'ar' ? ar : en;
  let analysisStartTime;

  try{
    logEl.textContent=''; preMerged.textContent=''; preGPT.textContent=''; preGemini.textContent=''; 
    execDiv.innerHTML=`<div class="muted" style="text-align: center;">${L('جاري التحضير...', 'Preparing...')}</div>`;

    const files = Array.from(document.getElementById('fileInput').files||[]);
    if(files.length===0){ alert(L('الرجاء اختيار ملف واحد على الأقل.', 'Please select at least one file.')); return; }
    
    btn.disabled = true; 
    btn.textContent = L('... جاري التحضير', '... Preparing');
    log('بدء عملية التحضير والتحليل...');

    const prep = await prepareFiles(files);
    
    prepInfo.style.display='inline-block';
    const prepMsg = L(
        `تم تجهيز ${prep.images.length} صورة/صفحة و ${prep.text.length} حرف نصي.`,
        `Prepared ${prep.images.length} images/pages and ${prep.text.length} chars.`
    );
    prepInfo.textContent = prepMsg;
    
    log('بدء التحليل عبر النماذج (قد يستغرق وقتاً)...');
    execDiv.innerHTML=`<div class="muted" style="text-align: center;">${L('جاري التحليل، يرجى الانتظار...', 'Analyzing, please wait...')}</div>`;
    btn.textContent = L('... جاري التحليل', '... Analyzing');

    const payload = {
      lang: lang,
      modelChoice: document.getElementById('model').value || 'both',
      specialty: document.getElementById('specialty').value || '',
      context: document.getElementById('context').value || '',
      images: prep.images,
      text: prep.text,
      fileNames: files.map(f=>f.name),
      apiVersion: 'v6.0.0' // تحديث الإصدار ليعكس المخطط الجديد
    };

    analysisStartTime = Date.now();
    const res = await fetch('/api/gpt', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    
    if(!res.ok){
      const errTxt = await res.text();
      log(`خطأ في الاستجابة من الخادم: HTTP ${res.status}`, 'err');
      throw new Error(`Server Error (${res.status}): ${errTxt}`);
    }
    const data = await res.json();

    if (!data.ok && !data.merged) {
        throw new Error(`Analysis Failed on Server: ${data.error || 'Unknown error'}`);
    }

    // عرض النتائج
    renderExecutive(data.merged);
    preMerged.textContent = JSON.stringify(data.merged, null, 2);
    
    // عرض المخرجات الخام أو رسائل الخطأ لكل نموذج
    const displayRaw = (preEl, modelData) => {
        if (modelData?.raw) {
            preEl.textContent = modelData.raw;
        } else {
            preEl.textContent = `Status: ${modelData?.note || (modelData?.ok ? 'OK (No Output)' : 'Failed/Skipped')}\nError: ${modelData?.error || 'None'}`;
        }
    };
    displayRaw(preGPT, data.gpt);
    displayRaw(preGemini, data.gemini);

    // التعامل مع الأخطاء الجزئية
    if (data.errors && data.errors.length > 0) {
        log('تحذير: حدثت أخطاء جزئية أثناء التحليل (قد يكون أحد النماذج فشل):', 'warn');
        data.errors.forEach(e => log(e, 'warn'));
    }

    const duration = ((Date.now() - analysisStartTime) / 1000).toFixed(1);
    log(`اكتمل التحليل بنجاح في ${duration} ثانية.`,'ok');

    // رابط تنزيل
    download('medical-audit-report-v6', data.merged);

  }catch(err){
    console.error(err);
    const errMsg = err.message || String(err);
    alert(L('حدث خطأ أثناء التحليل: ', 'An error occurred during analysis: ') + errMsg.slice(0, 500));
    execDiv.innerHTML=`<div class="err" style="text-align: center; padding: 20px;">${L('فشل التحليل. تحقق من سجل العمليات.', 'Analysis failed. Check the log.')}</div>`;
    log(`خطأ شامل: ${errMsg}`,'err');
  }finally{
    btn.disabled=false; 
    btn.textContent= L('بدء تحليل الحالة', 'Analyze Case');
  }
});
</script>
</body>
</html>
