<!doctype html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (V7.1 - ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©)</title>
Â  <style>
Â  Â  :root{--bg:#0b1020;--card:#fff;--muted:#667085;--brand:#0ea5e9;--err-color:#dc2626; --warn-color:#ca8a04; --ok-color:#16a34a;}
Â  Â  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial,sans-serif;background:#f6f7fb;margin:0;color:#111;line-height: 1.6;}
Â  Â  header{padding:18px 20px;background:linear-gradient(90deg,#0ea5e9,#2563eb);color:#fff}
Â  Â  header h1{margin:0;font-size:20px}
Â  Â  main{max-width:1200px;margin:22px auto;padding:0 14px 60px}
Â  Â  .card{background:var(--card);border:1px solid #e6e8f0;border-radius:14px;padding:18px;margin:16px 0;box-shadow:0 1px 2px rgba(16,24,40,.04)}
Â  Â  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
Â  Â  label{font-size:14px;color:#334155;margin-bottom: 4px; display: block;}
Â  Â  input[type="file"],select,textarea,button,input[type="text"]{
Â  Â  Â  width:100%;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px;background:#fff;font-size:14px;font-family: inherit;
Â  Â  }
Â  Â  select{width:auto;min-width:210px}
Â  Â  textarea{min-height:90px;resize:vertical}
Â  Â  button{background:#0ea5e9;border:none;color:#fff;cursor:pointer;transition: background 0.2s;}
    button:hover{background: #0284c7;}
Â  Â  button:disabled{opacity:.6;cursor:not-allowed}
Â  Â  small.muted{color:#667085}
Â  Â  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px;margin-inline:2px;font-weight: 500;}
Â  Â  pre{background:#0b1020;color:#e2e8f0;border-radius:12px;padding:14px;overflow:auto;font-size: 13px;}
Â  Â  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
Â  Â  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    @media (max-width: 800px) { .grid, .grid-3 { grid-template-columns: 1fr; } }
Â  Â  .log{background:#0b1020;color:#bcd;min-height:100px;border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size: 13px;}
Â  Â  .ok{color:var(--ok-color)}.warn{color:var(--warn-color)}.err{color:var(--err-color)}
Â  Â  .pill{background:#eef2ff;color:#1d4ed8;border-radius:999px;padding:4px 10px;font-size:13px}
    #exec h4{margin-top: 18px; margin-bottom: 8px; color: #334155;}
    #exec ul{padding-inline-start: 18px; margin-top: 5px;}
    #exec li{margin-bottom: 8px;}
    hr{border: none; border-top: 1px solid #e6e8f0; margin: 18px 0;}
    /* V7 Table Styles */
    .med-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    .med-table th, .med-table td { border: 1px solid #d0d5dd; padding: 10px; text-align: right; vertical-align: top; }
    .med-table th { background-color: #f1f5f9; font-weight: 600; }
    .status-GREEN { background-color: #f0fdf4; }
    .status-YELLOW { background-color: #fefce8; }
    .status-RED { background-color: #fef2f2; }
Â  </style>
    
    </head>
<body>
<header>
Â  <h1>Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (V7.1 - ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©)</h1>
Â  <div style="font-size:13px;opacity:.95">* Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø£ØºØ±Ø§Ø¶ ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙÙ‚Ø·Ø› * ÙŠÙØ±Ø§Ø¬Ø¹ Ø³Ø±ÙŠØ±ÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø£ÙŠ Ù‚Ø±Ø§Ø±Ø› * Ø¥Ø²Ø§Ù„Ø© PHI ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
</header>

<main>
Â  <section class="card">
    Â  Â  <div class="row" style="margin-bottom: 12px;">
Â  Â  Â  <div style="flex:1; min-width: 300px;">
Â  Â  Â  Â  <label>Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª (ØµÙˆØ±/â€PDF):</label>
Â  Â  Â  Â  <input id="fileInput" type="file" multiple accept="image/*,.pdf" />
Â  Â  Â  Â  <small class="muted">ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© (Ù„Ù„ØµÙˆØ± ÙˆPDF) Ù„Ø¶Ù…Ø§Ù† Ù‚Ø±Ø§Ø¡Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„Ø¬Ø±Ø¹Ø§Øª.</small>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="row" style="margin-bottom: 12px; align-items: flex-end;">
Â  Â  Â  <div><label>Ù„ØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</label>
Â  Â  Â  Â  <select id="lang">
Â  Â  Â  Â  Â  <option value="ar" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
Â  Â  Â  Â  Â  <option value="en">English</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <div><label>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:</label>
Â  Â  Â  Â  <select id="model">
Â  Â  Â  Â  Â  <option value="both" selected>Gemini + GPTâ€‘4o (Ù…ÙˆØµÙ‰ Ø¨Ù‡)</option>
Â  Â  Â  Â  Â  <option value="gpt">GPTâ€‘4o ÙÙ‚Ø·</option>
Â  Â  Â  Â  Â  <option value="gemini">Gemini ÙÙ‚Ø·</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <div style="min-width:260px;flex:1">
Â  Â  Â  Â  <label>Ø§Ù„ØªØ®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
Â  Â  Â  Â  <input id="specialty" type="text" placeholder="Ù…Ø«Ù„: Ø¨Ø§Ø·Ù†Ø©ØŒ Ù‚Ù„Ø¨ØŒ ØºØ¯Ø¯ ØµÙ…Ø§Ø¡..." />
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div style="margin-bottom: 15px;">
Â  Â  Â  <label>Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
Â  Â  Â  <textarea id="context" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯ÙˆÙŠØ© Ù„Ù…Ø±ÙŠØ¶ Ø³ÙƒØ±ÙŠ ÙˆØ¶ØºØ· Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠØ©."></textarea>
Â  Â  </div>
Â  Â  <div class="row">
Â  Â  Â  <button id="analyzeBtn">Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
Â  Â  Â  <span class="pill" id="prepInfo" style="display:none"></span>
Â  Â  </div>
Â  </section>

Â  <section class="card">
Â  Â  <h3 style="margin-top:0">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„ (V7)</h3>
Â  Â  <div id="exec" class="card" style="background:#f8fafc;border:1px dashed #d0d5dd;padding: 20px;">
        <div class="muted" style="text-align: center;">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„.</div>
    </div>
    <details style="margin-top: 15px;">
        <summary style="cursor: pointer; color: var(--brand);">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª JSON Ø§Ù„Ø®Ø§Ù… Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©</summary>
Â  Â     <pre id="merged" dir="ltr"></pre>
    </details>
Â  </section>

Â  <div class="grid">
Â  Â  <section class="card">
Â  Â  Â  <h3 style="margin-top:0">Ù…Ø®Ø±Ø¬Ø§Øª GPTâ€‘4o (Raw)</h3>
Â  Â  Â  <pre id="gpt" dir="ltr"></pre>
Â  Â  </section>
Â  Â  <section class="card">
Â  Â  Â  <h3 style="margin-top:0">Ù…Ø®Ø±Ø¬Ø§Øª Gemini (Raw)</h3>
Â  Â  Â  <pre id="gemini" dir="ltr"></pre>
Â  Â  </section>
Â  </div>

Â  <section class="card">
Â  Â  <h3 style="margin-top:0">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Log)</h3>
Â  Â  <div id="log" class="log"></div>
Â  </section>
</main>

<script>
const logEl = document.getElementById('log');
const btn = document.getElementById('analyzeBtn');
const prepInfo = document.getElementById('prepInfo');
const preMerged = document.getElementById('merged');
const preGPT = document.getElementById('gpt');
const preGemini = document.getElementById('gemini');
const execDiv = document.getElementById('exec');

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

function log(msg, cls=""){Â 
Â  const span = document.createElement('div');Â 
Â  span.className = cls;Â 
  const timestamp = new Date().toLocaleTimeString();
Â  span.textContent = `[${timestamp}] ${msg}`;Â 
Â  if (logEl) logEl.appendChild(span);Â 
Â  if (logEl) logEl.scrollTop = logEl.scrollHeight;
  if (cls === 'err' || cls === 'warn') { console.error(`[${cls.toUpperCase()}] ${msg}`); } else { console.log(msg); }
}

// =====================================================================
// PDF.js Loading System (V6.4/V7 - Self-hosted priority)
// =====================================================================
const PDFJS_VERSION = '4.3.136';
const PDFJS_SOURCES = [
    { 
        name: 'Self-Hosted', 
        lib: `./pdfjs-assets/pdf.legacy.min.js`, 
        worker: `./pdfjs-assets/pdf.worker.min.js`, 
        fonts: `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDFJS_VERSION}/standard_fonts/` 
    },
    { name: 'jsDelivr (Fallback)', lib: `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDFJS_VERSION}/build/pdf.legacy.min.js`, worker: `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDFJS_VERSION}/build/pdf.worker.min.js`, fonts: `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDFJS_VERSION}/standard_fonts/` },
    { name: 'cdnjs (Fallback)', lib: `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/pdf.legacy.min.js`, worker: `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/pdf.worker.min.js`, fonts: `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/standard_fonts/` }
];

let pdfjsLoaded = false;
let pdfjsLoadPromise = null;
let pdfjsConfig = {}; 

function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        
        script.onload = () => {
            if (typeof pdfjsLib !== 'undefined' && pdfjsLib.GlobalWorkerOptions && typeof pdfjsLib.getDocument === 'function') {
                 resolve(true);
            } else {
                reject(new Error(`Script loaded but pdfjsLib is incomplete: ${src}`));
            }
        };
        script.onerror = (e) => {
            const errorMsg = src.startsWith('./') ? 
                `Failed to load local script (Ensure 'pdfjs-assets' folder exists): ${src}` :
                `Failed to load script from network (Check connection/blockers): ${src}`;
            reject(new Error(errorMsg));
        };
        document.head.appendChild(script);
    });
}

async function initializePdfJs(L) {
    if (pdfjsLoaded) return true;
    if (pdfjsLoadPromise) return pdfjsLoadPromise;

    pdfjsLoadPromise = new Promise(async (resolve) => {
        log("Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© PDF.js...");
        btn.textContent = L("... ØªØ­Ù…ÙŠÙ„ Ù…ÙƒÙˆÙ†Ø§Øª PDF", "... Loading PDF Components");

        for (const source of PDFJS_SOURCES) {
            try {
                log(`> Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ${source.name} (${source.lib})...`);
                await loadScript(source.lib);
                
                pdfjsLib.GlobalWorkerOptions.workerSrc = source.worker;
                pdfjsConfig.fontsUrl = source.fonts;
                pdfjsLoaded = true;
                log(`> Ù†Ø¬Ø§Ø­: ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙˆØªÙ‡ÙŠØ¦Ø© PDF.js Ù…Ù† ${source.name}.`, 'ok');
                resolve(true);
                return;
                
            } catch (error) {
                log(`> ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ${source.name}: ${error.message}`, 'warn');
                if (typeof window.pdfjsLib !== 'undefined') {
                    try { delete window.pdfjsLib; } catch (e) {}
                }
            }
        }

        pdfjsLoaded = false;
        log("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ PDF.js Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø± (Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ).", 'err');
        resolve(false);
    }).finally(() => {
        if (btn.disabled) {
             btn.textContent = L('... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±', '... Preparing');
        }
    });

    return pdfjsLoadPromise;
}

// =====================================================================
// Image Processing Functions (V7: Enhanced Quality)
// =====================================================================

// Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø¯Ù‚Ø© Ù„Ø¶Ù…Ø§Ù† Ù‚Ø±Ø§Ø¡Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø¯ÙˆÙŠØ©
function b64FromCanvas(canvas, mime="image/jpeg", quality=0.88, maxW=2000){
  try {
    if (!canvas || canvas.width === 0 || canvas.height === 0) {
        log(`ØªØ­Ø°ÙŠØ±: Ø£Ø¨Ø¹Ø§Ø¯ Canvas Ù‡ÙŠ ØµÙØ± Ø£Ùˆ Ø§Ù„ÙƒØ§Ø¦Ù† ØºÙŠØ± ØµØ§Ù„Ø­.`, 'warn');
        return '';
    }

    const scale = Math.min(1, maxW / canvas.width);
    
    let targetCanvas = canvas;

    if (scale < 1) {
        const tmp = document.createElement('canvas');
        tmp.width = Math.max(1, Math.round(canvas.width * scale));
        tmp.height = Math.max(1, Math.round(canvas.height * scale));
        const ctx = tmp.getContext('2d');
        if (!ctx) throw new Error("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Canvas Context.");

        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(canvas, 0, 0, tmp.width, tmp.height);
        targetCanvas = tmp;
    }
    
    return targetCanvas.toDataURL(mime, quality).split(',')[1];

  } catch (error) {
    log(`ÙØ´Ù„ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64: ${error.message}`, 'err');
    return '';
  }
}

async function imageFileToB64(file){
    const img = new Image();
    const url = URL.createObjectURL(file);
    try {
        await new Promise((res, rej)=>{
            img.onload = ()=>res();
            img.onerror = (e) => rej(new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: ${file.name}`));
            img.src = url;
        });
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        if (!ctx) throw new Error("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Canvas Context Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.");
        
        // Ø¶Ù…Ø§Ù† Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡
        if (!file.type.includes('png')) {
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        ctx.drawImage(img,0,0);
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© V7
        const data = b64FromCanvas(canvas, file.type.includes('png')?'image/png':'image/jpeg');
        if (!data) throw new Error("ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø£Ø±Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©.");
        return data;
    } finally {
        URL.revokeObjectURL(url);
    }
}

// ÙˆØ¸ÙŠÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© PDF (V7: Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¯Ù‚Ø©)
async function pdfToImagesAndText(file, L){
    if (!pdfjsLoaded || typeof pdfjsLib === 'undefined') {
        return { images: [], text: L("[PDF Processing Disabled: Library Not Loaded]", "[PDF Processing Disabled: Library Not Loaded]") };
    }

Â    const images = [];
Â    let fullText = '';
    const scale = 2.5; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¯Ù‚Ø© Ù„Ù€ V7

    let pdf;
    try {
        const arr = await file.arrayBuffer();
        if (!arr || arr.byteLength === 0) {
            return { images: [], text: "[Empty File]" };
        }
    Â  Â  pdf = await pdfjsLib.getDocument({
            data:arr,
            standardFontDataUrl: pdfjsConfig.fontsUrl
        }).promise;
    } catch (pdfLoadError) {
        let errorReason = pdfLoadError.name === 'PasswordException' ? L('Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±', 'Password Protected') : L('ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­', 'Corrupt or Invalid');
        log(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ PDF: ${file.name}. Ø§Ù„Ø³Ø¨Ø¨: ${errorReason}.`, 'err');
        return { images: [], text: `[PDF Loading Failed: ${errorReason}]` };
    }

Â    for(let p=1; p <= pdf.numPages; p++){
        btn.textContent = `${L('... Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙØ­Ø©', '... Processing Page')} ${p}/${pdf.numPages}`;
        await sleep(15);
        log(`> ØªØ­ÙˆÙŠÙ„ ØµÙØ­Ø© ${p}/${pdf.numPages} Ù…Ù† ${file.name} ...`);

        let page;
        try { page = await pdf.getPage(p); } catch (e) { log(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© ${p}`, 'err'); continue; }

        const viewport = page.getViewport({scale: scale});

        // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©
        try {
    Â  Â      const canvas = document.createElement('canvas');
    Â  Â      const ctx = canvas.getContext('2d');
    Â  Â      canvas.width = viewport.width; canvas.height = viewport.height;
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
    Â  Â      await page.render({canvasContext:ctx, viewport}).promise;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© V7
            const imgData = b64FromCanvas(canvas, "image/jpeg");
            if (imgData) images.push(imgData);
        } catch (e) { log(`ÙØ´Ù„ Ø±Ø³Ù… ØµÙØ­Ø© ${p}`, 'warn'); }
    Â  Â  
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ
        let pageText = '';
        try {
            const tc = await page.getTextContent();
            let lastY = -1;
            for (const item of tc.items) {
                if (!item || typeof item.str !== 'string' || item.str.trim() === '') continue;
                const currentY = (Array.isArray(item.transform) && item.transform.length >= 6) ? item.transform[5] : null;
                const height = (typeof item.height === 'number' && item.height > 0) ? item.height : 10; 

                if (lastY !== -1 && currentY !== null && Math.abs(currentY - lastY) > height * 0.5) {
                    if (!pageText.endsWith('\n')) pageText += '\n';
                }
                pageText += item.str + ' ';
                if (currentY !== null) lastY = currentY;
            }
        } catch (e) { log(`ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ ØµÙØ­Ø© ${p}`, 'warn'); }

        pageText = pageText.replace(/[ \t]+/g, ' ').trim();
    Â  Â  fullText += `\n\n[BEGIN PAGE ${p}]\n${pageText}\n[END PAGE ${p}]\n\n`;
        
        if (page) page.cleanup();
        log(`> Ø§ÙƒØªÙ…Ù„Øª ØµÙØ­Ø© ${p}.`, 'ok');
    Â  }
    Â  return {images, text: fullText.trim()};
}

function sanitize(str, max=100000){
Â  const sanitized = (str||'').replace(/[\u2028\u2029\u0000-\u001F]/g,' ');
  if (sanitized.length > max) {
    log(`ØªØ­Ø°ÙŠØ±: ØªÙ… Ø§Ù‚ØªØµØ§Øµ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„ Ù„Ø·ÙˆÙ„Ù‡ Ø§Ù„Ø²Ø§Ø¦Ø¯.`, 'warn');
    return sanitized.slice(0, max) + "\n\n[...CONTENT TRUNCATED...]";
  }
  return sanitized;
}

function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return String(unsafe || '');
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

// =====================================================================
// V7.x: ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¹Ø±Ø¶
// =====================================================================

function renderExecutive(report){
  const lang = document.getElementById('lang').value || 'ar';
  const L = (ar, en) => lang === 'ar' ? ar : en;

Â  if(!report || Object.keys(report).length === 0) { 
    execDiv.innerHTML=`<div class="muted" style="text-align: center; padding: 20px;">${L('Ù„Ù… ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ØµØ§Ù„Ø­.', 'No valid report generated.')}</div>`;
    return; 
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  const renderList = (items, mapper, limit=10) => {
    if (!items || items.length === 0) return '<li>â€”</li>';
    return items.slice(0, limit).map(mapper).join('');
  };

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª V7
  const patient = report.patient_info || {};
  const physician = report.physician_info || {};
  const diagnoses = renderList(report.diagnoses, d => `<li>${escapeHtml(d)}</li>`);
  const analysis = report.consultative_analysis || {};
  const gaps = report.gap_analysis_missing_interventions || [];
  
  // Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
  const medicationReview = report.medication_review || [];
  let medTableHtml = '';

  if (medicationReview.length > 0) {
    medTableHtml = `<div style="overflow-x: auto;"><table class="med-table">
        <thead>
            <tr>
                <th>${L('Ø§Ù„Ø¯ÙˆØ§Ø¡ / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', 'Medication/Procedure')}</th>
                <th>${L('Ø§Ù„Ø¬Ø±Ø¹Ø©/Ø§Ù„ØªÙƒØ±Ø§Ø±', 'Dose/Freq')}</th>
                <th>${L('Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„ÙƒÙ…ÙŠØ©', 'Duration/Qty')}</th>
                <th>${L('Ø§Ù„Ø­Ø§Ù„Ø©', 'Status')}</th>
                <th>${L('Ø§Ù„ØªØ¹Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ ÙˆØ§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ (Justification)', 'Clinical & Insurance Justification')}</th>
                <th>${L('Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', 'Action')}</th>
            </tr>
        </thead>
        <tbody>`;
    
    medicationReview.forEach(item => {
        const statusCode = escapeHtml(item.insurance_status_code || 'YELLOW').toUpperCase();
        const emoji = escapeHtml(item.status_emoji || 'ğŸŸ¡');
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ„ÙˆÙŠÙ† Ø¹Ø¨Ø± ÙØ¦Ø© CSS
        medTableHtml += `<tr class="status-${statusCode}">
            <td><b>${escapeHtml(item.medication)}</b></td>
            <td>${escapeHtml(item.dose_frequency)}</td>
            <td>${escapeHtml(item.duration_quantity)}</td>
            <td>${emoji}</td>
            <td>${escapeHtml(item.justification)}</td>
            <td><span class="chip">${escapeHtml(item.action_required)}</span></td>
        </tr>`;
    });

    medTableHtml += `</tbody></table></div>`;
  } else {
    medTableHtml = `<p class="muted">${L('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¯ÙˆÙŠØ© Ù…ÙˆØµÙˆÙØ©.', 'No medications found.')}</p>`;
  }

  // Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠ
  const redFlags = renderList(analysis.red_flags_immediate_action, i => `<li class="err"><b>${escapeHtml(i.issue)}</b><br><em>${L('Ø§Ù„ØªÙˆØµÙŠØ©', 'Recommendation')}:</em> ${escapeHtml(i.recommendation)}</li>`);
  const yellowFlags = renderList(analysis.yellow_flags_monitoring_needed, i => `<li class="warn"><b>${escapeHtml(i.issue)}</b><br><em>${L('Ø§Ù„ØªÙˆØµÙŠØ©', 'Recommendation')}:</em> ${escapeHtml(i.recommendation)}</li>`);
  const greenFlags = renderList(analysis.green_flags_appropriate_care, i => `<li class="ok"><b>${escapeHtml(i.item)}</b><br><em>${L('Ù…Ù„Ø§Ø­Ø¸Ø©', 'Note')}:</em> ${escapeHtml(i.note)}</li>`);
  const gapAnalysis = renderList(gaps, g => `<li><b>${escapeHtml(g.gap)}</b><br><em>${L('Ø§Ù„ØªÙˆØµÙŠØ©', 'Recommendation')}:</em> ${escapeHtml(g.recommendation)}</li>`);

  const summary = escapeHtml(report.executive_summary || L('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø®Øµ.', 'No summary available.'));

  // ØªØ®Ø·ÙŠØ· V7
Â  execDiv.innerHTML = `
Â  Â  <div style="font-size: 15px;"><h4>${L('Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ', 'Executive Summary')}</h4><div>${summary}</div></div>
Â  Â  <hr>
    <h4>${L('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØ´Ø®ÙŠØµØ§Øª', 'Case Data & Diagnoses')}</h4>
    <div class="grid-3">
        <div><b>${L('Ø§Ù„Ù…Ø±ÙŠØ¶','Patient')}</b>
            <p>${L('Ø§Ù„Ø§Ø³Ù…', 'Name')}: ${escapeHtml(patient.name) || 'â€”'}<br>
            ${L('Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ù†ÙˆØ¹', 'Age/Gender')}: ${escapeHtml(patient.age) || 'â€”'} / ${escapeHtml(patient.gender) || 'â€”'}<br>
            ${L('Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù', 'File ID')}: ${escapeHtml(patient.file_id) || 'â€”'}</p>
        </div>
        <div><b>${L('Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬','Physician')}</b>
            <p>${L('Ø§Ù„Ø§Ø³Ù…', 'Name')}: ${escapeHtml(physician.name) || 'â€”'}<br>
            ${L('Ø§Ù„ØªØ®ØµØµ', 'Specialty')}: ${escapeHtml(physician.specialty) || 'â€”'}</p>
        </div>
        <div><b>${L('Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª Ø§Ù„Ù…ÙˆØ«Ù‚Ø©','Documented Diagnoses')}</b><ul>${diagnoses}</ul></div>
    </div>
    <hr>
    <h4>${L('Ø¬Ø¯ÙˆÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠØ©', 'Medication Review & Claims Audit Table')}</h4>
    ${medTableHtml}
    <hr>
    <h4>${L('Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠ ÙˆØ³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø±ÙŠØ¶', 'Consultative Analysis & Patient Safety')}</h4>
Â  Â  <div class="grid-3">
Â  Â  Â  <div><b style="color: var(--err-color);">${L('ğŸ”´ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø®Ø·Ø±Ø©/ÙŠØ¬Ø¨ Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ (Red Flags)', 'ğŸ”´ Dangerous/Stop Actions (Red Flags)')}</b><ul>${redFlags}</ul></div>
Â  Â  Â  <div><b style="color: var(--warn-color);">${L('ğŸŸ¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©/Ù…Ø´ÙƒÙˆÙƒ ÙÙŠÙ‡Ø§ (Yellow Flags)', 'ğŸŸ¡ Review/Questionable Actions (Yellow Flags)')}</b><ul>${yellowFlags}</ul></div>
      <div><b style="color: var(--ok-color);">${L('ğŸŸ¢ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆÙ…Ø¨Ø±Ø±Ø© (Green Flags)', 'ğŸŸ¢ Appropriate & Justified Actions (Green Flags)')}</b><ul>${greenFlags}</ul></div>
Â  Â  </div>
    <hr>
    <h4>${L('ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ¬ÙˆØ§Øª ÙˆØ§Ù„ØªØ¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© (Gap Analysis)', 'Gap Analysis & Missing Interventions')}</h4>
    <ul>${gapAnalysis}</ul>

Â  Â  <div style="margin-top: 20px;"><small class="muted" style="font-style: italic;">${escapeHtml(report.patient_safety_note||'')}</small></div>
Â  `;
}

// =====================================================================
// Main Logic (prepareFiles, download, event listener)
// =====================================================================

async function prepareFiles(files, L){
Â  const images = []; let textChunks = [];
  let startTime = Date.now();
  let successfulFiles = 0;
  let requiresPdfJs = files.some(f => f.type === 'application/pdf');

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
  if (requiresPdfJs) {
    const loadSuccess = await initializePdfJs(L);
    if (!loadSuccess) {
        alert(L(
            "ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© PDF (PDF.js) Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ù„Ø¨Ø¹ÙŠØ¯Ø©.\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù„ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ PDF Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¬Ù„Ø¯ 'pdfjs-assets' ÙˆÙ…Ù„ÙØ§ØªÙ‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŒ Ø£Ùˆ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©.",
            "Warning: Failed to load the PDF processing library (PDF.js) from local and remote sources.\n\nPDF files cannot be analyzed. Please ensure 'pdfjs-assets' folder and files exist correctly, or check your internet connection and privacy settings."
        ));
    }
  }

Â  for(const f of files){
    try {
        if(f.type === 'application/pdf'){
    Â  Â  Â    const {images:imgs,text} = await pdfToImagesAndText(f, L);
            const isErrorMessage = text.startsWith("[PDF Loading Failed]") || text.includes("[PDF Processing Disabled]");

            if (imgs.length > 0 || (text.length > 0 && !isErrorMessage)) {
        Â  Â  Â    images.push(...imgs.filter(Boolean));
        Â  Â  Â    textChunks.push(`\n\n# BEGIN DOCUMENT: ${f.name} (Type: PDF)\n${text}\n# END DOCUMENT: ${f.name}\n\n`);
                successfulFiles++;
            } else if (isErrorMessage) {
                log(`ØªØ®Ø·ÙŠ Ù…Ù„Ù PDF Ø¨Ø³Ø¨Ø¨ ÙØ´Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${f.name}`, 'warn');
            }

    Â  Â  } else if (f.type.startsWith('image/')){
            btn.textContent = `${L('... ØªØ­ÙˆÙŠÙ„', '... Converting')} ${f.name}`;
            await sleep(10);
    Â  Â  Â    log(`> ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø©: ${f.name} ...`);
    Â  Â  Â    const imgData = await imageFileToB64(f);
            images.push(imgData);
            log(`> Ø§ÙƒØªÙ…Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.`, 'ok');
            // Ù„Ø§ Ù†Ø¶ÙŠÙ Ù†Øµ Ù„Ù„ØµÙˆØ±Ø©ØŒ Ù†ØªØ±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ØµØ±ÙŠ
            successfulFiles++;
    Â  Â  } else {
            log(`> ØªØ®Ø·ÙŠ Ù†ÙˆØ¹ Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…: ${f.name}`, 'warn');
        }
    } catch (error) {
        log(`ÙØ´Ù„ Ø´Ø§Ù…Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù ${f.name}. Ø§Ù„Ø®Ø·Ø£: ${error.message}`, 'err');
    }
Â  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
  if (images.length === 0 && textChunks.length === 0) {
    throw new Error(L(
        "Ù„Ù… ÙŠØªÙ… ØªØ¬Ù‡ÙŠØ² Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØ­Ù„ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.",
        "No content was prepared for analysis. Please review the error log."
    ));
  }

  log(`Ø§ÙƒØªÙ…Ù„ ØªØ­Ø¶ÙŠØ± ${successfulFiles} Ù…Ù„Ù/Ù…Ù„ÙØ§Øª ÙÙŠ ${((Date.now() - startTime)/1000).toFixed(1)} Ø«Ø§Ù†ÙŠØ©.`, 'ok');
Â  return { images, text: sanitize(textChunks.join('\n')) };
}

function download(name, obj){
  if (!obj || Object.keys(obj).length === 0) return;
Â  const url = URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}));
Â  const a = document.createElement('a');
  const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
Â  a.href = url; a.download = `${name}-${timestamp}.json`; a.click();
Â  setTimeout(()=>URL.revokeObjectURL(url),5000);
}

// Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø²Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„
document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
Â  const lang = document.getElementById('lang').value || 'ar';
  const L = (ar, en) => lang === 'ar' ? ar : en;
  let analysisStartTime;

Â  try{
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
Â  Â  logEl.textContent=''; preMerged.textContent=''; preGPT.textContent=''; preGemini.textContent=''; 
    execDiv.innerHTML=`<div class="muted" style="text-align: center;">${L('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...', 'Preparing...')}</div>`;
    prepInfo.style.display='none';

Â  Â  const files = Array.from(document.getElementById('fileInput').files||[]);
Â  Â  if(files.length===0){ alert(L('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.', 'Please select at least one file.')); return; }
Â  Â  
    btn.disabled = true; 
    btn.textContent = L('... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±', '... Preparing');
Â  Â  log('Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¶ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„...');

    // Ø®Ø·ÙˆØ© Ø§Ù„ØªØ­Ø¶ÙŠØ±
Â  Â  const prep = await prepareFiles(files, L);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±
Â  Â  prepInfo.style.display='inline-block';
    const prepMsg = L(
        `ØªÙ… ØªØ¬Ù‡ÙŠØ² ${prep.images.length} ØµÙˆØ±Ø©/ØµÙØ­Ø© Ùˆ ${prep.text.length} Ø­Ø±Ù Ù†ØµÙŠ.`,
        `Prepared ${prep.images.length} images/pages and ${prep.text.length} chars.`
    );
Â  Â  prepInfo.textContent = prepMsg;
Â  Â  
    // Ø®Ø·ÙˆØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„Ù€ API
    log('Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹)...');
    execDiv.innerHTML=`<div class="muted" style="text-align: center;">${L('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...', 'Analyzing, please wait...')}</div>`;
Â  Â  btn.textContent = L('... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„', '... Analyzing');

Â  Â  const payload = {
Â  Â  Â  lang: lang,
Â  Â  Â  modelChoice: document.getElementById('model').value || 'both',
Â  Â  Â  specialty: document.getElementById('specialty').value || '',
Â  Â  Â  context: document.getElementById('context').value || '',
Â  Â  Â  images: prep.images,
Â  Â  Â  text: prep.text,
Â  Â  Â  fileNames: files.map(f=>f.name),
Â  Â  Â  apiVersion: 'v7.1.0' // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¥Ù„Ù‰ V7.1
Â  Â  };

    analysisStartTime = Date.now();
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ·Ø§Ø¨Ù‚ Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù€ API)
Â  Â  const res = await fetch('/api/gpt', { // Ø£Ùˆ /api/case-analyzer
Â  Â  Â  method:'POST',
Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…
Â  Â  if(!res.ok){
Â  Â  Â  const errTxt = await res.text();
      log(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: HTTP ${res.status}`, 'err');
Â  Â  Â  throw new Error(`Server Error (${res.status}): ${errTxt}`);
Â  Â  }
Â  Â  const data = await res.json();

    if (!data.ok && !data.merged) {
        throw new Error(`Analysis Failed on Server: ${data.error || 'Unknown error'}`);
    }

Â  Â  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
Â  Â  renderExecutive(data.merged);
Â  Â  preMerged.textContent = JSON.stringify(data.merged, null, 2);
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ø®Ø§Ù…
    const displayRaw = (preEl, modelData) => {
        if (modelData?.raw) {
            preEl.textContent = modelData.raw;
        } else {
            preEl.textContent = `Status: ${modelData?.note || 'N/A'}\nError: ${modelData?.error || 'None'}`;
        }
    };
    displayRaw(preGPT, data.gpt);
    displayRaw(preGemini, data.gemini);

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¬Ø²Ø¦ÙŠØ©
    if (data.errors && data.errors.length > 0) {
        log('ØªØ­Ø°ÙŠØ±: Ø­Ø¯Ø«Øª Ø£Ø®Ø·Ø§Ø¡ Ø¬Ø²Ø¦ÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„:', 'warn');
        data.errors.forEach(e => log(e, 'warn'));
    }

    const duration = ((Date.now() - analysisStartTime) / 1000).toFixed(1);
Â  Â  log(`Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ${duration} Ø«Ø§Ù†ÙŠØ©.`,'ok');

Â  Â  // Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„
Â  Â  download('medical-pharmacy-audit-v7', data.merged);

Â  }catch(err){
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
    const errMsg = err.message || String(err);
Â  Â  alert(L('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ', 'An error occurred during analysis: ') + errMsg.slice(0, 500));
    execDiv.innerHTML=`<div class="err" style="text-align: center; padding: 20px; background: #fef2f2;">${L('ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.', 'Analysis failed. Check the log.')}</div>`;
Â  Â  log(`Ø®Ø·Ø£ Ø´Ø§Ù…Ù„: ${errMsg}`,'err');
Â  }finally{
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
Â  Â  btn.disabled=false; 
    btn.textContent= L('Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©', 'Analyze Case');
Â  }
});
</script>
</body>
</html>
