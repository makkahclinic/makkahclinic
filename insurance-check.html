<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="app_title">تقييم الحالة الطبية وطلبات التأمين</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{--primary-600:#0284c7;--primary-700:#0369a1;--primary-800:#075985;--gray-50:#f8fafc;--gray-100:#f1f5f9;--gray-200:#e2e8f0;--gray-300:#cbd5e1;--gray-500:#64748b;--gray-700:#334155;--gray-900:#0f172a}
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;background:var(--gray-50);color:var(--gray-900);margin:0}
    .container{max-width:1100px;margin:24px auto;padding:24px;background:#fff;border:1px solid var(--gray-200);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:20px}
    .home-link{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:var(--primary-600);color:#fff;border-radius:12px;text-decoration:none;font-weight:600}
    .home-link:hover{background:var(--primary-700)}
    .chip{display:inline-flex;align-items:center;padding:6px 14px;border-radius:9999px;background:var(--gray-100);color:#475569;font-size:14px;font-weight:500;cursor:pointer}
    h1.main-title{font-size:32px;text-align:center;color:var(--primary-800);margin:0 0 8px}
    p.subtitle{font-size:15px;color:var(--gray-500);text-align:center;margin:0 0 24px}
    .banner{display:flex;gap:12px;padding:16px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;color:#0c4a6e;margin-bottom:24px}
    .section{margin-top:24px}
    .section-title{font-size:20px;color:#075985;display:flex;align-items:center;gap:10px;margin:0 0 16px}
    .card{padding:24px;border-radius:16px;border:1px solid var(--gray-200);background:#f8fafc}
    .grid{display:grid;gap:20px;grid-template-columns:repeat(1,1fr)}
    @media(min-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
    label{display:block;font-size:15px;color:#334155;font-weight:500;margin-bottom:8px}
    input,select,textarea{width:100%;padding:14px;border:1px solid var(--gray-300);border-radius:12px;background:#fff;font-size:15px;color:#111827;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#38bdf8;box-shadow:0 0 0 4px #93c5fd}
    textarea{min-height:100px;resize:vertical}
    .uploader{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;border:2px dashed #7dd3fc;border-radius:16px;background:#eff6ff;color:#075985;font-weight:500;cursor:pointer}
    .uploader .browse{margin-top:10px}
    .file-cards{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));margin-top:16px}
    .file-card{position:relative;background:#fff;border:1px solid var(--gray-200);border-radius:14px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    .file-thumb{width:100%;height:140px;object-fit:cover;background:#f1f5f9}
    .file-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .remove-btn{position:absolute;top:8px;right:8px;width:32px;height:32px;border-radius:50%;background:#ef4444;color:#fff;border:none;font-weight:700;font-size:16px;cursor:pointer}
    .btn{border:none;cursor:pointer;padding:14px 24px;border-radius:12px;font-weight:700}
    .btn-primary{background:#0284c7;color:#fff}.btn-primary:hover{background:#0369a1}
    .btn-outline{background:#fff;color:#111827;border:1px solid var(--gray-300)}
    .busy-text{color:#64748b;font-size:14px}
    .report-wrap{margin-top:32px;display:none}
    .report-content{width:100%;max-width:850px;margin:0 auto;padding:24px;border:1px solid var(--gray-200);border-radius:16px;background:#fff}
    .audit-table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:14px}
    .audit-table th,.audit-table td{padding:12px;text-align:right;border-bottom:1px solid #e5e7eb;vertical-align:top;word-wrap:break-word}
    .audit-table th{background:#f8fafc}
    .risk-critical td{background:#fce8e6}.risk-warning td{background:#fff0e1}.risk-ok td{background:#e6f4ea}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <a class="home-link" href="https://www.m2020m.org/portal.html" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span data-i18n="home_page">الصفحة الرئيسية</span>
      </a>
      <span class="chip" id="lang-switcher" data-i18n="lang_button">English</span>
      <button class="btn btn-outline" id="newCaseBtn" data-i18n="btn_new_case" title="ابدأ حالة جديدة">حالة جديدة</button>
    </div>

    <h1 class="main-title" data-i18n="main_title">تقييم الحالة الطبية وطلبات التأمين</h1>
    <p class="subtitle" data-i18n="subtitle">واجهة إدخال سريرية — تحليل عميق + توصيات إكلينيكية + جدول تأميني</p>

    <div class="banner">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2 1 21h22L12 2Zm1 15h-2v-2h2v2Zm0-4h-2V8h2v5Z"/></svg>
      <span data-i18n="banner_text">يعتمد التحليل على نماذج ذكاء اصطناعي خادمية معزولة لكل حالة لضمان عدم امتزاج النتائج.</span>
    </div>

    <!-- 1) معلومات المريض -->
    <div class="section">
      <h2 class="section-title" data-i18n="section1_title">1) معلومات المريض</h2>
      <div class="card">
        <div class="grid">
          <div><label data-i18n="label_name">الاسم (اختياري)</label><input id="name" data-i18n-placeholder="ph_name" placeholder="مثال: أحمد خالد" /></div>
          <div><label data-i18n="label_gender">الجنس</label><select id="gender">
            <option value="" data-i18n="opt_select">اختر</option>
            <option value="ذكر" data-i18n="opt_male">ذكر</option>
            <option value="أنثى" data-i18n="opt_female">أنثى</option>
          </select></div>
          <div><label data-i18n="label_age">العمر (بالسنوات)</label><input id="age" type="number" min="0" data-i18n-placeholder="ph_age" placeholder="مثال: 63"/></div>
          <div><label data-i18n="label_pregnant">هل المريضة حامل؟</label><select id="pregnant">
            <option value="no" data-i18n="opt_no">لا</option>
            <option value="yes" data-i18n="opt_yes">نعم</option>
            <option value="na" data-i18n="opt_na">غير منطبق</option>
          </select></div>
          <div><label data-i18n="label_pregnancy_months">شهر الحمل (إن وُجد)</label><input id="pregnancyMonths" type="number" min="1" max="10" data-i18n-placeholder="ph_preg_month" placeholder="مثال: 5" /></div>
          <div><label data-i18n="label_smoking">هل المريض مدخّن؟</label><select id="smoking">
            <option value="" data-i18n="opt_select">اختر</option>
            <option value="مدخن" data-i18n="opt_smoker">مدخن</option>
            <option value="غير مدخن" data-i18n="opt_nonsmoker">غير مدخن</option>
            <option value="سابق" data-i18n="opt_exsmoker">سابق</option>
          </select></div>
          <div><label data-i18n="label_pack_years">Pack‑Years (إن وُجد)</label><input id="packYears" type="number" min="0" step="0.5" data-i18n-placeholder="ph_pack_years" placeholder="مثال: 15" /></div>
          <div><label data-i18n="label_weight">الوزن (كجم)</label><input id="weight" type="number" step="0.1" data-i18n-placeholder="ph_weight" placeholder="مثال: 78" /></div>
          <div><label data-i18n="label_height">الطول (سم)</label><input id="height" type="number" step="0.5" data-i18n-placeholder="ph_height" placeholder="مثال: 172" /></div>
          <div><label data-i18n="label_temp">درجة الحرارة (°م)</label><input id="temp" type="number" step="0.1" data-i18n-placeholder="ph_temp" placeholder="مثال: 37.4" /></div>
          <div><label data-i18n="label_has_cough">هل يوجد سُعال؟</label><select id="hasCough">
            <option value="" data-i18n="opt_select">اختر</option>
            <option data-i18n="opt_yes">نعم</option>
            <option data-i18n="opt_no">لا</option>
          </select></div>
          <div><label data-i18n="label_cough_weeks">مدة السعال (أسابيع)</label><input id="coughWeeks" type="number" min="0" data-i18n-placeholder="ph_cough_weeks" placeholder="مثال: 12" /></div>
          <div><label data-i18n="label_cough_type">نوع السعال</label><select id="coughType">
            <option value="" data-i18n="opt_select">اختر</option>
            <option data-i18n="opt_dry">جاف</option>
            <option data-i18n="opt_productive">ببلغم</option>
            <option data-i18n="opt_hemoptysis">بدم</option>
          </select></div>
        </div>
      </div>
    </div>

    <!-- 2) الأعراض والنصوص -->
    <div class="section">
      <h2 class="section-title" data-i18n="section2_title">2) خطّ الحياة والأعراض</h2>
      <div class="card">
        <div class="grid">
          <div style="grid-column:1/-1"><label data-i18n="label_free_text">وصف الحالة (نص حر)</label>
            <textarea id="freeText" data-i18n-placeholder="ph_free_text" placeholder="مثال: سعال مزمن 12 أسبوعًا..."></textarea>
          </div>
          <div><label data-i18n="label_initial_dx">التشخيصات المبدئية</label><textarea id="initialDx" data-i18n-placeholder="ph_initial_dx" placeholder="مثال: T2DM, HTN, COPD? Dermatitis"></textarea></div>
          <div><label data-i18n="label_labs_imaging">تحاليل/أشعة مذكورة</label><textarea id="labsImaging" data-i18n-placeholder="ph_labs_imaging" placeholder="مثال: HbA1c 8.7%, eGFR 38→62, K 5.6 ..."></textarea></div>
          <div style="grid-column:1/-1"><label data-i18n="label_orders">الأدوية/الإجراءات المقرّرة</label><textarea id="orders" data-i18n-placeholder="ph_orders" placeholder="مثال: Xigduo XR bid, Metformin 1000 tid ..."></textarea></div>
        </div>
      </div>
    </div>

    <!-- 3) رفع ملفات -->
    <div class="section">
      <h2 class="section-title" data-i18n="section3_title">3) رفع ملفات (صور/PDF) — اختياري</h2>
      <div class="uploader" id="dropZone">
        <div data-i18n="uploader_text">اسحب الملفات هنا أو اضغط الزر لاختيارها</div>
        <button class="btn btn-outline browse" id="browseBtn" type="button" data-i18n="btn_browse">اختيار ملفات</button>
      </div>
      <input id="fileInput" class="sr-only" type="file" multiple accept="image/*,application/pdf" />
      <div id="cards" class="file-cards" aria-live="polite"></div>
      <div id="fileList" style="margin-top:8px;color:#475569"></div>
    </div>

    <div class="section" style="display:flex;gap:12px;align-items:center">
      <button class="btn btn-primary" id="analyzeBtn" data-i18n="btn_analyze">تحليل الحالة</button>
      <button class="btn btn-outline" id="exportServerBtn" data-i18n="btn_export_server">تصدير PDF (الخادم)</button>
      <button class="btn btn-outline" id="exportPdfBtn" data-i18n="btn_export_client">تصدير PDF (العميل)</button>
      <span id="busy" class="busy-text" style="display:none" data-i18n="busy_text">جاري التحليل…</span>
    </div>

    <div id="reportWrap" class="report-wrap">
      <div id="reportHTML" class="report-content"></div>
      <details style="margin-top:16px">
        <summary style="font-size:14px;color:#075985;cursor:pointer" data-i18n="show_json">إظهار JSON (للبحث/الإحصاءات)</summary>
        <pre id="jsonOut" style="white-space:pre-wrap;background:#f1f5f9;padding:16px;border-radius:12px;border:1px solid #e2e8f0;margin-top:12px;font-size:13px"></pre>
      </details>
    </div>
  </div>

  <script>
    /* ========== i18n ========== */
    const i18n = {
      ar: {
        app_title:"تقييم الحالة الطبية وطلبات التأمين", home_page:"الصفحة الرئيسية", lang_button:"English", btn_new_case:"حالة جديدة",
        main_title:"تقييم الحالة الطبية وطلبات التأمين", subtitle:"واجهة إدخال سريرية — تحليل عميق + توصيات إكلينيكية + جدول تأميني",
        banner_text:"يعتمد التحليل على نماذج ذكاء اصطناعي خادمية معزولة لكل حالة لضمان عدم امتزاج النتائج.",
        section1_title:"1) معلومات المريض", label_name:"الاسم (اختياري)", ph_name:"مثال: أحمد خالد",
        label_gender:"الجنس", opt_select:"اختر", opt_male:"ذكر", opt_female:"أنثى",
        label_age:"العمر (بالسنوات)", ph_age:"مثال: 63", label_pregnant:"هل المريضة حامل؟",
        opt_no:"لا", opt_yes:"نعم", opt_na:"غير منطبق",
        label_pregnancy_months:"شهر الحمل (إن وُجد)", ph_preg_month:"مثال: 5",
        label_smoking:"هل المريض مدخّن؟", opt_smoker:"مدخن", opt_nonsmoker:"غير مدخن", opt_exsmoker:"سابق",
        label_pack_years:"Pack‑Years (إن وُجد)", ph_pack_years:"مثال: 15",
        label_weight:"الوزن (كجم)", ph_weight:"مثال: 78", label_height:"الطول (سم)", ph_height:"مثال: 172",
        label_temp:"درجة الحرارة (°م)", ph_temp:"مثال: 37.4",
        label_has_cough:"هل يوجد سُعال؟", label_cough_weeks:"مدة السعال (أسابيع)", ph_cough_weeks:"مثال: 12",
        label_cough_type:"نوع السعال", opt_dry:"جاف", opt_productive:"ببلغم", opt_hemoptysis:"بدم",
        section2_title:"2) خطّ الحياة والأعراض",
        label_free_text:"وصف الحالة (نص حر)", ph_free_text:"مثال: سعال مزمن 12 أسبوعًا...",
        label_initial_dx:"التشخيصات المبدئية", ph_initial_dx:"مثال: T2DM, HTN, COPD? Dermatitis",
        label_labs_imaging:"تحاليل/أشعة مذكورة", ph_labs_imaging:"مثال: HbA1c 8.7%, eGFR 38→62, K 5.6 ...",
        label_orders:"الأدوية/الإجراءات المقرّرة", ph_orders:"مثال: Xigduo XR bid, Metformin 1000 tid ...",
        section3_title:"3) رفع ملفات (صور/PDF) — اختياري", uploader_text:"اسحب الملفات هنا أو اضغط الزر لاختيارها", btn_browse:"اختيار ملفات",
        btn_analyze:"تحليل الحالة", btn_export_server:"تصدير PDF (الخادم)", btn_export_client:"تصدير PDF (العميل)",
        busy_text:"جاري التحليل…", show_json:"إظهار JSON (للبحث/الإحصاءات)"
      },
      en: {
        app_title:"Medical Case & Insurance Assessment", home_page:"Home Page", lang_button:"العربية", btn_new_case:"New Case",
        main_title:"Medical Case & Insurance Assessment", subtitle:"Clinical entry — deep analysis + clinical advice + insurance table",
        banner_text:"Each case is isolated on the server to avoid any mixing of results.",
        section1_title:"1) Patient Information", label_name:"Name (Optional)", ph_name:"e.g., John Doe",
        label_gender:"Gender", opt_select:"Select", opt_male:"Male", opt_female:"Female",
        label_age:"Age (years)", ph_age:"e.g., 63", label_pregnant:"Is the patient pregnant?",
        opt_no:"No", opt_yes:"Yes", opt_na:"N/A",
        label_pregnancy_months:"Month of pregnancy (if any)", ph_preg_month:"e.g., 5",
        label_smoking:"Smoker status", opt_smoker:"Smoker", opt_nonsmoker:"Non‑smoker", opt_exsmoker:"Ex‑smoker",
        label_pack_years:"Pack‑Years (if any)", ph_pack_years:"e.g., 15",
        label_weight:"Weight (kg)", ph_weight:"e.g., 78", label_height:"Height (cm)", ph_height:"e.g., 172",
        label_temp:"Temperature (°C)", ph_temp:"e.g., 37.4",
        label_has_cough:"Cough present?", label_cough_weeks:"Cough duration (weeks)", ph_cough_weeks:"e.g., 12",
        label_cough_type:"Cough type", opt_dry:"Dry", opt_productive:"Productive", opt_hemoptysis:"Hemoptysis",
        section2_title:"2) Timeline & Symptoms",
        label_free_text:"Case description (free text)", ph_free_text:"e.g., Chronic cough for 12 weeks...",
        label_initial_dx:"Initial diagnoses", ph_initial_dx:"e.g., T2DM, HTN, COPD? Dermatitis",
        label_labs_imaging:"Mentioned labs/imaging", ph_labs_imaging:"e.g., HbA1c 8.7%, eGFR 38→62, K 5.6 ...",
        label_orders:"Prescribed meds/procedures", ph_orders:"e.g., Xigduo XR bid, Metformin 1000 tid ...",
        section3_title:"3) Upload files (Images/PDF) — optional", uploader_text:"Drag files here or click the button to choose", btn_browse:"Choose files",
        btn_analyze:"Analyze Case", btn_export_server:"Export PDF (server)", btn_export_client:"Export PDF (client)",
        busy_text:"Analyzing…", show_json:"Show JSON (for analytics)"
      }
    };

    let currentLang = 'ar';
    function applyLang(lang){
      currentLang = lang;
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      // نصوص داخلية:
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang][key]) el.innerHTML = i18n[lang][key];
      });
      // Placeholders:
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (i18n[lang][key]) el.placeholder = i18n[lang][key];
      });
      // تحديث عنوان الصفحة:
      document.title = i18n[lang].app_title;

      // ملاحظة: التقرير السابق كان بلغة مختلفة — سنخفيه لتجنّب اللبس:
      document.getElementById('reportWrap').style.display = 'none';
      document.getElementById('reportHTML').innerHTML = '';
      document.getElementById('jsonOut').textContent = '';
    }
    document.getElementById('lang-switcher').addEventListener('click', () => applyLang(currentLang === 'ar' ? 'en' : 'ar'));
    applyLang('ar');

    /* ========== منطق الحقول التي تعتمد على الجنس (الحمل) ========== */
    const genderEl = document.getElementById('gender');
    const pregSel = document.getElementById('pregnant');
    const pregMonths = document.getElementById('pregnancyMonths');
    function syncPregnancyControls(){
      const g = genderEl.value;
      if (g !== 'أنثى' && currentLang === 'ar' || g !== 'Female' && currentLang === 'en') {
        pregSel.value = currentLang === 'ar' ? 'na' : 'na';
        pregSel.disabled = true; pregMonths.value=''; pregMonths.disabled = true;
      } else {
        pregSel.disabled = false; pregMonths.disabled = pregSel.value !== 'yes';
      }
    }
    genderEl.addEventListener('change', syncPregnancyControls);
    pregSel.addEventListener('change', () => { pregMonths.disabled = pregSel.value !== 'yes'; });
    syncPregnancyControls();

    /* ========== رافع الملفات (بلا label مضاعف) ========== */
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const browseBtn = document.getElementById('browseBtn');
    const cardsBox = document.getElementById('cards');
    const fileList = document.getElementById('fileList');
    const filesState = []; // { name, mimeType, data (base64) }

    browseBtn.addEventListener('click', () => fileInput.click());
    // سحب وإفلات داخل المنطقة فقط
    ['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.style.borderColor = '#0284c7'; }));
    ['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.style.borderColor = '#7dd3fc'; }));
    dropZone.addEventListener('drop', async (e) => { e.preventDefault(); await handleFiles(Array.from(e.dataTransfer.files)); });

    fileInput.addEventListener('change', async () => {
      await handleFiles(Array.from(fileInput.files));
      // إفراغ القيمة للسماح باختيار نفس الملف لاحقًا
      fileInput.value = '';
    });

    async function handleFiles(files){
      for (const f of files){
        const base64Url = await fileToDataURL(f);
        filesState.push({ name: f.name, mimeType: f.type || 'application/octet-stream', data: base64Url.split('base64,').pop() });
      }
      renderCards();
      fileList.textContent = filesState.map(f => '• ' + f.name).join('\n');
    }
    function renderCards(){
      cardsBox.innerHTML = '';
      filesState.forEach((f,i) => {
        const isImg = (f.mimeType || '').startsWith('image/');
        const thumbSrc = isImg
          ? `data:${f.mimeType};base64,${f.data}`
          : `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="140" viewBox="0 0 200 140"><rect width="100%" height="100%" fill="#e2e8f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="12" fill="#64748b">'+f.name+'</text></svg>')}`;
        const card = document.createElement('div');
        card.className = 'file-card';
        card.innerHTML = `
          <button class="remove-btn" data-i="${i}" title="${currentLang==='ar'?'إزالة':'Remove'}">×</button>
          <img class="file-thumb" src="${thumbSrc}" alt="${f.name}">
          <div style="padding:12px;font-size:13px;color:#475569"><div class="file-name" title="${f.name}">${f.name}</div></div>`;
        cardsBox.appendChild(card);
      });
      cardsBox.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const i = +e.currentTarget.dataset.i; filesState.splice(i,1); renderCards(); fileList.textContent = filesState.map(f => '• ' + f.name).join('\n');
      }));
    }
    function fileToDataURL(file){
      return new Promise((resolve,reject) => { const r=new FileReader(); r.onerror=()=>reject(new Error('failed to read file')); r.onload=()=>resolve(r.result); r.readAsDataURL(file); });
    }

    /* ========== بناء كائن معلومات المريض ========== */
    function buildPatientInfo(){
      const gender = document.getElementById('gender').value || null;
      const pVal = document.getElementById('pregnant').value;
      return {
        name: document.getElementById('name').value || null,
        ageYears: document.getElementById('age').value ? Number(document.getElementById('age').value) : null,
        gender,
        pregnant: { isPregnant: pVal === 'yes', gestationalWeeks: (pVal === 'yes' && document.getElementById('pregnancyMonths').value) ? Number(document.getElementById('pregnancyMonths').value) * 4 : null },
        smoking: (() => { const s=document.getElementById('smoking').value || null; const py=document.getElementById('packYears').value ? Number(document.getElementById('packYears').value) : null; return s ? { status: s, packYears: py } : null; })(),
        temperatureC: document.getElementById('temp').value ? Number(document.getElementById('temp').value) : null,
        weightKg: document.getElementById('weight').value ? Number(document.getElementById('weight').value) : null,
        heightCm: document.getElementById('height').value ? Number(document.getElementById('height').value) : null,
        cough: { has: document.getElementById('hasCough').value || null, weeks: document.getElementById('coughWeeks').value ? Number(document.getElementById('coughWeeks').value) : null, type: document.getElementById('coughType').value || null }
      };
    }

    function makeCaseId(){ return (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()); }

    /* ========== حالة جديدة ========== */
    const initialFields = ['name','gender','age','pregnant','pregnancyMonths','smoking','packYears','weight','height','temp','hasCough','coughWeeks','coughType','freeText','initialDx','labsImaging','orders'];
    function startNewCase(){
      initialFields.forEach(id => { const el=document.getElementById(id); if(!el) return; if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; });
      filesState.splice(0, filesState.length);
      cardsBox.innerHTML = ''; fileList.textContent = '';
      document.getElementById('reportWrap').style.display = 'none';
      document.getElementById('reportHTML').innerHTML = '';
      document.getElementById('jsonOut').textContent = '';
    }
    document.getElementById('newCaseBtn').addEventListener('click', startNewCase);

    /* ========== التحليل ========== */
    async function analyze(){
      const analyzeBtn = document.getElementById('analyzeBtn');
      const busy = document.getElementById('busy');
      analyzeBtn.disabled = true; busy.style.display = 'inline';
      try{
        const textParts = [];
        const ft = document.getElementById('freeText').value.trim(); if (ft) textParts.push((currentLang==='ar'?'وصف الحالة: ':'Case: ')+ft);
        const dx = document.getElementById('initialDx').value.trim(); if (dx) textParts.push((currentLang==='ar'?'التشخيصات المبدئية: ':'Initial dx: ')+dx);
        const labs = document.getElementById('labsImaging').value.trim(); if (labs) textParts.push((currentLang==='ar'?'تحاليل/أشعة: ':'Labs/Imaging: ')+labs);
        const orders = document.getElementById('orders').value.trim(); if (orders) textParts.push((currentLang==='ar'?'الأدوية/الإجراءات: ':'Orders: ')+orders);
        const mergedText = textParts.join('\n');

        const payload = { text: mergedText, patientInfo: buildPatientInfo(), files: filesState, lang: currentLang, caseId: makeCaseId() };
        const resp = await fetch('/api/gpt', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await resp.json().catch(()=> ({}));
        if(!resp.ok) throw new Error(data?.error || ('HTTP '+resp.status));

        document.getElementById('reportWrap').style.display = 'block';
        document.getElementById('reportHTML').innerHTML = data.html || '';
        document.getElementById('jsonOut').textContent = JSON.stringify(data.structured || {}, null, 2);
      }catch(err){
        alert((currentLang==='ar'?'خطأ: ':'Error: ') + (err.message || 'unknown'));
      }finally{
        analyzeBtn.disabled = false; busy.style.display = 'none';
      }
    }
    document.getElementById('analyzeBtn').addEventListener('click', analyze);

    /* ========== تصدير PDF (الخادم) ========== */
    document.getElementById('exportServerBtn').addEventListener('click', async () => {
      const reportElement = document.getElementById('reportHTML');
      if(!reportElement){ alert(currentLang==='ar'?'التقرير غير جاهز للتصدير.':'Report not ready.'); return; }
      try{
        const html = `<!DOCTYPE html><html lang="${currentLang}" dir="${currentLang==='ar'?'rtl':'ltr'}"><head><meta charset="UTF-8"><title>Medical Audit Report</title>
          <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
          <style>body{font-family:'Tajawal',sans-serif;padding:2cm;color:#212529}.audit-table{width:100%;border-collapse:collapse}.audit-table th,.audit-table td{border:1px solid #dee2e6;padding:10px}</style></head>
          <body>${reportElement.innerHTML}</body></html>`;
        const resp = await fetch('/api/pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ html, lang: currentLang }) });
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const blob = await resp.blob(); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='Medical_Audit_Report.pdf'; a.click(); URL.revokeObjectURL(url);
      }catch(e){ alert((currentLang==='ar'?'حدث خطأ في التصدير: ':'Export error: ') + e.message); }
    });

    /* ========== تصدير PDF (العميل) — معالجة مشكلة الصفحة البيضاء ========== */
    document.getElementById('exportPdfBtn').addEventListener('click', async () => {
      const el = document.getElementById('reportHTML'); if(!el || !el.innerHTML.trim()){ alert(currentLang==='ar'?'التقرير غير جاهز للتصدير.':'Report not ready.'); return; }
      try{
        // انتظر تحميل الخطوط قبل الرسم (يمنع صفحات بيضاء)
        if (document.fonts && document.fonts.ready) { await document.fonts.ready; } // MDN FontFaceSet.ready
        const opt = {
          filename:'Medical_Audit_Report.pdf',
          margin: 10,
          html2canvas: { scale: 2, useCORS: true, letterRendering: true },
          jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
        };
        await html2pdf().set(opt).from(el).save();
      }catch(e){
        alert((currentLang==='ar'?'خطأ في التصدير (عميل): ':'Client export error: ') + e.message);
      }
    });
  </script>
</body>
</html>
