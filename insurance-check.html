<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
  <style>
    :root{--bg:#0b1020;--card:#fff;--muted:#667085;--brand:#0ea5e9}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial,sans-serif;background:#f6f7fb;margin:0;color:#111}
    header{padding:18px 20px;background:linear-gradient(90deg,#0ea5e9,#2563eb);color:#fff}
    header h1{margin:0;font-size:20px}
    main{max-width:1050px;margin:22px auto;padding:0 14px 60px}
    .card{background:var(--card);border:1px solid #e6e8f0;border-radius:14px;padding:16px 16px 18px;margin:16px 0;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:14px;color:#334155}
    input[type="file"],select,textarea,button,input[type="text"]{
      width:100%;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px;background:#fff;font-size:14px
    }
    select{width:auto;min-width:210px}
    textarea{min-height:110px;resize:vertical}
    button{background:#0ea5e9;border:none;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    small.muted{color:#667085}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px;margin-inline:4px}
    pre{background:#0b1020;color:#e2e8f0;border-radius:12px;padding:14px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .log{background:#0b1020;color:#bcd;min-height:70px;border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace}
    .ok{color:#059669}.warn{color:#b45309}.err{color:#dc2626}
    .pill{background:#eef2ff;color:#1d4ed8;border-radius:999px;padding:2px 8px;font-size:12px}
    .ref a{color:#0ea5e9;text-decoration:none}
  </style>
  <!-- PDF.js UMD (يمنع خطأ pdfjsLib is not defined) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    // تهيئة عامل PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
  </script>
</head>
<body>
<header>
  <h1>تحليل الحالات الطبية (Gemini & GPT‑4o)</h1>
  <div style="font-size:13px;opacity:.95">* المعالجة على الجهاز + الخادم؛ * التقرير تعليمي ويُراجع سريريًا قبل أي قرار؛ * إزالة PHI تلقائيًا.</div>
</header>

<main>
  <section class="card">
    <div class="row">
      <div style="flex:1">
        <label>اختر ملفات (صورة/‏PDF):</label>
        <input id="fileInput" type="file" multiple accept="image/*,.pdf" />
        <small class="muted">سيُحوَّل أي PDF إلى صور، ويُستخرج نصّه لرفع الدقة.</small>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>اللغة:</label>
        <select id="lang">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
      </div>
      <div><label>النموذج:</label>
        <select id="model">
          <option value="both" selected>Gemini + GPT‑4o</option>
          <option value="gpt">GPT‑4o فقط</option>
          <option value="gemini">Gemini فقط</option>
        </select>
      </div>
      <div style="min-width:260px;flex:1">
        <label>التخصص (اختياري):</label>
        <input id="specialty" type="text" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
      </div>
    </div>
    <div style="margin-top:8px">
      <label>وصف مختصر/سياق التأمين (اختياري):</label>
      <textarea id="context" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما"></textarea>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="analyzeBtn">تحليل الحالة</button>
      <span class="pill" id="prepInfo" style="display:none"></span>
    </div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">النتيجة المدمجة</h3>
    <div id="exec" class="card" style="background:#f8fafc;border:1px dashed #d0d5dd"></div>
    <pre id="merged" dir="ltr"></pre>
  </section>

  <div class="grid">
    <section class="card">
      <h3 style="margin-top:0">مخرجات GPT‑4o</h3>
      <pre id="gpt" dir="ltr"></pre>
    </section>
    <section class="card">
      <h3 style="margin-top:0">مخرجات Gemini</h3>
      <pre id="gemini" dir="ltr"></pre>
    </section>
  </div>

  <section class="card">
    <h3 style="margin-top:0">السجل</h3>
    <div id="log" class="log"></div>
  </section>
</main>

<script>
const logEl = document.getElementById('log');
const btn = document.getElementById('analyzeBtn');
const prepInfo = document.getElementById('prepInfo');
const preMerged = document.getElementById('merged');
const preGPT = document.getElementById('gpt');
const preGemini = document.getElementById('gemini');
const execDiv = document.getElementById('exec');

function log(msg, cls=""){ 
  const span = document.createElement('div'); 
  span.className = cls; 
  span.textContent = msg; 
  logEl.appendChild(span); 
  logEl.scrollTop = logEl.scrollHeight;
}

function b64FromCanvas(canvas, mime="image/jpeg", quality=0.78, maxW=1400){
  // تصغير مع الحفاظ على التناسب
  const scale = Math.min(1, maxW / canvas.width);
  const tmp = document.createElement('canvas');
  tmp.width = Math.max(1, Math.round(canvas.width * scale));
  tmp.height = Math.max(1, Math.round(canvas.height * scale));
  const ctx = tmp.getContext('2d');
  ctx.drawImage(canvas, 0, 0, tmp.width, tmp.height);
  return tmp.toDataURL(mime, quality).split(',')[1]; // بدون data:...;base64,
}

async function imageFileToB64(file){
  const img = new Image();
  const url = URL.createObjectURL(file);
  await new Promise((res, rej)=>{
    img.onload = ()=>res();
    img.onerror = rej;
    img.src = url;
  });
  const canvas = document.createElement('canvas');
  canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
  canvas.getContext('2d').drawImage(img,0,0);
  URL.revokeObjectURL(url);
  return b64FromCanvas(canvas, file.type.includes('png')?'image/png':'image/jpeg', 0.78, 1600);
}

async function pdfToImagesAndText(file){
  const arr = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arr}).promise;
  const images = [];
  let fullText = '';
  for(let p=1;p<=pdf.numPages;p++){
    log(`> تحويل صفحة ${p}/${pdf.numPages} من ${file.name} ...`,`ok`);
    const page = await pdf.getPage(p);
    // صورة
    const viewport = page.getViewport({scale:1.8});
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = viewport.width; canvas.height = viewport.height;
    await page.render({canvasContext:ctx, viewport}).promise;
    images.push(b64FromCanvas(canvas, "image/jpeg", 0.76, 1600));
    // نص
    const tc = await page.getTextContent();
    const pageText = tc.items.map(i=>i.str).join(' ').replace(/\s+/g,' ').trim();
    fullText += `\n[PAGE ${p}] ${pageText}`;
  }
  return {images, text: fullText.trim()};
}

function sanitize(str, max=22000){
  return (str||'').replace(/[\u2028\u2029]/g,' ').slice(0,max);
}

function renderExecutive(report){
  if(!report) { execDiv.textContent=''; return; }
  const lang = (document.getElementById('lang').value||'ar');
  const refs = (report.references||[]).map(r=>`<li class="ref"><a href="${r.link}" target="_blank" rel="noopener">${r.title||r.org||r.link}</a></li>`).join('');
  const kf = (report.key_findings||[]).map(k=>`<li>${k}</li>`).join('');
  const ddx = (report.differential_diagnoses||[]).slice(0,4).map(d=>`<li><b>${d.dx}</b> — ${d.why}</li>`).join('');
  const issues = (report.procedural_issues||[]).slice(0,3).map(i=>`<li><b>${i.issue}</b> — ${i.impact}</li>`).join('');
  const opp = (report.revenue_quality_opportunities||[]).slice(0,4).map(o=>`<li><b>${o.opportunity}</b> <span class="chip">${o.category}</span> — ${o.rationale}</li>`).join('');
  const next = (report.suggested_next_steps||[]).slice(0,4).map(s=>`<li><b>${s.action}</b> — ${s.justification}</li>`).join('');
  const contrad = (report.contradictions||[]).slice(0,3).map(c=>`<li><b>${c.item||'تناقض'}</b>: ${c.evidence} <em>↳ ${c.impact||''}</em></li>`).join('');
  execDiv.innerHTML = `
    <div><b>ملخص تنفيذي:</b><div>${report.executive_summary||report.patient_summary||''}</div></div>
    <hr>
    <div class="grid-3">
      <div><b>نتائج مفتاحية</b><ul>${kf||'<li>—</li>'}</ul></div>
      <div><b>تشاخيص تفاضلية</b><ul>${ddx||'<li>—</li>'}</ul></div>
      <div><b>تناقضات/أخطاء</b><ul>${contrad||'<li>—</li>'}</ul></div>
    </div>
    <div class="grid-3">
      <div><b>مشكلات إجرائية</b><ul>${issues||'<li>—</li>'}</ul></div>
      <div><b>فرص جودة/دخل</b><ul>${opp||'<li>—</li>'}</ul></div>
      <div><b>الخطوات القادمة</b><ul>${next||'<li>—</li>'}</ul></div>
    </div>
    <div><b>مراجع</b><ul>${refs||'<li>—</li>'}</ul></div>
    <div><small class="muted">${report.patient_safety_note||''}</small></div>
  `;
}

async function prepareFiles(files){
  const images = []; let textChunks = [];
  for(const f of files){
    if(f.type === 'application/pdf'){
      const {images:imgs,text} = await pdfToImagesAndText(f);
      images.push(...imgs);
      textChunks.push(`\n# PDF: ${f.name}\n${text}`);
    }else{
      log(`> تحويل صورة: ${f.name} ...`,'ok');
      images.push(await imageFileToB64(f));
    }
  }
  return { images, text: sanitize(textChunks.join('\n')) };
}

function download(name, obj){
  const url = URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}));
  const a = document.createElement('a');
  a.href = url; a.download = name; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),3000);
}

document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
  try{
    logEl.textContent=''; preMerged.textContent=''; preGPT.textContent=''; preGemini.textContent=''; execDiv.textContent='';
    const files = Array.from(document.getElementById('fileInput').files||[]);
    if(files.length===0){ alert('اختر ملفًا واحدًا على الأقل'); return; }
    btn.disabled = true; btn.textContent = '... جاري التحضير';
    log('بدء التحضير ...');
    const prep = await prepareFiles(files);
    prepInfo.style.display='inline-block';
    prepInfo.textContent = `تم تجهيز ${prep.images.length} صورة/صفحة + نص PDF للتحليل.`;
    log('بدء التحليل ...');
    btn.textContent = '... جاري التحليل';

    const payload = {
      lang: document.getElementById('lang').value || 'ar',
      modelChoice: document.getElementById('model').value || 'both',
      specialty: document.getElementById('specialty').value || '',
      context: document.getElementById('context').value || '',
      images: prep.images, // base64 بدون data:
      text: prep.text,
      fileNames: files.map(f=>f.name),
      apiVersion: 'v5.0.0'
    };

    const res = await fetch('/api/gpt', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const errTxt = await res.text();
      throw new Error(`(${res.status}) ${errTxt}`);
    }
    const data = await res.json();

    // عرض النتائج
    renderExecutive(data.merged);
    preMerged.textContent = JSON.stringify(data.merged, null, 2);
    preGPT.textContent = data.gpt?.raw || '';
    preGemini.textContent = data.gemini?.raw || '';
    log('اكتمل التحليل.','ok');

    // رابط تنزيل
    download('medical-case-report.json', data.merged);

  }catch(err){
    console.error(err);
    alert('خطأ: ' + (err.message||err.toString()));
    log(String(err),'err');
  }finally{
    btn.disabled=false; btn.textContent='تحليل الحالة';
  }
});
</script>
</body>
</html>
