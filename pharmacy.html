<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بوابة الصيدلية – تحليل وصفات وتقييم مريض</title>

  <!-- خطوط -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- html2canvas + jsPDF للتصدير -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- pdf.js لقراءة PDF وتحويله لصور -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --primary:#0b63c2;--primary-dark:#094f9c;--accent:#ffd54d;--bg:#f4f8ff;--card:#fff;
      --border:#e2e8f0;--muted:#66768a;--danger:#d63031;--ok:#10b981;--focus:rgba(11,99,194,.15);
      --shadow:0 12px 28px rgba(15,57,105,.08);--radius:16px
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 80% 0%,#e9f3ff,#f6fbff);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Amiri',serif;color:#243143}
    [lang="ar"] body,[lang="ar"] h1,[lang="ar"] h2,[lang="ar"] h3,[lang="ar"] label,[lang="ar"] input,[lang="ar"] select,[lang="ar"] textarea,[lang="ar"] button{font-family:'Amiri', serif}
    .container{max-width:1100px;margin:0 auto;padding:20px}

    .navbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--primary)}
    .lang-switcher{font-weight:700;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .home-link{background:#fff;color:#2b3a55;border:1px solid #ffe082;border-radius:12px;padding:.5rem .9rem;font-weight:800;display:inline-flex;align-items:center;gap:.4rem;box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .home-link::before{content:"⌂";}

    .hero{background:linear-gradient(145deg,#ffffff, #eef6ff);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;margin:10px 0 22px;position:relative;overflow:hidden}
    .hero::after{content:"";position:absolute;inset:auto -80px -90px auto;width:240px;height:240px;border-radius:50%;background:radial-gradient(closest-side, #ffd54d, transparent 70%);opacity:.45;}
    .hero h1{margin:0 0 8px;color:#0b63c2}
    .hero p{margin:0;color:var(--muted)}
    .cta{margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:none;border-radius:12px;padding:.8rem 1.2rem;font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.08);transition:transform .06s ease,filter .2s ease, background .25s ease}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg,#fff,#ffd54d);color:#2b3a55;border:1px solid #ffe082}
    .btn-primary:hover{filter:brightness(1.02)}
    .btn-outline{background:#fff;border:1px solid var(--border);color:#0b63c2}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .section-title{display:flex;align-items:center;gap:.5rem;border-bottom:2px solid var(--primary);color:var(--primary);font-weight:800;padding-bottom:6px;margin:18px 0 14px}
    .dot{width:9px;height:9px;background:#ffd54d;border-radius:50%}

    label{font-weight:700;display:block;margin:.7rem 0 .35rem}
    .hint{font-size:.92rem;color:var(--muted)}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--border);background:#fff;border-radius:12px;padding:.7rem .9rem;font-size:1rem;transition:border-color .2s, box-shadow .2s}
    input:focus,select:focus,textarea:focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 3px var(--focus)}
    textarea{min-height:110px;resize:vertical}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}

    .row{display:flex;gap:10px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f1f5ff;border:1px solid var(--border);font-weight:700;color:#0b63c2}

    .file-drop{border:2px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:#596;cursor:pointer;background:#fafcff;transition:border-color .2s, background .2s}
    .file-drop:hover{border-color:var(--primary);background:#f6fbff}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:12px}
    .thumb{position:relative;border:1px solid var(--border);border-radius:10px;background:#fcfdff;padding:6px}
    .thumb .name{font-size:.86rem;word-break:break-all;text-align:center;margin-top:6px}
    .thumb .x{position:absolute;inset:4px 4px auto auto;background:#d63031;color:#fff;border:0;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}

    .notification{margin-top:12px;padding:12px;border-radius:10px;display:none;font-weight:700;text-align:center}
    .notification.info{background:#e9f4ff;color:#114a86;border:1px solid #cfe6ff}
    .notification.err{background:#fde8ea;color:#7a1f27;border:1px solid #f5c6cb}

    #report{display:none;margin-top:16px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px 10px;text-align:right;vertical-align:top}
    th{background:#e9f3ff;color:#0b63c2}

    .footer-note{margin-top:18px;color:#8aa}
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div class="brand"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Rx Portal</div>
      <div style="display:flex;gap:8px;align-items:center">
        <a class="home-link" href="portal.html">الصفحة الرئيسية</a>
        <button id="langSwitcher" class="lang-switcher">English</button>
      </div>
    </div>

    <div class="hero">
      <h1 data-i18n="hero.title">منصة الصيدلية الذكية</h1>
      <p data-i18n="hero.subtitle">تجميع بيانات المريض، تحليل تفاعلات/جرعات، وPDF أنيق للطباعة.</p>
      <div class="cta">
        <button class="btn btn-primary" id="startBtn"><span data-i18n="hero.cta">بدء تحليل جديد</span> ▸</button>
        <button class="btn btn-outline" id="scrollToReport"><span data-i18n="hero.viewLast">عرض آخر تقرير</span></button>
      </div>
    </div>

    <div class="card" id="formCard">
      <div class="section-title"><span class="dot"></span><span data-i18n="sec.patient">١) بيانات المريض</span></div>
      <div class="grid">
        <div><label data-i18n="f.age">العمر</label><input id="age" type="number" placeholder="63"></div>
        <div>
          <label data-i18n="f.gender">الجنس</label>
          <select id="gender">
            <option value="">اختر</option>
            <option value="male">ذكر</option>
            <option value="female">أنثى</option>
          </select>
        </div>
        <div><label data-i18n="f.height">الطول (سم)</label><input id="height" type="number" placeholder="170"></div>
        <div><label data-i18n="f.weight">الوزن (كجم)</label><input id="weight" type="number" placeholder="72"></div>
      </div>

      <div class="grid" id="pregWrap" style="margin-top:8px;display:none">
        <div>
          <label data-i18n="f.pregnant">هل المريضة حامل؟</label>
          <select id="pregnancy">
            <option value="">اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>
        <div id="gestWrap" style="display:none">
          <label data-i18n="f.gestation">مدة الحمل (أسابيع)</label>
          <input id="gestation" type="number" min="1" max="42" placeholder="20">
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.organs">٢) تقييم وظائف الأعضاء</span></div>
      <div class="grid">
        <div><label data-i18n="f.egfr">eGFR</label><input id="egfr" type="number" step="0.1" placeholder="60"></div>
        <div><label data-i18n="f.crea">كرياتينين (mg/dL)</label><input id="creatinine" type="number" step="0.01" placeholder="1.1"></div>
        <div>
          <label data-i18n="f.liver">حالة الكبد</label>
          <select id="liver">
            <option value="normal">سليم</option>
            <option value="mild">قصور طفيف</option>
            <option value="moderate">قصور متوسط</option>
            <option value="severe">قصور حاد</option>
          </select>
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.allergy">٣) الحساسية</span></div>
      <div class="row" style="flex-wrap:wrap;gap:12px">
        <div style="min-width:260px;flex:1">
          <label data-i18n="f.foodAllergy">هل توجد حساسية طعام؟</label>
          <select id="foodAllergy">
            <option value="no">لا</option>
            <option value="yes">نعم</option>
          </select>
          <input id="foodAllergyTxt" style="margin-top:8px;display:none" placeholder="مثال: فستق، بيض…">
        </div>
        <button class="btn btn-outline" id="addAllergy"><span data-i18n="btn.addAllergy">+ إضافة حساسية أخرى</span></button>
      </div>
      <div id="allergyList" class="grid" style="margin-top:10px"></div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.symptoms">٤) معلومات سريرية إضافية</span></div>
      <label data-i18n="f.symptoms">الأعراض الإكلينيكية</label>
      <textarea id="symptoms" placeholder="مثال: دوخة، غثيان، ألم صدري…"></textarea>

      <div class="grid" style="margin-top:10px">
        <div>
          <label data-i18n="f.meds">قائمة الأدوية (سطر لكل دواء أو مفصولة بفواصل)</label>
          <textarea id="meds" placeholder="Amlodipine 10 mg
Duodart 0.5/0.4
Rosuvastatin 20 mg"></textarea>
        </div>
        <div>
          <label data-i18n="f.apap">إجمالي باراسيتامول يوميًا (mg) – اختياري</label>
          <input id="apap" type="number" step="1" placeholder="0">
        </div>
      </div>

      <!-- الرفع -->
      <div class="section-title" style="margin-top:18px"><span class="dot"></span>تحميل تقارير الأشعة</div>
      <div class="grid">
        <div>
          <div class="file-drop" onclick="document.getElementById('radInput').click()">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="radInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="radThumbs" class="thumbs"></div>
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span>تحميل نتائج المختبر</div>
      <div class="grid">
        <div>
          <div class="file-drop" onclick="document.getElementById('labInput').click()">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="labInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="labThumbs" class="thumbs"></div>
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span>ملفات أخرى (مثلاً صور روشتة/إيصالات)</div>
      <div class="grid">
        <div>
          <div class="file-drop" onclick="document.getElementById('otherInput').click()">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="otherInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="otherThumbs" class="thumbs"></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:16px">
        <button class="btn btn-primary" id="analyzeBtn"><span id="analyzeText">تحليل وفحص متقدم</span> ▸</button>
        <span class="hint">سيتم توليد تقرير شامل قابل للطباعة وPDF.</span>
      </div>
      <div id="note" class="notification info"></div>
    </div>

    <div id="report" class="card">
      <div id="reportContent"></div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
        <button class="btn btn-outline" id="downloadPDF">PDF</button>
        <button class="btn btn-outline" onclick="window.print()">طباعة</button>
      </div>
      <div class="footer-note">* لا يتم تخزين ملفاتك على الخادم؛ تستخدم فقط لتوليد التقرير.</div>
    </div>
  </div>

  <script>
    // ===== إعدادات عامة =====
    const API_ENDPOINT = '/api/pharmacy-rx';
    const { jsPDF } = window.jspdf;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // i18n بسيط
    const i18n = {
      ar:{hero:{title:'منصة الصيدلية الذكية',subtitle:'تجميع بيانات المريض، تحليل تفاعلات/جرعات، وPDF أنيق للطباعة.',cta:'بدء تحليل جديد',viewLast:'عرض آخر تقرير'},
          sec:{patient:'١) بيانات المريض',organs:'٢) تقييم وظائف الأعضاء',allergy:'٣) الحساسية',symptoms:'٤) معلومات سريرية إضافية'}},
      en:{hero:{title:'Smart Pharmacy Portal',subtitle:'Capture patient data, analyze interactions/doses, and export a polished PDF.',cta:'Start New Analysis',viewLast:'View Last Report'},
          sec:{patient:'1) Patient Information',organs:'2) Organ Function',allergy:
