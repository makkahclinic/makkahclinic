<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بوابة الصيدلية – تحليل وصفات وتقييم مريض</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root{
      --primary:#0b63c2;--primary-dark:#094f9c;--accent:#ffd54d;--bg:#f4f8ff;--card:#fff;
      --border:#e2e8f0;--muted:#66768a;--danger:#d63031;--ok:#10b981;--focus:rgba(11,99,194,.15);
      --shadow:0 12px 28px rgba(15,57,105,.08);--radius:16px
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 80% 0%,#e9f3ff,#f6fbff);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Amiri',serif;color:#243143}
    [lang="ar"] body,[lang="ar"] h1,[lang="ar"] h2,[lang="ar"] h3,[lang="ar"] label,[lang="ar"] input,[lang="ar"] select,[lang="ar"] textarea,[lang="ar"] button{font-family:'Amiri', serif}
    .container{max-width:1100px;margin:0 auto;padding:20px}

    .navbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--primary)}
    .lang-switcher{font-weight:700;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .home-btn{background:#fff;border:2px solid #ffd54d;color:#2b3a55;border-radius:12px;padding:.55rem .9rem;font-weight:800;cursor:pointer;text-decoration:none}
    .home-btn:hover{background:#fff9da}

    .hero{background:linear-gradient(145deg,#ffffff, #eef6ff);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;margin:10px 0 22px;position:relative;overflow:hidden}
    .hero::after{content:"";position:absolute;inset:auto -80px -90px auto;width:240px;height:240px;border-radius:50%;background:radial-gradient(closest-side, #ffd54d, transparent 70%);opacity:.45;}
    .hero h1{margin:0 0 8px;color:#0b63c2}
    .hero p{margin:0;color:var(--muted)}
    .cta{margin-top:16px;display:flex;gap:12px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:none;border-radius:12px;padding:.8rem 1.2rem;font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.08);transition:transform .06s ease,filter .2s ease, background .25s ease}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg,#fff,#ffd54d);color:#2b3a55;border:1px solid #ffe082}
    .btn-primary:hover{filter:brightness(1.02)}
    .btn-outline{background:#fff;border:1px solid var(--border);color:var(--primary)}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .section-title{display:flex;align-items:center;gap:.5rem;border-bottom:2px solid var(--primary);color:var(--primary);font-weight:800;padding-bottom:6px;margin:18px 0 14px}
    .dot{width:9px;height:9px;background:#ffd54d;border-radius:50%}

    label{font-weight:700;display:block;margin:.7rem 0 .35rem}
    .hint{font-size:.92rem;color:var(--muted)}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--border);background:#fff;border-radius:12px;padding:.7rem .9rem;font-size:1rem;transition:border-color .2s, box-shadow .2s}
    input:focus,select:focus,textarea:focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 3px var(--focus)}
    textarea{min-height:110px;resize:vertical}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .file-drop{border:2px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:var(--muted);cursor:pointer;transition:border-color .2s, background .2s}
    .file-drop:hover{border-color:var(--primary);background:#f6fbff}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:12px}
    .thumb{position:relative;border:1px solid var(--border);border-radius:10px;background:#fcfdff;padding:6px}
    .thumb .name{font-size:.86rem;word-break:break-all;text-align:center;margin-top:6px}
    .thumb .x{position:absolute;inset:4px 4px auto auto;background:#d63031;color:#fff;border:0;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}

    .notification{margin-top:12px;padding:12px;border-radius:10px;display:none;font-weight:700;text-align:center}
    .notification.info{background:#e9f4ff;color:#114a86;border:1px solid #cfe6ff}
    .notification.err{background:#fde8ea;color:#7a1f27;border:1px solid #f5c6cb}

    #report{display:none;margin-top:16px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px 10px;text-align:right}
    th{background:#e9f3ff;color:#0b63c2}

    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f1f5ff;border:1px solid var(--border);font-weight:700;color:#0b63c2}
    .footer-note{margin-top:18px;color:#8aa}
  </style>
</head>
<body>
  <div class="container">
    <!-- NAV -->
    <div class="navbar">
      <div class="brand">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Rx Portal
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <a href="portal.html" class="home-btn">⌂ الصفحة الرئيسية</a>
        <button id="langSwitcher" class="lang-switcher">English</button>
      </div>
    </div>

    <!-- HERO -->
    <div class="hero">
      <h1 data-i18n="hero.title">منصة الصيدلية الذكية</h1>
      <p data-i18n="hero.subtitle">تجميع بيانات المريض، تحليل تفاعلات/جرعات، وتصدير تقرير PDF احترافي.</p>
      <div class="cta">
        <button class="btn btn-primary" id="startBtn"><span data-i18n="hero.cta">بدء تحليل جديد</span> ▸</button>
        <button class="btn btn-outline" id="scrollToReport"><span data-i18n="hero.viewLast">عرض آخر تقرير</span></button>
      </div>
    </div>

    <!-- FORM -->
    <div class="card" id="formCard">
      <div class="section-title"><span class="dot"></span><span data-i18n="sec.patient">١) بيانات المريض</span></div>
      <div class="grid">
        <div><label data-i18n="f.age">العمر</label><input id="age" type="number" placeholder="63"></div>
        <div>
          <label data-i18n="f.gender">الجنس</label>
          <select id="gender">
            <option value="" data-i18n="opt.select">اختر</option>
            <option value="male" data-i18n="opt.male">ذكر</option>
            <option value="female" data-i18n="opt.female">أنثى</option>
          </select>
        </div>
        <div><label data-i18n="f.height">الطول (سم)</label><input id="height" type="number" placeholder="170"></div>
        <div><label data-i18n="f.weight">الوزن (كجم)</label><input id="weight" type="number" placeholder="72"></div>
      </div>

      <div class="grid" id="pregWrap" style="margin-top:8px;display:none">
        <div>
          <label data-i18n="f.pregnant">هل المريضة حامل؟</label>
          <select id="pregnancy">
            <option value="" data-i18n="opt.select">اختر</option>
            <option value="yes" data-i18n="opt.yes">نعم</option>
            <option value="no" data-i18n="opt.no">لا</option>
          </select>
        </div>
        <div id="gestWrap" style="display:none">
          <label data-i18n="f.gestation">مدة الحمل (أسابيع)</label>
          <input id="gestation" type="number" min="1" max="42" placeholder="20">
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.organs">٢) تقييم وظائف الأعضاء</span></div>
      <div class="grid">
        <div><label data-i18n="f.egfr">معدل الترشيح الكبيبي (eGFR)</label><input id="egfr" type="number" step="0.1" placeholder="60"></div>
        <div><label data-i18n="f.crea">مستوى الكرياتينين (mg/dL)</label><input id="creatinine" type="number" step="0.01" placeholder="1.1"></div>
        <div>
          <label data-i18n="f.liver">حالة الكبد</label>
          <select id="liver">
            <option value="normal" data-i18n="liver.normal">سليم</option>
            <option value="mild" data-i18n="liver.mild">قصور طفيف</option>
            <option value="moderate" data-i18n="liver.moderate">قصور متوسط</option>
            <option value="severe" data-i18n="liver.severe">قصور حاد</option>
          </select>
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.allergy">٣) الحساسية</span></div>
      <div class="row">
        <div style="min-width:260px;flex:1">
          <label data-i18n="f.foodAllergy">هل توجد حساسية طعام؟</label>
          <select id="foodAllergy">
            <option value="no" data-i18n="opt.no">لا</option>
            <option value="yes" data-i18n="opt.yes">نعم</option>
          </select>
          <input id="foodAllergyTxt" style="margin-top:8px;display:none" placeholder="مثال: فستق، بيض…">
        </div>
        <button class="btn btn-outline" id="addAllergy"><span data-i18n="btn.addAllergy">+ إضافة حساسية أخرى</span></button>
      </div>
      <div id="allergyList" class="grid" style="margin-top:10px"></div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.symptoms">٤) معلومات سريرية إضافية</span></div>
      <label data-i18n="f.symptoms">الأعراض الإكلينيكية</label>
      <textarea id="symptoms" placeholder="مثال: دوخة، غثيان، ألم صدري…"></textarea>

      <div class="grid" style="margin-top:10px">
        <div>
          <label data-i18n="f.meds">قائمة الأدوية (سطر لكل دواء أو مفصولة بفواصل)</label>
          <textarea id="meds" placeholder="Amlodipine 10&#10;Duodart 0.5/0.4&#10;Rosuvastatin 20 mg"></textarea>
        </div>
        <div>
          <label data-i18n="f.apap">إجمالي باراسيتامول يوميًا (mg) – اختياري</label>
          <input id="apap" type="number" step="1" placeholder="0">
        </div>
      </div>

      <!-- Uploads: Lab / Radiology -->
      <div class="grid" style="margin-top:12px">
        <div>
          <label data-i18n="f.uploadLab">تحميل نتائج المختبر</label>
          <div class="file-drop" onclick="document.getElementById('labInput').click()" data-i18n="f.dropHere">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="labInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="labThumbs" class="thumbs"></div>
        </div>
        <div>
          <label data-i18n="f.uploadRad">تحميل تقارير الأشعة</label>
          <div class="file-drop" onclick="document.getElementById('radInput').click()" data-i18n="f.dropHere">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="radInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="radThumbs" class="thumbs"></div>
        </div>
      </div>

      <!-- Other files -->
      <div class="grid" style="margin-top:12px">
        <div>
          <label>ملفات أخرى (مثلاً صور روشتة/مراسلات)</label>
          <div class="file-drop" onclick="document.getElementById('otherInput').click()">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="otherInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="otherThumbs" class="thumbs"></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:16px">
        <button class="btn btn-primary" id="analyzeBtn"><span data-i18n="btn.analyze">تحليل وتصدير</span> ▸</button>
        <span class="hint" data-i18n="hint.analyze">سيتم توليد تقرير شامل قابل للطباعة وPDF.</span>
      </div>
      <div id="note" class="notification info"></div>
    </div>

    <!-- REPORT -->
    <div id="report" class="card">
      <div id="reportContent"></div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
        <button class="btn btn-outline" id="downloadPDF">PDF</button>
        <button class="btn btn-outline" onclick="window.print()" data-i18n="btn.print">طباعة</button>
      </div>
      <div class="footer-note" data-i18n="hint.security">* لا يتم تخزين ملفاتك على الخادم؛ تستخدم فقط لتوليد التقرير محليًا.</div>
    </div>
  </div>

<script>
/* ======== IMPORTANT: ضع رابط Vercel هنا ======== */
const API_ENDPOINT = 'https://www.m2020m.org/api/pharmacy-rx';
/* =============================================== */

const { jsPDF } = window.jspdf;

/* I18N */
const i18n = {
  ar:{hero:{title:'منصة الصيدلية الذكية',subtitle:'تجميع بيانات المريض، تحليل تفاعلات/جرعات، وتصدير تقرير PDF احترافي.',cta:'بدء تحليل جديد',viewLast:'عرض آخر تقرير'},
      sec:{patient:'١) بيانات المريض',organs:'٢) تقييم وظائف الأعضاء',allergy:'٣) الحساسية',symptoms:'٤) معلومات سريرية إضافية'},
      f:{age:'العمر',gender:'الجنس',height:'الطول (سم)',weight:'الوزن (كجم)',pregnant:'هل المريضة حامل؟',gestation:'مدة الحمل (أسابيع)',egfr:'معدل الترشيح الكبيبي (eGFR)',crea:'مستوى الكرياتينين (mg/dL)',liver:'حالة الكبد',foodAllergy:'هل توجد حساسية طعام؟',symptoms:'الأعراض الإكلينيكية',meds:'قائمة الأدوية (سطر لكل دواء أو مفصولة بفواصل)',apap:'إجمالي باراسيتامول يوميًا (mg) – اختياري',uploadLab:'تحميل نتائج المختبر',uploadRad:'تحميل تقارير الأشعة',dropHere:'اضغط لرفع ملفات (صور/PDF)'},
      opt:{select:'اختر',male:'ذكر',female:'أنثى',yes:'نعم',no:'لا'},
      liver:{normal:'سليم',mild:'قصور طفيف',moderate:'قصور متوسط',severe:'قصور حاد'},
      btn:{addAllergy:'+ إضافة حساسية أخرى',analyze:'تحليل وتصدير',print:'طباعة'},
      hint:{analyze:'سيتم توليد تقرير شامل قابل للطباعة وPDF.',security:'* لا يتم تخزين ملفاتك على الخادم؛ تستخدم فقط لتوليد التقرير محليًا.'},
      report:{title:'ملخص تقييم المريض',patient:'بيانات المريض',allergies:'الحساسية',files:'المرفقات',analysis:'تحليل الأدوية'}},
  en:{hero:{title:'Smart Pharmacy Portal',subtitle:'Capture patient data, analyze interactions/doses, export a professional PDF.',cta:'Start New Analysis',viewLast:'View Last Report'},
      sec:{patient:'1) Patient Information',organs:'2) Organ Function',allergy:'3) Allergies',symptoms:'4) Additional Clinical Information'},
      f:{age:'Age',gender:'Gender',height:'Height (cm)',weight:'Weight (kg)',pregnant:'Is the patient pregnant?',gestation:'Gestation (weeks)',egfr:'eGFR',crea:'Creatinine (mg/dL)',liver:'Liver status',foodAllergy:'Any food allergies?',symptoms:'Clinical Symptoms',meds:'Medications list (one per line or comma-separated)',apap:'Total paracetamol per day (mg) – optional',uploadLab:'Upload Lab Results',uploadRad:'Upload Radiology Reports',dropHere:'Click to upload files (images/PDF)'},
      opt:{select:'Select',male:'Male',female:'Female',yes:'Yes',no:'No'},
      liver:{normal:'Normal',mild:'Mild impairment',moderate:'Moderate impairment',severe:'Severe impairment'},
      btn:{addAllergy:'+ Add Another Allergy',analyze:'Analyze & Export',print:'Print'},
      hint:{analyze:'A comprehensive, printable PDF will be generated.',security:'* Your files are not stored on the server; they are used locally to build the report.'},
      report:{title:'Patient Assessment Summary',patient:'Patient Details',allergies:'Allergies',files:'Attachments',analysis:'Rx Analysis'}}
};
let currentLang='ar';
function setLanguage(lang){
  currentLang=lang;
  document.documentElement.lang=lang;
  document.documentElement.dir=(lang==='ar'?'rtl':'ltr');
  document.getElementById('langSwitcher').textContent=(lang==='ar'?'English':'العربية');
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n'); el.textContent = key.split('.').reduce((o,k)=>o&&o[k], i18n[lang]);
  });
}
function t(en,ar){return currentLang==='ar'?ar:en}

/* UI refs */
const startBtn=document.getElementById('startBtn');
const scrollToReportBtn=document.getElementById('scrollToReport');
const genderEl=document.getElementById('gender');
const pregWrap=document.getElementById('pregWrap');
const pregnancyEl=document.getElementById('pregnancy');
const gestWrap=document.getElementById('gestWrap');
const foodAllergyEl=document.getElementById('foodAllergy');
const foodAllergyTxt=document.getElementById('foodAllergyTxt');
const allergyList=document.getElementById('allergyList');
const addAllergyBtn=document.getElementById('addAllergy');

let labFiles=[]; let radFiles=[]; let otherFiles=[];

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}

startBtn.addEventListener('click',()=>document.getElementById('formCard').scrollIntoView({behavior:'smooth'}));
scrollToReportBtn.addEventListener('click',()=>document.getElementById('report').scrollIntoView({behavior:'smooth'}));
document.getElementById('langSwitcher').addEventListener('click',()=>setLanguage(currentLang==='ar'?'en':'ar'));

genderEl.addEventListener('change',()=>{
  pregWrap.style.display = (genderEl.value==='female')?'':'none';
  if(genderEl.value!=='female'){ pregnancyEl && (pregnancyEl.value=''); gestWrap.style.display='none'; const g=document.getElementById('gestation'); if(g) g.value='';}
});
pregnancyEl?.addEventListener('change',()=>{
  gestWrap.style.display = (pregnancyEl.value==='yes')?'':'none';
  if(pregnancyEl.value!=='yes'){ const g=document.getElementById('gestation'); if(g) g.value='';}
});
foodAllergyEl.addEventListener('change',()=>{
  foodAllergyTxt.style.display=(foodAllergyEl.value==='yes')?'':'none';
  if(foodAllergyEl.value!=='yes') foodAllergyTxt.value='';
});
addAllergyBtn.addEventListener('click',()=>{
  const id=uid();
  const card=document.createElement('div');
  card.className='card'; card.style.padding='12px';
  card.innerHTML=`
    <div class="grid">
      <div>
        <label>${t('Allergy Type','نوع الحساسية')}</label>
        <select data-id="${id}" class="allType">
          <option value="drug">${t('Drug','دواء')}</option>
          <option value="chemical">${t('Chemical','مادة كيميائية')}</option>
          <option value="dust">${t('Dust','غبار')}</option>
          <option value="other">${t('Other','أخرى')}</option>
        </select>
      </div>
      <div>
        <label>${t('Details','التفاصيل')}</label>
        <input data-id="${id}" class="allDetail" placeholder="${t('e.g., Penicillin, Latex','مثال: بنسلين، لاتكس')}">
      </div>
    </div>
    <div class="row" style="margin-top:8px"><button class="btn btn-outline" data-remove="${id}">✕ ${t('Remove','حذف')}</button></div>`;
  allergyList.appendChild(card);
});
allergyList.addEventListener('click',(e)=>{const id=e.target.getAttribute('data-remove'); if(id){ e.target.closest('.card').remove(); }});

/* Files binding */
function bindFilePicker(inputId, gridId, store){
  const input=document.getElementById(inputId);
  const grid=document.getElementById(gridId);
  input.addEventListener('change',()=>{
    for(const file of input.files){
      const id=uid(); const reader=new FileReader();
      reader.onload=ev=>{
        store.push({id,name:file.name,preview:ev.target.result});
        const content=file.type.startsWith('image/')?`<img src="${ev.target.result}" style="width:100%;height:110px;object-fit:cover;border-radius:6px">`:`<div style="display:flex;align-items:center;justify-content:center;height:110px"><span class="pill">PDF</span></div>`;
        const div=document.createElement('div'); div.className='thumb';
        div.innerHTML=`<button class="x" data-x="${id}">×</button>${content}<div class="name">${file.name}</div>`;
        grid.appendChild(div);
      };
      reader.readAsDataURL(file);
    }
    input.value='';
  });
  grid.addEventListener('click',(e)=>{
    const id=e.target.getAttribute('data-x'); if(!id) return;
    const idx=store.findIndex(x=>x.id===id); if(idx>-1) store.splice(idx,1);
    e.target.closest('.thumb').remove();
  });
}
bindFilePicker('labInput','labThumbs',labFiles);
bindFilePicker('radInput','radThumbs',radFiles);
bindFilePicker('otherInput','otherThumbs',otherFiles);

/* Helpers */
const note=document.getElementById('note');
const out=document.getElementById('reportContent');
function showNote(type,text){ note.className='notification '+(type==='err'?'err':'info'); note.textContent=text; note.style.display='block';}
function clearNote(){ note.style.display='none'; note.textContent=''; }
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

function gatherPayload(){
  const age=parseInt(document.getElementById('age').value,10);
  const height=parseFloat(document.getElementById('height').value);
  const weight=parseFloat(document.getElementById('weight').value);
  const gender=document.getElementById('gender').value||undefined;
  const egfr=parseFloat(document.getElementById('egfr').value);
  const creatinine=parseFloat(document.getElementById('creatinine').value);
  const liver=document.getElementById('liver').value;
  const preg=document.getElementById('pregnancy')?.value;
  const gest=parseInt(document.getElementById('gestation')?.value,10);
  const symptoms=document.getElementById('symptoms').value||'';
  const apap=parseInt(document.getElementById('apap').value,10);
  const medsLines=(document.getElementById('meds').value||'').split(/\n|,/).map(s=>s.trim()).filter(Boolean);
  const ocrList=medsLines.map(x=>({name:x,dose:''}));

  const extra=[];
  document.querySelectorAll('.allType').forEach(el=>{
    const id=el.getAttribute('data-id');
    const detail=document.querySelector(`.allDetail[data-id="${id}"]`)?.value||'';
    if(el.value||detail){ extra.push({type:el.value, detail}); }
  });
  if(document.getElementById('foodAllergy').value==='yes' && document.getElementById('foodAllergyTxt').value.trim()){
    extra.push({type:'food', detail:document.getElementById('foodAllergyTxt').value.trim()});
  }

  return {
    patient:{
      age:Number.isFinite(age)?age:undefined,
      sex:(gender==='male'?'M':(gender==='female'?'F':undefined)),
      height:Number.isFinite(height)?height:undefined,
      weight:Number.isFinite(weight)?weight:undefined,
      pregnancy:(preg==='yes')?{pregnant:true,weeks:Number.isFinite(gest)?gest:undefined}:(preg==='no'?{pregnant:false}:undefined),
      eGFR:Number.isFinite(egfr)?egfr:undefined,
      creatinine:Number.isFinite(creatinine)?creatinine:undefined,
      liver, symptoms, allergies:extra,
      apapDailyMg:Number.isFinite(apap)?apap:undefined
    },
    ocrList,
    files:{
      labs: labFiles.map(x=>({name:x.name})),
      radiology: radFiles.map(x=>({name:x.name})),
      others: otherFiles.map(x=>({name:x.name}))
    }
  };
}

/* Render report */
function renderReport(data,payload){
  const L=i18n[currentLang]; const p=payload.patient||{};
  const items=data?.items||[]; const findings=data?.findings||[]; const refs=data?.references||{};
  const badge=(lvl)=>{const m=String(lvl||'').toLowerCase();
    const cls=m==='high'?'background:#fde8ea;color:#7a1f27':(m==='review'?'background:#fff3cd;color:#856404':'background:#e9f4ff;color:#114a86');
    return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;${cls};font-weight:800">${String(lvl||'').toUpperCase()}</span>`;};
  const findHtml=findings.length?findings.map(f=>{
    const links=(f.refs||[]).map(k=>refs[k]?`<a href="${refs[k].url}" target="_blank" rel="noopener">${refs[k].title}</a>`:'').filter(Boolean).join(' • ');
    return `<div style="border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0">
      ${badge(f.level)}<div style="margin-top:6px"><b>${escapeHtml(f.summary||'')}</b></div>
      <div style="color:#66768a;margin-top:4px">${escapeHtml(f.detail||'')}</div>${links?`<div style="margin-top:6px">${links}</div>`:''}</div>`;
  }).join(''):`<div class="hint">${t('No critical findings.','لا توجد ملاحظات حرجة.')}</div>`;
  const rows=items.map(x=>`<tr><td>${escapeHtml(x.original||'')}</td><td>${escapeHtml(x.mapped||'')}</td><td>${escapeHtml(x.class||'')}</td><td>${escapeHtml(x.indications||'')}</td><td>${escapeHtml(x.doseText||'')}</td><td>${escapeHtml(x.status||'')}</td></tr>`).join('');
  const labs=(payload.files?.labs||[]).map(f=>`<span class="pill">${escapeHtml(f.name)}</span>`).join(' ');
  const rads=(payload.files?.radiology||[]).map(f=>`<span class="pill">${escapeHtml(f.name)}</span>`).join(' ');
  const others=(payload.files?.others||[]).map(f=>`<span class="pill">${escapeHtml(f.name)}</span>`).join(' ');
  const bmi=(p.height&&p.weight)?(p.weight/Math.pow(p.height/100,2)):null;

  return `
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:800;color:#0b63c2">${L.report.title}</div>
      <div class="pill">${new Date().toLocaleString()}</div>
    </div>

    <h3 style="margin:12px 0 6px;color:#0b63c2">${L.report.patient}</h3>
    <div class="grid">
      <div><b>${t('Age','العمر')}:</b> ${p.age??'-'}</div>
      <div><b>${t('Gender','الجنس')}:</b> ${p.sex||'-'}</div>
      <div><b>${t('Height','الطول')}:</b> ${p.height??'-'} cm</div>
      <div><b>${t('Weight','الوزن')}:</b> ${p.weight??'-'} kg</div>
      <div><b>eGFR:</b> ${p.eGFR??'-'}</div>
      <div><b>${t('Creatinine','كرياتينين')}:</b> ${p.creatinine??'-'}</div>
      <div><b>${t('Liver','الكبد')}:</b> ${p.liver||'-'}</div>
      <div><b>${t('BMI','مؤشر كتلة الجسم')}:</b> ${bmi?bmi.toFixed(1):'-'}</div>
      ${p.pregnancy?`<div><b>${t('Pregnancy','الحمل')}:</b> ${p.pregnancy.pregnant?t('Yes','نعم'):t('No','لا')} ${p.pregnancy.weeks? '('+p.pregnancy.weeks+' '+t('weeks','أسابيع')+')':''}</div>`:''}
    </div>

    <h3 style="margin:12px 0 6px;color:#0b63c2">${L.report.allergies}</h3>
    <div>${(p.allergies||[]).map(a=>`<span class="pill">${escapeHtml(a.type)} — ${escapeHtml(a.detail)}</span>`).join(' ') || '<span class="hint">'+t('None reported','لا يوجد')+'</span>'}</div>

    <h3 style="margin:12px 0 6px;color:#0b63c2">${t('Clinical Symptoms','الأعراض السريرية')}</h3>
    <div style="white-space:pre-wrap;border:1px solid var(--border);border-radius:10px;padding:8px">${escapeHtml(p.symptoms||'')}</div>

    <h3 style="margin:12px 0 6px;color:#0b63c2">${L.report.files}</h3>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div><b>${t('Labs','مختبر')}:</b> ${labs||'-'}</div>
      <div><b>${t('Radiology','أشعة')}:</b> ${rads||'-'}</div>
      <div><b>${t('Other files','ملفات أخرى')}:</b> ${others||'-'}</div>
    </div>

    <h3 style="margin:12px 0 6px;color:#0b63c2">${L.report.analysis}</h3>
    <table><thead><tr>
      <th>${t('Original name','الاسم الأصلي')}</th>
      <th>${t('Mapped/Ingredient','الاسم/التركيب')}</th>
      <th>${t('Class','الفئة')}</th>
      <th>${t('Indications','الدواعي')}</th>
      <th>${t('Dose/Notes','الجرعة/الوصف')}</th>
      <th>${t('Status','الحالة')}</th>
    </tr></thead><tbody>${rows}</tbody></table>

    <h4 style="margin:12px 0 6px">${t('Findings','الملاحظات')}</h4>
    ${findHtml}
  `;
}

/* Analyze & PDF */
async function doAnalyze(){
  const payload=gatherPayload();
  if(!payload.ocrList.length && !payload.patient.symptoms){
    showNote('err',t('Please provide medications or symptoms at least.','الرجاء إدخال أدوية أو أعراض على الأقل.'));
    return;
  }
  showNote('info',t('Analyzing…','جاري التحليل…'));
  try{
    const res=await fetch(API_ENDPOINT,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ocrList:payload.ocrList, patient:payload.patient})
    });
    const text=await res.text();
    let data; try{ data=JSON.parse(text);}catch{ throw new Error(`الخادم لم يُرجع JSON صحيح (status ${res.status}). تحقق من رابط API.`); }
    if(!res.ok){ throw new Error(data?.message || `HTTP ${res.status}`); }
    clearNote();
    const html=renderReport(data,payload);
    document.getElementById('report').style.display='block';
    out.innerHTML=html;
    document.getElementById('report').scrollIntoView({behavior:'smooth'});
    window.__lastReportLang=currentLang;
  }catch(e){ console.error(e); showNote('err', t('Request failed: ','فشل الطلب: ')+e.message); }
}
async function downloadPDF(){
  const el=document.getElementById('report'); if(!el || el.style.display==='none'){ showNote('err', t('No report to export.','لا يوجد تقرير للتصدير.')); return; }
  showNote('info', t('Generating PDF…','جاري توليد PDF…'));
  const doc=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
  try{
    const canvas=await html2canvas(document.getElementById('reportContent'),{ scale:2, useCORS:true, onclone:(doc2)=>{ doc2.documentElement.dir=(window.__lastReportLang==='ar'?'rtl':'ltr'); }});
    const img=canvas.toDataURL('image/png'); const w=doc.internal.pageSize.getWidth()-20; const h=(canvas.height*w)/canvas.width;
    let y=10,left=h; doc.addImage(img,'PNG',10,y,w,h); left-=doc.internal.pageSize.getHeight();
    while(left>=0){ y=left - h + 10; doc.addPage(); doc.addImage(img,'PNG',10,y,w,h); left-=doc.internal.pageSize.getHeight(); }
    doc.save('Patient-Assessment.pdf'); clearNote();
  }catch(err){ console.error(err); showNote('err', t('PDF failed.','فشل إنشاء PDF.')); }
}
document.getElementById('analyzeBtn').addEventListener('click',doAnalyze);
document.getElementById('downloadPDF').addEventListener('click',downloadPDF);

/* Init */
setLanguage('ar');
</script>
</body>
</html>
