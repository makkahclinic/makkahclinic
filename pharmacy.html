<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بوابة الصيدلية – تحليل وصفات وتقييم مريض</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --primary:#0b63c2;--primary-dark:#094f9c;--accent:#ffd54d;--bg:#f4f8ff;--card:#fff;
      --border:#e2e8f0;--muted:#66768a;--danger:#d63031;--ok:#10b981;--focus:rgba(11,99,194,.15);
      --shadow:0 12px 28px rgba(15,57,105,.08);--radius:16px
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 80% 0%,#e9f3ff,#f6fbff);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Amiri',serif;color:#243143}
    [lang="ar"] body,[lang="ar"] h1,[lang="ar"] h2,[lang="ar"] h3,[lang="ar"] label,[lang="ar"] input,[lang="ar"] select,[lang="ar"] textarea,[lang="ar"] button{font-family:'Amiri', serif}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .navbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--primary)}
    .lang-switcher{font-weight:700;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .home-link{background:#fff;color:#2b3a55;border:1px solid #ffe082;border-radius:12px;padding:.5rem .9rem;font-weight:800;display:inline-flex;align-items:center;gap:.4rem;box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .home-link::before{content:"⌂";}
    .hero{background:linear-gradient(145deg,#ffffff, #eef6ff);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;margin:10px 0 22px;position:relative;overflow:hidden}
    .hero::after{content:"";position:absolute;inset:auto -80px -90px auto;width:240px;height:240px;border-radius:50%;background:radial-gradient(closest-side, #ffd54d, transparent 70%);opacity:.45;}
    .hero h1{margin:0 0 8px;color:#0b63c2}
    .hero p{margin:0;color:var(--muted)}
    .cta{margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:none;border-radius:12px;padding:.8rem 1.2rem;font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.08);transition:transform .06s ease,filter .2s ease, background .25s ease}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{cursor:not-allowed;filter:grayscale(0.8);opacity:0.7}
    .btn-primary{background:linear-gradient(90deg,#fff,#ffd54d);color:#2b3a55;border:1px solid #ffe082}
    .btn-primary:hover:not(:disabled){filter:brightness(1.02)}
    .btn-outline{background:#fff;border:1px solid var(--border);color:#0b63c2}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .section-title{display:flex;align-items:center;gap:.5rem;border-bottom:2px solid var(--primary);color:var(--primary);font-weight:800;padding-bottom:6px;margin:18px 0 14px}
    .dot{width:9px;height:9px;background:#ffd54d;border-radius:50%}
    label{font-weight:700;display:block;margin:.7rem 0 .35rem}
    .hint{font-size:.92rem;color:var(--muted)}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--border);background:#fff;border-radius:12px;padding:.7rem .9rem;font-size:1rem;transition:border-color .2s, box-shadow .2s}
    input:focus,select:focus,textarea:focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 3px var(--focus)}
    textarea{min-height:110px;resize:vertical}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}
    .row{display:flex;gap:10px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f1f5ff;border:1px solid var(--border);font-weight:700;color:#0b63c2}
    .file-drop{border:2px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:#596;cursor:pointer;background:#fafcff;transition:border-color .2s, background .2s}
    .file-drop:hover{border-color:var(--primary);background:#f6fbff}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:12px}
    .thumb{position:relative;border:1px solid var(--border);border-radius:10px;background:#fcfdff;padding:6px}
    .thumb .name{font-size:.86rem;word-break:break-all;text-align:center;margin-top:6px}
    .thumb .x{position:absolute;inset:4px 4px auto auto;background:#d63031;color:#fff;border:0;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}
    .notification{margin-top:12px;padding:12px;border-radius:10px;display:none;font-weight:700;text-align:center}
    .notification.info{background:#e9f4ff;color:#114a86;border:1px solid #cfe6ff}
    .notification.err{background:#fde8ea;color:#7a1f27;border:1px solid #f5c6cb}
    #report{display:none;margin-top:16px}
    .footer-note{margin-top:18px;color:#8aa}
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div class="brand"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Rx Portal</div>
      <div style="display:flex;gap:8px;align-items:center">
        <a class="home-link" href="#">الصفحة الرئيسية</a>
        <button id="langSwitcher" class="lang-switcher">English</button>
      </div>
    </div>

    <div class="hero">
      <h1 data-i18n="hero.title">منصة الصيدلية الذكية</h1>
      <p data-i18n="hero.subtitle">تجميع بيانات المريض، تحليل تفاعلات/جرعات، وPDF أنيق للطباعة.</p>
      <div class="cta">
        <button class="btn btn-primary" id="startBtn"><span data-i18n="hero.cta">بدء تحليل جديد</span> ▸</button>
        <button class="btn btn-outline" id="scrollToReportBtn"><span data-i18n="hero.viewLast">عرض آخر تقرير</span></button>
      </div>
    </div>

    <div class="card" id="formCard">
        <div class="section-title"><span class="dot"></span><span data-i18n="sec.patient">١) بيانات المريض</span></div>
        <div class="grid">
            <div><label data-i18n="f.age">العمر</label><input id="age" type="number" placeholder="63"></div>
            <div>
                <label data-i18n="f.gender">الجنس</label>
                <select id="gender">
                    <option value="" data-i18n="opt.select">اختر</option>
                    <option value="male" data-i18n="opt.male">ذكر</option>
                    <option value="female" data-i18n="opt.female">أنثى</option>
                </select>
            </div>
            <div><label data-i18n="f.height">الطول (سم)</label><input id="height" type="number" placeholder="170"></div>
            <div><label data-i18n="f.weight">الوزن (كجم)</label><input id="weight" type="number" placeholder="72"></div>
        </div>

        <div class="grid" id="pregWrap" style="margin-top:8px;display:none">
            <div>
                <label data-i18n="f.pregnant">هل المريضة حامل؟</label>
                <select id="pregnancy">
                    <option value="" data-i18n="opt.select">اختر</option>
                    <option value="yes" data-i18n="opt.yes">نعم</option>
                    <option value="no" data-i18n="opt.no">لا</option>
                </select>
            </div>
            <div id="gestWrap" style="display:none">
                <label data-i18n="f.gestation">مدة الحمل (أسابيع)</label>
                <input id="gestation" type="number" min="1" max="42" placeholder="20">
            </div>
        </div>

        <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.organs">٢) تقييم وظائف الأعضاء</span></div>
        <div class="grid">
            <div><label data-i18n="f.egfr">معدل الترشيح الكبيبي (eGFR)</label><input id="egfr" type="number" step="0.1" placeholder="60"></div>
            <div><label data-i18n="f.crea">مستوى الكرياتينين (mg/dL)</label><input id="creatinine" type="number" step="0.01" placeholder="1.1"></div>
            <div>
                <label data-i18n="f.liver">حالة الكبد</label>
                <select id="liver">
                    <option value="normal" data-i18n="liver.normal">سليم</option>
                    <option value="mild" data-i18n="liver.mild">قصور طفيف</option>
                    <option value="moderate" data-i18n="liver.moderate">قصور متوسط</option>
                    <option value="severe" data-i18n="liver.severe">قصور حاد</option>
                </select>
            </div>
        </div>

        <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.meds">٣) الأدوية والملفات</span></div>
        <div class="grid">
            <div>
                <label data-i18n="f.meds">قائمة الأدوية (اكتبها هنا)</label>
                <textarea id="meds" placeholder="Amlodipine 10mg&#10;Rosuvastatin 20 mg"></textarea>
            </div>
            <div>
                <label data-i18n="f.files">أو ارفع ملفات (روشتة، تقارير)</label>
                <div class="file-drop" onclick="document.getElementById('fileInput').click()">اضغط لرفع صور أو PDF</div>
                <input id="fileInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
                <div id="fileThumbs" class="thumbs"></div>
            </div>
        </div>
        
        <div style="display:flex;gap:10px;align-items:center;margin-top:24px">
            <button class="btn btn-primary" id="analyzeBtn"><span id="analyzeText" data-i18n="btn.analyze">تحليل وفحص متقدم</span> ▸</button>
            <span class="hint" data-i18n="hint.main">سيتم توليد تقرير شامل قابل للطباعة وPDF.</span>
        </div>
        <div id="note" class="notification info"></div>
    </div>

    <div id="report" class="card">
      <div id="reportContent"></div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap;">
        <button class="btn btn-outline" id="downloadPDF">تصدير PDF</button>
        <button class="btn btn-outline" onclick="window.print()">طباعة</button>
      </div>
      <div class="footer-note">* لا يتم تخزين ملفاتك على الخادم؛ تُستخدم فقط لتوليد التقرير ثم تُحذف.</div>
    </div>
  </div>

<script>
const API_ENDPOINT = '/api/pharmacy-rx'; // <-- عدّل هذا الرابط إذا كانت الواجهة الخلفية على خادم آخر
const { jsPDF } = window.jspdf;
pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;

/* I18N - نظام الترجمة */
const i18n = {
    ar: {
        hero: { title: 'منصة الصيدلية الذكية', subtitle: 'تجميع بيانات المريض، تحليل تفاعلات/جرعات، وPDF أنيق للطباعة.', cta: 'بدء تحليل جديد', viewLast: 'عرض آخر تقرير' },
        sec: { patient: '١) بيانات المريض', organs: '٢) تقييم وظائف الأعضاء', meds: '٣) الأدوية والملفات' },
        f: { age: 'العمر', gender: 'الجنس', height: 'الطول (سم)', weight: 'الوزن (كجم)', pregnant: 'هل المريضة حامل؟', gestation: 'مدة الحمل (أسابيع)', egfr: 'معدل الترشيح الكبيبي (eGFR)', crea: 'مستوى الكرياتينين (mg/dL)', liver: 'حالة الكبد', meds: 'قائمة الأدوية (اكتبها هنا)', files: 'أو ارفع ملفات (روشتة، تقارير)' },
        opt: { select: 'اختر', male: 'ذكر', female: 'أنثى', yes: 'نعم', no: 'لا' },
        liver: { normal: 'سليم', mild: 'قصور طفيف', moderate: 'قصور متوسط', severe: 'قصور حاد' },
        btn: { analyze: 'تحليل وفحص متقدم' },
        hint: { main: 'سيتم توليد تقرير شامل قابل للطباعة وPDF.' },
        msg: {
            processing: 'جاري معالجة الملفات...',
            analyzing: 'جاري إرسال البيانات للتحليل…',
            no_input: 'الرجاء إدخال أدوية أو رفع ملف روشتة.',
            pdf_fail: 'لم نتمكن من معالجة PDF: ',
            req_fail: 'فشل الطلب: ',
            pdf_gen: 'جاري توليد PDF…',
            pdf_gen_fail: 'فشل إنشاء PDF.',
            no_report: 'لا يوجد تقرير للتصدير.'
        }
    },
    en: {
        hero: { title: 'Smart Pharmacy Portal', subtitle: 'Capture patient data, analyze interactions/doses, and export a polished PDF.', cta: 'Start New Analysis', viewLast: 'View Last Report' },
        sec: { patient: '1) Patient Information', organs: '2) Organ Function', meds: '3) Medications & Files' },
        f: { age: 'Age', gender: 'Gender', height: 'Height (cm)', weight: 'Weight (kg)', pregnant: 'Is the patient pregnant?', gestation: 'Gestation (weeks)', egfr: 'eGFR', crea: 'Creatinine (mg/dL)', liver: 'Liver Status', meds: 'Medication List (type here)', files: 'Or upload files (Rx, reports)' },
        opt: { select: 'Select', male: 'Male', female: 'Female', yes: 'Yes', no: 'No' },
        liver: { normal: 'Normal', mild: 'Mild impairment', moderate: 'Moderate impairment', severe: 'Severe impairment' },
        btn: { analyze: 'Advanced Check & Analysis' },
        hint: { main: 'A comprehensive, printable PDF report will be generated.' },
        msg: {
            processing: 'Processing uploaded files...',
            analyzing: 'Sending data for analysis…',
            no_input: 'Please enter medications or upload a prescription file.',
            pdf_fail: 'Could not process PDF: ',
            req_fail: 'Request failed: ',
            pdf_gen: 'Generating PDF…',
            pdf_gen_fail: 'PDF generation failed.',
            no_report: 'No report to export.'
        }
    }
};
let currentLang = 'ar';

function t(key) {
    return key.split('.').reduce((o, k) => o && o[k], i18n[currentLang]) || key;
}

function setLanguage(lang) {
    currentLang = lang;
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === 'ar' ? 'rtl' : 'ltr');
    document.getElementById('langSwitcher').textContent = (lang === 'ar' ? 'English' : 'العربية');
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const i18nKey = el.getAttribute('data-i18n');
        const text = t(i18nKey);
        if (text) el.textContent = text;
    });
}

function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

/* ==== معالجة واجهة المستخدم ==== */
document.getElementById('startBtn').addEventListener('click', () => {
    document.getElementById('formCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
});
document.getElementById('scrollToReportBtn').addEventListener('click', () => {
    document.getElementById('report').scrollIntoView({ behavior: 'smooth', block: 'start' });
});
document.getElementById('langSwitcher').addEventListener('click', () => setLanguage(currentLang === 'ar' ? 'en' : 'ar'));

document.getElementById('gender').addEventListener('change', (e) => {
    const pregWrap = document.getElementById('pregWrap');
    pregWrap.style.display = (e.target.value === 'female') ? 'block' : 'none';
    if (e.target.value !== 'female') {
        document.getElementById('pregnancy').value = '';
        document.getElementById('gestWrap').style.display = 'none';
        document.getElementById('gestation').value = '';
    }
});
document.getElementById('pregnancy').addEventListener('change', (e) => {
    const gestWrap = document.getElementById('gestWrap');
    gestWrap.style.display = (e.target.value === 'yes') ? 'block' : 'none';
    if (e.target.value !== 'yes') {
        document.getElementById('gestation').value = '';
    }
});

/* ==== معالجة الملفات ==== */
let uploadedFiles = [];
const fileInput = document.getElementById('fileInput');
const fileThumbs = document.getElementById('fileThumbs');

fileInput.addEventListener('change', () => {
    for (const file of fileInput.files) {
        const id = uid();
        const reader = new FileReader();
        reader.onload = ev => {
            const type = file.type || '';
            uploadedFiles.push({ id, name: file.name, preview: ev.target.result, type, file });
            const content = type.startsWith('image/')
                ? `<img src="${ev.target.result}" style="width:100%;height:110px;object-fit:cover;border-radius:6px">`
                : `<div style="display:flex;align-items:center;justify-content:center;height:110px"><span class="pill">PDF</span></div>`;
            const div = document.createElement('div');
            div.className = 'thumb';
            div.innerHTML = `<button class="x" data-x="${id}">×</button>${content}<div class="name">${file.name}</div>`;
            fileThumbs.appendChild(div);
        };
        reader.readAsDataURL(file);
    }
    fileInput.value = ''; // Reset for next selection
});

fileThumbs.addEventListener('click', (e) => {
    const id = e.target.getAttribute('data-x');
    if (!id) return;
    const idx = uploadedFiles.findIndex(x => x.id === id);
    if (idx > -1) uploadedFiles.splice(idx, 1);
    e.target.closest('.thumb').remove();
});

/* ==== الملاحظات والإشعارات ==== */
const note = document.getElementById('note');
function showNote(type, text) {
    note.className = 'notification ' + (type === 'err' ? 'err' : 'info');
    note.textContent = text;
    note.style.display = 'block';
}
function clearNote() { note.style.display = 'none'; note.textContent = ''; }

/* ==== دوال مساعدة ==== */
async function renderPdfToImages(file) {
    const images = [];
    const url = URL.createObjectURL(file);
    try {
        const pdf = await pdfjsLib.getDocument({ url }).promise;
        for (let p = 1; p <= pdf.numPages; p++) {
            const page = await pdf.getPage(p);
            const viewport = page.getViewport({ scale: 2 });
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: ctx, viewport }).promise;
            images.push(canvas.toDataURL('image/png'));
        }
    } finally {
        URL.revokeObjectURL(url);
    }
    return images;
}

/* ==== التحليل الشامل (الوظيفة الرئيسية) ==== */
async function doAnalyze() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    analyzeBtn.disabled = true;
    document.getElementById('analyzeText').textContent = t('msg.analyzing');
    clearNote();

    try {
        // 1. تجميع بيانات المريض
        const age = parseInt(document.getElementById('age').value, 10);
        const gender = document.getElementById('gender').value;
        const height = parseFloat(document.getElementById('height').value);
        const weight = parseFloat(document.getElementById('weight').value);
        const egfr = parseFloat(document.getElementById('egfr').value);
        const creatinine = parseFloat(document.getElementById('creatinine').value);
        const liver = document.getElementById('liver').value;
        const preg = document.getElementById('pregnancy')?.value;
        const gest = parseInt(document.getElementById('gestation')?.value, 10);
        
        const patient = {
            age: Number.isFinite(age) ? age : undefined,
            sex: (gender === 'male' ? 'M' : (gender === 'female' ? 'F' : undefined)),
            weight: Number.isFinite(weight) ? weight : undefined,
            height: Number.isFinite(height) ? height : undefined,
            eGFR: Number.isFinite(egfr) ? egfr : undefined,
            creatinine: Number.isFinite(creatinine) ? creatinine : undefined,
            liverDisease: (liver && liver !== 'normal'),
            pregnancy: (preg === 'yes') ? { pregnant: true, weeks: Number.isFinite(gest) ? gest : undefined }
                     : (preg === 'no') ? { pregnant: false } : undefined,
            lactation: { breastfeeding: false } // لا يوجد حقل لها في الواجهة
        };

        // 2. تجميع نصوص الأدوية
        const medsText = (document.getElementById('meds').value || '').trim();
        const texts = medsText ? medsText.split(/\r?\n|,/).map(s => s.trim()).filter(Boolean) : [];

        // 3. معالجة الملفات المرفوعة (تحويل PDF إلى صور)
        showNote('info', t('msg.processing'));
        const imagesToSend = [];
        for (const fileItem of uploadedFiles) {
            if (fileItem.type && fileItem.type.startsWith('image/')) {
                imagesToSend.push(fileItem.preview);
            } else if (fileItem.type && fileItem.type.includes('pdf')) {
                try {
                    const pdfImages = await renderPdfToImages(fileItem.file);
                    imagesToSend.push(...pdfImages);
                } catch (e) {
                    console.warn(`Failed to process PDF ${fileItem.name}`, e);
                    showNote('err', t('msg.pdf_fail') + fileItem.name);
                }
            }
        }

        // 4. التحقق من وجود مدخلات
        if (texts.length === 0 && imagesToSend.length === 0) {
            showNote('err', t('msg.no_input'));
            throw new Error("No input");
        }

        // 5. استدعاء الواجهة الخلفية (API)
        showNote('info', t('msg.analyzing'));
        const payload = { texts, images: imagesToSend, patient };

        const res = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) {
            throw new Error(data?.message || res.statusText);
        }

        // 6. عرض النتائج
        clearNote();
        const reportEl = document.getElementById('report');
        const outEl = document.getElementById('reportContent');
        outEl.innerHTML = data.html; // الواجهة الخلفية ترسل HTML جاهزًا
        reportEl.style.display = 'block';
        reportEl.scrollIntoView({ behavior: 'smooth' });
        window.__lastReportLang = currentLang;

    } catch (e) {
        if (e.message !== "No input") {
            console.error('Analysis failed:', e);
            showNote('err', t('msg.req_fail') + e.message);
        }
    } finally {
        analyzeBtn.disabled = false;
        document.getElementById('analyzeText').textContent = t('btn.analyze');
    }
}

/* ==== تصدير PDF ==== */
async function downloadPDF() {
    const el = document.getElementById('report');
    if (!el || el.style.display === 'none') {
        showNote('err', t('msg.no_report'));
        return;
    }
    showNote('info', t('msg.pdf_gen'));
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
    try {
        const reportContent = document.getElementById('reportContent');
        // استخدام onclone لضمان الاتجاه الصحيح للغة العربية في الصورة
        const canvas = await html2canvas(reportContent, {
            scale: 2,
            useCORS: true,
            onclone: (doc2) => {
                const clonedContent = doc2.querySelector('#reportContent');
                if (clonedContent) {
                   clonedContent.style.fontFamily = "'Amiri', serif";
                }
            }
        });
        const img = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(img);
        const pdfWidth = doc.internal.pageSize.getWidth() - 20;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        let heightLeft = pdfHeight;
        let position = 10;
        
        doc.addImage(img, 'PNG', 10, position, pdfWidth, pdfHeight);
        heightLeft -= doc.internal.pageSize.getHeight() - 20;

        while (heightLeft > 0) {
            position = position - (doc.internal.pageSize.getHeight() - 20);
            doc.addPage();
            doc.addImage(img, 'PNG', 10, position, pdfWidth, pdfHeight);
            heightLeft -= doc.internal.pageSize.getHeight() - 20;
        }

        doc.save('Patient-Assessment-Report.pdf');
        clearNote();
    } catch (err) {
        console.error(err);
        showNote('err', t('msg.pdf_gen_fail'));
    }
}

/* ربط الأحداث بالوظائف والتشغيل الأولي */
document.getElementById('analyzeBtn').addEventListener('click', doAnalyze);
document.getElementById('downloadPDF').addEventListener('click', downloadPDF);
setLanguage('ar');

</script>
</body>
</html>
