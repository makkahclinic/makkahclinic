
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بوابة الصيدلية – تحليل وصفات وتقييم مريض</title>

  <!-- خطوط -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- html2canvas + jsPDF للتصدير -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- pdf.js لقراءة PDF وتحويله لصور -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --primary:#0b63c2;--primary-dark:#094f9c;--accent:#ffd54d;--bg:#f4f8ff;--card:#fff;
      --border:#e2e8f0;--muted:#66768a;--danger:#d63031;--ok:#10b981;--focus:rgba(11,99,194,.15);
      --shadow:0 12px 28px rgba(15,57,105,.08);--radius:16px
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 80% 0%,#e9f3ff,#f6fbff);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Amiri',serif;color:#243143}
    [lang="ar"] body,[lang="ar"] h1,[lang="ar"] h2,[lang="ar"] h3,[lang="ar"] label,[lang="ar"] input,[lang="ar"] select,[lang="ar"] textarea,[lang="ar"] button{font-family:'Amiri', serif}
    .container{max-width:1100px;margin:0 auto;padding:20px}

    .navbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--primary)}
    .lang-switcher{font-weight:700;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .home-link{background:#fff;color:#2b3a55;border:1px solid #ffe082;border-radius:12px;padding:.5rem .9rem;font-weight:800;display:inline-flex;align-items:center;gap:.4rem;box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .home-link::before{content:"⌂";}

    .hero{background:linear-gradient(145deg,#ffffff, #eef6ff);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;margin:10px 0 22px;position:relative;overflow:hidden}
    .hero::after{content:"";position:absolute;inset:auto -80px -90px auto;width:240px;height:240px;border-radius:50%;background:radial-gradient(closest-side, #ffd54d, transparent 70%);opacity:.45;}
    .hero h1{margin:0 0 8px;color:#0b63c2}
    .hero p{margin:0;color:var(--muted)}
    .cta{margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:none;border-radius:12px;padding:.8rem 1.2rem;font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.08);transition:transform .06s ease,filter .2s ease, background .25s ease}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg,#fff,#ffd54d);color:#2b3a55;border:1px solid #ffe082}
    .btn-primary:hover{filter:brightness(1.02)}
    .btn-outline{background:#fff;border:1px solid var(--border);color:#0b63c2}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .section-title{display:flex;align-items:center;gap:.5rem;border-bottom:2px solid var(--primary);color:var(--primary);font-weight:800;padding-bottom:6px;margin:18px 0 14px}
    .dot{width:9px;height:9px;background:#ffd54d;border-radius:50%}

    label{font-weight:700;display:block;margin:.7rem 0 .35rem}
    .hint{font-size:.92rem;color:var(--muted)}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--border);background:#fff;border-radius:12px;padding:.7rem .9rem;font-size:1rem;transition:border-color .2s, box-shadow .2s}
    input:focus,select:focus,textarea:focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 3px var(--focus)}
    textarea{min-height:110px;resize:vertical}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}

    .row{display:flex;gap:10px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f1f5ff;border:1px solid var(--border);font-weight:700;color:#0b63c2}

    .file-drop{border:2px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:#596;cursor:pointer;background:#fafcff;transition:border-color .2s, background .2s}
    .file-drop:hover{border-color:var(--primary);background:#f6fbff}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:12px}
    .thumb{position:relative;border:1px solid var(--border);border-radius:10px;background:#fcfdff;padding:6px}
    .thumb .name{font-size:.86rem;word-break:break-all;text-align:center;margin-top:6px}
    .thumb .x{position:absolute;inset:4px 4px auto auto;background:#d63031;color:#fff;border:0;border-radius:50%;width:22px;height:22px;line-height:22px;text-align:center;cursor:pointer}

    .notification{margin-top:12px;padding:12px;border-radius:10px;display:none;font-weight:700;text-align:center}
    .notification.info{background:#e9f4ff;color:#114a86;border:1px solid #cfe6ff}
    .notification.err{background:#fde8ea;color:#7a1f27;border:1px solid #f5c6cb}

    #report{display:none;margin-top:16px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px 10px;text-align:right;vertical-align:top}
    th{background:#e9f3ff;color:#0b63c2}

    .footer-note{margin-top:18px;color:#8aa}
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div class="brand"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Rx Portal</div>
      <div style="display:flex;gap:8px;align-items:center">
        <a class="home-link" href="portal.html">الصفحة الرئيسية</a>
        <button id="langSwitcher" class="lang-switcher">English</button>
      </div>
    </div>

    <div class="hero">
      <h1 data-i18n="hero.title">منصة الصيدلية الذكية</h1>
      <p data-i18n="hero.subtitle">تجميع بيانات المريض، تحليل تفاعلات/جرعات، وPDF أنيق للطباعة.</p>
      <div class="cta">
        <button class="btn btn-primary" id="startBtn"><span data-i18n="hero.cta">بدء تحليل جديد</span> ▸</button>
        <button class="btn btn-outline" id="scrollToReport"><span data-i18n="hero.viewLast">عرض آخر تقرير</span></button>
      </div>
    </div>

    <div class="card" id="formCard">
      <div class="section-title"><span class="dot"></span><span data-i18n="sec.patient">١) بيانات المريض</span></div>
      <div class="grid">
        <div><label data-i18n="f.age">العمر</label><input id="age" type="number" placeholder="63"></div>
        <div>
          <label data-i18n="f.gender">الجنس</label>
          <select id="gender">
            <option value="">اختر</option>
            <option value="male">ذكر</option>
            <option value="female">أنثى</option>
          </select>
        </div>
        <div><label data-i18n="f.height">الطول (سم)</label><input id="height" type="number" placeholder="170"></div>
        <div><label data-i18n="f.weight">الوزن (كجم)</label><input id="weight" type="number" placeholder="72"></div>
      </div>

      <div class="grid" id="pregWrap" style="margin-top:8px;display:none">
        <div>
          <label data-i18n="f.pregnant">هل المريضة حامل؟</label>
          <select id="pregnancy">
            <option value="">اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>
        <div id="gestWrap" style="display:none">
          <label data-i18n="f.gestation">مدة الحمل (أسابيع)</label>
          <input id="gestation" type="number" min="1" max="42" placeholder="20">
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.organs">٢) تقييم وظائف الأعضاء</span></div>
      <div class="grid">
        <div><label data-i18n="f.egfr">eGFR</label><input id="egfr" type="number" step="0.1" placeholder="60"></div>
        <div><label data-i18n="f.crea">كرياتينين (mg/dL)</label><input id="creatinine" type="number" step="0.01" placeholder="1.1"></div>
        <div>
          <label data-i18n="f.liver">حالة الكبد</label>
          <select id="liver">
            <option value="normal">سليم</option>
            <option value="mild">قصور طفيف</option>
            <option value="moderate">قصور متوسط</option>
            <option value="severe">قصور حاد</option>
          </select>
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.allergy">٣) الحساسية</span></div>
      <div class="row" style="flex-wrap:wrap;gap:12px">
        <div style="min-width:260px;flex:1">
          <label data-i18n="f.foodAllergy">هل توجد حساسية طعام؟</label>
          <select id="foodAllergy">
            <option value="no">لا</option>
            <option value="yes">نعم</option>
          </select>
          <input id="foodAllergyTxt" style="margin-top:8px;display:none" placeholder="مثال: فستق، بيض…">
        </div>
        <button class="btn btn-outline" id="addAllergy"><span data-i18n="btn.addAllergy">+ إضافة حساسية أخرى</span></button>
      </div>
      <div id="allergyList" class="grid" style="margin-top:10px"></div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span><span data-i18n="sec.symptoms">٤) معلومات سريرية إضافية</span></div>
      <label data-i18n="f.symptoms">الأعراض الإكلينيكية</label>
      <textarea id="symptoms" placeholder="مثال: دوخة، غثيان، ألم صدري…"></textarea>

      <div class="grid" style="margin-top:10px">
        <div>
          <label data-i18n="f.meds">قائمة الأدوية (سطر لكل دواء أو مفصولة بفواصل)</label>
          <textarea id="meds" placeholder="Amlodipine 10 mg
Duodart 0.5/0.4
Rosuvastatin 20 mg"></textarea>
        </div>
        <div>
          <label data-i18n="f.apap">إجمالي باراسيتامول يوميًا (mg) – اختياري</label>
          <input id="apap" type="number" step="1" placeholder="0">
        </div>
      </div>

      <!-- الرفع -->
      <div class="section-title" style="margin-top:18px"><span class="dot"></span>تحميل تقارير الأشعة</div>
      <div class="grid">
        <div>
          <div class="file-drop" onclick="document.getElementById('radInput').click()">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="radInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="radThumbs" class="thumbs"></div>
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span>تحميل نتائج المختبر</div>
      <div class="grid">
        <div>
          <div class="file-drop" onclick="document.getElementById('labInput').click()">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="labInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="labThumbs" class="thumbs"></div>
        </div>
      </div>

      <div class="section-title" style="margin-top:18px"><span class="dot"></span>ملفات أخرى (مثلاً صور روشتة/إيصالات)</div>
      <div class="grid">
        <div>
          <div class="file-drop" onclick="document.getElementById('otherInput').click()">اضغط لرفع ملفات (صور/PDF)</div>
          <input id="otherInput" type="file" accept="image/*,application/pdf" multiple style="display:none">
          <div id="otherThumbs" class="thumbs"></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:16px">
        <button class="btn btn-primary" id="analyzeBtn"><span id="analyzeText">تحليل وفحص متقدم</span> ▸</button>
        <span class="hint">سيتم توليد تقرير شامل قابل للطباعة وPDF.</span>
      </div>
      <div id="note" class="notification info"></div>
    </div>

    <div id="report" class="card">
      <div id="reportContent"></div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
        <button class="btn btn-outline" id="downloadPDF">PDF</button>
        <button class="btn btn-outline" onclick="window.print()">طباعة</button>
      </div>
      <div class="footer-note">* لا يتم تخزين ملفاتك على الخادم؛ تستخدم فقط لتوليد التقرير.</div>
    </div>
  </div>

  <script>
    // ===== إعدادات عامة =====
    const API_ENDPOINT = '/api/pharmacy-rx';
    const { jsPDF } = window.jspdf;
    // تكوين عامل PDF.js (مطلوب)
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // i18n بسيط
    const i18n = {
      ar:{hero:{title:'منصة الصيدلية الذكية',subtitle:'تجميع بيانات المريض، تحليل تفاعلات/جرعات، وPDF أنيق للطباعة.',cta:'بدء تحليل جديد',viewLast:'عرض آخر تقرير'},
          sec:{patient:'١) بيانات المريض',organs:'٢) تقييم وظائف الأعضاء',allergy:'٣) الحساسية',symptoms:'٤) معلومات سريرية إضافية'}},
      en:{hero:{title:'Smart Pharmacy Portal',subtitle:'Capture patient data, analyze interactions/doses, and export a polished PDF.',cta:'Start New Analysis',viewLast:'View Last Report'},
          sec:{patient:'1) Patient Information',organs:'2) Organ Function',allergy:'3) Allergies',symptoms:'4) Additional Clinical Information'}}
    };
    let currentLang='ar';
    function setLanguage(lang){
      currentLang=lang;
      document.documentElement.lang=lang;
      document.documentElement.dir=(lang==='ar'?'rtl':'ltr');
      document.getElementById('langSwitcher').textContent=(lang==='ar'?'English':'العربية');
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key=el.getAttribute('data-i18n');
        const t = key.split('.').reduce((o,k)=>o&&o[k], i18n[lang]);
        if (t) el.textContent=t;
      });
      document.getElementById('analyzeText').textContent = (lang==='ar'?'تحليل وفحص متقدم':'Advanced Check & Analysis');
    }
    function t(en,ar){return currentLang==='ar'?ar:en;}
    function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}

    // DOM عناصر
    const startBtn=document.getElementById('startBtn');
    const scrollToReportBtn=document.getElementById('scrollToReport');
    const genderEl=document.getElementById('gender');
    const pregWrap=document.getElementById('pregWrap');
    const pregnancyEl=document.getElementById('pregnancy');
    const gestWrap=document.getElementById('gestWrap');
    const foodAllergyEl=document.getElementById('foodAllergy');
    const foodAllergyTxt=document.getElementById('foodAllergyTxt');
    const allergyList=document.getElementById('allergyList');
    const addAllergyBtn=document.getElementById('addAllergy');
    const note=document.getElementById('note');
    const out=document.getElementById('reportContent');

    startBtn.addEventListener('click',()=>document.getElementById('formCard').scrollIntoView({behavior:'smooth',block:'start'}));
    scrollToReportBtn.addEventListener('click',()=>document.getElementById('report').scrollIntoView({behavior:'smooth',block:'start'}));
    document.getElementById('langSwitcher').addEventListener('click',()=>setLanguage(currentLang==='ar'?'en':'ar'));

    genderEl.addEventListener('change',()=>{
      pregWrap.style.display=(genderEl.value==='female')?'':'none';
      if(genderEl.value!=='female'){ pregnancyEl.value=''; gestWrap.style.display='none'; document.getElementById('gestation').value=''; }
    });
    pregnancyEl?.addEventListener('change',()=>{
      gestWrap.style.display=(pregnancyEl.value==='yes')?'':'none';
      if(pregnancyEl.value!=='yes'){ document.getElementById('gestation').value=''; }
    });

    foodAllergyEl.addEventListener('change',()=>{
      foodAllergyTxt.style.display=(foodAllergyEl.value==='yes')?'':'none';
      if(foodAllergyEl.value!=='yes') foodAllergyTxt.value='';
    });

    addAllergyBtn.addEventListener('click',()=>{
      const id=uid();
      const card=document.createElement('div');
      card.className='card';
      card.style.padding='12px';
      card.innerHTML=`
        <div class="grid">
          <div>
            <label>${t('Allergy Type','نوع الحساسية')}</label>
            <select data-id="${id}" class="allType">
              <option value="drug">${t('Drug','دواء')}</option>
              <option value="chemical">${t('Chemical','مادة كيميائية')}</option>
              <option value="dust">${t('Dust','غبار')}</option>
              <option value="other">${t('Other','أخرى')}</option>
            </select>
          </div>
          <div>
            <label>${t('Details','التفاصيل')}</label>
            <input data-id="${id}" class="allDetail" placeholder="${t('e.g., Penicillin, Latex','مثال: بنسلين، لاتكس')}">
          </div>
        </div>
        <div class="row" style="margin-top:8px"><button class="btn btn-outline" data-remove="${id}">✕ ${t('Remove','حذف')}</button></div>
      `;
      allergyList.appendChild(card);
    });
    allergyList.addEventListener('click',(e)=>{
      const id=e.target.getAttribute('data-remove');
      if(id){ e.target.closest('.card').remove(); }
    });

    // إدارة الملفات
    let labFiles=[], radFiles=[], otherFiles=[];
    function bindFilePicker(inputId,gridId,store){
      const input=document.getElementById(inputId);
      const grid=document.getElementById(gridId);
      input.addEventListener('change',()=>{
        for(const file of input.files){
          const id=uid();
          const reader=new FileReader();
          reader.onload=ev=>{
            const type=file.type || '';
            store.push({id,name:file.name,preview:ev.target.result,type,file});
            const content= type.startsWith('image/')
              ? `<img src="${ev.target.result}" style="width:100%;height:110px;object-fit:cover;border-radius:6px">`
              : `<div style="display:flex;align-items:center;justify-content:center;height:110px"><span class="pill">PDF</span></div>`;
            const div=document.createElement('div');
            div.className='thumb';
            div.innerHTML=`<button class="x" data-x="${id}">×</button>${content}<div class="name">${file.name}</div>`;
            grid.appendChild(div);
          };
          reader.readAsDataURL(file);
        }
        input.value='';
      });
      grid.addEventListener('click',(e)=>{
        const id=e.target.getAttribute('data-x');
        if(!id) return;
        const idx=store.findIndex(x=>x.id===id);
        if(idx>-1) store.splice(idx,1);
        e.target.closest('.thumb').remove();
      });
    }
    bindFilePicker('labInput','labThumbs',labFiles);
    bindFilePicker('radInput','radThumbs',radFiles);
    bindFilePicker('otherInput','otherThumbs',otherFiles);

    // ملاحظات
    function showNote(type,text){
      note.className='notification '+(type==='err'?'err':'info');
      note.textContent=text; note.style.display='block';
    }
    function clearNote(){ note.style.display='none'; note.textContent=''; }

    // تحويل PDF إلى صور (للإرسال إلى الباك-إند فقط)
    async function renderPdfToImages(file){
      const images = [];
      const ab = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
      for(let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        images.push(canvas.toDataURL('image/png'));
      }
      return images;
    }

    async function collectImagesForBackend(){
      const pools = [labFiles, radFiles, otherFiles].filter(Boolean);
      const out = [];
      for (const pool of pools){
        for (const f of pool){
          try{
            if ((f.type||'').includes('pdf')){
              const pages = await renderPdfToImages(f.file);
              out.push(...pages);
            } else if ((f.type||'').startsWith('image/')){
              out.push(f.preview);
            }
          }catch(e){ console.warn('Failed to prep file', f?.name, e); }
        }
      }
      return out;
    }

    function gatherPatient(){
      const age=parseInt(document.getElementById('age').value,10);
      const height=parseFloat(document.getElementById('height').value);
      const weight=parseFloat(document.getElementById('weight').value);
      const gender=document.getElementById('gender').value||undefined;
      const egfr=parseFloat(document.getElementById('egfr').value);
      const creatinine=parseFloat(document.getElementById('creatinine').value);
      const liver=document.getElementById('liver').value;
      const preg=document.getElementById('pregnancy')?.value;
      const gest=parseInt(document.getElementById('gestation')?.value,10);
      const lactation=false;

      return {
        age:Number.isFinite(age)?age:undefined,
        sex:(gender==='male'?'M':(gender==='female'?'F':undefined)),
        weight:Number.isFinite(weight)?weight:undefined,
        height:Number.isFinite(height)?height:undefined,
        eGFR:Number.isFinite(egfr)?egfr:undefined,
        creatinine:Number.isFinite(creatinine)?creatinine:undefined,
        liverDisease:(liver && liver!=='normal')?true:false,
        pregnancy:(preg==='yes')?{pregnant:true,weeks:Number.isFinite(gest)?gest:undefined}:(preg==='no'?{pregnant:false}:undefined),
        lactation:{breastfeeding:!!lactation}
      };
    }

    async function doAnalyze(){
      const medsText = (document.getElementById('meds').value || '').trim();
      const texts = medsText ? medsText.split(/\n+/).map(s => s.trim()).filter(Boolean) : [];
      const images = await collectImagesForBackend();
      const patient = gatherPatient();

      if (!texts.length && !images.length) {
        showNote('err', (currentLang==='ar'?'الرجاء إدخال أدوية أو رفع صورة/ملف.':'Please type meds or upload a file/image.'));
        return;
      }

      showNote('info', (currentLang==='ar'?'جاري التحليل…':'Analyzing…'));
      try{
        const res = await fetch(API_ENDPOINT, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ texts, images, patient })
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) throw new Error(data?.message || data?.error || res.statusText);

        clearNote();
        document.getElementById('report').style.display='block';
        out.innerHTML = data.html; // HTML النهائي من الباك-إند
        document.getElementById('report').scrollIntoView({behavior:'smooth'});

      } catch(e){
        console.error(e);
        showNote('err', (currentLang==='ar'?'فشل الطلب: ':'Request failed: ')+e.message);
      }
    }

    async function downloadPDF(){
      const el=document.getElementById('reportContent');
      if(!el || document.getElementById('report').style.display==='none'){
        showNote('err',t('No report to export.','لا يوجد تقرير للتصدير.'));
        return;
      }
      showNote('info',t('Generating PDF…','جاري توليد PDF…'));
      try{
        const canvas=await html2canvas(el,{scale:2,useCORS:true});
        const img=canvas.toDataURL('image/png');
        const doc=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const imgWidth = pageWidth - 20;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let heightLeft = imgHeight;
        let position = 10;
        doc.addImage(img,'PNG',10,position,imgWidth,imgHeight);
        heightLeft -= pageHeight;
        while (heightLeft > 0){
          position = heightLeft - imgHeight + 10;
          doc.addPage();
          doc.addImage(img,'PNG',10,position,imgWidth,imgHeight);
          heightLeft -= pageHeight;
        }
        doc.save('Patient-Assessment.pdf');
        clearNote();
      }catch(err){
        console.error(err);
        showNote('err',t('PDF failed.','فشل إنشاء PDF.'));
      }
    }

    document.getElementById('analyzeBtn').addEventListener('click',doAnalyze);
    document.getElementById('downloadPDF').addEventListener('click',downloadPDF);
    setLanguage('ar');
  </script>
</body>
</html>
