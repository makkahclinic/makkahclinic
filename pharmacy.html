<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بوابة الصيدلية – تحليل وصفات</title>
  <style>
    body{font-family: "Amiri", serif; background:#f6f7fb; color:#0f172a; margin:0}
    .container{max-width:1024px; margin:24px auto; padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px 18px;margin-bottom:16px}
    h1{font-size:22px;margin:0 0 12px;color:#1e40af}
    .row{display:grid; grid-template-columns: repeat(12,1fr); gap:12px}
    .col-6{grid-column: span 6}
    .col-12{grid-column: span 12}
    label{display:block;font-weight:700;margin:8px 0 6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%; padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-family:inherit
    }
    textarea{min-height:110px}
    .inline{display:flex; gap:12px; align-items:center}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px;
      border:1px solid #1d4ed8; color:#fff; background:#1d4ed8; cursor:pointer; font-weight:700}
    .btn.secondary{background:#fff;color:#1d4ed8}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .muted{color:#64748b; font-size:13px}
    .drop{border:2px dashed #94a3b8; border-radius:14px; padding:18px; text-align:center; color:#64748b; background:#f8fafc}
    .thumbs{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .thumb{position:relative; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff}
    .thumb img{display:block; height:90px}
    .thumb .meta{font-size:12px; padding:6px 8px}
    .thumb .x{position:absolute; top:6px; left:6px; background:#ef4444; color:#fff; border:none; border-radius:999px; width:22px; height:22px; cursor:pointer}
    .status{margin-top:10px; font-size:14px}
    .status.error{color:#b91c1c}
    .status.ok{color:#0f766e}
    #report .placeholder{border:2px dashed #cbd5e1; border-radius:16px; padding:22px; text-align:center; color:#64748b}
    .hr{height:1px; background:#e5e7eb; margin:14px 0}
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>تحليل وصفة طبية</h1>
    <div class="inline" style="gap:8px; flex-wrap:wrap">
      <button id="btnNew" class="btn secondary" type="button">تحليل جديد</button>
      <button id="btnAnalyze" class="btn" type="button">بدء التحليل</button>
      <span id="status" class="status muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col-6">
        <label>العمر</label>
        <input id="age" type="number" min="0" placeholder="مثال: 72" />
      </div>
      <div class="col-6">
        <label>الجنس</label>
        <select id="sex">
          <option value="">غير محدد</option>
          <option value="ذكر">ذكر</option>
          <option value="أنثى">أنثى</option>
        </select>
      </div>
      <div class="col-6">
        <label>eGFR (وظائف الكلى)</label>
        <input id="egfr" type="number" step="1" placeholder="مثال: 42" />
      </div>
      <div class="col-6">
        <label>الحمل</label>
        <div class="inline">
          <input id="preg" type="checkbox" />
          <span>المريضة حامل</span>
          <input id="weeks" type="number" min="1" placeholder="أسابيع (اختياري)" style="max-width:160px" />
        </div>
      </div>
      <div class="col-12">
        <label>حالة الكبد</label>
        <div class="inline">
          <input id="liver" type="checkbox" />
          <span>يوجد مرض كبدي</span>
        </div>
      </div>
      <div class="col-12">
        <label>نص الوصفة/الملاحظات</label>
        <textarea id="rxText" placeholder="مثال: دوكسيسيكلين 100mg مرتين يوميًا لمدة 5 أيام..."></textarea>
      </div>
    </div>
    <div class="hr"></div>
    <label>رفع ملفات (صور / PDF)</label>
    <div id="drop" class="drop">
      اسحب الملفات هنا أو
      <input id="file" type="file" accept="image/*,application/pdf" multiple style="display:none" />
      <button id="btnPick" class="btn secondary" type="button">اختر ملفات</button>
      <div class="muted" style="margin-top:6px">يدعم صور JPG/PNG وملفات PDF. لو الملف كبير، سنرسله عبر Files API تلقائيًا.</div>
    </div>
    <div id="thumbs" class="thumbs"></div>
  </div>

  <div id="report" class="card">
    <div class="placeholder">سيظهر التقرير هنا بعد التحليل.</div>
  </div>
</div>

<script>
  // ========= إعدادات =========
  const API_URL = "/api/pharmacy-rx"; // غيّرها إذا كان مسارك مختلفًا

  // ========= حالة الواجهة =========
  const state = {
    images: [], // data URLs
    files: [],  // File objects (للعرض فقط)
  };

  // ========= عناصر DOM =========
  const el = (id)=>document.getElementById(id);
  const btnNew = el("btnNew");
  const btnAnalyze = el("btnAnalyze");
  const statusEl = el("status");
  const fileInput = el("file");
  const btnPick = el("btnPick");
  const drop = el("drop");
  const thumbs = el("thumbs");
  const report = el("report");

  // ========= أدوات =========
  function setStatus(msg, cls="muted") {
    statusEl.className = "status " + cls;
    statusEl.textContent = msg || "";
  }

  async function fileToDataURL(file) {
    // MDN: FileReader.readAsDataURL لإخراج data:URL بترميز Base64
    // https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL
    return await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onerror = () => reject(new Error("قراءة الملف فشلت"));
      fr.onload = () => resolve(fr.result);
      fr.readAsDataURL(file);
    });
  }

  function addThumb(file, dataUrl) {
    const box = document.createElement("div");
    box.className = "thumb";
    const isImg = file.type.startsWith("image/");
    if (isImg) {
      const img = document.createElement("img");
      img.src = dataUrl;
      box.appendChild(img);
    }
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${file.name} • ${(file.size/1024/1024).toFixed(2)}MB`;
    const x = document.createElement("button");
    x.className = "x";
    x.textContent = "×";
    x.onclick = () => {
      const idx = state.images.indexOf(dataUrl);
      if (idx >= 0) state.images.splice(idx,1);
      const fidx = state.files.indexOf(file);
      if (fidx >= 0) state.files.splice(fidx,1);
      thumbs.removeChild(box);
    };
    box.appendChild(x);
    box.appendChild(meta);
    thumbs.appendChild(box);
  }

  async function addFiles(list) {
    const files = Array.from(list || []);
    for (const f of files) {
      if (!/^image\\//.test(f.type) && f.type !== "application/pdf") continue;
      const dataUrl = await fileToDataURL(f);
      state.files.push(f);
      state.images.push(dataUrl);
      addThumb(f, dataUrl);
    }
  }

  // Fetch JSON مع تحقّق من نوع المحتوى (يتفادى JSON.parse على HTML)
  // MDN fetch/json(): https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
  async function safePostJSON(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const ct = res.headers.get("content-type") || "";
    const text = await res.text();
    if (!res.ok) {
      console.error("HTTP", res.status, text.slice(0,500));
      throw new Error("فشل الطلب: HTTP " + res.status);
    }
    if (!ct.includes("application/json")) {
      console.error("Non-JSON", ct, text.slice(0,500));
      throw new Error("الخادم لم يرجّع JSON (تحقق من مسار API).");
    }
    return JSON.parse(text);
    // أو: return await res.json();  // لكن حافظنا على فحص الـ content-type
  }

  function getPatient() {
    return {
      age: Number(el("age").value) || undefined,
      sex: el("sex").value || undefined,
      eGFR: Number(el("egfr").value) || undefined,
      pregnancy: { pregnant: el("preg").checked, weeks: Number(el("weeks").value) || undefined },
      liverDisease: el("liver").checked,
    };
  }

  function resetAll() {
    // امسح الحقول
    el("age").value = "";
    el("sex").value = "";
    el("egfr").value = "";
    el("preg").checked = false;
    el("weeks").value = "";
    el("liver").checked = false;
    el("rxText").value = "";
    // امسح الملفات والمعاينات
    state.images = [];
    state.files = [];
    fileInput.value = "";
    thumbs.innerHTML = "";
    // امسح التقرير
    report.innerHTML = '<div class="placeholder">سيظهر التقرير هنا بعد التحليل.</div>';
    setStatus("تم مسح النموذج. جاهز لتحليل جديد.", "ok");
    btnAnalyze.disabled = false;
  }

  // ========= أحداث =========
  btnPick.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", async (e) => { await addFiles(e.target.files); });

  // سحب وإفلات
  ;["dragenter","dragover","dragleave","drop"].forEach(evt=>{
    drop.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); }, false);
  });
  drop.addEventListener("drop", async (e)=>{
    await addFiles(e.dataTransfer.files);
  });

  btnNew.addEventListener("click", resetAll);

  btnAnalyze.addEventListener("click", async () => {
    try {
      btnAnalyze.disabled = true;
      setStatus("جاري التحليل ... قد يستغرق ثوانٍ حسب حجم الملفات.", "muted");

      const payload = {
        texts: [el("rxText").value || ""],
        images: state.images.slice(), // data URLs
        patient: getPatient(),
      };

      const data = await safePostJSON(API_URL, payload);
      if (data?.ok && data?.html) {
        report.innerHTML = data.html;
        setStatus("اكتمل التحليل بنجاح.", "ok");
        report.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        throw new Error(data?.message || "رد غير متوقع من الخادم.");
      }
    } catch (err) {
      console.error(err);
      setStatus(err.message || "فشل التحليل.", "error");
      // اترك الزر مفعّل بعد الخطأ للمحاولة مجددًا
    } finally {
      btnAnalyze.disabled = false;
    }
  });

  // مبدئيًا
  setStatus("جاهز.", "muted");
</script>
</body>
</html>
