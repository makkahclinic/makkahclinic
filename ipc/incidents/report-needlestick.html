const SHEET_NAME = "NEEDEL";

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error("لم يتم العثور على الورقة: " + SHEET_NAME);
    }

    const data = JSON.parse(e.postData.contents);
    
    const timestamp = new Date();
    const row = [
      timestamp,
      data.fullname || "",
      data.department || "",
      data.position || "",
      data.date || "",
      data.time || "",
      data.exposure_type || "",
      data.instrument || "",
      data.contaminated || "",
      data.injury_site || "",
      data.contact_area || "",
      data.fluid_type || "",
      data.fluid_amount || "",
      data.patient_id || "",
      data.lab_results || "",
      data.washed || "لا",
      data.reported || "لا", 
      data.medical_eval || "لا",
      data.pep || "لا",
      data.notes || ""
    ];

    sheet.appendRow(row);
    SpreadsheetApp.flush();

    return ContentService.createTextOutput(JSON.stringify({
      status: "success",
      message: "تم حفظ البيانات بنجاح",
      timestamp: timestamp.toString()
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('خطأ في السكريبت:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: "error", 
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet() {
  return ContentService.createTextOutput(JSON.stringify({
    status: "active",
    message: "الخدمة تعمل بشكل صحيح"
  })).setMimeType(ContentService.MimeType.JSON);
}
