<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ğŸ©º Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠ â€“ Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--maroon:#7B1E24;--burgundy:#9e2b2b;--gold:#E9C46A;--sand:#FDF8F5}
    body{font-family:'Tajawal',sans-serif;background:var(--sand);
      background-image:radial-gradient(circle at top left,#fff 25%,#f9f2ef 80%)}
    .header{background:linear-gradient(to right,var(--maroon),var(--burgundy));
      color:#fff;border-bottom:6px solid var(--gold)}
    .card{background:#fff;border-radius:18px;box-shadow:0 6px 20px rgba(0,0,0,.08);transition:transform .3s ease}
    .card:hover{transform:translateY(-3px)}
    .label{color:var(--maroon);font-weight:700}
    .btn{background-color:var(--maroon);color:#fff;padding:12px 28px;border-radius:12px;font-weight:700;transition:all .3s ease;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .btn:hover{background-color:var(--gold);color:#3b2f2f;transform:translateY(-1px)}
    footer{margin-top:40px;text-align:center;color:#777;font-size:.85rem}
    @keyframes pulse {0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
    canvas.pulse {animation:pulse 1.5s ease;}
    .gold-counter{background:var(--gold);color:#7B1E24;font-weight:800;
      padding:10px 20px;border-radius:12px;display:inline-block;
      box-shadow:0 2px 6px rgba(0,0,0,.15);animation:pulse 2s infinite ease-in-out;}
  </style>
</head>

<body class="p-4">
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <header class="header py-6 text-center rounded-b-xl shadow">
    <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹" class="mx-auto h-20 mb-3">
    <h1 class="text-3xl md:text-4xl font-extrabold">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠ</h1>
    <p class="text-lg mt-2 text-[var(--gold)]">ÙˆØ®Ø²ÙŠ â€“ Ø¯Ù…ÙˆÙŠ â€“ Ø±Ø°Ø§Ø° Ù…Ø®Ø§Ø·ÙŠ</p>
    <p class="text-sm text-gray-100 mt-1">Ù„Ø¬Ù†Ø© Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰ â€“ Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</p>
  </header>

  <!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
  <section class="max-w-4xl mx-auto mt-10 card p-8 space-y-6">
    <h2 class="text-2xl font-extrabold text-[var(--maroon)] text-center border-b-2 border-[var(--gold)] pb-3">
      ğŸ“‹ ØªØ¹Ø¨Ø¦Ø© Ø¨Ù„Ø§Øº Ø§Ù„ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠ
    </h2>

    <form id="exposureForm" class="space-y-6" autocomplete="off" novalidate>
      <div>
        <h3 class="text-xl font-bold text-[var(--maroon)] mb-3">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div><label class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
               <input name="fullname" class="w-full border p-2 rounded" required></div>
          <div><label class="label">Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„ÙˆØ­Ø¯Ø©</label>
               <input name="department" class="w-full border p-2 rounded" required></div>
          <div><label class="label">Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
               <input name="position" class="w-full border p-2 rounded"></div>
          <div><label class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ø¯Ø«</label>
               <input type="date" name="date" class="w-full border p-2 rounded" required></div>
          <div><label class="label">Ø§Ù„ÙˆÙ‚Øª</label>
               <input type="time" name="time" class="w-full border p-2 rounded" required></div>
        </div>
      </div>

      <div>
        <h3 class="text-xl font-bold text-[var(--maroon)] mb-3">Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø±Ø¶</h3>
        <select id="exposureType" name="exposure_type" class="w-full border p-2 rounded" required>
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø±Ø¶</option>
          <option value="needle">ÙˆØ®Ø²ÙŠ (Ø¥Ø¨Ø±Ø© Ø£Ùˆ Ø£Ø¯Ø§Ø© Ø­Ø§Ø¯Ø©)</option>
          <option value="blood">ØªØ¹Ø±Ø¶ Ø¯Ù…ÙˆÙŠ / Ø³ÙˆØ§Ø¦Ù„ Ø¬Ø³Ø¯ÙŠØ©</option>
          <option value="mucosal">ØªÙ„Ø§Ù…Ø³ Ø§Ù„Ø£ØºØ´ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·ÙŠØ©</option>
        </select>

        <div id="needleSection" class="hidden space-y-2 mt-3">
          <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø¯Ø§Ø©</label>
          <select name="instrument" class="w-full border p-2 rounded">
            <option value="">Ø§Ø®ØªØ±</option><option>Ø¥Ø¨Ø±Ø©</option><option>Ù…Ø´Ø±Ø·</option><option>Ø£Ø¯Ø§Ø© Ø£Ø®Ø±Ù‰</option>
          </select>
          <label class="label">Ù‡Ù„ ÙƒØ§Ù†Øª Ù…Ù„ÙˆØ«Ø©ØŸ</label>
          <select name="contaminated" class="w-full border p-2 rounded">
            <option value="">Ø§Ø®ØªØ±</option><option>Ù†Ø¹Ù…</option><option>Ù„Ø§</option>
          </select>
          <label class="label">Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØµØ§Ø¨Ø©</label>
          <input name="injury_site" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: Ø¥ØµØ¨Ø¹ Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰">
        </div>
        <div id="bloodSection" class="hidden space-y-2 mt-3">
          <label class="label">Ù…ÙƒØ§Ù† Ø§Ù„ØªÙ„Ø§Ù…Ø³</label>
          <input name="contact_area" class="w-full border p-2 rounded" placeholder="Ø¬Ø±Ø­ / Ø¬Ù„Ø¯ Ù…ØªØ´Ù‚Ù‚">
          <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¦Ù„</label>
          <input name="fluid_type" class="w-full border p-2 rounded" placeholder="Ø¯Ù… / Ø³ÙˆØ§Ø¦Ù„ Ø¬Ø³Ø¯ÙŠØ©">
          <label class="label">ÙƒÙ…ÙŠØ© Ø§Ù„Ø³Ø§Ø¦Ù„</label>
          <input name="fluid_amount" class="w-full border p-2 rounded" placeholder="Ù‚Ù„ÙŠÙ„Ø© / Ù…ØªÙˆØ³Ø·Ø© / ÙƒØ«ÙŠØ±Ø©">
        </div>
      </div>

      <div>
        <h3 class="text-xl font-bold text-[var(--maroon)] mb-3">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©</h3>
        <div class="space-y-2">
          <label><input type="checkbox" name="washed" value="Ù†Ø¹Ù…"> ØªÙ… ØºØ³Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><br>
          <label><input type="checkbox" name="reported" value="Ù†Ø¹Ù…"> ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº</label><br>
          <label><input type="checkbox" name="medical_eval" value="Ù†Ø¹Ù…"> ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø¨ÙŠ</label><br>
          <label><input type="checkbox" name="pep" value="Ù†Ø¹Ù…"> ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠ (PEP)</label>
        </div>
      </div>

      <div>
        <label class="label block mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
        <textarea name="notes" class="w-full border p-2 rounded" rows="3" placeholder="Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
      </div>

      <div class="text-center mt-6">
        <button type="submit" id="submitBtn" class="btn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
        <div id="statusMsg" class="text-sm mt-3 text-gray-600"></div>
      </div>
    </form>
  </section>

  <div class="text-center mt-10">
    <button id="openLogBtn" class="btn bg-[var(--gold)] text-black hover:bg-[#f3cf73]">ğŸ“Š Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª</button>
  </div>

  <section class="max-w-6xl mx-auto mt-12 card p-8 text-center">
    <h2 class="text-2xl font-extrabold text-[var(--maroon)] mb-4">ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</h2>
    <div id="goldCounter" class="gold-counter mb-6">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª: 0 | Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ±Ø©: 0</div>
    <canvas id="chart" class="mx-auto pulse" height="160"></canvas>
    <div id="dataTable" class="mt-6"></div>
  </section>

  <footer>Â© 2025 Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± â€“ Ù„Ø¬Ù†Ø© Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰</footer>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyWPna2RXgl_P8xYfnIxG634pS8fVoAtW6X8Ch8-fzM0ASZNz49OIORmYwxjbiVapHEyg/exec";
    const exposureType=document.getElementById('exposureType');
    const needleSection=document.getElementById('needleSection');
    const bloodSection=document.getElementById('bloodSection');

    function handleExposureTypeChange(){
      needleSection.classList.add('hidden');
      bloodSection.classList.add('hidden');
      if(exposureType.value==='needle') needleSection.classList.remove('hidden');
      else if(['blood','mucosal'].includes(exposureType.value)) bloodSection.classList.remove('hidden');
    }
    exposureType.addEventListener('change',handleExposureTypeChange);

    document.getElementById('exposureForm').addEventListener('submit',e=>{
      e.preventDefault();
      const btn=document.getElementById('submitBtn'),msg=document.getElementById('statusMsg');
      btn.disabled=true;btn.textContent='â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
      const fd=new FormData(e.target);
      ['washed','reported','medical_eval','pep'].forEach(n=>{if(!fd.has(n))fd.append(n,'Ù„Ø§');});
      const params=new URLSearchParams(fd);
      const cb="__gs_cb_"+Date.now();params.append('callback',cb);
      const s=document.createElement('script');s.src=WEB_APP_URL+"?"+params.toString();
      const timeout=setTimeout(()=>{msg.textContent='âŒ Ù„Ù… ÙŠØµÙ„ Ø±Ø¯Ù‘ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…';msg.style.color='red';btn.disabled=false;btn.textContent='ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº';document.body.removeChild(s);delete window[cb];},15000);
      window[cb]=(json)=>{clearTimeout(timeout);
        if(json&&json.status==='success'){msg.textContent='âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­';msg.style.color='green';e.target.reset();handleExposureTypeChange();loadData();}
        else{msg.textContent='âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';msg.style.color='red';}
        btn.disabled=false;btn.textContent='ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº';document.body.removeChild(s);delete window[cb];};
      document.body.appendChild(s);
    });

    document.getElementById('openLogBtn').addEventListener('click',()=>{
      const pass=prompt('ğŸ” Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª:');
      if(pass==='BostonYYYY2025'){window.open('https://docs.google.com/spreadsheets/d/11ASpiUe6GTW4siaoPGnjqG3xKMeUdCmxPsTSbPTu9xw/edit#gid=0','_blank');}
      else if(pass!==null){alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');}
    });

    let chart;

    async function loadData(){
      try{
        const res=await fetch(`${WEB_APP_URL}?action=data&callback=cb_${Date.now()}`);
        const text=await res.text();
        const match=text.match(/\((.*)\)$/);
        if(!match)return;
        const data=JSON.parse(match[1]);
        if(data.status==='success'){renderChart(data.rows);renderTable(data.rows);}
      }catch(err){console.error('ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:',err);}
    }

    function renderChart(rows){
      if(!rows.length)return;
      const ctx=document.getElementById('chart').getContext('2d');
      const types={needle:0,blood:0,mucosal:0};
      let severe=0;
      rows.forEach(r=>{
        const type=(r["Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø±Ø¶"]||"").trim().toLowerCase();
        const contaminated=(r["Ù‡Ù„ ÙƒØ§Ù†Øª Ù…Ù„ÙˆØ«Ø©ØŸ"]||"").trim();
        if(types.hasOwnProperty(type))types[type]++;
        if(contaminated==="Ù†Ø¹Ù…")severe++;
      });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø°Ù‡Ø¨ÙŠ
      const counter=document.getElementById('goldCounter');
      counter.textContent=`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª: ${rows.length} | Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ±Ø©: ${severe}`;

      if(chart&&typeof chart.destroy==="function")chart.destroy();
      chart=new Chart(ctx,{
        type:'bar',
        data:{labels:['ÙˆØ®Ø²ÙŠ','Ø¯Ù…ÙˆÙŠ','Ù…Ø®Ø§Ø·ÙŠ'],
          datasets:[{label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª',data:Object.values(types),
            backgroundColor:['#7B1E24','#C55A44','#E9C46A'],borderWidth:1}]},
        options:{
          responsive:true,
          plugins:{title:{display:false},legend:{display:false}},
          scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}
        }});
      const canvas=document.getElementById('chart');
      canvas.classList.remove('pulse');void canvas.offsetWidth;canvas.classList.add('pulse');
    }

    function renderTable(rows){
      const c=document.getElementById('dataTable');
      if(!rows.length){c.innerHTML='<p class="text-gray-600 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';return;}
      const headers=Object.keys(rows[0]);
      c.innerHTML=`<div class="overflow-x-auto"><table class="min-w-full border text-sm text-center">
        <thead><tr>${headers.map(h=>`<th class="border bg-[var(--gold)] text-[var(--maroon)] p-2">${h}</th>`).join('')}</tr></thead>
        <tbody>${rows.map(r=>`<tr>${headers.map(h=>`<td class="border p-1">${r[h]||''}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
    }

    window.addEventListener('DOMContentLoaded',()=>{loadData();setInterval(loadData,60000);});
  </script>
</body>
</html>
