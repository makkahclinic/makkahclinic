// This code should be placed in the Google Apps Script editor associated with your Google Sheet.
// 1. Open your Google Sheet.
// 2. Go to Extensions > Apps Script.
// 3. Replace any existing code in Code.gs with the code below.
// 4. IMPORTANT: Fill in your Sheet Name and Email List below.
// 5. Deploy as a Web App (Deploy > New deployment).
// 6. Select "Web app" as the type.
// 7. In "Who has access", select "Anyone".
// 8. Click "Deploy".
// 9. Authorize the script when prompted.
// 10. Copy the generated Web app URL and paste it into the SCRIPT_URL variable in your index.html file.

const SHEET_NAME = "سجل البلاغات والشكاوى"; // <--- ‼️  ادخل اسم الشيت هنا
const EMAIL_LIST = "CEOmakkah@makkahmedicalclinic.org,adnanmsr@makkahmedicalclinic.org,BelalNatto@makkahmedicalclinic.org,kkhattab@makkahmedicalclinic.org,Saber.Saeed@makkahmedicalclinic.org"; // <--- ‼️  ادخل قائمة الإيميلات هنا

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);

    // If sheet doesn't exist, create it with headers
    if (!sheet) {
      const newSheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet(SHEET_NAME);
      const headers = [
        "رقم البلاغ", "نوع البلاغ", "تاريخ الإبلاغ", "مقدم البلاغ", "اسم المقدم", "رقم جوال المقدم",
        "الموقع", "وصف المشكلة", "المسؤول عن التنفيذ", "تاريخ الإتمام المتوقع", "رابط المرفقات (إن وجدت)"
      ];
      newSheet.appendRow(headers);
      newSheet.getRange("A1:K1").setFontWeight("bold").setBackground("#d9ead3");
      newSheet.setRightToLeft(true);
    }
    
    // Append data to the sheet
    const rowData = [
      data.reportNumber || "",
      data.reportCategory || "",
      data.reportDateTime || "",
      data.reporterType === 'employee' ? 'موظف' : 'مريض/زائر',
      data.reporterName || data.patientName || "",
      data.patientPhone || "",
      data.selectedLocations || "",
      data.incidentDescription || data.complaintDescription || "",
      data.responsiblePerson || "",
      data.completionDate || "",
      "" // Placeholder for attachments link
    ];
    
    sheet.appendRow(rowData);
    
    // Send email notification
    sendNotificationEmail(data);

    return ContentService.createTextOutput(JSON.stringify({ "result": "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log(error.toString());
    return ContentService.createTextOutput(JSON.stringify({ "result": "error", "message": error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function sendNotificationEmail(data) {
  const subject = `بلاغ جديد: ${data.reportCategory} - ${data.reportNumber}`;
  
  const reporterInfo = data.reporterType === 'employee' ? 
    `<li><strong>مقدم البلاغ:</strong> ${data.reporterName || 'غير محدد'} (موظف)</li>` :
    `<li><strong>مقدم البلاغ:</strong> ${data.patientName || 'غير محدد'} (مريض/زائر)</li>
     <li><strong>رقم الجوال:</strong> ${data.patientPhone || 'غير محدد'}</li>`;
  
  const body = `
    <html dir="rtl">
      <body style="font-family: Arial, sans-serif; text-align: right;">
        <h2>تم استلام بلاغ جديد في نظام إدارة الحوادث والشكاوى</h2>
        <p>الرجاء مراجعة التفاصيل أدناه واتخاذ الإجراءات اللازمة.</p>
        <ul style="list-style-type: none; padding: 0;">
          <li><strong>رقم البلاغ:</strong> ${data.reportNumber}</li>
          <li><strong>نوع البلاغ:</strong> ${data.reportCategory}</li>
          <li><strong>تاريخ ووقت البلاغ:</strong> ${new Date(data.reportDateTime).toLocaleString('ar-SA')}</li>
          ${reporterInfo}
          <li><strong>الموقع:</strong> ${data.selectedLocations}</li>
          <hr>
          <li><strong>وصف المشكلة:</strong><br><p style="padding-right: 20px;">${data.incidentDescription || data.complaintDescription}</p></li>
          <hr>
          <li><strong>المسؤول عن التنفيذ:</strong> ${data.responsiblePerson || 'غير محدد'}</li>
          <li><strong>تاريخ الإتمام المتوقع:</strong> ${data.completionDate || 'غير محدد'}</li>
        </ul>
        <p><em>هذه الرسالة تم إرسالها تلقائيًا من نظام البلاغات.</em></p>
      </body>
    </html>
  `;
  
  GmailApp.sendEmail(EMAIL_LIST, subject, "", { htmlBody: body });
}
