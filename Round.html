<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام جولات السلامة المطوّر – المجمع الطبي</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #1e3a5f;
      --primary-light: #2d5a8a;
      --crimson: #DC143C;
      --crimson-80: rgba(220, 20, 60, 0.8);
      --gold: #c9a962;
      --success: #198754;
      --warning: #ffc107;
      --danger: #dc3545;
    }
    body {
      font-family: 'Tajawal', system-ui, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
    }
    .navbar-custom {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
    }
    .navbar-custom .navbar-brand { color: #fff !important; }
    .logo-img {
      height: 42px;
      width: 42px;
      border-radius: 50%;
      object-fit: contain;
      background: var(--crimson-80);
      padding: 3px;
      margin-left: .5rem;
    }
    .nav-tabs .nav-link {
      color: var(--primary);
      font-weight: 600;
    }
    .nav-tabs .nav-link.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .card-custom {
      border-radius: 1rem;
      border: 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .station-card {
      border-radius: 1rem;
      border: 2px solid transparent;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: all 0.2s;
      padding: 1rem;
    }
    .station-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    .station-card.active {
      border-color: var(--crimson);
      background: #fff5f5;
    }
    .chip {
      border-radius: 20px;
      padding: 0.25rem 0.75rem;
      font-size: 0.8rem;
      display: inline-block;
    }
    .chip-success { background: #d1e7dd; color: #0f5132; }
    .chip-danger { background: #f8d7da; color: #842029; }
    .chip-warning { background: #fff3cd; color: #664d03; }
    .chip-info { background: #cff4fc; color: #055160; }
    .delayed-card {
      background: linear-gradient(135deg, #fff5f5, #ffe8e8);
      border-right: 4px solid var(--danger);
    }
    .violation-card {
      background: linear-gradient(135deg, #fff8e1, #ffecb3);
      border-right: 4px solid var(--warning);
    }
    .repeat-badge {
      background: var(--danger);
      color: #fff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
    }
    .spinner-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      z-index: 2000;
      backdrop-filter: blur(3px);
    }
    .filter-section {
      background: #fff;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .stats-mini {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .stat-box {
      background: #fff;
      padding: 1rem;
      border-radius: 0.75rem;
      text-align: center;
      flex: 1;
      min-width: 120px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .stat-box .number {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--primary);
    }
    .stat-box.danger .number { color: var(--danger); }
    .stat-box.warning .number { color: #d97706; }
    .stat-box.success .number { color: var(--success); }
    .text-crimson { color: var(--crimson); }
    .btn-start-round {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #78350f;
      border: none;
      font-weight: 600;
      padding: 0.4rem 1rem;
      border-radius: 20px;
    }
    .btn-start-round:hover { background: #f59e0b; color: #451a03; }
    .btn-completed {
      background: #d1fae5;
      color: #065f46;
      border: none;
      font-weight: 600;
      padding: 0.4rem 1rem;
      border-radius: 20px;
    }
    .checklist-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      background: #fafafa;
      border: 1px solid #e5e7eb;
    }
    .checklist-item .item-text { flex: 1; font-size: 0.95rem; }
    .checklist-btns { display: flex; gap: 0.5rem; }
    .checklist-btns .btn { min-width: 60px; }
    .btn-yes { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .btn-yes.active { background: #10b981; color: white; border-color: #10b981; }
    .btn-no { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .btn-no.active { background: #ef4444; color: white; border-color: #ef4444; }
    .staff-card-detailed {
      background: #fff;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .staff-card-detailed:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .staff-card-detailed.active { border-color: var(--crimson); background: #fff5f5; }
    .staff-stats { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .staff-stat { 
      background: #f3f4f6; 
      padding: 0.25rem 0.5rem; 
      border-radius: 6px; 
      font-size: 0.8rem;
    }
    .staff-stat.done { background: #d1fae5; color: #065f46; }
    .staff-stat.remaining { background: #fef3c7; color: #92400e; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-custom shadow-sm">
    <div class="container-fluid px-4">
      <span class="navbar-brand fw-bold d-flex align-items-center">
        <img src="logo-new.png" alt="شعار مجمع مكة الطبي" class="logo-img" />
        <span>نظام جولات السلامة المطوّر</span>
      </span>
      <span class="navbar-text small ms-auto text-white" id="todayInfoText"></span>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="today-tab" data-bs-toggle="tab" data-bs-target="#todayPane" type="button">
          <i class="fas fa-calendar-day me-1"></i> اليوم
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboardPane" type="button">
          <i class="fas fa-chart-line me-1"></i> لوحة التحكم
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="delayed-tab" data-bs-toggle="tab" data-bs-target="#delayedPane" type="button">
          <i class="fas fa-clock me-1"></i> المتأخرون
          <span class="badge bg-danger ms-1" id="delayedCount">0</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="violations-tab" data-bs-toggle="tab" data-bs-target="#violationsPane" type="button">
          <i class="fas fa-exclamation-triangle me-1"></i> المخالفات
          <span class="badge bg-warning text-dark ms-1" id="violationsCount">0</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#historyPane" type="button">
          <i class="fas fa-history me-1"></i> التاريخ
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Today Tab -->
      <div class="tab-pane fade show active" id="todayPane">
        <div class="row g-3">
          <!-- Main Content - Left Side -->
          <div class="col-lg-8">
            <!-- Staff Tasks Card -->
            <div class="card card-custom mb-3" id="staffTasksCard" style="display:none;">
              <div class="card-header" style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border-bottom: 2px solid #DC143C;">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0" style="color: #DC143C;">
                    <i class="fas fa-clipboard-list me-2"></i>
                    مهام اليوم للمسؤول: <span id="selectedStaffName" class="fw-bold"></span>
                  </h5>
                  <div class="d-flex gap-2">
                    <span class="badge bg-secondary">مهام اليوم: <span id="staffTodayTotal">0</span></span>
                    <span class="badge bg-success">منجز: <span id="staffTodayDone">0</span></span>
                    <span class="badge bg-warning text-dark">متبقي: <span id="staffTodayRemaining">0</span></span>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <table class="table table-hover mb-0">
                  <thead style="background: #f8f9fa;">
                    <tr>
                      <th style="padding: 0.75rem 1rem;">الجولة</th>
                      <th class="text-center" style="width: 120px;">منفذة / مطلوبة اليوم</th>
                      <th class="text-center" style="width: 100px;">الوقت المستهدف</th>
                      <th class="text-center" style="width: 120px;">الحالة</th>
                    </tr>
                  </thead>
                  <tbody id="staffTasksTableBody"></tbody>
                </table>
              </div>
            </div>
            
            <!-- Checklist Form Card -->
            <div id="checklistFormCard" class="card card-custom mb-3" style="display:none;">
              <div class="card-header" style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-bottom: 2px solid #10b981;">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-0" style="color: #047857;"><i class="fas fa-clipboard-check me-2"></i>نموذج التحقق للجولة المختارة</h6>
                    <div class="small text-muted mt-1" id="checklistRoundName"></div>
                  </div>
                  <div id="checklistProgress" class="text-end">
                    <span class="badge bg-light text-dark">عناصر الفحص: <span id="checklistItemsCount">0</span></span>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div id="checklistItems" class="mb-3"></div>
                
                <div class="row g-3 p-3" style="background: #f8fafc; border-radius: 8px;">
                  <div class="col-md-6">
                    <label class="form-label fw-bold small">مسؤول التنفيذ (في حال وجود خلل)</label>
                    <select class="form-select form-select-sm" id="checklistResponsible">
                      <option value="">لا يوجد (لا حاجة لإجراء)</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold small">ملاحظات إضافية</label>
                    <textarea class="form-control form-control-sm" id="checklistNotes" rows="2" placeholder="أي ملاحظات..."></textarea>
                  </div>
                </div>
                
                <div class="d-flex justify-content-between mt-3">
                  <button class="btn btn-outline-secondary" onclick="cancelChecklist()"><i class="fas fa-times me-1"></i>إلغاء</button>
                  <button class="btn btn-success px-4" onclick="submitChecklist()">
                    <i class="fas fa-save me-1"></i> حفظ الجولة
                  </button>
                </div>
              </div>
            </div>

            <!-- Log Table -->
            <div class="card card-custom">
              <div class="card-header bg-white border-0 py-2">
                <h6 class="mb-0"><i class="fas fa-list-alt text-secondary me-2"></i>سجل جولات اليوم <small class="text-muted">(يتم السحب مباشرة من Rounds_Log)</small></h6>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                  <table class="table table-sm table-hover mb-0">
                    <thead style="background: #f8f9fa; position: sticky; top: 0;">
                      <tr>
                        <th style="width: 70px;">الوقت</th>
                        <th>الجولة</th>
                        <th style="width: 100px;">المسؤول</th>
                        <th style="width: 80px;">مسؤول التنفيذ</th>
                        <th style="width: 70px;">الحالة</th>
                        <th>ملخص الخلل</th>
                      </tr>
                    </thead>
                    <tbody id="roundsLogBody">
                      <tr><td colspan="6" class="text-center text-muted">جاري التحميل...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Staff Cards - Right Side -->
          <div class="col-lg-4">
            <div class="card card-custom mb-3">
              <div class="card-header bg-white border-0 py-2">
                <h6 class="mb-0"><i class="fas fa-users text-primary me-2"></i>محطات المسؤولين</h6>
                <small class="text-muted">الأسماء تُسحب تلقائياً من عمود Assigned_To في MASTER_TASKS</small>
              </div>
              <div class="card-body" id="stationCardsContainer" style="max-height: 600px; overflow-y: auto;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Tab -->
      <div class="tab-pane fade" id="dashboardPane">
        <div class="row g-4 mb-4">
          <div class="col-md-3">
            <div class="stat-box">
              <div class="number" id="dashTotalRounds">0</div>
              <div class="small text-muted">إجمالي الجولات</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box success">
              <div class="number" id="dashCompleted">0</div>
              <div class="small text-muted">مكتملة</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box danger">
              <div class="number" id="dashDelayed">0</div>
              <div class="small text-muted">متأخرة</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
              <div class="number" id="dashCompliance" style="color: #059669;">0%</div>
              <div class="small text-muted">نسبة الامتثال</div>
            </div>
          </div>
        </div>
        
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="card card-custom">
              <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="fas fa-chart-area text-primary me-2"></i>أداء الجولات (آخر 14 يوم)</h6>
              </div>
              <div class="card-body">
                <canvas id="trendChart" height="200"></canvas>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card card-custom">
              <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="fas fa-chart-pie text-primary me-2"></i>توزيع الحالات</h6>
              </div>
              <div class="card-body">
                <canvas id="statusChart" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row g-4 mt-2">
          <div class="col-lg-6">
            <div class="card card-custom">
              <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="fas fa-user-tie text-primary me-2"></i>أداء المسؤولين</h6>
              </div>
              <div class="card-body">
                <canvas id="staffChart" height="200"></canvas>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-custom">
              <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="fas fa-map-marker-alt text-primary me-2"></i>الأداء حسب المنطقة</h6>
              </div>
              <div class="card-body">
                <canvas id="areaChart" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Delayed Tab -->
      <div class="tab-pane fade" id="delayedPane">
        <div class="filter-section">
          <h5 class="mb-3"><i class="fas fa-clock text-danger me-2"></i>الجولات المتأخرة</h5>
          <p class="text-muted small">هنا تظهر جميع الجولات التي تجاوزت وقتها المحدد</p>
        </div>
        <div id="delayedList" class="row g-3"></div>
      </div>

      <!-- Violations Tab -->
      <div class="tab-pane fade" id="violationsPane">
        <div class="filter-section">
          <h5 class="mb-3"><i class="fas fa-exclamation-triangle text-warning me-2"></i>المخالفات والتكرارات</h5>
          <p class="text-muted small">المخالفات المرصودة مع تتبع التكرار لنفس المشكلة</p>
        </div>
        
        <h6 class="fw-bold mb-3"><i class="fas fa-redo text-danger me-2"></i>مخالفات متكررة (تحتاج تدخل)</h6>
        <div id="repeatedViolationsList" class="row g-3 mb-4"></div>
        
        <h6 class="fw-bold mb-3"><i class="fas fa-list text-warning me-2"></i>جميع المخالفات</h6>
        <div id="allViolationsList" class="row g-3"></div>
      </div>

      <!-- History Tab -->
      <div class="tab-pane fade" id="historyPane">
        <div class="filter-section">
          <h5 class="mb-3"><i class="fas fa-history text-primary me-2"></i>سجل الجولات التاريخي</h5>
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label small">من تاريخ</label>
              <input type="date" class="form-control" id="historyStartDate" />
            </div>
            <div class="col-md-3">
              <label class="form-label small">إلى تاريخ</label>
              <input type="date" class="form-control" id="historyEndDate" />
            </div>
            <div class="col-md-3">
              <label class="form-label small">المسؤول</label>
              <select class="form-select" id="historyStaffFilter">
                <option value="">الكل</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-primary w-100" onclick="loadHistory()">
                <i class="fas fa-search me-1"></i> بحث
              </button>
            </div>
          </div>
        </div>
        
        <div class="card card-custom">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>التاريخ</th>
                    <th>الوقت</th>
                    <th>الجولة</th>
                    <th>المسؤول</th>
                    <th>مسؤول التنفيذ</th>
                    <th>الحالة</th>
                    <th>ملاحظات</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody">
                  <tr><td colspan="7" class="text-center text-muted">اختر الفلاتر واضغط بحث</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="spinnerOverlay" class="spinner-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <div class="fw-semibold">جاري تحميل البيانات...</div>
    </div>
  </div>

  <button class="btn btn-lg rounded-circle shadow-lg position-fixed" 
          style="bottom: 2rem; left: 2rem; width: 60px; height: 60px; background: var(--crimson); color: white; z-index: 1000;"
          data-bs-toggle="modal" data-bs-target="#roundFormModal" title="تسجيل جولة جديدة">
    <i class="fas fa-plus fa-lg"></i>
  </button>

  <div class="modal fade" id="roundFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background: var(--primary); color: white;">
          <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>تسجيل جولة رقابية</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="roundForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label fw-bold">المسؤول <span class="text-danger">*</span></label>
                <select class="form-select" id="formStaff" required>
                  <option value="">اختر المسؤول...</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">منفذ الجولة</label>
                <input type="text" class="form-control" id="formExecResponsible" placeholder="اسم المنفذ (اختياري)">
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">الجولة <span class="text-danger">*</span></label>
                <select class="form-select" id="formRound" required>
                  <option value="">اختر الجولة...</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">الحالة <span class="text-danger">*</span></label>
                <select class="form-select" id="formStatus" required>
                  <option value="في الوقت">في الوقت - مكتمل</option>
                  <option value="متأخر">متأخر</option>
                  <option value="خلل">يوجد خلل / مخالفة</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">وقت التنفيذ</label>
                <input type="time" class="form-control" id="formTime">
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">ملاحظات إيجابية</label>
                <textarea class="form-control" id="formPositiveNotes" rows="2" placeholder="نقاط القوة والإيجابيات..."></textarea>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">نقاط الخلل / المخالفات</label>
                <textarea class="form-control" id="formNegativeNotes" rows="2" placeholder="المشاكل والملاحظات السلبية (إن وجدت)..."></textarea>
              </div>
              <div class="col-12">
                <label class="form-label fw-bold">الإجراءات المتخذة</label>
                <textarea class="form-control" id="formActions" rows="2" placeholder="ما تم فعله لحل المشكلة (إن وجد)..."></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button type="button" class="btn btn-success" onclick="submitRoundForm()">
            <i class="fas fa-save me-1"></i> حفظ الجولة
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let MASTER_TASKS = [];
    let ROUNDS_LOG = [];
    let STAFF_LIST = [];
    let DELAYED_LIST = [];
    let VIOLATIONS_DATA = { violations: [], repeated: [] };

    document.addEventListener('DOMContentLoaded', () => {
      updateTodayHeader();
      loadAllData();
    });

    function showSpinner(show) {
      document.getElementById('spinnerOverlay').style.display = show ? 'flex' : 'none';
    }

    function updateTodayHeader() {
      const today = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('todayInfoText').textContent = today.toLocaleDateString('ar-SA', options);
    }

    async function loadAllData() {
      showSpinner(true);
      try {
        await Promise.all([
          loadMasterTasks(),
          loadRoundsLog(),
          loadStaffList(),
          loadDelayed(),
          loadViolations(),
          loadStaffSummary()
        ]);
        updateStats();
      } catch (err) {
        console.error('Load error:', err);
      } finally {
        showSpinner(false);
      }
    }

    async function loadMasterTasks() {
      try {
        const res = await fetch('/api/rounds/master-tasks');
        const data = await res.json();
        if (data.ok) {
          MASTER_TASKS = data.tasks;
          renderStationCards();
        }
      } catch (err) {
        console.error('Master tasks error:', err);
      }
    }

    async function loadRoundsLog() {
      try {
        const res = await fetch('/api/rounds/log');
        const data = await res.json();
        if (data.ok) {
          ROUNDS_LOG = data.entries;
          renderRoundsLog();
        }
      } catch (err) {
        console.error('Rounds log error:', err);
      }
    }

    async function loadStaffList() {
      try {
        const res = await fetch('/api/rounds/staff');
        const data = await res.json();
        if (data.ok) {
          STAFF_LIST = data.staff;
          populateStaffFilter();
        }
      } catch (err) {
        console.error('Staff list error:', err);
      }
    }

    async function loadDelayed() {
      try {
        const res = await fetch('/api/rounds/delayed');
        const data = await res.json();
        if (data.ok) {
          DELAYED_LIST = data.delayed;
          document.getElementById('delayedCount').textContent = DELAYED_LIST.length;
          renderDelayedList();
        }
      } catch (err) {
        console.error('Delayed error:', err);
      }
    }

    async function loadViolations() {
      try {
        const res = await fetch('/api/rounds/violations');
        const data = await res.json();
        if (data.ok) {
          VIOLATIONS_DATA = data;
          document.getElementById('violationsCount').textContent = data.violations.length;
          renderViolations();
        }
      } catch (err) {
        console.error('Violations error:', err);
      }
    }

    function updateStats() {
      const todayStr = new Date().toLocaleDateString('en-CA');
      const todayTasks = MASTER_TASKS.filter(t => {
        const dayMap = { 0: 'Sun', 1: 'Mon', 2: 'Tue', 3: 'Wed', 4: 'Thu', 5: 'Fri', 6: 'Sat' };
        const today = new Date().getDay();
        const dayKey = dayMap[today];
        return t[dayKey] && t[dayKey].toLowerCase() === 'yes';
      });
      
      const total = todayTasks.reduce((sum, t) => sum + (parseInt(t.Rounds_Per_Day) || 0), 0);
      const todayLogs = ROUNDS_LOG.filter(r => r.Date && r.Date.includes(todayStr.split('-')[2]));
      const done = todayLogs.filter(r => r.Status !== 'متأخر').length;
      const delayed = DELAYED_LIST.length;
      
      const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      setEl('statTotal', total);
      setEl('statDone', done);
      setEl('statPending', Math.max(0, total - done - delayed));
      setEl('statDelayed', delayed);
    }

    let STAFF_SUMMARY = [];
    let currentChecklist = null;
    let selectedStaffData = null;
    
    async function loadStaffSummary() {
      try {
        const res = await fetch('/api/rounds/staff-summary');
        const data = await res.json();
        if (data.ok) {
          STAFF_SUMMARY = data.staffSummary;
          renderStationCards();
        }
      } catch (err) {
        console.error('Staff summary error:', err);
      }
    }

    function renderStationCards() {
      const container = document.getElementById('stationCardsContainer');
      
      if (!STAFF_SUMMARY.length) {
        container.innerHTML = '<div class="text-muted text-center py-3">لا توجد بيانات</div>';
        return;
      }
      
      container.innerHTML = STAFF_SUMMARY.map(s => {
        const percent = s.todayTasks > 0 ? Math.round((s.todayDone / s.todayTasks) * 100) : 0;
        const progressColor = percent >= 100 ? '#10b981' : percent >= 50 ? '#f59e0b' : '#ef4444';
        
        return `
        <div class="staff-card-detailed" onclick="selectStaff('${s.name}', this)">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center">
              <div class="me-2" style="width:32px;height:32px;background:#f3f4f6;border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <i class="fas fa-user" style="color:#6b7280;"></i>
              </div>
              <div>
                <div class="fw-bold">${s.name}</div>
                <div class="small text-muted">مسؤول عن جولات السلامة حسب MASTER_TASKS</div>
              </div>
            </div>
          </div>
          <div class="d-flex gap-2 mb-2">
            <span class="badge" style="background:#dbeafe;color:#1e40af;">مهام اليوم: ${s.todayTasks}</span>
            <span class="badge" style="background:#d1fae5;color:#065f46;">منجز ${s.todayDone}</span>
            <span class="badge" style="background:#fef3c7;color:#92400e;">متبقي: ${s.todayRemaining}</span>
          </div>
          <div class="small text-muted mb-2">إجمالي مهام الأسبوع (حسب Yes في الأيام): ${s.weeklyTotal}</div>
          ${s.topRounds.length ? `
            <div class="small" style="border-top:1px dashed #e5e7eb;padding-top:0.5rem;">
              <strong style="color:#374151;">أهم جولات اليوم:</strong>
              <ul class="mb-0 ps-3" style="font-size:0.8rem;color:#6b7280;">
                ${s.topRounds.slice(0,3).map(r => `<li>${r.name.substring(0,35)}${r.name.length>35?'...':''} - تكرار x${r.roundsRequired}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      `}).join('');
    }

    function selectStaff(staffName, el) {
      document.querySelectorAll('.staff-card-detailed').forEach(c => c.classList.remove('active'));
      el?.classList.add('active');
      
      selectedStaffData = STAFF_SUMMARY.find(s => s.name === staffName);
      if (!selectedStaffData) return;
      
      document.getElementById('staffTasksCard').style.display = 'block';
      document.getElementById('checklistFormCard').style.display = 'none';
      document.getElementById('selectedStaffName').textContent = staffName;
      document.getElementById('staffTodayTotal').textContent = selectedStaffData.todayTasks;
      document.getElementById('staffTodayDone').textContent = selectedStaffData.todayDone;
      document.getElementById('staffTodayRemaining').textContent = selectedStaffData.todayRemaining;
      
      const tbody = document.getElementById('staffTasksTableBody');
      
      if (!selectedStaffData.topRounds.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">لا توجد مهام لهذا اليوم</td></tr>';
        return;
      }
      
      tbody.innerHTML = selectedStaffData.topRounds.map(r => {
        const isComplete = r.done >= r.roundsRequired;
        const statusBtn = isComplete 
          ? `<button class="btn btn-completed"><i class="fas fa-check me-1"></i>مكتملة</button>`
          : `<button class="btn btn-start-round" onclick="startRound('${r.taskId}', '${r.name}')"><i class="fas fa-play me-1"></i>بدء الجولة</button>`;
        
        return `
          <tr>
            <td>${r.name}</td>
            <td class="text-center"><strong>${r.done}</strong>/${r.roundsRequired}</td>
            <td class="text-center">${r.targetTime || '-'}</td>
            <td class="text-center">${statusBtn}</td>
          </tr>
        `;
      }).join('');
    }
    
    async function startRound(taskId, roundName) {
      showSpinner(true);
      try {
        const res = await fetch('/api/rounds/checklist/' + taskId);
        const data = await res.json();
        
        if (!data.ok) {
          alert('حدث خطأ في تحميل قائمة الفحص');
          return;
        }
        
        currentChecklist = { taskId, roundName, task: data.task, items: data.checklist, responsibles: data.responsibles };
        renderChecklistForm();
      } catch (err) {
        console.error('Checklist error:', err);
        alert('خطأ في الاتصال');
      } finally {
        showSpinner(false);
      }
    }
    
    function renderChecklistForm() {
      document.getElementById('checklistFormCard').style.display = 'block';
      document.getElementById('checklistRoundName').textContent = 
        `الجولة: ${currentChecklist.roundName} - المسؤول: ${selectedStaffData?.name || ''}`;
      
      const container = document.getElementById('checklistItems');
      
      if (!currentChecklist.items.length) {
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            لا توجد قائمة فحص محددة لهذه الجولة. يمكنك إضافة ملاحظات أدناه.
          </div>
        `;
      } else {
        container.innerHTML = currentChecklist.items.map(item => `
          <div class="checklist-item" data-id="${item.id}">
            <span class="item-text">${item.item}</span>
            <div class="checklist-btns">
              <button class="btn btn-sm btn-no" onclick="setChecklistAnswer(${item.id}, false, this)">لا</button>
              <button class="btn btn-sm btn-yes" onclick="setChecklistAnswer(${item.id}, true, this)">نعم</button>
            </div>
          </div>
        `).join('');
      }
      
      const respSelect = document.getElementById('checklistResponsible');
      respSelect.innerHTML = '<option value="">لا يوجد (لا حاجة لإجراء)</option>';
      currentChecklist.responsibles.forEach(r => {
        respSelect.innerHTML += `<option value="${r}">${r}</option>`;
      });
      
      document.getElementById('checklistFormCard').scrollIntoView({ behavior: 'smooth' });
    }
    
    function setChecklistAnswer(itemId, isYes, btn) {
      const item = btn.closest('.checklist-item');
      item.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      const itemData = currentChecklist.items.find(i => i.id === itemId);
      if (itemData) itemData.answer = isYes;
    }
    
    function cancelChecklist() {
      document.getElementById('checklistFormCard').style.display = 'none';
      currentChecklist = null;
    }
    
    async function submitChecklist() {
      if (!currentChecklist) return;
      
      const hasIssues = currentChecklist.items.some(i => i.answer === false);
      const responsible = document.getElementById('checklistResponsible').value;
      const notes = document.getElementById('checklistNotes').value;
      
      let status = 'في الوقت';
      let negativeNotes = '';
      
      if (hasIssues) {
        const issues = currentChecklist.items.filter(i => i.answer === false).map(i => i.item);
        negativeNotes = 'نقاط الخلل: ' + issues.join('، ');
        status = responsible ? 'خلل' : 'في الوقت';
      }
      
      const now = new Date();
      const payload = {
        date: now.toLocaleDateString('en-US'),
        time: now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'}),
        roundName: currentChecklist.roundName,
        staff: selectedStaffData?.name || '',
        execResponsible: responsible,
        status: status,
        positiveNotes: currentChecklist.items.filter(i => i.answer === true).map(i => i.item).join('، '),
        negativeNotes: negativeNotes + (notes ? ' | ' + notes : ''),
        actionsTaken: ''
      };
      
      showSpinner(true);
      try {
        const res = await fetch('/api/rounds/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('تم حفظ الجولة بنجاح!');
          cancelChecklist();
          loadAllData();
        } else {
          alert('حدث خطأ: ' + (data.error || 'غير معروف'));
        }
      } catch (err) {
        console.error('Submit error:', err);
        alert('حدث خطأ في الاتصال');
      } finally {
        showSpinner(false);
      }
    }

    function renderRoundsLog() {
      const tbody = document.getElementById('roundsLogBody');
      
      if (!ROUNDS_LOG.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">لا توجد جولات مسجلة اليوم</td></tr>';
        return;
      }
      
      tbody.innerHTML = ROUNDS_LOG.slice(0, 50).map(entry => {
        const status = entry.Status || '';
        let statusClass = 'bg-secondary';
        let statusText = status || 'تم';
        if (status === 'متأخر') { statusClass = 'bg-danger'; statusText = 'متأخر'; }
        else if (status === 'في الوقت' || status === 'مكتمل' || status === 'مكتملة') { statusClass = 'bg-success'; statusText = 'مكتملة'; }
        else if (status === 'خلل') { statusClass = 'bg-warning text-dark'; statusText = 'متأخر'; }
        
        return `
          <tr>
            <td class="small">${entry.Actual_Time || entry.Date?.split(' ')[1] || '-'}</td>
            <td class="small text-truncate" style="max-width:200px;" title="${entry.Area || entry.Round_Name || '-'}">${entry.Area || entry.Round_Name || '-'}</td>
            <td class="small">${entry.Staff || entry.Responsible_Role || '-'}</td>
            <td class="small">${entry.Exec_Responsible || '-'}</td>
            <td><span class="badge ${statusClass} rounded-pill" style="font-size: 0.7rem;">${statusText}</span></td>
            <td class="small text-truncate" style="max-width:150px;" title="${entry.Negative_Notes || ''}">${entry.Negative_Notes || '-'}</td>
          </tr>
        `;
      }).join('');
    }

    function renderDelayedList() {
      const container = document.getElementById('delayedList');
      
      if (!DELAYED_LIST.length) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>لا توجد جولات متأخرة - ممتاز!</div></div>';
        return;
      }
      
      container.innerHTML = DELAYED_LIST.map(d => `
        <div class="col-md-6 col-lg-4">
          <div class="card card-custom delayed-card p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="fw-bold mb-0">${d.Area || d.Round_Name || 'جولة'}</h6>
              <span class="badge bg-danger">${d.Delay_Min || 0} دقيقة تأخير</span>
            </div>
            <div class="small text-muted mb-1"><i class="fas fa-user me-1"></i>${d.Responsible_Role || d.Staff || '-'}</div>
            <div class="small text-muted mb-1"><i class="fas fa-clock me-1"></i>الوقت المحدد: ${d.Planned_Time || '-'}</div>
            <div class="small text-muted"><i class="fas fa-calendar me-1"></i>${d.Date || '-'}</div>
          </div>
        </div>
      `).join('');
    }

    function renderViolations() {
      const repeatedContainer = document.getElementById('repeatedViolationsList');
      const allContainer = document.getElementById('allViolationsList');
      
      if (!VIOLATIONS_DATA.repeated.length) {
        repeatedContainer.innerHTML = '<div class="col-12"><div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>لا توجد مخالفات متكررة</div></div>';
      } else {
        repeatedContainer.innerHTML = VIOLATIONS_DATA.repeated.map(v => `
          <div class="col-md-6 col-lg-4">
            <div class="card card-custom violation-card p-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="fw-bold mb-0">${v.area || 'منطقة'}</h6>
                <span class="repeat-badge">${v.count}</span>
              </div>
              <div class="small mb-2">${v.issue || 'مخالفة غير محددة'}</div>
              <div class="small text-muted"><i class="fas fa-user me-1"></i>المكلف: ${v.assignedTo || 'غير محدد'}</div>
              <div class="small text-muted"><i class="fas fa-calendar me-1"></i>آخر تكرار: ${v.dates[v.dates.length-1] || '-'}</div>
            </div>
          </div>
        `).join('');
      }
      
      if (!VIOLATIONS_DATA.violations.length) {
        allContainer.innerHTML = '<div class="col-12"><div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>لا توجد مخالفات مسجلة</div></div>';
      } else {
        allContainer.innerHTML = VIOLATIONS_DATA.violations.slice(0, 12).map(v => `
          <div class="col-md-6 col-lg-4">
            <div class="card card-custom p-3">
              <h6 class="fw-bold mb-1">${v.Area || v.Round_Name || 'جولة'}</h6>
              <div class="small mb-2">${v.Negative_Notes || v.NegativeNotes || 'خلل'}</div>
              <div class="small text-muted"><i class="fas fa-calendar me-1"></i>${v.Date || '-'}</div>
            </div>
          </div>
        `).join('');
      }
    }

    function populateStaffFilter() {
      const historySelect = document.getElementById('historyStaffFilter');
      const formSelect = document.getElementById('formStaff');
      
      STAFF_LIST.forEach(s => {
        const opt1 = document.createElement('option');
        opt1.value = s;
        opt1.textContent = s;
        historySelect.appendChild(opt1);
        
        const opt2 = document.createElement('option');
        opt2.value = s;
        opt2.textContent = s;
        formSelect.appendChild(opt2);
      });
      
      const roundSelect = document.getElementById('formRound');
      const uniqueRounds = [...new Set(MASTER_TASKS.map(t => t.Round_Name || t.Area))].filter(Boolean);
      uniqueRounds.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        roundSelect.appendChild(opt);
      });
    }
    
    async function submitRoundForm() {
      const staff = document.getElementById('formStaff').value;
      const roundName = document.getElementById('formRound').value;
      const status = document.getElementById('formStatus').value;
      
      if (!staff || !roundName) {
        alert('الرجاء اختيار المسؤول والجولة');
        return;
      }
      
      const now = new Date();
      const payload = {
        date: now.toLocaleDateString('en-US'),
        time: document.getElementById('formTime').value || now.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'}),
        roundName: roundName,
        staff: staff,
        execResponsible: document.getElementById('formExecResponsible').value,
        status: status,
        positiveNotes: document.getElementById('formPositiveNotes').value,
        negativeNotes: document.getElementById('formNegativeNotes').value,
        actionsTaken: document.getElementById('formActions').value
      };
      
      showSpinner(true);
      try {
        const res = await fetch('/api/rounds/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        
        if (data.ok) {
          alert('تم حفظ الجولة بنجاح!');
          document.getElementById('roundForm').reset();
          bootstrap.Modal.getInstance(document.getElementById('roundFormModal')).hide();
          loadAllData();
        } else {
          alert('حدث خطأ: ' + (data.error || 'غير معروف'));
        }
      } catch (err) {
        console.error('Submit error:', err);
        alert('حدث خطأ في الاتصال');
      } finally {
        showSpinner(false);
      }
    }

    async function loadHistory() {
      const startDate = document.getElementById('historyStartDate').value;
      const endDate = document.getElementById('historyEndDate').value;
      const staff = document.getElementById('historyStaffFilter').value;
      
      const params = new URLSearchParams();
      if (startDate) params.append('startDate', startDate);
      if (endDate) params.append('endDate', endDate);
      if (staff) params.append('staff', staff);
      
      showSpinner(true);
      try {
        const res = await fetch('/api/rounds/history?' + params.toString());
        const data = await res.json();
        
        const tbody = document.getElementById('historyTableBody');
        if (!data.ok || !data.entries.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">لا توجد نتائج</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.entries.map(e => {
          const statusClass = e.Status === 'متأخر' ? 'bg-warning text-dark' : 
                             e.Status === 'في الوقت' ? 'bg-success' : 'bg-secondary';
          return `
            <tr>
              <td class="small">${e.Date?.split(' ')[0] || '-'}</td>
              <td class="small">${e.Actual_Time || e.Date?.split(' ')[1] || '-'}</td>
              <td class="small">${e.Area || e.Round_Name || '-'}</td>
              <td class="small">${e.Responsible_Role || e.Staff || '-'}</td>
              <td class="small">${e.Execution_Responsible || '-'}</td>
              <td><span class="badge ${statusClass}">${e.Status || 'تم'}</span></td>
              <td class="small">${e.Negative_Notes || '-'}</td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        console.error('History error:', err);
      } finally {
        showSpinner(false);
      }
    }

    let chartsLoaded = false;
    let trendChart, statusChart, staffChart, areaChart;
    
    document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', () => {
      if (!chartsLoaded) {
        loadDashboardData();
        chartsLoaded = true;
      }
    });
    
    async function loadDashboardData() {
      try {
        const res = await fetch('/api/rounds/metrics');
        const data = await res.json();
        
        if (!data.ok) return;
        
        const m = data.metrics;
        document.getElementById('dashTotalRounds').textContent = m.totalRounds;
        document.getElementById('dashCompleted').textContent = m.completed;
        document.getElementById('dashDelayed').textContent = m.delayed;
        document.getElementById('dashCompliance').textContent = m.complianceRate + '%';
        
        renderTrendChart(m.byDay);
        renderStatusChart(m);
        renderStaffChart(m.byStaff);
        renderAreaChart(m.byArea);
      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }
    
    function renderTrendChart(byDay) {
      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChart) trendChart.destroy();
      
      const labels = byDay.map(d => d.date.split('-').slice(1).join('/'));
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'مكتملة', data: byDay.map(d => d.completed), borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', fill: true, tension: 0.3 },
            { label: 'متأخرة', data: byDay.map(d => d.delayed), borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.1)', fill: true, tension: 0.3 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
      });
    }
    
    function renderStatusChart(m) {
      const ctx = document.getElementById('statusChart').getContext('2d');
      if (statusChart) statusChart.destroy();
      
      statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['مكتملة', 'متأخرة', 'مخالفات'],
          datasets: [{
            data: [m.completed, m.delayed, m.violations],
            backgroundColor: ['#198754', '#dc3545', '#ffc107']
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }
    
    function renderStaffChart(byStaff) {
      const ctx = document.getElementById('staffChart').getContext('2d');
      if (staffChart) staffChart.destroy();
      
      const labels = Object.keys(byStaff).slice(0, 6);
      const completed = labels.map(l => byStaff[l].completed);
      const delayed = labels.map(l => byStaff[l].delayed);
      
      staffChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'مكتملة', data: completed, backgroundColor: '#198754' },
            { label: 'متأخرة', data: delayed, backgroundColor: '#dc3545' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
      });
    }
    
    function renderAreaChart(byArea) {
      const ctx = document.getElementById('areaChart').getContext('2d');
      if (areaChart) areaChart.destroy();
      
      const sorted = Object.entries(byArea).sort((a, b) => b[1].total - a[1].total).slice(0, 6);
      const labels = sorted.map(([k]) => k.length > 25 ? k.slice(0, 25) + '...' : k);
      const completed = sorted.map(([, v]) => v.completed);
      const delayed = sorted.map(([, v]) => v.delayed);
      
      areaChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'مكتملة', data: completed, backgroundColor: '#198754' },
            { label: 'متأخرة', data: delayed, backgroundColor: '#dc3545' }
          ]
        },
        options: { indexAxis: 'y', responsive: true, plugins: { legend: { position: 'top' } } }
      });
    }
  </script>
</body>
</html>
