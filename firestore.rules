rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====

    function isAuthenticated() {
      return request.auth != null;
    }

    // ğŸ‘‘ Owner (bypass ÙƒØ§Ù…Ù„)
    function isOwner() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.role == 'owner';
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.role == 'admin';
    }

    function isPrivileged() {
      return isOwner() || isAdmin();
    }

    // ğŸ” ØµÙ„Ø§Ø­ÙŠØ© Ù†Ø¸Ø§Ù… Ù…Ø­Ø¯Ø¯ (RBAC)
    // Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø· ÙŠØªØ¬Ø§ÙˆØ² - Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ®Ø¶Ø¹ Ù„Ù€ permissions
    function hasPermission(key) {
      return isOwner() ||
        (isAuthenticated() &&
         exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.permissions[key] == true);
    }

    // ===== staff_roles (Ø£Ù‡Ù… Collection) =====
    match /staff_roles/{userId} {

      allow read: if isAuthenticated() &&
        (request.auth.uid == userId || isPrivileged());

      allow create: if isPrivileged() &&
        (request.resource.data.role != 'owner' || isOwner());

      allow update: if isPrivileged() &&
        (request.resource.data.role != 'owner' || isOwner()) &&
        (resource.data.role != 'owner' || isOwner());

      allow delete: if isOwner();
    }

    // ===== Deleted staff (Ø£Ø±Ø´ÙŠÙ) =====
    match /deleted_staff/{userId} {
      allow read, create, update, delete: if isOwner();
    }

    // ===== Audit log =====
    match /audit_log/{logId} {
      allow read: if isPrivileged();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ===== Alerts =====
    match /alerts/{alertId} {
      allow read, write: if isPrivileged();
    }

    // ===== Membership Requests =====
    match /membershipRequests/{requestId} {

      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.status == 'pending';

      allow read: if isAuthenticated() &&
        (resource.data.uid == request.auth.uid || isPrivileged());

      allow update, delete: if isPrivileged();
    }

    // ===== System-specific collections =====
    // read, create, update = Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    // delete = Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·
    
    match /complaints/{docId} {
      allow read, create, update: if hasPermission('complaints');
      allow delete: if isOwner();
    }
    
    match /incidents/{docId} {
      allow read, create, update: if hasPermission('incidents');
      allow delete: if isOwner();
    }
    
    match /risks/{docId} {
      allow read, create, update: if hasPermission('risks');
      allow delete: if isOwner();
    }
    
    match /rounds/{docId} {
      allow read, create, update: if hasPermission('rounds');
      allow delete: if isOwner();
    }
    
    match /calibration/{docId} {
      allow read, create, update: if hasPermission('calibration');
      allow delete: if isOwner();
    }
    
    match /maintenance/{docId} {
      allow read, create, update: if hasPermission('maintenance');
      allow delete: if isOwner();
    }
    
    match /needlestick/{docId} {
      allow read, create, update: if hasPermission('needlestick');
      allow delete: if isOwner();
    }
    
    match /insurance/{docId} {
      allow read, create, update: if hasPermission('insurance');
      allow delete: if isOwner();
    }
    
    match /eoc/{docId} {
      allow read, create, update: if hasPermission('eoc');
      allow delete: if isOwner();
    }
    
    match /cbahi/{docId} {
      allow read, create, update: if hasPermission('cbahi');
      allow delete: if isOwner();
    }

    // ===== Default deny =====
  }
}
