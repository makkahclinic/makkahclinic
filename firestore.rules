rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====

    function isAuthenticated() {
      return request.auth != null;
    }

    // ğŸ‘‘ Owner (bypass ÙƒØ§Ù…Ù„)
    function isOwner() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.role == 'owner';
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.role == 'admin';
    }

    function isPrivileged() {
      return isOwner() || isAdmin();
    }

    // ğŸ” ØµÙ„Ø§Ø­ÙŠØ© Ù†Ø¸Ø§Ù… Ù…Ø­Ø¯Ø¯ (RBAC)
    function hasPermission(key) {
      return isOwner() || isAdmin() ||
        (isAuthenticated() &&
         exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.permissions[key] == true);
    }

    // ===== staff_roles (Ø£Ù‡Ù… Collection) =====
    match /staff_roles/{userId} {

      allow read: if isAuthenticated() &&
        (request.auth.uid == userId || isPrivileged());

      allow create: if isPrivileged() &&
        (request.resource.data.role != 'owner' || isOwner());

      allow update: if isPrivileged() &&
        // Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ¹ÙŠÙ‘Ù† owner Ø¥Ù„Ø§ owner
        (request.resource.data.role != 'owner' || isOwner()) &&
        // Ù„Ø§ Ø£Ø­Ø¯ ÙŠØºÙŠÙ‘Ø± owner Ø¥Ù„Ø§ owner
        (resource.data.role != 'owner' || isOwner());

      allow delete: if isOwner();
    }

    // ===== Deleted staff (Ø£Ø±Ø´ÙŠÙ) =====
    match /deleted_staff/{userId} {
      allow read, create, update, delete: if isOwner();
    }

    // ===== Audit log =====
    match /audit_log/{logId} {
      allow read: if isPrivileged();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ===== Alerts =====
    match /alerts/{alertId} {
      allow read, write: if isPrivileged();
    }

    // ===== Membership Requests =====
    match /membershipRequests/{requestId} {

      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.status == 'pending';

      allow read: if isAuthenticated() &&
        (resource.data.uid == request.auth.uid || isPrivileged());

      allow update, delete: if isPrivileged();
    }

    // ===== System-specific collections (examples) =====
    
    match /complaints/{docId} {
      allow read, write: if hasPermission('complaints');
    }
    
    match /incidents/{docId} {
      allow read, write: if hasPermission('incidents');
    }
    
    match /risks/{docId} {
      allow read, write: if hasPermission('risks');
    }
    
    match /rounds/{docId} {
      allow read, write: if hasPermission('rounds');
    }
    
    match /calibration/{docId} {
      allow read, write: if hasPermission('calibration');
    }
    
    match /maintenance/{docId} {
      allow read, write: if hasPermission('maintenance');
    }

    // ===== Default deny =====
  }
}
