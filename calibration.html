<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ | Ø³Ø¬Ù„ Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL) - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        // Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#8B0000',      // Ù‚Ø±Ù…Ø²ÙŠ Ø¯Ø§ÙƒÙ†
                        'secondary': '#D4AF37',    // Ø°Ù‡Ø¨ÙŠ
                        'accent': '#B8860B',       // Ø°Ù‡Ø¨ÙŠ ØºØ§Ù…Ù‚
                        'light': '#F5F5F5',
                        'dark': '#2C2C2C',
                        'success': '#28a745',
                        'danger': '#dc3545',
                        'warning': '#f59e0b',
                        'info': '#17a2b8'
                    },
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                    },
                    boxShadow: {
                        'gold-glow': '0 0 15px rgba(212, 175, 55, 0.5)',
                        'crimson-glow': '0 0 15px rgba(139, 0, 0, 0.3)'
                    },
                    keyframes: {
                        'pulsating-alert': {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(220, 53, 69, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(220, 53, 69, 0.8)' },
                        },
                        'upcoming-glow': {
                            '0%, 100%': { backgroundColor: 'rgba(212, 175, 55, 0.1)' },
                            '50%': { backgroundColor: 'rgba(212, 175, 55, 0.3)' },
                        }
                    },
                    animation: {
                        'pulsate-alert': 'pulsating-alert 2s infinite',
                        'upcoming-glow': 'upcoming-glow 3s infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Styles for Circular Progress Charts */
        .circular-chart {
            display: block;
            margin: 10px auto;
        }
        .circle-bg {
            fill: none;
            stroke: #eee;
            stroke-width: 3.8;
        }
        .circle {
            fill: none;
            stroke-linecap: round;
            transition: stroke-dasharray 0.6s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .percentage {
            fill: #666;
            font-family: 'Tajawal', sans-serif;
            text-anchor: middle;
            font-weight: bold;
        }

        /* Row highlight for upcoming calibrations */
        .row-upcoming {
            border-right: 4px solid #D4AF37;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #D4AF37;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #B8860B;
        }

        /* Print Stylesheet */
        @media print {
            body {
                background-color: white;
            }
            header, #smart-alert-banner, #dashboard-kpis, #compliance-indicators, #form-container, #table-controls, .shadow-md, .shadow-lg {
                display: none !important;
            }
            #table-container {
                display: block !important;
                box-shadow: none;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            table {
                font-size: 10pt;
                border-collapse: collapse;
                width: 100%;
            }
            th, td {
                border: 1px solid #ccc;
                padding: 5px;
            }
            .row-upcoming, .bg-red-50 {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .row-upcoming {
                background-color: rgba(212, 175, 55, 0.1) !important;
                animation: none !important;
            }
            .bg-red-50 {
                background-color: rgba(220, 53, 69, 0.1) !important;
            }
        }

        /* Gradient backgrounds */
        .gradient-header {
            background: linear-gradient(135deg, #8B0000 0%, #D4AF37 100%);
        }
        .gradient-kpi {
            background: linear-gradient(135deg, #F5F5F5 0%, #E8E8E8 100%);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <section id="fms-calibration" class="container mx-auto p-4 md:p-8">
        <!-- Header with Logo -->
        <header class="mb-6 p-6 gradient-header text-white shadow-lg rounded-lg flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center mb-4 md:mb-0">
                <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo.png" alt="Ø´Ø¹Ø§Ø± Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ" class="h-16 w-16 mr-4 rounded-full bg-white p-1">
                <div>
                    <h1 class="text-2xl font-bold">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL Log)</h1>
                    <p class="text-white/90">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p>
                </div>
            </div>
            <div class="text-center md:text-right">
                <div class="bg-white/20 p-2 rounded-lg">
                    <p class="text-sm font-medium">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="last-update">--</span></p>
                </div>
            </div>
        </header>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-primary mb-4"></i>
                <p class="text-lg font-semibold text-dark">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
                <p class="text-sm text-gray-600 mt-2">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            </div>
        </div>

        <!-- Smart Alert Banner -->
        <div id="smart-alert-banner" class="hidden mb-6 p-4 bg-gradient-to-r from-warning/20 to-danger/20 border-r-4 border-warning text-dark rounded-lg shadow-sm">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-warning text-xl ml-2 mt-1"></i>
                <div>
                    <p id="alert-message" class="font-semibold"></p>
                    <button id="dismiss-alert" class="mt-2 text-sm bg-white/50 hover:bg-white/70 px-3 py-1 rounded transition duration-150">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
                </div>
            </div>
        </div>

        <!-- Dashboard KPIs -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2" id="dashboard-kpis">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 shadow-crimson-glow gradient-kpi p-5 rounded-lg border-t-4 border-secondary">
                    <div id="kpi-pass" class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-success/20">
                        <i class="fas fa-check-circle text-3xl text-success mb-2"></i>
                        <p class="text-2xl font-bold" id="count-pass">0</p>
                        <p class="text-sm text-gray-600">âœ… Ù…Ø·Ø§Ø¨Ù‚ (Pass)</p>
                    </div>
                    <div id="kpi-fail" class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-danger/20">
                        <i class="fas fa-times-circle text-3xl text-danger mb-2"></i>
                        <p class="text-2xl font-bold" id="count-fail">0</p>
                        <p class="text-sm text-gray-600">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</p>
                    </div>
                    <div id="kpi-overdue" class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-warning/20">
                        <i class="fas fa-exclamation-circle text-3xl text-warning mb-2"></i>
                        <p class="text-2xl font-bold" id="count-overdue">0</p>
                        <p class="text-sm text-gray-600">âš ï¸ Ù…ØªØ£Ø®Ø± (Overdue)</p>
                    </div>
                    <div id="kpi-upcoming" class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-secondary/20">
                        <i class="fas fa-hourglass-half text-3xl text-secondary mb-2"></i>
                        <p class="text-2xl font-bold" id="count-upcoming">0</p>
                        <p class="text-sm text-gray-600">â³ Ù‚Ø§Ø¯Ù… (30 ÙŠÙˆÙ…)</p>
                    </div>
                    <div id="kpi-unscheduled" class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-gray-300">
                        <i class="fas fa-calendar-times text-3xl text-gray-500 mb-2"></i>
                        <p class="text-2xl font-bold" id="count-unscheduled">0</p>
                        <p class="text-sm text-gray-600">ğŸ•“ Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯</p>
                    </div>
                </div>
            </div>

            <!-- Compliance Indicators -->
            <div class="bg-white p-5 rounded-lg shadow-lg border border-secondary/20" id="compliance-indicators">
                <h2 class="text-lg font-semibold mb-4 text-primary border-b pb-2">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Compliance)</h2>
                <div class="flex justify-center items-center mb-6">
                    <div id="overall-compliance-chart" class="w-32 h-32"></div>
                </div>
                <h2 class="text-md font-semibold mb-3 text-center text-dark">Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
                <div class="grid grid-cols-4 gap-2 text-center" id="department-compliance"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Form Section -->
            <div class="lg:col-span-1" id="form-container">
                <div class="bg-white p-6 rounded-lg shadow-lg border border-secondary/20 sticky top-8">
                    <h2 class="text-xl font-bold mb-5 border-b pb-2 text-primary flex items-center">
                        <i class="fas fa-plus-circle ml-2 text-secondary"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
                    </h2>
                    <form id="calibration-form">
                        <div class="space-y-4">
                            <div>
                                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù‚Ø³Ù… <span class="text-danger">*</span></label>
                                <select id="department" name="department" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition duration-150">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>
                                </select>
                            </div>
                            <div>
                                <label for="staff" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ <span class="text-danger">*</span></label>
                                <input type="text" id="staff" name="staff" required list="staff-list" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø£Ùˆ Ø§Ø®ØªØ±Ù‡" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition duration-150">
                                <datalist id="staff-list"></datalist>
                            </div>
                            <div>
                                <label for="asset" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ù‡Ù…Ø© / Ø§Ù„Ø¬Ù‡Ø§Ø² (Task) <span class="text-danger">*</span></label>
                                <select id="asset" name="asset" required disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 focus:outline-none focus:ring-primary focus:border-primary transition duration-150">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>
                                </select>
                            </div>
                            <div>
                                <label for="testDate" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ <span class="text-danger">*</span></label>
                                <input type="date" id="testDate" name="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition duration-150">
                            </div>
                            <div>
                                <label for="frequency" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªÙƒØ±Ø§Ø± <span class="text-danger">*</span></label>
                                <select id="frequency" name="frequency" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition duration-150">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªÙƒØ±Ø§Ø±...</option>
                                    <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Weekly)</option>
                                    <option value="Ø´Ù‡Ø±ÙŠ">Ø´Ù‡Ø±ÙŠ (Monthly)</option>
                                    <option value="Ù†ØµÙ Ø³Ù†ÙˆÙŠ">Ù†ØµÙ Ø³Ù†ÙˆÙŠ (Semi-Annually)</option>
                                    <option value="Ø³Ù†ÙˆÙŠ">Ø³Ù†ÙˆÙŠ (Annually)</option>
                                </select>
                            </div>
                            <div>
                                <label for="nextDue" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
                                <input type="date" id="nextDue" name="nextDue" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù†ØªÙŠØ¬Ø© <span class="text-danger">*</span></label>
                                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                                    <label class="flex items-center cursor-pointer bg-success/10 p-2 rounded-lg transition duration-150 hover:bg-success/20">
                                        <input type="radio" name="result" value="Pass" required class="form-radio h-4 w-4 text-success">
                                        <span class="mr-2 text-success font-semibold">âœ… Ù…Ø·Ø§Ø¨Ù‚ (Pass)</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer bg-danger/10 p-2 rounded-lg transition duration-150 hover:bg-danger/20">
                                        <input type="radio" name="result" value="Fail" class="form-radio h-4 w-4 text-danger">
                                        <span class="mr-2 text-danger font-semibold">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label for="certificateFile" class="block text-sm font-medium text-gray-700 mb-1">Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF/ØµÙˆØ±Ø©) <span class="text-danger">*</span></label>
                                <input type="file" id="certificateFile" name="certificateFile" accept="application/pdf,image/*" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/80 transition duration-150">
                                <p id="file-status" class="text-xs text-gray-500 mt-1"></p>
                            </div>
                            <button type="submit" id="submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                                <i class="fas fa-save ml-2"></i>
                                Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Table Section -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-lg shadow-lg border border-secondary/20" id="table-container">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4" id="table-controls">
                        <h2 class="text-xl font-bold text-primary flex items-center">
                            <i class="fas fa-table ml-2 text-secondary"></i>
                            Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø§Øª ÙˆØ§Ù„ÙØ­ÙˆØµØ§Øª
                        </h2>
                        <div class="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-3 rtl:space-x-reverse w-full md:w-auto">
                            <div class="flex space-x-2 w-full md:w-auto">
                                <select id="department-filter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-sm w-full md:w-auto">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                                </select>
                                <input type="text" id="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª..." class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-sm w-full md:w-auto">
                            </div>
                            <div class="flex space-x-2 w-full md:w-auto">
                                <button id="refresh-btn" class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-accent transition duration-150 ease-in-out text-sm flex items-center">
                                    <i class="fas fa-sync-alt ml-1"></i> ØªØ­Ø¯ÙŠØ«
                                </button>
                                <button id="print-btn" onclick="window.print()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out text-sm flex items-center">
                                    <i class="fas fa-print ml-1"></i> Ø·Ø¨Ø§Ø¹Ø©
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200" id="logs-table">
                            <thead class="bg-primary text-white">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„ÙˆÙ‚Øª</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="8" class="text-center py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center text-sm text-gray-600">
                        <div id="table-stats">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <span id="total-records">0</span></div>
                        <div id="filter-stats" class="hidden">ØªÙ… ØªØµÙÙŠØ©: <span id="filtered-count">0</span> Ù…Ù† <span id="total-count">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // ================================================================
        // âš™ï¸ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙˆØ§Ù„ØªÙƒØ§Ù…Ù„ (JavaScript Logic) - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©
        // ================================================================

        // --- Configuration ---
        const CAL_API_URL = 'https://script.google.com/macros/s/AKfycbxhKSq0qMIT85_pUfiba5V5Pi-kO_Df4Qw98MRIM4fmCb-XcheI8uGQccFxuKjigATHlQ/exec';
        const MOCK_MODE = false;

        // --- Global State ---
        let assetsMap = {};
        let staffList = [];
        let allRecords = [];
        let DEPARTMENTS_LIST = [];
        let uploadedFileBase64 = null;
        let uploadedFileMimeType = null;
        let uploadedFileName = null;

        // --- DOM Elements ---
        const elements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            form: document.getElementById('calibration-form'),
            departmentSelect: document.getElementById('department'),
            assetSelect: document.getElementById('asset'),
            testDateInput: document.getElementById('testDate'),
            frequencySelect: document.getElementById('frequency'),
            nextDueInput: document.getElementById('nextDue'),
            certificateFileInput: document.getElementById('certificateFile'),
            fileStatus: document.getElementById('file-status'),
            submitBtn: document.getElementById('submit-btn'),
            tableBody: document.getElementById('log-table-body'),
            searchInput: document.getElementById('search-input'),
            staffDatalist: document.getElementById('staff-list'),
            alertBanner: document.getElementById('smart-alert-banner'),
            alertMessage: document.getElementById('alert-message'),
            departmentFilter: document.getElementById('department-filter'),
            refreshBtn: document.getElementById('refresh-btn'),
            dismissAlert: document.getElementById('dismiss-alert'),
            lastUpdate: document.getElementById('last-update'),
            tableStats: document.getElementById('table-stats'),
            filterStats: document.getElementById('filter-stats'),
            totalRecords: document.getElementById('total-records'),
            filteredCount: document.getElementById('filtered-count'),
            totalCount: document.getElementById('total-count')
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            console.log("Initializing Calibration System...");
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· API
            if (CAL_API_URL.includes('Ø¶Ø¹_Ø±Ø§Ø¨Ø·_API_Ø§Ù„Ø¬Ø¯ÙŠØ¯_Ù‡Ù†Ø§') && !MOCK_MODE) {
                showLoading(false);
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.', 'error');
                elements.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-danger">Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØªØµÙ„.</td></tr>';
                return;
            }
            
            setupEventListeners();
            elements.testDateInput.valueAsDate = new Date();
            await fetchData();
        }

        function setupEventListeners() {
            elements.departmentSelect.addEventListener('change', handleDepartmentChange);
            elements.testDateInput.addEventListener('change', calculateNextDue);
            elements.frequencySelect.addEventListener('change', calculateNextDue);
            elements.certificateFileInput.addEventListener('change', handleFileUpload);
            elements.form.addEventListener('submit', handleSubmit);
            elements.searchInput.addEventListener('keyup', filterTable);
            elements.departmentFilter.addEventListener('change', filterTable);
            elements.refreshBtn.addEventListener('click', () => fetchData(true));
            elements.dismissAlert.addEventListener('click', () => elements.alertBanner.classList.add('hidden'));
        }

        // --- Utility Functions ---
        function showLoading(isLoading) {
            if (elements.loadingOverlay) {
                elements.loadingOverlay.classList.toggle('hidden', !isLoading);
            }
        }

        function toggleSubmitLoading(isLoading) {
            elements.submitBtn.disabled = isLoading;
            if (isLoading) {
                elements.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            } else {
                elements.submitBtn.innerHTML = '<i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('en-CA');
            } catch (e) {
                return dateString;
            }
        }

        function getTodayClear() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }

        function showNotification(message, type = 'success') {
            alert(`${type === 'success' ? 'âœ… Ù†Ø¬Ø§Ø­' : 'âŒ Ø®Ø·Ø£'}: ${message}`);
        }

        // --- Data Fetching (GET) ---
        async function fetchData(forceRefresh = false) {
            showLoading(true);
            try {
                let data;
                console.log("Fetching LIVE data from API...");
                const url = forceRefresh ? `${CAL_API_URL}?refresh=true` : CAL_API_URL;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    console.error("Received non-JSON response:", text);
                    throw new Error("Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Web App) ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©.");
                }
                
                data = await response.json();
                
                if (data && data.status === 'success') {
                    assetsMap = data.data.assetsMap || {};
                    staffList = data.data.staffList || [];
                    DEPARTMENTS_LIST = Object.keys(assetsMap);
                    populateDepartments();
                    
                    allRecords = (data.data.records || []).map(record => ({
                        Timestamp: record.Timestamp,
                        department: record.Department,
                        staff: record.Staff,
                        assetID: record.AssetID,
                        assetName: record.AssetName,
                        testDate: record.TestDate,
                        frequency: record.Frequency,
                        nextDue: record.NextDue,
                        result: record.Result,
                        CertificateLink: record.CertificateLink
                    }));
                    
                    processData();
                    updateLastUpdateTime();
                } else {
                    throw new Error(data.message || 'Failed to fetch data structure.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showNotification(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                elements.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª.</td></tr>';
            } finally {
                showLoading(false);
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            elements.lastUpdate.textContent = now.toLocaleString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function processData() {
            renderStaffList();
            const assetStatuses = calculateAssetStatuses(allRecords);
            renderDashboard(assetStatuses);
            renderTable(allRecords);
            checkSmartAlerts(assetStatuses);
            updateTableStats();
        }

        // --- Form Handlers ---
        function populateDepartments() {
            // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            elements.departmentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>';
            DEPARTMENTS_LIST.sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                elements.departmentSelect.appendChild(option);
            });
            
            // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            elements.departmentFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>';
            DEPARTMENTS_LIST.sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                elements.departmentFilter.appendChild(option);
            });
        }

        function handleDepartmentChange() {
            const department = elements.departmentSelect.value;
            elements.assetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ø¬Ù‡Ø§Ø²...</option>';
            
            if (department && assetsMap[department]) {
                const sortedAssets = assetsMap[department].sort((a, b) => a.name.localeCompare(b.name));
                sortedAssets.forEach(asset => {
                    const option = document.createElement('option');
                    option.value = asset.id;
                    option.textContent = asset.name;
                    elements.assetSelect.appendChild(option);
                });
                elements.assetSelect.disabled = false;
                elements.assetSelect.classList.remove('bg-gray-100');
            } else {
                elements.assetSelect.disabled = true;
                elements.assetSelect.classList.add('bg-gray-100');
            }
        }

        function calculateNextDue() {
            const testDateValue = elements.testDateInput.value;
            const frequency = elements.frequencySelect.value;
            
            if (!testDateValue || !frequency) {
                elements.nextDueInput.value = '';
                return;
            }
            
            const dateParts = testDateValue.split('-').map(p => parseInt(p, 10));
            const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            
            if (isNaN(date.getTime())) return;
            
            let nextDate = new Date(date.getTime());
            
            switch (frequency) {
                case 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ':
                    nextDate.setDate(date.getDate() + 7);
                    break;
                case 'Ø´Ù‡Ø±ÙŠ':
                    nextDate.setMonth(date.getMonth() + 1);
                    break;
                case 'Ù†ØµÙ Ø³Ù†ÙˆÙŠ':
                    nextDate.setMonth(date.getMonth() + 6);
                    break;
                case 'Ø³Ù†ÙˆÙŠ':
                    nextDate.setFullYear(date.getFullYear() + 1);
                    break;
            }
            
            elements.nextDueInput.value = nextDate.toLocaleDateString('en-CA');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            elements.fileStatus.textContent = '';
            uploadedFileBase64 = null;
            
            if (!file) return;
            
            if (!file.type.match('application/pdf') && !file.type.match('image.*')) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø© ÙÙ‚Ø·.', 'error');
                event.target.value = '';
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª).', 'error');
                event.target.value = '';
                return;
            }
            
            elements.fileStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedFileBase64 = e.target.result.split(',')[1];
                uploadedFileMimeType = file.type;
                uploadedFileName = file.name;
                elements.fileStatus.textContent = `ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø©: ${file.name}`;
            };
            
            reader.onerror = function() {
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
                elements.fileStatus.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.';
            };
            
            reader.readAsDataURL(file);
        }

        // --- Submission Handler (POST) ---
        async function handleSubmit(event) {
            event.preventDefault();
            
            if (!uploadedFileBase64) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.', 'error');
                return;
            }
            
            const formData = new FormData(elements.form);
            const selectedAssetOption = elements.assetSelect.options[elements.assetSelect.selectedIndex];
            const assetName = selectedAssetOption ? selectedAssetOption.textContent : 'Unknown Task';
            
            const payload = {
                action: "logCalibration",
                data: {
                    department: formData.get('department'),
                    staff: formData.get('staff'),
                    assetID: formData.get('asset'),
                    assetName: assetName,
                    testDate: formData.get('testDate'),
                    frequency: formData.get('frequency'),
                    nextDue: formData.get('nextDue'),
                    result: formData.get('result'),
                },
                fileData: {
                    fileName: uploadedFileName,
                    mimeType: uploadedFileMimeType,
                    base64: uploadedFileBase64,
                }
            };
            
            toggleSubmitLoading(true);
            
            try {
                let responseData;
                console.log("LIVE Submission to API...");
                
                const response = await fetch(CAL_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(payload),
                });
                
                const responseText = await response.text();
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse JSON response:", responseText);
                    throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ù„ÙÙŠ).');
                }
                
                if (responseData.status === 'success') {
                    showNotification(responseData.message, 'success');
                    
                    if (responseData.data && responseData.data.newRecord) {
                        const newRecord = responseData.data.newRecord;
                        allRecords.unshift({
                            Timestamp: newRecord.Timestamp,
                            department: newRecord.Department,
                            staff: newRecord.Staff,
                            assetID: newRecord.AssetID,
                            assetName: newRecord.AssetName,
                            testDate: newRecord.TestDate,
                            frequency: newRecord.Frequency,
                            nextDue: newRecord.NextDue,
                            result: newRecord.Result,
                            CertificateLink: newRecord.CertificateLink
                        });
                        
                        processData();
                    }
                    
                    resetForm();
                } else {
                    throw new Error(responseData.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©.');
                }
            } catch (error) {
                console.error('Error submitting data:', error);
                showNotification(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„: ${error.message}`, 'error');
            } finally {
                toggleSubmitLoading(false);
            }
        }

        function resetForm() {
            elements.form.reset();
            uploadedFileBase64 = null;
            elements.fileStatus.textContent = '';
            elements.assetSelect.disabled = true;
            elements.assetSelect.classList.add('bg-gray-100');
            elements.assetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>';
            elements.testDateInput.valueAsDate = new Date();
        }

        // --- Data Processing & Business Logic ---
        function calculateAssetStatuses(records) {
            const statuses = {
                Pass: 0,
                Fail: 0,
                Overdue: 0,
                Upcoming: 0,
                Unscheduled: 0,
                DepartmentCompliance: {},
                Assets: {}
            };
            
            DEPARTMENTS_LIST.forEach(dept => {
                statuses.DepartmentCompliance[dept] = { pass: 0, total: 0 };
            });
            
            const latestRecords = {};
            const sortedRecords = [...records].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            
            sortedRecords.forEach(record => {
                if (!latestRecords[record.assetID]) {
                    latestRecords[record.assetID] = record;
                }
            });
            
            const today = getTodayClear();
            const upcomingThreshold = new Date(today);
            upcomingThreshold.setDate(today.getDate() + 30);
            
            Object.values(latestRecords).forEach(record => {
                if (record.result === 'Pass') {
                    statuses.Pass++;
                } else if (record.result === 'Fail') {
                    statuses.Fail++;
                }
                
                if (statuses.DepartmentCompliance[record.department]) {
                    statuses.DepartmentCompliance[record.department].total++;
                    if (record.result === 'Pass') {
                        statuses.DepartmentCompliance[record.department].pass++;
                    }
                }
                
                if (record.nextDue) {
                    try {
                        const nextDue = new Date(record.nextDue);
                        if (!isNaN(nextDue.getTime())) {
                            const nextDueClear = new Date(nextDue.getFullYear(), nextDue.getMonth(), nextDue.getDate());
                            if (nextDueClear < today) {
                                statuses.Overdue++;
                            } else if (nextDueClear <= upcomingThreshold) {
                                statuses.Upcoming++;
                            }
                        }
                    } catch (e) {
                        console.warn("Invalid date encountered:", record.nextDue);
                    }
                }
                
                statuses.Assets[record.assetID] = record;
            });
            
            let totalManagedTasks = 0;
            Object.values(assetsMap).forEach(assets => totalManagedTasks += assets.length);
            statuses.Unscheduled = Math.max(0, totalManagedTasks - Object.keys(latestRecords).length);
            
            return statuses;
        }

        // --- Rendering Functions ---
        function renderDashboard(statuses) {
            document.getElementById('count-pass').textContent = statuses.Pass;
            document.getElementById('count-fail').textContent = statuses.Fail;
            document.getElementById('count-overdue').textContent = statuses.Overdue;
            document.getElementById('count-upcoming').textContent = statuses.Upcoming;
            document.getElementById('count-unscheduled').textContent = statuses.Unscheduled;
            
            const failKpi = document.getElementById('kpi-fail');
            failKpi.classList.toggle('animate-pulsate-alert', statuses.Fail > 0);
            
            const overdueKpi = document.getElementById('kpi-overdue');
            overdueKpi.classList.toggle('animate-pulsate-alert', statuses.Overdue > 0);
            
            const totalCalibrated = statuses.Pass + statuses.Fail;
            let totalTasks = 0;
            Object.values(assetsMap).forEach(arr => totalTasks += arr.length);
            const overallCompliance = totalCalibrated > 0 ? (statuses.Pass / totalCalibrated) * 100 : (totalTasks === 0 ? 100 : 0);
            
            renderCircularChart('overall-compliance-chart', overallCompliance, '#8B0000', false);
            
            const deptContainer = document.getElementById('department-compliance');
            deptContainer.innerHTML = '';
            
            DEPARTMENTS_LIST.forEach(dept => {
                const stats = statuses.DepartmentCompliance[dept];
                const deptTasksCount = assetsMap[dept] ? assetsMap[dept].length : 0;
                const compliance = stats.total > 0 ? (stats.pass / stats.total) * 100 : (deptTasksCount > 0 ? 0 : 100);
                
                const chartDiv = document.createElement('div');
                chartDiv.id = `compliance-${dept}`;
                deptContainer.appendChild(chartDiv);
                
                renderCircularChart(`compliance-${dept}`, compliance, '#D4AF37', true);
                
                const label = document.createElement('p');
                label.className = 'text-xs font-semibold mt-1';
                label.textContent = dept;
                chartDiv.appendChild(label);
            });
        }

        function renderCircularChart(containerId, percentage, defaultColor, isSmall) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let dynamicColor = defaultColor;
            if (percentage < 60) {
                dynamicColor = '#dc3545';
            } else if (percentage < 90) {
                dynamicColor = '#D4AF37';
            } else if (percentage >= 95) {
                dynamicColor = '#28a745';
            }
            
            const radius = 15.9155;
            const circumference = 100;
            const dasharray = `${(percentage / 100) * circumference} ${circumference}`;
            const sizeClass = isSmall ? 'w-16 h-16' : 'w-24 h-24';
            const strokeWidth = isSmall ? '3.8' : '2.8';
            const fontSize = isSmall ? '0.4em' : '0.5em';
            
            container.innerHTML = `
                <svg viewBox="0 0 36 36" class="circular-chart ${sizeClass}">
                    <path class="circle-bg" stroke-width="3.8" d="M18 2.0845 a ${radius} ${radius} 0 0 1 0 31.831 a ${radius} ${radius} 0 0 1 0 -31.831" />
                    <path class="circle" stroke="${dynamicColor}" stroke-width="${strokeWidth}" stroke-dasharray="${dasharray}" d="M18 2.0845 a ${radius} ${radius} 0 0 1 0 31.831 a ${radius} ${radius} 0 0 1 0 -31.831" />
                    <text x="18" y="20.35" class="percentage" style="font-size: ${fontSize};">${Math.round(percentage)}%</text>
                </svg>
            `;
        }

        function renderTable(records) {
            if (records.length === 0) {
                elements.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©.</td></tr>';
                return;
            }
            
            const today = getTodayClear();
            const weeklyThreshold = new Date(today);
            weeklyThreshold.setDate(today.getDate() + 7);
            
            const sortedRecords = [...records].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            
            elements.tableBody.innerHTML = sortedRecords.map(record => {
                const isPass = record.result === 'Pass';
                const resultHtml = `
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isPass ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
                        ${isPass ? 'âœ… Ù…Ø·Ø§Ø¨Ù‚' : 'âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚'}
                    </span>
                `;
                
                const certificateHtml = record.CertificateLink ? 
                    `<a href="${record.CertificateLink}" target="_blank" class="text-primary hover:text-primary/80 transition duration-150 flex items-center">
                        <i class="fas fa-file-alt ml-1"></i> Ø¹Ø±Ø¶
                    </a>` : 
                    'N/A';
                
                let rowClass = '';
                if (record.nextDue) {
                    try {
                        const nextDue = new Date(record.nextDue);
                        if (!isNaN(nextDue.getTime())) {
                            const nextDueClear = new Date(nextDue.getFullYear(), nextDue.getMonth(), nextDue.getDate());
                            if (nextDueClear < today) {
                                rowClass = 'bg-danger/10';
                            } else if (nextDueClear <= weeklyThreshold) {
                                rowClass = 'row-upcoming animate-upcoming-glow';
                            }
                        }
                    } catch(e) {}
                }
                
                const assetDisplay = record.assetName || record.assetID;
                
                return `
                    <tr class="${rowClass} hover:bg-gray-50 transition duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(record.Timestamp)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-dark">${record.department}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-dark">${record.staff}</td>
                        <td class="px-6 py-4 text-sm text-dark max-w-sm truncate" title="${assetDisplay}">${assetDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(record.testDate)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${formatDate(record.nextDue)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${resultHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${certificateHtml}</td>
                    </tr>
                `;
            }).join('');
            
            updateTableStats();
        }

        function renderStaffList() {
            elements.staffDatalist.innerHTML = staffList.map(staff => `<option value="${staff}">`).join('');
        }

        // ğŸ§­ Smart Alerts Logic (7-day lookahead)
        function checkSmartAlerts(statuses) {
            const today = getTodayClear();
            const weeklyThreshold = new Date(today);
            weeklyThreshold.setDate(today.getDate() + 7);
            
            const imminentDepartments = new Set();
            
            Object.values(statuses.Assets).forEach(asset => {
                if (asset.nextDue) {
                    try {
                        const nextDue = new Date(asset.nextDue);
                        if (!isNaN(nextDue.getTime())) {
                            const nextDueClear = new Date(nextDue.getFullYear(), nextDue.getMonth(), nextDue.getDate());
                            if (nextDueClear <= weeklyThreshold) {
                                imminentDepartments.add(asset.department);
                            }
                        }
                    } catch(e) {}
                }
            });
            
            let alerts = [];
            
            if (statuses.Unscheduled > 0) {
                alerts.push(`<i class="fas fa-info-circle ml-2"></i>ØªÙ†Ø¨ÙŠÙ‡: ØªÙˆØ¬Ø¯ <strong>${statuses.Unscheduled}</strong> Ù…Ù‡Ù…Ø©/Ù…Ù‡Ø§Ù… Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø³Ø¬Ù„ Ù„Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯).`);
            }
            
            if (imminentDepartments.size > 0) {
                alerts.push(`<i class="fas fa-exclamation-triangle ml-2"></i>ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…: ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠØ±Ø§Øª Ù…Ø³ØªØ­Ù‚Ø© (Ø£Ùˆ Ù…ØªØ£Ø®Ø±Ø©) Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù‚Ø³Ù…/Ø£Ù‚Ø³Ø§Ù…: <strong>${Array.from(imminentDepartments).join(', ')}</strong>.`);
            }
            
            if (alerts.length > 0) {
                elements.alertBanner.classList.remove('hidden');
                elements.alertMessage.innerHTML = alerts.join('<br><br>');
            } else {
                elements.alertBanner.classList.add('hidden');
            }
        }

        // --- Table Utilities ---
        function filterTable() {
            const searchFilter = elements.searchInput.value.toUpperCase();
            const departmentFilter = elements.departmentFilter.value;
            
            const rows = elements.tableBody.getElementsByTagName("tr");
            let visibleCount = 0;
            
            for (let i = 0; i < rows.length; i++) {
                let visible = true;
                const cells = rows[i].getElementsByTagName("td");
                
                if (searchFilter) {
                    let found = false;
                    for (let j = 0; j < cells.length; j++) {
                        if (cells[j] && cells[j].textContent.toUpperCase().indexOf(searchFilter) > -1) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) visible = false;
                }
                
                if (departmentFilter && visible) {
                    const departmentCell = cells[1]; // Ø§Ù„Ù‚Ø³Ù… Ù‡Ùˆ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ
                    if (departmentCell && departmentCell.textContent !== departmentFilter) {
                        visible = false;
                    }
                }
                
                rows[i].style.display = visible ? "" : "none";
                if (visible) visibleCount++;
            }
            
            updateFilterStats(visibleCount, rows.length);
        }

        function updateTableStats() {
            const totalRecords = allRecords.length;
            elements.totalRecords.textContent = totalRecords;
        }

        function updateFilterStats(visibleCount, totalCount) {
            if (elements.searchInput.value || elements.departmentFilter.value) {
                elements.filterStats.classList.remove('hidden');
                elements.filteredCount.textContent = visibleCount;
                elements.totalCount.textContent = totalCount;
            } else {
                elements.filterStats.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
