<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ | Ø³Ø¬Ù„ Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL) - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap"
        rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1e3a5f',
            secondary: '#c9a962',
            accent: '#DC143C',
            light: '#F5F5F5',
            dark: '#2C2C2C',
            success: '#10b981',
            danger: '#ef4444',
            warning: '#f59e0b',
            info: '#17a2b8'
          },
          fontFamily: {
            sans: ['Tajawal', 'sans-serif']
          },
          boxShadow: {
            'gold-glow': '0 0 15px rgba(212, 175, 55, 0.5)',
            'crimson-glow': '0 0 15px rgba(139, 0, 0, 0.3)'
          },
          keyframes: {
            'pulsating-alert': {
              '0%, 100%': { boxShadow: '0 0 5px rgba(220, 53, 69, 0.5)' },
              '50%': { boxShadow: '0 0 20px rgba(220, 53, 69, 0.8)' }
            },
            'upcoming-glow': {
              '0%, 100%': { backgroundColor: 'rgba(212, 175, 55, 0.1)' },
              '50%': { backgroundColor: 'rgba(212, 175, 55, 0.3)' }
            }
          },
          animation: {
            'pulsate-alert': 'pulsating-alert 2s infinite',
            'upcoming-glow': 'upcoming-glow 3s infinite'
          }
        }
      }
    };
  </script>

  <style>
    .circular-chart { display: block; margin: 10px auto; }
    .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
    .circle { fill: none; stroke-linecap: round; transition: stroke-dasharray 0.6s ease;
              transform: rotate(-90deg); transform-origin: 50% 50%; }
    .percentage { fill: #666; font-family: 'Tajawal', sans-serif;
                  text-anchor: middle; font-weight: bold; }
    .row-upcoming { border-right: 4px solid #c9a962; }
    .gradient-header { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); }
    .gradient-kpi { background: linear-gradient(135deg, #F5F5F5 0%, #E8E8E8 100%); }
    .schedule-table { font-size: 0.75rem; }
    .schedule-table th { background-color: #1e3a5f; color: white; padding: 6px 8px; }
    .schedule-table td { padding: 6px 8px; border-bottom: 1px solid #e5e7eb; }
    .schedule-table tr:nth-child(even) { background-color: #f9fafb; }
    .schedule-table tr:hover { background-color: #f3f4f6; }

    @media print {
      body { background-color: white; }
      header, #smart-alert-banner, #dashboard-kpis, #compliance-indicators,
      #form-container, #table-controls, .shadow-md, .shadow-lg {
        display: none !important;
      }
      #table-container { display: block !important; box-shadow: none;
                         width: 100%; margin: 0; padding: 0; }
      table { font-size: 10pt; border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 5px; }
      .row-upcoming, .bg-red-50 { -webkit-print-color-adjust: exact; color-adjust: exact; }
      .row-upcoming { background-color: rgba(212, 175, 55, 0.1) !important;
                      animation: none !important; }
      .bg-red-50 { background-color: rgba(220, 53, 69, 0.1) !important; }
    }
  </style>
</head>

<body class="bg-gray-100 font-sans antialiased">
  <section id="fms-calibration" class="container mx-auto p-4 md:p-8">

    <!-- =================== Ø§Ù„Ù‡ÙŠØ¯Ø± =================== -->
    <header class="mb-6 gradient-header text-white shadow-lg rounded-lg overflow-hidden">
      <div class="p-6 flex flex-col lg:flex-row items-start justify-between">
        <div class="flex items-center mb-4 lg:mb-0 lg:w-1/3">
          <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png"
               alt="Ø´Ø¹Ø§Ø± Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ"
               class="h-16 w-16 ml-4 rounded-full bg-white p-1 flex-shrink-0" />
          <div>
            <h1 class="text-2xl font-bold">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL Log)</h1>
            <p class="text-white/90">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p>
          </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© -->
        <div class="lg:w-2/3 bg-white/10 backdrop-blur-sm rounded-lg p-4">
          <h3 class="text-lg font-bold mb-3 text-center text-white border-b border-white/30 pb-2">
            Ø¬Ø¯ÙˆÙ„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ
          </h3>
          <div class="overflow-x-auto">
            <table class="min-w-full schedule-table bg-white/90 text-dark rounded-lg">
              <thead>
                <tr>
                  <th class="text-center">Ø§Ù„Ù‚Ø³Ù…</th>
                  <th class="text-center">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</th>
                  <th class="text-center">Ø§Ù„ØªÙƒØ±Ø§Ø±</th>
                  <th class="text-center">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                  <th class="text-center">Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„ØªÙˆØ«ÙŠÙ‚</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="text-center font-semibold">ğŸ©» Ø§Ù„Ø£Ø´Ø¹Ø©</td>
                  <td>X-Ray / Portable / Dental / Mammogram / Ultrasound</td>
                  <td class="text-center">Ø³Ù†ÙˆÙŠÙ‹Ø§</td>
                  <td class="text-center">Ø£. Ø¨Ù„Ø§Ù„ Ù†ØªÙˆ</td>
                  <td class="text-center">NRRC â€“ LOG-FMS-2025-021</td>
                </tr>
                <tr>
                  <td class="text-center font-semibold">ğŸ§ª Ø§Ù„Ù…Ø®ØªØ¨Ø±</td>
                  <td>Biochem / Heme / Centrifuge / Micropipettes / Incubator / Refrigerator</td>
                  <td class="text-center">Ù†ØµÙ Ø³Ù†ÙˆÙŠ/Ø³Ù†ÙˆÙŠ</td>
                  <td class="text-center">Ø£. Ù‡ÙŠØ«Ù… Ø§Ù„Ø¬Ø¹Ù„ÙŠ</td>
                  <td class="text-center">FMS Approved Vendors â€“ LOG-FMS-2025-020</td>
                </tr>
                <tr>
                  <td class="text-center font-semibold">ğŸ§´ CSSD</td>
                  <td>Autoclave / Dry Heat / Sealer / Ultrasonic</td>
                  <td class="text-center">Ø³Ù†ÙˆÙŠÙ‹Ø§</td>
                  <td class="text-center">Ø¯. Ù…Ø¬Ø¯ÙŠ Ø¹Ø³ÙƒØ±</td>
                  <td class="text-center">Indicators â€“ LOG-FMS-2025-022</td>
                </tr>
                <tr>
                  <td class="text-center font-semibold">âš¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</td>
                  <td>Defib / ECG / Suction / O2 Flow / PulseOx</td>
                  <td class="text-center">Ø³Ù†ÙˆÙŠ + ÙŠÙˆÙ…ÙŠ</td>
                  <td class="text-center">Ø¯. Ù…Ø¹Ø§Ø° Ø§Ù„Ø¨ÙŠÙˆØ´</td>
                  <td class="text-center">FMS+EOC â€“ LOG-FMS-2025-023</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="px-6 py-3 bg-white/20 text-center">
        <p class="text-sm font-medium">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="last-update">--</span></p>
      </div>
    </header>

    <!-- =================== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ =================== -->
    <div id="loading-overlay"
         class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
      <div class="text-center">
        <i class="fas fa-spinner fa-spin text-4xl text-primary mb-4"></i>
        <p class="text-lg font-semibold text-dark">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
        <p class="text-sm text-gray-600 mt-2">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
      </div>
    </div>

    <!-- =================== ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø°ÙƒÙŠØ© =================== -->
    <div id="smart-alert-banner"
         class="hidden mb-6 p-4 bg-gradient-to-r from-warning/20 to-danger/20 border-r-4 border-warning text-dark rounded-lg shadow-sm">
      <div class="flex items-start">
        <i class="fas fa-exclamation-triangle text-warning text-xl ml-2 mt-1"></i>
        <div>
          <p id="alert-message" class="font-semibold"></p>
          <button id="dismiss-alert"
                  class="mt-2 text-sm bg-white/50 hover:bg-white/70 px-3 py-1 rounded transition duration-150">
            Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
          </button>
        </div>
      </div>
    </div>

    <!-- =================== Ù…Ø¤Ø´Ø±Ø§Øª KPI =================== -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="lg:col-span-2" id="dashboard-kpis">
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 shadow-crimson-glow gradient-kpi p-5 rounded-lg border-t-4 border-secondary">
          <div id="kpi-pass"
               class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-success/20">
            <i class="fas fa-check-circle text-3xl text-success mb-2"></i>
            <p class="text-2xl font-bold" id="count-pass">0</p>
            <p class="text-sm text-gray-600">âœ… Ù…Ø·Ø§Ø¨Ù‚ (Pass)</p>
          </div>
          <div id="kpi-fail"
               class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-danger/20">
            <i class="fas fa-times-circle text-3xl text-danger mb-2"></i>
            <p class="text-2xl font-bold" id="count-fail">0</p>
            <p class="text-sm text-gray-600">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</p>
          </div>
          <div id="kpi-overdue"
               class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-warning/20">
            <i class="fas fa-exclamation-circle text-3xl text-warning mb-2"></i>
            <p class="text-2xl font-bold" id="count-overdue">0</p>
            <p class="text-sm text-gray-600">âš ï¸ Ù…ØªØ£Ø®Ø± (Overdue)</p>
          </div>
          <div id="kpi-upcoming"
               class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-secondary/20">
            <i class="fas fa-hourglass-half text-3xl text-secondary mb-2"></i>
            <p class="text-2xl font-bold" id="count-upcoming">0</p>
            <p class="text-sm text-gray-600">â³ Ù‚Ø§Ø¯Ù… (30 ÙŠÙˆÙ…)</p>
          </div>
          <div id="kpi-unscheduled"
               class="text-center p-3 bg-white rounded-lg transition duration-300 hover:shadow-lg border border-gray-300">
            <i class="fas fa-calendar-times text-3xl text-gray-500 mb-2"></i>
            <p class="text-2xl font-bold" id="count-unscheduled">0</p>
            <p class="text-sm text-gray-600">ğŸ•“ Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯</p>
          </div>
        </div>
      </div>

      <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… -->
      <div class="bg-white p-5 rounded-lg shadow-lg border border-secondary/20"
           id="compliance-indicators">
        <h2 class="text-lg font-semibold mb-4 text-primary border-b pb-2">
          Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Compliance)
        </h2>
        <div class="flex justify-center items-center mb-6">
          <div id="overall-compliance-chart" class="w-32 h-32"></div>
        </div>
        <h2 class="text-md font-semibold mb-3 text-center text-dark">Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
        <div class="grid grid-cols-4 gap-2 text-center" id="department-compliance"></div>
      </div>
    </div>

    <!-- =================== Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ =================== -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ===== -->
      <div class="lg:col-span-1" id="form-container">
        <div class="bg-white p-6 rounded-lg shadow-lg border border-secondary/20 sticky top-8">
          <h2 class="text-xl font-bold mb-5 border-b pb-2 text-primary flex items-center">
            <i class="fas fa-plus-circle ml-2 text-secondary"></i>
            Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
          </h2>

          <form id="calibration-form">
            <div class="space-y-4">
              <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                  Ø§Ù„Ù‚Ø³Ù… <span class="text-danger">*</span>
                </label>
                <select id="department" name="department" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition duration-150">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>
                </select>
              </div>

              <div>
                <label for="staff" class="block text-sm font-medium text-gray-700 mb-1">
                  Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ <span class="text-danger">*</span>
                </label>
                <input type="text" id="staff" name="staff" required list="staff-list"
                       placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø£Ùˆ Ø§Ø®ØªØ±Ù‡"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition duration-150" />
                <datalist id="staff-list"></datalist>
              </div>

              <div>
                <label for="asset" class="block text-sm font-medium text-gray-700 mb-1">
                  Ø§Ù„Ù…Ù‡Ù…Ø© / Ø§Ù„Ø¬Ù‡Ø§Ø² (Task) <span class="text-danger">*</span>
                </label>
                <select id="asset" name="asset" required disabled
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 focus:outline-none focus:ring-primary focus:border-primary transition duration-150">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>
                </select>
              </div>

              <div>
                <label for="testDate" class="block text-sm font-medium text-gray-700 mb-1">
                  ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ <span class="text-danger">*</span>
                </label>
                <input type="date" id="testDate" name="testDate" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition duration-150" />
              </div>

              <div>
                <label for="frequency" class="block text-sm font-medium text-gray-700 mb-1">
                  Ø§Ù„ØªÙƒØ±Ø§Ø± <span class="text-danger">*</span>
                </label>
                <select id="frequency" name="frequency" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition duration-150">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªÙƒØ±Ø§Ø±...</option>
                  <option value="ÙŠÙˆÙ…ÙŠ">ÙŠÙˆÙ…ÙŠ (Daily)</option>
                  <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Weekly)</option>
                  <option value="Ø´Ù‡Ø±ÙŠ">Ø´Ù‡Ø±ÙŠ (Monthly)</option>
                  <option value="Ù†ØµÙ Ø³Ù†ÙˆÙŠ">Ù†ØµÙ Ø³Ù†ÙˆÙŠ (Semi-Annually)</option>
                  <option value="Ø³Ù†ÙˆÙŠ">Ø³Ù†ÙˆÙŠ (Annually)</option>
                </select>
              </div>

              <div>
                <label for="nextDue" class="block text-sm font-medium text-gray-700 mb-1">
                  ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…
                </label>
                <input type="date" id="nextDue" name="nextDue" readonly
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Ø§Ù„Ù†ØªÙŠØ¬Ø© <span class="text-danger">*</span>
                </label>
                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                  <label class="flex items-center cursor-pointer bg-success/10 p-2 rounded-lg transition duration-150 hover:bg-success/20">
                    <input type="radio" name="result" value="Pass" required
                           class="form-radio h-4 w-4 text-success" />
                    <span class="mr-2 text-success font-semibold">âœ… Ù…Ø·Ø§Ø¨Ù‚ (Pass)</span>
                  </label>
                  <label class="flex items-center cursor-pointer bg-danger/10 p-2 rounded-lg transition duration-150 hover:bg-danger/20">
                    <input type="radio" name="result" value="Fail"
                           class="form-radio h-4 w-4 text-danger" />
                    <span class="mr-2 text-danger font-semibold">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</span>
                  </label>
                </div>
              </div>

              <div>
                <label for="certificateFile"
                       class="block text-sm font-medium text-gray-700 mb-1">
                  Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF/ØµÙˆØ±Ø©) <span class="text-danger">*</span>
                </label>
                <input type="file" id="certificateFile" name="certificateFile"
                       accept="application/pdf,image/*" required
                       class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/80 transition duration-150" />
                <p id="file-status" class="text-xs text-gray-500 mt-1"></p>
              </div>

              <button type="submit" id="submit-btn"
                      class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                <i class="fas fa-save ml-2"></i>
                Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ===== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ===== -->
      <div class="lg:col-span-2">
        <div class="bg-white p-6 rounded-lg shadow-lg border border-secondary/20" id="table-container">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4"
               id="table-controls">
            <h2 class="text-xl font-bold text-primary flex items-center">
              <i class="fas fa-table ml-2 text-secondary"></i>
              Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø§Øª ÙˆØ§Ù„ÙØ­ÙˆØµØ§Øª
            </h2>
            <div class="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-3 rtl:space-x-reverse w-full md:w-auto">
              <div class="flex space-x-2 w-full md:w-auto">
                <select id="department-filter"
                        class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-sm w-full md:w-auto">
                  <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                </select>
                <input type="text" id="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª..."
                       class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-sm w-full md:w-auto" />
              </div>
              <div class="flex space-x-2 w-full md:w-auto">
                <button id="refresh-btn"
                        class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-accent transition duration-150 ease-in-out text-sm flex items-center">
                  <i class="fas fa-sync-alt ml-1"></i> ØªØ­Ø¯ÙŠØ«
                </button>
                <button id="print-btn" onclick="window.print()"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out text-sm flex items-center">
                  <i class="fas fa-print ml-1"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
              </div>
            </div>
          </div>

          <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200" id="logs-table">
              <thead class="bg-primary text-white">
                <tr>
                  <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„ÙˆÙ‚Øª</th>
                  <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ù‚Ø³Ù…</th>
                  <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                  <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                  <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ</th>
                  <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                  <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                  <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
                </tr>
              </thead>
              <tbody id="log-table-body" class="bg-white divide-y divide-gray-200">
                <tr>
                  <td colspan="8" class="text-center py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination Controls -->
          <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-gray-600">
            <div class="flex items-center gap-4">
              <div id="table-stats">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <span id="total-records">0</span></div>
              <div id="filter-stats" class="hidden">
                (ØªÙ… ØªØµÙÙŠØ©: <span id="filtered-count">0</span> Ù…Ù† <span id="total-count">0</span>)
              </div>
            </div>
            <div id="pagination-controls" class="flex items-center gap-2">
              <button id="first-page" onclick="goToPage(1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-double-right"></i>
              </button>
              <button id="prev-page" onclick="goToPage(currentPage - 1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-right"></i>
              </button>
              <span class="px-3">
                ØµÙØ­Ø© <span id="current-page-num">1</span> Ù…Ù† <span id="total-pages">1</span>
              </span>
              <button id="next-page" onclick="goToPage(currentPage + 1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-left"></i>
              </button>
              <button id="last-page" onclick="goToPage(totalPages)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-double-left"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- =================== Ø§Ù„Ø³ÙƒØ±Ø¨Øª =================== -->
  <script>
    // Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Web App
    const CAL_API_URL =
      'https://script.google.com/macros/s/AKfycbxhKSq0qMIT85_pUfiba5V5Pi-kO_Df4Qw98MRIM4fmCb-XcheI8uGQccFxuKjigATHlQ/exec';

    // Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
    let assetsMap = {};
    let staffList = [];
    let allRecords = [];
    let filteredRecords = [];
    let DEPARTMENTS_LIST = [];
    let uploadedFileBase64 = null;
    let uploadedFileMimeType = null;
    let uploadedFileName = null;
    
    // Pagination
    const RECORDS_PER_PAGE = 25;
    let currentPage = 1;

    // Ø¹Ù†Ø§ØµØ± DOM
    const elements = {
      loadingOverlay: document.getElementById('loading-overlay'),
      form: document.getElementById('calibration-form'),
      departmentSelect: document.getElementById('department'),
      assetSelect: document.getElementById('asset'),
      testDateInput: document.getElementById('testDate'),
      frequencySelect: document.getElementById('frequency'),
      nextDueInput: document.getElementById('nextDue'),
      certificateFileInput: document.getElementById('certificateFile'),
      fileStatus: document.getElementById('file-status'),
      submitBtn: document.getElementById('submit-btn'),
      tableBody: document.getElementById('log-table-body'),
      searchInput: document.getElementById('search-input'),
      staffDatalist: document.getElementById('staff-list'),
      alertBanner: document.getElementById('smart-alert-banner'),
      alertMessage: document.getElementById('alert-message'),
      departmentFilter: document.getElementById('department-filter'),
      refreshBtn: document.getElementById('refresh-btn'),
      dismissAlert: document.getElementById('dismiss-alert'),
      lastUpdate: document.getElementById('last-update'),
      tableStats: document.getElementById('table-stats'),
      filterStats: document.getElementById('filter-stats'),
      totalRecords: document.getElementById('total-records'),
      filteredCount: document.getElementById('filtered-count'),
      totalCount: document.getElementById('total-count')
    };

    // ================ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® ================
    function todayYMD() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const da = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${da}`;
    }

    function parseYMD(value) {
      if (!value) return null;
      const s = value.toString().trim();
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const y = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10);
      const d = parseInt(m[3], 10);
      if (!y || !mo || !d) return null;
      return new Date(y, mo - 1, d);
    }

    function compareYMD(a, b) {
      const da = parseYMD(a);
      const db = parseYMD(b);
      if (!da || !db) return 0;
      const ay = da.getFullYear(), am = da.getMonth(), ad = da.getDate();
      const by = db.getFullYear(), bm = db.getMonth(), bd = db.getDate();
      if (ay === by && am === bm && ad === bd) return 0;
      if (ay < by || (ay === by && am < bm) || (ay === by && am === bm && ad < bd)) return -1;
      return 1;
    }

    // ØªØ¬Ø§ÙˆØ² ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø© (Ø¥Ø¬Ø§Ø²Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©)
    function skipFriday(date) {
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ø¬Ù…Ø¹Ø© (5)ØŒ Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ø¨Øª
      if (date.getDay() === 5) {
        date.setDate(date.getDate() + 1);
      }
      return date;
    }

    function addDaysYMD(ymd, days, skipFridayFlag = false) {
      const d = parseYMD(ymd);
      if (!d) return '';
      d.setDate(d.getDate() + days);
      // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¬Ù…Ø¹Ø© Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨
      if (skipFridayFlag) skipFriday(d);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const da = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${da}`;
    }

    function addMonthsYMD(ymd, months) {
      const d = parseYMD(ymd);
      if (!d) return '';
      d.setMonth(d.getMonth() + months);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const da = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${da}`;
    }

    function addYearsYMD(ymd, years) {
      const d = parseYMD(ymd);
      if (!d) return '';
      d.setFullYear(d.getFullYear() + years);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const da = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${da}`;
    }

    function displayDate(value) {
      if (!value) return 'â€”';
      const s = value.toString().trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      // Ù„Ùˆ ØªØ§ÙŠÙ… Ø³ØªØ§Ù…Ø¨: Ù†Ø£Ø®Ø° Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0, 10);
      return s;
    }

    function getTodayClear() {
      const d = new Date();
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function showLoading(isLoading) {
      elements.loadingOverlay.classList.toggle('hidden', !isLoading);
    }

    function toggleSubmitLoading(isLoading) {
      elements.submitBtn.disabled = isLoading;
      elements.submitBtn.innerHTML = isLoading
        ? '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'
        : '<i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
    }

    function showNotification(message, type = 'success') {
      alert((type === 'success' ? 'âœ… Ù†Ø¬Ø§Ø­: ' : 'âŒ Ø®Ø·Ø£: ') + message);
    }

    // ================= Ø§Ù„ØªÙ‡ÙŠØ¦Ø© =================
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©...');
      setupEventListeners();
      elements.testDateInput.value = todayYMD();
      calculateNextDue();
      await fetchData();
    }

    function setupEventListeners() {
      elements.departmentSelect.addEventListener('change', handleDepartmentChange);
      elements.testDateInput.addEventListener('change', calculateNextDue);
      elements.frequencySelect.addEventListener('change', calculateNextDue);
      elements.certificateFileInput.addEventListener('change', handleFileUpload);
      elements.form.addEventListener('submit', handleSubmit);
      elements.searchInput.addEventListener('keyup', filterTable);
      elements.departmentFilter.addEventListener('change', filterTable);
      elements.refreshBtn.addEventListener('click', () => fetchData(true));
      elements.dismissAlert.addEventListener('click', () =>
        elements.alertBanner.classList.add('hidden')
      );
    }

    // ================ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ API ================
    async function fetchData(forceRefresh = false) {
      showLoading(true);
      try {
        console.log('ğŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API...');
        const url = forceRefresh ? `${CAL_API_URL}?refresh=true` : CAL_API_URL;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….');
        }

        const data = await response.json();
        if (!data || data.status !== 'success') {
          throw new Error(data && data.message ? data.message : 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
        }

        assetsMap = data.data.assetsMap || {};
        staffList = data.data.staffList || [];
        allRecords = (data.data.records || []).map(record => ({
          Timestamp: record.Timestamp,
          department: record.Department,
          staff: record.Staff,
          assetID: record.AssetID,
          assetName: record.AssetName,
          testDate: record.TestDate,
          frequency: record.Frequency,
          nextDue: record.NextDue,
          result: record.Result,
          CertificateLink:
            record.Certificate || record.CertificateLink || record.CertificatePdf || '',
          FileLink: record.File || record.FileLink || ''
        }));

        DEPARTMENTS_LIST = Object.keys(assetsMap || {});
        populateDepartments();
        processData();
        updateLastUpdateTime();
      } catch (err) {
        console.error(err);
        elements.tableBody.innerHTML =
          '<tr><td colspan="8" class="text-center py-4 text-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª.</td></tr>';
        showNotification('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + err.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function updateLastUpdateTime() {
      const now = new Date();
      elements.lastUpdate.textContent = now.toLocaleString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function processData() {
      renderStaffList();
      const statuses = calculateAssetStatuses(allRecords);
      renderDashboard(statuses);
      renderTable(allRecords);
      checkSmartAlerts(statuses);
      updateTableStats();
    }

    // ================ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ================
    function populateDepartments() {
      elements.departmentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>';
      elements.departmentFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>';

      DEPARTMENTS_LIST.sort().forEach(dept => {
        const opt1 = document.createElement('option');
        opt1.value = dept;
        opt1.textContent = dept;
        elements.departmentSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = dept;
        opt2.textContent = dept;
        elements.departmentFilter.appendChild(opt2);
      });
    }

    function handleDepartmentChange() {
      const department = elements.departmentSelect.value;
      elements.assetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ø¬Ù‡Ø§Ø²...</option>';

      if (department && assetsMap[department]) {
        const sortedAssets = assetsMap[department].slice().sort((a, b) =>
          a.name.localeCompare(b.name)
        );
        sortedAssets.forEach(asset => {
          const option = document.createElement('option');
          option.value = asset.id;
          option.textContent = asset.name;
          elements.assetSelect.appendChild(option);
        });
        elements.assetSelect.disabled = false;
        elements.assetSelect.classList.remove('bg-gray-100');
      } else {
        elements.assetSelect.disabled = true;
        elements.assetSelect.classList.add('bg-gray-100');
      }
    }

    // âœ… Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (ÙŠÙˆÙ…ÙŠ/Ø£Ø³Ø¨ÙˆØ¹ÙŠ/Ø´Ù‡Ø±ÙŠ/Ù†ØµÙ Ø³Ù†ÙˆÙŠ/Ø³Ù†ÙˆÙŠ)
    function calculateNextDue() {
      const testDateValue = elements.testDateInput.value; // yyyy-MM-dd
      let frequency = elements.frequencySelect.value;     // Ù…Ø«Ù„ "ÙŠÙˆÙ…ÙŠ"

      if (!testDateValue || !frequency) {
        elements.nextDueInput.value = '';
        return;
      }

      // Ù„Ùˆ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§ ÙƒØªØ¨Ù†Ø§ "ÙŠÙˆÙ…ÙŠ (Daily)" Ù†Ù†Ø¸ÙÙ‡:
      frequency = frequency.split('(')[0].trim();

      let nextYMD = testDateValue;

      switch (frequency) {
        case 'ÙŠÙˆÙ…ÙŠ':
          // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¬Ù…Ø¹Ø© (Ø¥Ø¬Ø§Ø²Ø©) ÙÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ
          nextYMD = addDaysYMD(testDateValue, 1, true);
          break;
        case 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ':
          nextYMD = addDaysYMD(testDateValue, 7);
          break;
        case 'Ø´Ù‡Ø±ÙŠ':
          nextYMD = addMonthsYMD(testDateValue, 1);
          break;
        case 'Ù†ØµÙ Ø³Ù†ÙˆÙŠ':
          nextYMD = addMonthsYMD(testDateValue, 6);
          break;
        case 'Ø³Ù†ÙˆÙŠ':
          nextYMD = addYearsYMD(testDateValue, 1);
          break;
        default:
          nextYMD = testDateValue;
      }

      elements.nextDueInput.value = nextYMD || '';
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      elements.fileStatus.textContent = '';
      uploadedFileBase64 = null;

      if (!file) return;

      if (!file.type.match('application/pdf') && !file.type.match('image.*')) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø© ÙÙ‚Ø·.', 'error');
        event.target.value = '';
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª).', 'error');
        event.target.value = '';
        return;
      }

      elements.fileStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...';

      const reader = new FileReader();
      reader.onload = function (e) {
        uploadedFileBase64 = e.target.result.split(',')[1];
        uploadedFileMimeType = file.type;
        uploadedFileName = file.name;
        elements.fileStatus.textContent = `ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø©: ${file.name}`;
      };
      reader.onerror = function () {
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
        elements.fileStatus.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.';
      };
      reader.readAsDataURL(file);
    }

    async function handleSubmit(event) {
      event.preventDefault();

      if (!uploadedFileBase64) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.', 'error');
        return;
      }

      const formData = new FormData(elements.form);
      const selectedAssetOption =
        elements.assetSelect.options[elements.assetSelect.selectedIndex];
      const assetName = selectedAssetOption ? selectedAssetOption.textContent : '';

      const payload = {
        action: 'logCalibration',
        data: {
          department: formData.get('department'),
          staff: formData.get('staff'),
          assetID: formData.get('asset'),
          assetName: assetName,
          testDate: formData.get('testDate'),
          frequency: formData.get('frequency'),
          nextDue: formData.get('nextDue'),
          result: formData.get('result')
        },
        fileData: {
          fileName: uploadedFileName,
          mimeType: uploadedFileMimeType,
          base64: uploadedFileBase64
        }
      };

      toggleSubmitLoading(true);

      try {
        console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ API...');
        const response = await fetch(CAL_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });

        const responseText = await response.text();
        let responseData;
        try {
          responseData = JSON.parse(responseText);
        } catch (e) {
          console.error('Invalid JSON:', responseText);
          throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (ØªØ­Ù‚Ù‚ Ù…Ù† Apps Script).');
        }

        if (responseData.status !== 'success') {
          throw new Error(responseData.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©.');
        }

        showNotification(
          responseData.message || 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.',
          'success'
        );

        if (responseData.data && responseData.data.newRecord) {
          const n = responseData.data.newRecord;
          allRecords.unshift({
            Timestamp: n.Timestamp,
            department: n.Department,
            staff: n.Staff,
            assetID: n.AssetID,
            assetName: n.AssetName,
            testDate: n.TestDate,
            frequency: n.Frequency,
            nextDue: n.NextDue,
            result: n.Result,
            CertificateLink:
              n.Certificate || n.CertificatePdf || '',
            FileLink: n.File || ''
          });
          processData();
        } else {
          // ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø´ÙŠØª
          await fetchData(true);
        }

        resetForm();
      } catch (err) {
        console.error(err);
        showNotification('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„: ' + err.message, 'error');
      } finally {
        toggleSubmitLoading(false);
      }
    }

    function resetForm() {
      elements.form.reset();
      uploadedFileBase64 = null;
      elements.fileStatus.textContent = '';
      elements.assetSelect.disabled = true;
      elements.assetSelect.classList.add('bg-gray-100');
      elements.assetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>';
      elements.testDateInput.value = todayYMD();
      calculateNextDue();
    }

    // ================ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ================
    function calculateAssetStatuses(records) {
      console.group('ğŸ” ØªØ­Ù„ÙŠÙ„ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…');

      const statuses = {
        Pass: 0,
        Fail: 0,
        Overdue: 0,
        Upcoming: 0,
        Unscheduled: 0,
        DepartmentCompliance: {},
        Assets: {}
      };

      DEPARTMENTS_LIST.forEach(dept => {
        statuses.DepartmentCompliance[dept] = {
          pass: 0,
          total: 0,
          taskCount: assetsMap[dept]?.length || 0
        };
      });

      const latestRecords = {};
      const sorted = [...records].sort((a, b) =>
        a.Timestamp < b.Timestamp ? 1 : -1
      );

      sorted.forEach(r => {
        if (r.assetID && !latestRecords[r.assetID]) {
          latestRecords[r.assetID] = r;
        }
      });

      const today = todayYMD();
      const upcomingThreshold = addDaysYMD(today, 30);

      Object.values(latestRecords).forEach(r => {
        const deptStats = statuses.DepartmentCompliance[r.department];
        if (!deptStats) return;

        if (r.result === 'Pass') statuses.Pass++;
        else statuses.Fail++;

        deptStats.total++;
        if (r.result === 'Pass') deptStats.pass++;

        const nd = r.nextDue;
        if (nd) {
          if (compareYMD(nd, today) === -1) {
            statuses.Overdue++;
          } else if (
            compareYMD(nd, today) >= 0 &&
            compareYMD(nd, upcomingThreshold) <= 0
          ) {
            statuses.Upcoming++;
          }
        }

        statuses.Assets[r.assetID] = r;
      });

      let totalManagedTasks = 0;
      Object.values(assetsMap).forEach(arr => (totalManagedTasks += arr.length));
      statuses.Unscheduled = Math.max(
        0,
        totalManagedTasks - Object.keys(latestRecords).length
      );

      console.groupEnd();
      return statuses;
    }

    function renderDashboard(statuses) {
      document.getElementById('count-pass').textContent = statuses.Pass;
      document.getElementById('count-fail').textContent = statuses.Fail;
      document.getElementById('count-overdue').textContent = statuses.Overdue;
      document.getElementById('count-upcoming').textContent = statuses.Upcoming;
      document.getElementById('count-unscheduled').textContent =
        statuses.Unscheduled;

      const failKpi = document.getElementById('kpi-fail');
      failKpi.classList.toggle('animate-pulsate-alert', statuses.Fail > 0);

      const overdueKpi = document.getElementById('kpi-overdue');
      overdueKpi.classList.toggle('animate-pulsate-alert', statuses.Overdue > 0);

      let totalTasks = 0;
      Object.values(assetsMap).forEach(arr => (totalTasks += arr.length));

      let overallCompliance = 100;
      if (totalTasks > 0) {
        overallCompliance = (statuses.Pass / totalTasks) * 100;
      }

      renderCircularChart(
        'overall-compliance-chart',
        overallCompliance,
        '#8B0000',
        false
      );

      const deptContainer = document.getElementById('department-compliance');
      deptContainer.innerHTML = '';

      DEPARTMENTS_LIST.forEach(dept => {
        const stats = statuses.DepartmentCompliance[dept];
        let compliance = 100;
        if (stats.taskCount > 0) {
          compliance = (stats.pass / stats.taskCount) * 100;
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'flex flex-col items-center';

        const chartDiv = document.createElement('div');
        chartDiv.id = `compliance-${dept}`;
        wrapper.appendChild(chartDiv);

        renderCircularChart(chartDiv.id, compliance, '#D4AF37', true);

        const label = document.createElement('p');
        label.className = 'text-xs font-semibold mt-1';
        label.textContent = dept;
        wrapper.appendChild(label);

        deptContainer.appendChild(wrapper);
      });
    }

    function renderCircularChart(containerId, percentage, defaultColor, isSmall) {
      const container = document.getElementById(containerId);
      if (!container) return;

      let dynamicColor = defaultColor;
      if (percentage < 60) dynamicColor = '#dc3545';
      else if (percentage < 90) dynamicColor = '#D4AF37';
      else if (percentage >= 95) dynamicColor = '#28a745';

      const radius = 15.9155;
      const circumference = 100;
      const dasharray = `${(percentage / 100) * circumference} ${circumference}`;
      const sizeClass = isSmall ? 'w-16 h-16' : 'w-24 h-24';
      const strokeWidth = isSmall ? '3.8' : '2.8';
      const fontSize = isSmall ? '0.4em' : '0.5em';

      container.innerHTML = `
        <svg viewBox="0 0 36 36" class="circular-chart ${sizeClass}">
          <path class="circle-bg" stroke-width="3.8"
                d="M18 2.0845 a ${radius} ${radius} 0 0 1 0 31.831 a ${radius} ${radius} 0 0 1 0 -31.831" />
          <path class="circle" stroke="${dynamicColor}" stroke-width="${strokeWidth}"
                stroke-dasharray="${dasharray}"
                d="M18 2.0845 a ${radius} ${radius} 0 0 1 0 31.831 a ${radius} ${radius} 0 0 1 0 -31.831" />
          <text x="18" y="20.35" class="percentage" style="font-size: ${fontSize};">
            ${Math.round(percentage)}%
          </text>
        </svg>
      `;
    }

    let totalPages = 1;

    function goToPage(page) {
      const maxPage = Math.ceil(filteredRecords.length / RECORDS_PER_PAGE) || 1;
      if (page < 1) page = 1;
      if (page > maxPage) page = maxPage;
      currentPage = page;
      renderTablePage();
      updatePaginationControls();
    }

    function updatePaginationControls() {
      totalPages = Math.ceil(filteredRecords.length / RECORDS_PER_PAGE) || 1;
      document.getElementById('current-page-num').textContent = currentPage;
      document.getElementById('total-pages').textContent = totalPages;
      
      document.getElementById('first-page').disabled = currentPage === 1;
      document.getElementById('prev-page').disabled = currentPage === 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;
      document.getElementById('last-page').disabled = currentPage >= totalPages;
    }

    function renderTable(records) {
      if (!records || records.length === 0) {
        filteredRecords = [];
        elements.tableBody.innerHTML =
          '<tr><td colspan="8" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©.</td></tr>';
        updatePaginationControls();
        return;
      }

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
      filteredRecords = [...records].sort((a, b) =>
        a.Timestamp < b.Timestamp ? 1 : -1
      );
      
      currentPage = 1;
      renderTablePage();
      updatePaginationControls();
    }

    function renderTablePage() {
      if (!filteredRecords || filteredRecords.length === 0) {
        elements.tableBody.innerHTML =
          '<tr><td colspan="8" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©.</td></tr>';
        return;
      }

      const today = todayYMD();
      const weeklyThreshold = addDaysYMD(today, 7);

      // Ø­Ø³Ø§Ø¨ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
      const startIndex = (currentPage - 1) * RECORDS_PER_PAGE;
      const endIndex = startIndex + RECORDS_PER_PAGE;
      const pageRecords = filteredRecords.slice(startIndex, endIndex);

      elements.tableBody.innerHTML = pageRecords
        .map(record => {
          const isPass = record.result === 'Pass';
          const resultHtml = `
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
              isPass ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'
            }">
              ${isPass ? 'âœ… Ù…Ø·Ø§Ø¨Ù‚' : 'âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚'}
            </span>
          `;

          let certificateHtml = 'N/A';
          if (record.CertificateLink && record.CertificateLink !== 'N/A') {
            certificateHtml = `
              <a href="${record.CertificateLink}" target="_blank"
                 class="text-primary hover:text-primary/80 transition duration-150 flex items-center justify-center bg-white border border-primary rounded-lg px-3 py-2 hover:bg-primary/10">
                <i class="fas fa-file-pdf ml-1 text-danger"></i>
                <span>Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</span>
              </a>
            `;
          } else if (record.FileLink && record.FileLink !== 'N/A') {
            certificateHtml = `
              <a href="${record.FileLink}" target="_blank"
                 class="text-primary hover:text-primary/80 transition duration-150 flex items-center justify-center bg-white border border-primary rounded-lg px-3 py-2 hover:bg-primary/10">
                <i class="fas fa-file-alt ml-1 text-info"></i>
                <span>Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span>
              </a>
            `;
          }

          let rowClass = '';
          const nd = record.nextDue;
          if (nd) {
            if (compareYMD(nd, today) === -1) {
              rowClass = 'bg-danger/10';
            } else if (
              compareYMD(nd, today) >= 0 &&
              compareYMD(nd, weeklyThreshold) <= 0
            ) {
              rowClass = 'row-upcoming animate-upcoming-glow';
            }
          }

          const assetDisplay = record.assetName || record.assetID || '';

          return `
            <tr class="${rowClass} hover:bg-gray-50 transition duration-150">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${displayDate(record.Timestamp)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-dark">
                ${record.department}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-dark">
                ${record.staff}
              </td>
              <td class="px-6 py-4 text-sm text-dark max-w-sm truncate" title="${assetDisplay}">
                ${assetDisplay}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${displayDate(record.testDate)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">
                ${displayDate(record.nextDue)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                ${resultHtml}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                ${certificateHtml}
              </td>
            </tr>
          `;
        })
        .join('');

      updateTableStats();
    }

    function renderStaffList() {
      elements.staffDatalist.innerHTML = staffList
        .map(s => `<option value="${s}">`)
        .join('');
    }

    function updateTableStats() {
      elements.totalRecords.textContent = allRecords.length || 0;
    }

    function checkSmartAlerts(statuses) {
      const today = todayYMD();
      const weeklyThreshold = addDaysYMD(today, 7);
      const imminentDepartments = new Set();

      Object.values(statuses.Assets).forEach(asset => {
        const nd = asset.nextDue;
        if (
          nd &&
          compareYMD(nd, today) >= 0 &&
          compareYMD(nd, weeklyThreshold) <= 0
        ) {
          imminentDepartments.add(asset.department);
        }
      });

      const alerts = [];
      if (statuses.Unscheduled > 0) {
        alerts.push(
          `<i class="fas fa-info-circle ml-2"></i>ØªÙ†Ø¨ÙŠÙ‡: ØªÙˆØ¬Ø¯ <strong>${statuses.Unscheduled}</strong> Ù…Ù‡Ù…Ø©/Ù…Ù‡Ø§Ù… Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø³Ø¬Ù„ Ù„Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯).`
        );
      }
      if (imminentDepartments.size > 0) {
        alerts.push(
          `<i class="fas fa-exclamation-triangle ml-2"></i>ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…: ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠØ±Ø§Øª Ù…Ø³ØªØ­Ù‚Ø© (Ø£Ùˆ Ù…ØªØ£Ø®Ø±Ø©) Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù‚Ø³Ù…/Ø£Ù‚Ø³Ø§Ù…: <strong>${Array.from(
            imminentDepartments
          ).join(', ')}</strong>.`
        );
      }

      if (alerts.length > 0) {
        elements.alertBanner.classList.remove('hidden');
        elements.alertMessage.innerHTML = alerts.join('<br><br>');
      } else {
        elements.alertBanner.classList.add('hidden');
      }
    }

    // ================ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© ================
    function filterTable() {
      const searchFilter = elements.searchInput.value.trim().toUpperCase();
      const departmentFilter = elements.departmentFilter.value;

      // ØªØ±ØªÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
      const sorted = [...allRecords].sort((a, b) =>
        a.Timestamp < b.Timestamp ? 1 : -1
      );

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
      filteredRecords = sorted.filter(record => {
        let matchSearch = true;
        let matchDept = true;

        // ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
        if (searchFilter) {
          const searchableText = [
            record.Timestamp || '',
            record.department || '',
            record.staff || '',
            record.assetID || '',
            record.assetName || '',
            record.testDate || '',
            record.nextDue || '',
            record.result || ''
          ].join(' ').toUpperCase();
          
          matchSearch = searchableText.includes(searchFilter);
        }

        // ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù…
        if (departmentFilter) {
          matchDept = record.department === departmentFilter;
        }

        return matchSearch && matchDept;
      });

      // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      currentPage = 1;
      renderTablePage();
      updatePaginationControls();
      updateFilterStats();
    }

    function updateFilterStats() {
      if (elements.searchInput.value || elements.departmentFilter.value) {
        elements.filterStats.classList.remove('hidden');
        elements.filteredCount.textContent = filteredRecords.length;
        elements.totalCount.textContent = allRecords.length;
      } else {
        elements.filterStats.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
