<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ | Ø³Ø¬Ù„ Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL) - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>

  <!-- Tailwind CSS (Ù…Ù„Ù CSS ÙÙ‚Ø· ÙŠÙƒÙÙŠØŒ Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… tailwind.config) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* ============ Ø£Ù„ÙˆØ§Ù† ÙˆÙ‡ÙˆÙŠØ© CBAHI ÙƒÙ€ Utilities ============ */
    :root{
      --cbahi-blue:#00529B; --cbahi-gold:#E9C46A; --cbahi-green:#28a745; --cbahi-red:#dc3545; --cbahi-orange:#f59e0b;
    }
    .text-cbahi-blue{color:var(--cbahi-blue)} .bg-cbahi-blue{background-color:var(--cbahi-blue)}
    .border-cbahi-gold{border-color:var(--cbahi-gold)}
    .text-cbahi-green{color:var(--cbahi-green)} .text-cbahi-red{color:var(--cbahi-red)} .text-cbahi-orange{color:var(--cbahi-orange)}
    .bg-cbahi-green{background-color:var(--cbahi-green)} .bg-cbahi-red{background-color:var(--cbahi-red)} .bg-cbahi-orange{background-color:var(--cbahi-orange)}

    /* Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª */
    @keyframes pulsating-alert{0%,100%{box-shadow:0 0 5px rgba(220,53,69,.5)}50%{box-shadow:0 0 20px rgba(220,53,69,.8)}}
    @keyframes upcoming-glow{0%,100%{background-color:rgba(233,196,106,.1)}50%{background-color:rgba(233,196,106,.3)}}
    .animate-pulsate-alert{animation:pulsating-alert 2s infinite}
    .animate-upcoming-glow{animation:upcoming-glow 3s infinite}
    .row-upcoming{border-right:4px solid var(--cbahi-gold)}

    /* Ù…Ø®Ø·Ø· Ø¯Ø§Ø¦Ø±ÙŠ SVG */
    .circular-chart{display:block;margin:10px auto}
    .circle-bg{fill:none;stroke:#eee;stroke-width:3.8}
    .circle{fill:none;stroke-linecap:round;transition:stroke-dasharray .6s ease;transform:rotate(-90deg);transform-origin:50% 50%}
    .percentage{fill:#666;font-family:'Tajawal',sans-serif;text-anchor:middle;font-weight:bold}

    /* Ø·Ø¨Ø§Ø¹Ø© */
    @media print{
      body{background:#fff}
      header,#smart-alert-banner,#dashboard-kpis,#compliance-indicators,#form-container,#table-controls,.shadow-md,.shadow-lg{display:none!important}
      #table-container{display:block!important;box-shadow:none;width:100%;margin:0;padding:0}
      table{font-size:10pt;border-collapse:collapse;width:100%}
      th,td{border:1px solid #ccc;padding:5px}
      .row-upcoming,.bg-red-50{-webkit-print-color-adjust:exact;color-adjust:exact}
      .row-upcoming{background-color:rgba(233,196,106,.1)!important;animation:none!important}
      .bg-red-50{background-color:rgba(220,53,69,.1)!important}
    }
  </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

<section id="fms-calibration" class="container mx-auto p-4 md:p-8">
  <header class="mb-6 p-4 bg-white shadow-md rounded-lg text-center">
    <h1 class="text-2xl font-bold text-cbahi-blue">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL Log)</h1>
    <p class="text-gray-600">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p>
  </header>

  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <div class="text-center">
      <i class="fas fa-spinner fa-spin text-4xl text-cbahi-blue"></i>
      <p class="mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
    </div>
  </div>

  <div id="smart-alert-banner" class="hidden mb-6 p-4 bg-yellow-100 border-r-4 border-cbahi-gold text-yellow-800 rounded-lg shadow-sm">
    <p id="alert-message" class="font-semibold"></p>
  </div>

  <!-- KPIs + Compliance -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-2" id="dashboard-kpis">
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 bg-white p-5 rounded-lg border-t-4 border-cbahi-gold">
        <div id="kpi-pass" class="text-center p-3 bg-green-50 rounded-lg"><i class="fas fa-check-circle text-3xl text-cbahi-green mb-2"></i><p class="text-2xl font-bold" id="count-pass">0</p><p class="text-sm text-gray-600">âœ… Ù…Ø·Ø§Ø¨Ù‚ (Pass)</p></div>
        <div id="kpi-fail" class="text-center p-3 bg-red-50 rounded-lg"><i class="fas fa-times-circle text-3xl text-cbahi-red mb-2"></i><p class="text-2xl font-bold" id="count-fail">0</p><p class="text-sm text-gray-600">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</p></div>
        <div id="kpi-overdue" class="text-center p-3 bg-orange-50 rounded-lg"><i class="fas fa-exclamation-circle text-3xl text-cbahi-orange mb-2"></i><p class="text-2xl font-bold" id="count-overdue">0</p><p class="text-sm text-gray-600">âš ï¸ Ù…ØªØ£Ø®Ø± (Overdue)</p></div>
        <div id="kpi-upcoming" class="text-center p-3 bg-yellow-50 rounded-lg"><i class="fas fa-hourglass-half text-3xl text-cbahi-gold mb-2"></i><p class="text-2xl font-bold" id="count-upcoming">0</p><p class="text-sm text-gray-600">â³ Ù‚Ø§Ø¯Ù… (30 ÙŠÙˆÙ…)</p></div>
        <div id="kpi-unscheduled" class="text-center p-3 bg-gray-100 rounded-lg"><i class="fas fa-calendar-times text-3xl text-gray-500 mb-2"></i><p class="text-2xl font-bold" id="count-unscheduled">0</p><p class="text-sm text-gray-600">ğŸ•“ Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯</p></div>
      </div>
    </div>
    <div class="bg-white p-5 rounded-lg shadow-md" id="compliance-indicators">
      <h2 class="text-lg font-semibold mb-4 text-cbahi-blue">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</h2>
      <div class="flex justify-center items-center mb-6"><div id="overall-compliance-chart" class="w-32 h-32"></div></div>
      <h2 class="text-md font-semibold mb-3 text-center">Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
      <div class="grid grid-cols-4 gap-2 text-center" id="department-compliance"></div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Form -->
    <div class="lg:col-span-1" id="form-container">
      <div class="bg-white p-6 rounded-lg shadow-md sticky top-8">
        <h2 class="text-xl font-bold mb-5 border-b pb-2 text-cbahi-blue">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="calibration-form">
          <div class="space-y-4">
            <div>
              <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù‚Ø³Ù… <span class="text-red-500">*</span></label>
              <select id="department" name="department" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>
              </select>
            </div>
            <div>
              <label for="staff" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ <span class="text-red-500">*</span></label>
              <input type="text" id="staff" name="staff" required list="staff-list" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø£Ùˆ Ø§Ø®ØªØ±Ù‡" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none">
              <datalist id="staff-list"></datalist>
            </div>
            <div>
              <label for="asset" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ù‡Ù…Ø© / Ø§Ù„Ø¬Ù‡Ø§Ø² (Task) <span class="text-red-500">*</span></label>
              <select id="asset" name="asset" required disabled class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 focus:outline-none">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>
              </select>
            </div>
            <div>
              <label for="testDate" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ <span class="text-red-500">*</span></label>
              <input type="date" id="testDate" name="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none">
            </div>
            <div>
              <label for="frequency" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªÙƒØ±Ø§Ø± <span class="text-red-500">*</span></label>
              <select id="frequency" name="frequency" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªÙƒØ±Ø§Ø±...</option>
                <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
                <option value="Ø´Ù‡Ø±ÙŠ">Ø´Ù‡Ø±ÙŠ</option>
                <option value="Ù†ØµÙ Ø³Ù†ÙˆÙŠ">Ù†ØµÙ Ø³Ù†ÙˆÙŠ</option>
                <option value="Ø³Ù†ÙˆÙŠ">Ø³Ù†ÙˆÙŠ</option>
              </select>
            </div>
            <div>
              <label for="nextDue" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
              <input type="date" id="nextDue" name="nextDue" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù†ØªÙŠØ¬Ø© <span class="text-red-500">*</span></label>
              <div class="flex items-center space-x-4 rtl:space-x-reverse">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="result" value="Pass" required class="h-4 w-4">
                  <span class="mr-2 text-cbahi-green font-semibold">âœ… Ù…Ø·Ø§Ø¨Ù‚</span>
                </label>
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="result" value="Fail" class="h-4 w-4">
                  <span class="mr-2 text-cbahi-red font-semibold">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚</span>
                </label>
              </div>
            </div>
            <div>
              <label for="certificateFile" class="block text-sm font-medium text-gray-700 mb-1">Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF/ØµÙˆØ±Ø©) <span class="text-red-500">*</span></label>
              <input type="file" id="certificateFile" name="certificateFile" accept="application/pdf,image/*" required class="w-full text-sm text-gray-500">
              <p id="file-status" class="text-xs text-gray-500 mt-1"></p>
            </div>
            <button type="submit" id="submit-btn" class="w-full flex justify-center py-2 px-4 rounded-md text-sm font-medium text-white bg-cbahi-blue hover:bg-blue-800 focus:outline-none">
              <i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Table -->
    <div class="lg:col-span-2">
      <div class="bg-white p-6 rounded-lg shadow-md" id="table-container">
        <div class="flex justify-between items-center mb-4" id="table-controls">
          <h2 class="text-xl font-bold text-cbahi-blue">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø§Øª ÙˆØ§Ù„ÙØ­ÙˆØµØ§Øª</h2>
          <div class="flex items-center space-x-3 rtl:space-x-reverse">
            <input type="text" id="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª..." class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none text-sm">
            <button id="print-btn" onclick="window.print()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">
              <i class="fas fa-print ml-1"></i> Ø·Ø¨Ø§Ø¹Ø©
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="logs-table">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„ÙˆÙ‚Øª</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù‚Ø³Ù…</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
              </tr>
            </thead>
            <tbody id="log-table-body" class="bg-white divide-y divide-gray-200">
              <tr><td colspan="8" class="text-center py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* ================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ================== */
const CAL_API_URL = 'https://script.google.com/macros/s/AKfycbzoIG8-LebB96dXw_OafHGu5wYyYXtliQ19ctG1pAf8kj3S9RdR-RLj6D2h20VTrziWWA/exec';
/* Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Proxy Ø¥Ù† ÙØ¹Ù‘Ù„ØªÙ‡ (Cloudflare Worker Ù…Ø«Ù„Ø§Ù‹). Ø¥Ù† ØªØ±ÙƒØªÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ø³ØªØ¨Ù‚Ù‰ POST Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø§Ù„Ù€CORS: */
const PROXY_URL = ''; // Ù…Ø«Ø§Ù„: 'https://cal-proxy.yourdomain.workers.dev'

const API_POST_ENDPOINT = PROXY_URL || CAL_API_URL; // POST ÙŠÙ…Ø± Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§

/* =========== Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© =========== */
let assetsMap = {};
let staffList = [];
let allRecords = [];
let DEPARTMENTS_LIST = [];
let uploadedFileBase64 = null, uploadedFileMimeType = null, uploadedFileName = null;

/* =========== Ø¹Ù†Ø§ØµØ± DOM =========== */
const el = {
  loadingOverlay: document.getElementById('loading-overlay'),
  form: document.getElementById('calibration-form'),
  departmentSelect: document.getElementById('department'),
  assetSelect: document.getElementById('asset'),
  testDateInput: document.getElementById('testDate'),
  frequencySelect: document.getElementById('frequency'),
  nextDueInput: document.getElementById('nextDue'),
  certificateFileInput: document.getElementById('certificateFile'),
  fileStatus: document.getElementById('file-status'),
  submitBtn: document.getElementById('submit-btn'),
  tableBody: document.getElementById('log-table-body'),
  searchInput: document.getElementById('search-input'),
  staffDatalist: document.getElementById('staff-list'),
  alertBanner: document.getElementById('smart-alert-banner'),
  alertMessage: document.getElementById('alert-message'),
};

document.addEventListener('DOMContentLoaded', init);

async function init(){
  try{
    console.log('Initializing Calibration System...');
    setupListeners();
    el.testDateInput.valueAsDate = new Date();
    await fetchData();  // ÙŠØ­Ø§ÙˆÙ„ fetch Ø«Ù… ÙŠØ³Ù‚Ø· Ø¥Ù„Ù‰ JSONP Ø¥Ø°Ø§ Ù„Ø²Ù…
  }catch(e){
    console.error(e);
  }
}

function setupListeners(){
  el.departmentSelect.addEventListener('change', handleDepartmentChange);
  el.testDateInput.addEventListener('change', calculateNextDue);
  el.frequencySelect.addEventListener('change', calculateNextDue);
  el.certificateFileInput.addEventListener('change', handleFileUpload);
  el.form.addEventListener('submit', handleSubmit);
  el.searchInput.addEventListener('keyup', filterTable);
}

function showLoading(v){ el.loadingOverlay?.classList.toggle('hidden', !v); }
function toggleSubmitLoading(v){
  el.submitBtn.disabled = v;
  el.submitBtn.innerHTML = v ? '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : '<i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
}
function notify(msg, type='success'){ alert((type==='success'?'âœ… Ù†Ø¬Ø§Ø­: ':'âŒ Ø®Ø·Ø£: ')+msg); }
function formatDate(s){
  if(!s) return 'N/A';
  const d = new Date(s); if(isNaN(d)) return s;
  return d.toLocaleDateString('en-CA');
}
function todayClear(){ const t = new Date(); t.setHours(0,0,0,0); return t; }

/* ================== Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CORS-aware) ================== */
async function fetchData(force=false){
  showLoading(true);
  try{
    // Ù…Ø­Ø§ÙˆÙ„Ø© fetch Ø¹Ø§Ø¯ÙŠØ©
    let url = CAL_API_URL + (force ? '?refresh=true' : '');
    try{
      console.log('Fetching LIVE data from API...');
      const res = await fetch(url, { redirect:'follow' });
      const ct = res.headers.get('content-type') || '';
      if(!res.ok || !ct.includes('application/json')){
        throw new Error('Unexpected response');
      }
      const data = await res.json();
      if(!data || data.status!=='success') throw new Error(data?.message || 'Failed to fetch data');
      handleBootstrapData(data);
    }catch(err){
      console.warn('Fetch blocked or invalid, falling back to JSONP...', err);
      await fetchViaJSONP(force);
    }
  }catch(e){
    console.error('Error fetching data:', e);
    el.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø´Ø±/Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª).</td></tr>';
    notify(e.message || 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','error');
  }finally{
    showLoading(false);
  }
}

/* JSONP Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© (Ù„Ø§ ÙŠØ­ØªØ§Ø¬ CORS) */
function fetchViaJSONP(force=false){
  return new Promise((resolve, reject)=>{
    const cb = '__CAL_BOOTSTRAP_'+Math.random().toString(36).slice(2);
    window[cb] = (payload)=>{
      try{ handleBootstrapData(payload); resolve(); }
      catch(e){ reject(e); }
      finally{ delete window[cb]; s.remove(); }
    };
    const s = document.createElement('script');
    s.src = CAL_API_URL + (force? '?refresh=true&':'?') + 'prefix=' + cb;
    s.onerror = ()=>{ delete window[cb]; reject(new Error('JSONP failed')); };
    document.body.appendChild(s);
  });
}

function handleBootstrapData(resp){
  // resp = {status:'success', data:{assetsMap, staffList, records}}
  const data = resp.data || {};
  assetsMap = data.assetsMap || {};
  staffList = data.staffList || [];
  DEPARTMENTS_LIST = Object.keys(assetsMap);
  allRecords = (data.records || []).map(r=>({
    Timestamp:r.Timestamp, department:r.Department, staff:r.Staff,
    assetID:r.AssetID, assetName:r.AssetName, testDate:r.TestDate,
    frequency:r.Frequency, nextDue:r.NextDue, result:r.Result,
    CertificateLink:r.CertificateLink
  }));
  processData();
}

/* ================== Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ±Ø³ÙˆÙ… ================== */
function renderCircularChart(containerId, p, defaultColor, isSmall){
  const c = document.getElementById(containerId); if(!c) return;
  let color = defaultColor;
  if(p < 60) color = '#dc3545'; else if(p < 90) color = '#E9C46A'; else if(p >= 95) color = '#28a745';
  const radius = 15.9155, circ = 100, dash = `${(p/100)*circ} ${circ}`;
  const size = isSmall? 'w-16 h-16':'w-24 h-24', sw = isSmall?'3.8':'2.8', fs = isSmall?'0.4em':'0.5em';
  c.innerHTML = `
    <svg viewBox="0 0 36 36" class="circular-chart ${size}">
      <path class="circle-bg" stroke-width="3.8" d="M18 2.0845 a ${radius} ${radius} 0 0 1 0 31.831 a ${radius} ${radius} 0 0 1 0 -31.831"/>
      <path class="circle" stroke="${color}" stroke-width="${sw}" stroke-dasharray="${dash}" d="M18 2.0845 a ${radius} ${radius} 0 0 1 0 31.831 a ${radius} ${radius} 0 0 1 0 -31.831"/>
      <text x="18" y="20.35" class="percentage" style="font-size:${fs};">${Math.round(p)}%</text>
    </svg>`;
}

function renderStaffList(){ el.staffDatalist.innerHTML = staffList.map(s=>`<option value="${s}">`).join(''); }

function populateDepartments(){
  el.departmentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>';
  DEPARTMENTS_LIST.sort().forEach(d=>{
    const o = document.createElement('option'); o.value = d; o.textContent = d; el.departmentSelect.appendChild(o);
  });
}

function handleDepartmentChange(){
  const d = el.departmentSelect.value;
  el.assetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ø¬Ù‡Ø§Ø²...</option>';
  if(d && assetsMap[d]){
    assetsMap[d].sort((a,b)=>a.name.localeCompare(b.name)).forEach(a=>{
      const o=document.createElement('option'); o.value=a.id; o.textContent=a.name; el.assetSelect.appendChild(o);
    });
    el.assetSelect.disabled=false; el.assetSelect.classList.remove('bg-gray-100');
  }else{ el.assetSelect.disabled=true; el.assetSelect.classList.add('bg-gray-100'); }
}

function calculateNextDue(){
  const v = el.testDateInput.value, f = el.frequencySelect.value;
  if(!v||!f){ el.nextDueInput.value=''; return; }
  const [Y,M,D] = v.split('-').map(n=>parseInt(n,10));
  const base = new Date(Y, M-1, D), next = new Date(base);
  if(f==='Ø£Ø³Ø¨ÙˆØ¹ÙŠ') next.setDate(base.getDate()+7);
  else if(f==='Ø´Ù‡Ø±ÙŠ') next.setMonth(base.getMonth()+1);
  else if(f==='Ù†ØµÙ Ø³Ù†ÙˆÙŠ') next.setMonth(base.getMonth()+6);
  else if(f==='Ø³Ù†ÙˆÙŠ') next.setFullYear(base.getFullYear()+1);
  el.nextDueInput.value = next.toLocaleDateString('en-CA');
}

function processData(){
  renderStaffList();
  populateDepartments();
  const statuses = calculateAssetStatuses(allRecords);
  renderDashboard(statuses);
  renderTable(allRecords);
  checkSmartAlerts(statuses);
}

function calculateAssetStatuses(recs){
  const s = {Pass:0, Fail:0, Overdue:0, Upcoming:0, Unscheduled:0, DepartmentCompliance:{}, Assets:{}};
  DEPARTMENTS_LIST.forEach(d=>s.DepartmentCompliance[d]={pass:0,total:0});
  const latest = {};
  [...recs].sort((a,b)=>new Date(b.Timestamp)-new Date(a.Timestamp)).forEach(r=>{ if(!latest[r.assetID]) latest[r.assetID]=r; });
  const today = todayClear(), upcoming = new Date(today); upcoming.setDate(today.getDate()+30);
  Object.values(latest).forEach(r=>{
    if(r.result==='Pass') s.Pass++; else if(r.result==='Fail') s.Fail++;
    if(s.DepartmentCompliance[r.department]){ s.DepartmentCompliance[r.department].total++; if(r.result==='Pass') s.DepartmentCompliance[r.department].pass++; }
    if(r.nextDue){ const nd = new Date(r.nextDue); if(!isNaN(nd)){ const c = new Date(nd.getFullYear(), nd.getMonth(), nd.getDate()); if(c<today) s.Overdue++; else if(c<=upcoming) s.Upcoming++; } }
    s.Assets[r.assetID]=r;
  });
  let totalTasks=0; Object.values(assetsMap).forEach(arr=>totalTasks+=arr.length);
  s.Unscheduled = Math.max(0, totalTasks - Object.keys(latest).length);
  return s;
}

function renderDashboard(s){
  document.getElementById('count-pass').textContent = s.Pass;
  document.getElementById('count-fail').textContent = s.Fail;
  document.getElementById('count-overdue').textContent = s.Overdue;
  document.getElementById('count-upcoming').textContent = s.Upcoming;
  document.getElementById('count-unscheduled').textContent = s.Unscheduled;
  document.getElementById('kpi-fail').classList.toggle('animate-pulsate-alert', s.Fail>0);
  document.getElementById('kpi-overdue').classList.toggle('animate-pulsate-alert', s.Overdue>0);

  const totalCalibrated = s.Pass + s.Fail;
  let totalTasks = 0; Object.values(assetsMap).forEach(a=>totalTasks+=a.length);
  const overall = totalCalibrated>0 ? (s.Pass/totalCalibrated)*100 : (totalTasks===0 ? 100 : 0);
  renderCircularChart('overall-compliance-chart', overall, '#00529B', false);

  const cont = document.getElementById('department-compliance'); cont.innerHTML='';
  DEPARTMENTS_LIST.forEach(d=>{
    const st=s.DepartmentCompliance[d]; const dTasks=assetsMap[d]?assetsMap[d].length:0;
    const pct = st.total>0 ? (st.pass/st.total)*100 : (dTasks>0?0:100);
    const div=document.createElement('div'); div.id='compliance-'+d; cont.appendChild(div);
    renderCircularChart(div.id, pct, '#E9C46A', true);
    const p=document.createElement('p'); p.className='text-xs font-semibold mt-1'; p.textContent=d; div.appendChild(p);
  });
}

function renderTable(recs){
  if(recs.length===0){ el.tableBody.innerHTML='<tr><td colspan="8" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©.</td></tr>'; return; }
  const today=todayClear(), week=new Date(today); week.setDate(today.getDate()+7);
  const rows=[...recs].sort((a,b)=>new Date(b.Timestamp)-new Date(a.Timestamp)).map(r=>{
    const pass = r.result==='Pass';
    const resultHTML = `<span class="px-2 inline-flex text-xs font-semibold rounded-full ${pass?'bg-green-100 text-cbahi-green':'bg-red-100 text-cbahi-red'}">${pass?'âœ… Ù…Ø·Ø§Ø¨Ù‚':'âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚'}</span>`;
    const cert = r.CertificateLink ? `<a href="${r.CertificateLink}" target="_blank" class="text-cbahi-blue hover:text-blue-800"><i class="fas fa-file-alt ml-1"></i> Ø¹Ø±Ø¶</a>` : 'N/A';
    let rowClass=''; if(r.nextDue){ const nd=new Date(r.nextDue); if(!isNaN(nd)){ const c=new Date(nd.getFullYear(),nd.getMonth(),nd.getDate()); if(c<today) rowClass='bg-red-50'; else if(c<=week) rowClass='row-upcoming animate-upcoming-glow'; } }
    const asset = r.assetName || r.assetID;
    return `<tr class="${rowClass} hover:bg-gray-50"><td class="px-6 py-4 text-sm text-gray-500">${formatDate(r.Timestamp)}</td><td class="px-6 py-4 text-sm font-medium text-gray-900">${r.department}</td><td class="px-6 py-4 text-sm text-gray-900">${r.staff}</td><td class="px-6 py-4 text-sm text-gray-900 max-w-sm truncate" title="${asset}">${asset}</td><td class="px-6 py-4 text-sm text-gray-500">${formatDate(r.testDate)}</td><td class="px-6 py-4 text-sm text-gray-500 font-semibold">${formatDate(r.nextDue)}</td><td class="px-6 py-4">${resultHTML}</td><td class="px-6 py-4 text-sm">${cert}</td></tr>`;
  }).join('');
  el.tableBody.innerHTML = rows;
}

function checkSmartAlerts(s){
  const today=todayClear(), week=new Date(today); week.setDate(today.getDate()+7);
  const imminent=new Set();
  Object.values(s.Assets).forEach(a=>{
    if(a.nextDue){ const nd=new Date(a.nextDue); if(!isNaN(nd)){ const c=new Date(nd.getFullYear(),nd.getMonth(),nd.getDate()); if(c<=week) imminent.add(a.department); } }
  });
  const alerts=[];
  if(s.Unscheduled>0) alerts.push(`<i class="fas fa-info-circle ml-2"></i>ØªÙ†Ø¨ÙŠÙ‡: ØªÙˆØ¬Ø¯ <strong>${s.Unscheduled}</strong> Ù…Ù‡Ù…Ø© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª.`);
  if(imminent.size>0) alerts.push(`<i class="fas fa-exclamation-triangle ml-2"></i>Ù…Ø¹Ø§ÙŠØ±Ø§Øª Ù…Ø³ØªØ­Ù‚Ø© Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙÙŠ: <strong>${[...imminent].join(', ')}</strong>.`);
  if(alerts.length>0){ el.alertBanner.classList.remove('hidden'); el.alertMessage.innerHTML=alerts.join('<br><br>'); } else { el.alertBanner.classList.add('hidden'); }
}

function filterTable(){
  const f = el.searchInput.value.toUpperCase();
  const rows = el.tableBody.getElementsByTagName('tr');
  for(let i=0;i<rows.length;i++){
    let vis=false; const cells=rows[i].getElementsByTagName('td');
    for(let j=0;j<cells.length;j++){ if(cells[j] && cells[j].textContent.toUpperCase().indexOf(f)>-1){ vis=true; break; } }
    rows[i].style.display = vis ? '' : 'none';
  }
}

/* ================== Ø§Ù„Ø±ÙØ¹/Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ================== */
function handleFileUpload(ev){
  const file = ev.target.files[0]; el.fileStatus.textContent=''; uploadedFileBase64=null;
  if(!file) return;
  if(!file.type.match('application/pdf') && !file.type.match('image.*')){ notify('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø© ÙÙ‚Ø·.','error'); ev.target.value=''; return; }
  if(file.size > 10*1024*1024){ notify('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¬Ø§ÙˆØ² 10MB.','error'); ev.target.value=''; return; }
  el.fileStatus.textContent='Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...';
  const r=new FileReader();
  r.onload = e=>{ uploadedFileBase64 = e.target.result.split(',')[1]; uploadedFileMimeType = file.type; uploadedFileName = file.name; el.fileStatus.textContent='ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø©: '+file.name; };
  r.onerror = ()=>{ notify('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.','error'); el.fileStatus.textContent='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.'; };
  r.readAsDataURL(file);
}

async function handleSubmit(ev){
  ev.preventDefault();
  if(!uploadedFileBase64){ notify('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ù‹Ø§.','error'); return; }
  const fd = new FormData(el.form);
  const opt = el.assetSelect.options[el.assetSelect.selectedIndex];
  const assetName = opt ? opt.textContent : 'Unknown Task';

  const payload = {
    action:'logCalibration',
    data:{
      department:fd.get('department'),
      staff:fd.get('staff'),
      assetID:fd.get('asset'),
      assetName:assetName,
      testDate:fd.get('testDate'),
      frequency:fd.get('frequency'),
      nextDue:fd.get('nextDue'),
      result:fd.get('result')
    },
    fileData:{ fileName:uploadedFileName, mimeType:uploadedFileMimeType, base64:uploadedFileBase64 }
  };

  toggleSubmitLoading(true);
  try{
    if(!API_POST_ENDPOINT){ throw new Error('Ø§Ù„Ù€POST ÙŠØ­ØªØ§Ø¬ Proxy CORS Ø¹Ù„Ù‰ Ù†Ø·Ø§Ù‚Ùƒ. ÙØ¹Ù‘Ù„ PROXY_URL ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù.'); }
    const res = await fetch(API_POST_ENDPOINT, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(payload) });
    const txt = await res.text(); let data;
    try{ data = JSON.parse(txt); }catch{ throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….'); }
    if(data.status!=='success') throw new Error(data.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.');

    notify(data.message || 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­','success');
    if(data.data && data.data.newRecord){
      const n = data.data.newRecord;
      allRecords.unshift({ Timestamp:n.Timestamp, department:n.Department, staff:n.Staff, assetID:n.AssetID, assetName:n.AssetName, testDate:n.TestDate, frequency:n.Frequency, nextDue:n.NextDue, result:n.Result, CertificateLink:n.CertificateLink });
      processData();
    }
    resetForm();
  }catch(e){
    console.error('Submit error:', e);
    notify(e.message,'error');
  }finally{
    toggleSubmitLoading(false);
  }
}

function resetForm(){
  el.form.reset(); uploadedFileBase64=null; el.fileStatus.textContent='';
  el.assetSelect.disabled=true; el.assetSelect.classList.add('bg-gray-100'); el.assetSelect.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>';
  el.testDateInput.valueAsDate = new Date();
}
</script>
</body>
</html>
