<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ | Ø³Ø¬Ù„ Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL) - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        // Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cbahi-blue': '#00529B',
                        'cbahi-gold': '#E9C46A',
                        'cbahi-green': '#28a745',
                        'cbahi-red': '#dc3545',
                        'cbahi-orange': '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                    },
                    // ğŸ’¡ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© (Visual Indicators)
                    boxShadow: {
                        'gold-glow': '0 0 15px rgba(233, 196, 106, 0.5)',
                    },
                    keyframes: {
                        // Ø¹Ù†Ø¯ â€œFailâ€ Ø£Ùˆ "Overdue" ÙŠØ¸Ù‡Ø± Ù„ÙˆÙ† Ø£Ø­Ù…Ø±/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù†Ø§Ø¨Ø¶ Ø®ÙÙŠÙ.
                        'pulsating-alert': {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(220, 53, 69, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(220, 53, 69, 0.8)' },
                        },
                        // Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ Ø°Ù‡Ø¨ÙŠ Ù…ØªÙˆÙ‡Ø¬ ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù‚ØªØ±Ø§Ø¨ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©
                        'upcoming-glow': {
                            '0%, 100%': { backgroundColor: 'rgba(233, 196, 106, 0.1)' },
                            '50%': { backgroundColor: 'rgba(233, 196, 106, 0.3)' },
                        }
                    },
                    animation: {
                        'pulsate-alert': 'pulsating-alert 2s infinite',
                        'upcoming-glow': 'upcoming-glow 3s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Styles for Circular Progress Charts */
        .circular-chart {
            display: block;
            margin: 10px auto;
        }
        .circle-bg {
            fill: none;
            stroke: #eee;
            stroke-width: 3.8;
        }
        .circle {
            fill: none;
            stroke-linecap: round;
            transition: stroke-dasharray 0.6s ease;
            /* Ensure the progress starts from the top (12 o'clock) */
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .percentage {
            fill: #666;
            font-family: 'Tajawal', sans-serif;
            text-anchor: middle;
            font-weight: bold;
        }
        /* Row highlight for upcoming calibrations */
        .row-upcoming {
            border-right: 4px solid #E9C46A;
        }

        /* Print Stylesheet */
        @media print {
            body { background-color: white; }
            header, #smart-alert-banner, #dashboard-kpis, #compliance-indicators, #form-container, #table-controls, .shadow-md, .shadow-lg {
                display: none !important;
            }
            #table-container {
                display: block !important;
                box-shadow: none;
                width: 100%; margin: 0; padding: 0;
            }
            table { font-size: 10pt; border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #ccc; padding: 5px; }
            .row-upcoming, .bg-red-50 { -webkit-print-color-adjust: exact; color-adjust: exact; }
            .row-upcoming { background-color: rgba(233, 196, 106, 0.1) !important; animation: none !important; }
            .bg-red-50 { background-color: rgba(220, 53, 69, 0.1) !important; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <section id="fms-calibration" class="container mx-auto p-4 md:p-8">
        
        <header class="mb-6 p-4 bg-white shadow-md rounded-lg text-center">
            <h1 class="text-2xl font-bold text-cbahi-blue">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL Log)</h1>
            <p class="text-gray-600">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p>
        </header>

        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-cbahi-blue"></i>
                <p class="mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
            </div>
        </div>

        <div id="smart-alert-banner" class="hidden mb-6 p-4 bg-yellow-100 border-r-4 border-cbahi-gold text-yellow-800 rounded-lg shadow-sm">
            <p id="alert-message" class="font-semibold"></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <div class="lg:col-span-2" id="dashboard-kpis">
                 <div class="grid grid-cols-2 md:grid-cols-5 gap-4 shadow-gold-glow bg-white p-5 rounded-lg border-t-4 border-cbahi-gold">
                    <div id="kpi-pass" class="text-center p-3 bg-green-50 rounded-lg transition duration-300 hover:shadow-md">
                        <i class="fas fa-check-circle text-3xl text-cbahi-green mb-2"></i>
                        <p class="text-2xl font-bold" id="count-pass">0</p>
                        <p class="text-sm text-gray-600">âœ… Ù…Ø·Ø§Ø¨Ù‚ (Pass)</p>
                    </div>
                    <div id="kpi-fail" class="text-center p-3 bg-red-50 rounded-lg transition duration-300 hover:shadow-md">
                        <i class="fas fa-times-circle text-3xl text-cbahi-red mb-2"></i>
                        <p class="text-2xl font-bold" id="count-fail">0</p>
                        <p class="text-sm text-gray-600">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</p>
                    </div>
                    <div id="kpi-overdue" class="text-center p-3 bg-orange-50 rounded-lg transition duration-300 hover:shadow-md">
                        <i class="fas fa-exclamation-circle text-3xl text-cbahi-orange mb-2"></i>
                        <p class="text-2xl font-bold" id="count-overdue">0</p>
                        <p class="text-sm text-gray-600">âš ï¸ Ù…ØªØ£Ø®Ø± (Overdue)</p>
                    </div>
                    <div id="kpi-upcoming" class="text-center p-3 bg-yellow-50 rounded-lg transition duration-300 hover:shadow-md">
                        <i class="fas fa-hourglass-half text-3xl text-cbahi-gold mb-2"></i>
                        <p class="text-2xl font-bold" id="count-upcoming">0</p>
                        <p class="text-sm text-gray-600">â³ Ù‚Ø§Ø¯Ù… (30 ÙŠÙˆÙ…)</p>
                    </div>
                    <div id="kpi-unscheduled" class="text-center p-3 bg-gray-100 rounded-lg transition duration-300 hover:shadow-md">
                        <i class="fas fa-calendar-times text-3xl text-gray-500 mb-2"></i>
                        <p class="text-2xl font-bold" id="count-unscheduled">0</p>
                        <p class="text-sm text-gray-600">ğŸ•“ Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-md" id="compliance-indicators">
                <h2 class="text-lg font-semibold mb-4 text-cbahi-blue">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Compliance)</h2>
                <div class="flex justify-center items-center mb-6">
                    <div id="overall-compliance-chart" class="w-32 h-32">
                        </div>
                </div>
                <h2 class="text-md font-semibold mb-3 text-center">Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
                <div class="grid grid-cols-4 gap-2 text-center" id="department-compliance">
                    </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="lg:col-span-1" id="form-container">
                <div class="bg-white p-6 rounded-lg shadow-md sticky top-8">
                    <h2 class="text-xl font-bold mb-5 border-b pb-2 text-cbahi-blue">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯</h2>
                    <form id="calibration-form">
                        <div class="space-y-4">
                            
                            <div>
                                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù‚Ø³Ù… <span class="text-red-500">*</span></label>
                                <select id="department" name="department" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cbahi-blue focus:border-cbahi-blue">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>
                                </select>
                            </div>

                            <div>
                                <label for="staff" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ <span class="text-red-500">*</span></label>
                                <input type="text" id="staff" name="staff" required list="staff-list" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø£Ùˆ Ø§Ø®ØªØ±Ù‡" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cbahi-blue focus:border-cbahi-blue">
                                <datalist id="staff-list"></datalist>
                            </div>

                            <div>
                                <label for="asset" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ù‡Ù…Ø© / Ø§Ù„Ø¬Ù‡Ø§Ø² (Task) <span class="text-red-500">*</span></label>
                                <select id="asset" name="asset" required disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 focus:outline-none focus:ring-cbahi-blue focus:border-cbahi-blue">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>
                                </select>
                            </div>

                            <div>
                                <label for="testDate" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ <span class="text-red-500">*</span></label>
                                <input type="date" id="testDate" name="testDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cbahi-blue focus:border-cbahi-blue">
                            </div>

                            <div>
                                <label for="frequency" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªÙƒØ±Ø§Ø± <span class="text-red-500">*</span></label>
                                <select id="frequency" name="frequency" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cbahi-blue focus:border-cbahi-blue">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªÙƒØ±Ø§Ø±...</option>
                                    <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Weekly)</option>
                                    <option value="Ø´Ù‡Ø±ÙŠ">Ø´Ù‡Ø±ÙŠ (Monthly)</option>
                                    <option value="Ù†ØµÙ Ø³Ù†ÙˆÙŠ">Ù†ØµÙ Ø³Ù†ÙˆÙŠ (Semi-Annually)</option>
                                    <option value="Ø³Ù†ÙˆÙŠ">Ø³Ù†ÙˆÙŠ (Annually)</option>
                                </select>
                            </div>

                            <div>
                                <label for="nextDue" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
                                <input type="date" id="nextDue" name="nextDue" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù†ØªÙŠØ¬Ø© <span class="text-red-500">*</span></label>
                                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="result" value="Pass" required class="form-radio h-4 w-4 text-cbahi-green">
                                        <span class="mr-2 text-cbahi-green font-semibold">âœ… Ù…Ø·Ø§Ø¨Ù‚ (Pass)</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="result" value="Fail" class="form-radio h-4 w-4 text-cbahi-red">
                                        <span class="mr-2 text-cbahi-red font-semibold">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</span>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label for="certificateFile" class="block text-sm font-medium text-gray-700 mb-1">Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF/ØµÙˆØ±Ø©) <span class="text-red-500">*</span></label>
                                <input type="file" id="certificateFile" name="certificateFile" accept="application/pdf,image/*" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cbahi-blue file:text-white hover:file:bg-blue-800">
                                <p id="file-status" class="text-xs text-gray-500 mt-1"></p>
                            </div>

                            <button type="submit" id="submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-cbahi-blue hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cbahi-blue transition duration-150 ease-in-out">
                                <i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-lg shadow-md" id="table-container">
                    <div class="flex justify-between items-center mb-4" id="table-controls">
                        <h2 class="text-xl font-bold text-cbahi-blue">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø§Øª ÙˆØ§Ù„ÙØ­ÙˆØµØ§Øª</h2>
                        <div class="flex items-center space-x-3 rtl:space-x-reverse">
                            <input type="text" id="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª..." class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cbahi-blue focus:border-cbahi-blue text-sm">
                            <button id="print-btn" onclick="window.print()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out text-sm">
                                <i class="fas fa-print ml-1"></i> Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="logs-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ÙˆÙ‚Øª</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="8" class="text-center py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <script>
        // ================================================================
        // âš™ï¸ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙˆØ§Ù„ØªÙƒØ§Ù…Ù„ (JavaScript Logic) - Final Corrected Version
        // ================================================================

        // --- Configuration ---
        
        // ğŸŒŸ Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API Ø¨ØµÙŠØºØ© JavaScript ØµØ­ÙŠØ­Ø©
        const CAL_API_URL = 'https://script.google.com/macros/s/AKfycbzvzCl6BbnqyGta4dH5Ic3Sh0tbM6HJzWCdqsUMFh31oRDzU2GMtVToEsETKppbh2PFtQ/exec';
        
        // ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ (LIVE MODE)
        const MOCK_MODE = false; 

        // --- Global State ---
        let assetsMap = {};
        let staffList = [];
        let allRecords = [];
        let DEPARTMENTS_LIST = []; // Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§
        let uploadedFileBase64 = null;
        let uploadedFileMimeType = null;
        let uploadedFileName = null;

        // --- DOM Elements ---
        const elements = {
            loadingOverlay: document.getElementById('loading-overlay'),
            form: document.getElementById('calibration-form'),
            departmentSelect: document.getElementById('department'),
            assetSelect: document.getElementById('asset'),
            testDateInput: document.getElementById('testDate'),
            frequencySelect: document.getElementById('frequency'),
            nextDueInput: document.getElementById('nextDue'),
            certificateFileInput: document.getElementById('certificateFile'),
            fileStatus: document.getElementById('file-status'),
            submitBtn: document.getElementById('submit-btn'),
            tableBody: document.getElementById('log-table-body'),
            searchInput: document.getElementById('search-input'),
            staffDatalist: document.getElementById('staff-list'),
            alertBanner: document.getElementById('smart-alert-banner'),
            alertMessage: document.getElementById('alert-message'),
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            console.log("Initializing Calibration System...");
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (ÙÙŠ Ø­Ø§Ù„ ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹)
            if (CAL_API_URL.includes('Ø¶Ø¹_Ø±Ø§Ø¨Ø·_API_Ø§Ù„Ø¬Ø¯ÙŠØ¯_Ù‡Ù†Ø§') && !MOCK_MODE) {
                showLoading(false);
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.', 'error');
                elements.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØªØµÙ„.</td></tr>';
                return;
            }

            setupEventListeners();
            // Set default date input to today
            elements.testDateInput.valueAsDate = new Date();
            await fetchData();
        }

        function setupEventListeners() {
            elements.departmentSelect.addEventListener('change', handleDepartmentChange);
            elements.testDateInput.addEventListener('change', calculateNextDue);
            elements.frequencySelect.addEventListener('change', calculateNextDue);
            elements.certificateFileInput.addEventListener('change', handleFileUpload);
            elements.form.addEventListener('submit', handleSubmit);
            elements.searchInput.addEventListener('keyup', filterTable);
        }

        // --- Utility Functions ---
        function showLoading(isLoading) {
            // Ø¥Ø®ÙØ§Ø¡ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            if (elements.loadingOverlay) {
                elements.loadingOverlay.classList.toggle('hidden', !isLoading);
            }
        }

        function toggleSubmitLoading(isLoading) {
            elements.submitBtn.disabled = isLoading;
            if (isLoading) {
                elements.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            } else {
                elements.submitBtn.innerHTML = '<i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ø±Ø¶ (YYYY-MM-DD)
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… en-CA Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DD Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                return date.toLocaleDateString('en-CA'); 
            } catch (e) {
                return dateString;
            }
        }
        
        // Helper to get today's date cleared of time for accurate comparison
        function getTodayClear() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }

        function showNotification(message, type = 'success') {
            // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ù€ Toast notification Ø£ÙƒØ«Ø± ØªØ·ÙˆØ±Ø§Ù‹ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
            alert(`${type === 'success' ? 'âœ… Ù†Ø¬Ø§Ø­' : 'âŒ Ø®Ø·Ø£'}: ${message}`);
        }

        // --- Data Fetching (GET) ---
        async function fetchData(forceRefresh = false) {
            showLoading(true);
            try {
                let data;
                
                console.log("Fetching LIVE data from API...");
                const url = forceRefresh ? `${CAL_API_URL}?refresh=true` : CAL_API_URL;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    console.error("Received non-JSON response:", text);
                    throw new Error("Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Web App) ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©.");
                }
                
                data = await response.json();
                
                if (data && data.status === 'success') {
                    assetsMap = data.data.assetsMap || {};
                    staffList = data.data.staffList || [];
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
                    DEPARTMENTS_LIST = Object.keys(assetsMap);
                    populateDepartments();

                    // ØªÙˆØ­ÙŠØ¯ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† CAL_Log Sheet)
                    allRecords = (data.data.records || []).map(record => ({
                        Timestamp: record.Timestamp,
                        department: record.Department,
                        staff: record.Staff,
                        assetID: record.AssetID,
                        assetName: record.AssetName,
                        testDate: record.TestDate,
                        frequency: record.Frequency,
                        nextDue: record.NextDue,
                        result: record.Result,
                        CertificateLink: record.CertificateLink
                    }));
                    
                    processData();
                } else {
                    throw new Error(data.message || 'Failed to fetch data structure.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showNotification(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                elements.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª.</td></tr>';
            } finally {
                showLoading(false);
            }
        }

        function processData() {
            renderStaffList();
            // Calculate statuses based on the latest record for each asset/task
            const assetStatuses = calculateAssetStatuses(allRecords);
            renderDashboard(assetStatuses);
            renderTable(allRecords);
            checkSmartAlerts(assetStatuses);
        }

        // --- Form Handlers ---

        function populateDepartments() {
            elements.departmentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>';
            DEPARTMENTS_LIST.sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                elements.departmentSelect.appendChild(option);
            });
        }

        function handleDepartmentChange() {
            const department = elements.departmentSelect.value;
            elements.assetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‡Ù…Ø©/Ø§Ù„Ø¬Ù‡Ø§Ø²...</option>';
            
            if (department && assetsMap[department]) {
                // ÙØ±Ø² Ø§Ù„Ù…Ù‡Ø§Ù… Ø£Ø¨Ø¬Ø¯ÙŠÙ‹Ø§
                const sortedAssets = assetsMap[department].sort((a, b) => a.name.localeCompare(b.name));
                
                sortedAssets.forEach(asset => {
                    const option = document.createElement('option');
                    option.value = asset.id;
                    option.textContent = asset.name; 
                    elements.assetSelect.appendChild(option);
                });
                elements.assetSelect.disabled = false;
                elements.assetSelect.classList.remove('bg-gray-100');
            } else {
                elements.assetSelect.disabled = true;
                elements.assetSelect.classList.add('bg-gray-100');
            }
        }

        function calculateNextDue() {
            const testDateValue = elements.testDateInput.value;
            const frequency = elements.frequencySelect.value;

            if (!testDateValue || !frequency) {
                elements.nextDueInput.value = '';
                return;
            }

            // Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ­ÙŠØ­ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const dateParts = testDateValue.split('-').map(p => parseInt(p, 10));
            // Ø§Ù„Ø´Ù‡Ø± ÙÙŠ JavaScript ÙŠØ¨Ø¯Ø£ Ù…Ù† 0 (ÙŠÙ†Ø§ÙŠØ±=0)
            const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);

            if (isNaN(date.getTime())) return;

            let nextDate = new Date(date.getTime());

            switch (frequency) {
                case 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ':
                    nextDate.setDate(date.getDate() + 7);
                    break;
                case 'Ø´Ù‡Ø±ÙŠ':
                    nextDate.setMonth(date.getMonth() + 1);
                    break;
                case 'Ù†ØµÙ Ø³Ù†ÙˆÙŠ':
                    nextDate.setMonth(date.getMonth() + 6);
                    break;
                case 'Ø³Ù†ÙˆÙŠ':
                    nextDate.setFullYear(date.getFullYear() + 1);
                    break;
            }

            // Format as YYYY-MM-DD
            elements.nextDueInput.value = nextDate.toLocaleDateString('en-CA');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            elements.fileStatus.textContent = '';
            uploadedFileBase64 = null;

            if (!file) return;

            // Validate file type and size (10MB limit)
            if (!file.type.match('application/pdf') && !file.type.match('image.*')) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø© ÙÙ‚Ø·.', 'error');
                event.target.value = '';
                return;
            }
            if (file.size > 10 * 1024 * 1024) { // 10MB
                showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª).', 'error');
                event.target.value = '';
                return;
            }

            elements.fileStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...';
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedFileBase64 = e.target.result.split(',')[1];
                uploadedFileMimeType = file.type;
                uploadedFileName = file.name;
                elements.fileStatus.textContent = `ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø©: ${file.name}`;
            };
            reader.onerror = function() {
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.', 'error');
                elements.fileStatus.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.';
            };
            reader.readAsDataURL(file);
        }

        // --- Submission Handler (POST) ---
        async function handleSubmit(event) {
            event.preventDefault();

            if (!uploadedFileBase64) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.', 'error');
                return;
            }

            const formData = new FormData(elements.form);
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© (TaskName)
            const selectedAssetOption = elements.assetSelect.options[elements.assetSelect.selectedIndex];
            const assetName = selectedAssetOption ? selectedAssetOption.textContent : 'Unknown Task';

            const payload = {
                action: "logCalibration",
                data: {
                    department: formData.get('department'),
                    staff: formData.get('staff'),
                    assetID: formData.get('asset'), // TaskID
                    assetName: assetName,            // TaskName
                    testDate: formData.get('testDate'),
                    frequency: formData.get('frequency'),
                    nextDue: formData.get('nextDue'),
                    result: formData.get('result'),
                },
                fileData: {
                    fileName: uploadedFileName, 
                    mimeType: uploadedFileMimeType,
                    base64: uploadedFileBase64,
                }
            };

            toggleSubmitLoading(true);

            try {
                let responseData;
                
                console.log("LIVE Submission to API...");
                // CRITICAL: Use 'text/plain' to avoid CORS preflight issues with Google Apps Script
                const response = await fetch(CAL_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(payload),
                });

                // Robust response parsing
                const responseText = await response.text();
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse JSON response:", responseText);
                    throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ù„ÙÙŠ).');
                }

                if (responseData.status === 'success') {
                    showNotification(responseData.message, 'success');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø© (ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡)
                    if (responseData.data && responseData.data.newRecord) {
                        const newRecord = responseData.data.newRecord;
                         // ØªÙˆØ­ÙŠØ¯ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                         allRecords.unshift({
                            Timestamp: newRecord.Timestamp,
                            department: newRecord.Department,
                            staff: newRecord.Staff,
                            assetID: newRecord.AssetID,
                            assetName: newRecord.AssetName,
                            testDate: newRecord.TestDate,
                            frequency: newRecord.Frequency,
                            nextDue: newRecord.NextDue,
                            result: newRecord.Result,
                            CertificateLink: newRecord.CertificateLink
                        });
                        processData(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    }

                    // Reset form
                    resetForm();
                    
                } else {
                    throw new Error(responseData.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©.');
                }
            } catch (error) {
                console.error('Error submitting data:', error);
                showNotification(`ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„: ${error.message}`, 'error');
            } finally {
                toggleSubmitLoading(false);
            }
        }

        function resetForm() {
            elements.form.reset();
            uploadedFileBase64 = null;
            elements.fileStatus.textContent = '';
            elements.assetSelect.disabled = true;
            elements.assetSelect.classList.add('bg-gray-100');
            elements.assetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>';
            elements.testDateInput.valueAsDate = new Date(); // Reset date to today
        }

        // --- Data Processing & Business Logic ---

        // ğŸ§© Calculates KPIs based on the LATEST record for each unique TaskID.
        function calculateAssetStatuses(records) {
            const statuses = {
                Pass: 0, Fail: 0, Overdue: 0, Upcoming: 0, Unscheduled: 0,
                DepartmentCompliance: {},
                Assets: {}
            };

            // 1. Initialize Department Compliance structure dynamically
            DEPARTMENTS_LIST.forEach(dept => {
                statuses.DepartmentCompliance[dept] = { pass: 0, total: 0 };
            });

            // 2. Find the latest record for each task
            const latestRecords = {};
            const sortedRecords = [...records].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            
            sortedRecords.forEach(record => {
                if (!latestRecords[record.assetID]) {
                    latestRecords[record.assetID] = record;
                }
            });

            // 3. Analyze the latest records
            const today = getTodayClear();
            const upcomingThreshold = new Date(today);
            upcomingThreshold.setDate(today.getDate() + 30);

            Object.values(latestRecords).forEach(record => {
                
                // Update KPIs based on Result (Independent of date)
                if (record.result === 'Pass') {
                    statuses.Pass++;
                } else if (record.result === 'Fail') {
                    statuses.Fail++;
                }

                // Update Department Compliance
                if (statuses.DepartmentCompliance[record.department]) {
                    statuses.DepartmentCompliance[record.department].total++;
                    if (record.result === 'Pass') {
                        statuses.DepartmentCompliance[record.department].pass++;
                    }
                }

                // Check Dates (NextDue)
                if (record.nextDue) {
                    try {
                        const nextDue = new Date(record.nextDue);
                        if (!isNaN(nextDue.getTime())) {
                            // Normalize date for comparison
                            const nextDueClear = new Date(nextDue.getFullYear(), nextDue.getMonth(), nextDue.getDate());
        
                            if (nextDueClear < today) {
                                statuses.Overdue++;
                            } else if (nextDueClear <= upcomingThreshold) {
                                statuses.Upcoming++;
                            }
                        }
                    } catch (e) {
                        console.warn("Invalid date encountered:", record.nextDue);
                    }
                }
                
                statuses.Assets[record.assetID] = record;
            });

            // 4. Calculate Unscheduled Tasks
            let totalManagedTasks = 0;
            Object.values(assetsMap).forEach(assets => totalManagedTasks += assets.length);
            statuses.Unscheduled = Math.max(0, totalManagedTasks - Object.keys(latestRecords).length);

            return statuses;
        }

        // --- Rendering Functions ---

        function renderDashboard(statuses) {
            document.getElementById('count-pass').textContent = statuses.Pass;
            document.getElementById('count-fail').textContent = statuses.Fail;
            document.getElementById('count-overdue').textContent = statuses.Overdue;
            document.getElementById('count-upcoming').textContent = statuses.Upcoming;
            document.getElementById('count-unscheduled').textContent = statuses.Unscheduled;

            // Apply Pulsating Alert effect if Fail > 0 or Overdue > 0
            const failKpi = document.getElementById('kpi-fail');
            failKpi.classList.toggle('animate-pulsate-alert', statuses.Fail > 0);

            const overdueKpi = document.getElementById('kpi-overdue');
            overdueKpi.classList.toggle('animate-pulsate-alert', statuses.Overdue > 0);


            // Overall Compliance Chart
            const totalCalibrated = statuses.Pass + statuses.Fail;
            // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… = Ø§Ù„Ù†Ø§Ø¬Ø­ / (Ø§Ù„Ù†Ø§Ø¬Ø­ + Ø§Ù„ÙØ§Ø´Ù„). Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù… 0ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù…Ù‡Ø§Ù… Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ØµÙ„Ø§Ù‹.
            let totalTasks = 0;
            Object.values(assetsMap).forEach(arr => totalTasks += arr.length);

            const overallCompliance = totalCalibrated > 0 ? (statuses.Pass / totalCalibrated) * 100 : (totalTasks === 0 ? 100 : 0);
            
            renderCircularChart('overall-compliance-chart', overallCompliance, '#00529B', false);

            // Department Compliance Charts
            const deptContainer = document.getElementById('department-compliance');
            deptContainer.innerHTML = '';
            
            DEPARTMENTS_LIST.forEach(dept => {
                const stats = statuses.DepartmentCompliance[dept];
                const deptTasksCount = assetsMap[dept] ? assetsMap[dept].length : 0;
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù…Ù‡Ù…Ø© (total=0)ØŒ ÙˆÙ„ÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ù‡Ø§Ù… Ù…Ø·Ù„ÙˆØ¨Ø© (deptTasksCount>0)ØŒ ÙØ¥Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ù‡Ùˆ 0%.
                const compliance = stats.total > 0 ? (stats.pass / stats.total) * 100 : (deptTasksCount > 0 ? 0 : 100);

                const chartDiv = document.createElement('div');
                chartDiv.id = `compliance-${dept}`;
                deptContainer.appendChild(chartDiv);
                renderCircularChart(`compliance-${dept}`, compliance, '#E9C46A', true);
                
                const label = document.createElement('p');
                label.className = 'text-xs font-semibold mt-1';
                label.textContent = dept;
                chartDiv.appendChild(label);
            });
        }

        // ğŸŒŸ Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ
        function renderCircularChart(containerId, percentage, defaultColor, isSmall) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© (ØªØ­Ø³ÙŠÙ† Ù…Ø±Ø¦ÙŠ)
            let dynamicColor = defaultColor;
            if (percentage < 60) {
                dynamicColor = '#dc3545'; // Red
            } else if (percentage < 90) {
                dynamicColor = '#E9C46A'; // Gold
            } else if (percentage >= 95) {
                dynamicColor = '#28a745'; // Green
            }

            const radius = 15.9155;
            const circumference = 100;
            const dasharray = `${(percentage / 100) * circumference} ${circumference}`;
            
            const sizeClass = isSmall ? 'w-16 h-16' : 'w-24 h-24';
            const strokeWidth = isSmall ? '3.8' : '2.8';
            const fontSize = isSmall ? '0.4em' : '0.5em';

            // Ø±Ø³Ù… Ø§Ù„Ù€ SVG Ù…Ø¨Ø§Ø´Ø±Ø©
            container.innerHTML = `
                <svg viewBox="0 0 36 36" class="circular-chart ${sizeClass}">
                    <path class="circle-bg"
                        stroke-width="3.8"
                        d="M18 2.0845
                        a ${radius} ${radius} 0 0 1 0 31.831
                        a ${radius} ${radius} 0 0 1 0 -31.831" />
                    <path class="circle"
                        stroke="${dynamicColor}"
                        stroke-width="${strokeWidth}"
                        stroke-dasharray="${dasharray}"
                        d="M18 2.0845
                        a ${radius} ${radius} 0 0 1 0 31.831
                        a ${radius} ${radius} 0 0 1 0 -31.831" />
                    <text x="18" y="20.35" class="percentage" style="font-size: ${fontSize};">${Math.round(percentage)}%</text>
                </svg>
            `;
        }


        function renderTable(records) {
            if (records.length === 0) {
                elements.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©.</td></tr>';
                return;
            }

            const today = getTodayClear();
            const weeklyThreshold = new Date(today);
            weeklyThreshold.setDate(today.getDate() + 7);

            const sortedRecords = [...records].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            elements.tableBody.innerHTML = sortedRecords.map(record => {
                const isPass = record.result === 'Pass';
                const resultHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isPass ? 'bg-green-100 text-cbahi-green' : 'bg-red-100 text-cbahi-red'}">
                                    ${isPass ? 'âœ… Ù…Ø·Ø§Ø¨Ù‚' : 'âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚'}
                                  </span>`;
                
                const certificateHtml = record.CertificateLink ? 
                    `<a href="${record.CertificateLink}" target="_blank" class="text-cbahi-blue hover:text-blue-800 transition duration-150"><i class="fas fa-file-alt ml-1"></i> Ø¹Ø±Ø¶</a>` : 
                    'N/A';

                // Determine row highlighting (Visual Indicators)
                let rowClass = '';
                if (record.nextDue) {
                    try {
                        const nextDue = new Date(record.nextDue);
                        if (!isNaN(nextDue.getTime())) {
                             // Normalize date for comparison
                            const nextDueClear = new Date(nextDue.getFullYear(), nextDue.getMonth(), nextDue.getDate());

                            if (nextDueClear < today) {
                                // Overdue
                                rowClass = 'bg-red-50';
                            } else if (nextDueClear <= weeklyThreshold) {
                                // Upcoming within 7 days
                                rowClass = 'row-upcoming animate-upcoming-glow';
                            }
                        }
                    } catch(e) {}
                }
                
                const assetDisplay = record.assetName || record.assetID;

                return `
                    <tr class="${rowClass} hover:bg-gray-50 transition duration-150">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(record.Timestamp)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.department}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.staff}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-sm truncate" title="${assetDisplay}">${assetDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(record.testDate)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${formatDate(record.nextDue)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${resultHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${certificateHtml}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderStaffList() {
            elements.staffDatalist.innerHTML = staffList.map(staff => `<option value="${staff}">`).join('');
        }
        
        // ğŸ§­ Smart Alerts Logic (7-day lookahead)
        function checkSmartAlerts(statuses) {
            const today = getTodayClear();
            const weeklyThreshold = new Date(today);
            weeklyThreshold.setDate(today.getDate() + 7);

            const imminentDepartments = new Set();
            Object.values(statuses.Assets).forEach(asset => {
                if (asset.nextDue) {
                     try {
                        const nextDue = new Date(asset.nextDue);
                        if (!isNaN(nextDue.getTime())) {
                            const nextDueClear = new Date(nextDue.getFullYear(), nextDue.getMonth(), nextDue.getDate());
                            
                            // Alert if overdue OR upcoming within 7 days
                            if (nextDueClear <= weeklyThreshold) {
                                imminentDepartments.add(asset.department);
                            }
                        }
                    } catch(e) {}
                }
            });

            let alerts = [];
            if (statuses.Unscheduled > 0) {
                alerts.push(`<i class="fas fa-info-circle ml-2"></i>ØªÙ†Ø¨ÙŠÙ‡: ØªÙˆØ¬Ø¯ <strong>${statuses.Unscheduled}</strong> Ù…Ù‡Ù…Ø©/Ù…Ù‡Ø§Ù… Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø³Ø¬Ù„ Ù„Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯).`);
            }

            if (imminentDepartments.size > 0) {
                alerts.push(`<i class="fas fa-exclamation-triangle ml-2"></i>ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…: ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠØ±Ø§Øª Ù…Ø³ØªØ­Ù‚Ø© (Ø£Ùˆ Ù…ØªØ£Ø®Ø±Ø©) Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù‚Ø³Ù…/Ø£Ù‚Ø³Ø§Ù…: <strong>${Array.from(imminentDepartments).join(', ')}</strong>.`);
            }

            if (alerts.length > 0) {
                elements.alertBanner.classList.remove('hidden');
                elements.alertMessage.innerHTML = alerts.join('<br><br>');
            } else {
                 elements.alertBanner.classList.add('hidden');
            }
        }

        // --- Table Utilities ---
        function filterTable() {
            const filter = elements.searchInput.value.toUpperCase();
            const rows = elements.tableBody.getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                let visible = false;
                const cells = rows[i].getElementsByTagName("td");
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j]) {
                        if (cells[j].textContent.toUpperCase().indexOf(filter) > -1) {
                            visible = true;
                            break;
                        }
                    }
                }
                rows[i].style.display = visible ? "" : "none";
            }
        }

    </script>
</body>
</html>
