<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø³Ø¬Ù„ Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (CAL) - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1e3a5f',
            secondary: '#c9a962',
            accent: '#DC143C',
            success: '#10b981',
            danger: '#ef4444',
            warning: '#f59e0b'
          },
          fontFamily: { sans: ['Tajawal', 'sans-serif'] }
        }
      }
    };
  </script>

  <style>
    .gradient-header { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); }
    .gold-border { border-color: #c9a962; }
    
    .accordion-content { 
      max-height: 0; 
      overflow: hidden; 
      transition: max-height 0.4s ease-out; 
    }
    .accordion-content.open { max-height: 5000px; }
    
    .accordion-btn.active i.fa-chevron-down { transform: rotate(180deg); }
    .accordion-btn i.fa-chevron-down { transition: transform 0.3s ease; }
    
    .status-pass { background: #dcfce7; color: #166534; }
    .status-fail { background: #fee2e2; color: #991b1b; }
    .status-upcoming { background: #fef3c7; color: #92400e; }
    .status-overdue { background: #fecaca; color: #dc2626; animation: pulse-red 2s infinite; }
    
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
    }
    
    .kpi-card { transition: transform 0.2s, box-shadow 0.2s; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    
    @media print {
      .no-print { display: none !important; }
      .print-show { display: block !important; }
    }
  </style>
</head>

<body class="bg-gray-50 font-sans">

  <!-- ========== Ø§Ù„Ù‡ÙŠØ¯Ø± ========== -->
  <header class="gradient-header text-white shadow-xl">
    <div class="container mx-auto px-4 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-white rounded-full p-2 shadow-lg flex items-center justify-center">
            <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-transparent.png"
                 alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹" class="w-12 h-12 object-contain"
                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>ğŸ¥</text></svg>'">
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold">Ø³Ø¬Ù„ Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
            <p class="text-white/80 text-sm">CAL Log - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</p>
          </div>
        </div>
        <div class="text-left hidden md:block">
          <a href="cbahi-portal.html" class="inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
            <i class="fas fa-arrow-left"></i>
            <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨ÙˆØ§Ø¨Ø©</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 space-y-6">

    <!-- ========== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ========== -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 flex items-center justify-center z-50">
      <div class="text-center">
        <i class="fas fa-cog fa-spin text-5xl text-primary mb-4"></i>
        <p class="text-xl font-bold text-primary">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
      </div>
    </div>

    <!-- ========== KPIs ========== -->
    <section id="kpis" class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="kpi-card bg-white rounded-xl p-4 shadow-md border-r-4 border-primary">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
            <i class="fas fa-tools text-primary text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</p>
            <p id="kpi-total" class="text-2xl font-bold text-primary">0</p>
          </div>
        </div>
      </div>
      
      <div class="kpi-card bg-white rounded-xl p-4 shadow-md border-r-4 border-success">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-success/10 rounded-full flex items-center justify-center">
            <i class="fas fa-check-circle text-success text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Ù…Ø·Ø§Ø¨Ù‚ (Pass)</p>
            <p id="kpi-pass" class="text-2xl font-bold text-success">0</p>
          </div>
        </div>
      </div>
      
      <div class="kpi-card bg-white rounded-xl p-4 shadow-md border-r-4 border-danger">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-danger/10 rounded-full flex items-center justify-center">
            <i class="fas fa-times-circle text-danger text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</p>
            <p id="kpi-fail" class="text-2xl font-bold text-danger">0</p>
          </div>
        </div>
      </div>
      
      <div class="kpi-card bg-white rounded-xl p-4 shadow-md border-r-4 border-warning">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-warning/10 rounded-full flex items-center justify-center">
            <i class="fas fa-clock text-warning text-xl"></i>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Ù…ØªØ£Ø®Ø±Ø©</p>
            <p id="kpi-overdue" class="text-2xl font-bold text-warning">0</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Accordion) ========== -->
    <section class="bg-white rounded-xl shadow-md overflow-hidden">
      <button id="form-toggle" class="accordion-btn w-full flex items-center justify-between p-4 bg-primary text-white hover:bg-primary/90 transition">
        <div class="flex items-center gap-3">
          <i class="fas fa-plus-circle text-xl"></i>
          <span class="text-lg font-bold">ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§ÙŠØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
        </div>
        <i class="fas fa-chevron-down text-xl"></i>
      </button>
      
      <div id="form-content" class="accordion-content">
        <form id="calForm" class="p-6 space-y-4">
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù‚Ø³Ù… *</label>
              <select id="department" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¬Ù‡Ø§Ø² *</label>
              <select id="assetSelect" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² --</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ù†ÙØ° *</label>
              <select id="staff" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙÙ†ÙŠ --</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± *</label>
              <input type="date" id="testDate" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªÙƒØ±Ø§Ø± *</label>
              <select id="frequency" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary">
                <option value="">-- Ø§Ø®ØªØ± --</option>
                <option value="ÙŠÙˆÙ…ÙŠ">ÙŠÙˆÙ…ÙŠ</option>
                <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
                <option value="Ø´Ù‡Ø±ÙŠ">Ø´Ù‡Ø±ÙŠ</option>
                <option value="Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ">Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option>
                <option value="Ù†ØµÙ Ø³Ù†ÙˆÙŠ">Ù†ØµÙ Ø³Ù†ÙˆÙŠ</option>
                <option value="Ø³Ù†ÙˆÙŠ">Ø³Ù†ÙˆÙŠ</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù†ØªÙŠØ¬Ø© *</label>
              <select id="result" required class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary">
                <option value="">-- Ø§Ø®ØªØ± --</option>
                <option value="Pass">âœ… Ù…Ø·Ø§Ø¨Ù‚ (Pass)</option>
                <option value="Fail">âŒ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ (Fail)</option>
              </select>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ø¥Ø±ÙØ§Ù‚ ØªÙ‚Ø±ÙŠØ± (PDF/ØµÙˆØ±Ø©)</label>
            <input type="file" id="reportFile" accept=".pdf,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded-lg p-3 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-primary file:text-white file:cursor-pointer">
          </div>
          
          <div class="flex gap-3 pt-4">
            <button type="submit" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-6 rounded-lg font-bold transition flex items-center justify-center gap-2">
              <i class="fas fa-save"></i>
              <span>Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</span>
            </button>
            <button type="reset" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-6 rounded-lg font-bold transition">
              <i class="fas fa-redo"></i>
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- ========== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Accordion) ========== -->
    <section class="bg-white rounded-xl shadow-md overflow-hidden no-print">
      <button id="schedule-toggle" class="accordion-btn w-full flex items-center justify-between p-4 bg-secondary text-white hover:bg-secondary/90 transition">
        <div class="flex items-center gap-3">
          <i class="fas fa-calendar-alt text-xl"></i>
          <span class="text-lg font-bold">Ø¬Ø¯ÙˆÙ„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©</span>
        </div>
        <i class="fas fa-chevron-down text-xl"></i>
      </button>
      
      <div id="schedule-content" class="accordion-content">
        <div class="p-4 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3 text-right font-bold">Ø§Ù„Ù‚Ø³Ù…</th>
                <th class="p-3 text-right font-bold">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</th>
                <th class="p-3 text-center font-bold">Ø§Ù„ØªÙƒØ±Ø§Ø±</th>
                <th class="p-3 text-center font-bold">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <tr class="hover:bg-gray-50">
                <td class="p-3 font-semibold">ğŸ©» Ø§Ù„Ø£Ø´Ø¹Ø© (RAD)</td>
                <td class="p-3">X-Ray, Portable, Dental, Mammogram, Ultrasound</td>
                <td class="p-3 text-center"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">Ø³Ù†ÙˆÙŠ</span></td>
                <td class="p-3 text-center">Ø£. Ø¨Ù„Ø§Ù„ Ù†ØªÙˆ</td>
              </tr>
              <tr class="hover:bg-gray-50">
                <td class="p-3 font-semibold">ğŸ§ª Ø§Ù„Ù…Ø®ØªØ¨Ø± (LAB)</td>
                <td class="p-3">Biochem, Heme, Centrifuge, Micropipettes, Incubator</td>
                <td class="p-3 text-center"><span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">Ù†ØµÙ Ø³Ù†ÙˆÙŠ</span></td>
                <td class="p-3 text-center">Ø£. Ù‡ÙŠØ«Ù… Ø§Ù„Ø¬Ø¹Ù„ÙŠ</td>
              </tr>
              <tr class="hover:bg-gray-50">
                <td class="p-3 font-semibold">ğŸ§´ Ø§Ù„ØªØ¹Ù‚ÙŠÙ… (CSSD)</td>
                <td class="p-3">Autoclave, Dry Heat, Sealer, Ultrasonic</td>
                <td class="p-3 text-center"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">Ø³Ù†ÙˆÙŠ</span></td>
                <td class="p-3 text-center">Ø¯. Ù…Ø¬Ø¯ÙŠ Ø¹Ø³ÙƒØ±</td>
              </tr>
              <tr class="hover:bg-gray-50">
                <td class="p-3 font-semibold">âš¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (ER)</td>
                <td class="p-3">Defib, ECG, Suction, O2 Flow, PulseOx</td>
                <td class="p-3 text-center"><span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">ÙŠÙˆÙ…ÙŠ + Ø³Ù†ÙˆÙŠ</span></td>
                <td class="p-3 text-center">Ø¯. Ù…Ø¹Ø§Ø° Ø§Ù„Ø¨ÙŠÙˆØ´</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ========== Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø§Øª (Accordion) ========== -->
    <section class="bg-white rounded-xl shadow-md overflow-hidden">
      <button id="records-toggle" class="accordion-btn active w-full flex items-center justify-between p-4 bg-gray-700 text-white hover:bg-gray-600 transition">
        <div class="flex items-center gap-3">
          <i class="fas fa-database text-xl"></i>
          <span class="text-lg font-bold">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø§Øª</span>
          <span id="records-count" class="bg-white/20 px-3 py-1 rounded-full text-sm">0 Ø³Ø¬Ù„</span>
        </div>
        <i class="fas fa-chevron-down text-xl"></i>
      </button>
      
      <div id="records-content" class="accordion-content open">
        <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="p-4 border-b bg-gray-50 flex flex-wrap gap-3 items-center justify-between no-print">
          <div class="flex flex-wrap gap-2">
            <select id="filterDept" class="border rounded-lg px-3 py-2 text-sm">
              <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
              <option value="RAD">Ø§Ù„Ø£Ø´Ø¹Ø©</option>
              <option value="LAB">Ø§Ù„Ù…Ø®ØªØ¨Ø±</option>
              <option value="CSSD">Ø§Ù„ØªØ¹Ù‚ÙŠÙ…</option>
              <option value="ER">Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</option>
            </select>
            <select id="filterResult" class="border rounded-lg px-3 py-2 text-sm">
              <option value="">ÙƒÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</option>
              <option value="Pass">Ù…Ø·Ø§Ø¨Ù‚</option>
              <option value="Fail">ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚</option>
            </select>
            <input type="text" id="searchBox" placeholder="Ø¨Ø­Ø«..." class="border rounded-lg px-3 py-2 text-sm w-40">
          </div>
          <div class="flex gap-2">
            <button onclick="window.print()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
              <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
            </button>
            <button onclick="exportCSV()" class="bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
              <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ±
            </button>
          </div>
        </div>
        
        <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <div class="overflow-x-auto">
          <table id="calTable" class="min-w-full text-sm">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th class="p-3 text-right font-bold">#</th>
                <th class="p-3 text-right font-bold">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="p-3 text-right font-bold">Ø§Ù„Ù‚Ø³Ù…</th>
                <th class="p-3 text-right font-bold">Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                <th class="p-3 text-right font-bold">Ø§Ù„ÙÙ†ÙŠ</th>
                <th class="p-3 text-center font-bold">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                <th class="p-3 text-center font-bold">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                <th class="p-3 text-center font-bold">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th class="p-3 text-center font-bold no-print">Ø§Ù„Ù…Ù„ÙØ§Øª</th>
              </tr>
            </thead>
            <tbody id="calTableBody" class="divide-y"></tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="p-4 border-t bg-gray-50 flex items-center justify-between no-print">
          <div class="text-sm text-gray-600">
            <span>ØµÙØ­Ø© <span id="currentPage">1</span> Ù…Ù† <span id="totalPages">1</span></span>
          </div>
          <div class="flex gap-2">
            <button id="btnFirst" onclick="goToPage(1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">
              <i class="fas fa-angle-double-right"></i>
            </button>
            <button id="btnPrev" onclick="goToPage(currentPage - 1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">
              <i class="fas fa-angle-right"></i>
            </button>
            <button id="btnNext" onclick="goToPage(currentPage + 1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">
              <i class="fas fa-angle-left"></i>
            </button>
            <button id="btnLast" onclick="goToPage(totalPages)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">
              <i class="fas fa-angle-double-left"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="bg-primary text-white text-center py-4 mt-8">
    <p class="text-sm">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± &copy; 2025 - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</p>
  </footer>

  <script>
    // ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ====================
    const API_URL = 'https://script.google.com/macros/s/AKfycbxxUGk2dy9cOyAcLrJHMkjHc03EbLMwpLW8F5xVKAoTL_ILKJDMnDwCb4E4PyAPOgHf/exec';
    
    let allRecords = [];
    let filteredRecords = [];
    let assetsMap = {};
    let staffList = [];
    
    // Pagination
    const RECORDS_PER_PAGE = 25;
    let currentPage = 1;
    let totalPages = 1;

    // ==================== Accordion ====================
    document.querySelectorAll('.accordion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const content = btn.nextElementSibling;
        const isOpen = content.classList.contains('open');
        
        content.classList.toggle('open');
        btn.classList.toggle('active');
      });
    });

    // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const json = await res.json();
        
        if (json.status === 'success' && json.data) {
          assetsMap = json.data.assetsMap || {};
          staffList = json.data.staffList || [];
          allRecords = json.data.records || [];
          
          populateDropdowns();
          applyFilters();
          updateKPIs();
        }
      } catch (err) {
        console.error('Error loading data:', err);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
      } finally {
        document.getElementById('loading-overlay').style.display = 'none';
      }
    }

    // ==================== ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ====================
    function populateDropdowns() {
      const deptSelect = document.getElementById('department');
      const staffSelect = document.getElementById('staff');
      
      // Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      Object.keys(assetsMap).forEach(dept => {
        const opt = document.createElement('option');
        opt.value = dept;
        opt.textContent = getDeptName(dept);
        deptSelect.appendChild(opt);
      });
      
      // Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      staffList.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        staffSelect.appendChild(opt);
      });
      
      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù…
      deptSelect.addEventListener('change', () => {
        const assetSelect = document.getElementById('assetSelect');
        assetSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² --</option>';
        
        const assets = assetsMap[deptSelect.value] || [];
        assets.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = `${a.id} - ${a.name}`;
          assetSelect.appendChild(opt);
        });
      });
    }

    function getDeptName(code) {
      const names = { RAD: 'Ø§Ù„Ø£Ø´Ø¹Ø©', LAB: 'Ø§Ù„Ù…Ø®ØªØ¨Ø±', CSSD: 'Ø§Ù„ØªØ¹Ù‚ÙŠÙ…', ER: 'Ø§Ù„Ø·ÙˆØ§Ø±Ø¦' };
      return names[code] || code;
    }

    // ==================== KPIs ====================
    function updateKPIs() {
      const total = allRecords.length;
      const pass = allRecords.filter(r => r.Result === 'Pass').length;
      const fail = allRecords.filter(r => r.Result === 'Fail').length;
      const overdue = allRecords.filter(r => isOverdue(r.NextDue)).length;
      
      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-pass').textContent = pass;
      document.getElementById('kpi-fail').textContent = fail;
      document.getElementById('kpi-overdue').textContent = overdue;
    }

    function isOverdue(dateStr) {
      if (!dateStr) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(dateStr);
      return due < today;
    }

    function isUpcoming(dateStr) {
      if (!dateStr) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(dateStr);
      const diff = (due - today) / (1000 * 60 * 60 * 24);
      return diff >= 0 && diff <= 3;
    }

    // ==================== Ø§Ù„ÙÙ„ØªØ±Ø© ====================
    function applyFilters() {
      const dept = document.getElementById('filterDept').value;
      const result = document.getElementById('filterResult').value;
      const search = document.getElementById('searchBox').value.toLowerCase();
      
      filteredRecords = allRecords.filter(r => {
        if (dept && r.Department !== dept) return false;
        if (result && r.Result !== result) return false;
        if (search) {
          const text = `${r.AssetID} ${r.AssetName} ${r.Staff} ${r.Department}`.toLowerCase();
          if (!text.includes(search)) return false;
        }
        return true;
      });
      
      // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø«
      filteredRecords.sort((a, b) => new Date(b.TestDate) - new Date(a.TestDate));
      
      currentPage = 1;
      totalPages = Math.ceil(filteredRecords.length / RECORDS_PER_PAGE) || 1;
      
      document.getElementById('records-count').textContent = `${filteredRecords.length} Ø³Ø¬Ù„`;
      
      renderTable();
    }

    // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.getElementById('filterDept').addEventListener('change', applyFilters);
    document.getElementById('filterResult').addEventListener('change', applyFilters);
    document.getElementById('searchBox').addEventListener('input', applyFilters);

    // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ====================
    function renderTable() {
      const tbody = document.getElementById('calTableBody');
      const start = (currentPage - 1) * RECORDS_PER_PAGE;
      const end = start + RECORDS_PER_PAGE;
      const pageData = filteredRecords.slice(start, end);
      
      tbody.innerHTML = '';
      
      if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
        return;
      }
      
      pageData.forEach((r, idx) => {
        const overdue = isOverdue(r.NextDue);
        const upcoming = isUpcoming(r.NextDue);
        
        let statusBadge = '';
        let rowClass = '';
        
        if (overdue) {
          statusBadge = '<span class="status-overdue px-2 py-1 rounded text-xs font-bold">Ù…ØªØ£Ø®Ø±</span>';
          rowClass = 'bg-red-50';
        } else if (upcoming) {
          statusBadge = '<span class="status-upcoming px-2 py-1 rounded text-xs font-bold">Ù‚Ø±ÙŠØ¨</span>';
          rowClass = 'bg-yellow-50';
        } else {
          statusBadge = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Ø³Ù„ÙŠÙ…</span>';
        }
        
        const resultBadge = r.Result === 'Pass'
          ? '<span class="status-pass px-2 py-1 rounded text-xs font-bold">Ù…Ø·Ø§Ø¨Ù‚</span>'
          : '<span class="status-fail px-2 py-1 rounded text-xs font-bold">ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚</span>';
        
        const fileLinks = [];
        if (r.File) fileLinks.push(`<a href="${r.File}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf"></i></a>`);
        if (r.Certificate) fileLinks.push(`<a href="${r.Certificate}" target="_blank" class="text-green-600 hover:underline"><i class="fas fa-certificate"></i></a>`);
        
        tbody.innerHTML += `
          <tr class="${rowClass} hover:bg-gray-100 transition">
            <td class="p-3 text-gray-500">${start + idx + 1}</td>
            <td class="p-3">${r.TestDate || '-'}</td>
            <td class="p-3"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${r.Department}</span></td>
            <td class="p-3 font-medium">${r.AssetName || r.AssetID}</td>
            <td class="p-3">${r.Staff}</td>
            <td class="p-3 text-center">${resultBadge}</td>
            <td class="p-3 text-center">${r.NextDue || '-'}</td>
            <td class="p-3 text-center">${statusBadge}</td>
            <td class="p-3 text-center no-print">${fileLinks.join(' ') || '-'}</td>
          </tr>
        `;
      });
      
      updatePaginationUI();
    }

    // ==================== Pagination ====================
    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
    }

    function updatePaginationUI() {
      document.getElementById('currentPage').textContent = currentPage;
      document.getElementById('totalPages').textContent = totalPages;
      
      document.getElementById('btnFirst').disabled = currentPage === 1;
      document.getElementById('btnPrev').disabled = currentPage === 1;
      document.getElementById('btnNext').disabled = currentPage === totalPages;
      document.getElementById('btnLast').disabled = currentPage === totalPages;
    }

    // ==================== Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù…Ø¹ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¬Ù…Ø¹Ø© ====================
    function calculateNextDue(testDate, frequency) {
      if (!testDate) return '';
      
      const d = new Date(testDate);
      
      switch (frequency) {
        case 'ÙŠÙˆÙ…ÙŠ':
          d.setDate(d.getDate() + 1);
          // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¬Ù…Ø¹Ø© (5)
          if (d.getDay() === 5) d.setDate(d.getDate() + 1);
          break;
        case 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ':
          d.setDate(d.getDate() + 7);
          break;
        case 'Ø´Ù‡Ø±ÙŠ':
          d.setMonth(d.getMonth() + 1);
          break;
        case 'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ':
          d.setMonth(d.getMonth() + 3);
          break;
        case 'Ù†ØµÙ Ø³Ù†ÙˆÙŠ':
          d.setMonth(d.getMonth() + 6);
          break;
        case 'Ø³Ù†ÙˆÙŠ':
          d.setFullYear(d.getFullYear() + 1);
          break;
      }
      
      return d.toISOString().split('T')[0];
    }

    // ==================== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ====================
    document.getElementById('calForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const dept = document.getElementById('department').value;
      const assetID = document.getElementById('assetSelect').value;
      const staff = document.getElementById('staff').value;
      const testDate = document.getElementById('testDate').value;
      const frequency = document.getElementById('frequency').value;
      const result = document.getElementById('result').value;
      const fileInput = document.getElementById('reportFile');
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚
      const nextDue = calculateNextDue(testDate, frequency);
      
      // Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²
      const assets = assetsMap[dept] || [];
      const asset = assets.find(a => a.id === assetID);
      const assetName = asset ? asset.name : assetID;
      
      const payload = {
        data: { department: dept, assetID, assetName, staff, testDate, frequency, nextDue, result },
        fileData: {}
      };
      
      // Ø§Ù„Ù…Ù„Ù
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const base64 = await fileToBase64(file);
        payload.fileData = { base64, mimeType: file.type, fileName: file.name };
      }
      
      try {
        showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', 'info');
        
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const json = await res.json();
        
        if (json.status === 'success') {
          showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
          
          if (json.data && json.data.newRecord) {
            allRecords.unshift(json.data.newRecord);
            applyFilters();
            updateKPIs();
          }
          
          document.getElementById('calForm').reset();
        } else {
          showToast(json.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error');
        }
      } catch (err) {
        console.error(err);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
      }
    });

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ==================== ØªØµØ¯ÙŠØ± CSV ====================
    function exportCSV() {
      if (filteredRecords.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
        return;
      }
      
      const headers = ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ù‚Ø³Ù…', 'Ø§Ù„Ø¬Ù‡Ø§Ø²', 'Ø§Ù„ÙÙ†ÙŠ', 'Ø§Ù„Ù†ØªÙŠØ¬Ø©', 'Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚'];
      const rows = filteredRecords.map(r => [
        r.TestDate, r.Department, r.AssetName || r.AssetID, r.Staff, r.Result, r.NextDue
      ]);
      
      const csv = '\ufeff' + [headers, ...rows].map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `calibration_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      
      showToast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }

    // ==================== Toast ====================
    function showToast(msg, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 left-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-pulse`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    // ==================== ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ====================
    document.getElementById('testDate').valueAsDate = new Date();

    // ==================== Ø§Ù„ØªØ´ØºÙŠÙ„ ====================
    loadData();
  </script>

</body>
</html>
