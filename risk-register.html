<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سجل المخاطر - Risk Register</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;800;900&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --navy: #1e3a5f;
            --navy-dark: #0f2744;
            --gold: #c9a962;
            --crimson: #DC143C;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --gray: #64748b;
            --ext: #7f1d1d;
            --high: #dc2626;
            --med: #f59e0b;
            --low: #22c55e;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-bottom: 3px solid var(--gold);
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-title i { font-size: 2rem; color: var(--gold); }
        .header-title h1 { font-family: 'Cairo', sans-serif; font-size: 1.5rem; font-weight: 800; }
        .header-title small { opacity: 0.8; font-size: 0.85rem; }
        
        .header-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 10px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .btn-primary { background: var(--info); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-light { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-light:hover { background: rgba(255,255,255,0.25); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        
        #saveBadge {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            cursor: default;
            transition: all 0.3s;
        }
        
        #saveBadge.ok { border-color: rgba(34,197,94,0.6); color: #86efac; }
        #saveBadge.warn { border-color: rgba(245,158,11,0.6); color: #fcd34d; }
        #saveBadge.err { border-color: rgba(239,68,68,0.6); color: #fca5a5; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        
        .alert-bar {
            background: linear-gradient(135deg, rgba(127,29,29,0.3) 0%, rgba(220,38,38,0.2) 100%);
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            gap: 1rem;
        }
        
        .alert-bar.show { display: flex; }
        .alert-bar i { font-size: 1.5rem; color: var(--danger); }
        .alert-bar strong { color: #fca5a5; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 1.25rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stat-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.08); }
        .stat-card.active { border-width: 2px; }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
        }
        
        .stat-card.ext::before { background: var(--ext); }
        .stat-card.high::before { background: var(--high); }
        .stat-card.med::before { background: var(--med); }
        .stat-card.low::before { background: var(--low); }
        .stat-card.total::before { background: var(--gold); }
        
        .stat-value { font-size: 2.2rem; font-weight: 900; font-family: 'Cairo', sans-serif; }
        .stat-label { font-size: 0.8rem; opacity: 0.8; margin-top: 0.25rem; }
        
        .stat-card.ext .stat-value { color: #fca5a5; }
        .stat-card.high .stat-value { color: #fca5a5; }
        .stat-card.med .stat-value { color: #fcd34d; }
        .stat-card.low .stat-value { color: #86efac; }
        .stat-card.total .stat-value { color: var(--gold); }
        
        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 1.5rem;
        }
        
        @media (max-width: 1000px) {
            .main-grid { grid-template-columns: 1fr; }
        }
        
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .card-header {
            background: rgba(255,255,255,0.05);
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .card-header h3 {
            font-family: 'Cairo', sans-serif;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-header h3 i { color: var(--gold); }
        
        .card-body { padding: 1.25rem; }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 700; margin-bottom: 0.4rem; font-size: 0.9rem; }
        .form-label .required { color: var(--danger); }
        
        .form-control {
            width: 100%;
            padding: 0.7rem 1rem;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(255,255,255,0.08);
        }
        
        .form-control option { background: #1e293b; color: #fff; }
        
        textarea.form-control { min-height: 70px; resize: vertical; }
        
        .rating-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .rating-box {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 0.6rem;
            text-align: center;
        }
        
        .rating-box label { display: block; font-weight: 700; margin-bottom: 0.4rem; font-size: 0.8rem; }
        
        .rating-btns { display: flex; gap: 0.25rem; justify-content: center; }
        
        .rating-btn {
            width: 32px;
            height: 32px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: transparent;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        
        .rating-btn:hover { border-color: var(--gold); }
        .rating-btn.active { background: var(--gold); border-color: var(--gold); color: #000; }
        
        .score-display {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border-radius: 10px;
            text-align: center;
            font-weight: 800;
            font-size: 1rem;
        }
        
        .score-display.ext { background: rgba(127,29,29,0.3); border: 2px solid var(--ext); color: #fca5a5; }
        .score-display.high { background: rgba(220,38,38,0.2); border: 2px solid var(--high); color: #fca5a5; }
        .score-display.med { background: rgba(245,158,11,0.2); border: 2px solid var(--med); color: #fcd34d; }
        .score-display.low { background: rgba(34,197,94,0.2); border: 2px solid var(--low); color: #86efac; }
        
        .filters-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.8rem;
            min-width: 120px;
        }
        
        .filter-select option { background: #1e293b; }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        th, td {
            padding: 0.75rem 0.75rem;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        th {
            background: rgba(255,255,255,0.05);
            font-weight: 800;
            font-size: 0.75rem;
            color: var(--gold);
            white-space: nowrap;
            cursor: pointer;
        }
        
        th:hover { background: rgba(255,255,255,0.08); }
        th i { margin-right: 0.25rem; opacity: 0.5; }
        
        tr:hover { background: rgba(255,255,255,0.03); }
        
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .badge-ext { background: var(--ext); color: #fff; }
        .badge-high { background: var(--high); color: #fff; }
        .badge-med { background: var(--med); color: #000; }
        .badge-low { background: var(--low); color: #000; }
        
        .badge-open { background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid rgba(239,68,68,0.4); }
        .badge-progress { background: rgba(59,130,246,0.2); color: #93c5fd; border: 1px solid rgba(59,130,246,0.4); }
        .badge-closed { background: rgba(34,197,94,0.2); color: #86efac; border: 1px solid rgba(34,197,94,0.4); }
        
        .action-btns { display: flex; gap: 0.25rem; }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--gold);
        }
        
        .loading i { font-size: 2rem; animation: spin 1s linear infinite; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: rgba(255,255,255,0.5);
        }
        
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }
        
        .heatmap-section { margin-top: 1.5rem; padding: 1.25rem; }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: 30px repeat(5, 1fr);
            gap: 3px;
            max-width: 350px;
            margin: 0 auto;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-weight: 800;
            font-size: 0.8rem;
        }
        
        .heatmap-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: rgba(255,255,255,0.6);
        }
        
        .heatmap-header {
            text-align: center;
            font-size: 0.65rem;
            color: rgba(255,255,255,0.5);
            padding: 0.2rem;
        }
        
        .cell-ext { background: var(--ext); color: #fff; }
        .cell-high { background: var(--high); color: #fff; }
        .cell-med { background: var(--med); color: #000; }
        .cell-low { background: var(--low); color: #000; }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); color: #fff; }
        .toast.error { background: var(--danger); color: #fff; }
        
        .risk-text { max-width: 180px; font-size: 0.8rem; }
        
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .auth-box {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        
        .auth-box h2 { margin-bottom: 1rem; color: var(--gold); font-family: 'Cairo', sans-serif; }
        .auth-box input {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 1.2rem;
            text-align: center;
            letter-spacing: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .auth-box input:focus { border-color: var(--gold); outline: none; }
        .auth-error { color: var(--danger); font-size: 0.85rem; margin-bottom: 1rem; display: none; }
        
        .export-btns { display: flex; gap: 0.5rem; }
    </style>
</head>
<body>
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-box">
            <i class="fas fa-shield-halved" style="font-size: 3rem; color: var(--gold); margin-bottom: 1rem;"></i>
            <h2>سجل المخاطر</h2>
            <p style="opacity: 0.8; margin-bottom: 1.5rem;">أدخل رمز الوصول</p>
            <input type="password" id="passcodeInput" placeholder="****" maxlength="4" autocomplete="off">
            <p class="auth-error" id="authError">رمز خاطئ، حاول مرة أخرى</p>
            <button class="btn btn-success" style="width: 100%;" onclick="verifyPasscode()">
                <i class="fas fa-unlock"></i> دخول
            </button>
            <p style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.6;">للعرض فقط: اضغط إدخال بدون رمز</p>
        </div>
    </div>

    <header class="header">
        <div class="header-title">
            <i class="fas fa-shield-virus"></i>
            <div>
                <h1>سجل المخاطر - Risk Register</h1>
                <small>إدارة المخاطر - مجمع مكة الطبي بالزاهر</small>
            </div>
        </div>
        <div class="header-actions">
            <span id="saveBadge" class="ok">
                <i class="fas fa-circle-check"></i> جاهز
            </span>
            <button class="btn btn-light" onclick="loadRisks()">
                <i class="fas fa-sync"></i> تحديث
            </button>
            <div class="export-btns">
                <button class="btn btn-light btn-sm" onclick="exportExcel()">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
            </div>
            <a href="incident-report-analysis.html" class="btn btn-light">
                <i class="fas fa-chart-pie"></i> تحليل الحوادث
            </a>
            <a href="mega.html" class="btn btn-light">
                <i class="fas fa-home"></i> المركز الرقمي
            </a>
        </div>
    </header>
    
    <div class="container">
        <div class="alert-bar" id="criticalAlert">
            <i class="fas fa-triangle-exclamation"></i>
            <div>
                <strong>تنبيه!</strong> يوجد <span id="criticalCount">0</span> مخاطر حرجة تتطلب اهتمام فوري
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card total" onclick="filterByLevel('')">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">إجمالي المخاطر</div>
            </div>
            <div class="stat-card ext" onclick="filterByLevel('حرج')">
                <div class="stat-value" id="statExt">0</div>
                <div class="stat-label">حرج (16-25)</div>
            </div>
            <div class="stat-card high" onclick="filterByLevel('عالي')">
                <div class="stat-value" id="statHigh">0</div>
                <div class="stat-label">عالي (12-15)</div>
            </div>
            <div class="stat-card med" onclick="filterByLevel('متوسط')">
                <div class="stat-value" id="statMed">0</div>
                <div class="stat-label">متوسط (6-11)</div>
            </div>
            <div class="stat-card low" onclick="filterByLevel('منخفض')">
                <div class="stat-value" id="statLow">0</div>
                <div class="stat-label">منخفض (1-5)</div>
            </div>
        </div>
        
        <div class="main-grid">
            <div class="card" id="formCard" style="display: none;">
                <div class="card-header">
                    <h3><i class="fas fa-plus-circle"></i> <span id="formTitle">إضافة خطر جديد</span></h3>
                </div>
                <div class="card-body">
                    <form id="riskForm">
                        <input type="hidden" id="editId">
                        
                        <div class="form-group">
                            <label class="form-label">اختر الخطر <span class="required">*</span></label>
                            <select class="form-control" id="riskSelect" required onchange="onRiskSelect()">
                                <option value="">اختر من مكتبة المخاطر...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">أو اكتب وصف جديد</label>
                            <textarea class="form-control" id="riskDesc" placeholder="وصف تفصيلي للخطر..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">التصنيف <span class="required">*</span></label>
                            <select class="form-control" id="category" required>
                                <option value="">اختر التصنيف...</option>
                                <option value="FMS">FMS - إدارة المرافق</option>
                                <option value="PSC">PSC - سلامة المرضى</option>
                                <option value="PSC/FMS">PSC/FMS</option>
                                <option value="IPC">IPC - مكافحة العدوى</option>
                                <option value="EOC">EOC - الطوارئ والكوارث</option>
                                <option value="EOC/FMS">EOC/FMS</option>
                                <option value="RM">RM - إدارة المخاطر</option>
                                <option value="QI">QI - تحسين الجودة</option>
                                <option value="LD">LD - القيادة والحوكمة</option>
                                <option value="HR">HR - الموارد البشرية</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">المالك/المسؤول</label>
                            <select class="form-control" id="owner">
                                <option value="">اختر المسؤول...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">مصدر الخطر <span class="required">*</span></label>
                            <select class="form-control" id="source" required>
                                <option value="">اختر المصدر...</option>
                                <option value="جولة">جولة (Round)</option>
                                <option value="حادث">حادث (Incident)</option>
                                <option value="تدقيق">تدقيق (Audit)</option>
                                <option value="شكوى">شكوى (Complaint)</option>
                                <option value="Near Miss">Near Miss</option>
                                <option value="تقييم ذاتي">تقييم ذاتي</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        
                        <div class="rating-grid">
                            <div class="rating-box">
                                <label>الاحتمالية</label>
                                <div class="rating-btns" id="probBtns">
                                    <button type="button" class="rating-btn" data-val="1">1</button>
                                    <button type="button" class="rating-btn" data-val="2">2</button>
                                    <button type="button" class="rating-btn active" data-val="3">3</button>
                                    <button type="button" class="rating-btn" data-val="4">4</button>
                                    <button type="button" class="rating-btn" data-val="5">5</button>
                                </div>
                            </div>
                            <div class="rating-box">
                                <label>الأثر</label>
                                <div class="rating-btns" id="impactBtns">
                                    <button type="button" class="rating-btn" data-val="1">1</button>
                                    <button type="button" class="rating-btn" data-val="2">2</button>
                                    <button type="button" class="rating-btn active" data-val="3">3</button>
                                    <button type="button" class="rating-btn" data-val="4">4</button>
                                    <button type="button" class="rating-btn" data-val="5">5</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="score-display med" id="scoreDisplay">
                            درجة الخطورة: <span id="scoreValue">9</span> - متوسط
                        </div>
                        
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">إجراءات التخفيف</label>
                            <textarea class="form-control" id="mitigation" placeholder="الإجراءات المقترحة..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">الحالة</label>
                            <select class="form-control" id="status">
                                <option value="مفتوح">مفتوح</option>
                                <option value="قيد المعالجة">قيد المعالجة</option>
                                <option value="مغلق">مغلق</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">تاريخ المراجعة القادمة</label>
                            <input type="date" class="form-control" id="reviewDate">
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; margin-top: 1.25rem;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-save"></i> <span id="submitText">حفظ</span>
                            </button>
                            <button type="button" class="btn btn-light" onclick="resetForm()" id="cancelBtn" style="display: none;">
                                <i class="fas fa-times"></i> إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> سجل المخاطر</h3>
                    <div class="filters-bar">
                        <select class="filter-select" id="filterCategory" onchange="applyFilters()">
                            <option value="">كل التصنيفات</option>
                            <option value="FMS">FMS</option>
                            <option value="PSC">PSC</option>
                            <option value="IPC">IPC</option>
                            <option value="EOC">EOC</option>
                            <option value="RM">RM</option>
                            <option value="QI">QI</option>
                            <option value="LD">LD</option>
                        </select>
                        <select class="filter-select" id="filterLevel" onchange="applyFilters()">
                            <option value="">كل المستويات</option>
                            <option value="حرج">حرج</option>
                            <option value="عالي">عالي</option>
                            <option value="متوسط">متوسط</option>
                            <option value="منخفض">منخفض</option>
                        </select>
                        <select class="filter-select" id="filterStatus" onchange="applyFilters()">
                            <option value="">كل الحالات</option>
                            <option value="مفتوح">مفتوح</option>
                            <option value="قيد المعالجة">قيد المعالجة</option>
                            <option value="مغلق">مغلق</option>
                        </select>
                        <select class="filter-select" id="sortBy" onchange="applyFilters()">
                            <option value="score-desc">الأعلى خطورة</option>
                            <option value="score-asc">الأقل خطورة</option>
                            <option value="date-desc">الأحدث</option>
                            <option value="status">الحالة</option>
                        </select>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="tableContainer">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>جاري التحميل...</p>
                        </div>
                    </div>
                </div>
                
                <div class="heatmap-section">
                    <h4 style="text-align: center; margin-bottom: 1rem; color: var(--gold); font-size: 0.9rem;">
                        <i class="fas fa-th"></i> مصفوفة المخاطر
                    </h4>
                    <div class="heatmap-grid" id="heatmapGrid"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwSCFPl4FKjCwfCNYG7FNiTb2PDTntK7QcMfYJkLcRs0r--l68S4DuehYFl1Xs3H-bl/exec';
        
        let allRisks = [];
        let riskLibrary = [];
        let owners = [];
        let probability = 3;
        let impact = 3;
        let isWriteMode = false;
        
        document.getElementById('passcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verifyPasscode();
        });
        
        function verifyPasscode() {
            const code = document.getElementById('passcodeInput').value;
            
            if (code === '' || code === '0000') {
                isWriteMode = false;
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('formCard').style.display = 'none';
                loadRisks();
            } else if (code === '1234' || code === '2025') {
                isWriteMode = true;
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('formCard').style.display = 'block';
                loadRisks();
                loadRiskLibrary();
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('passcodeInput').value = '';
            }
        }
        
        async function loadRiskLibrary() {
            try {
                const res = await fetch(API_URL + '?action=library');
                const data = await res.json();
                
                if (data.ok && data.items) {
                    riskLibrary = data.items;
                    
                    const ownerSet = new Set();
                    riskLibrary.forEach(r => {
                        if (r.defaultOwner) ownerSet.add(r.defaultOwner);
                    });
                    owners = [...ownerSet];
                    
                    populateRiskDropdown();
                    populateOwnerDropdown();
                }
            } catch (err) {
                console.error('Library load failed:', err);
                populateDefaultOwners();
            }
        }
        
        function populateRiskDropdown() {
            const select = document.getElementById('riskSelect');
            select.innerHTML = '<option value="">اختر من مكتبة المخاطر...</option>';
            
            riskLibrary.forEach((r, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = r.risk;
                select.appendChild(opt);
            });
        }
        
        function populateOwnerDropdown() {
            const select = document.getElementById('owner');
            select.innerHTML = '<option value="">اختر المسؤول...</option>';
            
            const defaultOwners = ['د.خالد الخطاب', 'صابر عبده', 'بلال نذر', 'عدنان الرفاعي', 'هيثم', 'منسق سلامة المرضى', 'الإدارة', 'الصيدلية', 'المختبر', 'التمريض', 'الاستقبال'];
            const allOwners = [...new Set([...owners, ...defaultOwners])];
            
            allOwners.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o;
                opt.textContent = o;
                select.appendChild(opt);
            });
        }
        
        function populateDefaultOwners() {
            const select = document.getElementById('owner');
            select.innerHTML = '<option value="">اختر المسؤول...</option>';
            const defaultOwners = ['د.خالد الخطاب', 'صابر عبده', 'بلال نذر', 'عدنان الرفاعي', 'هيثم', 'منسق سلامة المرضى', 'الإدارة', 'الصيدلية', 'المختبر', 'التمريض', 'الاستقبال'];
            defaultOwners.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o;
                opt.textContent = o;
                select.appendChild(opt);
            });
        }
        
        function onRiskSelect() {
            const idx = document.getElementById('riskSelect').value;
            if (idx === '' || !riskLibrary[idx]) return;
            
            const risk = riskLibrary[idx];
            document.getElementById('riskDesc').value = risk.risk || '';
            document.getElementById('category').value = risk.category || '';
            document.getElementById('owner').value = risk.defaultOwner || '';
            document.getElementById('mitigation').value = risk.defaultMitigation || '';
        }
        
        function setSaveBadge(type, html) {
            const el = document.getElementById('saveBadge');
            el.innerHTML = html;
            el.className = type;
        }
        
        document.querySelectorAll('#probBtns .rating-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#probBtns .rating-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                probability = parseInt(btn.dataset.val);
                updateScore();
            });
        });
        
        document.querySelectorAll('#impactBtns .rating-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#impactBtns .rating-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                impact = parseInt(btn.dataset.val);
                updateScore();
            });
        });
        
        function updateScore() {
            const score = probability * impact;
            let level, levelClass;
            
            if (score >= 16) { level = 'حرج'; levelClass = 'ext'; }
            else if (score >= 12) { level = 'عالي'; levelClass = 'high'; }
            else if (score >= 6) { level = 'متوسط'; levelClass = 'med'; }
            else { level = 'منخفض'; levelClass = 'low'; }
            
            const display = document.getElementById('scoreDisplay');
            display.className = 'score-display ' + levelClass;
            display.innerHTML = `درجة الخطورة: <span id="scoreValue">${score}</span> - ${level}`;
        }
        
        async function loadRisks() {
            document.getElementById('tableContainer').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>جاري التحميل...</p>
                </div>
            `;
            
            try {
                const res = await fetch(API_URL + '?action=list');
                const data = await res.json();
                
                if (data.ok) {
                    allRisks = data.items || [];
                    updateStats();
                    applyFilters();
                    renderHeatmap();
                    checkCriticalAlert();
                } else {
                    showToast('خطأ في تحميل البيانات', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('فشل الاتصال بالخادم', 'error');
                document.getElementById('tableContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>فشل تحميل البيانات</p>
                    </div>
                `;
            }
        }
        
        function checkCriticalAlert() {
            const critical = allRisks.filter(r => r.level === 'حرج' && r.status !== 'مغلق').length;
            const alertBar = document.getElementById('criticalAlert');
            
            if (critical > 0) {
                document.getElementById('criticalCount').textContent = critical;
                alertBar.classList.add('show');
            } else {
                alertBar.classList.remove('show');
            }
        }
        
        function updateStats() {
            const stats = { total: allRisks.length, ext: 0, high: 0, med: 0, low: 0 };
            
            allRisks.forEach(r => {
                if (r.level === 'حرج') stats.ext++;
                else if (r.level === 'عالي') stats.high++;
                else if (r.level === 'متوسط') stats.med++;
                else stats.low++;
            });
            
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statExt').textContent = stats.ext;
            document.getElementById('statHigh').textContent = stats.high;
            document.getElementById('statMed').textContent = stats.med;
            document.getElementById('statLow').textContent = stats.low;
        }
        
        function filterByLevel(level) {
            document.getElementById('filterLevel').value = level;
            applyFilters();
        }
        
        function applyFilters() {
            const cat = document.getElementById('filterCategory').value;
            const lvl = document.getElementById('filterLevel').value;
            const st = document.getElementById('filterStatus').value;
            const sort = document.getElementById('sortBy').value;
            
            let filtered = [...allRisks];
            if (cat) filtered = filtered.filter(r => r.category && r.category.includes(cat));
            if (lvl) filtered = filtered.filter(r => r.level === lvl);
            if (st) filtered = filtered.filter(r => r.status === st);
            
            if (sort === 'score-desc') filtered.sort((a, b) => (b.score || 0) - (a.score || 0));
            else if (sort === 'score-asc') filtered.sort((a, b) => (a.score || 0) - (b.score || 0));
            else if (sort === 'date-desc') filtered.sort((a, b) => new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0));
            else if (sort === 'status') {
                const order = { 'مفتوح': 0, 'قيد المعالجة': 1, 'مغلق': 2 };
                filtered.sort((a, b) => (order[a.status] || 0) - (order[b.status] || 0));
            }
            
            renderTable(filtered);
        }
        
        function renderTable(risks) {
            if (!risks.length) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>لا توجد مخاطر مسجلة</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>الخطر</th>
                                <th>التصنيف</th>
                                <th>المسؤول</th>
                                <th>المصدر</th>
                                <th>الدرجة</th>
                                <th>المستوى</th>
                                <th>الحالة</th>
                                ${isWriteMode ? '<th>إجراءات</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${risks.map(r => `
                                <tr>
                                    <td class="risk-text">${r.risk || '-'}</td>
                                    <td><span class="badge" style="background: rgba(201,169,98,0.2); color: var(--gold);">${r.category || '-'}</span></td>
                                    <td style="font-size: 0.8rem;">${r.owner || '-'}</td>
                                    <td style="font-size: 0.75rem; opacity: 0.7;">${r.sourceEvidence || '-'}</td>
                                    <td style="font-weight: 800;">${r.score || '-'}</td>
                                    <td><span class="badge badge-${getLevelClass(r.level)}">${r.level || '-'}</span></td>
                                    <td><span class="badge badge-${getStatusClass(r.status)}">${r.status || '-'}</span></td>
                                    ${isWriteMode ? `
                                        <td>
                                            <div class="action-btns">
                                                <button class="btn btn-sm btn-primary" onclick="editRisk('${r.id}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteRisk('${r.id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    ` : ''}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('tableContainer').innerHTML = html;
        }
        
        function getLevelClass(level) {
            if (level === 'حرج') return 'ext';
            if (level === 'عالي') return 'high';
            if (level === 'متوسط') return 'med';
            return 'low';
        }
        
        function getStatusClass(status) {
            if (status === 'مغلق') return 'closed';
            if (status === 'قيد المعالجة') return 'progress';
            return 'open';
        }
        
        function renderHeatmap() {
            const matrix = {};
            for (let p = 1; p <= 5; p++) {
                for (let i = 1; i <= 5; i++) {
                    matrix[`${p}-${i}`] = 0;
                }
            }
            
            allRisks.forEach(r => {
                const key = `${r.probability}-${r.impact}`;
                if (matrix[key] !== undefined) matrix[key]++;
            });
            
            let html = '<div class="heatmap-header"></div>';
            for (let i = 1; i <= 5; i++) {
                html += `<div class="heatmap-header">${i}</div>`;
            }
            
            for (let p = 5; p >= 1; p--) {
                html += `<div class="heatmap-label">${p}</div>`;
                for (let i = 1; i <= 5; i++) {
                    const score = p * i;
                    let cellClass;
                    if (score >= 16) cellClass = 'cell-ext';
                    else if (score >= 12) cellClass = 'cell-high';
                    else if (score >= 6) cellClass = 'cell-med';
                    else cellClass = 'cell-low';
                    
                    const count = matrix[`${p}-${i}`];
                    html += `<div class="heatmap-cell ${cellClass}">${count || ''}</div>`;
                }
            }
            
            document.getElementById('heatmapGrid').innerHTML = html;
        }
        
        document.getElementById('riskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isWriteMode) {
                showToast('وضع العرض فقط - لا يمكن الحفظ', 'error');
                return;
            }
            
            setSaveBadge('warn', '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...');
            
            const editId = document.getElementById('editId').value;
            const payload = {
                risk: document.getElementById('riskDesc').value || document.getElementById('riskSelect').selectedOptions[0]?.textContent || '',
                category: document.getElementById('category').value,
                owner: document.getElementById('owner').value,
                probability: probability,
                impact: impact,
                mitigation: document.getElementById('mitigation').value,
                status: document.getElementById('status').value,
                reviewDate: document.getElementById('reviewDate').value,
                sourceEvidence: document.getElementById('source').value,
                updatedBy: 'user'
            };
            
            const action = editId ? 'update' : 'add';
            if (editId) payload.id = editId;
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, payload })
                });
                
                const data = await res.json();
                
                if (data.ok) {
                    setSaveBadge('ok', '<i class="fas fa-circle-check"></i> تم الحفظ ✓');
                    showToast(editId ? 'تم التحديث بنجاح' : 'تمت الإضافة بنجاح', 'success');
                    resetForm();
                    loadRisks();
                } else {
                    setSaveBadge('err', '<i class="fas fa-triangle-exclamation"></i> فشل الحفظ');
                    showToast(data.error || 'حدث خطأ', 'error');
                }
            } catch (err) {
                setSaveBadge('err', '<i class="fas fa-triangle-exclamation"></i> فشل الحفظ');
                showToast('فشل الاتصال', 'error');
            }
        });
        
        function editRisk(id) {
            if (!isWriteMode) return;
            
            const risk = allRisks.find(r => r.id === id);
            if (!risk) return;
            
            document.getElementById('editId').value = id;
            document.getElementById('riskDesc').value = risk.risk || '';
            document.getElementById('category').value = risk.category || '';
            document.getElementById('owner').value = risk.owner || '';
            document.getElementById('mitigation').value = risk.mitigation || '';
            document.getElementById('status').value = risk.status || 'مفتوح';
            document.getElementById('reviewDate').value = risk.reviewDate || '';
            document.getElementById('source').value = risk.sourceEvidence || '';
            
            probability = risk.probability || 3;
            impact = risk.impact || 3;
            
            document.querySelectorAll('#probBtns .rating-btn').forEach(b => {
                b.classList.toggle('active', parseInt(b.dataset.val) === probability);
            });
            document.querySelectorAll('#impactBtns .rating-btn').forEach(b => {
                b.classList.toggle('active', parseInt(b.dataset.val) === impact);
            });
            
            updateScore();
            
            document.getElementById('formTitle').textContent = 'تعديل الخطر';
            document.getElementById('submitText').textContent = 'تحديث';
            document.getElementById('cancelBtn').style.display = 'block';
            
            document.getElementById('riskForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function deleteRisk(id) {
            if (!isWriteMode) return;
            if (!confirm('هل أنت متأكد من حذف هذا الخطر؟')) return;
            
            setSaveBadge('warn', '<i class="fas fa-spinner fa-spin"></i> جاري الحذف...');
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'delete', payload: { id } })
                });
                
                const data = await res.json();
                
                if (data.ok) {
                    setSaveBadge('ok', '<i class="fas fa-circle-check"></i> تم الحذف ✓');
                    showToast('تم الحذف بنجاح', 'success');
                    loadRisks();
                } else {
                    setSaveBadge('err', '<i class="fas fa-triangle-exclamation"></i> فشل الحذف');
                    showToast(data.error || 'حدث خطأ', 'error');
                }
            } catch (err) {
                setSaveBadge('err', '<i class="fas fa-triangle-exclamation"></i> فشل');
                showToast('فشل الاتصال', 'error');
            }
        }
        
        function resetForm() {
            document.getElementById('riskForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('formTitle').textContent = 'إضافة خطر جديد';
            document.getElementById('submitText').textContent = 'حفظ';
            document.getElementById('cancelBtn').style.display = 'none';
            
            probability = 3;
            impact = 3;
            
            document.querySelectorAll('#probBtns .rating-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.val === '3');
            });
            document.querySelectorAll('#impactBtns .rating-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.val === '3');
            });
            
            updateScore();
        }
        
        function exportExcel() {
            if (!allRisks.length) {
                showToast('لا توجد بيانات للتصدير', 'error');
                return;
            }
            
            let csv = '\uFEFF';
            csv += 'الخطر,التصنيف,المسؤول,المصدر,الاحتمالية,الأثر,الدرجة,المستوى,الحالة,إجراءات التخفيف\n';
            
            allRisks.forEach(r => {
                csv += `"${r.risk || ''}","${r.category || ''}","${r.owner || ''}","${r.sourceEvidence || ''}",${r.probability || ''},${r.impact || ''},${r.score || ''},"${r.level || ''}","${r.status || ''}","${r.mitigation || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'risk-register-' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            
            showToast('تم التصدير بنجاح', 'success');
        }
        
        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
