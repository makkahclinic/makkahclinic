// /api/gpt.js - FINAL VERSION FOR MEDICAL AUDIT

const systemInstruction = `
ุฃูุช "ูุจูุฑ ุงุณุชุดุงุฑูู ุงูุชุฏููู ุงูุทุจู"ุ ููููุชู ูู ุชุญููู ุงููุตูุงุช ุงูุทุจูุฉ ุงููุนูุฏุฉ ุฅูู ุชูุงุฑูุฑ ุงุณุชุฑุงุชูุฌูุฉ ูุงุถุญุฉ ูููุธูุฉ ูู ุฌุฏุงูู HTML.

**ููุงุนุฏ ุงูุณููู ุงูุฅูุฒุงููุฉ:**
- **ุงูุฏูุฉ ุงูุทุจูุฉ ุงููุทููุฉ:** ูุจู ุงุฏุนุงุก ูุฌูุฏ ุงุฒุฏูุงุฌูุฉ ุนูุงุฌูุฉุ ูุฌุจ ุฃู ุชููู ูุชุฃูุฏุงู 100% ุฃู ุงูุฏูุงุฆูู ูู ููุณ ุงูุนุงุฆูุฉ ุงูุนูุงุฌูุฉ ููุนุงูุฌุงู ููุณ ุงูุญุงูุฉ. ุชุฌูุจ ุงูุฃุฎุทุงุก ูุซู ุงูุฎูุท ุจูู ุฃุฏููุฉ ุงูุถุบุท (Amlodipine) ูุฃุฏููุฉ ุงูุฏููู (Rozavi). ุงูุฏูุฉ ูู ุฃููููุชู ุงููุตูู.
- **ุงูุชูุงุตู ุงูุงุญุชุฑุงูู:** ูุง ุชุณุชุฎุฏู ุนุจุงุฑุงุช ูุซู "ูุฑุงุกุฉ ููุซููุฉ". ุฅุฐุง ูุงูุช ูุฑุงุกุชู ููููุฉ ูุง ุบูุฑ ูุงุถุญุฉุ ุงุฐูุฑ ุฃูุถู ุชุฎููู ูู ูุฃุชุจุนู ุจุนุจุงุฑุฉ "(ูุฑุงุกุฉ ุบูุฑ ูุงุถุญุฉุ ูุชุทูุจ ุชูุถูุญุงู ูู ุงูุทุจูุจ)".

**ูููุฌูุฉ ุงูุชุญููู ุงูุฅูุฒุงููุฉ:**

**ุงูุฎุทูุฉ 0: ูุณุญ ุงูุจูุงูุงุช ุงูุฏูููุบุฑุงููุฉ**
- ุงุจุฏุฃ ุจูุณุญ ุดุงูู ููุฌุฒุก ุงูุนููู ูู ุงููุซููุฉ. ุงุณุชุฎุฑุฌ 'ุฑูู ุงูููู'ุ 'ุงูุฌูุณ' (ูู ุงูุฎุงูุฉ ุงููุญุฏุฏุฉ โ)ุ ู'ุงูุนูุฑ' (ุฅู ูุฌุฏ). ุงุฐูุฑ ูุฐู ุงููุนูููุงุช ูู ุจุฏุงูุฉ ุงูุชูุฑูุฑ.

**ุงูุฎุทูุฉ 1: ุงุณุชุฎูุงุต ูุชุญููู ุงูุจูุงูุงุช ูู ุฌุฏูู**
1.  **ุฃูุดุฆ ุฌุฏูู HTML ูุชุญููู ุงูุฃุฏููุฉ** ุจุงูุฃุนูุฏุฉ ุงูุชุงููุฉ: "ุงูุฏูุงุก", "ุงูุฌุฑุนุฉ ุงููุชุฑุฌูุฉ", "ุงูุบุฑุถ ุงูุทุจู ุงููุฑุฌุญ", "ููุงุญุธุงุช ูุชุจุฑูุฑุงุช".
2.  **ุงููุฃ ุงูุฌุฏูู ุจุฏูุฉ:**
    - **ุงูุฌุฑุนุฉ ุงููุชุฑุฌูุฉ:** ูู ุดูุฑุฉ ุงูุชุฑููุฒ (ูุซู '1x1x90') ูุชุฑุฌูู ุฅูู ูุต ููููู ("ูุฑุฉ ูุงุญุฏุฉ ููููุงู ููุฏุฉ 90 ูููุงู").
    - **ููุงุญุธุงุช ูุชุจุฑูุฑุงุช:** ุงุณุชุฎุฏู ุงููุคุดุฑุงุช ุงูุจุตุฑูุฉ: โ (ูุจุฑุฑ)ุ โ๏ธ (ูุชุทูุจ ุชุจุฑูุฑุงู)ุ โ (ุฎุทุฃ ูุญุชูู).

**ุงูุฎุทูุฉ 2: ุชุญุฏูุฏ ุงูุฃุฎุทุงุก ุงูุญุฑุฌุฉ ููุฌูุงุช ุงูุชุจุฑูุฑ**
- ุจุนุฏ ุงูุฌุฏููุ ุฃูุดุฆ ูุณูุงู ุจุนููุงู **"ุงูุฃุฎุทุงุก ุงูุทุจูุฉ ุงูุญุฑุฌุฉ ุงูููุชุดูุฉ"**.
- ุงุฐูุฑ ููุง ุจูุถูุญ ุฃู ุฃุฎุทุงุก ุฌุณููุฉ ูุฌุฏุชูุงุ ูุซู:
    - **ุงูุงุฒุฏูุงุฌูุฉ ุงูุนูุงุฌูุฉ ุงูุญููููุฉ:** (ูุซุงู: "ููุฌุฏ ุฎุทุฑ ุงุฒุฏูุงุฌูุฉ ุซูุงุซูุฉ ูู ุนูุงุฌ ุงูุถุบุท ุจูู ุงูุฃุฏููุฉ Amlodipine, Co-Taburan, ู Triplex").
    - **ุฃุฎุทุงุก ุงูุฌุฑุนุงุช:** (ูุซุงู: "ุฌุฑุนุฉ ุฏูุงุก Diamicron MR ุงูููุตููุฉ ูุฑุชูู ููููุงู ุชุนุชุจุฑ ุฎุทุฃ ุนูุงุฌูุงู").
- ุซู ุฃูุดุฆ ูุณูุงู ุจุนููุงู **"ุงููุญูุตุงุช ุงููุทููุจุฉ ูุงุณุชููุงู ุงูููู"** ูุงุฐูุฑ ูููุง ูุงุฆูุฉ ุงููุญูุตุงุช ุงููุงุฒูุฉ.

**ุงูุฎุทูุฉ 3: ุตูุงุบุฉ ุชูุตูุงุช ุชูููุฐูุฉ**
- ูุฏู ุฎุทุฉ ุนูู ุชูููุฐูุฉ ููุงุถุญุฉ ุจูุงุกู ุนูู ุงูุฃุฎุทุงุก ูุงููุฌูุงุช ุงูุชู ูุฌุฏุชูุง.

**ุงููุฎุฑุฌ ุงูููุงุฆู:**
- ูุฌุจ ุฃู ูููู ุฑุฏู ูู ููุฏ HTML ููุทุ ููุธูุงู ูู ุฌุฏุงูู ูุงุถุญุฉุ ููุจุฏุฃ ูุจุงุดุฑุฉ ุจุงููุณู \`<h3>\`.
`;

// The rest of the /api/gpt.js file (buildUserPrompt, handler, etc.) remains the same as the last version I provided.
// This is just the final, polished systemInstruction. For clarity, the full file is below.

function buildUserPrompt(caseData) {
    const {
        gender, isPregnant, pregnancyMonth, height, weight, temperature,
        bloodPressure, caseDescription, diagnosis, labResults,
        medicationsProcedures, imageData
    } = caseData;

    return `
        **ุงูุจูุงูุงุช ุงููุงุฑุฏุฉ ููุชุญููู:**
        - ุงููููุงุช ุงููุฑููุนุฉ: ${imageData && imageData.length > 0 ? `ููุฌุฏ ${imageData.length} ุตูุฑุฉ ูุฑููุฉ ููุชุญููู. **ูุฐู ูู ุงููุตุฏุฑ ุงูุฃุณุงุณู ูุงููุญูุฏ ููุญูููุฉ.**.` : "ูุง ููุฌุฏ ุตูุฑ ูุฑููุฉ."}
        ---
        **ูููู ุงูุชูุฑูุฑ ุงููุทููุจ (ููุงุณุชุฎุฏุงู ูู ุงููุฎุฑุฌ ุงูููุงุฆู):**
        <h3>ุชูุฑูุฑ ุงุณุชุดุงุฑู ููุชุฏููู ุงูุทุจู</h3>
        <div class="section"><h4>1. ููุฎุต ุงูุญุงูุฉ ูุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ:</h4><p>[ุงูููุฎุต ููุง]</p></div>
        <div class="section"><h4>2. ุฌุฏูู ุชุญููู ุงูุฃุฏููุฉ ุงูููุตููุฉ:</h4><table><thead><tr><th>ุงูุฏูุงุก</th><th>ุงูุฌุฑุนุฉ ุงููุชุฑุฌูุฉ</th><th>ุงูุบุฑุถ ุงูุทุจู ุงููุฑุฌุญ</th><th>ููุงุญุธุงุช ูุชุจุฑูุฑุงุช</th></tr></thead><tbody></tbody></table></div>
        <div class="section"><h4>3. ุงูุฃุฎุทุงุก ุงูุทุจูุฉ ุงูุญุฑุฌุฉ ูุงููุญูุตุงุช ุงููุทููุจุฉ:</h4><h5>ุงูุฃุฎุทุงุก ุงูุทุจูุฉ ุงูุญุฑุฌุฉ ุงูููุชุดูุฉ:</h5><p>[ูุดู ุงูุฃุฎุทุงุก ููุง]</p><h5>ุงููุญูุตุงุช ุงููุทููุจุฉ ูุงุณุชููุงู ุงูููู:</h5><p>[ูุงุฆูุฉ ุงููุญูุตุงุช ููุง]</p></div>
        <div class="section"><h4>4. ุฎุทุฉ ุงูุนูู ูุงูุชูุตูุงุช ุงูุชูููุฐูุฉ:</h4><p>[ุงูุฎุทุฉ ููุง]</p></div>
    `;
}

export default async function handler(req, res) {
    // CORS and method checks...
    if (req.method !== 'POST') return res.status(405).json({ error: 'Method Not Allowed' });

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error("GEMINI_API_KEY is not set.");
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

        const userPrompt = buildUserPrompt(req.body);
        const parts = [{ text: systemInstruction }, { text: userPrompt }];

        if (req.body.imageData && req.body.imageData.length > 0) {
            req.body.imageData.forEach(imgData => {
                parts.push({ inline_data: { mimeType: "image/jpeg", data: imgData } });
            });
        }

        const payload = {
            contents: [{ role: "user", parts: parts }],
            generationConfig: { temperature: 0.25, topP: 0.95, topK: 40 },
        };

        const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });

        if (!response.ok) {
            const errorBody = await response.json();
            console.error("Gemini API Error:", errorBody);
            throw new Error(errorBody.error?.message || `API request failed: ${response.statusText}`);
        }

        const result = await response.json();
        const reportHtml = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!reportHtml) throw new Error("The model did not generate a report.");
        
        return res.status(200).json({ htmlReport: reportHtml });

    } catch (err) {
        console.error("๐ฅ Server-side Error in /api/gpt:", err);
        return res.status(500).json({ error: "Server error during analysis", detail: err.message });
    }
}
