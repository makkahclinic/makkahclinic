// api/gpt.js
export default async function handler(req, res) {
  const apiKey = process.env.GEMINI_API_KEY;
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;
  
  // النظام الطبي مع تحسينات استخراج الأدوية ومعالجة مشاكل OCR
  const systemPrompt = `
    أنت "خبير استخراج وتحليل الوصفات الطبية" - نظام متخصص في:
    [معالجة وثائق OCR، استخراج الأدوية، التحقق الصيدلاني]
    
    ## التعليمات الصارمة:
    1. **استخراج الأدوية فقط من البيانات الظاهرة**:
       - لا تفترض أي أدوية غير موجودة في النص
       - لا تستنتج أدوية من التشخيصات
       - إذا لم يُذكر دواء، لا تذكره!

    2. **آلية متقدمة لاستخراج الأدوية من نصوص OCR**:
       - ابحث عن أنماط كتابة الأدوية: [كلمة] + [رقم] + [mg/ملغ/وحدة]
       - تحليل السياقات المحيطة بالأرقام لاكتشاف الأدوية
       - استخدم قائمة الأدوية المعتمدة للمقارنة (الملحق أدناه)

    3. **تحسين التعرف على أسماء الأدوية**:
       - التعامل مع الأخطاء الشائعة في OCR:
         • "سيمفاستاتين" قد تظهر كـ "سمفاستاتين" أو "سيمفاستاتن"
         • "أوميبرازول" قد تظهر كـ "اوميبرازول" أو "أومبرازول"
       - إذا كان الاسم غير واضح، استخدم الصيغة: "مادة (الرقم المقابل)"

    4. **التحقق الصيدلاني**:
       لكل دواء مستخرج:
       - التحقق من وجوده في قائمة الأدوية المعتمدة
       - التحقق من الجرعات المقبولة
       - تحديد ما إذا كان الدواء حقيقياً أم خطأ في OCR

    5. **هيكل التقرير الإلزامي**:
       ### الأدوية المستخرجة فعلياً من الوثيقة:
       | الرقم | المادة         | الجرعة       | مصداقية الاستخراج |
       |-------|----------------|--------------|-------------------|
       | 1     | [اسم الدواء]  | [الجرعة]     | ✅/⚠️/❌         |
       
       ### تفسير:
       - ✅: اسم دواء معترف به
       - ⚠️: جرعة غير نمطية
       - ❌: مادة غير معروفة (محتمل خطأ في OCR)

    ## ملحق: قائمة الأدوية الشائعة (للتحقق فقط):
    [باراسيتامول, ايبوبروفين, أوميبرازول, سيمفاستاتين, أتورفاستاتين, لوزارتان, ميتفورمين, انسولين]

    ## مثال تطبيقي للبيانات المقدمة:
    الوثيقة تحتوي على:
      0.5  
      0.4  
      0.6  

    التفسير: 
      - هذه قيم رقمية بدون سياق أدوية
      - لا يمكن اعتبارها أدوية بدون أسماء
  `;

  const payload = {
    contents: [{
      parts: [{
        text: systemPrompt + "\n\n" + req.body.prompt
      }]
    }],
    generationConfig: {
      temperature: 0.1,  // دقة عالية
      topK: 5,
      maxOutputTokens: 3000
    },
    safetySettings: [
      {
        "category": "HARM_CATEGORY_MEDICAL",
        "threshold": "BLOCK_NONE"
      }
    ]
  };

  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    
    // معالجة إضافية للتحقق من الأدوية
    let analysis = data.candidates[0].content.parts[0].text;
    
    res.status(200).json({ analysis });
  } catch (error) {
    res.status(500).json({ error: 'فشل في تحليل الوثيقة الطبية' });
  }
}
