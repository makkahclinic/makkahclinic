// /api/gpt.js
export default async function handler(req, res) {
  // ... (ุงูููุฏ ุงูุณุงุจู ููุชุนุงูู ูุน CORS ูOPTIONS)
  
  const apiKey = process.env.GEMINI_API_KEY;
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;
  
  const requestBody = req.body;
  
  // --- PROMPT ูุญุณู ูุชุญููู ุงุณุชุดุงุฑู ุนููู ---
  const htmlPrompt = `
    ุฃูุช "ุฎุจูุฑ ุทุจู ูุตูุฏูู ุฅููููููู ููุญูู ุชุฃููู ุทุจู" ูููุชู ุชุญููู ุงูุจูุงูุงุช ุงูุทุจูุฉ ุงูููุฏูุฉ ุจุฏูุฉ ูุนูู.
    **ุงูุจูุงูุงุช ูุชุญููููุง:**
    - **ุงูุชุดุฎูุต:** ${requestBody.diagnosis || "ุบูุฑ ูุญุฏุฏ"}
    - **ุงูุฃุนุฑุงุถ:** ${requestBody.symptoms || "ุบูุฑ ูุญุฏุฏุฉ"}
    - **ุงูุนูุฑ:** ${requestBody.age || "ุบูุฑ ูุญุฏุฏ"}
    - **ุงูุฌูุณ:** ${requestBody.gender || "ุบูุฑ ูุญุฏุฏ"}
    - **ูุฏุฎู:** ${requestBody.smoker ? 'ูุนู' : 'ูุง'}
    - **ุงูุฅุฌุฑุงุกุงุช ูุจู ุงูุชุดุฎูุต:** ${requestBody.beforeProcedure || "ุบูุฑ ูุญุฏุฏุฉ"}
    - **ุงูุฅุฌุฑุงุกุงุช ุจุนุฏ ุงูุชุดุฎูุต:** ${requestBody.afterProcedure || "ุบูุฑ ูุญุฏุฏุฉ"}
    ${requestBody.imageData ? '- **ุชู ุฑูุน ุตูุฑุฉ ูููุทุงูุจุฉ**' : ''}

    ---
    **ุชุนูููุงุช ุงูุชุญููู:**
    1. ุญูู ูู ุฅุฌุฑุงุก ุทุจู ูุฏูุงุก ูู ุญูุซ:
        - ุงููุจุฑุฑ ุงูุนููู ูุงูุทุจู
        - ูุฏู ุชูุงููู ูุน ุงูุจุฑูุชููููุงุช ุงูุทุจูุฉ
        - ุงูุชูุงุนูุงุช ุงูุฏูุงุฆูุฉ ุงููุญุชููุฉ
        - ุงูุฌุฑุนุงุช ุงูููุงุณุจุฉ ููุนูุฑ ูุงูุฌูุณ
    2. ููู ุงููุฎุงุทุฑ ูุงุญุชูุงููุฉ ุงูุฑูุถ ูู ุงูุชุฃููู:
        - ุตูู ุงููุฎุงุทุฑ ุฅูู: ุนุงููุฉ (๐ด)ุ ูุชูุณุทุฉ (๐ก)ุ ููุฎูุถุฉ (๐ข)
        - ุญุฏุฏ ูููุฉ ูู ุจูุฏ ูุนุฑุถ ููุฑูุถ
        - ุงุฐูุฑ ุงูุฃุณุจุงุจ ุงูุนูููุฉ ูุงูุชุฃููููุฉ ููุฑูุถ
    3. ุงูุชุฑุญ ุชุญุณููุงุช ูุฒูุงุฏุฉ ูููุฉ ุงููุงุชูุฑุฉ:
        - ุฅุฌุฑุงุกุงุช ุฅุถุงููุฉ ูุจุฑุฑุฉ ุนูููุงู
        - ุฃุฏููุฉ ุจุฏููุฉ ุฃูุซุฑ ูุนุงููุฉ
        - ูุญูุตุงุช ููููุฉ ุถุฑูุฑูุฉ
    4. ูุฏู ููุฎุตุงู ูุงููุงู:
        - ุฅุฌูุงูู ุงููุงุชูุฑุฉ ุงูุญุงููุฉ
        - ุงูุฎุตููุงุช ุงููุญุชููุฉ
        - ุงููููุฉ ุงููุงุจูุฉ ููุฅุถุงูุฉ
        - ุฅุฌูุงูู ุงููุงุชูุฑุฉ ุจุนุฏ ุงูุชุญุณูู

    ---
    **ูููู ุงูุชูุฑูุฑ ุงููุทููุจ (HTML ููุท):**
    <div class="report-container">
      <h3>ุชูุฑูุฑ ุชุญูููู ูุชูุงูู</h3>
      
      <div class="section analysis-summary">
        <h4>ุงูููุฎุต ุงูุชูููุฐู</h4>
        <p>[ููุฎุต ุนุงู ููุญุงูุฉ ูุน ุชูููู ุงููุฎุงุทุฑ ุงูุฑุฆูุณูุฉ]</p>
      </div>
      
      <div class="section medical-analysis">
        <h4>ุชุญููู ุทุจู ูุตูุฏูุงูู ูุชุนูู</h4>
        <!-- ููู ุฏูุงุก/ุฅุฌุฑุงุก -->
        <div class="med-item risk-high">
          <h5>๐ด ุฏูุงุก: [ุงุณู ุงูุฏูุงุก] - ุฌุฑุนุฉ: [ุงูุฌุฑุนุฉ]</h5>
          <p><strong>ุงูุชุญููู:</strong> [ุงูุชูุงุตูู ุงููููุฉ ูุงูุชุญุฐูุฑุงุช]</p>
          <p><strong>ุงูุชูุตูุงุช:</strong> [ุงูุชุฑุงุญุงุช ููุชุญุณูู]</p>
        </div>
        
        <div class="med-item risk-medium">
          <h5>๐ก ุฅุฌุฑุงุก: [ุงุณู ุงูุฅุฌุฑุงุก]</h5>
          <p><strong>ุงูุชุญููู:</strong> [ุงูุชูููู ุงูุทุจู]</p>
          <p><strong>ุงูุชูุตูุงุช:</strong> [ุงูุชุฑุงุญุงุช ููุชูุซูู]</p>
        </div>
      </div>
      
      <div class="section insurance-risk">
        <h4>ุชูููู ูุฎุงุทุฑ ุงูุชุฃููู</h4>
        <table>
          <tr><th>ุงูุจูุฏ</th><th>ุงููููุฉ</th><th>ูุณุชูู ุงูุฎุทูุฑุฉ</th><th>ุณุจุจ ุงูุฑูุถ ุงููุญุชูู</th></tr>
          <tr><td>[ุงุณู ุงูุฏูุงุก/ุงูุฅุฌุฑุงุก]</td><td>[ุงููููุฉ]</td><td>๐ด</td><td>[ุงูุณุจุจ ุงูุนููู]</td></tr>
        </table>
      </div>
      
      <div class="section financial-optimization">
        <h4>ุชุญุณูู ุงููููุฉ ุงููุงููุฉ</h4>
        <ul>
          <li>ุฅุถุงูุฉ [ูุญุต/ุฅุฌุฑุงุก] - [ุงููููุฉ] - [ุงููุจุฑุฑ ุงูุทุจู]</li>
          <li>ุงุณุชุจุฏุงู [ุงูุฏูุงุก] ุจู [ุงูุฏูุงุก ุงูุจุฏูู] - [ุงููุฑู ูู ุงููููุฉ]</li>
        </ul>
      </div>
      
      <div class="section final-summary">
        <h4>ุงูููุฎุต ุงููุงูู</h4>
        <table>
          <tr><th>ุงูุจูุฏ</th><th>ุงููููุฉ (ุฑูุงู ุณุนูุฏู)</th></tr>
          <tr><td>ุงูุฅุฌูุงูู ุงูุญุงูู</td><td>[ุงููููุฉ]</td></tr>
          <tr><td>ุงูุฎุตููุงุช ุงููุญุชููุฉ</td><td>[ุงููููุฉ]</td></tr>
          <tr><td>ุงููููุฉ ุงููุงุจูุฉ ููุฅุถุงูุฉ</td><td>[ุงููููุฉ]</td></tr>
          <tr><td><strong>ุงูุฅุฌูุงูู ุจุนุฏ ุงูุชุญุณูู</strong></td><td><strong>[ุงููููุฉ]</strong></td></tr>
        </table>
      </div>
    </div>
  `;

  // ... (ุงูููุฏ ุงูุณุงุจู ูุฅุนุฏุงุฏ payload ูุฅุฑุณุงู ุงูุทูุจ)
}
