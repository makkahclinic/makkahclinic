/**
ย* @description ููุทุฉ ููุงูุฉ API ูุญุณููุฉ ุชุชุนุงูู ูุน ุทูุจุงุช ุจูุงุจุชู ุงูุทุจูุจ ูุงููุฑูุถ
ย* ุจุฃุณููุจ ุงุณุชุดุงุฑู ุฎุจูุฑุ ูุชุฏุนู ุฑูุน ูููุงุช ูุชุนุฏุฏุฉ (ุตูุฑ ู PDF).
ย*/
export default async function handler(req, res) {
ย // Set CORS headers
ย res.setHeader("Access-Control-Allow-Origin", "*");
ย res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
ย res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
ย if (req.method === "OPTIONS") return res.status(200).end();
ย if (req.method !== "POST") return res.status(405).json({ error: "Method Not Allowed" });

ย const apiKey = process.env.GEMINI_API_KEY;
ย const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;
ยย
ย let htmlPrompt;
ย const requestBody = req.body;

ย // --- --- --- --- --- --- --- --- --- --- --- ---
ย // --- 1. ุชุทููุฑ ุดุฎุตูุฉ ุงููุณุชุดุงุฑ ุงูุทุจู ูููุฑูุถ ---
ย // --- --- --- --- --- --- --- --- --- --- --- ---
ย if (requestBody.analysisType === 'patient') {
ย ย const { symptoms, age, gender, smoker, vitals, labs, diagnosis, currentMedications, weight, height, isPregnant, pregnancyMonth } = requestBody;
ย ย htmlPrompt = `
      ุฃูุช "ุงูุฏูุชูุฑ ุญููู"ุ ูุณุชุดุงุฑ ุทุจู ุฐูู ูุฎุจูุฑ ูุชูุชุน ุจุฎุจุฑุฉ ูุงุณุนุฉ ูู ุชุดุฎูุต ุงูุญุงูุงุช ุงููุนูุฏุฉ. ูููุชู ูู ุชุญููู ุงูุจูุงูุงุช ุงูุชู ููุฏููุง ุงููุฑูุถ ุจุนูู ุงุณุชุซูุงุฆูุ ูุชูุฏูู ุชูุฑูุฑ HTML ููุตูุ ุขููุ ูุนููู. ูุฌุจ ุฃู ุชููุฑ ูุทุจูุจ ุงุณุชุดุงุฑู ุญููููุ ุชุจุญุซ ุนู ุงูุฃุณุจุงุจ ุงูุฌุฐุฑูุฉุ ุชูุชุดู ุงูุฃุฎุทุงุก ุงูุทุจูุฉ ุงูุดุงุฆุนุฉุ ูุชูุถุญ ุงููุฎุงุทุฑ ุงููุญุชููุฉ (ูุซู ุชูุงุนู ุงูุฃุฏููุฉ ุฃู ููุงูุน ุงูุงุณุชุนูุงู)ุ ูุชูุชุฑุญ ุฎุทูุงุช ุนูููุฉ ููุญุฏุฏุฉ. ูุฌุจ ุฃู ูููู ุฃุณููุจู ูุงุถุญูุงุ ูุทูุฆููุงุ ููููู ูุจุงุดุฑ ูุญุงุณู ุนูุฏูุง ูุชุนูู ุงูุฃูุฑ ุจุงูุณูุงูุฉ.

ย ย ย **ููู ุงููุฑูุถ:**
ย ย ย - ุงูุนูุฑ ูุงูุฌูุณ: ${age}ุ ${gender}
ย ย ย - ุงููุฒู ูุงูุทูู: ${weight || "ูู ูุญุฏุฏ"} ูุฌูุ ${height || "ูู ูุญุฏุฏ"} ุณู
ย ย ย - ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ (ุงูุชุฏุฎูู/ุงูุญูู): ${smoker ? 'ูุนู' : 'ูุง'}ุ ${isPregnant ? `ุญุงูู ูู ุงูุดูุฑ ${pregnancyMonth}` : "ูุง"}
ย ย ย - ุงูุฃุนุฑุงุถ ุงูุฑุฆูุณูุฉ ูุงูุดููู: ${symptoms}
ย ย ย - ุงูุฃุฏููุฉ ุงูุญุงููุฉ (ููุทุฉ ุญุงุณูุฉ ููุชุญููู): ${currentMedications || "ูุง ููุฌุฏ"}
ย ย ย - ุจูุงูุงุช ุฅุถุงููุฉ (ุฅู ูุฌุฏุช): ุงูุญุฑุงุฑุฉ/ุงูุถุบุท (${vitals || "ูู ุชูุฏู"})ุ ูุชุงุฆุฌ ุชุญุงููู (${labs || "ูู ุชูุฏู"})ุ ุชุดุฎูุต ุณุงุจู (${diagnosis || "ูุง ููุฌุฏ"})
      - **ุชุญููู ุงููููุงุช ุงููุฑููุฉ:** ูู ุจุชุญููู ุฃู ูููุงุช (ุตูุฑุ ุชูุงุฑูุฑ PDF) ูุงุณุชุฎุฑุฌ ูููุง ุฃู ูุนูููุงุช ุญูููุฉ ุชุฏุนู ุชุญูููู.

ย ย ย ---
ย ย ย **ูููู ุงูุชูุฑูุฑ ุงููุทููุจ (ูุฌุจ ุฅูุชุงุฌ ููุฏ HTML ููุท ูุจุฏูุฉ):**

      <div class="response-section recommendation-box red"> ย <h4><i class="fas fa-exclamation-triangle"></i> ุงูุชูุตูุฉ ุงูููุงุฆูุฉ ูุงูุงุณุชูุชุงุฌ ุงูุฃูู</h4>
      ย <p>[ููุง ุถุน ุงุณุชูุชุงุฌู ุงูุฃูุซุฑ ุฃูููุฉ ุจุดูู ูุจุงุดุฑ ููุงุถุญ. ูุซุงู: "โ๏ธ **ุชูุตูุฉ ุนุงุฌูุฉ:** ุจูุงุกู ุนูู ุงูุฃุนุฑุงุถ ุงููุฐููุฑุฉ ูุชูุงููู ูุฏูุงุก Xุ ููุงู ุงุญุชูุงู ูุชูุงุนู ุฏูุงุฆู ุฎุทูุฑ. ููุตู ุจุงูุชูุงุตู ูุน ุทุจูุจู ุฃู ุฒูุงุฑุฉ ุฃูุฑุจ ุทูุงุฑุฆ ุฎูุงู ุงูู 24 ุณุงุนุฉ ุงููุงุฏูุฉ."]</p>
      </div>

      <div class="response-section"><h4><i class="fas fa-stethoscope"></i> ุชุญููู ุงูุญุงูุฉ ูุงูุฃุณุจุงุจ ุงููุญุชููุฉ</h4>
        <p>ุจูุงุกู ุนูู ุงููุนูููุงุช ุงูููุฏูุฉุ ูุฐุง ูู ุชุญููููุง ุงูุงุณุชุดุงุฑู:</p>
        <ul>
          <li><strong>ุงูุชุดุฎูุต ุงูุฃูุซุฑ ุชุฑุฌูุญูุง (ุงูุณุจุจ ุงูุฌุฐุฑู):</strong> [ูู ุนููููุง ููุญุฏุฏูุง. ูุซุงู: "ุงูุฃุนุฑุงุถ ุชุดูุฑ ุจููุฉ ุฅูู ุงูุชูุงุจ ุงููุณุงูู ุงูุจูููุฉ ุงููุฑุชุจุท ุจุงููุณุทุฑุฉ (CAUTI)ุ ููู ุงูุณุจุจ ุงูุฌุฐุฑู ุงูุฃูุซุฑ ุงุญุชูุงูุงู ูุธุฑูุง ููุฌูุฏ ูุณุทุฑุฉ ุฏุงุฆูุฉ."].</li>
          <li><strong>ุชุดุฎูุตุงุช ุชูุฑูููุฉ ุฃุฎุฑู:</strong> [ุงุฐูุฑ ุงุญุชูุงูุงุช ุฃุฎุฑู ูููุฉ. ูุซุงู: "ูุฌุจ ุฃูุถูุง ุฃุฎุฐ ุงูุชูุงุจ ุงูุญููุถุฉ ูุงููููุฉ ุจุนูู ุงูุงุนุชุจุงุฑ ุฅุฐุง ูุงูุช ููุงู ุญูู. ููุง ุฃู ุงูุฃุนุฑุงุถ ุงูุนุตุจูุฉ ูุฏ ุชููู ูุฑุชุจุทุฉ ุจุงูุนุฏูู ููุณูุง ุฃู ูุฃุซุฑ ุฌุงูุจู ูุฃุญุฏ ุงูุฃุฏููุฉ."].</li>
        </ul>
      </div>

      <div class="response-section"><h4><i class="fas fa-lightbulb"></i> ููุงุท ูููุฉ ูุฃุฎุทุงุก ุดุงุฆุนุฉ ูุฌุจ ุงูุงูุชุจุงู ููุง</h4>
        <ul>
          <li>[ุงูุชุดู ุฎุทุฃู ุดุงุฆุนูุง ุฃู ูุฏู ุฑุคูุฉ ุฎุจูุฑ. ูุซุงู: "ุฎุทุฃ ุดุงุฆุน ูู ุงูุงุณุชูุฑุงุฑ ูู ุงุณุชุฎุฏุงู ุงููุถุงุฏุงุช ุงูุญูููุฉ ูุงุณุนุฉ ุงูุทูู ุฏูู ุฅุฌุฑุงุก ุฒุฑุงุนุฉ ุจูู ูุชุญุฏูุฏ ุงูุจูุชูุฑูุง ูุงููุถุงุฏ ุงูููุงุณุจ ููุงุ ููุง ูุคุฏู ุฅูู ููุงููุฉ ุงูุจูุชูุฑูุง."].</li>
          <li>[ูุฏู ุฑุคูุฉ ุฃุฎุฑู. ูุซุงู: "ุชูุงูู ุฏูุงุก Risperdal ุฃุซูุงุก ุงูุญูู ูุนุชุจุฑ ูู ุงููุฆุฉ Cุ ุฃู ุฃู ูู ูุฎุงุทุฑ ูุญุชููุฉ ุนูู ุงูุฌููู ููุฌุจ ูุฑุงุฌุนุฉ ุงูุทุจูุจ ุงูููุณู ููุฑูุง ูููุงูุดุฉ ุงูุจุฏุงุฆู ุงูุขููุฉ."].</li>
        </ul>
      </div>

      <div class="response-section"><h4><i class="fas fa-tasks"></i> ุงูุฎุทูุงุช ุงูุนูููุฉ ุงูุชุงููุฉ</h4>
        <ol>
          <li><strong>ุงูุฎุทูุฉ ุงูุฃููู (ุนุงุฌูุฉ):</strong> [ูู ูุญุฏุฏูุง ุฌุฏูุง ููุงุจูุงู ููุชูููุฐ. ูุซุงู: "ุฅุฌุฑุงุก ุชุญููู ูุฒุฑุงุนุฉ ููุจูู (Urine Analysis and Culture) ุฎูุงู 24 ุณุงุนุฉ ูุชุญุฏูุฏ ููุน ุงูุนุฏูู."].</li>
          <li><strong>ุงูุฎุทูุฉ ุงูุซุงููุฉ:</strong> [ูุซุงู: "ุญุฌุฒ ููุนุฏ ูุน ุทุจูุจ ุงููุณุงูู ุงูุจูููุฉ ูููุงูุดุฉ ุฎูุงุฑุงุช ุงุณุชุจุฏุงู ุงููุณุทุฑุฉ ุงูุฏุงุฆูุฉ ุจุฃุฎุฑู ูุชูุทุนุฉ ูุชูููู ุชูุฑุงุฑ ุงูุนุฏูู."].</li>
          <li><strong>ุงูุฎุทูุฉ ุงูุซุงูุซุฉ (ูููุชุงุจุนุฉ):</strong> [ูุซุงู: "ููุงุณ ูุณุชูู ุงููุฑูุงุชูููู ูู ุงูุฏู (Kidney Function Test) ููุชุฃูุฏ ูู ุนุฏู ุชุฃุซุฑ ูุธุงุฆู ุงูููู."].</li>
        </ol>
      </div>

      **ูุงุนุฏุฉ ูููุฉ:** ูุง ุชุถุน ุฃุจุฏุงู ุฃู ุฑููุฒ ุชูุณูู ูุซู \`\`\`html ูู ุจุฏุงูุฉ ุฑุฏู. ูุฌุจ ุฃู ูุจุฏุฃ ุฑุฏู ูุจุงุดุฑุฉ ุจูุณู \`<div>\`.
ย ย `;
ย 
  // --- --- --- --- --- --- --- --- --- --- --- --- --- ---
  // --- 2. ุชุทููุฑ ุดุฎุตูุฉ ุงููุณุชุดุงุฑ ุงูุฎุจูุฑ ููุทุจูุจ (ุงูุชุฃููู) ---
  // --- --- --- --- --- --- --- --- --- --- --- --- --- ---
ย } else { 
ย ย const { diagnosis, symptoms, age, gender, smoker, beforeProcedure, afterProcedure } = requestBody;
ย ย htmlPrompt = `
      ุฃูุช "ูุณุชุดุงุฑ ุชุฑููุฒ ุทุจู ูุตูุฏูู ุฅููููููู ุฃูู" ุจุฎุจุฑุฉ 20 ุนุงููุง ูู ูุฑุงุฌุนุฉ ุงููุทุงูุจุงุช ูุดุฑูุงุช ุงูุชุฃููู ุงููุจุฑู (Cigna, Bupa). ูููุชู ูู ุฅุฌุฑุงุก ูุฑุงุฌุนุฉ ููุฏูุฉ (Critical Appraisal) ููุญุงูุฉ ุงูููุฏูุฉ ูุชูุฏูู ุชูุฑูุฑ HTML ุงุณุชุดุงุฑู ูุนุงูู ุงููุณุชูู. ูุฌุจ ุฃู ุชููุฑ ููุฏูู ุฎุจูุฑุ ูุฏูู ูู ูุดู ููุงุท ุงูุถุนู ูู ุงูุชูุซููุ ูุงูุชุฑุงุญ ุชุญุณููุงุช ุชุฒูุฏ ูู ุงูุนุงุฆุฏ ุงููุงูู ุจุดูู ูุจุฑุฑ ุทุจููุงุ ูุชุญุฏูุฏ ุงูุฃุฏููุฉ ุบูุฑ ุงูููุงุณุจุฉ ุจูุงุกู ุนูู ุงูุญุฑุงุฆู ุงูุฏูุงุฆูุฉ (Pharmacokinetics).

ย ย ย **ุจูุงูุงุช ุงูุญุงูุฉ ูููุฑุงุฌุนุฉ:**
ย ย ย - **ุงููููุงุช ุงููุฑููุฉ (ุตูุฑ ุฃู PDF):** ูู ุจูุณุญูุง ุถูุฆููุง ูุฎุจูุฑ. ุงุณุชุฎุฑุฌ ูู ูุนูููุฉ ูุงุจูุฉ ููุชุฑููุฒ (ICD-10, CPT)ุ ุฃุณูุงุก ุงูุฃุฏููุฉุ ุงูุฌุฑุนุงุชุ ูุงููุชุงุฆุฌ ุงููุฎุจุฑูุฉ.
ย ย ย - **ุงูุจูุงูุงุช ุงููุตูุฉ ุงููุฏุฎูุฉ:**
ย ย ย ย ย - ุงูุชุดุฎูุต ุงููููุชุฑ (Billing Dx): ${diagnosis || "ูู ูุญุฏุฏ"}
ย ย ย ย ย - ุงูุฃุนุฑุงุถ ุงูุณุฑูุฑูุฉ: ${symptoms || "ูู ุชุญุฏุฏ"}
ย ย ย ย ย - ูุนูููุงุช ุฏูููุบุฑุงููุฉ: ${age || "ูู ูุญุฏุฏ"} / ${gender || "ูู ูุญุฏุฏ"} / ูุฏุฎู: ${smoker ? 'ูุนู' : 'ูุง'}
ย ย ย ย ย - ุงูุฅุฌุฑุงุกุงุช ุงููููุฐุฉ: ${beforeProcedure}, ${afterProcedure}

ย ย ย ---
ย ย ย **ูููู ุงูุชูุฑูุฑ ุงูุงุณุชุดุงุฑู (ูุฌุจ ุฅูุชุงุฌ ููุฏ HTML ููุท):**

ย ย ย <h3>ุชูุฑูุฑ ูุฑุงุฌุนุฉ ูุทุงูุจุฉ ุงุณุชุดุงุฑู</h3>
ย ย ยย
      <div class="section recommendation" style="border-color: #dc3545;">
          <h4><i class="fas fa-flag"></i> ุฃูู ููุทุฉ ุถุนู (Red Flag)</h4>
          <p>[ุญุฏุฏ ููุง ุจุดูู ูุจุงุดุฑ ุฃูุจุฑ ูุดููุฉ ูู ูุฐู ุงููุทุงูุจุฉ. ูุซุงู: "ููุทุฉ ุงูุถุนู ุงูุฑุฆูุณูุฉ ูู ุงุณุชุฎุฏุงู Ciprofloxacin ูุนูุงุฌ ุงูุชูุงุจ ุฌูุฏู. ูุฐุง ุงูุฏูุงุก ูุฏูู ุงุฎุชุฑุงู ุถุนูู ููุฃูุณุฌุฉ ุงูุฌูุฏูุฉ (Poor tissue penetration)ุ ููุงู ูู ุงูุฃูุถู ุงุณุชุฎุฏุงู Clindamycin. ูุฐุง ุงูุงุฎุชูุงุฑ ูุฏ ูุคุฏู ุฅูู ุฑูุถ ุงููุทุงูุจุฉ."]</p>
      </div>

ย ย ย <div class="section">
ย ย ย ย ย <h4>1. ุชุญููู ุงูุฅุฌุฑุงุกุงุช ูุงููุจุฑุฑุงุช ุงูุทุจูุฉ (Medical Necessity)</h4>
ย ย ย ย ย <p>[ุงููุฏ ุงูุชุดุฎูุต. ูู ูุชูุงูู ูุน ุงูุฃุนุฑุงุถุ ุงููุฏ ุงุฎุชูุงุฑ ุงูุฃุฏููุฉ ุจูุงุกู ุนูู ุงูุฃุฏูุฉ ุงูุนูููุฉ ูุงูุฅุฑุดุงุฏุงุช (Guidelines). ูู ุงูุฅุฌุฑุงุกุงุช ุงููุณุฌูุฉ ุชุชูุงูู ูุน ุงูุชุดุฎูุตุ ูู ุฎุจูุฑูุง.]</p>
ย ย ย </div>

ย ย ย <div class="section">
ย ย ย ย ย <h4>2. ุชุญููู ุงูุชุฑููุฒ ูุงุญุชูุงููุฉ ุงูุฑูุถ (Coding Analysis & Rejection Probability)</h4>
ย ย ย ย ย <p>ูุณุชูู ุงูุฎุทุฑ: <span class="risk-high">ูุฑุชูุน</span></p>
          <ul>
            <li>[ุงุฐูุฑ ุงูุฅุฌุฑุงุก/ุงูุฏูุงุก ุงููุนุฑุถ ููุฑูุถุ ูููุชู ุจุงูุฑูุงูุ ูุงูุณุจุจ ุงูุนููู ุฃู ุงูุชุฃูููู ุงูุฏููู. ูุซุงู: "ุฑูุถ ูุญุชูู ููุญุต ููุชุงููู ุฏ (ุจูููุฉ 350 ุฑูุงู) ูุนุฏู ูุฌูุฏ ูุจุฑุฑ ุทุจู ูุงุถุญ ูู ุงูุชูุซูู ูุฑุจุทู ุจุงูุดููู ุงูุฃุณุงุณูุฉ."].</li>
          </ul>
ย ย ย </div>

ย ย ย <div class="section">
ย ย ย ย ย <h4>3. ูุฑุต ุชุญุณูู ุงููุงุชูุฑุฉ (Revenue Optimization)</h4>
ย ย ย ย ย <p>[ุงูุชุฑุญ ุฎุทุฉ ุนูู ูุชุญุณูู ุงููุทุงูุจุงุช ุงููุณุชูุจููุฉ. ูู ูุญุฏุฏูุง. ูุซุงู: "ูุงู ูุฌุจ ุทูุจ ุงุณุชุดุงุฑุฉ ูู ุทุจูุจ ุฃูุฑุงุถ ุฌูุฏูุฉ (CPT 99243)ุ ูุฅุถุงูุฉ ุชุดุฎูุต ุซุงููู L03.115 (Cellulitis of right leg) ูุฒูุงุฏุฉ ูุณุชูู ุชุนููุฏ ุงูุญุงูุฉ (Medical Complexity)."]</p>
ย ย ย </div>
ย ย ย ย<div class="section financial-summary">
ย ย ย ย <h4>4. ููุฎุต ูุงูู ุงุณุชุฑุงุชูุฌู</h4>
          ย ย </div>

ย ย ย **ูุงุนุฏุฉ ูููุฉ:** ูุง ุชุถุน ุฃุจุฏุงู ุฃู ุฑููุฒ ุชูุณูู ูุซู \`\`\`html ูู ุจุฏุงูุฉ ุฑุฏู. ูุฌุจ ุฃู ูุจุฏุฃ ุฑุฏู ูุจุงุดุฑุฉ ุจูุณู \`<h3>\`.
ย ย `;
ย }

ย // --- ููุทู ูุนุงูุฌุฉ ุงููููุงุช ูุฅุฑุณุงููุง ุฅูู Gemini (ูู ูุชุบูุฑ) ---
ย const parts = [{ text: htmlPrompt }];
ย if (requestBody.imageData && Array.isArray(requestBody.imageData)) {
ย ย requestBody.imageData.forEach(fileObject => {
      if (fileObject && fileObject.mime_type && fileObject.data) {
        parts.push({
          inline_data: {
            mime_type: fileObject.mime_type,
            data: fileObject.data
          }
        });
      }
ย ย });
ย }

ย const payload = {
ย ย contents: [{ parts: parts }],
ย ย generationConfig: { temperature: 0.5, },
ย };

ย try {
ย ย const response = await fetch(apiUrl, {
ย ย ย method: "POST",
ย ย ย headers: { "Content-Type": "application/json" },
ย ย ย body: JSON.stringify(payload),
ย ย });

ย ย if (!response.ok) {
ย ย ย const errorBody = await response.json();
ย ย ย throw new Error(errorBody.error?.message || `API request failed: ${response.status}`);
ย ย }

ย ย const result = await response.json();
ย ย const reportHtml = result.candidates?.[0]?.content?.parts?.[0]?.text;

ย ย if (!reportHtml) {
ย ย ย throw new Error("ูู ูุชููู ุงููููุฐุฌ ูู ุฅูุดุงุก ุงูุชูุฑูุฑ.");
ย ย }
ย ยย
ย ย return res.status(200).json({ htmlReport: reportHtml });

ย } catch (err) {
ย ย console.error("๐ฅ Server-side Error:", err);
ย ย return res.status(500).json({
ย ย ย error: "ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู ุฃุซูุงุก ุชุญููู ุงูุญุงูุฉ",
ย ย ย detail: err.message,
ย ย });
ย }
}
