import { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method === 'OPTIONS') {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    return res.status(405).json({ error: 'Method Not Allowed' });
  }

  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');

  const { diagnosis, symptoms, age, gender, beforeProcedure, afterProcedure } = req.body;

  if (!diagnosis || !symptoms || !age || !gender || !beforeProcedure || !afterProcedure) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  try {
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) throw new Error("OpenAI API key is not set.");

    const evaluateProcedureJustification = (procedure: string, patientAge: number, patientSymptoms: string[]) => {
      let justification = 'โ ูุจุฑุฑุฉ ููุฏุนููุฉ ุชุฃููููุงู';
      let risk = 'ููุฎูุถ';

      if (procedure.includes('ุณูุฑ ุนุดูุงุฆู')) {
        if (patientAge < 30 && !patientSymptoms.includes('ุนุทุด') && !patientSymptoms.includes('ุชุจูู') && !patientSymptoms.includes('ููุฏุงู ูุฒู')) {
          justification = 'โ๏ธ ูุจุฑุฑุฉ ูููู ุบูุฑ ูุฏุนููุฉ (ุบูุฑ ูุงูู ุจููุฑุฏู ุฏูู ุฃุนุฑุงุถ ุฏุงุนูุฉุ ูุฌุจ ุชูุซูู ุงูุฃุนุฑุงุถ ุฃู ุทูุจ HbA1c ูุงุญูุงู)';
          risk = 'ูุชูุณุท ุฅูู ูุฑุชูุน';
        }
      }

      return { justification, risk };
    };

    const proceduresWithEvaluations: any[] = [];

    if (beforeProcedure && Array.isArray(beforeProcedure)) {
      beforeProcedure.forEach((proc: string) => {
        const { justification, risk } = evaluateProcedureJustification(proc, age, symptoms);
        proceduresWithEvaluations.push({
          step: proc,
          justification: justification,
          rationale: `ุชูููู ูุจุฏุฆู ุจูุงุกู ุนูู ุงูุนูุฑ ูุงูุฃุนุฑุงุถ: ${risk}`
        });
      });
    }

    if (afterProcedure && Array.isArray(afterProcedure)) {
      afterProcedure.forEach((proc: string) => {
        const { justification, risk } = evaluateProcedureJustification(proc, age, symptoms);
        proceduresWithEvaluations.push({
          step: proc,
          justification: justification,
          rationale: `ุชูููู ูุจุฏุฆู ุจูุงุกู ุนูู ุงูุนูุฑ ูุงูุฃุนุฑุงุถ: ${risk}`
        });
      });
    }

    const prompt = `ุฃูุช ุงุณุชุดุงุฑู ุชุญูููุงุช ุทุจูุฉ ูุชุฃููููุฉุ ุฏูุฑู ูู ุชูููู ุงูุญุงูุฉ ุงูุชุงููุฉ ุจุนูู ุทุจู ููุงูู.

๐ ุงููุทููุจ ููู:
1. ุชุญููู ุดุงูู ููุฅุฌุฑุงุกุงุช ุงูููุชุฎุฐุฉ (ุฃุดุนุฉุ ูุญูุตุงุชุ ุฃุฏููุฉ) ูุจูุงู ูู ูู:
   โ ูุจุฑุฑุฉ ููุฏุนููุฉ ุชุฃููููุงู
   โ๏ธ ูุจุฑุฑุฉ ูููู ุบูุฑ ูุฏุนููุฉ
   โ ุบูุฑ ูุจุฑุฑุฉ ููุง ูุฏุนููุฉ
2. ุจูุงู ูุงุถุญ ููู ูุจุฑุฑ ุทุจูุงู ูุน ุงูุชุฑููุฒ ุนูู ุงูุชูุซูู ุงูุณุฑูุฑู ุงููุทููุจ ููุจููู ุชุฃููููุงูุ ููุฌุจ ุฃู ูุชู ุชูููู ุงูุฅุฌุฑุงุก ุจูุงุกู ุนูู ุนูุฑ ุงููุฑูุถ ูุงูุณูุงู:
  - ูู ุงูุฃุนูุงุฑ ุงูุตุบูุฑุฉ (ูุซูุงู: 20โ30 ุณูุฉ)ุ ูุง ููุนุชุฏ ุจุชุญููู ุณูุฑ ุนุดูุงุฆู ูููุฑุฏ (200) ุจุฏูู ุฃุนุฑุงุถ ุฏุงุนูุฉ.
  - ูุชู ุงูุฃุฎุฐ ุจุนูู ุงูุงุนุชุจุงุฑ ุงูุฃุนุฑุงุถ ุงููุฑุงููุฉ ูุซู ุงูุนุทุดุ ุงูุชุจูู ุงููุชูุฑุฑุ ููุฏุงู ุงููุฒู.
  - ุงูุฅุฌุฑุงุก ูุนุชุจุฑ ูุจุฑุฑ ููุท ุฅุฐุง ูุงู ูุฑุชุจุทุงู ูุนูุงู ุจุดููู ุงููุฑูุถ ุฃู ุถูู ุฎุทุฉ ุชูููู ูุชูุงููุฉ.
3. ุงููุดู ุนู ุงูุฅุฌุฑุงุกุงุช ุฃู ุงููุญูุตุงุช ุงูุทุจูุฉ ุงูููููุฏุฉ ูุงูุชู ูุงู ูู ุงูุฃูุถู ุนูููุง ุญุณุจ ุงูุชุฎุตุตุ ูุซู:
- ูู ุญุงูุงุช ุงูุจุงุทูุฉ: CBCุ ESRุ HbA1cุ ูุธุงุฆู ูููุ ุชุญููู ุจููุ ูุญุต ุงููุฏูุ ุชุฎุทูุท ููุจ.
- ูู ุฃูุฑุงุถ ุงูุนููู: OCTุ ููุงุณ ุถุบุท ุงูุนููุ ุชุตููุฑ ุงูุดุจููุฉุ ุงุฎุชุจุงุฑ ุดูุฑูุฑุ ุงููุตุจุงุญ ุงูุดููุ ููุงุณ ุงููุธุฑุ ูุญุต ูุงุน ุงูุนููุ ูุงุฎุชุจุงุฑุงุช ูุชุงุจุนุฉ ุงูุดุจููุฉ ูู ุญุงูุฉ ูุฑุถู ุงูุณูุฑูุ ููููุตุญ ุจุฐูุฑ ุถุบุท ุงูุนูู ููุญุต ุงููุธุฑ ุนูุฏ ูุฌูุฏ ุฃุนุฑุงุถ ุจุตุฑูุฉ ูุซู ุบุจุงุด ุฃู ุฃูู.
- ูู ุงููุณุงุก ูุงูููุงุฏุฉ: ุณููุงุฑุ ุชุญููู ูุฑูููุงุชุ ูุญุต ููุจููุ ูุญุต ุนูู ุงูุฑุญู.
- ูู ุทุจ ุงูุฃุณูุงู: ุฃุดุนุฉ ุจุงููุฑุงููุฉุ ูุญุต ุฌููุจ ูุซููุฉุ ุชูููู ุชุณูุณุ ุนูุงุฌ ุฌุฐูุฑ.
- ูู ุงูุนุธุงู: ุฃุดุนุฉ Xุ ุชุตููุฑ ุฑูููุ ุชูููู ูุฏู ุงูุญุฑูุฉุ ูุญุต ูุซุงูุฉ ุงูุนุธู.
- ูู ุงูุทุจ ุงูุนุงู: ุชุญููู ุฏู ุดุงููุ ุชูููู ุนูุงูุงุช ุญูููุฉุ ูุญูุตุงุช ุฑูุชูููุฉ ุจูุงุก ุนูู ุงูุดููู.
4. ุชูุฏูู ุชูุตูุงุช ูุชุญุณูู ุงูุฅูุฑุงุฏ ูู ููุณ ุงูุญุงูุฉ ุจุทุฑููุฉ ูุดุฑูุนุฉ ููุบุทุงุฉุ ููุฌุจ ุชูุถูุญ ุงูุฅุฌุฑุงุกุงุช ุงูุชู ูุงู ูู ุงููููู ุงูููุงู ุจูุง ููู ุชููุซูุ ูุซู:
- ูู ุงุฑุชูุงุน ุงูุถุบุท: ูุฌุจ ุฏุงุฆููุง ุฏุนู ุตุฑู ุนูุงุฌ ุงูุถุบุท ุจููุงุณ ูุนูู ููุซู ููุถุบุท.
- ูู ูุตู ุงููุถุงุฏุงุช ุงูุญูููุฉ: ููุดุชุฑุท ูุฌูุฏ ุญุฑุงุฑุฉุ ูุญุต ุณุฑูุฑู ุฅูุฌุงุจูุ ุฃู ุชุญููู ุฏู ูุฏุนู ูุฌูุฏ ุนุฏูู ูุซู WBC ูุฑุชูุน ุฃู CRP.

๐งพ ุตูุบุฉ ุงูุฅุฎุฑุงุฌ ุงููุทููุจุฉ (JSON ููุท):
- result: ููุฎุต ุทุจู ูุงุถุญ ููุญุงูุฉ
- justification: ุชุญููู ุจูุฏู ููุฅุฌุฑุงุกุงุช ุงููุชุฎุฐุฉ (ูุตูููุฉ: [{ step, justification, rationale }])
- rejectionRisk: (ููุฎูุถ / ูุชูุณุท / ูุฑุชูุน)
- rejectionReason: ุณุจุจ ุงูุฑูุถ ุงููุญุชูู ุฅู ููุฌุฏ
- rejectedValue: ูุจูุบ ูุนุฑุถ ููุฑูุถ ุฅู ููุฌุฏ
- improvementSuggestions: ูุตูููุฉ JSON ุญููููุฉ ููุท ุจุฏูู ุฃู ุดุฑุญ ูุตู ุฃู ุชูุณูู Markdownุ ูุฌุจ ุฃู ุชููู ุนูู ูุฐุง ุงูุดูู:
  [
    {
      "title": "ุชุญููู ุงูุณูุฑ ุงูุชุฑุงููู HbA1c",
      "description": "ููุนุฑูุฉ ูุฏู ุงูุณูุทุฑุฉ ุนูู ุงูุณูุฑู ุฎูุงู ุงูุซูุงุซุฉ ุฃุดูุฑ ุงููุงุถูุฉ.",
      "estimatedValue": "150",
      "whyNotRejectable": "ุถุฑูุฑู ููุบุทู ุชุฃููููุงู ูุฌููุน ูุฑุถู ุงูุณูุฑู."
    },
    {
      "title": "ุชุญููู ูุธุงุฆู ุงูููู",
      "description": "ูููุดู ุนู ุฃุซุฑ ุงูุณูุฑู ุนูู ุงูููู.",
      "estimatedValue": "200",
      "whyNotRejectable": "ูุบุทู ุชุฃููููุงู ุนูุฏ ูุฌูุฏ ุณูุฑู ูุฒูู."
    }
  ]
- potentialRevenueIncrease: ุนุจุงุฑุฉ ููุธูุฉ ุชูุถุญ ุฅุฌูุงูู ุงูุฒูุงุฏุฉ ุงูููููุฉ ูุน ุฏูุฌ ุฃุณูุงุก ุงูุฅุฌุฑุงุกุงุช ุงูููุชุฑุญุฉ ูุชุฃุซูุฑูุง ุงููุงูู ูุงูุชุฃูููู.

๐ ุจูุงุกู ุนูู ุชุญููู ุนุฏุฉ ุญุงูุงุช ูุดุงุจูุฉุ ูุฌุจ ุฅุนุทุงุก ุชูุตูุงุช ุงุณุชุฑุงุชูุฌูุฉ ููุทุจูุจ ุชูุถุญ:
- ุงูุฃุฎุทุงุก ุงููุชูุฑุฑุฉ ุงูุชู ุชุคุฏู ุฅูู ุฑูุถ ุงูุชุฃูููุ ูุซู ุตุฑู ุฃุฏููุฉ ุฏูู ููุงุณ ุฃู ุชุดุฎูุต ุฏุงุนู.
- ุนุฏู ุชูุซูู ูุชุงุฆุฌ ูุญูุตุงุช ูููุฉ ูุซู ููุงุณ ุงูุถุบุทุ ุฃู ูุฌูุฏ ุญุฑุงุฑุฉุ ุฃู ูุชุงุฆุฌ ุงููุฎุชุจุฑ.
- ุฃูููุฉ ุงูุชูุฑูู ุจูู ูุง ูู ูุจุฑุฑ ุทุจููุง ููุง ูู ูุจุฑุฑ ุชุฃูููููุง.
- ุถุฑูุฑุฉ ุฏูุฌ ุงูุฃุนุฑุงุถุ ุงููุชุงุฆุฌุ ูุงููุญูุตุงุช ุงูุชุดุฎูุตูุฉ ูู ูุฑุงุฑ ูู ุฅุฌุฑุงุก.
- ุฃูู ุงูุฅุฌุฑุงุกุงุช ุงูุชู ูููุตุญ ุจูุง ูุชูููู ุบุงูุจูุงุ ุฎุงุตุฉ OCTุ ููุงุณ ุถุบุท ุงูุนููุ ุงุฎุชุจุงุฑ ุดูุฑูุฑุ ูุญุต ูุธุฑุ CBC ูู ุญุงูุงุช ุงูุนุฏููุ ููุฒุฑุนุฉ ุจูู ุนูุฏ ูุฌูุฏ ุฃุนุฑุงุถ ุจูููุฉ.
- ููุชุฑุญ ูุชุญุณูู ุฃุณููุจ ุงูุชูุซูู: ุฑุจุท ูุจุงุดุฑ ุจูู ูู ุฏูุงุก ุฃู ูุญุต ูุณุจุจ ุตุฑููุ ูุน ุชูุซูู ุงููุชูุฌุฉ ุฃู ุงูุนุฑุถ ุงููุคูุฏุ ูุซู: โุฃูู ูู ุงูุนูู + ุงูุฎูุงุถ ุฑุคูุฉ + ุดุจููุฉ ุทุจูุนูุฉ = ูุง ุญุงุฌุฉ ูู ูุถุงุฏ ุญููู ุฏูู ุนุฏูู ูุซุจุชุฉ.โ

๐ฌ ุจูุงูุงุช ุงูุญุงูุฉ:
- ุงูุชุดุฎูุต: ${diagnosis}
- ุงูุฃุนุฑุงุถ: ${symptoms}
- ุงูุนูุฑ: ${age}
- ุงูุฌูุณ: ${gender === 'male' ? 'ุฐูุฑ' : gender === 'female' ? 'ุฃูุซู' : 'ุบูุฑ ูุญุฏุฏ'}
- ุงูุฅุฌุฑุงุกุงุช ุงูุชุญููููุฉ (ุฃุดุนุฉ ูุชุญุงููู) ูุจู ุงูุชุดุฎูุต: ${beforeProcedure}
- ุงูุฅุฌุฑุงุกุงุช ุงูุนูุงุฌูุฉ ูุงูููุงุฆูุฉ ุจุนุฏ ุงูุชุดุฎูุต: ${afterProcedure}
`;

    const completion = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "gpt-4o",
        messages: [{ role: "user", content: prompt }],
        max_tokens: 1400
      })
    });

    const data = await completion.json();
    const raw = data.choices?.[0]?.message?.content;

    let result;
    try {
      const cleaned = raw
        .replace(/^json\s*/i, '')
        .replace(/^```json\s*/i, '')
        .replace(/```$/, '')
        .trim();
      result = JSON.parse(cleaned);
    } catch (parseError) {
      console.error("Failed to parse GPT response:", parseError);
      result = { result: raw, error: "Failed to parse GPT response as JSON." };
    }

    res.status(200).json(result);
  } catch (err: any) {
    console.error("GPT API Error:", err);
    res.status(500).json({ error: "GPT API Error: " + err.message });
  }
}
