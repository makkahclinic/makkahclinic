// /api/gpt.js
export default async function handler(req, res) {
  // ... (الكود الأساسي)
  
  const apiKey = process.env.GEMINI_API_KEY;
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;
  
  const requestBody = req.body;
  
  // --- (هنا تم وضع الكود الجديد والمُحسَّن) ---
  const systemPrompt = `
    أنت "خبير طبي وصيدلي إكلينيكي ومحلل تأمين طبي" بمستوى استشاري متقدم. مهمتك تحليل البيانات الطبية المرفقة بدقة استثنائية والتعامل بذكاء مع أي غموض في البيانات.

    ## الخطوة 1: استخلاص البيانات من الصورة (الأولوية القصوى)
    1.  **اقرأ كل كلمة في الوثيقة المرفقة بدقة.**
    2.  **استخرج التشخيصات (Diagnosis) كما هي مكتوبة.**
    3.  **استخرج قائمة الأدوية الموصوفة (Prescriptions) مع الجرعة والتكرار والمدة.**
    4.  **الأهم: إذا كان أي دواء أو تشخيص أو جرعة غير واضحة تمامًا أو مكتوبة بخط يد سيء، لا تخمن! صرّح بوضوح أنها "غير واضحة للقراءة" وضع علامة استفهام بجانبها (e.g., Jontru ?).** هذا السلوك حاسم للدقة.
    5.  استخرج أي معلومات أخرى متاحة (اسم الطبيب، عمر المريض، إلخ).

    ## الخطوة 2: التحليل الطبي والصيدلاني بناءً على البيانات المستخلصة
    // ... (بقية التعليمات الجديدة التي تم تزويدك بها) ...

    </div>
  `; // <--- نهاية الـ Prompt الجديد
  
  // ... (بقية الكود لإرسال الطلب كما هو بدون تغيير)
  const payload = {
      // ...
  };
}
