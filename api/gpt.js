// api/gpt.js
import Tesseract from "tesseract.js";
export default async function handler(req, res) {
  // Set CORS headers
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

  if (req.method === "OPTIONS") return res.status(200).end();
  if (req.method !== "POST") return res.status(405).json({ error: "Method Not Allowed" });

  const apiKey = process.env.GEMINI_API_KEY;
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;
  
  let htmlPrompt;
  const requestBody = req.body;

  // --- ูุธุงู ูุชูุฏู ููุนุงูุฌุฉ ูุซุงุฆู ุงูุฃุทุจุงุก ---
  if (requestBody.analysisType === 'doctor') {
    // ูุธุงู ูุชูุงูู ูุชุญููู ุงููุซุงุฆู ุงูุทุจูุฉ ููุนุงูุฌุฉ ุฃุฎุทุงุก OCR
    htmlPrompt = `
      ุฃูุช "ุงููุธุงู ุงูุทุจู ุงููุชูุงูู" - ูุญุฑู ุฐูุงุก ุงุตุทูุงุนู ูุฌูุน ุฎุจุฑุงุช:
      [ุงุณุชุดุงุฑู ุจุงุทูุฉุ ุตูุฏูู ุฅูููููููุ ูุญูู ุชุฃููู ุทุจูุ ุฎุจูุฑ ูุนุงูุฌุฉ ูุซุงุฆู ุทุจูุฉ]

      ## ุงูุชุนูููุงุช ุงูุตุงุฑูุฉ:
      1. **ูุนุงูุฌุฉ ุฃุฎุทุงุก OCR ุงููุชูุฏูุฉ**:
         - ุงุณุชุฎุฏุงู ุฎูุงุฑุฒููุฉ ุชุตุญูุญ ุซูุงุซูุฉ ุงููุณุชููุงุช:
           โข ุงูุชุดุงุจู ุงูุตูุชู (Phonetic)
           โข ุงูุชุดุงุจู ุงูุจุตุฑู (Visual)
           โข ุชุญููู ุงูุณูุงู ุงูุทุจู
         - ูุงุฆูุฉ ุชุตุญูุญ ุชููุงุฆูุฉ:
           "ุณููุบุงุณูุงููู" โ "ุณูููุงุณุชุงุชูู"
           "ุฃูุตูุฑุงุฒูู" โ "ุฃูููุจุฑุงุฒูู"
           "ููู" โ "ููุบ"
           "ุซูุซุงู" โ "ุชููุงู"
           "ุจููู ุชูุฑูู" โ "ููุฒู ุชูุฏูู"

      2. **ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุงูุฏูุงุฆูุฉ**:
         - ุงุณุชุฎุฑุงุฌ ููุท ุงูุฃุฏููุฉ ุงููุฐููุฑุฉ ุตุฑุงุญุฉ
         - ุนุฏู ุงูุชุฑุงุถ ุฃู ุฃุฏููุฉ ุบูุฑ ููุฌูุฏุฉ
         - ููู ุฏูุงุก: ุงูุชุญูู ูู:
           โข ุงูุงุณู (ูุทุงุจูุฉ ูุน ูุงุนุฏุฉ ุงูุฃุฏููุฉ)
           โข ุงูุฌุฑุนุฉ (ุฑูู + ูุญุฏุฉ ุตุงูุญุฉ)
           โข ุงูุชูุฑุงุฑ (ููููุงูุ ุฃุณุจูุนูุงู...)

      3. **ูุธุงู ุงูุชุญูู ุงูุฑุจุงุนู**:
         ุฃ. ุงููุทุงุจูุฉ ูุน ูุงุนุฏุฉ ุงูุฃุฏููุฉ ุงููุนุชูุฏุฉ
         ุจ. ุงูุชุญูู ูู ุตุญุฉ ุงูุฌุฑุนุฉ
         ุฌ. ุงูุชุญูู ูู ูุญุฏุงุช ุงูููุงุณ
         ุฏ. ุงูุชุญูู ูู ุงูุณูุงู ุงูุทุจู

      4. **ุงูุชูุฑูุฑ ุงูุฅูุฒุงูู**:
         ### ุฌุฏูู ุชุตุญูุญ ุงูุฃุฎุทุงุก:
         | ุงููุต ุงูุฃุตูู     | ุงููุต ุงููุตุญุญ     | ุญุงูุฉ ุงูุชุญูู | ุงูุณุจุจ |
         |-----------------|-----------------|-------------|--------|
         [ูุชู ุชุนุจุฆุฉ ูุฐุง ุงูุฌุฏูู ุชููุงุฆูุงู]

         ### ุงูุฃุฏููุฉ ุงููุคูุฏุฉ:
         | ุงูุฏูุงุก         | ุงูุฌุฑุนุฉ       | ุงูุญุงูุฉ       |
         |----------------|--------------|--------------|
         [ูุชู ุชุนุจุฆุฉ ูุฐุง ุงูุฌุฏูู ุชููุงุฆูุงู]

      5. **ุงูุชุญููู ุงูุทุจู ุงููุชูุงูู**:
         - ููู ุฏูุงุก ูุคูุฏ:
           โข ุชูููู ุทุจู ุดุงูู
           โข ุชูููู ุตูุฏูุงูู
           โข ุชูููู ุชุฃูููู
         - ุชุญููู ุงูุฅุฌุฑุงุกุงุช ุงูุทุจูุฉ
         - ุชูููู ุงููุฎุงุทุฑ ุงููุงููุฉ

      ## ูุซุงู ุชุทุจููู:
      ุงููุต ุงููุฏุฎู: "ุณููุบุงุณูุงููู 80 ููู ููููุงู"
      ุงููุนุงูุฌุฉ:
        1. ุงูุชุตุญูุญ: "ุณูููุงุณุชุงุชูู 80 ููุบ ููููุงู"
        2. ุงูุชุญูู: โ (ุฏูุงุก ูุนุฑููุ ุฌุฑุนุฉ ุตุงูุญุฉ)
        3. ุงูุชุญููู: 
           - โ ุฌุฑุนุฉ ุนุงููุฉ ุฎุทูุฑุฉ
           - โ๏ธ ุฎุทุฑ ุชูู ุงูุนุถูุงุช
           - ๐ฐ ูุฑููุถ ุชุฃููููุงู

      ## ููุงุนุฏ ุญุงุณูุฉ:
      - ุนุฏู ุฐูุฑ ุฃู ุฏูุงุก ุบูุฑ ููุฌูุฏ ูู ุงููุซููุฉ
      - ุนุฏู ุงูุงูุชุฑุงุถ ุฃู ุงูุงุณุชูุชุงุฌ
      - ุงูุฅุจูุงุบ ุนู ุงูุจูุงูุงุช ุบูุฑ ุงููุงุถุญุฉ
    `;
  } 
  // --- ูุธุงู ูุชูุฏู ูุชุญููู ุจูุงูุงุช ุงููุฑุถู ---
  else if (requestBody.analysisType === 'patient') {
    const { symptoms, age, gender, smoker, vitals, labs, diagnosis, currentMedications } = requestBody;
    htmlPrompt = `
      ุฃูุช "ุงููุณุงุนุฏ ุงูุตุญู ุงูุฐูู" - ูุธุงู ุฏุนู ูุฑุงุฑุงุช ุทุจูุฉ ูุชูุฏู ูููุฑุถู

      ## ุงูุชุนูููุงุช:
      1. ุงูุชุญููู ุงูุดุงูู ููุฃุนุฑุงุถ
      2. ุชูุฏูู ุชูุตูุงุช ูุจููุฉ ุนูู ุงูุฃุฏูุฉ
      3. ุฅูุดุงุก ุฎุทุฉ ูุชุงุจุนุฉ ุดุฎุตูุฉ

      ... [ูุธุงู ุชุญููู ุงููุฑุถู ุงูุญุงูู ูุน ุชุญุณููุงุช] ...
    `;
  }

  // ูุธุงู ูุนุงูุฌุฉ ุงูุตูุฑ ุงููุชูุฏู
  let extractedText = '';
if (requestBody.imageData && Array.isArray(requestBody.imageData)) {
  for (const base64Image of requestBody.imageData) {
    const buffer = Buffer.from(base64Image, "base64");
    const { data: { text } } = await Tesseract.recognize(buffer, 'ara');
    extractedText += '\n' + text;
  }
}
  console.log("๐ท ุงููุต ุงููุณุชุฎุฑุฌ ูู ุงูุตูุฑุฉ:\n", extractedText);
  const parts = [{ text: htmlPrompt }];
if (extractedText) {
  parts.push({ text: extractedText });
}
  const payload = {
    contents: [{ parts: parts }],
    generationConfig: {
      temperature: 0.2,  // ุฏูุฉ ุนุงููุฉ
      topK: 10,
      maxOutputTokens: 5000
    },
    safetySettings: [
      { category: "HARM_CATEGORY_MEDICAL", threshold: "BLOCK_NONE" },
      { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }
    ]
  };

  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      const errorBody = await response.json();
      throw new Error(errorBody.error?.message || `ูุดู ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู: ${response.statusText}`);
    }

    const result = await response.json();
    let reportHtml = result.candidates?.[0]?.content?.parts?.[0]?.text;

    // ุงูุชุญูู ุงูููุงุฆู ูููุน ุงููููุณุฉ
    const extractedMeds = extractMedications(extractedText || "");
if (reportHtml.includes("ุณูููุงุณุชุงุชูู") && !extractedMeds.includes("ุณูููุงุณุชุงุชูู")) {
  return res.status(200).json({
    htmlReport: `
      <div class="error-alert">
        <h3>โ๏ธ ุชุญุฐูุฑ: ุจูุงูุงุช ุบูุฑ ูุงููุฉ</h3>
        <p>ูู ูุชู ุงูุนุซูุฑ ุนูู ุฏูุงุก "ุณูููุงุณุชุงุชูู" ูู ุงููุซููุฉ ุงูููุฏูุฉ</p>
        <ul>
          <li>ุงูุณุจุจ ุงููุญุชูู: ุฌูุฏุฉ ุตูุฑุฉ ููุฎูุถุฉ ุฃู ุฎุท ุบูุฑ ูุงุถุญ</li>
          <li>ุงูุชูุตูุฉ: ุฅุนุงุฏุฉ ุฑูุน ุตูุฑุฉ ุฃูุถุญ</li>
          <li>ุงูุฃุฏููุฉ ุงูููุชุดูุฉ: ${extractedMeds.join(', ') || 'ูุง ุดูุก'}</li>
        </ul>
      </div>
    `
  });
}
          <p>ูู ูุชู ุงูุนุซูุฑ ุนูู ุฏูุงุก "ุณูููุงุณุชุงุชูู" ูู ุงููุซููุฉ ุงูููุฏูุฉ</p>
          <ul>
            <li>ุงูุณุจุจ ุงููุญุชูู: ุฌูุฏุฉ ุตูุฑุฉ ููุฎูุถุฉ ุฃู ุฎุท ุบูุฑ ูุงุถุญ</li>
            <li>ุงูุชูุตูุฉ: ุฅุนุงุฏุฉ ุฑูุน ุตูุฑุฉ ุฃูุถุญ</li>
            <li>ุงูุฃุฏููุฉ ุงูููุชุดูุฉ: ${extractedMeds.join(', ') || 'ูุง ุดูุก'}</li>
          </ul>
        </div>
      `;
    }

    return res.status(200).json({ htmlReport: reportHtml });

  } catch (err) {
    console.error("๐ฅ ุฎุทุฃ ูู ุงูุฎุงุฏู:", err);
    return res.status(500).json({
      error: "ูุดู ูู ุชุญููู ุงููุซููุฉ ุงูุทุจูุฉ",
      detail: err.message,
      solution: "ุงูุฑุฌุงุก ุงูุชุญูู ูู ุฌูุฏุฉ ุงูุตูุฑุฉ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ"
    });
  }
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุงุณุชุฎุฑุงุฌ ุงูุฃุฏููุฉ
function extractMedications(text) {
  const drugPatterns = [
    /(ุณูููุงุณุชุงุชูู|ุฃุชูุฑูุงุณุชุงุชูู|ุฑูุฒููุงุณุชุงุชูู)/gi,
    /(ุฃูููุจุฑุงุฒูู|ูุงูุณูุจุฑุงุฒูู|ุจุงูุชูุจุฑุงุฒูู)/gi,
    /(ููุชููุฑููู|ุฃูุณูููู|ุบููุจูููุงููุฏ)/gi
  ];
  
  const medications = new Set();
  
  drugPatterns.forEach(pattern => {
    const matches = text.match(pattern);
    if (matches) {
      matches.forEach(match => medications.add(match));
    }
  });
  
  return Array.from(medications);
}
