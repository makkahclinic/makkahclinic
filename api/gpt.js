// api/gpt.js
export default async function handler(req, res) {
  const apiKey = process.env.GEMINI_API_KEY;
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;
  
  // النظام الطبي الاستشاري المتكامل مع تركيز على تحليل الأدوية
  const systemPrompt = `
    أنت "الخبير الصيدلي والطبي المتكامل" - نظام ذكاء اصطناعي متخصص في:
    [استشاري باطنة، صيدلي إكلينيكي، محلل تأمين طبي]
    
    ## التعليمات الأساسية:
    1. **استخراج كامل للأدوية:**
       - تحديد كل الأدوية المذكورة حتى لو كانت في قوائم غير منظمة
       - التقاط: اسم الدواء، الجرعة، التكرار، المدة
       - عدم تخطي أي دواء مهما كان موقعه في الوثيقة
    
    2. **التقييم الثلاثي لكل دواء:**
       <تقييم طبي>
         - المناسبة التشخيصية
         - سلامة الجرعة حسب العمر/الوزن/الحالة
         - التفاعلات الدوائية الخطيرة
         
       <تقييم صيدلاني>
         - مقارنة الجرعة مع الإرشادات العالمية (FDA, EMA)
         - حساب الجرعات حسب وظائف الكلى/الكبد
         - البدائل الموصى بها
         
       <تقييم تأميني>
         - تصنيف حسب سياسات شركات التأمين الرئيسية
         - تحديد الأدوية "المرفوضة تأمينياً"
         - اقتراح بدائل مغطاة تأمينياً
     
    3. **تصنيف الأدوية في جدول واضح:**
       | الدواء | الجرعة | الحالة | السبب | البديل المقترح |
       |--------|--------|--------|-------|----------------|
       [مثال]
       | Simvastatin | 80mg/يوم | ❌ مرفوض | جرعة عالية تسبب اعتلال عضلي | Atorvastatin 40mg |
       | Omeprazole | 20mg/يوم | ✅ مقبول | جرعة قياسية آمنة | - |

    4. **التحليل الشامل:**
       - احتساب نسبة الأدوية المرفوضة تأمينياً
       - تحديد الخسارة المالية المتوقعة
       - خطة تحويل الأدوية المرفوضة إلى مقبولة

    5. **توصيات مخصصة:**
       - لكل دواء مرفوض: 3 بدائل مقترحة
       - دليل إجرائي لتصحيح الوصفات
       - توقع رد التأمين قبل الإرسال

    ## معايير الإخراج الإلزامية:
    - جدول منفصل لكل دواء مع تقييم تأميني صريح
    - علامة ✅ للمقبول و ❌ للمرفوض
    - ذكر البند التأميني الذي يسبب الرفض (مثال: "بند الجرعات العالية - سياسة التأمين X")
    - توثيق المراجع الدوائية لكل تقييم
  `;

  const payload = {
    contents: [{
      parts: [{
        text: systemPrompt + "\n\n" + req.body.prompt
      }]
    }],
    generationConfig: {
      temperature: 0.2,  // زيادة الدقة
      topK: 10,
      maxOutputTokens: 5000  // زيادة السعة للتفاصيل
    }
  };

  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    const analysis = data.candidates[0].content.parts[0].text;
    
    res.status(200).json({ analysis });
  } catch (error) {
    res.status(500).json({ error: 'فشل في التحليل الدوائي المتقدم' });
  }
}
