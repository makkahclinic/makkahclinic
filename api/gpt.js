// /api/gpt.js

export default async function handler(req, res) {
    // ... (The top part of the code remains the same)
    res.setHeader("Access-Control-Allow-Origin", "*");
    res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
    res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

    if (req.method === "OPTIONS") return res.status(200).end();
    if (req.method !== "POST") return res.status(405).json({ error: "Method Not Allowed" });

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
        console.error("๐ฅ Server-side Error: GEMINI_API_KEY is not set.");
        return res.status(500).json({
            error: "ุฎุทุฃ ูู ุฅุนุฏุงุฏุงุช ุงูุฎุงุฏู",
            detail: "ููุชุงุญ ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (API Key) ุบูุฑ ููุฌูุฏ.",
        });
    }
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;
    
    let htmlPrompt;
    const requestBody = req.body;

    if (requestBody.analysisType === 'patient') {
        // --- PATIENT PORTAL PROMPT (No changes here) ---
        // ... (The patient prompt remains the same as before)

    } else {
        // --- ๐ FINAL & STRICT EXPERT AUDITOR PROMPT V3 ---
        const { diagnosis, symptoms, age, gender, smoker, beforeProcedure, afterProcedure } = requestBody;
        htmlPrompt = `
        **ุดุฎุตูุชู ุงูุฃุณุงุณูุฉ:** ุฃูุช "ุฎุจูุฑ ุงุณุชุดุงุฑู ุฃุนูู ูู ุงููุฑุงุฌุนุฉ ุงูุทุจูุฉ ูุงูุชุฃููู ุงูุทุจู (Senior Certified Medical Reimbursement Specialist)". ููุฏูู ูุฏุฑุฉ ูุงุฆูุฉ ุนูู ูุฑุงุกุฉ ูุชุญููู ุงููุตูุงุช ุงูุทุจูุฉ ุงูููุชูุจุฉ ุจุฎุท ุงููุฏ ูููุง ูุงูุช ูุนูุฏุฉ. ุฎุจุฑุชู ูุจููุฉ ุนูู ุจุฑูุชููููุงุช ุงูุนูุงุฌ ุงูุนุงูููุฉ (UpToDate, NICE, American Diabetes Association) ูุณูุงุณุงุช ุดุฑูุงุช ุงูุชุฃููู ูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ (ูุซู ุจูุจุงุ ุงูุชุนุงูููุฉ).

        **ูููุชู:** ุชุญููู ุงูุญุงูุฉ ุงูุทุจูุฉ ุงููุฑููุฉ (ูุตูุง ูุตูุฑูุง) ูุชูุฏูู ุชูุฑูุฑ ุชุฏููู ุทุจู ุดุงูู ูุง ููุจู ุงูุฌุฏูุ ุจุตูุบุฉ HTML.

        // ๐-- ููุงุนุฏ ุตุงุฑูุฉ ูุฌุจ ุงุชุจุงุนูุง ุญุฑูููุง --๐

        1.  **ูุงุนุฏุฉ ุงูุชุญููู ุงูุดุงูู:** **ูุง ุชุชุฌุงูู ุฃู ุฏูุงุก ุฃู ุชุดุฎูุต ููุชูุจุ ุญุชู ูู ูุงู ุบูุฑ ูุงุถุญ.** ูู ุจุชุญููู ูู ุฏูุงุก ูู ุตู ูููุตู ุชูุงููุง ูู ุงูุฌุฏูู. ุฅุฐุง ูุงู ุฎุท ุงููุฏ ุบูุฑ ูุงุถุญุ ุงุจุฐู ุฃูุตู ุฌูุฏู ูุชุฎููู ุงูุฏูุงุก ูู ุณูุงู ุงูุชุดุฎูุตุงุช ุงูุฃุฎุฑู (ูุซูุงูุ ุฅุฐุง ุฑุฃูุช ุชุดุฎูุต ุงูุณูุฑูุ ููู ุงููุฑุฌุญ ุฃู ุงูุฏูุงุก ุบูุฑ ุงููุงุถุญ ูู ุฏูุงุก ุณูุฑู).
        2.  **ูุงุนุฏุฉ ุงูุฃููุงู ุงูุฅูุฒุงููุฉ:** ุฃูุช **ููุฒู** ุจุงุณุชุฎุฏุงู ุงูุฃุตูุงู ุงูููููุฉ (`class="risk-red"`, `class="risk-yellow"`, `class="risk-green"`) ูู ูุณูู `<tr>` ุงูุฎุงุตุฉ ุจุงูุฌุฏูู ุงูุฃูู. **ูุง ุชุชุฑู ุฃู ุตู ุจุฏูู ุตูู ูููู.**
            -   **risk-red**: ููุฃุฎุทุงุก ุงูุทุจูุฉ ุงููุงุถุญุฉุ ุฃู ุงูุฅุฌุฑุงุกุงุช ุงููุฑููุถุฉ ุชุฃูููููุง ุจูุณุจุฉ 100%.
            -   **risk-yellow**: ููุฅุฌุฑุงุกุงุช ุงูุชู ุชุญุชุงุฌ ุชุจุฑูุฑูุง ููููุง ุฌุฏูุง ุฃู ุชุนุชุจุฑ ุฎุงุฑุฌ ุงูุจุฑูุชูููู ุงููุนุชุงุฏ.
            -   **risk-green**: ููุฅุฌุฑุงุกุงุช ุงูุณูููุฉ ูุงููุชูุงููุฉ ุชูุงููุง ูุน ุงูุจุฑูุชููููุงุช.
        3.  **ูุงุนุฏุฉ ุญู ุงูุชูุงูุถุงุช:** ุฅุฐุง ูุฌุฏุช ุชูุงูุถูุง ุตุงุฑุฎูุง ุจูู ุงูุจูุงูุงุช (ูุซูุงูุ ุชุดุฎูุตุงุช ูุฃูุฑุงุถ ูุจุงุฑ ุงูุณู ูุซู BPH ููุฑูุถ ููุฏูุนู ุฃูู ุทูู)ุ ูุฌุจ ุนููู ุงูุฅุดุงุฑุฉ ุฅูู ูุฐุง ุงูุชูุงูุถ **ุจูุถูุญ ูููุฉ** ูู "ุงูููุฎุต ุงูุชูููุฐู". ุงุนุชุจุฑู ูุคุดุฑูุง ุฎุทูุฑูุง ุนูู ุงุญุชูุงููุฉ ูุฌูุฏ ุฎุทุฃ ูุงุฑุซู ูู ุฅุฏุฎุงู ุงูุจูุงูุงุช ุฃู ุงุญุชูุงู.
        4.  **ูุงุนุฏุฉ ุงููุตุงุฏุฑ:** ุนูุฏ ุฐูุฑ ุจุฑูุชูููู ุนูุงุฌูุ ูุฌุจ ุฃู ุชููู ูุญุฏุฏูุง. ูุซุงู: "ุจุฑูุชูููู ุงูุฌูุนูุฉ ุงูุฃูุฑูููุฉ ููุณูุฑู (ADA) ููุฑุถู ุงูุณูุฑู ูู ุงูููุน ุงูุซุงูู".

        ---
        **ูููู ุงูุชูุฑูุฑ ุงููุทููุจ (ูุฌุจ ุฅูุชุงุฌ ููุฏ HTML ููุท ุจุงุชุจุงุน ูุฐุง ุงููููู ุจุฏูุฉ ุดุฏูุฏุฉ):**

        <h3><svg ...>ุชูุฑูุฑ ุงูุชุฏููู ุงูุทุจู ุงูุดุงูู</svg></h3>

        <div class="section">
            <h4>ุงูููุฎุต ุงูุชูููุฐู ูุฃุฎุทุฑ ุงูููุงุญุธุงุช</h4>
            <div class="recommendation-card risk-red">
              <p><strong>[ุถุน ููุง ุฃุฎุทุฑ ููุงุญุธุฉ ุจุดูู ูุจุงุดุฑุ ูุซูุงู: "ุชู ูุตู ุฏูุงุก Duodart ุงููุฎุตุต ููุจุฑูุณุชุงุชุง ููุฑูุถ ุนูุฑู 12 ุนุงููุงุ ููู ูุง ูุนุชุจุฑ ุฎุทุฃ ุทุจููุง ูุงุฏุญูุง ููุฑููุถ ุชุฃูููููุง ุจุดูู ูุงุทุน."]</strong></p>
            </div>
            <div class="recommendation-card risk-yellow">
              <p><strong>[ุถุน ููุง ููุงุญุธุฉ ูุงูุฉ ุฃุฎุฑูุ ูุซูุงู: "ุชู ูุตู 3 ุฃุฏููุฉ ูุงุฑุชูุงุน ุถุบุท ุงูุฏู ู 2 ููุณูุฑู ููุง ูุฏ ูุดูุฑ ุฅูู ุญุงูุฉ ูุนูุฏุฉ ุฌุฏูุง (Polypharmacy) ุชุญุชุงุฌ ุฅูู ุชูุซูู ุงุณุชุซูุงุฆู."]</strong></p>
            </div>
        </div>

        <div class="section">
            <h4>1. ุชูููู ุงูุฅุฌุฑุงุกุงุช ุงูุญุงููุฉ (ุงูุชุฏููู ุงูุชูุตููู)</h4>
            <table class="audit-table">
                <thead><tr><th>ุงูุฅุฌุฑุงุก / ุงูุฏูุงุก</th><th>ุงูุชูููู ูุงูุชุนููู ุงูุนููู (ูุน ุงููุตุฏุฑ)</th><th>ููุงููุฉ ุงูุชุฃููู</th></tr></thead>
                <tbody>
                    <tr class="risk-green">
                        <td>Amlodipine 10mg</td>
                        <td><strong>ุชูููู: ุณููู ููุจุฑุฑ.</strong><br>ูุณุชุฎุฏู ูุนูุงุฌ ุงุฑุชูุงุน ุถุบุท ุงูุฏู (HTN). ุงูุฌุฑุนุฉ ุถูู ุงููุทุงู ุงูุทุจูุนู ููุจุงูุบูู. ูุชูุงูู ูุน ุฅุฑุดุงุฏุงุช JNC8.</td>
                        <td><strong>ููุจูู.</strong> ุงูุฅุฌุฑุงุก ุถุฑูุฑู ุทุจููุง ููุชุดุฎูุต ุงููุฐููุฑ.</td>
                    </tr>
                    <tr class="risk-red">
                        <td>Duodart 0.5/0.4mg</td>
                        <td><strong>ุชูููู: ุฎุทุฃ ุทุจู ูุงุฏุญ.</strong><br>ูุฐุง ุงูุฏูุงุก ูุฎุตุต ูุนูุงุฌ ุชุถุฎู ุงูุจุฑูุณุชุงุชุง ุงูุญููุฏ (BPH) ููุง ูุณุชุฎุฏู ุฅุทูุงููุง ูููุณุงุก ุฃู ุงูุฃุทูุงู. ูุตูู ูุทูู ูุนุชุจุฑ ุฎุทุฃ ุฌุณูููุง.</td>
                        <td><strong>ูุฑููุถ ูุทุนูุง.</strong> ุงุณุชุฎุฏุงู ุฎุงุฑุฌ ุงููุทุงู (Off-label) ูุบูุฑ ูุจุฑุฑ ุจุดูู ุฎุทูุฑ.</td>
                    </tr>
                    </tbody>
            </table>
        </div>

        <div class="section">
            <h4>2. ูุฑุต ุงูุชุญุณูู ูุฑูุน ุงูุฅูุฑุงุฏุงุช (ุงูุฅุฌุฑุงุกุงุช ุงููุงุฆุชุฉ)</h4>
            <p>ุจูุงุกู ุนูู ุงูุชุดุฎูุตุงุช ุงููุชุนุฏุฏุฉ (Polypharmacy)ุ ูุฐู ูู ุงูุฅุฌุฑุงุกุงุช ุงูุถุฑูุฑูุฉ ุงูุชู ุชู ุฅุบูุงููุง:</p>
            <div class="recommendation-card">
                <h5>ุฅุฌุฑุงุก ููุชุฑุญ: ูุญุต ูุธุงุฆู ุงูููู (Creatinine, eGFR) ูููุญุฉ ุงูุฏููู ุงููุงููุฉ (Lipid Panel)</h5>
                <p><strong>ุงููุจุฑุฑ ุงูุทุจู:</strong> ูุน ูุฌูุฏ ุชุดุฎูุต ุงุฑุชูุงุน ุถุบุท ุงูุฏู ูุงูุณูุฑู (HTN, Dyslipidemia)ุ ูุฅู ุจุฑูุชููููุงุช ADA ู KDIGO ุชุฌุนู ูุฐู ุงููุญูุตุงุช **ุฅูุฒุงููุฉ** ููุฑุงูุจุฉ ุชุฃุซูุฑ ุงูุฃุฏููุฉ ุนูู ุงูููู ูุชูููู ูุฎุงุทุฑ ุฃูุฑุงุถ ุงูููุจ. ุฅุบูุงููุง ูุนุชุจุฑ ููุตูุง ูู ุงูุฑุนุงูุฉ.</p>
                <p><strong>ุงูุชุฃุซูุฑ ุงููุงูู:</strong> ุฅุถุงูุฉ ูุฐู ุงููุญูุตุงุช ูุงู ุณูุฒูุฏ ุงููุงุชูุฑุฉ ุจูููุฉ ุชูุฑูุจูุฉ **~350 ุฑูุงู ุณุนูุฏู** ููู ูุบุทุงุฉ ุจุงููุงูู ูู ุงูุชุฃููู ููุชุดุฎูุตุงุช ุงููุฐููุฑุฉ.</p>
            </div>
        </div>
        
        <div class="section financial-summary"> ... </div>
        <div class="section"><h4>4. ุชูุตูุงุช ููุงุฆูุฉ ููุชุฑููุฒ ูุงูุชูุซูู</h4> ... </div>
        `;
    }

    // --- The rest of the file remains the same ---
    const parts = [{ text: htmlPrompt }];
    if (requestBody.imageData) {
        if (Array.isArray(requestBody.imageData)) {
            requestBody.imageData.forEach(imgData => {
                parts.push({ inline_data: { mime_type: "image/jpeg", data: imgData } });
            });
        } 
        else if (typeof requestBody.imageData === 'string') {
            parts.push({ inline_data: { mime_type: "image/jpeg", data: requestBody.imageData } });
        }
    }
    const payload = {
        contents: [{ parts: parts }],
        generationConfig: {
            temperature: 0.3, // Lowered temperature for more deterministic and rule-following output
        },
    };
    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });
        const result = await response.json();
        if (!response.ok) {
            const errorMessage = result.error?.message || `API request failed: ${response.statusText}`;
            throw new Error(errorMessage);
        }
        const reportHtml = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!reportHtml) {
            throw new Error("ูู ูุชููู ุงููููุฐุฌ ูู ุฅูุดุงุก ุงูุชูุฑูุฑ. ุงูุงุณุชุฌุงุจุฉ ูุงูุช ูุงุฑุบุฉ.");
        }
        return res.status(200).json({ htmlReport: reportHtml });
    } catch (err) {
        console.error("๐ฅ Server-side Error:", err);
        return res.status(500).json({
            error: "ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู ุฃุซูุงุก ุชุญููู ุงูุญุงูุฉ",
            detail: err.message,
        });
    }
}
