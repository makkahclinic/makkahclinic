// /api/analyzer.js - THE UNIFIED DUAL-PERSONALITY ANALYZER

const systemInstruction = `
Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ø·Ø¨ÙŠ Ø³Ø±ÙŠØ±ÙŠ ÙØ§Ø¦Ù‚ Ø§Ù„Ø°ÙƒØ§Ø¡ ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„ØªÙƒÙŠÙ. Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù‡ÙŠ ØªØ­Ø¯ÙŠØ¯ "Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù" Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ (Ø¥Ù…Ø§ 'patient' Ø£Ùˆ 'doctor') Ø«Ù… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± HTML Ù…Ø®ØµØµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø°Ù„Ùƒ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±.

### Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„: Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ØªÙØ·Ø¨Ù‚ Ø¯Ø§Ø¦Ù…Ù‹Ø§)

1.  **Ø§Ø³ØªØ®Ù„Ø§Øµ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** Ø§Ø³ØªØ®Ø±Ø¬ ÙƒÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø© Ù…ØªØ§Ø­Ø© Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙƒØªÙˆØ¨ ÙˆØ§Ù„ØµÙˆØ±.
2.  **Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ Ø§Ù„ØµØ§Ø±Ù…:** Ù„ÙƒÙ„ Ø¯ÙˆØ§Ø¡ØŒ ØªØ­Ù‚Ù‚ Ù…Ù†:
    * **Ø§Ù„Ø¬Ø±Ø¹Ø©:** Ù‡Ù„ Ù‡ÙŠ Ù…Ù†Ø·Ù‚ÙŠØ©ØŸ (Ù…Ø«Ø§Ù„: Diamicron MR Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙŠÙˆÙ…ÙŠÙ‹Ø§).
    * **Ø§Ù„Ø§Ø²Ø¯ÙˆØ§Ø¬ÙŠØ© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©:** Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ø£Ø¯ÙˆÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù†ÙØ³ Ø§Ù„ØºØ±Ø¶ØŸ (Ù…Ø«Ø§Ù„: Triplexam + Diovan Ù„Ù„Ø¶ØºØ·).
    * **Ø§Ù„Ø£Ù…Ø§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ù‚:** Ù‡Ù„ Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¢Ù…Ù† Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ (Ù…Ø«Ø§Ù„: **Ø§Ù„Ø­Ù…Ù„**ØŒ ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù†ØŒ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒÙ„Ù‰). Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù‡Ù….
    * **Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØºÙŠØ± Ø§Ù„ÙˆØ§Ø¶Ø­Ø©:** Ø§Ù‚ØªØ±Ø­ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ Ø§Ù„Ø£Ù‚Ø±Ø¨ (Ù…Ø«Ø§Ù„: 'Rost' -> Rosuvastatin).
3.  **ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ¬ÙˆØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµÙŠØ©:** Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ÙØ­ÙˆØµØ§Øª Ø¶Ø±ÙˆØ±ÙŠØ© Ù„Ù… ØªØªÙ… (Ù…Ø«Ø§Ù„: Ù…Ø±ÙŠØ¶ Ø¨ØµØ¯Ø§Ø¹ Ø­Ø§Ø¯ Ø­ÙˆÙ„ Ø§Ù„Ø¹ÙŠÙ† -> ÙŠØªØ·Ù„Ø¨ Ù‚ÙŠØ§Ø³ Ø¶ØºØ· Ø§Ù„Ø¹ÙŠÙ†).

---

### Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±)

**Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ù‡Ùˆ 'patient':**
* **Ø´Ø®ØµÙŠØªÙƒ:** "ÙØ±ÙŠÙ‚ Ø§Ø³ØªØ´Ø§Ø±ÙŠ Ø·Ø¨ÙŠ" ÙˆØ¯ÙˆØ¯ ÙˆÙ…ØªØ¹Ø§Ø·Ù.
* **Ø§Ù„Ù‡Ø¯Ù:** ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ø±ÙŠØ¶ØŒ ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ ÙˆØ¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø¨Ø´ÙƒÙ„ Ø¨ØµØ±ÙŠ ÙÙˆØ±ÙŠ.
* **Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠ:**
    1.  **ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø±Ø¬Ø©:** Ø§Ø¨Ø¯Ø£ Ø¨Ø£Ø®Ø·Ø± 2-3 Ø§ÙƒØªØ´Ø§ÙØ§Øª ÙÙŠ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø­Ù…Ø±Ø§Ø¡ 'box-critical'.
    2.  **Ù…ÙˆØ¬Ø² Ø§Ù„Ø­Ø§Ù„Ø©:** Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù„ØºØ© Ø³Ù‡Ù„Ø©.
    3.  **Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:** Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ±Ø© Ù…Ø¹ ØªÙ„ÙˆÙŠÙ†.
    4.  **Ø¬Ø¯ÙˆÙ„ ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:** ÙŠØ¬Ø¨ ØªÙ„ÙˆÙŠÙ† Ø®Ù„ÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (`<td class='box-critical'>`) Ù„Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø®Ø·Ø±.
    5.  **Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¬ÙˆØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµÙŠØ©:** Ø¨Ø³Ù‘Ø· Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ©.
    6.  **Ø®Ø·Ø© Ø¹Ù…Ù„:** Ø§Ø³ØªØ®Ø¯Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ¹Ø¨Ø§Ø±Ø§Øª ÙˆØ§Ø¶Ø­Ø© (ğŸš¨ Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ø§Ø¬Ù„ØŒ âš ï¸ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ù‡Ù…).
    7.  **Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø·Ø¨ÙŠØ¨:** Ø¬Ù‡Ù‘Ø² Ù„Ù„Ù…Ø±ÙŠØ¶ Ø£Ø³Ø¦Ù„Ø© Ø°ÙƒÙŠØ© ÙˆÙ…ÙˆØ¬Ø²Ø©.

**Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ù‡Ùˆ 'doctor':**
* **Ø´Ø®ØµÙŠØªÙƒ:** "ÙƒØ¨ÙŠØ± Ù…Ø¯Ù‚Ù‚ÙŠ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ£Ù…ÙŠÙ†" Ø±Ø³Ù…ÙŠØŒ Ø¯Ù‚ÙŠÙ‚ØŒ ÙˆÙ…ÙˆØ¬Ø².
* **Ø§Ù„Ù‡Ø¯Ù:** ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø³Ø±Ø¹Ø©ØŒ ÙƒØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ØŒ ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ.
* **Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠ:**
    1.  **Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±:** "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø·Ø¨ÙŠ ÙˆØ§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠØ©".
    2.  **Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø©:** Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ© ÙˆØ§Ù„ØªØ´Ø®ÙŠØµØ§Øª.
    3.  **Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ‚:** ÙÙ‚Ø±Ø§Øª Ù†ØµÙŠØ© ØªØ´Ø±Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ´ÙØ©.
    4.  **Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„:** ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ "Drug-Drug Interaction" ÙˆØ¹Ù…ÙˆØ¯ **"Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ"** Ù…Ø¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (âŒ Ù…Ø±ÙÙˆØ¶ØŒ âš ï¸ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø±ÙØ¶ØŒ âœ… Ù…Ù‚Ø¨ÙˆÙ„).
    5.  **ÙØ±Øµ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø±Ø¹Ø§ÙŠØ©:** Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‚Ø·ÙŠØ© Ù„Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©.
    6.  **Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„:** Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ù‚Ù…Ø© Ù„Ù„ØªØµØ­ÙŠØ­Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.
`;

// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¢Ù† ØªØ¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙƒÙ„Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠÙ†
function buildUserPrompt(caseData) {
    // Ù†Ø­Ø¯Ø¯ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
    const audience = caseData.userType === 'patient' ? 'patient' : 'doctor';

    const textInput = `
        **Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Audience):** ${audience}

        **Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:**
        - Ø§Ù„Ø¹Ù…Ø±: ${caseData.age || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
        - Ø§Ù„Ø¬Ù†Ø³: ${caseData.gender || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
        - ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© (Ø£Ø¹Ø±Ø§Ø¶/ØªØ´Ø®ÙŠØµ/Ù…Ù„Ø§Ø­Ø¸Ø§Øª): ${caseData.symptoms || caseData.diagnosis || caseData.notes || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
        - Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù†ØµÙŠÙ‹Ø§): ${caseData.medications || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
        - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø­Ù…Ù„ØŒ ØªØ¯Ø®ÙŠÙ†ØŒ Ø¥Ù„Ø®): ${caseData.history || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
    `;

    return `
        ${textInput}
        **Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©:**
        - ${caseData.imageData && caseData.imageData.length > 0 ? `ÙŠÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„.` : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø±ÙÙ‚Ø©."}
    `;
}

export default async function handler(req, res) {
    // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Gemini ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ...
    // The Gemini connection logic (fetch, payload, etc.) remains identical
    res.setHeader("Access-Control-Allow-Origin", "*");
    res.setHeader("Access-Control-Allow-Methods", "POST", "OPTIONS");
    res.setHeader("Access-Control-Allow-Headers", "Content-Type", "Authorization");

    if (req.method === "OPTIONS") return res.status(200).end();
    if (req.method !== 'POST') return res.status(405).json({ error: 'Method Not Allowed' });

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) throw new Error("GEMINI_API_KEY is not set.");
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

        const userPrompt = buildUserPrompt(req.body); 
        const parts = [{ text: systemInstruction }, { text: userPrompt }];

        if (req.body.imageData && Array.isArray(req.body.imageData)) {
            req.body.imageData.forEach(imgData => {
                parts.push({ inline_data: { mimeType: "image/jpeg", data: imgData } });
            });
        }

        const payload = {
            contents: [{ role: "user", parts: parts }],
            generationConfig: { temperature: 0.2, topP: 0.95, topK: 40 },
        };

        const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });

        if (!response.ok) {
            const errorBody = await response.json();
            throw new Error(errorBody.error?.message || `API request failed: ${response.statusText}`);
        }

        const result = await response.json();
        const reportHtml = result.candidates[0].content.parts[0].text;
        
        return res.status(200).json({ htmlReport: reportHtml });

    } catch (err) {
        return res.status(500).json({
            error: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©",
            detail: err.message,
        });
    }
}
