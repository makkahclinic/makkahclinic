// /api/gpt.js

/**
 * The final, definitive, table-driven version of the AI's thinking process.
 * This version integrates the best of our logic with the clear, table-based presentation style requested by the user.
 */
const systemInstruction = `
ุฃูุช "ูุจูุฑ ุงุณุชุดุงุฑูู ุงูุชุฏููู ุงูุทุจู"ุ ููููุชู ูู ุชุญููู ุงููุตูุงุช ุงูุทุจูุฉ ุงููุนูุฏุฉ ุฅูู ุชูุงุฑูุฑ ุงุณุชุฑุงุชูุฌูุฉ ูุงุถุญุฉ ูููุธูุฉ ูู ุฌุฏุงูู HTML.

**ููุงุนุฏ ุงูุณููู ุงูุฅูุฒุงููุฉ:**
- **ุงูุฏูุฉ ุงูุทุจูุฉ ุงููุทููุฉ:** ูุจู ุงุฏุนุงุก ูุฌูุฏ ุงุฒุฏูุงุฌูุฉ ุนูุงุฌูุฉุ ูุฌุจ ุฃู ุชููู ูุชุฃูุฏุงู 100% ุฃู ุงูุฏูุงุฆูู ูู ููุณ ุงูุนุงุฆูุฉ ุงูุนูุงุฌูุฉ. ุชุฌูุจ ุงูุฃุฎุทุงุก ูุซู ุงูุฎูุท ุจูู ุฃุฏููุฉ ุงูุถุบุท ูุงูุฏููู. ุงูุฏูุฉ ูู ุฃููููุชู ุงููุตูู.
- **ุงูุชูุงุตู ุงูุงุญุชุฑุงูู:** ูุง ุชุณุชุฎุฏู ุนุจุงุฑุงุช ูุซู "ูุฑุงุกุฉ ููุซููุฉ" ุฃู ูุณุจ ูุฆููุฉ. ุฅุฐุง ูุงูุช ูุฑุงุกุชู ููููุฉ ูุง ุบูุฑ ูุงุถุญุฉุ ุงุฐูุฑ ุฃูุถู ุชุฎููู ูู ูุฃุชุจุนู ุจุนุจุงุฑุฉ "(ูุฑุงุกุฉ ุบูุฑ ูุงุถุญุฉุ ูุชุทูุจ ุชูุถูุญุงู ูู ุงูุทุจูุจ)".

**ูููุฌูุฉ ุงูุชุญููู ุงูุฅูุฒุงููุฉ (ุงุชุจุน ูุฐู ุงูุฎุทูุงุช ุจุงูุชุฑุชูุจ ุงูุตุงุฑู):**

**ุงูุฎุทูุฉ 0: ูุณุญ ุงูุจูุงูุงุช ุงูุฏูููุบุฑุงููุฉ (Demographic Scan)**
- ุงุจุฏุฃ ุจูุณุญ ุดุงูู ููุฌุฒุก ุงูุนููู ูู ุงููุซููุฉ. ุงุณุชุฎุฑุฌ 'ุฑูู ุงูููู'ุ 'ุงูุฌูุณ' (ูู ุงูุฎุงูุฉ ุงููุญุฏุฏุฉ โ)ุ ู'ุงูุนูุฑ' (ุฅู ูุฌุฏ). ุงุฐูุฑ ูุฐู ุงููุนูููุงุช ูู ุจุฏุงูุฉ ุงูุชูุฑูุฑ.

**ุงูุฎุทูุฉ 1: ุงุณุชุฎูุงุต ูุชุญููู ุงูุจูุงูุงุช ูู ุฌุฏูู (Table-Based Data Extraction)**
1.  ุงูุขูุ ูู ุจุชุญููู ุฎุท ุงููุฏ ููุงุฆูุฉ ุงูุฃุฏููุฉ.
2.  **ุฃูุดุฆ ุฌุฏูู HTML ูุชุญููู ุงูุฃุฏููุฉ:** ูุฌุจ ุฃู ูุญุชูู ุงูุฌุฏูู ุนูู ุงูุฃุนูุฏุฉ ุงูุชุงููุฉ: "ุงูุฏูุงุก", "ุงูุฌุฑุนุฉ ุงููุชุฑุฌูุฉ", "ุงูุบุฑุถ ุงูุทุจู ุงููุฑุฌุญ", "ููุงุญุธุงุช ูุชุจุฑูุฑุงุช".
3.  **ุงููุฃ ุงูุฌุฏูู ุจุฏูุฉ:**
    - **ุงูุฏูุงุก:** ุงูุชุจ ุงุณู ุงูุฏูุงุก. ุฅุฐุง ุบูุฑ ูุงุถุญุ ุงุชุจุน ูุงุนุฏุฉ ุงูุชูุงุตู ุงูุงุญุชุฑุงูู.
    - **ุงูุฌุฑุนุฉ ุงููุชุฑุฌูุฉ:** ูู ุดูุฑุฉ ุงูุชุฑููุฒ (ูุซู '1x1x90') ูุชุฑุฌูู ุฅูู ูุต ููููู ("ูุฑุฉ ูุงุญุฏุฉ ููููุงู ููุฏุฉ 90 ูููุงู").
    - **ุงูุบุฑุถ ุงูุทุจู ุงููุฑุฌุญ:** ุจูุงุกู ุนูู ุงูุชุดุฎูุตุงุช ูุงุณู ุงูุฏูุงุกุ ุญุฏุฏ ุงูุบุฑุถ ููู (ูุซุงู: "ูุนูุงุฌ ุงุฑุชูุงุน ุถุบุท ุงูุฏู").
    - **ููุงุญุธุงุช ูุชุจุฑูุฑุงุช:** ุงุณุชุฎุฏู ุงููุคุดุฑุงุช ุงูุจุตุฑูุฉ ุงูุชุงููุฉ:
        - **โ ูุจุฑุฑ:** ุฅุฐุง ูุงู ุงูุฏูุงุก ููุทููุงู ูุน ุงูุชุดุฎูุต.
        - **โ๏ธ ูุชุทูุจ ุชุจุฑูุฑุงู:** ุฅุฐุง ูุงู ุงูุฏูุงุก ูุญุชุงุฌ ููุญูุตุงุช ุฏุงุนูุฉ (ูุซู ุชุญููู ุฏููู ุฃู PSA).
        - **โ ุฎุทุฃ ูุญุชูู:** ุฅุฐุง ุดููุช ูู ูุฌูุฏ ุฎุทุฃ (ูุซู ุฌุฑุนุฉ ุฎุงุทุฆุฉ ุฃู ุงุฒุฏูุงุฌูุฉ).

**ุงูุฎุทูุฉ 2: ุชุญุฏูุฏ ุงูุฃุฎุทุงุก ุงูุญุฑุฌุฉ ููุฌูุงุช ุงูุชุจุฑูุฑ**
- ุจุนุฏ ุงูุฌุฏููุ ุฃูุดุฆ ูุณูุงู ูููุตูุงู ุจุนููุงู **"ุงูุฃุฎุทุงุก ุงูุทุจูุฉ ุงูุญุฑุฌุฉ ุงูููุชุดูุฉ"**.
- ุงุฐูุฑ ููุง ุจูุถูุญ ุฃู ุฃุฎุทุงุก ุฌุณููุฉ ูุฌุฏุชูุงุ ูุซู:
    - **ุงูุงุฒุฏูุงุฌูุฉ ุงูุนูุงุฌูุฉ ุงูุญููููุฉ:** (ูุซุงู: "ููุฌุฏ ุฎุทุฑ ุงุฒุฏูุงุฌูุฉ ุซูุงุซูุฉ ูู ุนูุงุฌ ุงูุถุบุท ุจูู ุงูุฃุฏููุฉ Amlodipine, Co-Taburan, ู Triplex").
    - **ุฃุฎุทุงุก ุงูุฌุฑุนุงุช:** (ูุซุงู: "ุฌุฑุนุฉ ุฏูุงุก Diamicron MR ุงูููุตููุฉ ูุฑุชูู ููููุงู ุชุนุชุจุฑ ุฎุทุฃ ุนูุงุฌูุงูุ ุญูุซ ูุฌุจ ุฃู ูุคุฎุฐ ูุฑุฉ ูุงุญุฏุฉ ููุท").
- ุซู ุฃูุดุฆ ูุณูุงู ุจุนููุงู **"ุงููุญูุตุงุช ุงููุทููุจุฉ ูุงุณุชููุงู ุงูููู"** ูุงุฐูุฑ ูููุง ูุงุฆูุฉ ุงููุญูุตุงุช ุงููุงุฒูุฉ.

**ุงูุฎุทูุฉ 3: ุตูุงุบุฉ ุงูุชูุตูุงุช ูุฎุทุฉ ุงูุนูู**
- ูุฏู ุฎุทุฉ ุนูู ุชูููุฐูุฉ ููุงุถุญุฉ ุจูุงุกู ุนูู ุงูุฃุฎุทุงุก ูุงููุฌูุงุช ุงูุชู ูุฌุฏุชูุง. ูู ุญุงุณูุงู ูู ุชูุตูุงุชู.

**ุงููุฎุฑุฌ ุงูููุงุฆู:**
- ูุฌุจ ุฃู ูููู ุฑุฏู ูู ููุฏ HTML ููุทุ ููุธูุงู ูู ุฌุฏุงูู ูุงุถุญุฉุ ููุจุฏุฃ ูุจุงุดุฑุฉ ุจุงููุณู \`<h3>\`.
`;


/**
 * Builds the dynamic user prompt part based on the request data.
 */
function buildUserPrompt(caseData) {
    const {
        gender, isPregnant, pregnancyMonth, height, weight, temperature,
        bloodPressure, caseDescription, diagnosis, labResults,
        medicationsProcedures, imageData
    } = caseData;

    return `
        **ุงูุจูุงูุงุช ุงููุงุฑุฏุฉ ููุชุญููู:**

        **1. ูุนูููุงุช ุงููุฑูุถ (ุจูุงูุงุช ูุตูุฉ ุฏุงุนูุฉ):**
        - ุงูุฌูุณ: ${gender || "ุบูุฑ ูุญุฏุฏ ูู ุงููุต"}
        ${gender === 'female' ? `- ุญุงูู: ${isPregnant === 'yes' ? `ูุนูุ ุงูุดูุฑ ${pregnancyMonth || 'ุบูุฑ ูุญุฏุฏ'}` : 'ูุง'}` : ''}
        
        **2. ุชูุงุตูู ุงูุญุงูุฉ (ุจูุงูุงุช ูุตูุฉ ุฏุงุนูุฉ):**
        - ุงูุชุดุฎูุต ุงููุจุฏุฆู: ${diagnosis || "ุบูุฑ ูุญุฏุฏ ูู ุงููุต"}
        
        **3. ุงููููุงุช ุงููุฑููุนุฉ:**
        - ${imageData && imageData.length > 0 ? `ููุฌุฏ ${imageData.length} ุตูุฑุฉ ูุฑููุฉ ููุชุญููู. **ูุฐู ูู ุงููุตุฏุฑ ุงูุฃุณุงุณู ูุงููุญูุฏ ููุญูููุฉ.**.` : "ูุง ููุฌุฏ ุตูุฑ ูุฑููุฉ."}

        ---
        **ูููู ุงูุชูุฑูุฑ ุงููุทููุจ (ููุงุณุชุฎุฏุงู ูู ุงููุฎุฑุฌ ุงูููุงุฆู):**

        <h3>ุชูุฑูุฑ ุงุณุชุดุงุฑู ููุชุฏููู ุงูุทุจู</h3>
        
        <div class="section">
            <h4>1. ููุฎุต ุงูุญุงูุฉ ูุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ:</h4>
            <p>[ููุง ุงูููุฎุต ูุงูุชุฑููุฒ ุนูู ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ ูู ุฃุนูู ุงููููุฐุฌ ูุงูููุงูุต]</p>
        </div>

        <div class="section">
            <h4>2. ุฌุฏูู ุชุญููู ุงูุฃุฏููุฉ ุงูููุตููุฉ:</h4>
            <table>
              <thead>
                <tr>
                  <th>ุงูุฏูุงุก</th>
                  <th>ุงูุฌุฑุนุฉ ุงููุชุฑุฌูุฉ</th>
                  <th>ุงูุบุฑุถ ุงูุทุจู ุงููุฑุฌุญ</th>
                  <th>ููุงุญุธุงุช ูุชุจุฑูุฑุงุช</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h4>3. ุงูุฃุฎุทุงุก ุงูุทุจูุฉ ุงูุญุฑุฌุฉ ูุงููุญูุตุงุช ุงููุทููุจุฉ:</h4>
            <h5>ุงูุฃุฎุทุงุก ุงูุทุจูุฉ ุงูุญุฑุฌุฉ ุงูููุชุดูุฉ:</h5>
            <p>[ููุง ูุดู ุงูุฃุฎุทุงุก ุงูุทุจูุฉ ุงูุฌุณููุฉ]</p>
            <h5>ุงููุญูุตุงุช ุงููุทููุจุฉ ูุงุณุชููุงู ุงูููู:</h5>
            <p>[ููุง ูุงุฆูุฉ ุงููุญูุตุงุช ุงููุทููุจุฉ]</p>
        </div>

        <div class="section">
            <h4>4. ุฎุทุฉ ุงูุนูู ูุงูุชูุตูุงุช ุงูุชูููุฐูุฉ:</h4>
            <p>[ููุง ุงูุฎุทุฉ ุงููุญุณูุฉ ูุงูููุชุฑุญุฉ ุจุดูู ุญุงุณู]</p>
        </div>
    `;
}


/**
 * @description The intelligent backend for the Medical & Insurance Review Expert system.
 */
export default async function handler(req, res) {
    // Set CORS headers
    res.setHeader("Access-Control-Allow-Origin", "*");
    res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
    res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

    if (req.method === "OPTIONS") {
        return res.status(200).end();
    }

    if (req.method !== "POST") {
        return res.status(405).json({ error: "Method Not Allowed" });
    }

    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (!apiKey) {
            throw new Error("GEMINI_API_KEY environment variable is not set.");
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

        const userPrompt = buildUserPrompt(req.body);
        
        const parts = [
            { text: systemInstruction },
            { text: userPrompt }
        ];

        if (req.body.imageData && Array.isArray(req.body.imageData) && req.body.imageData.length > 0) {
            req.body.imageData.forEach(imgData => {
                parts.push({
                    inline_data: {
                        mimeType: "image/jpeg",
                        data: imgData
                    }
                });
            });
        }

        const payload = {
            contents: [{ role: "user", parts: parts }],
            generationConfig: {
                temperature: 0.25, 
                topP: 0.95,
                topK: 40,
            },
        };

        const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });

        if (!response.ok) {
            const errorBody = await response.json();
            console.error("Gemini API Error:", errorBody);
            throw new Error(errorBody.error?.message || `API request failed: ${response.statusText}`);
        }

        const result = await response.json();
        
        const reportHtml = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!reportHtml) {
            console.error("No report generated by Gemini. Full response:", JSON.stringify(result, null, 2));
            throw new Error("ูู ูุชููู ุงููููุฐุฌ ูู ุฅูุดุงุก ุงูุชูุฑูุฑ. ูุฏ ูููู ุงููุญุชูู ูุญุธูุฑูุง ุฃู ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน.");
        }
        
        return res.status(200).json({ htmlReport: reportHtml });

    } catch (err)
        {
        console.error("๐ฅ Server-side Error in /api/gpt:", err);
        return res.status(500).json({
            error: "ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู ุฃุซูุงุก ุชุญููู ุงูุญุงูุฉ",
            detail: err.message,
        });
    }
}
