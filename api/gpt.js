// /api/gpt.js

/**
ย* @description Serverless API endpoint to generate a detailed, formatted HTML report.
ย* This version is now fully multimodal, capable of analyzing both text and image inputs.
ย*
ย* ุชู ุชุญุฏูุซ ูุฐุง ุงูููุฏ ููุตุจุญ ูุชุนุฏุฏ ุงููุณุงุฆุทุ ูุงุฏุฑุงู ุนูู ุชุญููู ุงููุฏุฎูุงุช ุงููุตูุฉ ูุงูุตูุฑ ูุนุงู.
ย*/
export default async function handler(req, res) {
ย // Set CORS headers
ย res.setHeader("Access-Control-Allow-Origin", "*");
ย res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
ย res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

ย // Handle preflight OPTIONS request
ย if (req.method === "OPTIONS") {
ย ย return res.status(200).end();
ย }

ย // Ensure the request method is POST
ย if (req.method !== "POST") {
ย ย return res.status(405).json({ error: "Method Not Allowed" });
ย }

ย const {
ย ย diagnosis,
ย ย symptoms,
ย ย age,
ย ย gender,
ย ย smoker,
ย ย beforeProcedure,
ย ย afterProcedure,
ย ย imageData // Now receiving image data
ย } = req.body;

ย // Validate that either text fields or an image is provided
ย if ((!diagnosis && !symptoms) && !imageData) {
ย ย return res.status(400).json({ error: "ุงูุฑุฌุงุก ููุก ุงูุญููู ุงููุตูุฉ ุฃู ุฑูุน ุตูุฑุฉ." });
ย }

ย const apiKey = process.env.GEMINI_API_KEY;
ย const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

  // **PROMPT ENHANCEMENT**: The persona is now a "Clinical Pharmacist & Expert Medical Reviewer".
  // The analysis section now mandates pharmacological review of prescribed drugs.
  // **ุชุญุณูู ุงูุชุนูููุงุช**: ุงูุดุฎุตูุฉ ุงูุขู ูู "ุตูุฏูู ุฅููููููู ูุฎุจูุฑ ูุฑุงุฌุนุฉ ุทุจูุฉ".
  // ูุณู ุงูุชุญููู ุงูุขู ููุฑุถ ุงููุฑุงุฌุนุฉ ุงูุฏูุงุฆูุฉ ููุฃุฏููุฉ ุงูููุตููุฉ.
ย const htmlPrompt = `
    ุฃูุช "ุตูุฏูู ุฅููููููู ูุฎุจูุฑ ูุฑุงุฌุนุฉ ุทุจูุฉ ูุชุฃูููุ ูุชุฎุตุต ูู ุทุจ ุงูุนููู ูุงูุฃูุฑุงุถ ุงูุจุงุทููุฉ ุงููุตุงุญุจุฉ". ูููุชู ูุชุงุจุฉ ุชูุฑูุฑ ุชุญูููู ุงุณุชุดุงุฑู ูุงุญุฏ ููุชูุงูู ุจุตูุบุฉ HTML. ูุฌุจ ุฃู ูููู ุชุญูููู ุดููููุงูุ ูุฑุจุท ุจูู ุงูุชุฎุตุตุงุชุ ููุฏุนู ุชูุตูุงุชู ุจูุตุงุฏุฑ ุทุจูุฉ ูุนุฑููุฉ.

    **ุจูุงูุงุช ุงูุญุงูุฉ ูุชุญููููุง:**
    - ุงูุชุดุฎูุต ุงููููุชุฑ: ${diagnosis || "ูู ูุญุฏุฏ"}
    - ุงูุฃุนุฑุงุถ: ${symptoms || "ูู ุชุญุฏุฏ"}
    - ุงูุนูุฑ: ${age || "ูู ูุญุฏุฏ"}
    - ุงูุฌูุณ: ${gender || "ูู ูุญุฏุฏ"}
    - ูุฏุฎู: ${smoker ? 'ูุนู' : 'ูุง'}
    - ุงูุฅุฌุฑุงุกุงุช ุงููุชุฎุฐุฉ: ${beforeProcedure || "ูุง ููุฌุฏ"}, ${afterProcedure || "ูุง ููุฌุฏ"}

    ---
    **ูููู ุงูุชูุฑูุฑ ุงููุทููุจ (ูุฌุจ ุฅูุชุงุฌ ููุฏ HTML ููุท):**

    <h3>ุชูุฑูุฑ ุชุญูููู ูููุตู</h3>
    
    <div class="section">
        <h4>1. ุชุญููู ุงูุฅุฌุฑุงุกุงุช ููุจุฑุฑุงุชูุง ุงูุทุจูุฉ:</h4>
        <p>ุงุจุฏุฃ ุจููุฏ ุงูุชุดุฎูุต ุงููููุชุฑ. ูู ูู ุฏููู ุฃู ุนุงูุ ุงูุชุฑุญ ุงูุฑูุฒ ุงูุตุญูุญ. ุซูุ ุญูู ูู ุฏูุงุก ูุฅุฌุฑุงุก. **ุนูุฏ ุชุญููู ุงูุฃุฏููุฉุ ุฃูุช ููุฒู ุจุชุญููู ุฎุตุงุฆุตูุง ุงูุฏูุงุฆูุฉ:** ูู ุงูุฏูุงุก ุงููุฎุชุงุฑ ูู ุงูุฃูุถู ูู ูุฆุชู ููุฐู ุงูุญุงูุฉุ ูู ูุตู ุจุชุฑููุฒ ูุงูู ูููุงู ุงูุนุฏูู (ูุซูุงูุ ูู ูุนุจุฑ ููุจูู ูู ุญุงูุฉ ุงูุชูุงุจ ุงููุณุงูู ุงูุจูููุฉ)ุ ุงููุฏ ุงูุงุฎุชูุงุฑุงุช ุงูุฏูุงุฆูุฉ ุงูุณูุฆุฉ ุจูุถูุญ (ูุซุงู: "ุงุฎุชูุงุฑ ุงูุฅุฑูุซุฑูููุณูู ูุนูุงุฌ ุงูุชูุงุจ ุงููุณุงูู ุงูุจูููุฉ ูู ุฎุทุฃ ุนูุงุฌู ูุฃู ุชุฑููุฒู ูู ุงูุจูู ุถุนูู ุฌุฏุงู...").</p>
    </div>

    <div class="section">
        <h4>2. ุงุญุชูุงููุฉ ุงูุฑูุถ ูู ุงูุชุฃููู:</h4>
        <p>ุญุฏุฏ ูุณุชูู ุงูุฎุทุฑ (ููุฎูุถ/ูุชูุณุท/ุนุงูู) ุจุงุณุชุฎุฏุงู ุงููุฆุฉ ุงูููุงุณุจุฉ: <span class="risk-low">ููุฎูุถ</span>, <span class="risk-medium">ูุชูุณุท</span>, <span class="risk-high">ุนุงูู</span>.</p>
        <p>ุงุฐูุฑ ุจูุถูุญ ูุง ูู ุงูุฅุฌุฑุงุกุงุช ุงููุนุฑุถุฉ ููุฑูุถุ ูููุชูุง ุจุงูุฑูุงู ุงูุณุนูุฏูุ ูุงูุณุจุจ ุงูุนููู ุฃู ุงูุชุฃูููู ููุฑูุถุ ูุน ุงูุชุฑููุฒ ุนูู ุงูุฃุฎุทุงุก ุงูุนูุงุฌูุฉ.</p>
    </div>

    <div class="section">
        <h4>3. ูุง ูุงู ูููู ุนููู ูุฑูุน ุงููุงุชูุฑุฉ (ููููุง ููุจุฑูุชููููุงุช ุงูุทุจูุฉ):</h4>
        <p>ูุฐุง ูู ุงูุฌุฒุก ุงูุฃูู. ูุฎุจูุฑ ุงุณุชุดุงุฑูุ ููุฑ ูู "ุฑุญูุฉ ุงููุฑูุถ" ุงููุงููุฉ. ุงูุชุฑุญ ุฎุทุฉ ุนูู ุชุจุฏุฃ ุจุงูุงุณุชุดุงุฑุงุช ุงูุถุฑูุฑูุฉ ุซู ุชูุชูู ุฅูู ุงููุญูุตุงุช ุงููุชุฎุตุตุฉ. ูู ุดููููุงูุ ูุฅุฐุง ูุงูุช ุงูุญุงูุฉ (ูุซู ุงูุณูุฑู) ุชุคุซุฑ ุนูู ุฃุนุถุงุก ุฃุฎุฑูุ **ูุฃูุช ููุฒู** ุจุงูุชุฑุงุญ ูุญูุตุงุช ุฌูุงุฒูุฉ ูุซู ูุธุงุฆู ุงูููู ูุงููุจุฏ. ููู ุงูุชุฑุงุญุ ุงุณุชุฎุฏู ุงูุชูุณูู ุงูุชุงูู:</p>
        
        <div class="recommendation">
            <strong>ุนููุงู ุงูุงูุชุฑุงุญ: (ูุซุงู: ุทูุจ ุงุณุชุดุงุฑุฉ ุทุจูุฉ ููุนููู)</strong>
            <ul>
                <li><strong>ุฃูููุฉ ุงูุฅุฌุฑุงุก:</strong> ุงุดุฑุญ ุจุนูู ููุงุฐุง ุงูุฅุญุงูุฉ ุฅูู ุฃุฎุตุงุฆู ูู ุงูุฎุทูุฉ ุงูุฃููู ุงูุตุญูุญุฉ ูุงููุจุฑุฑุฉ ุทุจูุงู.</li>
                <li><strong>ุงููููุฉ ุงูุชูุฏูุฑูุฉ:</strong> ูุฏุฑ ุงูุชูููุฉ ุจุงูุฑูุงู ุงูุณุนูุฏู.</li>
                <li><strong>ููุงุฐุง ูุง ูููู ุฑูุถู:</strong> ูุฏู ุญุฌุฉ ูููุฉ ููููุนุฉ ูุดุฑูุฉ ุงูุชุฃูููุ ูุงุฏุนููุง **ุจุดูู ุฅูุฒุงูู** ุจุฐูุฑ ุจุฑูุชูููู ุทุจู ูุนุฑูู (ูุซุงู: "ูููุงู ูุฅุฑุดุงุฏุงุช ุงูุฌูุนูุฉ ุงูุฃูุฑูููุฉ ููุณูุฑู (ADA)..." ุฃู "ุญุณุจ ุชูุตูุงุช KDIGO ูุฃูุฑุงุถ ุงูููู...").</li>
            </ul>
        </div>
    </div>

    <div class="section financial-summary">
        <h4>4. ุงููุคุดุฑ ุงููุงูู:</h4>
        <table>
            <thead>
                <tr>
                    <th>ุงููุคุดุฑ</th>
                    <th>ุงููููุฉ (ุฑูุงู ุณุนูุฏู)</th>
                    <th>ููุงุญุธุงุช</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ุฅุฌูุงูู ุงูุฏุฎู ุงูุญุงูู (ุงููููุชุฑ)</td>
                    <td>[ุถุน ุงููููุฉ ููุง]</td>
                    <td>[ุถุน ุงูููุงุญุธุฉ ููุง]</td>
                </tr>
                <tr>
                    <td>ุฅุฌูุงูู ุงูุฏุฎู ุจุนุฏ ุฎุตู ุงูุฑููุถ ุงููุญุชููุฉ</td>
                    <td>[ุถุน ุงููููุฉ ููุง]</td>
                    <td>[ุถุน ุงูููุงุญุธุฉ ููุง]</td>
                </tr>
                <tr>
                    <td>ุฅุฌูุงูู ุงูุฏุฎู ุงููุญุชูู ูุน ุงูุชุญุณููุงุช</td>
                    <td>[ุถุน ุงููููุฉ ููุง]</td>
                    <td>[ุถุน ุงูููุงุญุธุฉ ููุง]</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h4>5. ุชูุตูุงุช ุนุงูุฉ ุดุงููุฉ:</h4>
        <p>ูุฏู ูุตุงุฆุญ ุนุงูุฉ ูุชุญุณูู ุงูุชุฑููุฒุ ุงูุชูุซููุ ูุงุฎุชูุงุฑ ุงูุฃุฏููุฉ ุจูุงุกู ุนูู ูุนุงููุชูุง ูุฎุตุงุฆุตูุง ุงูุฏูุงุฆูุฉ.</p>
    </div>

    **ูุงุนุฏุฉ ูููุฉ:** ูุง ุชุถุน ุฃุจุฏุงู ุฃู ุฑููุฒ ุชูุณูู ูุซู \`\`\`html ูู ุจุฏุงูุฉ ุฑุฏู. ูุฌุจ ุฃู ูุจุฏุฃ ุฑุฏู ูุจุงุดุฑุฉ ุจูุณู \`<h3>\`.
ย ย `;

ย const parts = [{ text: htmlPrompt }];
ย if (imageData) {
ย ย parts.push({
ย ย ย inline_data: {
ย ย ย ย mime_type: "image/jpeg",
ย ย ย ย data: imageData
ย ย ย }
ย ย });
ย }

ย const payload = {
ย ย contents: [{ parts: parts }],
ย ย generationConfig: {
ย ย ย temperature: 0.5,
ย ย },
ย };

ย try {
ย ย const response = await fetch(apiUrl, {
ย ย ย method: "POST",
ย ย ย headers: { "Content-Type": "application/json" },
ย ย ย body: JSON.stringify(payload),
ย ย });

ย ย if (!response.ok) {
ย ย ย const errorBody = await response.json();
ย ย ย console.error("๐ฅ Gemini API Error Response:", errorBody);
ย ย ย throw new Error(errorBody.error?.message || `API request failed: ${response.statusText}`);
ย ย }

ย ย const result = await response.json();
ย ย const reportHtml = result.candidates?.[0]?.content?.parts?.[0]?.text;

ย ย if (!reportHtml) {
ย ย ย throw new Error("ูู ูุชููู ุงููููุฐุฌ ูู ุฅูุดุงุก ุงูุชูุฑูุฑ.");
ย ย }
ย ยย
ย ย return res.status(200).json({ htmlReport: reportHtml });

ย } catch (err) {
ย ย console.error("๐ฅ Server-side Error:", err);
ย ย return res.status(500).json({
ย ย ย error: "ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู ุฃุซูุงุก ุชุญููู ุงูุญุงูุฉ",
ย ย ย detail: err.message,
ย ย });
ย }
}
