// api/gpt.js
export default async function handler(req, res) {
  // Set CORS headers
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

  if (req.method === "OPTIONS") return res.status(200).end();
  if (req.method !== "POST") return res.status(405).json({ error: "Method Not Allowed" });

  const apiKey = process.env.GEMINI_API_KEY;
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;
  
  let htmlPrompt;
  const requestBody = req.body;

  // --- Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ---
  if (requestBody.analysisType === 'doctor') {
    // Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ OCR
    htmlPrompt = `
      Ø£Ù†Øª "Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„" - Ù…Ø­Ø±Ùƒ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØ¬Ù…Ø¹ Ø®Ø¨Ø±Ø§Øª:
      [Ø§Ø³ØªØ´Ø§Ø±ÙŠ Ø¨Ø§Ø·Ù†Ø©ØŒ ØµÙŠØ¯Ù„ÙŠ Ø¥ÙƒÙ„ÙŠÙ†ÙŠÙƒÙŠØŒ Ù…Ø­Ù„Ù„ ØªØ£Ù…ÙŠÙ† Ø·Ø¨ÙŠØŒ Ø®Ø¨ÙŠØ± Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ«Ø§Ø¦Ù‚ Ø·Ø¨ÙŠØ©]

      ## Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØµØ§Ø±Ù…Ø©:
      1. **Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ OCR Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©**:
         - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªØµØ­ÙŠØ­ Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª:
           â€¢ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø§Ù„ØµÙˆØªÙŠ (Phonetic)
           â€¢ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø§Ù„Ø¨ØµØ±ÙŠ (Visual)
           â€¢ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø·Ø¨ÙŠ
         - Ù‚Ø§Ø¦Ù…Ø© ØªØµØ­ÙŠØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:
           "Ø³ÙŠÙ…ØºØ§Ø³Ù†Ø§Ù†ÙŠÙ†" â†’ "Ø³ÙŠÙ…ÙØ§Ø³ØªØ§ØªÙŠÙ†"
           "Ø£ÙˆØµÙŠØ±Ø§Ø²ÙˆÙ„" â†’ "Ø£ÙˆÙ…ÙŠØ¨Ø±Ø§Ø²ÙˆÙ„"
           "Ù…Ù„Ù" â†’ "Ù…Ù„Øº"
           "Ø«Ù„Ø«Ø§Ù‹" â†’ "ØªÙ„ÙØ§Ù‹"
           "Ø¨Ù„ÙˆÙ… ØªÙ‚Ø±ÙŠÙ…" â†’ "ÙŠÙ„Ø²Ù… ØªÙ‚Ø¯ÙŠÙ…"

      2. **Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ©**:
         - Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙÙ‚Ø· Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© ØµØ±Ø§Ø­Ø©
         - Ø¹Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ Ø£ÙŠ Ø£Ø¯ÙˆÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
         - Ù„ÙƒÙ„ Ø¯ÙˆØ§Ø¡: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:
           â€¢ Ø§Ù„Ø§Ø³Ù… (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©)
           â€¢ Ø§Ù„Ø¬Ø±Ø¹Ø© (Ø±Ù‚Ù… + ÙˆØ­Ø¯Ø© ØµØ§Ù„Ø­Ø©)
           â€¢ Ø§Ù„ØªÙƒØ±Ø§Ø± (ÙŠÙˆÙ…ÙŠØ§Ù‹ØŒ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹...)

      3. **Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ**:
         Ø£. Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©
         Ø¨. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¬Ø±Ø¹Ø©
         Ø¬. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³
         Ø¯. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø·Ø¨ÙŠ

      4. **Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠ**:
         ### Ø¬Ø¯ÙˆÙ„ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:
         | Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ     | Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØµØ­Ø­     | Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ | Ø§Ù„Ø³Ø¨Ø¨ |
         |-----------------|-----------------|-------------|--------|
         [ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹]

         ### Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©:
         | Ø§Ù„Ø¯ÙˆØ§Ø¡         | Ø§Ù„Ø¬Ø±Ø¹Ø©       | Ø§Ù„Ø­Ø§Ù„Ø©       |
         |----------------|--------------|--------------|
         [ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹]

      5. **Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„**:
         - Ù„ÙƒÙ„ Ø¯ÙˆØ§Ø¡ Ù…Ø¤ÙƒØ¯:
           â€¢ ØªÙ‚ÙŠÙŠÙ… Ø·Ø¨ÙŠ Ø´Ø§Ù…Ù„
           â€¢ ØªÙ‚ÙŠÙŠÙ… ØµÙŠØ¯Ù„Ø§Ù†ÙŠ
           â€¢ ØªÙ‚ÙŠÙŠÙ… ØªØ£Ù…ÙŠÙ†ÙŠ
         - ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©
         - ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø§Ù„ÙŠØ©

      ## Ù…Ø«Ø§Ù„ ØªØ·Ø¨ÙŠÙ‚ÙŠ:
      Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„: "Ø³ÙŠÙ…ØºØ§Ø³Ù†Ø§Ù†ÙŠÙ† 80 Ù…Ù„Ù ÙŠÙˆÙ…ÙŠØ§Ù‹"
      Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:
        1. Ø§Ù„ØªØµØ­ÙŠØ­: "Ø³ÙŠÙ…ÙØ§Ø³ØªØ§ØªÙŠÙ† 80 Ù…Ù„Øº ÙŠÙˆÙ…ÙŠØ§Ù‹"
        2. Ø§Ù„ØªØ­Ù‚Ù‚: âœ… (Ø¯ÙˆØ§Ø¡ Ù…Ø¹Ø±ÙˆÙØŒ Ø¬Ø±Ø¹Ø© ØµØ§Ù„Ø­Ø©)
        3. Ø§Ù„ØªØ­Ù„ÙŠÙ„: 
           - âŒ Ø¬Ø±Ø¹Ø© Ø¹Ø§Ù„ÙŠØ© Ø®Ø·ÙŠØ±Ø©
           - âš ï¸ Ø®Ø·Ø± ØªÙ„Ù Ø§Ù„Ø¹Ø¶Ù„Ø§Øª
           - ğŸ’° Ù…Ø±ÙÙˆØ¶ ØªØ£Ù…ÙŠÙ†ÙŠØ§Ù‹

      ## Ù‚ÙˆØ§Ø¹Ø¯ Ø­Ø§Ø³Ù…Ø©:
      - Ø¹Ø¯Ù… Ø°ÙƒØ± Ø£ÙŠ Ø¯ÙˆØ§Ø¡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
      - Ø¹Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬
      - Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„ÙˆØ§Ø¶Ø­Ø©
    `;
  } 
  // --- Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰ ---
  else if (requestBody.analysisType === 'patient') {
    const { symptoms, age, gender, smoker, vitals, labs, diagnosis, currentMedications } = requestBody;
    htmlPrompt = `
      Ø£Ù†Øª "Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ" - Ù†Ø¸Ø§Ù… Ø¯Ø¹Ù… Ù‚Ø±Ø§Ø±Ø§Øª Ø·Ø¨ÙŠØ© Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø±Ø¶Ù‰

      ## Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:
      1. Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø¹Ø±Ø§Ø¶
      2. ØªÙ‚Ø¯ÙŠÙ… ØªÙˆØµÙŠØ§Øª Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ù„Ø©
      3. Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø´Ø®ØµÙŠØ©

      ... [Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª] ...
    `;
  }

  // Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
  const parts = [{ text: htmlPrompt }];
  if (requestBody.imageData && Array.isArray(requestBody.imageData)) {
    requestBody.imageData.forEach(imgData => {
      parts.push({
        inlineData: {
          mimeType: "image/jpeg",
          data: imgData
        }
      });
    });
  }

  const payload = {
    contents: [{ parts: parts }],
    generationConfig: {
      temperature: 0.2,  // Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
      topK: 10,
      maxOutputTokens: 5000
    },
    safetySettings: [
      { category: "HARM_CATEGORY_MEDICAL", threshold: "BLOCK_NONE" },
      { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }
    ]
  };

  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!response.ok) {
      const errorBody = await response.json();
      throw new Error(errorBody.error?.message || `ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.statusText}`);
    }

    const result = await response.json();
    let reportHtml = result.candidates?.[0]?.content?.parts?.[0]?.text;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù‡Ù„ÙˆØ³Ø©
    if (reportHtml.includes("Ø³ÙŠÙ…ÙØ§Ø³ØªØ§ØªÙŠÙ†") && !requestBody.content?.includes("Ø³ÙŠÙ…ÙØ§Ø³ØªØ§ØªÙŠÙ†")) {
      reportHtml = `
        <div class="error-alert">
          <h3>âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©</h3>
          <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯ÙˆØ§Ø¡ "Ø³ÙŠÙ…ÙØ§Ø³ØªØ§ØªÙŠÙ†" ÙÙŠ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</p>
          <ul>
            <li>Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„: Ø¬ÙˆØ¯Ø© ØµÙˆØ±Ø© Ù…Ù†Ø®ÙØ¶Ø© Ø£Ùˆ Ø®Ø· ØºÙŠØ± ÙˆØ§Ø¶Ø­</li>
            <li>Ø§Ù„ØªÙˆØµÙŠØ©: Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­</li>
            <li>Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${extractedMeds.join(', ') || 'Ù„Ø§ Ø´ÙŠØ¡'}</li>
          </ul>
        </div>
      `;
    }

    return res.status(200).json({ htmlReport: reportHtml });

  } catch (err) {
    console.error("ğŸ”¥ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…:", err);
    return res.status(500).json({
      error: "ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø·Ø¨ÙŠØ©",
      detail: err.message,
      solution: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"
    });
  }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
function extractMedications(text) {
  const drugPatterns = [
    /(Ø³ÙŠÙ…ÙØ§Ø³ØªØ§ØªÙŠÙ†|Ø£ØªÙˆØ±ÙØ§Ø³ØªØ§ØªÙŠÙ†|Ø±ÙˆØ²ÙˆÙØ§Ø³ØªØ§ØªÙŠÙ†)/gi,
    /(Ø£ÙˆÙ…ÙŠØ¨Ø±Ø§Ø²ÙˆÙ„|Ù„Ø§Ù†Ø³ÙˆØ¨Ø±Ø§Ø²ÙˆÙ„|Ø¨Ø§Ù†ØªÙˆØ¨Ø±Ø§Ø²ÙˆÙ„)/gi,
    /(Ù…ÙŠØªÙÙˆØ±Ù…ÙŠÙ†|Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†|ØºÙ„ÙŠØ¨Ù†ÙƒÙ„Ø§Ù…ÙŠØ¯)/gi
  ];
  
  const medications = new Set();
  
  drugPatterns.forEach(pattern => {
    const matches = text.match(pattern);
    if (matches) {
      matches.forEach(match => medications.add(match));
    }
  });
  
  return Array.from(medications);
}
