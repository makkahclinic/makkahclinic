export const config = {
  api: {
    bodyParser: { sizeLimit: "50mb" },
    responseLimit: false,
  },
};

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

function extractBase64Data(dataUrl) {
  if (!dataUrl || !dataUrl.includes(',')) {
    throw new Error('ØµÙŠØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
  }
  return dataUrl.split(',')[1];
}

async function analyzeMedicalContent(files) {
  try {
    const model = genAI.getGenerativeModel({ 
      model: "gemini-1.5-pro",
      generationConfig: {
        temperature: 0.1,
        topP: 0.8,
        topK: 40,
        maxOutputTokens: 8192,
      }
    });

    const prompt = `
Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø·Ø¨ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆØ§Ù„ÙƒØ´Ù Ø¹Ù† Ø³ÙˆØ¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…. Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø·Ø¨ÙŠØ© Ø¨Ø¹Ù†Ø§ÙŠØ© ÙØ§Ø¦Ù‚Ø© ÙˆØ§Ø³ØªØ®Ø±Ø¬:

## ğŸ“‹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
1. **Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶**: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¹Ù…Ø±ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„ÙØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
2. **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨**: Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ØŒ Ø§Ù„ØªØ®ØµØµØŒ Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ Ø¥Ù† ÙˆØ¬Ø¯

## ğŸ—“ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹):
Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© Ø¹Ù„Ù‰ Ø­Ø¯Ø© ÙˆØ§Ø³ØªØ®Ø±Ø¬:
- **ØªØ§Ø±ÙŠØ® ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„** (Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§Ù„Ø´Ù‡Ø±ØŒ Ø§Ù„Ø³Ù†Ø©ØŒ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù† ÙˆØ¬Ø¯)
- **Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª** (Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹)
- **Ø³Ø¨Ø¨ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©** (Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø·ÙˆØ§Ø±Ø¦)
- **Ù…Ø¯Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø©** Ø¥Ù† ÙƒØ§Ù†Øª Ù…Ø°ÙƒÙˆØ±Ø©

## ğŸ”¬ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:
Ù„ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©ØŒ Ø§Ø³ØªØ®Ø±Ø¬:
- **Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©** Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ù‚ÙŠÙ‚
- **Ù†ÙˆØ¹ ÙƒÙ„ ÙØ­Øµ** (ØªØ­Ø§Ù„ÙŠÙ„ Ø¯Ù…ØŒ Ø£Ø´Ø¹Ø©ØŒ Ù…Ù†Ø§Ø¸ÙŠØ±ØŒ Ø¥Ù„Ø®)
- **Ø§Ù„Ù†ØªØ§Ø¦Ø¬** Ø¥Ù† ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
- **Ø§Ù„ØªÙƒÙ„ÙØ©** Ø¥Ù† ÙƒØ§Ù†Øª Ù…Ø°ÙƒÙˆØ±Ø©

## âš ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:
Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ­Ù„Ù„:
1. **Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©**:
   - ÙØ­ÙˆØµØ§Øª ØªÙ… Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
   - ÙØ­ÙˆØµØ§Øª ØªÙ… Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ù…Ø¨Ø±Ø± ÙˆØ§Ø¶Ø­
   - ÙØ­ÙˆØµØ§Øª ØªÙ… Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ø®Ù„Ø§Ù„ Ø´Ù‡Ø± Ø¨Ø¯ÙˆÙ† ØªØºÙŠØ± ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø©

2. **Ø§Ù„Ø¥ÙØ±Ø§Ø· ÙÙŠ Ø§Ù„ÙØ­ÙˆØµØ§Øª**:
   - Ø·Ù„Ø¨ ÙØ­ÙˆØµØ§Øª ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠØ© Ù„Ù„Ø­Ø§Ù„Ø©
   - Ø·Ù„Ø¨ ÙØ­ÙˆØµØ§Øª Ù…ÙƒÙ„ÙØ© Ø¨Ø¯ÙˆÙ† Ù…Ø¨Ø±Ø± Ù‚ÙˆÙŠ
   - Ø·Ù„Ø¨ ÙØ­ÙˆØµØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù…Ø´ÙƒÙ„Ø© Ù†ÙØ³Ù‡Ø§

3. **Ø£Ù†Ù…Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡Ø©**:
   - Ø²ÙŠØ§Ø±Ø§Øª Ù…ØªÙƒØ±Ø±Ø© Ø¨Ø¯ÙˆÙ† ØªØ­Ø³Ù† ÙˆØ§Ø¶Ø­
   - ØªØºÙŠÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¨Ø´ÙƒÙ„ Ù…ÙØ§Ø¬Ø¦
   - Ø¹Ø¯Ù… Ø§ØªØ¨Ø§Ø¹ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠØ©

## ğŸ’Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:
- **Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ù‚Ø±Ø±Ø©** ÙÙŠ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©
- **Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„Ù…Ø¯Ø©**
- **Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©**
- **Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ø£Ùˆ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©**

## ğŸ“Š Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…Ù‡Ù†ÙŠ:
Ù‚ÙŠÙ‘Ù…:
1. **Ù…Ø¯Ù‰ Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª** Ù„Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø©
2. **Ù…Ù†Ø·Ù‚ÙŠØ© Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠ** Ù„Ù„Ø¹Ù„Ø§Ø¬
3. **ÙØ¹Ø§Ù„ÙŠØ© Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©**
4. **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ©**

## ğŸš¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:
Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£ÙŠ Ù…Ø®Ø§Ù„ÙØ§ØªØŒ Ø§Ø°ÙƒØ±:
- **Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©** Ø¨Ø§Ù„ØªÙØµÙŠÙ„
- **Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯** Ù„Ù„Ù…Ø®Ø§Ù„ÙØ©
- **Ø§Ù„Ø¶Ø±Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„** Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙŠØ¶
- **Ø§Ù„ØªÙƒÙ„ÙØ© ØºÙŠØ± Ø§Ù„Ù…Ø¨Ø±Ø±Ø©**
- **Ø¯Ø±Ø¬Ø© Ø®Ø·ÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©** (Ù…Ù†Ø®ÙØ¶Ø©/Ù…ØªÙˆØ³Ø·Ø©/Ø¹Ø§Ù„ÙŠØ©)

## ğŸ“‹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
Ø§Ø³ØªØ®Ø¯Ù… HTML Ù…Ø¹:
- Ø¬Ø¯Ø§ÙˆÙ„ Ù…ÙØµÙ„Ø© Ù„Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ®
- Ø£Ù„ÙˆØ§Ù† ØªØ­Ø°ÙŠØ±ÙŠØ© Ù„Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·Ø±ØŒ Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„ØªØ­Ø°ÙŠØ±)
- Ø±Ù…ÙˆØ² Ù„Ù„ØªØµÙ†ÙŠÙ (âœ… Ø·Ø¨ÙŠØ¹ÙŠØŒ âš ï¸ Ù…Ø´Ø¨ÙˆÙ‡ØŒ âŒ Ù…Ø®Ø§Ù„ÙØ©)
- Ø®Ø· Ø²Ù…Ù†ÙŠ ÙˆØ§Ø¶Ø­ Ù„Ù„Ø£Ø­Ø¯Ø§Ø«

## ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…Ù‡Ù…Ø©:
- Ø§Ù‚Ø±Ø£ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨Ø¹Ù†Ø§ÙŠØ© ÙØ§Ø¦Ù‚Ø© (Ø§Ù†ØªØ¨Ù‡ Ù„Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©)
- Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ† ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„ÙØ­ÙˆØµØ§Øª
- Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªÙ†Ø§Ù‚Ø¶Ø§Øª ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ
- Ù„Ø§ ØªØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ ØªÙØµÙŠÙ„ ØµØºÙŠØ±
- ÙƒÙ† Ø¯Ù‚ÙŠÙ‚Ø§Ù‹ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
- Ø§Ø±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ ÙˆØ§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
`;

    const imageParts = files.map(file => ({
      inlineData: {
        data: extractBase64Data(file.data),
        mimeType: file.mimeType
      }
    }));

    const result = await model.generateContent([prompt, ...imageParts]);
    const response = await result.response;
    
    return response.text();

  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„:', error);
    throw new Error(`ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${error.message}`);
  }
}

async function generateAdvancedAnalysis(analysisResult, files) {
  if (!OPENAI_API_KEY) {
    return analysisResult;
  }

  const systemPrompt = `
Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆØ§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„ Ø§Ù„Ø·Ø¨ÙŠ. Ù…Ù‡Ù…ØªÙƒ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‚Ø¯Ù… ÙˆØ¥Ø¶Ø§ÙØ©:

1. **ØªØ­Ù„ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠ Ù…ØªÙ‚Ø¯Ù…**:
   - Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø´Ù‡Ø±ÙŠØ§Ù‹
   - Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ù„ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©
   - Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø·Ø©
   - Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©

2. **Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ÙƒØ´Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©**:
   - ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù†Ù…Ø§Ø· ØºÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
   - Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø± Ø§Ù„Ø®Ø·Ø± (Risk Score)
   - ØªØµÙ†ÙŠÙ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø´ØªØ¨Ø§Ù‡

3. **ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ø¹Ù† Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª**:
   - Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ù‚Ù…Ø© Ø¨Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
   - Ø§Ù„Ø£Ø¯Ù„Ø© Ù„ÙƒÙ„ Ù…Ø®Ø§Ù„ÙØ©
   - Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„ØµØ­ÙŠ

4. **ØªÙˆØµÙŠØ§Øª Ø¥Ø¬Ø±Ø§Ø¦ÙŠØ©**:
   - Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
   - Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø®ØªØµØ© Ù„Ù„Ø¥Ø¨Ù„Ø§Øº
   - Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©

Ø§Ø³ØªØ®Ø¯Ù… ØªÙ†Ø³ÙŠÙ‚ HTML Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¹ Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© Ù†ØµÙŠØ© ÙˆØ£Ù„ÙˆØ§Ù† ØªØ­Ø°ÙŠØ±ÙŠØ©.
`;

  try {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: "gpt-4o",
        messages: [
          { role: "system", content: systemPrompt },
          { 
            role: "user", 
            content: `Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ: ${analysisResult}\n\nØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: ${files.length}\nØ§Ù„ÙˆÙ‚Øª: ${new Date().toISOString()}` 
          },
        ],
        max_tokens: 4000,
        temperature: 0.1,
      }),
    });

    if (!response.ok) {
      throw new Error(`Ø®Ø·Ø£ ÙÙŠ OpenAI API: ${response.status}`);
    }

    const data = await response.json();
    return data?.choices?.[0]?.message?.content || analysisResult;

  } catch (error) {
    console.warn(`ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…: ${error.message}`);
    return analysisResult;
  }
}

export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  if (req.method !== "POST") {
    return res.status(405).json({ 
      error: "Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø© - Ø§Ø³ØªØ®Ø¯Ù… POST ÙÙ‚Ø·"
    });
  }

  try {
    const { files, analysisType = 'comprehensive' } = req.body;

    if (!files || !Array.isArray(files) || files.length === 0) {
      return res.status(400).json({ 
        error: "Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©"
      });
    }

    if (!GEMINI_API_KEY) {
      return res.status(500).json({ 
        error: "Ù…ÙØªØ§Ø­ Gemini API ØºÙŠØ± Ù…ØªÙˆÙØ±"
      });
    }

    console.log(`Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù€ ${files.length} Ù…Ù„Ù(Ø§Øª)`);

    // Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ù…ÙØµÙ„
    const analysisResult = await analyzeMedicalContent(files);

    // Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† OpenAI Ù…ØªØ§Ø­Ø§Ù‹
    let finalReport = analysisResult;
    if (OPENAI_API_KEY && analysisType === 'comprehensive') {
      try {
        finalReport = await generateAdvancedAnalysis(analysisResult, files);
      } catch (enhancementError) {
        console.warn('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:', enhancementError.message);
      }
    }

    const responseData = {
      success: true,
      html: finalReport,
      structured: {
        analysisType: 'medical-practice-audit',
        filesAnalyzed: files.length,
        timestamp: new Date().toISOString(),
        model: "gemini-1.5-pro",
        enhanced: !!OPENAI_API_KEY,
        features: [
          'ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø²ÙŠØ§Ø±Ø§Øª',
          'ÙƒØ´Ù Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©', 
          'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©',
          'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©',
          'Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ØºÙŠØ± Ø§Ù„Ù…Ø¨Ø±Ø±Ø©'
        ]
      }
    };

    return res.status(200).json(responseData);

  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…:", error);
    
    return res.status(500).json({ 
      error: `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${error.message}`,
      type: error.constructor.name,
      timestamp: new Date().toISOString()
    });
  }
}
