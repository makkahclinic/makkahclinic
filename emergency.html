<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background 0.5s ease;
            color: #fff;
        }
        
        body.safe {
            background: linear-gradient(135deg, #166534 0%, #14532d 50%, #052e16 100%);
        }
        
        body.fire {
            background: linear-gradient(135deg, #DC143C, #7f1d1d);
            animation: emergencyPulse 0.5s ease-in-out infinite alternate;
        }
        
        body.injury {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        body.infection {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        }
        
        body.power {
            background: linear-gradient(135deg, #eab308, #ca8a04);
        }
        
        body.water {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
        }
        
        body.other {
            background: linear-gradient(135deg, #475569, #334155);
        }
        
        @keyframes emergencyPulse {
            0% { filter: brightness(1); }
            100% { filter: brightness(0.8); }
        }
        
        /* ========== POLICE / EVAC EMERGENCY LIGHTS (Strong) ========== */
        .emergency-lights{
          display:none;
          position:fixed;
          inset:0;
          pointer-events:none;
          z-index:9999;
          overflow:hidden;
          mix-blend-mode:screen;
        }

        .emergency-lights.active{ display:block; }

        /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ/Ø³ÙÙ„ÙŠ Ø£Ø¹Ø±Ø¶ + Ø£Ù‚ÙˆÙ‰ */
        .light-bar{
          position:absolute;
          left:0; right:0;
          height:38px;
          display:flex;
          filter:saturate(1.4) contrast(1.2);
        }
        .light-bar.top{ top:0; }
        .light-bar.bottom{ bottom:0; }

        .light-left,.light-right{
          flex:1;
          opacity:.12;
          transform:translateZ(0);
        }

        /* Ù†Ù…Ø· Ø³ØªØ±ÙˆØ¨ Ù…Ø²Ø¯ÙˆØ¬ (Ø¯Ù‚Ø¯Ù‚ØªÙŠÙ†) Ù…Ø«Ù„ Ø§Ù„Ø´Ø±Ø·Ø© */
        .light-left{
          background:linear-gradient(90deg, rgba(255,0,0,1), rgba(255,0,0,.7));
          box-shadow:0 0 120px 70px rgba(255,0,0,.95);
          animation: doubleStrobeRed .9s infinite steps(1,end);
        }

        .light-right{
          background:linear-gradient(90deg, rgba(0,120,255,.7), rgba(0,120,255,1));
          box-shadow:0 0 120px 70px rgba(0,120,255,.95);
          animation: doubleStrobeBlue .9s infinite steps(1,end);
          animation-delay:.45s;
        }

        /* Ø¬ÙˆØ§Ù†Ø¨ Ø£Ø¶ÙŠÙ‚ Ù„ÙƒÙ† Ø£Ù‚ÙˆÙ‰ */
        .side-light{
          position:absolute;
          top:38px; bottom:38px;
          width:34px;
          opacity:.1;
          filter:saturate(1.6);
        }
        .side-light.left{
          left:0;
          background:rgba(255,0,0,1);
          box-shadow:0 0 110px 60px rgba(255,0,0,.85);
          animation: sidePulse .9s infinite steps(1,end);
        }
        .side-light.right{
          right:0;
          background:rgba(0,120,255,1);
          box-shadow:0 0 110px 60px rgba(0,120,255,.85);
          animation: sidePulse .9s infinite steps(1,end);
          animation-delay:.45s;
        }

        /* Ø³ØªØ±ÙˆØ¨ Ø²ÙˆØ§ÙŠØ§ (Ù‚ØµÙŠØ± Ù‚ÙˆÙŠ) */
        .corner-strobe{
          position:absolute;
          width:140px;
          height:140px;
          border-radius:50%;
          opacity:0;
          filter:blur(.2px);
        }
        .corner-strobe.top-left{
          top:-40px; left:-40px;
          background:radial-gradient(circle, rgba(255,0,0,1) 25%, rgba(255,0,0,0) 70%);
          box-shadow:0 0 170px 95px rgba(255,0,0,.9);
          animation: cornerStrobe .9s infinite steps(1,end);
        }
        .corner-strobe.top-right{
          top:-40px; right:-40px;
          background:radial-gradient(circle, rgba(0,120,255,1) 25%, rgba(0,120,255,0) 70%);
          box-shadow:0 0 170px 95px rgba(0,120,255,.9);
          animation: cornerStrobe .9s infinite steps(1,end);
          animation-delay:.45s;
        }
        .corner-strobe.bottom-left{
          bottom:-40px; left:-40px;
          background:radial-gradient(circle, rgba(255,0,0,1) 25%, rgba(255,0,0,0) 70%);
          box-shadow:0 0 170px 95px rgba(255,0,0,.9);
          animation: cornerStrobe .9s infinite steps(1,end);
          animation-delay:.12s;
        }
        .corner-strobe.bottom-right{
          bottom:-40px; right:-40px;
          background:radial-gradient(circle, rgba(0,120,255,1) 25%, rgba(0,120,255,0) 70%);
          box-shadow:0 0 170px 95px rgba(0,120,255,.9);
          animation: cornerStrobe .9s infinite steps(1,end);
          animation-delay:.57s;
        }

        /* Ù…Ø³Ø­ Ø¶ÙˆØ¦ÙŠ ÙŠÙ…Ø± Ø¹Ø¨Ø± Ø§Ù„Ø´Ø§Ø´Ø© (ÙŠØ¹Ø·ÙŠ Ø§Ù„Ø±Ù‡Ø¨Ø©) */
        .emergency-lights::before{
          content:"";
          position:absolute;
          inset:-20%;
          background:linear-gradient(
            90deg,
            rgba(255,0,0,0) 0%,
            rgba(255,0,0,.22) 15%,
            rgba(255,0,0,0) 35%,
            rgba(0,120,255,0) 50%,
            rgba(0,120,255,.22) 65%,
            rgba(0,120,255,0) 85%,
            rgba(0,120,255,0) 100%
          );
          transform:translateX(-35%);
          animation: sweep 1.15s linear infinite;
          pointer-events:none;
        }

        /* ÙˆÙ…ÙŠØ¶ Ø´Ø§Ø´Ø© Ù‚ØµÙŠØ± (flash) Ø¨Ø¯Ù„ Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ù…Ø³ØªÙ…Ø± */
        .emergency-lights::after{
          content:"";
          position:absolute;
          inset:0;
          background:rgba(255,255,255,0);
          animation: shockFlash .9s infinite steps(1,end);
          pointer-events:none;
        }

        /* ====== Keyframes ====== */

        /* Ø³ØªØ±ÙˆØ¨ Ù…Ø²Ø¯ÙˆØ¬: Ø¯Ù‚Ø¯Ù‚ØªÙŠÙ† Ø³Ø±ÙŠØ¹ + Ø³ÙƒÙˆÙ† */
        @keyframes doubleStrobeRed{
          0%{opacity:.08}
          6%{opacity:.95}
          10%{opacity:.10}
          16%{opacity:.95}
          20%{opacity:.08}
          100%{opacity:.08}
        }
        @keyframes doubleStrobeBlue{
          0%{opacity:.08}
          6%{opacity:.95}
          10%{opacity:.10}
          16%{opacity:.95}
          20%{opacity:.08}
          100%{opacity:.08}
        }

        @keyframes cornerStrobe{
          0%{opacity:0}
          5%{opacity:1}
          8%{opacity:0}
          14%{opacity:1}
          18%{opacity:0}
          100%{opacity:0}
        }

        @keyframes sidePulse{
          0%{opacity:.06}
          6%{opacity:.65}
          10%{opacity:.08}
          16%{opacity:.65}
          20%{opacity:.06}
          100%{opacity:.06}
        }

        @keyframes sweep{
          0%{transform:translateX(-55%)}
          100%{transform:translateX(55%)}
        }

        /* ÙÙ„Ø§Ø´ Ø£Ø¨ÙŠØ¶ Ø®ÙÙŠÙ Ù„Ø­Ø¸ÙŠ (ÙŠØ¹Ø·ÙŠ Ø¥Ø­Ø³Ø§Ø³ Ø¥Ù†Ø°Ø§Ø±) */
        @keyframes shockFlash{
          0%{background:rgba(255,255,255,0)}
          6%{background:rgba(255,255,255,.09)}
          10%{background:rgba(255,255,255,0)}
          16%{background:rgba(255,255,255,.07)}
          20%{background:rgba(255,255,255,0)}
          100%{background:rgba(255,255,255,0)}
        }

        /* Ø§Ø­ØªØ±Ø§Ù… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© */
        @media (prefers-reduced-motion: reduce){
          .light-left,.light-right,.side-light,.corner-strobe,
          .emergency-lights::before,.emergency-lights::after{
            animation:none !important;
            opacity:.12 !important;
          }
        }
        
        .container {
            text-align: center;
            padding: 5px;
            width: 100%;
            max-width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }
        
        .safe-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .safe-screen.hidden {
            display: none;
        }
        
        .logo-container {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: logoPulse 3s ease-in-out infinite;
            border: 2px solid rgba(201, 169, 98, 0.5);
            overflow: hidden;
        }
        
        .logo-container img {
            width: 70px;
            height: auto;
        }
        
        .logo-fallback {
            display: none;
        }
        
        @keyframes logoPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 30px rgba(201, 169, 98, 0.3);
            }
            50% { 
                transform: scale(1.03); 
                box-shadow: 0 0 50px rgba(201, 169, 98, 0.5);
            }
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(34, 197, 94, 0.2);
            padding: 10px 25px;
            border-radius: 50px;
            border: 2px solid rgba(34, 197, 94, 0.5);
        }
        
        .status-badge i {
            font-size: 1.8rem;
            color: #22c55e;
            animation: checkPulse 2s ease-in-out infinite;
        }
        
        .status-badge span {
            font-size: 1.8rem;
            font-weight: 900;
            color: #22c55e;
        }
        
        @keyframes checkPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .clinic-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #c9a962;
            margin-top: 5px;
        }
        
        .current-time {
            font-size: 2.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .date-display {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 3px;
        }
        
        .connection-indicator {
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            transition: all 0.3s ease;
        }
        
        .connection-indicator.connected {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }
        
        .connection-indicator.polling {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border: 1px solid #eab308;
        }
        
        .connection-indicator i {
            font-size: 0.7rem;
        }
        
        .emergency-screen {
            display: none;
        }
        
        .emergency-screen.active {
            display: block;
        }
        
        /* Badge ØªÙ…Ø±ÙŠÙ† */
        .drill-badge {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 6px 20px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 900;
            margin-bottom: 3px;
            animation: drillPulse 1.5s infinite;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
        }
        
        @keyframes drillPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.6); }
            50% { box-shadow: 0 0 50px rgba(34, 197, 94, 0.9); }
        }
        
        body.drill {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            animation: none !important;
        }
        
        body.control-mode {
            background: linear-gradient(135deg, #1e3a5f, #0f172a);
            animation: none !important;
        }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .control-panel {
            display: none;
            text-align: center;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .control-panel.active {
            display: block;
        }
        
        .control-header {
            margin-bottom: 25px;
        }
        
        .control-header h1 {
            font-size: 1.6rem;
            color: #c9a962;
            margin-bottom: 8px;
        }
        
        .control-header p {
            color: rgba(255,255,255,0.7);
            font-size: 0.95rem;
        }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .scenario-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .scenario-card:hover {
            transform: scale(1.03);
            background: rgba(255,255,255,0.15);
        }
        
        .scenario-card.selected {
            border-color: #c9a962;
            background: rgba(201, 169, 98, 0.2);
            box-shadow: 0 0 20px rgba(201, 169, 98, 0.3);
        }
        
        .scenario-card i {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }
        
        .scenario-card.fire i { color: #ef4444; }
        .scenario-card.power i { color: #f59e0b; }
        .scenario-card.water i { color: #3b82f6; }
        .scenario-card.medical i { color: #22c55e; }
        .scenario-card.infection i { color: #8b5cf6; }
        .scenario-card.drill i { color: #10b981; }
        
        .scenario-card span {
            display: block;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .drill-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 20px;
            cursor: pointer;
        }
        
        .drill-toggle input {
            width: 20px;
            height: 20px;
            accent-color: #10b981;
        }
        
        .drill-toggle label {
            font-size: 1rem;
            color: #10b981;
            font-weight: 600;
            cursor: pointer;
        }
        
        .activate-control-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .activate-control-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
        }
        
        .activate-control-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .activate-control-btn.drill-mode {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .back-link {
            margin-top: 20px;
            display: inline-block;
            color: rgba(255,255,255,0.6);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .back-link:hover {
            color: #fff;
        }
        
        /* Ù…Ù„Ø®Øµ Ø§Ù„Ø®Ø·ÙˆØ§Øª */
        .steps-summary {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 8px 12px;
            margin: 5px 0;
            text-align: right;
        }
        
        .steps-summary h3 {
            color: #fbbf24;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .steps-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 3px 15px;
        }
        
        .step-item-mini {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 0;
        }
        
        .step-num-mini {
            background: #fbbf24;
            color: #000;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .step-text-mini {
            font-size: 0.85rem;
            line-height: 1.3;
            font-weight: 500;
        }
        
        @media (min-width: 1200px) {
            .step-text-mini {
                font-size: 1rem;
            }
            .step-num-mini {
                width: 24px;
                height: 24px;
                font-size: 0.85rem;
            }
            .steps-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .emergency-logo {
            width: 40px;
            height: 40px;
            margin: 0 auto 3px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .emergency-logo img {
            width: 26px;
            height: auto;
        }
        
        .emergency-icon {
            font-size: 2rem;
            animation: iconBlink 0.5s ease-in-out infinite alternate;
            margin-bottom: 0;
        }
        
        @keyframes iconBlink {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .emergency-screen h1 {
            font-size: 1.4rem;
            font-weight: 900;
            margin-bottom: 2px;
            text-shadow: 0 3px 15px rgba(0,0,0,0.5);
            animation: textBlink 0.6s ease-in-out infinite alternate;
        }
        
        @keyframes textBlink {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .emergency-type {
            font-size: 1rem;
            background: rgba(0,0,0,0.5);
            padding: 4px 16px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 3px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .instruction-box {
            background: rgba(0,0,0,0.4);
            padding: 5px;
            border-radius: 10px;
            margin: 3px 0;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .instruction-box h2 {
            font-size: 0.9rem;
            margin-bottom: 2px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .instruction-box .location {
            font-size: 1.8rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 3px 10px rgba(0,0,0,0.5);
        }
        
        .muster-point {
            background: rgba(34,197,94,0.3);
            padding: 5px;
            border-radius: 10px;
            margin-top: 3px;
            border: 2px solid rgba(34,197,94,0.5);
        }
        
        .muster-point h3 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .muster-point .point-name {
            font-size: 1.1rem;
            font-weight: 900;
            color: #86efac;
        }
        
        .timer {
            margin-top: 4px;
            font-size: 0.85rem;
        }
        
        .timer .time-display {
            font-size: 1.4rem;
            font-weight: 900;
            font-family: monospace;
        }
        
        .emergency-numbers {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .emergency-number {
            background: rgba(0,0,0,0.4);
            padding: 3px 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .emergency-number i {
            font-size: 0.75rem;
        }
        
        .emergency-number span {
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .footer {
            padding: 4px;
            text-align: center;
            font-size: 0.7rem;
            opacity: 0.7;
            background: rgba(0,0,0,0.2);
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .logo-container {
                width: 120px;
                height: 120px;
            }
            
            .logo-container img {
                width: 90px;
            }
            
            .status-badge {
                padding: 10px 25px;
            }
            
            .status-badge i {
                font-size: 1.8rem;
            }
            
            .status-badge span {
                font-size: 1.8rem;
            }
            
            .clinic-name {
                font-size: 1.4rem;
            }
            
            .current-time {
                font-size: 3rem;
            }
            
            .emergency-screen h1 {
                font-size: 2.5rem;
            }
            
            .emergency-type {
                font-size: 1.5rem;
                padding: 12px 25px;
            }
            
            .instruction-box .location {
                font-size: 2rem;
            }
            
            .emergency-icon {
                font-size: 5rem;
            }
            
            .timer .time-display {
                font-size: 3rem;
            }
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        .start-screen {
          position: fixed;
          inset: 0;
          background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          text-align: center;
          padding: 20px;
        }
        .start-screen.hidden { display: none; }
        
        .start-logo {
          width: 120px;
          height: 120px;
          background: rgba(255,255,255,0.1);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 25px;
          border: 3px solid rgba(201, 169, 98, 0.5);
        }
        .start-logo img {
          width: 80px;
          height: auto;
        }
        
        .start-title {
          font-size: 1.8rem;
          font-weight: 900;
          color: #c9a962;
          margin-bottom: 10px;
        }
        
        .start-subtitle {
          font-size: 1.1rem;
          color: rgba(255,255,255,0.8);
          margin-bottom: 30px;
          line-height: 1.6;
        }
        
        .start-btn {
          background: linear-gradient(135deg, #22c55e, #16a34a);
          color: #fff;
          border: none;
          padding: 20px 50px;
          font-size: 1.4rem;
          font-weight: 900;
          border-radius: 60px;
          cursor: pointer;
          box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4);
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .start-btn:hover {
          transform: scale(1.05);
          box-shadow: 0 12px 40px rgba(34, 197, 94, 0.5);
        }
        .start-btn i {
          margin-left: 10px;
        }
        
        .start-note {
          margin-top: 25px;
          font-size: 0.9rem;
          color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body class="safe">
    <!-- ØªØ£Ø«ÙŠØ± Ø£Ø¶ÙˆØ§Ø¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙˆØ§Ù…Ø¶Ø© -->
    <div id="emergencyLights" class="emergency-lights">
        <div class="light-bar top">
            <div class="light-left"></div>
            <div class="light-right"></div>
        </div>
        <div class="light-bar bottom">
            <div class="light-left"></div>
            <div class="light-right"></div>
        </div>
        <div class="side-light left"></div>
        <div class="side-light right"></div>
        <div class="corner-strobe top-left"></div>
        <div class="corner-strobe top-right"></div>
        <div class="corner-strobe bottom-left"></div>
        <div class="corner-strobe bottom-right"></div>
    </div>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div class="start-screen" id="startScreen">
      <div class="start-logo">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹">
      </div>
      <div class="start-title">Ù†Ø¸Ø§Ù… Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</div>
      <div class="start-subtitle">
        Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©<br>
        Ø³ÙŠØµØ¯Ø± ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø£ÙŠ Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦
      </div>
      <button class="start-btn" id="startBtn">
        <i class="fas fa-bell"></i>
        Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
      </button>
      <div class="start-note">Ø§ØªØ±Ùƒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø©</div>
    </div>
    <div class="container">
        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… (ØªØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­ÙƒÙ…) -->
        <div class="control-panel" id="controlPanel">
            <div class="control-header">
                <h1><i class="fas fa-broadcast-tower"></i> ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h1>
                <p>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù„Ù„ØªÙØ¹ÙŠÙ„</p>
            </div>
            
            <div class="scenario-grid">
                <div class="scenario-card fire" onclick="selectScenario('fire', event)">
                    <i class="fas fa-fire"></i>
                    <span>Ø­Ø±ÙŠÙ‚</span>
                </div>
                <div class="scenario-card power" onclick="selectScenario('power', event)">
                    <i class="fas fa-bolt"></i>
                    <span>Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒÙ‡Ø±Ø¨Ø§Ø¡</span>
                </div>
                <div class="scenario-card water" onclick="selectScenario('water', event)">
                    <i class="fas fa-tint"></i>
                    <span>ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡</span>
                </div>
                <div class="scenario-card medical" onclick="selectScenario('injury', event)">
                    <i class="fas fa-heartbeat"></i>
                    <span>Ø¥ØºÙ…Ø§Ø¡/Ø¥ØµØ§Ø¨Ø©</span>
                </div>
                <div class="scenario-card infection" onclick="selectScenario('infection', event)">
                    <i class="fas fa-virus"></i>
                    <span>ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰</span>
                </div>
            </div>
            
            <div class="drill-toggle" onclick="toggleDrill(event)">
                <input type="checkbox" id="drillCheckbox">
                <label for="drillCheckbox">ğŸ¯ ØªÙ…Ø±ÙŠÙ† ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØµÙˆØª)</label>
            </div>
            
            <button class="activate-control-btn" id="activateControlBtn" onclick="activateFromControl()" disabled>
                <i class="fas fa-bell"></i>
                <span>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø£ÙˆÙ„Ø§Ù‹</span>
            </button>
            
            <a href="eoc-command.html" class="back-link">
                <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
            </a>
        </div>
        
        <div class="safe-screen" id="safeScreen">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹" id="logoImg">
            </div>
            
            <div class="status-badge">
                <i class="fas fa-shield-check"></i>
                <span>Ø§Ù„ÙˆØ¶Ø¹ Ø¢Ù…Ù†</span>
            </div>
            
            <div class="clinic-name">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</div>
            
            <div class="current-time" id="currentTime">--:--</div>
            <div class="date-display" id="currentDate">--</div>
            <div class="connection-indicator polling" id="connectionIndicator" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„">
                <i class="fas fa-wifi"></i>
                <span class="status-text">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„...</span>
            </div>
        </div>
        
        <div class="emergency-screen" id="emergencyScreen">
            <div class="emergency-logo">
                <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹">
            </div>
            <div class="drill-badge" id="drillBadge" style="display: none;">
                ğŸ¯ ØªÙ…Ø±ÙŠÙ† - DRILL
            </div>
            <div class="emergency-icon" id="emergencyIcon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h1 id="emergencyTitle">ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦</h1>
            <div class="emergency-type" id="emergencyType">-</div>
            
            <div class="instruction-box">
                <h2 id="instructionTitle">Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª:</h2>
                <div class="location" id="emergencyLocation">-</div>
            </div>
            
            <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø®Ø·ÙˆØ§Øª -->
            <div class="steps-summary" id="stepsSummary" style="display: none;">
                <h3><i class="fas fa-list-ol"></i> Ø§Ù„Ø®Ø·ÙˆØ§Øª:</h3>
                <div id="stepsContent" class="steps-container"></div>
            </div>
            
            <div class="muster-point" id="musterSection" style="display: none;">
                <h3><i class="fas fa-location-arrow"></i> Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰:</h3>
                <div class="point-name" id="musterPoint">-</div>
            </div>
            
            <div class="timer">
                <span>Ø§Ù„ÙˆÙ‚Øª Ù…Ù†Ø° Ø§Ù„Ø¨Ù„Ø§Øº:</span>
                <span class="time-display" id="elapsedTime">00:00</span>
            </div>
            
            <div class="emergency-numbers" id="emergencyNumbers">
                <div class="emergency-number">
                    <i class="fas fa-phone"></i>
                    <span>911</span>
                </div>
                <div class="emergency-number">
                    <i class="fas fa-fire-extinguisher"></i>
                    <span>998</span>
                </div>
                <div class="emergency-number">
                    <i class="fas fa-ambulance"></i>
                    <span>997</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ù†Ø¸Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
    </div>

    <audio id="fallbackAlarm" preload="auto" loop style="display:none;">
      <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <div id="soundGate" class="sound-gate hidden">
      <button id="enableSoundBtn" class="sound-btn">
        <i class="fas fa-volume-up"></i> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª
      </button>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbytslZrI7jIgUY0iavZPfgOiEPZKgkjFaNgTBCcWByHLARdEFb4Qkzi4Ecad0v_Q7SL1w/exec';

        let currentCommand = null;
        let sirenInterval = null;
        let timerInterval = null;
        let commandStartTime = null;

        // Web Audio API Siren System
        let audioCtx = null;
        let sirenOsc1 = null;
        let sirenOsc2 = null;
        let sirenGain = null;
        let sirenPlaying = false;

        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(e => console.warn('AudioContext resume failed:', e));
            }
        }

        async function ensureAudioReady() {
            initAudioContext();
            if (audioCtx && audioCtx.state === 'suspended') {
                try { await audioCtx.resume(); } catch(e) {}
            }
            if (audioCtx && audioCtx.state !== 'running') {
                try {
                    audioCtx.close();
                    audioCtx = null;
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    await audioCtx.resume();
                } catch(e) { console.warn('Audio recreate failed:', e); }
            }
        }

        setInterval(() => {
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume().catch(() => {});
            }
        }, 3000);

        function startSiren() {
            try {
                initAudioContext();
                if (sirenPlaying) return;
                sirenPlaying = true;

                if (!audioCtx || audioCtx.state !== 'running') {
                    playFallbackAlarm();
                    showSoundGate();
                    return;
                }

                sirenGain = audioCtx.createGain();
                sirenGain.gain.value = 0.6;
                sirenGain.connect(audioCtx.destination);

                sirenOsc1 = audioCtx.createOscillator();
                sirenOsc1.type = 'sawtooth';
                sirenOsc1.frequency.value = 600;
                sirenOsc1.connect(sirenGain);
                sirenOsc1.start();

                sirenOsc2 = audioCtx.createOscillator();
                sirenOsc2.type = 'square';
                sirenOsc2.frequency.value = 800;
                sirenOsc2.connect(sirenGain);
                sirenOsc2.start();

                let ascending = true;
                sirenInterval = setInterval(() => {
                    if (!sirenOsc1 || !sirenOsc2) return;
                    const now = audioCtx.currentTime;
                    if (ascending) {
                        sirenOsc1.frequency.linearRampToValueAtTime(1200, now + 0.5);
                        sirenOsc2.frequency.linearRampToValueAtTime(1400, now + 0.5);
                    } else {
                        sirenOsc1.frequency.linearRampToValueAtTime(400, now + 0.5);
                        sirenOsc2.frequency.linearRampToValueAtTime(600, now + 0.5);
                    }
                    ascending = !ascending;
                }, 500);

            } catch(e) {
                console.error('Siren error:', e);
                playFallbackAlarm();
                showSoundGate();
            }
        }

        function playFallbackAlarm() {
            try {
                const audio = document.getElementById('fallbackAlarm');
                if (audio) {
                    audio.currentTime = 0;
                    audio.volume = 1;
                    audio.play().catch(() => {
                        console.warn('Fallback audio blocked too');
                        showSoundGate();
                    });
                }
            } catch(e) {}
        }

        function stopFallbackAlarm() {
            try {
                const audio = document.getElementById('fallbackAlarm');
                if (audio) { audio.pause(); audio.currentTime = 0; }
            } catch(e) {}
        }

        function stopSiren() {
            sirenPlaying = false;
            if (sirenInterval) {
                clearInterval(sirenInterval);
                sirenInterval = null;
            }
            try {
                if (sirenOsc1) { sirenOsc1.stop(); sirenOsc1.disconnect(); sirenOsc1 = null; }
                if (sirenOsc2) { sirenOsc2.stop(); sirenOsc2.disconnect(); sirenOsc2 = null; }
                if (sirenGain) { sirenGain.disconnect(); sirenGain = null; }
            } catch(e) {}
        }

        // ========== ØµÙˆØª Ù†Ø¨Ø¶Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ (Ù„Ù„ØªÙˆØ¬ÙŠÙ‡) ==========
        let heartbeatInterval = null;
        let heartbeatPlaying = false;
        
        function startHeartbeat() {
            try {
                initAudioContext();
                if (heartbeatPlaying) return;
                heartbeatPlaying = true;
                
                function playBeat() {
                    if (!heartbeatPlaying) return;
                    
                    // Ù†Ø¨Ø¶Ø© Ù‚ÙˆÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… oscillators Ù…ØªØ¹Ø¯Ø¯Ø©
                    const osc1 = audioCtx.createOscillator();
                    const osc2 = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    
                    osc1.type = 'sine';
                    osc1.frequency.value = 60; // bass Ø¹Ù…ÙŠÙ‚
                    osc2.type = 'sine';
                    osc2.frequency.value = 120; // Ø·Ø¨Ù‚Ø© Ø«Ø§Ù†ÙŠØ©
                    
                    osc1.connect(gain);
                    osc2.connect(gain);
                    gain.connect(audioCtx.destination);
                    
                    const now = audioCtx.currentTime;
                    
                    // Ø¯ÙˆÙ…-Ø¯ÙˆÙ… Ø£ÙˆÙ„ (Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹)
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(1.0, now + 0.03);
                    gain.gain.linearRampToValueAtTime(0.3, now + 0.1);
                    gain.gain.linearRampToValueAtTime(0, now + 0.18);
                    
                    // Ø¯ÙˆÙ…-Ø¯ÙˆÙ… Ø«Ø§Ù†ÙŠ (Ù‚ÙˆÙŠ)
                    gain.gain.linearRampToValueAtTime(0.9, now + 0.25);
                    gain.gain.linearRampToValueAtTime(0.2, now + 0.32);
                    gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    
                    osc1.start(now);
                    osc2.start(now);
                    osc1.stop(now + 0.45);
                    osc2.stop(now + 0.45);
                }
                
                playBeat();
                heartbeatInterval = setInterval(playBeat, 700);
                
            } catch(e) {
                console.error('Heartbeat error:', e);
                showSoundGate();
            }
        }
        
        function stopHeartbeat() {
            heartbeatPlaying = false;
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // ========== ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¹Ø²Ù„ (Ù„Ù„Ø¹Ø¯ÙˆÙ‰) ==========
        let isolationInterval = null;
        let isolationPlaying = false;
        
        function startIsolationAlert() {
            try {
                initAudioContext();
                if (isolationPlaying) return;
                isolationPlaying = true;
                
                function playAlert() {
                    if (!isolationPlaying) return;
                    
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    
                    osc.type = 'triangle';
                    osc.frequency.value = 520;
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    
                    const now = audioCtx.currentTime;
                    
                    // 3 beeps Ø³Ø±ÙŠØ¹Ø©
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.6, now + 0.05);
                    gain.gain.linearRampToValueAtTime(0, now + 0.12);
                    
                    gain.gain.linearRampToValueAtTime(0.6, now + 0.18);
                    gain.gain.linearRampToValueAtTime(0, now + 0.25);
                    
                    gain.gain.linearRampToValueAtTime(0.6, now + 0.31);
                    gain.gain.linearRampToValueAtTime(0, now + 0.38);
                    
                    osc.start(now);
                    osc.stop(now + 0.5);
                }
                
                playAlert();
                isolationInterval = setInterval(playAlert, 1200);
                
            } catch(e) {
                console.error('Isolation alert error:', e);
                showSoundGate();
            }
        }
        
        function stopIsolationAlert() {
            isolationPlaying = false;
            if (isolationInterval) {
                clearInterval(isolationInterval);
                isolationInterval = null;
            }
        }

        function stopAllSounds() {
            stopSiren();
            stopHeartbeat();
            stopIsolationAlert();
            stopFallbackAlarm();
        }

        // ========== Text-to-Speech Ù„Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµÙˆØªÙŠØ© ==========
        let bestArabicVoice = null;
        
        function findBestArabicVoice() {
            const voices = speechSynthesis.getVoices();
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙØ¶Ù„ÙŠØ©: Google Arabic > Microsoft Arabic > Ø£ÙŠ ØµÙˆØª Ø¹Ø±Ø¨ÙŠ
            const priorities = [
                v => v.name.includes('Google') && v.lang.startsWith('ar'),
                v => v.name.includes('Microsoft') && v.lang.startsWith('ar'),
                v => v.name.includes('Majed') || v.name.includes('Ù…Ø§Ø¬Ø¯'),
                v => v.name.includes('Hoda') || v.name.includes('Ù‡Ø¯Ù‰'),
                v => v.name.includes('Naayf') || v.name.includes('Ù†Ø§ÙŠÙ'),
                v => v.lang === 'ar-SA',
                v => v.lang === 'ar-XA',
                v => v.lang.startsWith('ar')
            ];
            
            for (const check of priorities) {
                const found = voices.find(check);
                if (found) {
                    console.log('Selected Arabic voice:', found.name, found.lang);
                    return found;
                }
            }
            return null;
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                bestArabicVoice = findBestArabicVoice();
            };
            // Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙˆØ±ÙŠØ©
            bestArabicVoice = findBestArabicVoice();
        }
        
        function speakCommand(text, repeat = 2) {
            if (!('speechSynthesis' in window)) {
                console.warn('TTS not supported');
                return;
            }
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù†Ø·Ù‚ Ø³Ø§Ø¨Ù‚
            speechSynthesis.cancel();
            
            let count = 0;
            function speak() {
                if (count >= repeat) return;
                count++;
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = 0.85; // Ø£Ø¨Ø·Ø£ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ÙˆØ¶ÙˆØ­
                utterance.pitch = 1.1; // Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ø§Ù‹
                utterance.volume = 1;
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙØ¶Ù„ ØµÙˆØª Ø¹Ø±Ø¨ÙŠ
                if (bestArabicVoice) {
                    utterance.voice = bestArabicVoice;
                } else {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ø¬Ø¯Ø¯Ø§Ù‹
                    bestArabicVoice = findBestArabicVoice();
                    if (bestArabicVoice) utterance.voice = bestArabicVoice;
                }
                
                utterance.onend = () => {
                    if (count < repeat) {
                        setTimeout(speak, 2000); // ÙØ§ØµÙ„ Ø£Ø·ÙˆÙ„
                    }
                };
                
                utterance.onerror = (e) => {
                    console.error('Speech error:', e);
                };
                
                speechSynthesis.speak(utterance);
            }
            
            // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.onvoiceschanged = () => {
                    bestArabicVoice = findBestArabicVoice();
                    speak();
                };
            } else {
                speak();
            }
        }

        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }

        function isTrue(v){
          const s = String(v).toLowerCase().trim();
          return v === true || s === 'true' || s === 'yes' || s === '1';
        }

        let audioUnlocked = false;

        function showSoundGate(){
          const g = document.getElementById('soundGate');
          if (g) g.classList.remove('hidden');
        }
        function hideSoundGate(){
          const g = document.getElementById('soundGate');
          if (g) g.classList.add('hidden');
        }

        function unlockAudioOnInteraction() {
          try {
            initAudioContext();
            if (audioCtx && audioCtx.state === 'suspended') {
              audioCtx.resume();
            }
            audioUnlocked = true;
            hideSoundGate();
            if (currentCommand && !sirenPlaying && !heartbeatPlaying && !isolationPlaying) {
              const resp = String(currentCommand.responseType || '').toLowerCase().trim();
              const rt = String(currentCommand.reportType || '');
              stopAllSounds();
              if (resp.includes('send_team') || resp.includes('ØªÙˆØ¬ÙŠÙ‡')) {
                startHeartbeat();
              } else if (resp.includes('isolation') || resp.includes('Ø¹Ø²Ù„') || rt.includes('Ø¹Ø¯ÙˆÙ‰')) {
                startIsolationAlert();
              } else {
                startSiren();
              }
            }
          } catch(e) {
            console.warn('Audio unlock failed:', e);
          }
        }

        document.addEventListener('click', unlockAudioOnInteraction);
        document.addEventListener('touchstart', unlockAudioOnInteraction);
        document.addEventListener('keydown', unlockAudioOnInteraction);

        let monitoringStarted = false;
        let eventSource = null;
        let sseConnected = false;
        let sseReconnectAttempts = 0;
        let pollingInterval = null;
        const MAX_SSE_RECONNECT = 5;

        function connectSSE() {
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }

          const sseUrl = '/api/emergency-stream';
          console.log('ğŸ”Œ Connecting to SSE...');
          
          eventSource = new EventSource(sseUrl);
          
          eventSource.onopen = () => {
            console.log('âœ… SSE Connected - Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙˆØ±ÙŠØ©!');
            sseConnected = true;
            sseReconnectAttempts = 0;
            updateConnectionStatus(true);
            if (pollingInterval) {
              clearInterval(pollingInterval);
              pollingInterval = null;
            }
          };

          eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              
              if (data.connected) {
                console.log('ğŸŸ¢ SSE Ready');
                return;
              }
              
              if (data.error) {
                console.warn('SSE Error:', data.error);
                return;
              }

              if (data.command) {
                const cmd = data.command;
                if (cmd && isTrue(cmd.active)) {
                  if (!currentCommand || currentCommand.timestamp !== cmd.timestamp) {
                    activateEmergency(cmd);
                  }
                }
              } else if (data.cleared) {
                if (currentCommand) {
                  console.log('ğŸ”´ Emergency cleared via SSE');
                  deactivateEmergency();
                }
              }
            } catch (e) {
              console.error('SSE parse error:', e);
            }
          };

          eventSource.onerror = (e) => {
            console.warn('âš ï¸ SSE Error - attempting reconnect');
            sseConnected = false;
            updateConnectionStatus(false);
            
            if (eventSource) {
              eventSource.close();
              eventSource = null;
            }
            
            sseReconnectAttempts++;
            if (sseReconnectAttempts < MAX_SSE_RECONNECT) {
              setTimeout(connectSSE, 3000);
            } else {
              console.log('ğŸ“¡ Falling back to polling mode');
              startPollingFallback();
            }
          };
        }

        function startPollingFallback() {
          if (pollingInterval) return;
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }
          console.log('ğŸ“¡ Using fast polling (1 second)');
          updateConnectionStatus(false);
          checkActiveCommand();
          pollingInterval = setInterval(checkActiveCommand, 1000);
        }

        function updateConnectionStatus(connected) {
          const indicator = document.getElementById('connectionIndicator');
          if (indicator) {
            indicator.className = connected ? 'connection-indicator connected' : 'connection-indicator polling';
            indicator.title = connected ? 'SSE - Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙˆØ±ÙŠØ©' : 'Polling - ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©';
            const statusText = indicator.querySelector('.status-text');
            if (statusText) {
              statusText.textContent = connected ? 'âš¡ SSE - ÙÙˆØ±ÙŠ' : 'ğŸ“¡ 1 Ø«Ø§Ù†ÙŠØ©';
            }
          }
        }

        function startMonitoring() {
          if (monitoringStarted) return;
          monitoringStarted = true;
          
          // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª
          try {
            initAudioContext();
            audioUnlocked = true;
          } catch(e) {}
          
          // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          const startScreen = document.getElementById('startScreen');
          if (startScreen) startScreen.classList.add('hidden');
          
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ SSE Ø£ÙˆÙ„Ø§Ù‹
          if (typeof EventSource !== 'undefined') {
            connectSSE();
            // fallback Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØµÙ„ SSE
            setTimeout(() => {
              if (!sseConnected) {
                console.log('SSE timeout - using polling');
                startPollingFallback();
              }
            }, 5000);
          } else {
            // Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… SSE
            startPollingFallback();
          }
        }

        document.addEventListener('DOMContentLoaded', () => {
          // ØªÙ‡ÙŠØ¦Ø© ÙˆØ¶Ø¹ Ø§Ù„ØªØ­ÙƒÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
          initControlMode();
          
          // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          const startBtn = document.getElementById('startBtn');
          if (startBtn) startBtn.addEventListener('click', startMonitoring);
          
          // Ø²Ø± Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
          const soundBtn = document.getElementById('enableSoundBtn');
          if (soundBtn) soundBtn.addEventListener('click', unlockAudioOnInteraction);
        });

        function jsonp(action, params = {}) {
            return new Promise((resolve, reject) => {
                const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
                params.action = action;
                params.callback = cb;

                const s = document.createElement("script");
                s.src = WEB_APP_URL + "?" + new URLSearchParams(params).toString();

                window[cb] = (data) => { cleanup(); resolve(data); };
                s.onerror = () => { cleanup(); reject(new Error("jsonp failed")); };

                function cleanup() {
                    try { delete window[cb]; } catch(e) {}
                    if (s.parentNode) s.parentNode.removeChild(s);
                }
                document.body.appendChild(s);
            });
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            document.getElementById('currentDate').textContent =
                now.toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        async function checkActiveCommand() {
            try {
                const data = await jsonp('getActiveCommand', {});
                const cmd = data && data.ok ? data.command : null;

                if (cmd && isTrue(cmd.active)) {
                    if (!currentCommand || currentCommand.timestamp !== cmd.timestamp) {
                        activateEmergency(cmd);
                    }
                } else {
                    if (currentCommand) deactivateEmergency();
                }
            } catch (e) {
                console.error('checkActiveCommand:', e);
            }
        }

        // ========== ÙˆØ¶Ø¹ Ø§Ù„ØªØ­ÙƒÙ… ==========
        let controlMode = false;
        let selectedScenario = null;
        let isDrillMode = false;
        
        const typeLabels = {
            'fire': 'Ø­Ø±ÙŠÙ‚',
            'power': 'Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
            'water': 'ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡',
            'injury': 'Ø¥ØºÙ…Ø§Ø¡/Ø¥ØµØ§Ø¨Ø©',
            'infection': 'ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰'
        };
        
        function initControlMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'control') {
                controlMode = true;
                document.body.classList.add('control-mode');
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('safeScreen').classList.add('hidden');
                document.getElementById('controlPanel').classList.add('active');
            }
        }
        
        function selectScenario(type, evt) {
            selectedScenario = type;
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
            const target = evt ? evt.target : event.target;
            if (target) {
                const card = target.closest('.scenario-card');
                if (card) card.classList.add('selected');
            }
            updateActivateButton();
        }
        
        function toggleDrill(evt) {
            if (evt) evt.stopPropagation();
            const checkbox = document.getElementById('drillCheckbox');
            isDrillMode = !isDrillMode;
            checkbox.checked = isDrillMode;
            updateActivateButton();
        }
        
        function updateActivateButton() {
            const btn = document.getElementById('activateControlBtn');
            if (!selectedScenario) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-bell"></i><span>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø£ÙˆÙ„Ø§Ù‹</span>';
                btn.classList.remove('drill-mode');
            } else {
                btn.disabled = false;
                const label = typeLabels[selectedScenario];
                if (isDrillMode) {
                    btn.innerHTML = `<i class="fas fa-clipboard-check"></i><span>ØªÙØ¹ÙŠÙ„ ØªÙ…Ø±ÙŠÙ†: ${label}</span>`;
                    btn.classList.add('drill-mode');
                } else {
                    btn.innerHTML = `<i class="fas fa-bell"></i><span>ØªÙØ¹ÙŠÙ„ Ø·ÙˆØ§Ø±Ø¦: ${label}</span>`;
                    btn.classList.remove('drill-mode');
                }
            }
        }
        
        async function activateFromControl() {
            if (!selectedScenario) return;
            
            const label = typeLabels[selectedScenario];
            const confirmMsg = isDrillMode
                ? `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ ØªÙ…Ø±ÙŠÙ†: ${label}ØŸ`
                : `âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø·ÙˆØ§Ø±Ø¦ Ø­Ù‚ÙŠÙ‚ÙŠØ©: ${label}ØŸ\n\nØ³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†!`;
            
            if (!confirm(confirmMsg)) return;
            
            const btn = document.getElementById('activateControlBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„...</span>';
            
            const payload = {
                responseType: selectedScenario,
                reportType: label,
                location: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±',
                muster: 'Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¬Ù…Ø¹ A - Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ',
                isDrill: isDrillMode
            };
            
            try {
                await jsonp('setActiveCommand', payload);
                
                // Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
                document.getElementById('controlPanel').classList.remove('active');
                activateEmergency(payload);
                
            } catch(e) {
                console.error('Activation error:', e);
                // Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ù†ÙØ¹Ù‘Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹
                document.getElementById('controlPanel').classList.remove('active');
                activateEmergency(payload);
            }
        }
        
        // ========== Ø§Ù„Ø®Ø·ÙˆØ§Øª ==========
        const scenarioSteps = {
            'fire': ['ğŸ†˜ R: Ø£Ù†Ù‚Ø° Ù…Ù† ÙÙŠ Ø®Ø·Ø±', 'ğŸš¨ A: Ø¥Ù†Ø°Ø§Ø± + Ø§ØªØµÙ„ 998', 'ğŸšª C: Ø£ØºÙ„Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨', 'ğŸƒ E: Ø£Ø®Ù„Ù Ù„Ù„ØªØ¬Ù…Ø¹', 'ğŸ§¯ PASS: Ø·ÙØ§ÙŠØ©', 'ğŸ›— Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ¹Ø¯!'],
            'Ø­Ø±ÙŠÙ‚': ['ğŸ†˜ R: Ø£Ù†Ù‚Ø° Ù…Ù† ÙÙŠ Ø®Ø·Ø±', 'ğŸš¨ A: Ø¥Ù†Ø°Ø§Ø± + Ø§ØªØµÙ„ 998', 'ğŸšª C: Ø£ØºÙ„Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨', 'ğŸƒ E: Ø£Ø®Ù„Ù Ù„Ù„ØªØ¬Ù…Ø¹', 'ğŸ§¯ PASS: Ø·ÙØ§ÙŠØ©', 'ğŸ›— Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ¹Ø¯!'],
            'power': ['ğŸ”‹ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ„Ø¯', 'ğŸ”Œ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø­Ø±Ø¬Ø© Ø¹Ù„Ù‰ UPS', 'ğŸ¥ ØªÙÙ‚Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰', 'ğŸ“ Ø£Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©+EOC', 'ğŸ›— Ø£Ø®Ù„Ù Ø§Ù„Ù…ØµØ¹Ø¯!', 'â„ï¸ Ù„Ø§ ØªÙØªØ­ Ø«Ù„Ø§Ø¬Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©'],
            'ÙƒÙ‡Ø±Ø¨Ø§Ø¡': ['ğŸ”‹ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ„Ø¯', 'ğŸ”Œ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø­Ø±Ø¬Ø© Ø¹Ù„Ù‰ UPS', 'ğŸ¥ ØªÙÙ‚Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰', 'ğŸ“ Ø£Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©+EOC', 'ğŸ›— Ø£Ø®Ù„Ù Ø§Ù„Ù…ØµØ¹Ø¯!', 'â„ï¸ Ù„Ø§ ØªÙØªØ­ Ø«Ù„Ø§Ø¬Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©'],
            'Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒÙ‡Ø±Ø¨Ø§Ø¡': ['ğŸ”‹ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ„Ø¯', 'ğŸ”Œ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø­Ø±Ø¬Ø© Ø¹Ù„Ù‰ UPS', 'ğŸ¥ ØªÙÙ‚Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰', 'ğŸ“ Ø£Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©+EOC', 'ğŸ›— Ø£Ø®Ù„Ù Ø§Ù„Ù…ØµØ¹Ø¯!', 'â„ï¸ Ù„Ø§ ØªÙØªØ­ Ø«Ù„Ø§Ø¬Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©'],
            'water': ['ğŸƒ Ø£Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø§Ø³ ÙÙˆØ±Ø§Ù‹', 'âš¡ Ø§ÙØµÙ„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡!', 'ğŸš° Ø£ØºÙ„Ù‚ Ø§Ù„Ù…Ø­Ø¨Ø³', 'ğŸ’» Ø§Ø±ÙØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ù† Ø§Ù„Ø£Ø±Ø¶!', 'âš ï¸ Ø¹Ù„Ø§Ù…Ø© "Ø£Ø±Ø¶ÙŠØ© Ø²Ù„Ù‚Ø©"', 'ğŸ“ Ø£Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©'],
            'Ù…ÙŠØ§Ù‡': ['ğŸƒ Ø£Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø§Ø³ ÙÙˆØ±Ø§Ù‹', 'âš¡ Ø§ÙØµÙ„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡!', 'ğŸš° Ø£ØºÙ„Ù‚ Ø§Ù„Ù…Ø­Ø¨Ø³', 'ğŸ’» Ø§Ø±ÙØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ù† Ø§Ù„Ø£Ø±Ø¶!', 'âš ï¸ Ø¹Ù„Ø§Ù…Ø© "Ø£Ø±Ø¶ÙŠØ© Ø²Ù„Ù‚Ø©"', 'ğŸ“ Ø£Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©'],
            'ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡': ['ğŸƒ Ø£Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø§Ø³ ÙÙˆØ±Ø§Ù‹', 'âš¡ Ø§ÙØµÙ„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡!', 'ğŸš° Ø£ØºÙ„Ù‚ Ø§Ù„Ù…Ø­Ø¨Ø³', 'ğŸ’» Ø§Ø±ÙØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ù† Ø§Ù„Ø£Ø±Ø¶!', 'âš ï¸ Ø¹Ù„Ø§Ù…Ø© "Ø£Ø±Ø¶ÙŠØ© Ø²Ù„Ù‚Ø©"', 'ğŸ“ Ø£Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©'],
            'injury': ['ğŸ›¡ï¸ Ø£Ù…Ù‘Ù† Ø§Ù„Ù…ÙƒØ§Ù†', 'ğŸ‘‹ Ø§ÙØ­Øµ Ø§Ù„ÙˆØ¹ÙŠ', 'ğŸ“ Ø§ØªØµÙ„ 997', 'ğŸ¦µ Ø§Ø±ÙØ¹ Ø§Ù„Ø±Ø¬Ù„ÙŠÙ† 30Ø³Ù…', 'ğŸ’¨ Ø§ÙØªØ­ Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¡', 'ğŸ¦· Ø£Ø³Ù†Ø§Ù†: Ø£Ø®Ø±Ø¬ Ø§Ù„Ø£Ø¯ÙˆØ§Øª!'],
            'Ø¥ØºÙ…Ø§Ø¡': ['ğŸ›¡ï¸ Ø£Ù…Ù‘Ù† Ø§Ù„Ù…ÙƒØ§Ù†', 'ğŸ‘‹ Ø§ÙØ­Øµ Ø§Ù„ÙˆØ¹ÙŠ', 'ğŸ“ Ø§ØªØµÙ„ 997', 'ğŸ¦µ Ø§Ø±ÙØ¹ Ø§Ù„Ø±Ø¬Ù„ÙŠÙ† 30Ø³Ù…', 'ğŸ’¨ Ø§ÙØªØ­ Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¡', 'ğŸ¦· Ø£Ø³Ù†Ø§Ù†: Ø£Ø®Ø±Ø¬ Ø§Ù„Ø£Ø¯ÙˆØ§Øª!'],
            'Ø¥ØµØ§Ø¨Ø©': ['ğŸ›¡ï¸ Ø£Ù…Ù‘Ù† Ø§Ù„Ù…ÙƒØ§Ù†', 'ğŸ‘‹ Ø§ÙØ­Øµ Ø§Ù„ÙˆØ¹ÙŠ', 'ğŸ“ Ø§ØªØµÙ„ 997', 'ğŸ¦µ Ø§Ø±ÙØ¹ Ø§Ù„Ø±Ø¬Ù„ÙŠÙ† 30Ø³Ù…', 'ğŸ’¨ Ø§ÙØªØ­ Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¡', 'ğŸ¦· Ø£Ø³Ù†Ø§Ù†: Ø£Ø®Ø±Ø¬ Ø§Ù„Ø£Ø¯ÙˆØ§Øª!'],
            'Ø¥ØºÙ…Ø§Ø¡/Ø¥ØµØ§Ø¨Ø©': ['ğŸ›¡ï¸ Ø£Ù…Ù‘Ù† Ø§Ù„Ù…ÙƒØ§Ù†', 'ğŸ‘‹ Ø§ÙØ­Øµ Ø§Ù„ÙˆØ¹ÙŠ', 'ğŸ“ Ø§ØªØµÙ„ 997', 'ğŸ¦µ Ø§Ø±ÙØ¹ Ø§Ù„Ø±Ø¬Ù„ÙŠÙ† 30Ø³Ù…', 'ğŸ’¨ Ø§ÙØªØ­ Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¡', 'ğŸ¦· Ø£Ø³Ù†Ø§Ù†: Ø£Ø®Ø±Ø¬ Ø§Ù„Ø£Ø¯ÙˆØ§Øª!'],
            'infection': ['ğŸ”’ Ø§Ø¹Ø²Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙˆØ±Ø§Ù‹', 'ğŸ§¤ Ø§Ù„Ø¨Ø³ Ù‚ÙØ§Ø²Ø§Øª+ÙƒÙ…Ø§Ù…Ø©+Ø¹Ø¨Ø§Ø¡Ø©', 'ğŸ“ Ø£Ø¨Ù„Øº Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰', 'ğŸ§´ Ø§ØºØ³Ù„ ÙŠØ¯ÙŠÙƒ 20 Ø«Ø§Ù†ÙŠØ©', 'ğŸ©¸ Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ØŸ ØºØ·Ù‘Ù‡ Ø«Ù… ØµØ¨ ÙƒÙ„ÙˆØ± Ù…Ø®ÙÙ', 'ğŸ”´ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ÙÙŠ ÙƒÙŠØ³ Ø£Ø­Ù…Ø±'],
            'Ø¹Ø¯ÙˆÙ‰': ['ğŸ”’ Ø§Ø¹Ø²Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙˆØ±Ø§Ù‹', 'ğŸ§¤ Ø§Ù„Ø¨Ø³ Ù‚ÙØ§Ø²Ø§Øª+ÙƒÙ…Ø§Ù…Ø©+Ø¹Ø¨Ø§Ø¡Ø©', 'ğŸ“ Ø£Ø¨Ù„Øº Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰', 'ğŸ§´ Ø§ØºØ³Ù„ ÙŠØ¯ÙŠÙƒ 20 Ø«Ø§Ù†ÙŠØ©', 'ğŸ©¸ Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ØŸ ØºØ·Ù‘Ù‡ Ø«Ù… ØµØ¨ ÙƒÙ„ÙˆØ± Ù…Ø®ÙÙ', 'ğŸ”´ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ÙÙŠ ÙƒÙŠØ³ Ø£Ø­Ù…Ø±'],
            'outbreak': ['ğŸ”’ Ø§Ø¹Ø²Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙˆØ±Ø§Ù‹', 'ğŸ§¤ Ø§Ù„Ø¨Ø³ Ù‚ÙØ§Ø²Ø§Øª+ÙƒÙ…Ø§Ù…Ø©+Ø¹Ø¨Ø§Ø¡Ø©', 'ğŸ“ Ø£Ø¨Ù„Øº Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰', 'ğŸ§´ Ø§ØºØ³Ù„ ÙŠØ¯ÙŠÙƒ 20 Ø«Ø§Ù†ÙŠØ©', 'ğŸ©¸ Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ØŸ ØºØ·Ù‘Ù‡ Ø«Ù… ØµØ¨ ÙƒÙ„ÙˆØ± Ù…Ø®ÙÙ', 'ğŸ”´ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ÙÙŠ ÙƒÙŠØ³ Ø£Ø­Ù…Ø±'],
            'ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰': ['ğŸ”’ Ø§Ø¹Ø²Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙˆØ±Ø§Ù‹', 'ğŸ§¤ Ø§Ù„Ø¨Ø³ Ù‚ÙØ§Ø²Ø§Øª+ÙƒÙ…Ø§Ù…Ø©+Ø¹Ø¨Ø§Ø¡Ø©', 'ğŸ“ Ø£Ø¨Ù„Øº Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰', 'ğŸ§´ Ø§ØºØ³Ù„ ÙŠØ¯ÙŠÙƒ 20 Ø«Ø§Ù†ÙŠØ©', 'ğŸ©¸ Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ØŸ ØºØ·Ù‘Ù‡ Ø«Ù… ØµØ¨ ÙƒÙ„ÙˆØ± Ù…Ø®ÙÙ', 'ğŸ”´ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ÙÙŠ ÙƒÙŠØ³ Ø£Ø­Ù…Ø±'],
            'ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰ / Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰': ['ğŸ”’ Ø§Ø¹Ø²Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙˆØ±Ø§Ù‹', 'ğŸ§¤ Ø§Ù„Ø¨Ø³ Ù‚ÙØ§Ø²Ø§Øª+ÙƒÙ…Ø§Ù…Ø©+Ø¹Ø¨Ø§Ø¡Ø©', 'ğŸ“ Ø£Ø¨Ù„Øº Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰', 'ğŸ§´ Ø§ØºØ³Ù„ ÙŠØ¯ÙŠÙƒ 20 Ø«Ø§Ù†ÙŠØ©', 'ğŸ©¸ Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ØŸ ØºØ·Ù‘Ù‡ Ø«Ù… ØµØ¨ ÙƒÙ„ÙˆØ± Ù…Ø®ÙÙ', 'ğŸ”´ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ÙÙŠ ÙƒÙŠØ³ Ø£Ø­Ù…Ø±']
        };

        async function activateEmergency(command) {
            currentCommand = command;
            commandStartTime = new Date(command.timestamp || Date.now());

            await ensureAudioReady();

            document.getElementById('safeScreen').classList.add('hidden');
            document.getElementById('emergencyScreen').classList.add('active');
            
            // ØªÙØ¹ÙŠÙ„ Ø£Ø¶ÙˆØ§Ø¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙˆØ§Ù…Ø¶Ø© ğŸš¨
            document.getElementById('emergencyLights').classList.add('active');

            const resp = String(command.responseType || '').toLowerCase().trim();
            const rt = String(command.reportType || '');
            const isDrill = command.isDrill === true || command.isDrill === 'true' || resp === 'drill' || rt.includes('ØªÙ…Ø±ÙŠÙ†');
            let bodyClass = 'other';
            let iconHtml = '<i class="fas fa-exclamation-triangle"></i>';
            
            // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ badge Ø§Ù„ØªÙ…Ø±ÙŠÙ†
            const drillBadge = document.getElementById('drillBadge');
            if (isDrill) {
                drillBadge.style.display = 'block';
                bodyClass = 'drill';
                iconHtml = '<i class="fas fa-clipboard-check"></i>';
                document.getElementById('emergencyTitle').textContent = 'ØªÙ…Ø±ÙŠÙ† Ø·ÙˆØ§Ø±Ø¦';
            } else {
                drillBadge.style.display = 'none';
            }

            // Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙ†Ù‚Ø·Ø© Ø§Ù„ØªØ¬Ù…Ø¹
            const loc = command.location || '-';
            const muster = command.muster || command.musterPoint || '';

            // Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù…Ø± (responseType) Ø£ÙˆÙ„Ø§Ù‹
            if (resp.includes('full_evacuation') || resp.includes('Ø¥Ø®Ù„Ø§Ø¡') || resp.includes('Ø§Ø®Ù„Ø§Ø¡')) {
                bodyClass = 'fire'; // Ø£Ø­Ù…Ø± Ù„Ù„Ø¥Ø®Ù„Ø§Ø¡
                document.getElementById('emergencyTitle').textContent = 'Ø£Ù…Ø± Ø¥Ø®Ù„Ø§Ø¡';
                // Ø¹Ø±Ø¶: "Ø¥Ø®Ù„Ø§Ø¡ ÙÙˆØ±ÙŠ - Ø§Ù„Ù…ÙˆÙ‚Ø¹"
                document.getElementById('instructionTitle').textContent = 'Ø¥Ø®Ù„Ø§Ø¡ ÙÙˆØ±ÙŠ - ' + loc;
                iconHtml = '<i class="fas fa-running"></i>';
            } else if (resp.includes('send_team') || resp.includes('ØªÙˆØ¬ÙŠÙ‡') || resp.includes('ØªÙˆØ¬Ù‡')) {
                bodyClass = 'injury'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„ØªÙˆØ¬ÙŠÙ‡
                document.getElementById('emergencyTitle').textContent = 'Ø£Ù…Ø± ØªÙˆØ¬ÙŠÙ‡';
                document.getElementById('instructionTitle').textContent = 'ØªÙˆØ¬ÙŠÙ‡ ÙØ±ÙŠÙ‚ - ' + loc;
                iconHtml = '<i class="fas fa-user-shield"></i>';
            } else if (resp.includes('isolation_evacuation') || resp.includes('Ø¹Ø²Ù„')) {
                bodyClass = 'infection'; // Ø¨Ù†ÙØ³Ø¬ÙŠ Ù„Ù„Ø¹Ø²Ù„
                document.getElementById('emergencyTitle').textContent = 'Ø£Ù…Ø± Ø¹Ø²Ù„';
                document.getElementById('instructionTitle').textContent = 'Ø¹Ø²Ù„ ÙÙˆØ±ÙŠ - ' + loc;
                iconHtml = '<i class="fas fa-virus"></i>';
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ responseTypeØŒ Ù†Ø³ØªØ®Ø¯Ù… reportType Ù„Ù„ÙˆÙ†
                if (rt.includes('Ø­Ø±ÙŠÙ‚') || rt.includes('Ø¯Ø®Ø§Ù†')) {
                    bodyClass = 'fire';
                    iconHtml = '<i class="fas fa-fire"></i>';
                } else if (rt.includes('Ø¥ØºÙ…Ø§Ø¡') || rt.includes('Ø¥ØµØ§Ø¨Ø©')) {
                    bodyClass = 'injury';
                    iconHtml = '<i class="fas fa-user-injured"></i>';
                } else if (rt.includes('Ø¹Ø¯ÙˆÙ‰')) {
                    bodyClass = 'infection';
                    iconHtml = '<i class="fas fa-virus"></i>';
                } else if (rt.includes('ÙƒÙ‡Ø±Ø¨Ø§Ø¡')) {
                    bodyClass = 'power';
                    iconHtml = '<i class="fas fa-bolt"></i>';
                } else if (rt.includes('Ù…ÙŠØ§Ù‡') || rt.includes('ØªØ³Ø±Ø¨')) {
                    bodyClass = 'water';
                    iconHtml = '<i class="fas fa-water"></i>';
                }
                document.getElementById('emergencyTitle').textContent = 'ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦';
                document.getElementById('instructionTitle').textContent = 'Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª - ' + loc;
            }

            document.body.className = bodyClass;
            document.getElementById('emergencyIcon').innerHTML = iconHtml;
            document.getElementById('emergencyType').textContent = command.reportType || 'Ø·ÙˆØ§Ø±Ø¦';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†ÙØµÙ„ (Ø£ØµØ¨Ø­ Ù…Ø¯Ù…ÙˆØ¬ Ù…Ø¹ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)
            document.getElementById('emergencyLocation').style.display = 'none';

            // Ø¹Ø±Ø¶ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¬Ù…Ø¹ ÙƒÙ€ "Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰:"
            if (muster) {
                document.getElementById('musterSection').style.display = 'block';
                document.getElementById('musterPoint').textContent = muster;
            } else {
                document.getElementById('musterSection').style.display = 'none';
                document.getElementById('musterPoint').textContent = '-';
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ§Øª
            const stepsContainer = document.getElementById('stepsSummary');
            const stepsContent = document.getElementById('stepsContent');
            let steps = scenarioSteps[resp] || scenarioSteps[rt] || null;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†Øµ
            if (!steps) {
                for (let key in scenarioSteps) {
                    if (rt.includes(key) || resp.includes(key)) {
                        steps = scenarioSteps[key];
                        break;
                    }
                }
            }
            
            if (steps && steps.length > 0) {
                stepsContent.innerHTML = steps.map((step, i) => `
                    <div class="step-item-mini">
                        <span class="step-num-mini">${i + 1}</span>
                        <span class="step-text-mini">${step}</span>
                    </div>
                `).join('');
                stepsContainer.style.display = 'block';
            } else {
                stepsContainer.style.display = 'none';
            }

            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù…Ø±
            if (!isDrill) {
                // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØµÙˆØª Ø³Ø§Ø¨Ù‚ Ø£ÙˆÙ„Ø§Ù‹
                stopAllSounds();
                
                if (resp.includes('send_team') || resp.includes('ØªÙˆØ¬ÙŠÙ‡')) {
                    // Ø£Ù…Ø± ØªÙˆØ¬ÙŠÙ‡: Ù†Ø¨Ø¶Ø§Øª Ù‚Ù„Ø¨ ğŸ’“
                    startHeartbeat();
                } else if (resp.includes('isolation') || resp.includes('Ø¹Ø²Ù„') || rt.includes('Ø¹Ø¯ÙˆÙ‰')) {
                    // Ø¹Ø²Ù„/Ø¹Ø¯ÙˆÙ‰: ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ù…ØªÙ‚Ø·Ø¹ ğŸ”Š
                    startIsolationAlert();
                } else {
                    // Ø¥Ø®Ù„Ø§Ø¡/Ø­Ø±ÙŠÙ‚: ØµÙØ§Ø±Ø© Ø¥Ù†Ø°Ø§Ø± ğŸš¨
                    startSiren();
                }
            }
            startTimer();
        }

        function deactivateEmergency() {
            currentCommand = null;
            document.getElementById('safeScreen').classList.remove('hidden');
            document.getElementById('emergencyScreen').classList.remove('active');
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø£Ø¶ÙˆØ§Ø¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙˆØ§Ù…Ø¶Ø©
            document.getElementById('emergencyLights').classList.remove('active');
            document.body.className = 'safe';
            stopAllSounds();
            stopSpeaking();
            hideSoundGate();
            document.getElementById('musterSection').style.display = 'none';
            document.getElementById('musterPoint').textContent = '-';
            stopTimer();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!commandStartTime) return;
                const diff = Math.floor((Date.now() - commandStartTime.getTime()) / 1000);
                const mins = Math.floor(diff / 60).toString().padStart(2, '0');
                const secs = (diff % 60).toString().padStart(2, '0');
                document.getElementById('elapsedTime').textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('elapsedTime').textContent = '00:00';
        }

        // Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ¨Ø¯Ø£ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©"
    </script>
<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙˆØª (Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø· - ØªØ®ØªÙÙŠ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬) -->
<div id="soundControls" style="position:fixed;z-index:10000;bottom:20px;right:20px;display:none;gap:10px;align-items:center;background:rgba(0,0,0,0.8);padding:15px;border-radius:15px;">
  <button id="policeBtn"
    style="padding:12px 14px;font-weight:800;border-radius:12px;border:0;cursor:pointer;background:#1e3a5f;color:#fff;">
    ğŸš“ Police OFF
  </button>

  <button id="alarmBtn"
    style="padding:12px 14px;font-weight:800;border-radius:12px;border:0;cursor:pointer;background:#DC143C;color:#fff;">
    ğŸ¥ Alarm OFF
  </button>

  <input id="sirenVolume" type="range" min="0" max="1" step="0.01" value="0.25"
    style="width:120px;">
</div>

<script>
(() => {
  let audioCtx=null, master=null, comp=null;
  let osc1=null, osc2=null, lfo=null, lfoGain=null, gainNode=null;
  let timer=null;

  const lightsEl = document.getElementById("emergencyLights");
  const policeBtn = document.getElementById("policeBtn");
  const alarmBtn  = document.getElementById("alarmBtn");
  const volEl     = document.getElementById("sirenVolume");
  const soundControls = document.getElementById("soundControls");

  const state = { mode: null };

  // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØª ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­ÙƒÙ…
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('mode') === 'control' || urlParams.get('sound') === 'test') {
    soundControls.style.display = 'flex';
  }

  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    master = audioCtx.createGain();
    master.gain.value = Number(volEl?.value ?? 0.25);

    comp = audioCtx.createDynamicsCompressor();
    comp.threshold.value = -18;
    comp.knee.value = 18;
    comp.ratio.value = 6;
    comp.attack.value = 0.003;
    comp.release.value = 0.15;

    master.connect(comp);
    comp.connect(audioCtx.destination);
  }

  function stopAll(){
    if (timer){ clearInterval(timer); timer=null; }

    [osc1, osc2, lfo].forEach(n=>{
      try { n && n.stop(); } catch(e){}
      try { n && n.disconnect(); } catch(e){}
    });
    osc1=osc2=lfo=null;

    try { lfoGain && lfoGain.disconnect(); } catch(e){}
    try { gainNode && gainNode.disconnect(); } catch(e){}
    lfoGain=null; gainNode=null;

    state.mode=null;
    if (policeBtn) policeBtn.textContent = "ğŸš“ Police OFF";
    if (alarmBtn)  alarmBtn.textContent  = "ğŸ¥ Alarm OFF";
  }

  function setVolume(v){
    if (!master) return;
    master.gain.setTargetAtTime(Number(v), audioCtx.currentTime, 0.03);
  }

  // ØµÙØ§Ø±Ø© Ø§Ù„Ø´Ø±Ø·Ø©
  function startPolice(){
    ensureAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();

    stopAll();
    state.mode="police";
    if (lightsEl) lightsEl.classList.add("active");
    if (policeBtn) policeBtn.textContent = "ğŸš“ Police ON";

    gainNode = audioCtx.createGain();
    gainNode.gain.value = 0.65;

    osc1 = audioCtx.createOscillator();
    osc2 = audioCtx.createOscillator();
    osc1.type="sawtooth";
    osc2.type="square";
    osc1.detune.value=-10;
    osc2.detune.value=+7;

    lfo = audioCtx.createOscillator();
    lfo.type="sine";
    lfo.frequency.value = 10.5;

    lfoGain = audioCtx.createGain();
    lfoGain.gain.value = 0.16;

    lfo.connect(lfoGain);
    lfoGain.connect(gainNode.gain);

    osc1.connect(gainNode);
    osc2.connect(gainNode);
    gainNode.connect(master);

    const now = audioCtx.currentTime;
    osc1.start(now);
    osc2.start(now);
    lfo.start(now);

    let phase=0;
    timer = setInterval(()=>{
      const t = audioCtx.currentTime;
      const presets = [
        {a: 820, b: 640},
        {a: 1050, b: 820},
        {a: 680, b: 520},
        {a: 1120, b: 900},
      ];
      const p = presets[phase % presets.length];

      osc1.frequency.cancelScheduledValues(t);
      osc2.frequency.cancelScheduledValues(t);
      osc1.frequency.setTargetAtTime(p.a, t, 0.05);
      osc2.frequency.setTargetAtTime(p.b, t, 0.05);

      phase++;
    }, 140);
  }

  // Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
  function startAlarm(){
    ensureAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();

    stopAll();
    state.mode="alarm";
    if (lightsEl) lightsEl.classList.add("active");
    if (alarmBtn)  alarmBtn.textContent  = "ğŸ¥ Alarm ON";

    gainNode = audioCtx.createGain();
    gainNode.gain.value = 0.0;
    gainNode.connect(master);

    osc1 = audioCtx.createOscillator();
    osc1.type="square";
    osc1.frequency.value = 880;
    osc1.connect(gainNode);

    const now = audioCtx.currentTime;
    osc1.start(now);

    let step=0;
    timer = setInterval(()=>{
      const t = audioCtx.currentTime;
      const on = (step===0 || step===1);
      gainNode.gain.cancelScheduledValues(t);
      gainNode.gain.setTargetAtTime(on ? 0.55 : 0.0, t, 0.01);
      osc1.frequency.setTargetAtTime(on ? 930 : 820, t, 0.02);
      step = (step+1) % 5;
    }, 220);
  }

  policeBtn?.addEventListener("click", ()=>{
    if (state.mode === "police") stopAll();
    else startPolice();
  });

  alarmBtn?.addEventListener("click", ()=>{
    if (state.mode === "alarm") stopAll();
    else startAlarm();
  });

  volEl?.addEventListener("input", e => setVolume(e.target.value));

  // API Ù„Ù„Ù†Ø¸Ø§Ù…
  window.EOC = window.EOC || {};
  window.EOC.playPolice = startPolice;
  window.EOC.playAlarm  = startAlarm;
  window.EOC.stopSound  = stopAll;

})();
</script>
</body>
</html>
