<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحليل الحالات الطبية (Gemini & GPT‑4o)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial;background:#0b1217;color:#e9edf1;margin:0;padding:24px}
    h1{margin:0 0 8px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
    .card{background:#111a21;border:1px solid #1f2b34;border-radius:12px;padding:16px;margin:12px 0}
    label{font-size:13px;color:#a9bbc7;display:block;margin-bottom:6px}
    select,input,textarea,button{background:#0e1620;color:#e9edf1;border:1px solid #25313b;border-radius:8px}
    select,input{padding:10px}
    textarea{padding:10px;width:100%;min-height:96px;resize:vertical}
    button{padding:12px 16px;cursor:pointer}
    button.primary{background:#1a73e8;border-color:#1a73e8}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#95a8b4;font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    pre{background:#081017;color:#dbe7ef;border:1px dashed #24313b;border-radius:10px;padding:12px;overflow:auto}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px}
    .pill{font-size:12px;border-radius:999px;padding:4px 8px;background:#11202a;border:1px solid #1f3645}
    .ok{background:#0d2a19;color:#9ff2c3;border-color:#144a2c}
    .warn{background:#2a250d;color:#ffe28a;border-color:#4a3f14}
    .bad{background:#2a0d0d;color:#ffb3b3;border-color:#4a1414}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:10px 12px;text-align:right}
    th{color:#9eb0bd;font-weight:600;border-bottom:1px solid #24313b}
    tr.rowx{background:#0c151c;border:1px solid #1f2b34}
    td.status{font-weight:700}
    .s-ok{color:#6ff0ad}
    .s-warn{color:#ffd166}
    .s-bad{color:#ff7b7b}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}
  </style>

  <!-- PDF.js عبر CDN + تهيئة العامل (worker) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // مطلوب لتعريف العامل في المتصفح (وإلا سيظهر: pdfjsLib is not defined / لا يوجد عامل)
    // توثيق استخدام العامل عبر GlobalWorkerOptions مذكور في مصادر PDF.js. 
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>
</head>
<body>
  <h1>تحليل الحالات الطبية <span class="muted">Gemini & GPT‑4o</span></h1>
  <div class="muted">API Version: <span id="apiVer" class="pill">v6.2</span></div>

  <div class="card">
    <div class="grid">
      <div>
        <label>اختر ملفات (صورة/‏PDF):</label>
        <input id="fileInput" type="file" accept="application/pdf,image/*" multiple />
        <div class="muted">أي PDF سيتحوّل إلى صور + يُستخرج نصّه (PDF.js).</div>
      </div>
      <div>
        <label>اللغة:</label>
        <select id="lang">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label>النموذج:</label>
        <select id="model">
          <option>Gemini + GPT‑4o</option>
          <option>Gemini فقط</option>
          <option>GPT‑4o فقط</option>
        </select>
      </div>
      <div>
        <label>التخصص (اختياري):</label>
        <input id="specialty" placeholder="أسنان، جلدية، قلب، ضغط، كُلى ..." />
      </div>
    </div>

    <label style="margin-top:10px">وصف مختصر/سياق التأمين (اختياري):</label>
    <textarea id="context" placeholder="مثال: مراجعة رفض المطالبة لزيارة أكزيما"></textarea>

    <div class="row">
      <button id="analyzeBtn" class="primary">تحليل الحالة</button>
      <span class="muted" id="prepNote">لم يتم التحضير بعد.</span>
    </div>

    <div class="toolbar">
      <strong>السجل</strong>
    </div>
    <pre id="log" class="mono" style="min-height:90px"></pre>
  </div>

  <div class="card">
    <div class="toolbar"><strong>النتيجة المدمجة</strong>
      <button id="copyMerged" class="pill">نسخ JSON</button>
    </div>
    <pre id="merged" class="mono" style="min-height:140px"></pre>
    <div id="tableHost" class="card" style="margin-top:12px;display:none">
      <div class="toolbar"><strong>جدول الأدوية/الإجراءات (مقبول/قابل للرفض/مرفوض)</strong></div>
      <div id="tableWrap"></div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar"><strong>مخرجات GPT‑4o</strong> <button id="copyGpt" class="pill">نسخ</button></div>
    <pre id="gpt" class="mono" style="min-height:120px"></pre>
  </div>

  <div class="card">
    <div class="toolbar"><strong>مخرجات Gemini</strong> <button id="copyGem" class="pill">نسخ</button></div>
    <pre id="gem" class="mono" style="min-height:120px"></pre>
  </div>

<script>
const API_URL = '/api/gpt';          // نفس الدالة تحت api/
const API_VERSION = 'v6.2';          // للعرض فقط
document.getElementById('apiVer').textContent = API_VERSION;

const logEl = document.getElementById('log');
const prepNote = document.getElementById('prepNote');
const analyzeBtn = document.getElementById('analyzeBtn');

const mergedEl = document.getElementById('merged');
const gptEl = document.getElementById('gpt');
const gemEl = document.getElementById('gem');

const tableHost = document.getElementById('tableHost');
const tableWrap = document.getElementById('tableWrap');

const MAX_IMG_DIM = 1400;  // لتقليل الحجم
function log(msg){ logEl.textContent += (msg + '\n'); logEl.scrollTop = logEl.scrollHeight; }

function dataUrlFromCanvas(canvas, mime='image/jpeg', q=0.7){
  return canvas.toDataURL(mime, q);
}
function downscale(img, maxDim=MAX_IMG_DIM){
  const ratio = Math.min(1, maxDim / Math.max(img.width, img.height));
  const w = Math.round(img.width * ratio);
  const h = Math.round(img.height * ratio);
  const c = document.createElement('canvas'); c.width = w; c.height = h;
  const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
  return c;
}

async function fileToImageDataURL(file){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = () => {
        const canvas = downscale(img);
        resolve({ dataUrl: dataUrlFromCanvas(canvas), contentType: 'image/jpeg' });
      };
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

async function pdfToImagesAndText(file){
  const arr = new Uint8Array(await file.arrayBuffer());
  const pdf = await pdfjsLib.getDocument({ data: arr }).promise;
  const images = [];
  let fullText = '';
  for (let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    // render to canvas
    const vp = page.getViewport({ scale: 1.6 });
    const canvas = document.createElement('canvas');
    canvas.width = vp.width; canvas.height = vp.height;
    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport: vp }).promise;
    // downscale + to dataURL
    const scaled = downscale(canvas, MAX_IMG_DIM);
    images.push({ dataUrl: dataUrlFromCanvas(scaled), contentType: 'image/jpeg' });
    // extract text
    const tc = await page.getTextContent();
    const pageText = tc.items.map(i => i.str).join(' ').replace(/\s+/g,' ').trim();
    fullText += (pageText + '\n');
  }
  return { images, text: fullText };
}

async function prepareFiles(){
  const input = document.getElementById('fileInput');
  const files = Array.from(input.files || []);
  if (!files.length) throw new Error('لم يتم اختيار ملفات.');
  const prepared = { images: [], texts: [] };
  log('بدء التحضير ... < تحويل PDF واستخراج نص (إن وجد)');
  for (const f of files){
    if (f.type === 'application/pdf' || /\.pdf$/i.test(f.name)){
      const { images, text } = await pdfToImagesAndText(f);
      images.forEach(x => prepared.images.push(x));
      if (text) prepared.texts.push(text);
      log(`✓ رُفعت ${images.length}/${images.length} صفحة من ${f.name}`);
    }else if (f.type.startsWith('image/')){
      const img = await fileToImageDataURL(f);
      prepared.images.push(img);
      log(`✓ أُضيفت الصورة: ${f.name}`);
    }else{
      log(`⚠️ تم تجاهل ملف غير مدعوم: ${f.name}`);
    }
  }
  prepNote.textContent = `تم تجهيز ${prepared.images.length} صورة/صفحة + نص PDF للتحليل.`;
  return prepared;
}

function copy(text){ navigator.clipboard.writeText(text).catch(()=>{}); }

function renderMedsTable(report){
  const rows = report?.meds_table || report?.medications_table || [];
  if (!rows.length){ tableHost.style.display='none'; tableWrap.innerHTML=''; return; }
  const statusClass = s => s==='accepted'?'s-ok':(s==='questionable'?'s-warn':'s-bad');
  const statusBadge = s => s==='accepted'?'✅ مقبول':(s==='questionable'?'⚠️ قابل للرفض':'⛔ مرفوض');
  let html = '<table><thead><tr><th>البند</th><th>الجرعة/الكمية</th><th>الحالة</th><th>التعليل</th></tr></thead><tbody>';
  for (const r of rows){
    html += `<tr class="rowx">
      <td>${escapeHTML(r.item||'')}</td>
      <td>${escapeHTML([r.dose,r.quantity,r.regimen].filter(Boolean).join(' — ')||'')}</td>
      <td class="status ${statusClass(r.status||'')}">${statusBadge(r.status||'questionable')}</td>
      <td>${escapeHTML(r.why||'')}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  tableWrap.innerHTML = html;
  tableHost.style.display='block';
}

function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

async function analyze(){
  try{
    analyzeBtn.disabled = true; mergedEl.textContent = gptEl.textContent = gemEl.textContent = '';
    tableHost.style.display='none'; tableWrap.innerHTML='';

    const prepared = await prepareFiles();

    log('بدء التحليل ...');
    const body = {
      api_version: API_VERSION,
      language: document.getElementById('lang').value,
      model: document.getElementById('model').value,
      specialty: document.getElementById('specialty').value.trim(),
      insuranceContext: document.getElementById('context').value.trim(),
      images: prepared.images,
      texts: prepared.texts,
      temperature: 0.1
    };
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    const raw = await res.text();
    let data;
    try{ data = JSON.parse(raw); }catch{
      throw new Error(`فشل التحليل: JSON غير صالح.\n${raw.slice(0,400)}`);
    }

    if (data.error){ throw new Error(data.error); }

    const merged = JSON.stringify(data.merged, null, 2);
    const gpt = JSON.stringify(data.gpt, null, 2);
    const gem = JSON.stringify(data.gemini, null, 2);

    mergedEl.textContent = merged;
    gptEl.textContent = gpt;
    gemEl.textContent = gem;

    renderMedsTable(data.merged || data.gpt || data.gemini);

    document.getElementById('copyMerged').onclick = ()=>copy(merged);
    document.getElementById('copyGpt').onclick = ()=>copy(gpt);
    document.getElementById('copyGem').onclick = ()=>copy(gem);

    log('اكتمل التحليل.');
  }catch(err){
    alert(err.message || String(err));
    log('❌ '+ (err.message||String(err)));
  }finally{
    analyzeBtn.disabled = false;
  }
}

document.getElementById('analyzeBtn').addEventListener('click', analyze);
</script>
</body>
</html>
