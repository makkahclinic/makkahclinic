ØªÙ…Ø§Ù… â€” Ø®Ù„Ù‘Ù†Ø§ â€œÙ†Ù‚ÙÙ„Ù‡Ø§â€ ÙƒÙ„Ù‡Ø§ Ù…Ø±Ø© ÙˆØ­Ø¯Ø© âœ…
Ø³Ø£Ø¹Ø·ÙŠÙƒ Ø­Ø²Ù…Ø© Ø¥Ø¶Ø§ÙØ§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù†Ø³Ø® (UI + JS) ØªØ±ÙƒÙ‘Ø¨Ù‡Ø§ ÙÙˆÙ‚ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªÙƒØ³Ø± Ø£ÙŠ Ø´ÙŠØ¡.

Ø§Ù„ÙÙƒØ±Ø©: Ù†Ø³ØªØ®Ø¯Ù… allIncidentsCache Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ + Ø¯ÙˆØ§Ù„ getDept/getDate/normSeverity/normStatus/getId/getEscToâ€¦ ÙˆÙ†Ø¨Ù†ÙŠ ÙÙˆÙ‚Ù‡Ø§.

0) Ø£Ø¶Ù UI Ø³Ø±ÙŠØ¹ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù€ Dashboard

Ø¯Ø§Ø®Ù„ Ù‚Ø³Ù… Ø§Ù„Ù€ Heatmap (Ù‚Ø¨Ù„ <div id="incidentHeatmap"> Ù…Ø¨Ø§Ø´Ø±Ø©) Ø£Ø¶Ù:

<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
  <label style="font-weight:700;color:#1e3a5f;">
    <i class="fas fa-calendar-alt"></i> Ø§Ù„ÙØªØ±Ø©:
  </label>

  <select id="hmRange" class="form-control" style="width:220px;">
    <option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
    <option value="60">Ø¢Ø®Ø± 60 ÙŠÙˆÙ…</option>
    <option value="90" selected>Ø¢Ø®Ø± 90 ÙŠÙˆÙ…</option>
    <option value="365">Ø¢Ø®Ø± Ø³Ù†Ø©</option>
    <option value="all">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
  </select>

  <button class="btn btn-secondary btn-sm" onclick="refreshExecutiveView(true)">
    <i class="fas fa-bolt"></i> ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹
  </button>

  <button class="btn btn-primary btn-sm" onclick="exportHeatmapPDF()">
    <i class="fas fa-file-pdf"></i> PDF Heatmap
  </button>
</div>

<div id="deptRiskTrend" style="margin-top:12px;"></div>

<div id="toastContainer" style="position:fixed;left:20px;bottom:20px;z-index:99999;display:flex;flex-direction:column;gap:10px;"></div>

1) Ø£Ø¶Ù Ù…ÙƒØªØ¨Ø© PDF (Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ØªØµØ¯ÙŠØ± Heatmap PDF)

Ø¯Ø§Ø®Ù„ <head> Ø£Ø¶Ù:

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

2) Ø§Ù„ØµÙ‚ Ù‡Ø°Ø§ â€œØ§Ù„Ø¨Ù„ÙˆÙƒâ€ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¯Ø§Ø®Ù„ <script> (Ø¢Ø®Ø± Ø§Ù„Ù…Ù„Ù)

Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„ÙˆÙƒ ÙŠØ¶ÙŠÙ:

Heatmap Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª (30/60/90/â€¦)

Repeat Department Risk (ØªÙƒØ±Ø§Ø± + ÙˆØ²Ù†)

Risk Trend â†‘â†“ (Ù…Ù‚Ø§Ø±Ù†Ø© Ø¢Ø®Ø± 30 ÙŠÙˆÙ… Ù…Ø¹ 30 ÙŠÙˆÙ… Ù‚Ø¨Ù„Ù‡Ø§)

Toast Ø¨Ø¯Ù„ alert

ØµÙˆØª Ø¥Ù†Ø°Ø§Ø± (ÙˆÙØ§Ø© / ØªØµØ¹ÙŠØ¯ Ø¬Ø¯ÙŠØ¯)

ØªÙ‚Ø§Ø±ÙŠØ±: Heatmap PDF + RCA completion rate + SLA compliance

/* =========================
   Executive Add-ons Pack
   ========================= */

// ====== Settings
const SLA_HOURS = {
  acknowledge: 24, // ØªØ¹ÙŠÙŠÙ† Ù…Ø³Ø¤ÙˆÙ„ / Ø¨Ø¯Ø¡ Ù…ØªØ§Ø¨Ø¹Ø©
  rcaStart: 7 * 24, // Ø¨Ø¯Ø¡ RCA Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…
  closeMinor: 7 * 24, // Ø¥ØºÙ„Ø§Ù‚ (none/minor) Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…
  closeMajor: 14 * 24 // Ø¥ØºÙ„Ø§Ù‚ (moderate/severe/death) Ø®Ù„Ø§Ù„ 14 ÙŠÙˆÙ…
};

// ====== Helpers
function parseDateSafe(v) {
  const s = String(v || '').trim();
  if (!s) return null;
  const d = new Date(s);
  if (!isNaN(d.getTime())) return d;

  // Ù…Ø­Ø§ÙˆÙ„Ø©: yyyy-mm-dd (Ø¨Ø¯ÙˆÙ† ÙˆÙ‚Øª)
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (m) {
    const d2 = new Date(`${m[1]}-${m[2]}-${m[3]}T12:00:00`);
    if (!isNaN(d2.getTime())) return d2;
  }
  return null;
}

function withinDays(inc, days) {
  if (days === 'all') return true;
  const d = parseDateSafe(getDate(inc));
  if (!d) return false;
  const limit = Date.now() - (Number(days) * 86400000);
  return d.getTime() >= limit;
}

function lastActionDate(inc) {
  // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ followup Ø¢Ø®Ø±ØŒ Ø§Ø³ØªØ¹Ù…Ù„Ù‡â€¦ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ lastActionDate Ø£Ùˆ date
  const d = parseDateSafe(inc.lastActionDate) || parseDateSafe(getDate(inc));
  return d || new Date(0);
}

function hoursOpen(inc) {
  const st = normStatus(inc);
  if (st === 'closed') return 0;
  const ref = lastActionDate(inc);
  return Math.floor((Date.now() - ref.getTime()) / 36e5);
}

// ====== Toast (Ø¨Ø¯ÙŠÙ„ alert)
function toast(msg, type = 'info', timeout = 4500) {
  const box = document.getElementById('toastContainer');
  if (!box) return alert(msg);

  const el = document.createElement('div');
  el.style.cssText = `
    min-width:260px; max-width:420px;
    background:${type==='danger'?'#dc3545':type==='warning'?'#ffc107':type==='success'?'#28a745':'#1e3a5f'};
    color:${type==='warning'?'#222':'#fff'};
    padding:12px 14px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.18);
    display:flex;gap:10px;align-items:flex-start;
  `;
  const icon = type==='danger'?'fa-triangle-exclamation':type==='warning'?'fa-circle-exclamation':type==='success'?'fa-circle-check':'fa-circle-info';
  el.innerHTML = `<i class="fas ${icon}" style="margin-top:2px;"></i><div style="line-height:1.4">${msg}</div>`;
  box.appendChild(el);
  setTimeout(() => { el.remove(); }, timeout);
}

// ====== Sound Alert
let audioCtx;
function beep(freq = 880, ms = 180, gainVal = 0.05) {
  try {
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.value = freq;
    o.type = 'sine';
    g.gain.value = gainVal;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(() => { o.stop(); }, ms);
  } catch (e) {}
}

function alarmPattern(type) {
  // death = Ø£Ù‚ÙˆÙ‰
  if (type === 'death') { beep(880, 220, 0.07); setTimeout(()=>beep(660,220,0.07),260); setTimeout(()=>beep(880,260,0.07),520); return; }
  // escalated
  beep(740, 160, 0.06); setTimeout(()=>beep(740,160,0.06),220);
}

// ====== Risk Model
function sevWeightKey(sevKey) {
  if (sevKey === 'death') return 12;
  if (sevKey === 'severe') return 8;
  if (sevKey === 'moderate') return 4;
  if (sevKey === 'minor') return 2;
  return 1;
}

function rcaFlag(inc) {
  // ÙŠØ¯Ø¹Ù… Ø¹Ø±Ø¨ÙŠ/Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø­Ø³Ø¨ Ø´ÙŠØªÙƒ
  const raw = String(inc.RCA_Required ?? inc.rcaRequired ?? '').trim().toLowerCase();
  return raw === 'true' || raw === 'Ù†Ø¹Ù…' || raw === 'yes' || raw === 'y';
}

function riskExtras2(inc) {
  let extra = 0;
  const st = normStatus(inc);
  const esc = !!getEscTo(inc) || st === 'escalated';
  const rca = rcaFlag(inc) || st === 'rca_required' || st === 'rca_in_progress';

  if (esc) extra += 4;
  if (rca) extra += 3;

  const hrs = hoursOpen(inc);
  if (hrs >= 48) extra += 3;
  else if (hrs >= 24) extra += 2;

  return extra;
}

function riskScoreIncident(inc) {
  const sevKey = normSeverity(inc);
  return sevWeightKey(sevKey) + riskExtras2(inc);
}

// ====== Heatmap (time-based)
function buildIncidentHeatmapTimed(all, daysRange) {
  const filtered = all.filter(x => withinDays(x, daysRange));
  buildIncidentHeatmap(filtered); // ØªØ³ØªØ®Ø¯Ù… Ø¯Ø§Ù„ØªÙƒ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (ØªØ¨Ù†ÙŠ heatmap) â€” Ù…Ù…ØªØ§Ø²
}

// ====== Repeat Department Risk
function computeRepeatDeptRisk(all, daysRange) {
  const filtered = all.filter(x => withinDays(x, daysRange));
  const deptMap = new Map();

  for (const inc of filtered) {
    const dept = getDept(inc);
    if (!deptMap.has(dept)) deptMap.set(dept, { count: 0, risk: 0, severe: 0, escalated: 0 });
    const d = deptMap.get(dept);
    d.count += 1;
    const sev = normSeverity(inc);
    d.risk += riskScoreIncident(inc);
    if (sev === 'severe' || sev === 'death') d.severe += 1;
    if (normStatus(inc) === 'escalated' || getEscTo(inc)) d.escalated += 1;
  }

  // Repeat Risk Index = (risk / max(1,count)) + severe*2 + escalated*1.5
  const arr = Array.from(deptMap.entries()).map(([dept, d]) => {
    const rri = (d.risk / Math.max(1,d.count)) + (d.severe*2) + (d.escalated*1.5);
    return { dept, ...d, rri: Number(rri.toFixed(2)) };
  });

  arr.sort((a,b) => b.rri - a.rri);
  return arr;
}

// ====== Risk Trend â†‘â†“ (Ø¢Ø®Ø± 30 ÙŠÙˆÙ… vs 30 ÙŠÙˆÙ… Ù‚Ø¨Ù„Ù‡Ø§)
function computeDeptTrend(all) {
  const now30 = all.filter(x => withinDays(x, 30));
  const prev30 = all.filter(x => {
    const d = parseDateSafe(getDate(x));
    if (!d) return false;
    const t = d.getTime();
    const from = Date.now() - (60 * 86400000);
    const to = Date.now() - (30 * 86400000);
    return t >= from && t < to;
  });

  function sumRisk(list) {
    const m = new Map();
    for (const inc of list) {
      const dept = getDept(inc);
      m.set(dept, (m.get(dept) || 0) + riskScoreIncident(inc));
    }
    return m;
  }

  const a = sumRisk(now30);
  const b = sumRisk(prev30);

  const depts = Array.from(new Set([...a.keys(), ...b.keys()]));
  const rows = depts.map(dept => {
    const cur = a.get(dept) || 0;
    const prev = b.get(dept) || 0;
    const delta = cur - prev;
    const pct = prev ? ((delta / prev) * 100) : (cur ? 100 : 0);
    return { dept, cur, prev, delta, pct: Number(pct.toFixed(1)) };
  });

  rows.sort((x,y) => Math.abs(y.delta) - Math.abs(x.delta));
  return rows;
}

function renderDeptTrendCard(trendRows, repeatRows) {
  const box = document.getElementById('deptRiskTrend');
  if (!box) return;

  const topRepeat = repeatRows.slice(0, 6);
  const topTrend = trendRows.slice(0, 6);

  const trendHtml = topTrend.map(r => {
    const up = r.delta > 0;
    const icon = up ? 'fa-arrow-trend-up' : (r.delta < 0 ? 'fa-arrow-trend-down' : 'fa-minus');
    const color = up ? '#dc3545' : (r.delta < 0 ? '#28a745' : '#6c757d');
    return `
      <div style="background:#f8f9fa;border:1px solid #e9ecef;border-radius:12px;padding:10px;display:flex;justify-content:space-between;gap:10px;">
        <div style="font-weight:800;color:#1e3a5f;">${r.dept}</div>
        <div style="font-weight:800;color:${color};white-space:nowrap;">
          <i class="fas ${icon}"></i>
          ${r.delta>=0?'+':''}${Math.round(r.delta)} (${r.pct}%)
        </div>
      </div>
    `;
  }).join('');

  const repeatHtml = topRepeat.map(r => `
    <div style="background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:10px;display:flex;justify-content:space-between;gap:10px;">
      <div style="font-weight:800;color:#1e3a5f;">${r.dept}</div>
      <div style="font-weight:800;color:#6f42c1;white-space:nowrap;">
        RRI ${r.rri} | #${r.count}
      </div>
    </div>
  `).join('');

  box.innerHTML = `
    <div class="card" style="margin-top:18px;">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-ranking-star"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: Repeat Risk + Trend</h3>
      </div>
      <div class="card-body" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px;">
        <div>
          <div style="font-weight:900;color:#6f42c1;margin-bottom:10px;"><i class="fas fa-repeat"></i> Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØªÙƒØ±Ø§Ø±Ù‹Ø§ ÙˆØ®Ø·ÙˆØ±Ø© (RRI)</div>
          <div style="display:flex;flex-direction:column;gap:10px;">${repeatHtml}</div>
        </div>
        <div>
          <div style="font-weight:900;color:#dc3545;margin-bottom:10px;"><i class="fas fa-chart-line"></i> ØªØºÙŠÙ‘Ø± Ø§Ù„Ø®Ø·Ø± (Ø¢Ø®Ø± 30 ÙŠÙˆÙ… Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚)</div>
          <div style="display:flex;flex-direction:column;gap:10px;">${trendHtml}</div>
        </div>
      </div>
    </div>
  `;
}

// ====== SLA Compliance + RCA completion rate
function computeRcaCompletion(all, daysRange) {
  const list = all.filter(x => withinDays(x, daysRange));
  const need = list.filter(i => {
    const st = normStatus(i);
    const sev = normSeverity(i);
    return st !== 'closed' && (st === 'rca_required' || st === 'rca_in_progress' || rcaFlag(i) || sev === 'severe' || sev === 'death');
  });

  const inProgress = need.filter(i => normStatus(i) === 'rca_in_progress').length;
  const started = need.filter(i => normStatus(i) === 'rca_in_progress' || normStatus(i) === 'in_progress' || norm(i.rootCause)).length;
  const completed = list.filter(i => {
    const st = normStatus(i);
    // Ø§ÙØªØ±Ø¶: RCA Ù…ÙƒØªÙ…Ù„ Ø¥Ø°Ø§ ÙÙŠÙ‡ rootCause + correctiveActions
    const ok = !!norm(i.rootCause) && !!norm(i.correctiveActions);
    return ok || st === 'in_progress' || st === 'closed';
  }).length;

  return {
    need: need.length,
    inProgress,
    started,
    completed,
    rate: need.length ? Math.round((started / need.length) * 100) : 100
  };
}

function computeSla(all, daysRange) {
  const list = all.filter(x => withinDays(x, daysRange));

  let totalOpen = 0;
  let okAck = 0;

  let totalClose = 0;
  let okClose = 0;

  let totalRcaStart = 0;
  let okRcaStart = 0;

  for (const inc of list) {
    const st = normStatus(inc);
    const sev = normSeverity(inc);
    const hrs = hoursOpen(inc);

    // Acknowledge SLA: Ø¥Ù† ÙƒØ§Ù†Øª â€œÙ…ÙØªÙˆØ­Ø©â€ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ assignedTo Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©
    if (st !== 'closed') {
      totalOpen += 1;
      // Ø¥Ø°Ø§ assignedTo Ù…ÙˆØ¬ÙˆØ¯ â†’ Ù†Ø¹ØªØ¨Ø± ØªÙ… acknowledgment
      if (norm(inc.assignedTo)) okAck += 1;
      else if (hrs <= SLA_HOURS.acknowledge) okAck += 1; // Ù„Ø§Ø²Ø§Ù„ Ø¶Ù…Ù† SLA
    }

    // Close SLA
    if (st === 'closed') {
      totalClose += 1;
      const closeHrsLimit = (sev === 'none' || sev === 'minor') ? SLA_HOURS.closeMinor : SLA_HOURS.closeMajor;

      const incD = parseDateSafe(getDate(inc));
      const closeD = parseDateSafe(getClosedDate(inc));
      if (incD && closeD) {
        const durHrs = Math.floor((closeD.getTime() - incD.getTime()) / 36e5);
        if (durHrs <= closeHrsLimit) okClose += 1;
      } else {
        // Ù„Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©ØŒ Ù„Ø§ Ù†ÙƒØ³Ø± Ø§Ù„Ù…Ø¤Ø´Ø± â€” Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨Ø©
      }
    }

    // RCA Start SLA (Ù„Ù„Ø­Ø§Ù„Ø§Øª severe/death/rca_required)
    const needsRca = (sev === 'severe' || sev === 'death' || normStatus(inc) === 'rca_required' || rcaFlag(inc));
    if (needsRca && st !== 'closed') {
      totalRcaStart += 1;
      // Ø¥Ø°Ø§ Ø¯Ø®Ù„ rca_in_progress Ø£Ùˆ ÙŠÙˆØ¬Ø¯ rootCause â†’ Ø¨Ø¯Ø£
      if (normStatus(inc) === 'rca_in_progress' || norm(inc.rootCause)) okRcaStart += 1;
      else if (hrs <= SLA_HOURS.rcaStart) okRcaStart += 1; // Ù„Ø§Ø²Ø§Ù„ Ø¶Ù…Ù† SLA
    }
  }

  const pct = (a,b) => b ? Math.round((a/b)*100) : 100;
  return {
    ack: { ok: okAck, total: totalOpen, pct: pct(okAck,totalOpen) },
    close: { ok: okClose, total: totalClose, pct: pct(okClose,totalClose) },
    rcaStart: { ok: okRcaStart, total: totalRcaStart, pct: pct(okRcaStart,totalRcaStart) }
  };
}

function renderComplianceCards(rca, sla) {
  // Ù†Ø¶ÙŠÙÙ‡Ø§ ØªØ­Øª deptRiskTrend
  const box = document.getElementById('deptRiskTrend');
  if (!box) return;

  const card = document.createElement('div');
  card.className = 'card';
  card.style.marginTop = '18px';
  card.innerHTML = `
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-shield-check"></i> Ù…Ø¤Ø´Ø±Ø§Øª RCA + SLA</h3>
    </div>
    <div class="card-body" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;">
      <div style="background:#f8f9fa;border:1px solid #e9ecef;border-radius:12px;padding:12px;">
        <div style="font-weight:900;color:#6f42c1;margin-bottom:6px;">RCA Completion Rate</div>
        <div style="font-size:28px;font-weight:900;color:#1e3a5f;">${rca.rate}%</div>
        <div style="color:#666;font-size:0.9rem;">Ù…Ø·Ù„ÙˆØ¨ RCA: ${rca.need} | Ø¨Ø¯Ø£/Ù…ÙƒØªÙ…Ù„: ${rca.started}</div>
      </div>

      <div style="background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:12px;">
        <div style="font-weight:900;color:#1e3a5f;margin-bottom:6px;">SLA Acknowledge</div>
        <div style="font-size:28px;font-weight:900;color:${sla.ack.pct<80?'#dc3545':'#28a745'};">${sla.ack.pct}%</div>
        <div style="color:#666;font-size:0.9rem;">${sla.ack.ok}/${sla.ack.total}</div>
      </div>

      <div style="background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:12px;">
        <div style="font-weight:900;color:#1e3a5f;margin-bottom:6px;">SLA RCA Start</div>
        <div style="font-size:28px;font-weight:900;color:${sla.rcaStart.pct<80?'#dc3545':'#28a745'};">${sla.rcaStart.pct}%</div>
        <div style="color:#666;font-size:0.9rem;">${sla.rcaStart.ok}/${sla.rcaStart.total}</div>
      </div>

      <div style="background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:12px;">
        <div style="font-weight:900;color:#1e3a5f;margin-bottom:6px;">SLA Close</div>
        <div style="font-size:28px;font-weight:900;color:${sla.close.pct<80?'#dc3545':'#28a745'};">${sla.close.pct}%</div>
        <div style="color:#666;font-size:0.9rem;">${sla.close.ok}/${sla.close.total}</div>
      </div>
    </div>
  `;
  box.appendChild(card);
}

// ====== Heatmap PDF
async function exportHeatmapPDF() {
  const el = document.getElementById('incidentHeatmap');
  if (!el) return toast('Heatmap ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'warning');

  toast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDFâ€¦', 'info', 2500);
  const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#ffffff' });
  const imgData = canvas.toDataURL('image/png');

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'mm', 'a4');

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø©
  const imgW = pageW - 16;
  const imgH = (canvas.height * imgW) / canvas.width;

  pdf.addImage(imgData, 'PNG', 8, 10, imgW, Math.min(imgH, pageH - 20));
  pdf.save(`Heatmap_${new Date().toISOString().slice(0,10)}.pdf`);
  toast('ØªÙ… ØªØµØ¯ÙŠØ± Heatmap PDF âœ…', 'success');
}

// ====== New Escalation / Death notifications (delta check)
function diffKey(i) {
  return `${getId(i)}|${normStatus(i)}|${getEscTo(i)}|${normSeverity(i)}`;
}

function checkNewAlerts(all) {
  const key = 'incident_alert_snapshot_v1';
  const oldRaw = localStorage.getItem(key);
  const old = oldRaw ? new Set(JSON.parse(oldRaw)) : new Set();

  const nowSet = new Set(all.map(diffKey));
  localStorage.setItem(key, JSON.stringify(Array.from(nowSet)));

  // ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ ÙˆÙØ§Ø© Ø£Ùˆ ØªØµØ¹ÙŠØ¯ Ø¬Ø¯ÙŠØ¯
  for (const inc of all) {
    const k = diffKey(inc);
    if (old.has(k)) continue;

    const sev = normSeverity(inc);
    const st = normStatus(inc);
    const esc = !!getEscTo(inc) || st === 'escalated';

    if (sev === 'death') {
      toast(`ğŸš¨ ÙˆÙØ§Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${getId(inc)} | ${getDept(inc)}`, 'danger', 8000);
      alarmPattern('death');
    } else if (esc) {
      toast(`âš ï¸ ØªØµØ¹ÙŠØ¯ Ø¬Ø¯ÙŠØ¯: ${getId(inc)} â†’ ${getEscTo(inc) || 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'}`, 'warning', 6500);
      alarmPattern('escalated');
    }
  }
}

// ====== One entry point for executive refresh
async function refreshExecutiveView(force = false) {
  const range = (document.getElementById('hmRange')?.value || '90');
  const all = await loadAllIncidentsCached(force);

  // Heatmap time-based
  buildIncidentHeatmapTimed(all, range);

  // Repeat Risk + Trend
  const repeat = computeRepeatDeptRisk(all, range);
  const trend = computeDeptTrend(all);
  renderDeptTrendCard(trend, repeat);

  // RCA + SLA
  const rca = computeRcaCompletion(all, range);
  const sla = computeSla(all, range);
  renderComplianceCards(rca, sla);

  // Alerts
  checkNewAlerts(all);
}

// ====== Hook: range change auto-refresh
document.addEventListener('change', (e) => {
  if (e.target && e.target.id === 'hmRange') refreshExecutiveView(false);
});

// ====== Call once after login/data load
// Ø¶ÙŠÙ Ù‡Ø°Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© loadData() Ø¹Ù†Ø¯Ùƒ Ø¨Ø¹Ø¯ buildIncidentHeatmap(all):
// await refreshExecutiveView(false);

3) ØªØ¹Ø¯ÙŠÙ„ ØµØºÙŠØ± ÙÙŠ loadData() Ø¹Ù†Ø¯Ùƒ (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯)

Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ¹Ù…Ù„:

buildIncidentHeatmap(all);


Ø£Ø¶Ù:

await refreshExecutiveView(false);

4) Ø£Ù‡Ù… â€œØ®Ù„Ù„ Ù…Ù†Ø·Ù‚ÙŠâ€ Ù„Ø§Ø²Ù… ØªÙ†ØªØ¨Ù‡ Ù„Ù‡ (Ø­ØªÙ‰ Ù…Ø§ ØªØªÙ„Ø®Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)

Ø£Ù†Øª Ø¹Ù†Ø¯Ùƒ Ø§Ù„Ø¢Ù† Ù…ØµØ¯Ø±ÙŠÙ† Ù„Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª:

loadData() ÙŠØ­Ø³Ø¨ escalated/closed Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

loadStats() Ù‚Ø¯ ÙŠÙƒØªØ¨ ÙÙˆÙ‚Ù‡Ø§ Ù…Ù† byStatus

âœ… Ø£Ù†Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ø¯Ù‘Ù„ØªÙ‡Ø§ Ø¬Ø²Ø¦ÙŠÙ‹Ø§ (Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡).
Ø§Ù„Ø£ÙØ¶Ù„: Ø®Ù„ÙŠ Ù…ØµØ¯Ø± ÙˆØ§Ø­Ø¯ â€œØ­Ø§ÙƒÙ…â€ Ù„Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© ÙˆÙ‡Ùˆ loadData()ØŒ ÙˆØ®Ù„ loadStats() ÙÙ‚Ø· Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©.

ÙÙŠ loadStats() Ø§Ø­Ø°Ù/Ø¹Ù„Ù‘Ù‚ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù€:

escalatedTabCount / closedTabCount


ÙˆØ®Ù„ÙŠÙ‡Ø§ ØªÙØ¯Ø§Ø± Ù…Ù† refreshExecutiveView + loadData.

5) Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†Ùƒ Ø§Ù„Ø¢Ù† (Ø®Ø·ÙˆØ§Øª ØªÙ†ÙÙŠØ° Ø¯Ù‚ÙŠÙ‚Ø©)

Ø£Ø¶Ù UI controls (Ø§Ù„Ø¬Ø²Ø¡ Ø±Ù‚Ù… 0)

Ø£Ø¶Ù scripts pdf libs (Ø§Ù„Ø¬Ø²Ø¡ Ø±Ù‚Ù… 1)

Ø§Ù„ØµÙ‚ Executive Add-ons Pack (Ø§Ù„Ø¬Ø²Ø¡ Ø±Ù‚Ù… 2)

Ø£Ø¶Ù await refreshExecutiveView(false); Ø¨Ø¹Ø¯ heatmap ÙÙŠ loadData()

ÙˆØ¨ÙƒØ°Ø§ ØªÙƒÙˆÙ† Ø®Ù„Ù‘ØµØª ÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:

âœ… Heatmap Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
âœ… Repeat Department Risk
âœ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø¨ Risk Trend
âœ… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª + ØµÙˆØª
âœ… Toast Ø¨Ø¯Ù„ alert
âœ… Heatmap PDF
âœ… RCA completion rate
âœ… SLA compliance