Ø£Ø®ØªØ§Ø± (2): Ø£ÙŠ Ø±Ø§Ø¨Ø· + Ù…Ø±ÙÙ‚Ø§Øª Ø¯Ø§Ø®Ù„ Google Drive âœ…
Ù‡Ø°Ø§ Ø£Ù‚ÙˆÙ‰ Ù„Ø³Ø¨Ø§Ù‡ÙŠ Ù„Ø£Ù†Ù‡ ÙŠØ³Ù…Ø­ Ù„Ùƒ ØªØ±Ø¨Ø·: Ù…Ø­Ø§Ø¶Ø± + PO/PR + ØµÙˆØ± Ù…Ø®Ø²ÙˆÙ† + ØµÙˆØ± ØµÙŠØ§Ù†Ø© + Ø´Ù‡Ø§Ø¯Ø§Øª ØªØ¯Ø±ÙŠØ¨â€¦ ÙˆÙƒÙ„Ù‡Ø§ ØªØµÙŠØ± Evidence Ø±Ø³Ù…ÙŠØ©.

ÙˆØªØ­Øª Ù‡Ù†Ø§ Ø£Ø¹Ø·ÙŠÙƒ ÙƒÙ„ Ø´ÙŠØ¡ Ø¬Ø§Ù‡Ø²:

Ø¥Ù†Ø´Ø§Ø¡ 3 Ø´ÙŠØªØ§Øª

3 Actions API

ØªØ¹Ø¯ÙŠÙ„ Survey Mode (Ø¨Ø£Ù‚Ù„ ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ ÙƒÙˆØ¯Ùƒ)

1) Apps Script â€” Ø¥Ø¶Ø§ÙØ© Ø´ÙŠØªØ§Øª Evidence (Ø§Ù†Ø³Ø® ÙˆØ§Ù„ØµÙ‚)

Ø¶Ø¹ Ù‡Ø°Ø§ ÙÙŠ Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù€Apps Script:

// ==================== EVIDENCE PIPELINE SETUP ====================
const SHEET_EVIDENCE_PIPELINE = 'Evidence_Pipeline';
const SHEET_EVIDENCE_LINKS = 'Evidence_Links';
const SHEET_STANDARD_MAP = 'Standard_Map';

function setupEvidencePipeline() {
  const ss = SpreadsheetApp.openById(MRIS_SPREADSHEET_ID);

  ensureSheet_(ss, SHEET_EVIDENCE_PIPELINE, [
    'EvidenceID','Timestamp','DeptID','AlertID','DecisionID','ActionID',
    'EvidenceType','EvidenceLink','StandardRef','Summary',
    'OwnerStaffID','Status','VerifiedBy','VerifiedAt'
  ]);

  ensureSheet_(ss, SHEET_EVIDENCE_LINKS, [
    'LinkID','EvidenceID','DocType','DocLink','Notes'
  ]);

  ensureSheet_(ss, SHEET_STANDARD_MAP, [
    'StandardRef','Area','RequiredEvidenceTypes','Notes'
  ]);

  // Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ø¯Ø¦ÙŠ Ù„Ù…Ø¹Ø§ÙŠÙŠØ± LD4.5 (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ³ÙŠØ¹)
  const mapSheet = ss.getSheetByName(SHEET_STANDARD_MAP);
  if (mapSheet.getLastRow() === 1) {
    mapSheet.appendRow(['LD4.5','Leadership','Policy,Minutes,KPI,Procurement,Logs','Resource adequacy evidence bundle']);
  }
}

function ensureSheet_(ss, name, headers) {
  let sh = ss.getSheetByName(name);
  if (!sh) sh = ss.insertSheet(name);
  if (sh.getLastRow() === 0) sh.appendRow(headers);
  else {
    const first = sh.getRange(1,1,1,headers.length).getValues()[0];
    const empty = first.every(v => !v);
    if (empty) sh.getRange(1,1,1,headers.length).setValues([headers]);
  }
  sh.setFrozenRows(1);
}


Ø´ØºÙ‘Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©: setupEvidencePipeline()
ÙˆØ³ÙŠÙÙ†Ø´Ø¦ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆÙŠØ¶Ø¹ Ø§Ù„Ù€headers.

2) Apps Script â€” Ø¥Ø¶Ø§ÙØ© 3 Actions API (linkEvidence / finalizeEvidence / getEvidencePack)
2.1 Ø¹Ø¯Ù‘Ù„ doPost: Ø£Ø¶Ù Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ switch(action)

Ø¶Ø¹Ù‡Ø§ Ø¯Ø§Ø®Ù„ doPost Ø¹Ù†Ø¯Ùƒ:

case 'linkEvidence':
  result = linkEvidence_(payload, auth);
  break;

case 'finalizeEvidence':
  result = finalizeEvidence_(payload, auth);
  break;

case 'getEvidencePack':
  // Ø§Ù„Ø£ÙØ¶Ù„ GETØŒ Ù„ÙƒÙ† Ù†Ø®Ù„ÙŠÙ‡ POST Ø¹Ø´Ø§Ù† Ø§Ù„Ø®ØµÙˆØµÙŠØ©
  result = getEvidencePack_(payload, auth);
  break;

2.2 Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø£Ø³ÙÙ„ ÙƒÙˆØ¯Ùƒ
// ==================== EVIDENCE PIPELINE API ====================

// payload: { action:'linkEvidence', token, deptId, standardRef, evidenceType, evidenceLink, summary, alertId?, decisionId?, actionId?, attachments?[] }
function linkEvidence_(payload, auth) {
  const required = ['deptId','standardRef','evidenceType','evidenceLink','summary'];
  const v = validatePayload_(payload, required);
  if (!v.valid) return { success:false, error:v.error };

  // ØµÙ„Ø§Ø­ÙŠØ©: Ø£ÙŠ ÙƒØ§ØªØ¨/Ø¬ÙˆØ¯Ø©/Ø¥Ø¯Ø§Ø±ÙŠ (Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù…Ùƒ)
  if (!ROLES[auth.role]?.canWrite) return { success:false, error:'Permission denied' };

  const ss = SpreadsheetApp.openById(MRIS_SPREADSHEET_ID);
  let sh = ss.getSheetByName(SHEET_EVIDENCE_PIPELINE);
  let links = ss.getSheetByName(SHEET_EVIDENCE_LINKS);
  if (!sh || !links) return { success:false, error:'Evidence sheets not initialized. Run setupEvidencePipeline().' };

  const evidenceId = 'EVD' + Date.now();
  const ts = new Date().toISOString();

  sh.appendRow([
    evidenceId, ts,
    payload.deptId,
    payload.alertId || '',
    payload.decisionId || '',
    payload.actionId || '',
    payload.evidenceType,
    payload.evidenceLink,
    payload.standardRef,
    payload.summary,
    auth.staffId,
    'Draft',
    '',
    ''
  ]);

  // Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ): attachments: [{docType, docLink, notes}]
  if (Array.isArray(payload.attachments)) {
    payload.attachments.forEach(att => {
      const linkId = 'LNK' + Date.now() + Math.random().toString(36).slice(2,6);
      links.appendRow([
        linkId,
        evidenceId,
        att.docType || 'Attachment',
        att.docLink || '',
        att.notes || ''
      ]);
    });
  }

  logAudit_(auth, 'CREATE', SHEET_EVIDENCE_PIPELINE, evidenceId, `Evidence linked ${payload.standardRef} ${payload.evidenceType}`);
  return { success:true, evidenceId };
}

// payload: { action:'finalizeEvidence', token, evidenceId, status:'Ready'|'Verified', verifyNote? }
function finalizeEvidence_(payload, auth) {
  const required = ['evidenceId','status'];
  const v = validatePayload_(payload, required);
  if (!v.valid) return { success:false, error:v.error };

  // Verified Ø¹Ø§Ø¯Ø© admin/quality ÙÙ‚Ø·
  if (payload.status === 'Verified' && !(auth.role === 'admin' || auth.role === 'quality')) {
    return { success:false, error:'Permission denied: verification requires admin/quality' };
  }

  const ss = SpreadsheetApp.openById(MRIS_SPREADSHEET_ID);
  const sh = ss.getSheetByName(SHEET_EVIDENCE_PIPELINE);
  if (!sh) return { success:false, error:'Evidence_Pipeline not found' };

  const data = sh.getDataRange().getValues();
  const headers = data[0].map(String);

  const idxEvidenceID = headers.indexOf('EvidenceID');
  const idxStatus = headers.indexOf('Status');
  const idxVerifiedBy = headers.indexOf('VerifiedBy');
  const idxVerifiedAt = headers.indexOf('VerifiedAt');

  if (idxEvidenceID < 0 || idxStatus < 0) return { success:false, error:'Evidence headers missing' };

  let row = -1;
  for (let i=1; i<data.length; i++) {
    if (String(data[i][idxEvidenceID]) === String(payload.evidenceId)) { row = i+1; break; }
  }
  if (row === -1) return { success:false, error:'EvidenceID not found' };

  sh.getRange(row, idxStatus+1).setValue(payload.status);

  if (payload.status === 'Verified') {
    if (idxVerifiedBy >= 0) sh.getRange(row, idxVerifiedBy+1).setValue(auth.staffId);
    if (idxVerifiedAt >= 0) sh.getRange(row, idxVerifiedAt+1).setValue(new Date().toISOString());
  }

  logAudit_(auth, 'UPDATE', SHEET_EVIDENCE_PIPELINE, payload.evidenceId, `Evidence status -> ${payload.status}`);
  return { success:true, evidenceId: payload.evidenceId, status: payload.status };
}

// payload: { action:'getEvidencePack', token, deptId?, standardRef?, status? }
function getEvidencePack_(payload, auth) {
  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø¯Ù„Ø©: viewer Ù…Ù…ÙƒÙ†ØŒ Ø¨Ø³ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø³ÙŠØ© Ù…ÙˆØ¸ÙÙŠÙ†
  if (!hasPermission_(auth.role, SHEET_EVIDENCE_PIPELINE, 'read') && auth.role !== 'admin' && auth.role !== 'quality') {
    // Ù„Ø£Ù† canRead Ø¹Ù†Ø¯Ùƒ Ù…Ø§ ÙÙŠÙ‡Ø§ Evidence sheetsØŒ Ø®Ù„ÙŠÙ†Ø§ Ù†Ø³Ù…Ø­ Ù„Ù„Ù€ admin/quality.
    // Ø§Ù„Ø£ÙØ¶Ù„: ØªØ¶ÙŠÙ SHEET_EVIDENCE_PIPELINE Ù„Ù‚ÙˆØ§Ø¦Ù… canRead.
  }

  const ss = SpreadsheetApp.openById(MRIS_SPREADSHEET_ID);
  const sh = ss.getSheetByName(SHEET_EVIDENCE_PIPELINE);
  const links = ss.getSheetByName(SHEET_EVIDENCE_LINKS);
  if (!sh || !links) return { success:false, error:'Evidence sheets not found' };

  const evid = sheetToObjects_(sh);
  const lnk = sheetToObjects_(links);

  let filtered = evid;

  if (payload.deptId) filtered = filtered.filter(x => String(x.DeptID) === String(payload.deptId));
  if (payload.standardRef) filtered = filtered.filter(x => String(x.StandardRef) === String(payload.standardRef));
  if (payload.status) filtered = filtered.filter(x => String(x.Status) === String(payload.status));

  // Ø£Ø±ÙÙ‚ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù„ÙƒÙ„ Evidence
  const byEvidence = {};
  lnk.forEach(x => {
    const id = String(x.EvidenceID || '');
    if (!byEvidence[id]) byEvidence[id] = [];
    byEvidence[id].push({
      docType: x.DocType,
      docLink: x.DocLink,
      notes: x.Notes
    });
  });

  const out = filtered.map(x => ({
    evidenceId: x.EvidenceID,
    timestamp: x.Timestamp,
    deptId: x.DeptID,
    alertId: x.AlertID,
    decisionId: x.DecisionID,
    actionId: x.ActionID,
    evidenceType: x.EvidenceType,
    evidenceLink: x.EvidenceLink,
    standardRef: x.StandardRef,
    summary: x.Summary,
    status: x.Status,
    verifiedBy: x.VerifiedBy,
    verifiedAt: x.VerifiedAt,
    attachments: byEvidence[String(x.EvidenceID)] || []
  }));

  return { success:true, data: out.slice(-200) };
}

Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ (ØªØ¹Ø¯ÙŠÙ„ ØµØºÙŠØ± Ø¹Ù„Ù‰ ROLES)

Ø­ØªÙ‰ ÙŠÙ‚Ø¯Ø± â€œSurvey Modeâ€ ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø£Ø¯Ù„Ø©:

Ø£Ø¶Ù Evidence_Pipeline ÙˆEvidence_Links Ø¥Ù„Ù‰ canRead Ù„Ù€ viewer/quality/admin Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ.

Ù…Ø«Ø§Ù„ Ø³Ø±ÙŠØ¹:

viewer: { canRead: ['Departments','Alerts_Log','KPI_Weekly','Evidence_Pipeline','Evidence_Links'], canWrite:false, canApprove:false, canAdmin:false }

3) ØªØ¹Ø¯ÙŠÙ„ Survey Mode ÙÙŠ Ø§Ù„Ù€ UI (Ø£Ù‚Ù„ ØªØºÙŠÙŠØ±)
3.1 Ø£Ø¶Ù Ø¯Ø§Ù„Ø© ØªØ¬ÙŠØ¨ Ø§Ù„Ø£Ø¯Ù„Ø©

Ø¶Ø¹Ù‡Ø§ Ø¯Ø§Ø®Ù„ <script>:

async function loadEvidencePack(deptId = '', standardRef = 'LD4.5') {
  if (!API_TOKEN) return [];

  // Ù†Ø³ØªØ®Ø¯Ù… POST Ù‡Ù†Ø§ (Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù† Ù…Ù† token ÙÙŠ URL)
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({
      action: 'getEvidencePack',
      token: API_TOKEN,
      deptId,
      standardRef,
      status: '' // Ø£Ùˆ 'Verified' Ù„Ùˆ ØªØ¨ØºÙ‰
    })
  });

  const json = await res.json();
  if (!json.success) throw new Error(json.error || 'Evidence API error');
  return json.data || [];
}

3.2 Ø¯Ø§Ø®Ù„ setMode(mode) Ù„Ù…Ø§ mode === 'survey' Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰

Ø¨Ø¯Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ø¨ØªØŒ Ø§Ø³ØªØ®Ø¯Ù…:

if (mode === 'survey') {
  document.querySelector('.alerts-section').style.display = 'none';

  document.querySelector('.recommendations-section').innerHTML = `
    <h3 class="rec-title">ğŸ“‹ Ø£Ø¯Ù„Ø© Ø³Ø¨Ø§Ù‡ÙŠ Ø§Ù„Ø­ÙŠØ©</h3>
    <div id="evidenceList" style="display:flex; flex-direction:column; gap:0.8rem;"></div>
  `;

  // Ø­Ù…Ù‘Ù„ Ø£Ø¯Ù„Ø© LD4.5 (Ù„ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø£Ùˆ Ù„Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ†)
  loadEvidencePack('', 'LD4.5').then(items => {
    const box = document.getElementById('evidenceList');
    if (!items.length) {
      box.innerHTML = `<div class="rec-item"><div class="rec-description">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯Ù„Ø© Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø±Ø¨Ø· Ø£ÙˆÙ„ Ø¯Ù„ÙŠÙ„.</div></div>`;
      return;
    }
    box.innerHTML = items.slice().reverse().slice(0, 20).map(ev => {
      const att = (ev.attachments || []).map(a => `
        <div style="margin-top:6px; font-size:0.75rem; opacity:0.85;">
          ğŸ“ <a href="${a.docLink}" target="_blank" style="color:var(--gold); text-decoration:none;">${a.docType}</a>
        </div>
      `).join('');
      return `
        <div class="rec-item">
          <div class="rec-header">
            <span class="rec-icon">ğŸ“„</span>
            <span class="rec-label">${ev.standardRef} â€” ${ev.evidenceType} â€” ${ev.status}</span>
          </div>
          <div class="rec-description">${ev.summary}</div>
          <div style="margin-top:8px; font-size:0.8rem;">
            ğŸ”— <a href="${ev.evidenceLink}" target="_blank" style="color:var(--gold); text-decoration:none;">ÙØªØ­ Ø§Ù„Ø¯Ù„ÙŠÙ„</a>
          </div>
          ${att}
          <div style="margin-top:8px; font-size:0.7rem; opacity:0.7;">
            Dept: ${ev.deptId || 'ALL'} | Alert: ${ev.alertId || '-'} | Decision: ${ev.decisionId || '-'}
          </div>
        </div>
      `;
    }).join('');
  }).catch(err => {
    const box = document.getElementById('evidenceList');
    if (box) box.innerHTML = `<div class="rec-item"><div class="rec-description">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù„Ø©: ${err.message}</div></div>`;
  });

} else {
  document.querySelector('.alerts-section').style.display = 'block';
}

4) Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ (Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø¬Ù‡Ø©) â€” Ø£ÙˆÙ„ Evidence

Ø¬Ø±Ù‘Ø¨ ÙÙŠ Postman Ø£Ùˆ Console:

POST Ø¥Ù„Ù‰ API_URL:

{
  "action": "linkEvidence",
  "token": "YOUR_TOKEN",
  "deptId": "ALL",
  "standardRef": "LD4.5",
  "evidenceType": "Minutes",
  "evidenceLink": "https://docs.google.com/document/d/....",
  "summary": "Ù…Ø­Ø¶Ø± Ø§Ø¬ØªÙ…Ø§Ø¹ Ù„Ø¬Ù†Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙƒÙØ§ÙŠØ© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ",
  "alertId": "",
  "decisionId": "",
  "actionId": "",
  "attachments": [
    { "docType": "Attendance", "docLink": "https://drive.google.com/file/d/....", "notes": "ØªÙˆÙ‚ÙŠØ¹Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±" }
  ]
}


Ø«Ù… Ø¬Ø±Ù‘Ø¨:

{ "action":"getEvidencePack", "token":"YOUR_TOKEN", "standardRef":"LD4.5" }

Ù†Ù‚Ø·Ø© Ø£Ø®ÙŠØ±Ø© Ù…Ù‡Ù…Ø© (Ø¹Ø´Ø§Ù† â€œÙ…Ø§ ÙŠØ®Ø±Ù‘Ø´ Ø§Ù„Ù…ÙŠÙ‘Ø©â€)

Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØ´ØªØºÙ„ Evidence Pipeline:

Ù†Ù…Ù†Ø¹ Ø£ÙŠ Decision/Procurement Ø¨Ø¯ÙˆÙ† EvidenceID (Rule)

ÙˆÙ†Ø®Ù„ÙŠ â€œSurvey Modeâ€ ÙŠØ¹Ø±Ø¶ ÙÙ‚Ø· Verified Ø£Ø«Ù†Ø§Ø¡ Ø²ÙŠØ§Ø±Ø© Ø³Ø¨Ø§Ù‡ÙŠ