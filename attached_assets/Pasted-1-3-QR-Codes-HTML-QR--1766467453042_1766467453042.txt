1) استبدال جزء الـ 3 QR Codes (حجم + تنسيق)
أ) استبدل الـ HTML الحالي الخاص بالـ QR بهذا (فقط هذا الجزء)

ضعه مكان <div class="qr-section-pink"> ... </div> الحالي:

<!-- QR Codes Section (FIXED) -->
<div class="qr-section-pink">
  <div class="qr-section-title"><i class="fas fa-qrcode"></i> روابط سريعة - امسح بالجوال</div>

  <div class="qr-pink-cards">
    <a href="emergency-report.html" class="qr-pink-card qr-pink-card--danger">
      <div class="qr">
        <img
          src="https://api.qrserver.com/v1/create-qr-code/?size=360x360&data=https://m2020m.org/emergency-report.html&ecc=H"
          alt="QR - إبلاغ طوارئ">
      </div>
      <div class="meta">
        <div class="name"><i class="fas fa-exclamation-triangle"></i> إبلاغ طوارئ</div>
        <div class="desc">نموذج البلاغ السريع</div>
        <div class="url" dir="ltr">m2020m.org/emergency-report.html</div>
      </div>
    </a>

    <a href="Emergency.html" class="qr-pink-card qr-pink-card--info">
      <div class="qr">
        <img
          src="https://api.qrserver.com/v1/create-qr-code/?size=360x360&data=https://m2020m.org/Emergency.html&ecc=H"
          alt="QR - طوارئ الشاشات">
      </div>
      <div class="meta">
        <div class="name"><i class="fas fa-tv"></i> طوارئ الشاشات</div>
        <div class="desc">شاشة عرض التنبيه</div>
        <div class="url" dir="ltr">m2020m.org/Emergency.html</div>
      </div>
    </a>

    <a href="emergency-poster.html" class="qr-pink-card qr-pink-card--gold">
      <div class="qr">
        <img
          src="https://api.qrserver.com/v1/create-qr-code/?size=360x360&data=https://m2020m.org/emergency-poster.html&ecc=H"
          alt="QR - البوستر">
      </div>
      <div class="meta">
        <div class="name"><i class="fas fa-image"></i> البوستر</div>
        <div class="desc">بوستر الطوارئ للطباعة</div>
        <div class="url" dir="ltr">m2020m.org/emergency-poster.html</div>
      </div>
    </a>
  </div>
</div>

ب) استبدل/أضف CSS التالي (مكان تعريفات .qr-pink-cards و .qr-pink-card القديمة)
/* === FIX: QR section (3 QR) === */
.qr-section-pink{
  --qr: 148px; /* حجم الـ QR على الشاشة */
  background:linear-gradient(135deg,rgba(236,72,153,.14),rgba(244,114,182,.18));
  border:2px solid rgba(236,72,153,.35);
  border-radius:18px;
  padding:16px;
}

.qr-section-title{
  text-align:center;
  font-weight:1000;
  font-size:1.05rem;
  color:#ec4899;
  margin-bottom:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

.qr-pink-cards{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:14px;
  align-items:stretch;
}

@media(max-width:900px){
  .qr-pink-cards{grid-template-columns:1fr;}
}

.qr-pink-card{
  text-decoration:none;
  border-radius:16px;
  padding:14px;
  background:rgba(255,255,255,.95);
  display:flex;
  align-items:center;
  gap:14px;
  box-shadow:0 6px 18px rgba(236,72,153,.18);
  transition:transform .2s, box-shadow .2s;
}

.qr-pink-card:hover{
  transform:translateY(-3px);
  box-shadow:0 10px 26px rgba(236,72,153,.28);
}

.qr-pink-card .qr{
  width:var(--qr);
  height:var(--qr);
  padding:10px;
  background:#fff;
  border-radius:14px;
  border:2px solid rgba(30,58,95,.12);
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
}

.qr-pink-card .qr img{
  width:100%;
  height:100%;
  object-fit:contain;
}

.qr-pink-card .meta{
  min-width:0;
  flex:1;
  text-align:right;
}

.qr-pink-card .meta .name{
  font-weight:1000;
  font-size:1.02rem;
  color:#1e3a5f;
  display:flex;
  align-items:center;
  gap:8px;
}

.qr-pink-card .meta .desc{
  margin-top:6px;
  font-weight:800;
  color:rgba(15,23,42,.75);
  font-size:.9rem;
}

.qr-pink-card .meta .url{
  margin-top:10px;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:.78rem;
  color:rgba(15,23,42,.55);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.qr-pink-card--danger .meta .name i{color:var(--danger);}
.qr-pink-card--info   .meta .name i{color:var(--info);}
.qr-pink-card--gold   .meta .name i{color:var(--secondary);}

@media print{
  .qr-section-pink{ --qr: 42mm; } /* أكبر وواضح للطباعة */
  .qr-pink-card{ page-break-inside:avoid; }
}


ملاحظة مهمة: أنت الآن تطلب QR بـ size=360x360 (جودة عالية)، لكن تعرضه بحجم ثابت أنيق — أفضل للطباعة.
وإذا تبغى “بدون خدمة خارجية” (أكثر خصوصية/أمان)، أفضل حل توليد QR محليًا بدل api.qrserver (أذكره تحت بالأمن).

2) أهم الثغرات/المخاطر الأمنية في نظامك وكيف تصلحها (بوضوح وبالأولوية)
(حرج جدًا) 1) الـ Apps Script Web App يبدو “API مفتوح” بدون صلاحيات/هوية

عندك Actions كثيرة “تكتب” في الشيتات (مثل setActiveCommand, clearActiveCommand, updateEmergencyStatus, submitComplaint…) — إذا نشر الـ Web App بإتاحة عامة، أي شخص يمكنه تشغيل/إلغاء طوارئ أو تعديل السجلات. هذا يدخل ضمن مشاكل المصادقة والتفويض في OWASP API Security Top 10 (Broken Authentication / Broken Authorization).

الإصلاح (الأفضل والأسرع):

غيّر إعدادات نشر الـ Web App بحيث الوصول ليس “Anyone, even anonymous”. وثّق Google يوضح خيارات access مثل ANYONE_ANONYMOUS وغيرها، وأيضاً خيار executeAs.

عمليًا: اجعل الوصول Domain أو Anyone with Google account (حسب بيئتكم)، ويفضل “Execute as user accessing” لو تبغى تتبع من نفّذ.

(حرج) 2) JSONP (callback) = مخاطرة + لا يصلح للبيانات الحساسة

JSONP يعني “تشغيل JavaScript من دومين آخر” عن طريق <script src=...>. هذا يسهّل تجاوز SOP لكنه يزيد سطح الهجوم، ويصعّب التحكم في من يقرأ البيانات. JSONP معروف كمفهوم، لكنه ليس خيارًا آمنًا لواجهات فيها بيانات تشغيلية/حساسة.

الإصلاح الأفضل:

استبدل JSONP بـ POST + JSON + CORS (أفضل ممارسة).

إن كان عندك سيرفر/Proxy على m2020m.org (حتى Cloudflare Worker بسيط) خلّه ينادي Apps Script من الخلف ثم يرجّع JSON للفرونت.

إذا “مضطر” تبقى على JSONP الآن: على الأقل اقفل الوصول كما فوق + أضف تفويض (token/جلسة) لكل actions الحساسة.

(عالي) 3) تمرير معلومات حساسة في Query String (GET)

أنت تستخدم doGet لأشياء كثيرة، وبعضها ممكن يصير فيه معلومات حساسة (أسماء، أرقام، ملاحظات، أكواد). إرسال بيانات في URL يدخل في سجلات المتصفح/الخوادم/الـ Referer. هذا نمط سيء للمصادقة والبيانات الحساسة وفق توصيات OWASP API Security.

الإصلاح:

خلي كل عمليات “الكتابة” وعمليات “البيانات الحساسة” doPost فقط وبـ body JSON.

(عالي) 4) XSS/DOM Injection من قيم الشيت (خاصة الأيقونات/المعرّفات)

عندك أماكن تبني HTML بـ template strings وتضع قيم من الشيت داخل class="..." وداخل onclick="..."…
حتى لو عندك escapeHtml، الترميز يختلف حسب السياق (HTML vs Attribute vs JS). هذا نوع من ثغرات DOM/XSS (OWASP يحذر من بناء HTML مباشرة من بيانات غير موثوقة).

الإصلاح العملي:

ألغِ inline onclick بالكامل (مهم جدًا)، واستبدله بـ addEventListener + data-*.

اعمل “Allowlist” لقيم الأيقونات: اسمح فقط بـ [a-z0-9-] وابدأ بـ fa-، وارفض أي شيء غيره.

أي نص يطلع للمستخدم: استخدم textContent بدل innerHTML قدر الإمكان.

(عالي) 5) تخزين Passcodes كنص صريح في Google Sheet

هذا خطر أمني كبير (أي شخص عنده وصول للشيت يرى الأكواد).
الإصلاح:

خزن هاش (SHA-256 + salt) بدل الكود، وقارن الهاش داخل Apps Script.

أو الأفضل: اعتمد تسجيل دخول Google Workspace بدل “passcode”.

(متوسط) 6) Formula Injection داخل Sheets

أي نص يدخل الشيت ويبدأ بـ = + - @ قد يتحول “معادلة” عند فتح Google Sheets. هذا معروف كـ CSV/Spreadsheet Injection.

الإصلاح السريع (مهم):

قبل أي appendRow، اعمل sanitize:

إذا النص يبدأ بهذه الرموز → أضف ' بالبداية.

(متوسط) 7) اعتماد على مكتبات خارجية بدون SRI وبدون CSP

FontAwesome و Google Fonts و QR API كلها طرف ثالث.

إضافة SRI تقلل مخاطر التلاعب بالمحتوى، وCSP تقلل أثر XSS.

الإصلاح:

لو تقدر: self-host للـ CSS/fonts أو على الأقل SRI لـ CDN.

فعّل CSP على السيرفر (Nginx/Cloudflare/…)، واستخدم سياسة مناسبة.

“Patch” سريع جدًا تقنيًا للـ Apps Script (حماية أساسية)

هذا مثال حد أدنى (ليس مثالي، لكنه يوقف العبث فورًا). ضعه أعلى ملف Apps Script ثم استدعه داخل doGet/doPost قبل أي action حساس:

const PUBLIC_ACTIONS = new Set([
  'ping',
  'getBuildingConfig',
  'getScenarioGuides',
  'getScenarioProfiles'
]);

function requireToken_(p) {
  const expected = PropertiesService.getScriptProperties().getProperty('API_TOKEN');
  const got = String((p && (p.token || p.t)) || '').trim();
  if (!expected || got !== expected) throw new Error('Unauthorized');
}

function safeCell_(v){
  const s = String(v ?? '');
  return (/^[=+\-@]/.test(s.trim())) ? ("'" + s) : s;
}


ثم داخل doGet(e) بعد تحديد action:

if (!PUBLIC_ACTIONS.has(action)) requireToken_(p);


وقبل أي كتابة للشيت (مثال داخل submitEmergencyReport):

sheet.appendRow([
  safeCell_(reportId),
  safeCell_(dateStr),
  safeCell_(timeStr),
  safeCell_(String(params.disasterType || '').trim()),
  safeCell_(String(params.location || '').trim()),
  safeCell_(String(params.notes || '').trim()),
  'جديد', '', ''
]);


تنبيه مهم: Token داخل كود HTML يمكن اكتشافه. لذلك الحل الحقيقي: تقييد Access في النشر (Domain / Google Account) كما ذكرنا.

ملاحظة عن “تحذيرات الكونسول” اللي تشوفها

التحذيرات اللي تظهر مثل ethereum.js أو chrome.runtime كثير منها يكون من إضافات المتصفح (extensions) وليس من كودك. جرّب فتح الصفحة في Incognito بدون إضافات للتأكد.