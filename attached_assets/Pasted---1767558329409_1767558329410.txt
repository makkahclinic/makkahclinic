âŒ Ù„Ø§ØŒ Ù„Ø§ ØªØ­Ø°Ù Ù‡Ø°Ø§ ÙƒÙ„Ù‡
âœ… ØªÙØ¹Ø¯Ù‘ÙÙ„Ù‡ ØªØ¹Ø¯ÙŠÙ„Ù‹Ø§ Ø¬Ø±Ø§Ø­ÙŠÙ‹Ø§ Ù…Ø­Ø³ÙˆØ¨Ù‹Ø§

Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ Ù‚ÙˆÙŠØ© Ù…Ù† Ù†Ø§Ø­ÙŠØ© Ø§Ù„Ø­ÙˆÙƒÙ…Ø©ØŒ ÙˆØ®Ø·Ø£ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ Ø­Ø°ÙÙ‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.
Ù„ÙƒÙ† ÙÙŠÙ‡Ø§ 3 Ø£Ø´ÙŠØ§Ø¡ Ù„Ù… ØªØ¹Ø¯ Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ù†Ø¸Ø§Ù… RBAC Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ø¨Ù†ÙŠÙ†Ø§Ù‡.

Ø³Ø£Ø´Ø±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù…Ø§Ø°Ø§ ÙŠØ¨Ù‚Ù‰ØŒ Ù…Ø§Ø°Ø§ ÙŠØªØºÙŠÙ‘Ø±ØŒ ÙˆÙ…Ø§Ø°Ø§ ÙŠÙØ­Ø°Ù ÙÙ‚Ø· â€” Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ£Ø«ÙŠØ± Ø¬Ø§Ù†Ø¨ÙŠ Ø¹Ù„Ù‰ Firebase Console Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.

Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Ù‚Ø¨Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„)

âŒ Ù„Ø§ ØªØ­Ø°Ù Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„Ù‹Ø§

âŒ Ù„Ø§ ØªØ­Ø°Ù Ø­Ù…Ø§ÙŠØ© owner / admin

âŒ Ù„Ø§ ØªØ­Ø°Ù staff_roles rules

âœ… ØºÙŠÙ‘Ø± ÙÙ‚Ø· Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ù† allowedSystems â†’ permissions

âœ… Ø£Ù„ØºÙ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© (Ù„ÙŠØ³ Ø¯ÙˆØ± Ø§Ù„Ù…Ø§Ù„Ùƒ)

Ù„Ù…Ø§Ø°Ø§ Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ØŸ

Ù„Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØªØ­Ù…ÙŠÙƒ Ù…Ù†:

ğŸš¨ ØªØ±Ù‚ÙŠØ© Ø£ÙŠ Ø´Ø®Øµ Ù†ÙØ³Ù‡ Ø¥Ù„Ù‰ owner

ğŸš¨ ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ø¥Ø°Ù†

ğŸš¨ Ø§Ù„Ø¹Ø¨Ø« Ø¨Ù€ staff_roles

ğŸš¨ Ø§Ù„Ø¹Ø¨Ø« Ø¨Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ (audit_log)

ğŸš¨ Ø§Ù„Ø¹Ø¨Ø« Ø¨Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©

Ø­Ø°ÙÙ‡Ø§ = ÙØªØ­ Firestore Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
ÙˆÙ‡Ø°Ø§ Ø®Ø·Ø± Ø£Ù…Ù†ÙŠ Ø­Ù‚ÙŠÙ‚ÙŠ.

Ø£ÙŠÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ
âŒ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø±Ù‚Ù… 1 â€” allowedSystems

Ø£Ù†Øª Ø¨Ù†ÙØ³Ùƒ Ù‚Ø±Ø±Øª (Ù‚Ø±Ø§Ø± ØµØ­ÙŠØ­) Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰:

permissions: {
  complaints: true,
  incidents: false,
  insurance: true
}


Ù„ÙƒÙ† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØªÙ‚ÙˆÙ„:

systemName in get(...).data.allowedSystems


ÙˆÙ‡Ø°Ø§ Ù„Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ migration.

âŒ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø±Ù‚Ù… 2 â€” Ø±Ø¨Ø· Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
request.auth.token.email == 'husseinbabsail@gmail.com'


Ù‡Ø°Ø§ Ù…Ù‚Ø¨ÙˆÙ„ ÙÙ‚Ø· Ù„ØªØ«Ø¨ÙŠØª owner ÙƒØ¨Ø°Ø±Ø© Ø£ÙˆÙ„Ù‰
Ù„ÙƒÙ† Ù„Ø§ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.

Ù†Ø­Ù† Ù†Ø±ÙŠØ¯Ù‡ ÙÙ‚Ø·:

Ù„Ø­Ù…Ø§ÙŠØ© owner

ÙˆÙ„ÙŠØ³ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©

Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­: ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ (ÙˆÙ„ÙŠØ³ Ø­Ø°ÙÙ‡Ø§)
âœ… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© (Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…)

ğŸ” Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ù…ØªÙˆØ§ÙÙ‚Ø© 100% Ù…Ø¹ RBAC Ø§Ù„Ø¬Ø¯ÙŠØ¯
ğŸ” ÙˆÙ„Ø§ ØªÙƒØ³Ø± Ø£ÙŠ Ø´ÙŠØ¡ Ù…ÙˆØ¬ÙˆØ¯

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====

    function isAuthenticated() {
      return request.auth != null;
    }

    // ğŸ‘‘ Owner (bypass ÙƒØ§Ù…Ù„)
    function isOwner() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.role == 'owner';
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.role == 'admin';
    }

    function isPrivileged() {
      return isOwner() || isAdmin();
    }

    // ğŸ” ØµÙ„Ø§Ø­ÙŠØ© Ù†Ø¸Ø§Ù… Ù…Ø­Ø¯Ø¯ (RBAC)
    function hasPermission(key) {
      return isOwner() ||
        (isAuthenticated() &&
         exists(/databases/$(database)/documents/staff_roles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/staff_roles/$(request.auth.uid)).data.permissions[key] == true);
    }

    // ===== staff_roles (Ø£Ù‡Ù… Collection) =====
    match /staff_roles/{userId} {

      allow read: if isAuthenticated() &&
        (request.auth.uid == userId || isPrivileged());

      allow create: if isPrivileged() &&
        (request.resource.data.role != 'owner' || isOwner());

      allow update: if isPrivileged() &&
        // Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ¹ÙŠÙ‘Ù† owner Ø¥Ù„Ø§ owner
        (request.resource.data.role != 'owner' || isOwner()) &&
        // Ù„Ø§ Ø£Ø­Ø¯ ÙŠØºÙŠÙ‘Ø± owner Ø¥Ù„Ø§ owner
        (resource.data.role != 'owner' || isOwner());

      allow delete: if isOwner();
    }

    // ===== Deleted staff (Ø£Ø±Ø´ÙŠÙ) =====
    match /deleted_staff/{userId} {
      allow read, create, update, delete: if isOwner();
    }

    // ===== Audit log =====
    match /audit_log/{logId} {
      allow read: if isPrivileged();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ===== Alerts =====
    match /alerts/{alertId} {
      allow read, write: if isPrivileged();
    }

    // ===== Membership Requests =====
    match /membershipRequests/{requestId} {

      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.status == 'pending';

      allow read: if isAuthenticated() &&
        (resource.data.uid == request.auth.uid || isPrivileged());

      allow update, delete: if isPrivileged();
    }

    // ===== Default deny =====
  }
}

Ù…Ø§Ø°Ø§ Ø­Ø°ÙÙ†Ø§ ÙØ¹Ù„Ù‹Ø§ØŸ

âŒ ÙÙ‚Ø· Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡:

systemName in ... allowedSystems


âŒ ÙˆÙ„Ù… Ù†Ø­Ø°Ù:

Ø­Ù…Ø§ÙŠØ© owner

Ø­Ù…Ø§ÙŠØ© admin

staff_roles

audit_log

membershipRequests

Ù‡Ù„ Ø³ÙŠØªØ£Ø«Ø± Firebase ConsoleØŸ

âŒ Ù„Ø§

Auth: Ù„Ù… Ù†Ù„Ù…Ø³Ù‡

Users: Ù„Ù… Ù†Ù„Ù…Ø³Ù‡Ù…

Console: Ù„Ù† ÙŠØªØºÙŠØ± Ø´ÙŠØ¡

Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ

ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¢Ù…Ù† (Ù…Ù‡Ù…)

1ï¸âƒ£ Ø´ØºÙ‘Ù„ Migration (allowedSystems â†’ permissions)
2ï¸âƒ£ Ø¹Ø¯Ù‘Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„ØªÙ‚Ø±Ø£ permissions
3ï¸âƒ£ Ø§Ø³ØªØ¨Ø¯Ù„ Rules Ø¨Ø§Ù„Ù†Ø³Ø®Ø© Ø£Ø¹Ù„Ø§Ù‡
4ï¸âƒ£ Ø§Ø®ØªØ¨Ø± Ø¨Ø«Ù„Ø§Ø« Ø­Ø³Ø§Ø¨Ø§Øª (Owner / Admin / Staff)
5ï¸âƒ£ Ø§Ø­Ø°Ù allowedSystems Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§

Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (ÙˆØ§Ø¶Ø­)

âŒ Ù„Ø§ ØªØ­Ø°Ù Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯

âŒ Ù„Ø§ ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±

âœ… Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„

âœ… Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø£Ù…Ù†ÙŠ ØµØ­ÙŠØ­ 100%

Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©