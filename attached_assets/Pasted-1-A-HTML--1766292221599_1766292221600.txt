1) â€œØ§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠâ€ ØªØªØ­ÙˆÙ„ Ø£Ø­Ù…Ø± Ù†Ø§Ø¨Ø¶ ÙˆÙ‚Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆØªÙƒÙˆÙ† Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± Ù„Ù„Ø¥Ù„ØºØ§Ø¡
(A) ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€ HTML ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±

Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‡Ø°Ø§:

<div class="status-badge" id="systemStatus">
  <i class="fas fa-check-circle"></i><span>Ø§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ</span>
</div>


Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ù‡Ø°Ø§:

<div class="status-badge" id="systemStatus"
     role="button" tabindex="0"
     onclick="onStatusBadgeClick()"
     onkeydown="if(event.key==='Enter' || event.key===' '){event.preventDefault(); onStatusBadgeClick();}">
  <i class="fas fa-check-circle"></i><span>Ø§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ</span>
</div>

(B) ØªØ¹Ø¯ÙŠÙ„ CSS Ù„Ù„Ù€ status badge (Ø¹Ø´Ø§Ù† ÙŠÙƒÙˆÙ† ÙˆØ§Ø¶Ø­ Ø£Ù†Ù‡ clickable)

Ø¯Ø§Ø®Ù„ CSS Ø¹Ù†Ø¯ .status-badge{...} Ø£Ø¶Ù:

.status-badge{ cursor:pointer; user-select:none; }
.status-badge:hover{ filter: brightness(1.06); }
.status-badge.alert:hover{ filter: brightness(1.10); }

(C) Ø§Ø­Ø°Ù Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Ø¯ (Ù„Ø£Ù† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙŠØµÙŠØ± Ù…Ù† Ø§Ù„Ø´Ø§Ø±Ø© Ù†ÙØ³Ù‡Ø§)

Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‡Ø°Ø§ ÙÙŠ ÙƒØ§Ø±Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:

<button class="main-cancel-btn" id="cancelEmergencyBtn" onclick="cancelActiveCommand()" style="flex:1;min-width:150px;display:none">
  <i class="fas fa-stop-circle"></i>
  <span>Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</span>
</button>


Ø§Ù…Ø³Ø­Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.

Ø«Ù… Ø§Ù…Ø³Ø­ CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡ (Ù„Ø£Ù†Ù‡ ØµØ§Ø± ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…). Ø§Ø¨Ø­Ø« Ø¹Ù†:

.main-cancel-btn{...}
.main-cancel-btn:hover{...}


ÙˆØ§Ù…Ø³Ø­ Ø§Ù„Ø¨Ù„ÙˆÙƒÙŠÙ†.

ÙƒØ°Ø§ ØªÙƒÙˆÙ† â€œØ­Ø±ÙƒØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡â€ Ù…Ùˆ Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù…ÙƒØ§Ù†ÙŠÙ†ØŒ ÙˆÙƒÙ„ Ø´ÙŠØ¡ Ù…ÙˆØ­Ø¯ Ù…Ù† Ø§Ù„Ø´Ø§Ø±Ø© ÙÙˆÙ‚.

(D) ØªØ¹Ø¯ÙŠÙ„ JavaScript: Ø®Ù„Ù‘ÙŠ Ø§Ù„Ø´Ø§Ø±Ø© ØªØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù†Ø´Ø· Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
1) Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ (Ø¶Ø¹Ù‡Ø§ Ø¨Ø¹Ø¯ jsonp() Ù…Ø¨Ø§Ø´Ø±Ø©)
let ACTIVE_CMD_CACHE = null;

async function syncActiveCommandUI() {
  try {
    const ac = await jsonp('getActiveCommand', {});
    const cmd = (ac && ac.ok) ? ac.command : null;

    // cmd ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¯ ÙŠØ±Ø¬Ø¹ null Ø£Ùˆ {active:true,...}
    if (cmd && (cmd.active === true || String(cmd.active).toLowerCase() === 'true' || String(cmd.active) === '1')) {
      ACTIVE_CMD_CACHE = cmd;

      const isTraining =
        String(cmd.mode || '').toLowerCase() === 'training' ||
        String(cmd.reportType || '').includes('ØªÙ…Ø±ÙŠÙ†') ||
        String(cmd.reportType || '').includes('ğŸ¯');

      setStatusAlert(true, isTraining ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ†' : 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦');
    } else {
      ACTIVE_CMD_CACHE = null;
      setStatusAlert(false);
    }
  } catch (e) {
    console.error('syncActiveCommandUI:', e);
  }
}

function setStatusAlert(on, label){
  const el = document.getElementById('systemStatus');
  if (!el) return;

  if (on){
    el.classList.add('alert');
    el.innerHTML = `<i class="fas fa-stop-circle"></i><span>${escapeHtml(label || 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦')}</span>`;
  } else {
    el.classList.remove('alert');
    el.innerHTML = `<i class="fas fa-check-circle"></i><span>Ø§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ</span>`;
  }
}

/**
 * Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø±Ø©:
 * - Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ Ø£Ù…Ø± Ù†Ø´Ø·: Ù„Ø§ ØªØ³ÙˆÙŠ Ø´ÙŠØ¡ (Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù„Ùˆ ØªØ¨ØºÙ‰)
 * - Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø£Ù…Ø±: Ø§Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø³Ø¨Ø¨ -> Ø£ØºÙ„Ù‚ Ø¹Ø¨Ø± closeActiveCommand (Ù…Ø¹ Ø³Ø¬Ù„)
 */
async function onStatusBadgeClick(){
  try {
    const ac = await jsonp('getActiveCommand', {});
    const cmd = (ac && ac.ok) ? ac.command : null;

    if (!cmd || !(cmd.active === true || String(cmd.active).toLowerCase() === 'true' || String(cmd.active) === '1')) {
      toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'info');
      return;
    }

    const isTraining =
      String(cmd.mode || '').toLowerCase() === 'training' ||
      String(cmd.reportType || '').includes('ØªÙ…Ø±ÙŠÙ†') ||
      String(cmd.reportType || '').includes('ğŸ¯');

    const who = prompt(isTraining ? 'Ø§Ø³Ù… Ù…Ù† ÙŠØ±ÙŠØ¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ†:' : 'Ø§Ø³Ù… Ù…Ù† ÙŠØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:');
    if (!who) return;
    const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || '';

    // Ø§Ù„Ø£ÙØ¶Ù„: closeActiveCommand (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„ Apps Script Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
    const res = await jsonp('closeActiveCommand', {
      closedBy: who,
      closeReason: reason
    });

    if (!res || !res.ok) throw new Error(res?.error || 'closeActiveCommand failed');

    toast(isTraining ? 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ†' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', 'success');
    await syncActiveCommandUI();
    await refreshLists?.(); // Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©
  } catch (e) {
    console.error(e);
    toast('ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ â€” ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø£Ø¶ÙØª closeActiveCommand ÙÙŠ Apps Script', 'error');
  }
}

2) Ø§Ø­Ø°Ù Ø£ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‚Ø¯ÙŠÙ… Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡

Ø§Ø¨Ø­Ø« ÙˆØ§Ø­Ø°Ù:

updateCancelButtonVisibility() (Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)

ÙˆØ£ÙŠ setInterval(updateCancelButtonVisibility, ...)

ÙˆØ£ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ await updateCancelButtonVisibility();

3) ÙÙŠ init() (Ø£Ùˆ DOMContentLoaded) Ø£Ø¶Ù Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø§Ù„Ø©

Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± await updateCancelButtonVisibility(); (Ø£Ùˆ Ù…ÙƒØ§Ù†Ù‡Ø§) ÙˆØ¶Ø¹ Ø¨Ø¯Ù„Ù‡Ø§:

await syncActiveCommandUI();
setInterval(syncActiveCommandUI, 5000);

4) ÙÙŠ pollReports() Ø§Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±

Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ:

setStatusAlert(true, 'Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯!');


Ø§Ù…Ø³Ø­Ù‡.
Ø§Ù„Ø´Ø§Ø±Ø© Ø§Ù„Ø¢Ù† ØªÙ…Ø«Ù„ â€œØ£Ù…Ø± Ù†Ø´Ø·â€ ÙÙ‚Ø·ØŒ ÙˆØ§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¸Ù‡Ø± Ø¨Ø§Ù„Ù€ toast + Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø±Ø§Ø±.

2) Ù‡Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§ØªØ­Ù„ØªØŸ (Ø§Ù„Ø­ÙØ¸ + Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù…Ù† Ø§Ù„Ø´ÙŠØª)
(A) Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±ÙŠØ¨

ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡) Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù…:

const res = await jsonp('logTrainingSession', payload);


ÙˆÙ‡Ø°Ø§ ØµØ­ Ù„Ø£Ù† Ø§Ù„Ù€ Apps Script Ø¹Ù†Ø¯Ùƒ ÙÙŠÙ‡ action === 'logTrainingSession'.

Ù„Ùˆ Ù…Ø§ Ø²Ø§Ù„ â€œØ­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨â€ Ù„Ø§ ÙŠØ­ÙØ¸ØŒ ØºØ§Ù„Ø¨Ø§Ù‹ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„ØªØ§Ù„ÙŠ:

Ø§Ù„Ù€ WEB_APP_URL Ù…Ùˆ Ù†ÙØ³ Ø¢Ø®Ø± Deploy (Ø£Ù†Øª ØªØ¹Ø¯Ù„ Ø³ÙƒØ±Ø¨Øª Ù„ÙƒÙ† Ù…Ø§ Ø¹Ù…Ù„Øª Deploy Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©).

Ø£Ù†Øª ØªÙØªØ­ Ø´ÙŠØª ØºÙ„Ø·: Ø§Ù„Ø­ÙØ¸ ÙŠØªÙ… ÙÙŠ Training_Log Ø¯Ø§Ø®Ù„ Ù…Ù„Ù EOC_SPREADSHEET_ID.

Ø§Ø³Ù… Ø§Ù„Ù€ action ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Apps Script (Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† logTrainingSession Ø­Ø±ÙÙŠØ§Ù‹).

(B) Ù„ÙŠØ´ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù…Ø§ ÙƒØ§Ù†Øª ØªØ¬ÙŠ Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ØŸ

Ù„Ø£Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ‚Ø±Ø£ Ù…Ù† Ø´ÙŠØª Training_Roster Ø¹Ø¨Ø± getTrainingRoster() ÙˆÙ„ÙŠØ³ Ù…Ù† Ø´ÙŠØª Staff.
Ø¥Ø°Ø§ Training_Roster ÙØ§Ø¶ÙŠ â†’ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªØ·Ù„Ø¹ ÙØ§Ø¶ÙŠØ©.

Ø£ÙØ¶Ù„ Ø­Ù„ â€œØ¨Ø¯ÙˆÙ† ØªØ¹Ø¨ ÙŠØ¯ÙˆÙŠâ€: Ù†Ø®Ù„ÙŠ Apps Script ÙŠÙ†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Staff Ø¥Ù„Ù‰ Training_Roster Ø¥Ø°Ø§ ÙƒØ§Ù† roster ÙØ§Ø¶ÙŠ (ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„Ø£Ø³ÙÙ„).

4) Ø§Ù„Ø¹ÙŠØ¨ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø±ÙŠÙØ±ÙŠØ´ Ø§Ù„ØµÙØ­Ø© ÙŠÙ„Ø®Ø¨Ø·/ÙŠÙ„ØºÙŠ â€œØ§Ù„Ù‚ÙÙ„â€ â€” Ù„Ø§Ø²Ù… Ø¥ØºÙ„Ø§Ù‚ Ø±Ø³Ù…ÙŠ Ø¨Ø§Ø³Ù… + Ø³Ø¨Ø¨ + Ø³Ø¬Ù„

Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Apps Script) Ù…Ùˆ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·:

Ù…Ù†Ø¹ overwrite: Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø£Ù…Ø± Ù†Ø´Ø·ØŒ setActiveCommand ÙŠØ±ÙØ¶ Ø¥ØµØ¯Ø§Ø± Ø£Ù…Ø± Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙˆØ¶Ø¹Øª force=true.

Ø¥ØºÙ„Ø§Ù‚ Ø±Ø³Ù…ÙŠ: closeActiveCommand(closedBy, closeReason)

ÙŠØºÙŠÙ‘Ø± active â†’ false

ÙŠØ³Ø¬Ù„ ÙÙŠ Ø³Ø¬Ù„ Ø£ÙˆØ§Ù…Ø± (Command Log) Ù…Ù† Ø¨Ø¯Ø£/Ù…Ù† Ø£ØºÙ„Ù‚/Ø§Ù„ÙˆÙ‚Øª/Ø§Ù„Ø³Ø¨Ø¨

Ù‡Ø°Ø§ ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ ØªÙˆØµÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… LockService Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙŠØª.

(A) ØªØ¹Ø¯ÙŠÙ„Ø§Øª Apps Script (Ø§Ù†Ø³Ø®/Ø§Ù„ØµÙ‚)
1) ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù€ BOOTSTRAP constants Ø£Ø¶Ù:
const SHEET_CMD_LOG = 'EOC_COMMAND_LOG';
const HEADERS_CMD_LOG = [
  'command_id','start_ts','end_ts',
  'mode','responseType','reportType','location','muster',
  'scenarioKey','scenarioLabel','issuedBy','closedBy','closeReason','reportId'
];

2) Ø¯Ø§Ø®Ù„ setupEocWorkbook_() Ø£Ø¶Ù:
ensureSheet_(ss, SHEET_CMD_LOG, HEADERS_CMD_LOG);

3) Ø¯Ø§Ø®Ù„ doGet(e) Ø£Ø¶Ù route Ø¬Ø¯ÙŠØ¯:
if (action === 'closeActiveCommand') {
  const result = closeActiveCommand(p);
  return output_(result);
}

4) Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© setActiveCommand(params) Ø¹Ù†Ø¯Ùƒ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© (ØªØ­Ù…ÙŠ Ù…Ù† overwrite + ØªØ³Ø¬Ù„ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©):
function setActiveCommand(params) {
  try {
    const lock = LockService.getScriptLock();
    lock.tryLock(10000);

    const ss = SpreadsheetApp.openById(EOC_SPREADSHEET_ID);

    // Ensure sheets
    ensureSheet_(ss, SHEET_ACTIVE_CMD, HEADERS_ACTIVE);
    ensureSheet_(ss, SHEET_CMD_LOG, HEADERS_CMD_LOG);

    const sheet = ss.getSheetByName(SHEET_ACTIVE_CMD);
    const logSh = ss.getSheetByName(SHEET_CMD_LOG);

    const data = sheet.getDataRange().getValues();
    let hasActive = false;
    let existing = null;

    if (data.length >= 2) {
      const flag = String(data[1][0] || '').toLowerCase().trim();
      hasActive = (flag === 'true' || flag === 'yes' || flag === '1');
      if (hasActive) {
        existing = {
          responseType: data[1][1],
          reportType: data[1][2],
          location: data[1][3],
          muster: data[1][4],
          timestamp: data[1][5],
          mode: data[1][6] || 'real',
          scenarioKey: data[1][7] || '',
          scenarioLabel: data[1][8] || '',
          sessionId: data[1][9] || '',
          trainer: data[1][10] || ''
        };
      }
    }

    const force = String(params.force || '').toLowerCase().trim();
    const isForce = (force === 'true' || force === 'yes' || force === '1');

    if (hasActive && !isForce) {
      lock.releaseLock();
      return { ok: false, error: 'ACTIVE_COMMAND_EXISTS', command: existing };
    }

    // clear old rows
    if (sheet.getLastRow() > 1) sheet.deleteRows(2, sheet.getLastRow() - 1);

    const cmdId = String(params.commandId || ('CMD-' + Date.now()));
    const ts = new Date().toISOString();

    const row = [
      'true',
      String(params.responseType || ''),
      String(params.reportType || ''),
      String(params.location || ''),
      String(params.muster || ''),
      ts,
      String(params.mode || 'real'),
      String(params.scenarioKey || ''),
      String(params.scenarioLabel || ''),
      String(params.sessionId || ''),
      String(params.trainer || '')
    ];
    sheet.appendRow(row);

    // log start
    logSh.appendRow([
      cmdId, ts, '',
      String(params.mode || 'real'),
      String(params.responseType || ''),
      String(params.reportType || ''),
      String(params.location || ''),
      String(params.muster || ''),
      String(params.scenarioKey || ''),
      String(params.scenarioLabel || ''),
      String(params.issuedBy || ''),
      '', '', String(params.reportId || '')
    ]);

    lock.releaseLock();
    return { ok: true, commandId: cmdId, timestamp: ts };
  } catch (err) {
    try { LockService.getScriptLock().releaseLock(); } catch(e) {}
    return { ok: false, error: err.message };
  }
}

5) Ø£Ø¶Ù Ø¯Ø§Ù„Ø© closeActiveCommand(params) (ØªØ³Ø¬Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ø³Ù… + Ø³Ø¨Ø¨):
function closeActiveCommand(params) {
  try {
    const closedBy = String(params.closedBy || '').trim();
    if (!closedBy) return { ok: false, error: 'closedBy is required' };

    const closeReason = String(params.closeReason || '').trim();

    const lock = LockService.getScriptLock();
    lock.tryLock(10000);

    const ss = SpreadsheetApp.openById(EOC_SPREADSHEET_ID);
    ensureSheet_(ss, SHEET_ACTIVE_CMD, HEADERS_ACTIVE);
    ensureSheet_(ss, SHEET_CMD_LOG, HEADERS_CMD_LOG);

    const sh = ss.getSheetByName(SHEET_ACTIVE_CMD);
    const logSh = ss.getSheetByName(SHEET_CMD_LOG);

    const data = sh.getDataRange().getValues();
    if (data.length < 2) {
      lock.releaseLock();
      return { ok: false, error: 'No active command' };
    }

    const row = data[1];
    const flag = String(row[0] || '').toLowerCase().trim();
    const isActive = (flag === 'true' || flag === 'yes' || flag === '1');
    if (!isActive) {
      lock.releaseLock();
      return { ok: false, error: 'No active command' };
    }

    const endTs = new Date().toISOString();
    sh.getRange(2, 1).setValue('false');

    // find last log row for this command (best effort)
    const logData = logSh.getDataRange().getValues();
    for (let i = logData.length - 1; i >= 1; i--) {
      // end_ts is col 3; close only the latest open row
      const endCell = String(logData[i][2] || '').trim();
      if (!endCell) {
        logSh.getRange(i + 1, 3).setValue(endTs);              // end_ts
        logSh.getRange(i + 1, 12).setValue(closedBy);          // closedBy
        logSh.getRange(i + 1, 13).setValue(closeReason);       // closeReason
        break;
      }
    }

    lock.releaseLock();
    return { ok: true, endTs: endTs, closedBy: closedBy };
  } catch (err) {
    try { LockService.getScriptLock().releaseLock(); } catch(e) {}
    return { ok: false, error: err.message };
  }
}

6) Ø¹Ø¯Ù‘Ù„ getActiveCommand() Ù„ÙŠÙØ±Ø¬Ø¹ mode/trainerâ€¦ (Ø¹Ø´Ø§Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ¹Ø±Ù ØªØ¯Ø±ÙŠØ¨ ÙˆÙ„Ø§ Ø·ÙˆØ§Ø±Ø¦)

Ø§Ø³ØªØ¨Ø¯Ù„ return Ø¯Ø§Ø®Ù„ getActiveCommand() Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„:

return {
  ok: true,
  command: {
    active: true,
    responseType: row[1],
    reportType: row[2],
    location: row[3],
    muster: row[4],
    timestamp: row[5],
    mode: row[6] || 'real',
    scenarioKey: row[7] || '',
    scenarioLabel: row[8] || '',
    sessionId: row[9] || '',
    trainer: row[10] || ''
  }
};


Ù…Ù‡Ù…: ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø© (LockService + Ù…Ù†Ø¹ overwrite + Ø³Ø¬Ù„ Ø¥ØºÙ„Ø§Ù‚) Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØµÙŠØ± â€œØ±ÙŠÙØ±ÙŠØ´â€ Ø£Ùˆ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† ØªÙˆØ«ÙŠÙ‚.