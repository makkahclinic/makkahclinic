<div style="position:fixed;z-index:10000;bottom:20px;right:20px;display:flex;gap:10px;align-items:center;">
  <button id="policeBtn"
    style="padding:12px 14px;font-weight:800;border-radius:12px;border:0;cursor:pointer;">
    ğŸš“ Police OFF
  </button>

  <button id="alarmBtn"
    style="padding:12px 14px;font-weight:800;border-radius:12px;border:0;cursor:pointer;">
    ğŸ¥ Alarm OFF
  </button>

  <input id="sirenVolume" type="range" min="0" max="1" step="0.01" value="0.25"
    style="width:160px;">
</div>

<script>
(() => {
  let audioCtx=null, master=null, comp=null;

  // common nodes
  let osc1=null, osc2=null, lfo=null, lfoGain=null, gainNode=null;
  let timer=null;

  const lightsEl = document.getElementById("emergencyLights");
  const policeBtn = document.getElementById("policeBtn");
  const alarmBtn  = document.getElementById("alarmBtn");
  const volEl     = document.getElementById("sirenVolume");

  const state = { mode: null }; // "police" | "alarm" | null

  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    master = audioCtx.createGain();
    master.gain.value = Number(volEl?.value ?? 0.25);

    comp = audioCtx.createDynamicsCompressor();
    comp.threshold.value = -18;
    comp.knee.value = 18;
    comp.ratio.value = 6;
    comp.attack.value = 0.003;
    comp.release.value = 0.15;

    master.connect(comp);
    comp.connect(audioCtx.destination);
  }

  function stopAll(){
    if (timer){ clearInterval(timer); timer=null; }

    [osc1, osc2, lfo].forEach(n=>{
      try { n && n.stop(); } catch(e){}
      try { n && n.disconnect(); } catch(e){}
    });
    osc1=osc2=lfo=null;

    try { lfoGain && lfoGain.disconnect(); } catch(e){}
    try { gainNode && gainNode.disconnect(); } catch(e){}
    lfoGain=null; gainNode=null;

    state.mode=null;
    if (lightsEl) lightsEl.classList.remove("active");
    if (policeBtn) policeBtn.textContent = "ğŸš“ Police OFF";
    if (alarmBtn)  alarmBtn.textContent  = "ğŸ¥ Alarm OFF";
  }

  function setVolume(v){
    if (!master) return;
    master.gain.setTargetAtTime(Number(v), audioCtx.currentTime, 0.03);
  }

  // ====== POLICE: Yelp/Phaser feel ======
  function startPolice(){
    ensureAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();

    stopAll(); // stop others first
    state.mode="police";
    if (lightsEl) lightsEl.classList.add("active");
    if (policeBtn) policeBtn.textContent = "ğŸš“ Police ON";
    if (alarmBtn)  alarmBtn.textContent  = "ğŸ¥ Alarm OFF";

    gainNode = audioCtx.createGain();
    gainNode.gain.value = 0.65;

    // two oscillators for body
    osc1 = audioCtx.createOscillator();
    osc2 = audioCtx.createOscillator();
    osc1.type="sawtooth";
    osc2.type="square";
    osc1.detune.value=-10;
    osc2.detune.value=+7;

    // tremolo to add urgency
    lfo = audioCtx.createOscillator();
    lfo.type="sine";
    lfo.frequency.value = 10.5;

    lfoGain = audioCtx.createGain();
    lfoGain.gain.value = 0.16;

    lfo.connect(lfoGain);
    lfoGain.connect(gainNode.gain);

    osc1.connect(gainNode);
    osc2.connect(gainNode);
    gainNode.connect(master);

    const now = audioCtx.currentTime;
    osc1.start(now);
    osc2.start(now);
    lfo.start(now);

    // phaser-ish quick alternating sweep
    let phase=0;
    timer = setInterval(()=>{
      const t = audioCtx.currentTime;

      // cycle 0..3 produces fast "yelp" bursts
      const presets = [
        {a: 820, b: 640},
        {a: 1050, b: 820},
        {a: 680, b: 520},
        {a: 1120, b: 900},
      ];
      const p = presets[phase % presets.length];

      osc1.frequency.cancelScheduledValues(t);
      osc2.frequency.cancelScheduledValues(t);
      osc1.frequency.setTargetAtTime(p.a, t, 0.05);
      osc2.frequency.setTargetAtTime(p.b, t, 0.05);

      phase++;
    }, 140);
  }

  // ====== HOSPITAL/BUILDING ALARM: Beep-Beep ======
  function startAlarm(){
    ensureAudio();
    if (audioCtx.state === "suspended") audioCtx.resume();

    stopAll();
    state.mode="alarm";
    if (lightsEl) lightsEl.classList.add("active");
    if (alarmBtn)  alarmBtn.textContent  = "ğŸ¥ Alarm ON";
    if (policeBtn) policeBtn.textContent = "ğŸš“ Police OFF";

    gainNode = audioCtx.createGain();
    gainNode.gain.value = 0.0; // will pulse
    gainNode.connect(master);

    osc1 = audioCtx.createOscillator();
    osc1.type="square";
    osc1.frequency.value = 880; // alarm pitch
    osc1.connect(gainNode);

    const now = audioCtx.currentTime;
    osc1.start(now);

    // beep pattern: beep-beep ... pause ... repeat
    let step=0;
    timer = setInterval(()=>{
      const t = audioCtx.currentTime;
      const on = (step===0 || step===1); // two beeps
      gainNode.gain.cancelScheduledValues(t);
      gainNode.gain.setTargetAtTime(on ? 0.55 : 0.0, t, 0.01);

      // slight pitch wobble so Ù…Ø§ ÙŠÙƒÙˆÙ† Ø±ØªÙŠØ¨
      osc1.frequency.setTargetAtTime(on ? 930 : 820, t, 0.02);

      step = (step+1) % 5; // 0,1 beep | 2 gap | 3,4 longer gap
    }, 220);
  }

  // Buttons
  policeBtn?.addEventListener("click", ()=>{
    if (state.mode === "police") stopAll();
    else startPolice();
  });

  alarmBtn?.addEventListener("click", ()=>{
    if (state.mode === "alarm") stopAll();
    else startAlarm();
  });

  volEl?.addEventListener("input", e => setVolume(e.target.value));

  // Optional API for your system
  window.EOC = window.EOC || {};
  window.EOC.playPolice = startPolice;
  window.EOC.playAlarm  = startAlarm;
  window.EOC.stopSound  = stopAll;

})();
</script>
