ØªÙ…Ø§Ù… âœ…
Ø³Ø£Ø¨Ù†ÙŠ Ù„Ùƒ Ø­Ø²Ù…Ø© ØªØµØ­ÙŠØ­Ø§Øª v2 Ù†Ø¸ÙŠÙØ© + Ø§Ø­ØªØ±Ø§ÙÙŠØ© ØªØ´Ù…Ù„:

ØªÙˆØ­ÙŠØ¯ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (Source of Truth)

Ø­Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ù…Ø®Ø§Ù„ÙØ© (open / followup / closed / archived)

ÙÙ„ØªØ±Ø© ØµØ­ÙŠØ­Ø© 100% Backend + Frontend

ØªØµØ­ÙŠØ­ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª

ÌMigration Ø°ÙƒÙŠØ© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¯ÙˆÙ† ÙƒØ³Ø± Ø§Ù„Ù†Ø¸Ø§Ù…**

Ø³Ø£Ø¹Ø·ÙŠÙƒ Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø· Ù…Ø¹ Ø´Ø±Ø­ Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶Ø±ÙˆØ±Ø©.

ğŸ”´ (1) Ù…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ù„Ù„Ù…Ø®Ø§Ù„ÙØ© â€“ Violation Engine
âœ¨ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø£Ø¹Ù„Ù‰ Google Apps Script
/***************************************
 * VIOLATION ENGINE - SOURCE OF TRUTH
 ***************************************/
function isRealViolation(row) {
  const isViolationFlag = String(row.Is_Violation || '').toLowerCase();
  const status = String(row.Status || '').toLowerCase();
  const notes = String(row.Negative_Notes || '');

  if (isViolationFlag === 'yes' || isViolationFlag === 'true') return true;
  if (status.includes('Ø®Ù„Ù„') || status.includes('Ù…Ø®Ø§Ù„ÙØ©')) return true;
  if (notes.includes('âŒ') || notes.includes('Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ù„Ù„')) return true;

  return false;
}

ğŸ”´ (2) Ø­Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ù…Ø®Ø§Ù„ÙØ© (Open / FollowUp / Closed / Archived)
âœ¨ Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ GAS
function getViolationState(row) {
  const rowIndex = row._rowIndex;
  const isClosed =
    String(row.Closed_YN || '').toLowerCase() === 'yes' ||
    String(row.Is_Resolved || '').toLowerCase() === 'yes';

  const isArchived =
    String(row.Is_Archived || '').toLowerCase() === 'yes';

  let hasFollowUps = false;
  const followUpsSheet = getSheet('Rounds_FollowUps');

  if (followUpsSheet && rowIndex) {
    const data = followUpsSheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (Number(data[i][1]) === Number(rowIndex)) {
        hasFollowUps = true;
        break;
      }
    }
  }

  if (isArchived) return 'archived';
  if (isClosed) return 'closed';
  if (hasFollowUps) return 'followup';
  return 'open';
}

ğŸ”´ (3) Ø¥ØµÙ„Ø§Ø­ getViolations() Ø¬Ø°Ø±ÙŠÙ‹Ø§
âŒ Ø§Ø­Ø°Ù Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
âœ… Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ø¸ÙŠÙ:
function getViolations() {
  const roundsLog = sheetToObjects(getSheet('Rounds_Log'));

  const violations = roundsLog
    .filter(r => isRealViolation(r))
    .map(r => {
      const area = r.Area || r.Round_Name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

      return {
        _rowIndex: r._rowIndex,
        Date: formatDate(r.Date),
        Time: formatTime(r.Actual_Time),
        Area: area,
        Round_Name: r.Round_Name || area,
        Responsible_Role: r.Responsible_Role || '',
        Execution_Responsible: r.Execution_Responsible || '',
        Negative_Notes: r.Negative_Notes || '',
        Resolved_By: r.Resolved_By || '',
        Resolved_Date: formatDate(r.Resolved_Date),
        Is_Archived: r.Is_Archived || 'No',
        State: getViolationState(r)
      };
    });

  return {
    violations,
    total: violations.length,
    open: violations.filter(v => v.State === 'open').length,
    followup: violations.filter(v => v.State === 'followup').length,
    closed: violations.filter(v => v.State === 'closed').length,
    archived: violations.filter(v => v.State === 'archived').length
  };
}


ğŸ“Œ Ø§Ù„Ø¢Ù† ÙƒÙ„ Ù…Ø®Ø§Ù„ÙØ© = Ø­Ù‚ÙŠÙ‚ÙŠØ© + Ø­Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.

ğŸ”´ (4) ÙÙ„ØªØ±Ø© Front-End Ù†Ø¸ÙŠÙØ© (Ø¨Ø¯ÙˆÙ† ÙƒØ§Ø´ ÙˆÙ„Ø§ ØªØ¹Ù‚ÙŠØ¯)
âœ¨ Ø¹Ø¯Ù„ filterViolations() ÙÙŠ JavaScript:
function filterViolations(state) {
  CURRENT_VIOLATION_FILTER = state;

  document.querySelectorAll('.violation-filter-btn')
    .forEach(b => b.classList.remove('active'));

  document.querySelector(`[data-filter="${state}"]`)?.classList.add('active');

  let filtered = VIOLATIONS_DATA.violations;

  if (state !== 'all') {
    filtered = filtered.filter(v => v.State === state);
  }

  renderViolations({
    ...VIOLATIONS_DATA,
    violations: filtered
  });
}


ğŸ“Œ Ù„Ø§ ÙƒØ§Ø´
ğŸ“Œ Ù„Ø§ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©

ğŸ”´ (5) Ø¥ØµÙ„Ø§Ø­ Ø¬Ø°Ø±ÙŠ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
âœ¨ Ø§Ø³ØªØ¨Ø¯Ù„ getHistory() Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù‡Ø°Ø§:
function getHistory(params) {
  let rows = sheetToObjects(getSheet('Rounds_Log'));

  if (params.startDate || params.endDate) {
    const start = params.startDate ? new Date(params.startDate) : null;
    const end = params.endDate ? new Date(params.endDate + 'T23:59:59') : null;

    rows = rows.filter(r => {
      const d = parseLogDate(r.Date);
      if (!d) return false;
      if (start && d < start) return false;
      if (end && d > end) return false;
      return true;
    });

  } else if (params.days) {
    const cutoff = getSaudiDate();
    cutoff.setDate(cutoff.getDate() - params.days);
    rows = rows.filter(r => {
      const d = parseLogDate(r.Date);
      return d && d >= cutoff;
    });
  }

  if (params.staff) {
    rows = rows.filter(r =>
      r.Responsible_Role === params.staff ||
      r.Execution_Responsible === params.staff
    );
  }

  rows.sort((a, b) => parseLogDate(b.Date) - parseLogDate(a.Date));

  return {
    entries: rows.map(r => ({
      _rowIndex: r._rowIndex,
      Date: formatDate(r.Date),
      Time: formatTime(r.Actual_Time),
      Area: r.Area || r.Round_Name,
      Responsible_Role: r.Responsible_Role,
      Execution_Responsible: r.Execution_Responsible,
      Status: r.Status,
      Negative_Notes: r.Negative_Notes,
      State: getViolationState(r)
    }))
  };
}


ğŸ“Œ Ù„Ø§ ØªØ¶Ø§Ø±Ø¨
ğŸ“Œ Ù„Ø§ ÙÙ‚Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
ğŸ“Œ Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ ÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª

ğŸ§¼ (6) Migration Ø°ÙƒÙŠØ© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† Ù‚ÙˆÙŠ)
âœ¨ Ù†ÙÙ‘Ø° Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
function migrateOldViolations() {
  const sheet = getSheet('Rounds_Log');
  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  const colIsViolation = headers.indexOf('Is_Violation') + 1;

  let fixed = 0;

  for (let i = 1; i < data.length; i++) {
    const row = {};
    headers.forEach((h, idx) => row[h] = data[i][idx]);

    if (isRealViolation(row) && !data[i][colIsViolation - 1]) {
      sheet.getRange(i + 1, colIsViolation).setValue('Yes');
      fixed++;
    }
  }

  return { fixed };
}

âœ… Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯ v2

âœ”ï¸ ÙƒÙ„ Ù…Ø®Ø§Ù„ÙØ© Ù…Ø±ØµÙˆØ¯Ø© = Ø¸Ø§Ù‡Ø±Ø©
âœ”ï¸ Ø­Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ø§ ØªØªØ¯Ø§Ø®Ù„
âœ”ï¸ ÙÙ„ØªØ±Ø© Ø¯Ù‚ÙŠÙ‚Ø©
âœ”ï¸ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø«Ø§Ø¨Øª
âœ”ï¸ ØµØ§Ù„Ø­ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ù…ÙŠØ© (Ø³Ø¨Ø§Ù‡ÙŠ / Ø¬ÙˆØ¯Ø© / Ø¥Ø¯Ø§Ø±Ø©)