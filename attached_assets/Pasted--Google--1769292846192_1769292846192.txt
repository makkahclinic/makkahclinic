/**
 * Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø®Ø¯Ù…Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠ
 * Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±
 * 
 * Google Sheet ID: 1rTGa4WOw1q0IQE7KCS8TtRJ58J0guTbfgcP30cE-EWk
 * Drive Folder ID: 18NsJAyzWXEuopa-ZfSyYXRWSFxENV9g4
 * Tasks Folder ID: 1ofHpYL2t29PHGO_Cv24HAKnKyYg0CQxz
 * 
 * Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Google Sheet:
 * 1. InsurancePermissions - ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
 * 2. InsuranceUsageLog - Ø³Ø¬Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø©
 * 3. DoctorStats - Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©
 * 4. Tasks - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª
 */

const SHEET_ID = '1rTGa4WOw1q0IQE7KCS8TtRJ58J0guTbfgcP30cE-EWk';
const DRIVE_FOLDER_ID = '18NsJAyzWXEuopa-ZfSyYXRWSFxENV9g4';
const TASKS_FOLDER_ID = '1ofHpYL2t29PHGO_Cv24HAKnKyYg0CQxz';

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø§Ù„ÙƒÙŠÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù… Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
const OWNER_EMAILS = [
  'dr.mansour2012@hotmail.com',
  'owner@m2020m.org',
  'husseinbabsail@gmail.com'
];

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  try {
    let params = {};
    
    if (e.postData && e.postData.contents) {
      params = JSON.parse(e.postData.contents);
    } else if (e.parameter) {
      params = e.parameter;
    }
    
    const action = params.action || e.parameter.action;
    let result;
    
    switch(action) {
      case 'checkPermission':
        result = checkInsurancePermission(params.email);
        break;
      case 'getPermissions':
      case 'getAuthorizedUsers':
        result = getAllInsurancePermissions();
        break;
      case 'addPermission':
      case 'addAuthorizedUser':
        result = addInsurancePermission(params.email, params.name, params.department || params.dept);
        break;
      case 'removePermission':
      case 'removeAuthorizedUser':
        result = removeInsurancePermission(params.email);
        break;
      case 'logUsage':
        result = logInsuranceUsage(params);
        break;
      case 'getUsageLog':
        result = getUsageLog(params.email);
        break;
      case 'getDoctorStats':
        result = getDoctorStats();
        break;
      case 'rebuildDoctorStats':
        result = rebuildDoctorStatsFromLog();
        break;
      case 'updateDoctorRating':
        result = updateDoctorRating(params.doctorName, params.insuranceRating, params.serviceRating);
        break;
      case 'saveReport':
        result = saveReportToDrive(params);
        break;
      case 'getDashboardStats':
        result = getDashboardStats(params.email);
        break;
      case 'getDoctorsList':
        result = getDoctorsList();
        break;
      case 'logUsageAndSavePDF':
        result = logUsageAndSavePDF(params);
        break;
      case 'logUsageAndSaveHTML':
        result = logUsageAndSaveHTML(params);
        break;
      // ============================================
      // Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª - NEW
      // ============================================
      case 'createTask':
        result = createTask_(params);
        break;
      case 'getTasks':
        result = getTasks_();
        break;
      case 'getTaskFile':
        result = getTaskFile_(params);
        break;
      case 'updateTaskStatus':
        result = updateTaskStatus_(params);
        break;
      case 'saveTaskReport':
        result = saveTaskReport_(params);
        break;
      case 'confirmDelivery':
        result = confirmDelivery_(params);
        break;
      case 'getDeliveryLog':
        result = getDeliveryLog_();
        break;
      // ============================================
      // Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© - Ù„Ù„Ù…Ø§Ù„ÙƒÙŠÙ† ÙÙ‚Ø·
      // ============================================
      case 'forceUpdateHeaders':
        if (isOwnerEmail(params.email)) {
          result = forceUpdateAllHeaders();
        } else {
          result = { success: false, error: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' };
        }
        break;
      case 'resetDoctorStats':
        if (isOwnerEmail(params.email)) {
          result = resetDoctorStats();
        } else {
          result = { success: false, error: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' };
        }
        break;
      default:
        result = { success: false, error: 'Unknown action: ' + action };
    }
    
    output.setContent(JSON.stringify(result));
    
  } catch(error) {
    output.setContent(JSON.stringify({ 
      success: false, 
      error: error.toString() 
    }));
  }
  
  return output;
}

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‡Ùˆ Ù…Ø§Ù„Ùƒ
 */
function isOwnerEmail(email) {
  if (!email) return false;
  return OWNER_EMAILS.map(e => e.toLowerCase()).includes(email.toLowerCase());
}

/**
 * Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
 */
function setupSheets() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  
  // ÙˆØ±Ù‚Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  let permSheet = ss.getSheetByName('InsurancePermissions');
  if (!permSheet) {
    permSheet = ss.insertSheet('InsurancePermissions');
    permSheet.appendRow(['email', 'name', 'department', 'addedDate', 'addedBy', 'active']);
    permSheet.getRange(1, 1, 1, 6).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
  }
  
  // ÙˆØ±Ù‚Ø© Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… - Ù…Ø¹ Ø§Ù„Ù€ 10 Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
  let logSheet = ss.getSheetByName('InsuranceUsageLog');
  const logHeaders = [
    'timestamp', 'userEmail', 'userName', 'doctorName', 'caseType', 'filesCount',
    'totalCases', 'totalServices', 'acceptedItems', 'reviewItems', 'docItems',
    'vitalSignsRate', 'docQuality', 'medicalQuality', 'eligibility', 'insuranceDocQuality',
    'reportLink', 'notes'
  ];
  if (!logSheet) {
    logSheet = ss.insertSheet('InsuranceUsageLog');
    logSheet.appendRow(logHeaders);
    logSheet.getRange(1, 1, 1, logHeaders.length).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
  } else {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±Ø² Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø¯ÙŠÙ…Ø©
    const existingHeaders = logSheet.getRange(1, 1, 1, logSheet.getLastColumn()).getValues()[0];
    if (existingHeaders.length < logHeaders.length || existingHeaders[6] !== 'totalCases') {
      logSheet.getRange(1, 1, 1, logHeaders.length).setValues([logHeaders]);
      logSheet.getRange(1, 1, 1, logHeaders.length).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
    }
  }
  
  // ÙˆØ±Ù‚Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ - Ù…Ø¹ Ø§Ù„Ù€ 10 Ù…Ø¤Ø´Ø±Ø§Øª
  let statsSheet = ss.getSheetByName('DoctorStats');
  const statsHeaders = [
    'doctorName', 'totalReports', 'sumCases', 'sumServices', 'sumAccepted', 
    'sumReview', 'sumDoc', 'avgVitalRate', 'avgDocQuality', 'avgMedicalQuality',
    'avgEligibility', 'avgInsuranceDocQuality', 'lastCaseDate', 'folderLink', 'status'
  ];
  if (!statsSheet) {
    statsSheet = ss.insertSheet('DoctorStats');
    statsSheet.appendRow(statsHeaders);
    statsSheet.getRange(1, 1, 1, statsHeaders.length).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
  } else {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±Ø² Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø¯ÙŠÙ…Ø©
    const existingHeaders = statsSheet.getRange(1, 1, 1, statsSheet.getLastColumn()).getValues()[0];
    if (existingHeaders.length < statsHeaders.length || existingHeaders[2] !== 'sumCases') {
      statsSheet.getRange(1, 1, 1, statsHeaders.length).setValues([statsHeaders]);
      statsSheet.getRange(1, 1, 1, statsHeaders.length).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
    }
  }
  
  // ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ù‡Ø§Ù… - NEW
  let tasksSheet = ss.getSheetByName('Tasks');
  if (!tasksSheet) {
    tasksSheet = ss.insertSheet('Tasks');
    tasksSheet.appendRow([
      'ID', 'Ø§Ù„Ø·Ø¨ÙŠØ¨', 'Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù', 'Ø±Ø§ÙØ¹ Ø§Ù„Ù…Ù„Ù', 'Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø±Ø§ÙØ¹', 
      'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„Ù…Ø­Ù„Ù„', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù„ÙŠÙ„', 
      'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'Ø§Ù„ØªÙˆÙ‚ÙŠØ¹', 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù'
    ]);
    tasksSheet.getRange(1, 1, 1, 13).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
  }
  
  return { success: true, message: 'ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¨Ù†Ø¬Ø§Ø­' };
}

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†
 */
function checkInsurancePermission(email) {
  if (!email) {
    return { success: false, hasPermission: false, error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨' };
  }
  
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName('InsurancePermissions');
  
  if (!sheet) {
    setupSheets();
    sheet = ss.getSheetByName('InsurancePermissions');
  }
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString().toLowerCase() === email.toLowerCase() && data[i][5] === true) {
      return { 
        success: true, 
        hasPermission: true,
        user: {
          email: data[i][0],
          name: data[i][1],
          department: data[i][2]
        }
      };
    }
  }
  
  return { success: true, hasPermission: false };
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ù„Ù„Ù…Ø§Ù„Ùƒ)
 */
function getAllInsurancePermissions() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName('InsurancePermissions');
  
  if (!sheet) {
    setupSheets();
    return { success: true, permissions: [] };
  }
  
  const data = sheet.getDataRange().getValues();
  const permissions = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      permissions.push({
        email: data[i][0],
        name: data[i][1],
        department: data[i][2],
        addedDate: data[i][3] ? Utilities.formatDate(new Date(data[i][3]), 'Asia/Riyadh', 'yyyy-MM-dd HH:mm') : '',
        addedBy: data[i][4],
        active: data[i][5] === true || data[i][5] === 'TRUE'
      });
    }
  }
  
  return { success: true, permissions: permissions, users: permissions };
}

/**
 * Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù…ÙˆØ¸Ù
 */
function addInsurancePermission(email, name, department) {
  if (!email || !name) {
    return { success: false, error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨Ø§Ù†' };
  }
  
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName('InsurancePermissions');
  
  if (!sheet) {
    setupSheets();
    sheet = ss.getSheetByName('InsurancePermissions');
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString().toLowerCase() === email.toLowerCase()) {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
      sheet.getRange(i + 1, 6).setValue(true);
      return { success: true, message: 'ØªÙ… ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù' };
    }
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
  sheet.appendRow([
    email,
    name,
    department || '',
    new Date(),
    Session.getActiveUser().getEmail() || 'owner',
    true
  ]);
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø®Ø§Øµ Ù„Ù„Ù…ÙˆØ¸Ù
  createUserFolder(name, email);
  
  return { success: true, message: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­' };
}

/**
 * Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ© Ù…ÙˆØ¸Ù
 */
function removeInsurancePermission(email) {
  if (!email) {
    return { success: false, error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨' };
  }
  
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName('InsurancePermissions');
  
  if (!sheet) {
    return { success: false, error: 'ÙˆØ±Ù‚Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' };
  }
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString().toLowerCase() === email.toLowerCase()) {
      sheet.getRange(i + 1, 6).setValue(false);
      return { success: true, message: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù' };
    }
  }
  
  return { success: false, error: 'Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
}

/**
 * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø®Ø§Øµ Ù„Ù„Ù…ÙˆØ¸Ù
 */
function createUserFolder(name, email) {
  try {
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const folderName = name + ' - ' + email.split('@')[0];
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¬Ù„Ø¯
    const folders = parentFolder.getFoldersByName(folderName);
    if (folders.hasNext()) {
      return folders.next().getUrl();
    }
    
    const newFolder = parentFolder.createFolder(folderName);
    return newFolder.getUrl();
  } catch(e) {
    Logger.log('Error creating folder: ' + e);
    return null;
  }
}

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø© - Ù…Ø¹ Ø§Ù„Ù€ 10 Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
 */
function logInsuranceUsage(params) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    let logSheet = ss.getSheetByName('InsuranceUsageLog');
    
    if (!logSheet) {
      setupSheets();
      logSheet = ss.getSheetByName('InsuranceUsageLog');
    }
    
    const timestamp = new Date();
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù€ 10 Ù…Ø¤Ø´Ø±Ø§Øª
    const totalCases = parseInt(params.totalCases) || 0;
    const totalServices = parseInt(params.totalServices) || 0;
    const acceptedItems = parseInt(params.acceptedItems) || 0;
    const reviewItems = parseInt(params.reviewItems) || 0;
    const docItems = parseInt(params.docItems) || 0;
    const vitalSignsRate = parseFloat(params.vitalSignsRate) || 0;
    const docQuality = parseFloat(params.docQuality) || 0;
    const medicalQuality = parseFloat(params.medicalQuality) || 0;
    const eligibility = parseFloat(params.eligibility) || 0;
    const insuranceDocQuality = parseFloat(params.insuranceDocQuality) || 0;
    
    Logger.log('ğŸ“Š [logInsuranceUsage] Saving: DocQ=' + docQuality + '%, MedQ=' + medicalQuality + '%, Elig=' + eligibility + '%');
    
    logSheet.appendRow([
      timestamp,
      params.userEmail || '',
      params.userName || '',
      params.doctorName || '',
      params.caseType || '',
      params.filesCount || 0,
      totalCases,
      totalServices,
      acceptedItems,
      reviewItems,
      docItems,
      vitalSignsRate,
      docQuality,
      medicalQuality,
      eligibility,
      insuranceDocQuality,
      params.reportLink || '',
      params.notes || ''
    ]);
    
    Logger.log('âœ… InsuranceUsageLog: Row added successfully');
    // ================================
// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©)
// ================================
updateDoctorStats(params.doctorName, {
  // ğŸ”¹ Ø£Ø±Ù‚Ø§Ù… Ø£Ø³Ø§Ø³ÙŠØ©
  totalCases: totalCases,                 // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰ (ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚)
  totalServices: totalServices,            // Ø¹Ø¯Ø¯ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© (Ø£Ø³Ø§Ø³ Ø§Ù„Ø¬ÙˆØ¯Ø©)
  acceptedItems: acceptedItems,
  reviewItems: reviewItems,                // Ø£Ø®Ø·Ø§Ø¡ Ø·Ø¨ÙŠØ©
  docItems: docItems,                      // Ø£Ø®Ø·Ø§Ø¡ ØªÙˆØ«ÙŠÙ‚

  // ğŸ”¹ Ù†Ø³Ø¨ Ø¬Ø§Ù‡Ø²Ø© Ù…Ø­Ø³ÙˆØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø§Ù… Ø§Ù„ØµØ­ÙŠØ­
  medicalQuality: totalServices > 0
    ? Math.round(((totalServices - reviewItems) / totalServices) * 100)
    : 0,

  docQuality: totalServices > 0
    ? Math.round(((totalServices - docItems) / totalServices) * 100)
    : 0,

  eligibility: totalCases > 0
    ? Math.round(((totalCases - Math.min(reviewItems, totalCases)) / totalCases) * 100)
    : 0,

  // ğŸ”¹ Ù…Ø¤Ø´Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
  vitalSignsRate: vitalSignsRate,
  insuranceDocQuality: insuranceDocQuality
});

Logger.log('âœ… DoctorStats: Updated successfully');

return {
  success: true,
  message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­'
};
} catch (error) {
  Logger.log('âŒ [logInsuranceUsage] Error: ' + error.toString());
  return {
    success: false,
    error: error.toString()
  };
}} // end logInsuranceUsage
/**
 * ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ - Ù…Ø¹ Ø§Ù„Ù€ 10 Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
 * Ø§Ù„Ù‡ÙŠØ¯Ø±Ø² (15 Ø¹Ù…ÙˆØ¯):
 * doctorName, totalReports, sumCases, sumServices, sumAccepted,
 * sumReview, sumDoc, avgVitalRate, avgDocQuality, avgMedicalQuality,
 * avgEligibility, avgInsuranceDocQuality, lastCaseDate, folderLink, status
 */
function updateDoctorStats(doctorName, stats) {
  try {
    if (!doctorName || !stats) {
      Logger.log('âš ï¸ [updateDoctorStats] Missing doctorName or stats');
      return;
    }
    
    Logger.log('ğŸ“Š [updateDoctorStats] Doctor: ' + doctorName + ', DocQ=' + stats.docQuality + ', MedQ=' + stats.medicalQuality + ', Elig=' + stats.eligibility);
    
    const ss = SpreadsheetApp.openById(SHEET_ID);
    let statsSheet = ss.getSheetByName('DoctorStats');
    
    if (!statsSheet) {
      setupSheets();
      statsSheet = ss.getSheetByName('DoctorStats');
    }
    
    const data = statsSheet.getDataRange().getValues();
    let doctorRow = -1;
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().toLowerCase() === doctorName.toLowerCase()) {
        doctorRow = i + 1;
        break;
      }
    }
    
    const timestamp = new Date();
    const formattedDate = Utilities.formatDate(timestamp, 'Asia/Riyadh', 'yyyy-MM-dd HH:mm');
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    function getStatus(docQ, medQ, elig) {
      const avg = (docQ + medQ + elig) / 3;
      if (avg >= 90) return 'Ù…Ù…ØªØ§Ø²';
      if (avg >= 70) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
      if (avg >= 50) return 'Ø¬ÙŠØ¯';
      return 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
    }
    
    if (doctorRow > 0) {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ - Ø¬Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©
      Logger.log('ğŸ“ [updateDoctorStats] Updating existing doctor at row ' + doctorRow);
      
      const currentReports = parseInt(data[doctorRow - 1][1]) || 0;
      const currentSumCases = parseInt(data[doctorRow - 1][2]) || 0;
      const currentSumServices = parseInt(data[doctorRow - 1][3]) || 0;
      const currentSumAccepted = parseInt(data[doctorRow - 1][4]) || 0;
      const currentSumReview = parseInt(data[doctorRow - 1][5]) || 0;
      const currentSumDoc = parseInt(data[doctorRow - 1][6]) || 0;
      const currentVitalRate = parseFloat(data[doctorRow - 1][7]) || 0;
      const currentDocQuality = parseFloat(data[doctorRow - 1][8]) || 0;
      const currentMedicalQuality = parseFloat(data[doctorRow - 1][9]) || 0;
      const currentEligibility = parseFloat(data[doctorRow - 1][10]) || 0;
      const currentInsuranceDocQuality = parseFloat(data[doctorRow - 1][11]) || 0;
      
      const newReports = currentReports + 1;
      const newSumCases = currentSumCases + (stats.totalCases || 0);
      const newSumServices = currentSumServices + (stats.totalServices || 0);
      const newSumAccepted = currentSumAccepted + (stats.acceptedItems || 0);
      const newSumReview = currentSumReview + (stats.reviewItems || 0);
      const newSumDoc = currentSumDoc + (stats.docItems || 0);
      
      // âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ÙˆØ²ÙˆÙ†Ø© Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (ÙˆÙ„ÙŠØ³ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±)
      // âš ï¸ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø®Ø¯Ù…Ø§ØªØŒ Ù†ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª
      const newServiceWeight = stats.totalServices || 0;
      const totalWeight = currentSumServices + newServiceWeight;
      
      const newVitalRate = totalWeight > 0 
        ? ((currentVitalRate * currentSumServices + (stats.vitalSignsRate || 0) * newServiceWeight) / totalWeight).toFixed(1)
        : 0;
      const newDocQuality = totalWeight > 0 
        ? ((currentDocQuality * currentSumServices + (stats.docQuality || 0) * newServiceWeight) / totalWeight).toFixed(1)
        : 0;
      const newMedicalQuality = totalWeight > 0 
        ? ((currentMedicalQuality * currentSumServices + (stats.medicalQuality || 0) * newServiceWeight) / totalWeight).toFixed(1)
        : 0;
      const newEligibility = totalWeight > 0 
        ? ((currentEligibility * currentSumServices + (stats.eligibility || 0) * newServiceWeight) / totalWeight).toFixed(1)
        : 0;
      const newInsuranceDocQuality = totalWeight > 0 
        ? ((currentInsuranceDocQuality * currentSumServices + (stats.insuranceDocQuality || 0) * newServiceWeight) / totalWeight).toFixed(1)
        : 0;
      
      const status = getStatus(parseFloat(newDocQuality), parseFloat(newMedicalQuality), parseFloat(newEligibility));
      
      Logger.log('ğŸ“Š [updateDoctorStats] New values: DocQ=' + newDocQuality + ', MedQ=' + newMedicalQuality + ', Elig=' + newEligibility);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ - 14 Ø¹Ù…ÙˆØ¯ (B Ø¥Ù„Ù‰ O)
      statsSheet.getRange(doctorRow, 2, 1, 14).setValues([[
        newReports, newSumCases, newSumServices, newSumAccepted, newSumReview, newSumDoc,
        newVitalRate, newDocQuality, newMedicalQuality, newEligibility, newInsuranceDocQuality,
        formattedDate, data[doctorRow - 1][13] || '', status
      ]]);
      
      Logger.log('âœ… [updateDoctorStats] Row updated successfully');
      
    } else {
      // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨ Ø¬Ø¯ÙŠØ¯
      Logger.log('â• [updateDoctorStats] Adding new doctor: ' + doctorName);
      
      const folderUrl = createDoctorFolder(doctorName);
      const status = getStatus(stats.docQuality || 0, stats.medicalQuality || 0, stats.eligibility || 0);
      
      // 15 Ø¹Ù…ÙˆØ¯ ÙƒØ§Ù…Ù„Ø©
      const newRow = [
        doctorName,                       // A: doctorName
        1,                                // B: totalReports
        stats.totalCases || 0,           // C: sumCases
        stats.totalServices || 0,        // D: sumServices
        stats.acceptedItems || 0,        // E: sumAccepted
        stats.reviewItems || 0,          // F: sumReview
        stats.docItems || 0,             // G: sumDoc
        stats.vitalSignsRate || 0,       // H: avgVitalRate
        stats.docQuality || 0,           // I: avgDocQuality âœ“
        stats.medicalQuality || 0,       // J: avgMedicalQuality âœ“
        stats.eligibility || 0,          // K: avgEligibility âœ“
        stats.insuranceDocQuality || 0,  // L: avgInsuranceDocQuality
        formattedDate,                   // M: lastCaseDate
        folderUrl || '',                 // N: folderLink
        status                           // O: status
      ];
      
      Logger.log('ğŸ“Š [updateDoctorStats] New row (15 cols): ' + JSON.stringify(newRow));
      
      statsSheet.appendRow(newRow);
      
      Logger.log('âœ… [updateDoctorStats] New doctor added successfully');
    }
  } catch(error) {
    Logger.log('âŒ [updateDoctorStats] Error: ' + error.toString());
    throw error;
  }
}

/**
 * âœ… Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ DoctorStats Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† InsuranceUsageLog
 * Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¶Ù…Ù† ØªØ·Ø§Ø¨Ù‚ 100% Ø¨ÙŠÙ† Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
 * Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ù…ÙˆØ²ÙˆÙ†Ø© Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (ÙˆÙ„ÙŠØ³ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±)
 */
function rebuildDoctorStatsFromLog() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const logSheet = ss.getSheetByName('InsuranceUsageLog');
    const statsSheet = ss.getSheetByName('DoctorStats');
    
    if (!logSheet || !statsSheet) {
      return { success: false, error: 'Ø§Ù„Ø´ÙŠØªØ§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' };
    }
    
    const log = logSheet.getDataRange().getValues();
    
    // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ù‡ÙŠØ¯Ø±)
    if (statsSheet.getLastRow() > 1) {
      statsSheet.getRange(2, 1, statsSheet.getLastRow() - 1, statsSheet.getLastColumn()).clearContent();
    }
    
    const map = {};
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ (Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„ØµÙ 2 - Ø¨Ø¹Ø¯ Ø§Ù„Ù‡ÙŠØ¯Ø±)
    for (let i = 1; i < log.length; i++) {
      const row = log[i];
      const doctor = row[3]; // doctorName ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ D (index 3)
      
      if (!doctor || doctor === '') continue;
      
      if (!map[doctor]) {
        map[doctor] = {
          reports: 0,
          cases: 0,
          services: 0,
          accepted: 0,
          review: 0,
          doc: 0,
          vitalSum: 0,
          docQSum: 0,
          medQSum: 0,
          eligSum: 0,
          insQSum: 0,
          lastDate: null,
          folderLink: ''
        };
      }
      
      const r = map[doctor];
      const services = Number(row[7]) || 0; // totalServices ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ H (index 7)
      
      r.reports++;
      r.cases += Number(row[6]) || 0;      // totalCases
      r.services += services;
      r.accepted += Number(row[8]) || 0;   // acceptedItems
      r.review += Number(row[9]) || 0;     // reviewItems
      r.doc += Number(row[10]) || 0;       // docItems
      
      // âš ï¸ Ø§Ù„ÙˆØ²Ù† Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆÙ„ÙŠØ³ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
      r.vitalSum += (Number(row[11]) || 0) * services;
      r.docQSum += (Number(row[12]) || 0) * services;
      r.medQSum += (Number(row[13]) || 0) * services;
      r.eligSum += (Number(row[14]) || 0) * services;
      r.insQSum += (Number(row[15]) || 0) * services;
      
      // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ®
      if (row[0]) {
        const rowDate = new Date(row[0]);
        if (!r.lastDate || rowDate > r.lastDate) {
          r.lastDate = rowDate;
        }
      }
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
    let doctorsUpdated = 0;
    Object.entries(map).forEach(([doctor, r]) => {
      const avgVital = r.services > 0 ? (r.vitalSum / r.services).toFixed(1) : 0;
      const avgDocQ = r.services > 0 ? (r.docQSum / r.services).toFixed(1) : 0;
      const avgMedQ = r.services > 0 ? (r.medQSum / r.services).toFixed(1) : 0;
      const avgElig = r.services > 0 ? (r.eligSum / r.services).toFixed(1) : 0;
      const avgInsQ = r.services > 0 ? (r.insQSum / r.services).toFixed(1) : 0;
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
      const avgAll = (parseFloat(avgDocQ) + parseFloat(avgMedQ) + parseFloat(avgElig)) / 3;
      let status = 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
      if (avgAll >= 90) status = 'Ù…Ù…ØªØ§Ø²';
      else if (avgAll >= 70) status = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
      else if (avgAll >= 50) status = 'Ø¬ÙŠØ¯';
      
      const formattedDate = r.lastDate 
        ? Utilities.formatDate(r.lastDate, 'Asia/Riyadh', 'yyyy-MM-dd HH:mm')
        : '';
      
      statsSheet.appendRow([
        doctor,      // A: doctorName
        r.reports,   // B: totalReports
        r.cases,     // C: sumCases
        r.services,  // D: sumServices
        r.accepted,  // E: sumAccepted
        r.review,    // F: sumReview
        r.doc,       // G: sumDoc
        avgVital,    // H: avgVitalRate
        avgDocQ,     // I: avgDocQuality
        avgMedQ,     // J: avgMedicalQuality
        avgElig,     // K: avgEligibility
        avgInsQ,     // L: avgInsuranceDocQuality
        formattedDate, // M: lastCaseDate
        '',          // N: folderLink
        status       // O: status
      ]);
      
      doctorsUpdated++;
    });
    
    Logger.log('âœ… [rebuildDoctorStats] Rebuilt stats for ' + doctorsUpdated + ' doctors');
    
    return { 
      success: true, 
      message: 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ' + doctorsUpdated + ' Ø·Ø¨ÙŠØ¨',
      doctorsUpdated: doctorsUpdated 
    };
    
  } catch(error) {
    Logger.log('âŒ [rebuildDoctorStats] Error: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù„Ù„Ø·Ø¨ÙŠØ¨
 */
function createDoctorFolder(doctorName) {
  try {
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const folderName = 'Ø¯. ' + doctorName;
    
    const folders = parentFolder.getFoldersByName(folderName);
    if (folders.hasNext()) {
      return folders.next().getUrl();
    }
    
    const newFolder = parentFolder.createFolder(folderName);
    return newFolder.getUrl();
  } catch(e) {
    Logger.log('Error creating doctor folder: ' + e);
    return null;
  }
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
 */
function getUsageLog(email) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const logSheet = ss.getSheetByName('InsuranceUsageLog');
  
  if (!logSheet) {
    return { success: true, logs: [] };
  }
  
  const data = logSheet.getDataRange().getValues();
  const logs = [];
  
  for (let i = 1; i < data.length; i++) {
    if (!email || data[i][1].toString().toLowerCase() === email.toLowerCase()) {
      logs.push({
        timestamp: data[i][0] ? Utilities.formatDate(new Date(data[i][0]), 'Asia/Riyadh', 'yyyy-MM-dd HH:mm') : '',
        userEmail: data[i][1],
        userName: data[i][2],
        doctorName: data[i][3],
        caseType: data[i][4],
        filesCount: data[i][5],
        docQuality: data[i][6],
        medicalQuality: data[i][7],
        eligibility: data[i][8],
        reportLink: data[i][9],
        notes: data[i][10]
      });
    }
  }
  
  return { success: true, logs: logs.reverse() };
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
 * Headers (15 columns - Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­):
 * [0] doctorName, [1] totalReports, [2] sumCases, [3] sumServices, [4] sumAccepted,
 * [5] sumReview, [6] sumDoc, [7] avgVitalRate, [8] avgDocQuality,
 * [9] avgMedicalQuality, [10] avgEligibility, [11] avgInsuranceDocQuality,
 * [12] lastCaseDate, [13] folderLink, [14] status
 */
function getDoctorStats() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const statsSheet = ss.getSheetByName('DoctorStats');
  
  if (!statsSheet) {
    return { success: true, doctors: [] };
  }
  
  const data = statsSheet.getDataRange().getValues();
  const doctors = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      doctors.push({
        doctorName: data[i][0],
        totalReports: data[i][1],           // [1] Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        totalCases: data[i][2],             // [2] Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª (sumCases)
        totalServices: data[i][3],          // [3] Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (sumServices)
        sumAccepted: data[i][4],            // [4] Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©
        sumReview: data[i][5],              // [5] ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©
        sumDoc: data[i][6],                 // [6] ØªØ­ØªØ§Ø¬ ØªÙˆØ«ÙŠÙ‚
        avgVitalRate: data[i][7],           // [7] Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©
        avgDocQuality: data[i][8],          // [8] Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ âœ“
        avgMedicalQuality: data[i][9],      // [9] Ø¬ÙˆØ¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª âœ“
        avgEligibility: data[i][10],        // [10] Ø£Ù‡Ù„ÙŠØ© Ø§Ù„Ù…Ø±ÙŠØ¶ âœ“
        avgInsuranceDocQuality: data[i][11],// [11] Ø¬ÙˆØ¯Ø© ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØªØ£Ù…ÙŠÙ†
        lastCaseDate: data[i][12],          // [12] Ø¢Ø®Ø± Ù…Ø±Ø§Ø¬Ø¹Ø©
        folderLink: data[i][13],            // [13] Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¬Ù„Ø¯
        status: data[i][14]                 // [14] Ø§Ù„Ø­Ø§Ù„Ø©
      });
    }
  }
  
  // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹
  doctors.sort((a, b) => b.totalCases - a.totalCases);
  
  return { success: true, doctors: doctors };
}

/**
 * Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Drive
 */
function saveReportToDrive(params) {
  try {
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    
    // Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨
    const doctorFolderName = 'Ø¯. ' + (params.doctorName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
    let doctorFolder;
    
    const folders = parentFolder.getFoldersByName(doctorFolderName);
    if (folders.hasNext()) {
      doctorFolder = folders.next();
    } else {
      doctorFolder = parentFolder.createFolder(doctorFolderName);
    }
    
    // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ…Ù„Ù HTML Ù…Ø¹ Ø¨Ù†ÙŠØ© ÙƒØ§Ù…Ù„Ø©
    const timestamp = Utilities.formatDate(new Date(), 'Asia/Riyadh', 'yyyy-MM-dd_HHmm');
    const fileName = 'ØªÙ‚Ø±ÙŠØ±_' + timestamp + '.html';
    
    const reportBody = params.reportHtml || '<p>No content</p>';
    
    // Ø¥Ù†Ø´Ø§Ø¡ HTML ÙƒØ§Ù…Ù„ Ù…Ø¹ CSS
    const fullHtml = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ© - ${params.doctorName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Tajawal', sans-serif; background: #f8fafc; padding: 20px; direction: rtl; }
    .print-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; background: linear-gradient(135deg, #1e3a5f, #2d4a6f); border-radius: 12px; margin-bottom: 20px; color: white; }
    .print-header img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #c9a962; background: white; }
    .print-header-text h1 { color: #c9a962; font-size: 1.4rem; margin-bottom: 5px; }
    .print-header-text p { font-size: 0.9rem; opacity: 0.9; }
    .print-header-dates { text-align: left; font-size: 0.85rem; }
    .print-footer { margin-top: 30px; padding: 15px; background: #f1f5f9; border-radius: 8px; text-align: center; font-size: 0.8rem; color: #64748b; border-top: 3px solid #c9a962; }
    .audit-report { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .audit-report h1 { color: #1e3a5f; font-size: 1.5rem; text-align: center; padding: 15px; border-bottom: 3px solid #c9a962; margin-bottom: 20px; }
    .audit-report h2 { color: #1e3a5f; font-size: 1.2rem; margin-top: 25px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
    .audit-report h3 { color: #334155; font-size: 1rem; margin-top: 15px; }
    .audit-report p, .audit-report li { line-height: 1.9; color: #334155; }
    .audit-report ul { list-style: none; padding: 0; }
    .audit-report li { padding: 12px 15px; margin: 8px 0; border-radius: 8px; border-right: 4px solid #cbd5e1; background: #f8fafc; }
    .success, li:has(.success) { background: #dcfce7 !important; border-right-color: #22c55e !important; }
    .error, li:has(.error) { background: #fee2e2 !important; border-right-color: #ef4444 !important; }
    .warning, li:has(.warning) { background: #fef9c3 !important; border-right-color: #eab308 !important; }
    .info, li:has(.info) { background: #dbeafe !important; border-right-color: #3b82f6 !important; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 12px; text-align: right; border: 1px solid #e2e8f0; }
    th { background: #1e3a5f; color: white; }
    tr:nth-child(even) { background: #f8fafc; }
    .score-box { text-align: center; padding: 20px; border-radius: 12px; margin: 15px 0; }
    .score-high { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .score-medium { background: linear-gradient(135deg, #eab308, #ca8a04); color: white; }
    .score-low { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .score-value { font-size: 2.5rem; font-weight: bold; }
    @media print { body { background: white; padding: 0; } .audit-report { box-shadow: none; } }
  </style>
</head>
<body>
  ${reportBody}
</body>
</html>`;
    
    const file = doctorFolder.createFile(fileName, fullHtml, MimeType.HTML);
    
    return { 
      success: true, 
      fileUrl: file.getUrl(),
      folderUrl: doctorFolder.getUrl(),
      message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­' 
    };
  } catch(e) {
    return { success: false, error: e.toString() };
  }
}

/**
 * Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
 */
function getDashboardStats(email) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  
  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©
  const logSheet = ss.getSheetByName('InsuranceUsageLog');
  const statsSheet = ss.getSheetByName('DoctorStats');
  const permSheet = ss.getSheetByName('InsurancePermissions');
  
  let totalCases = 0;
  let todayCases = 0;
  let userCases = 0;
  let userTodayCases = 0;
  const today = Utilities.formatDate(new Date(), 'Asia/Riyadh', 'yyyy-MM-dd');
  
  if (logSheet) {
    const logData = logSheet.getDataRange().getValues();
    for (let i = 1; i < logData.length; i++) {
      if (logData[i][0]) {
        totalCases++;
        const logDate = Utilities.formatDate(new Date(logData[i][0]), 'Asia/Riyadh', 'yyyy-MM-dd');
        if (logDate === today) todayCases++;
        
        if (email && logData[i][1].toString().toLowerCase() === email.toLowerCase()) {
          userCases++;
          if (logDate === today) userTodayCases++;
        }
      }
    }
  }
  
  let totalDoctors = 0;
  if (statsSheet) {
    const statsData = statsSheet.getDataRange().getValues();
    totalDoctors = statsData.length - 1;
  }
  
  let totalStaff = 0;
  if (permSheet) {
    const permData = permSheet.getDataRange().getValues();
    for (let i = 1; i < permData.length; i++) {
      if (permData[i][5] === true) totalStaff++;
    }
  }
  
  return {
    success: true,
    stats: {
      totalCases: totalCases,
      todayCases: todayCases,
      totalDoctors: totalDoctors,
      totalStaff: totalStaff,
      userCases: userCases,
      userTodayCases: userTodayCases
    }
  };
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù…Ù† Ø´ÙŠØª Staff
 */
function getDoctorsList() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName('Staff');
    
    if (!sheet) {
      return { success: true, doctors: [] };
    }
    
    const data = sheet.getDataRange().getValues();
    const doctors = [];
    
    for (let i = 1; i < data.length; i++) {
      const name = data[i][0]; // Ø§Ù„Ø¹Ù…ÙˆØ¯ A - Ø§Ù„Ø§Ø³Ù…
      const specialty = data[i][1]; // Ø§Ù„Ø¹Ù…ÙˆØ¯ B - Ø§Ù„ØªØ®ØµØµ
      if (name && name.toString().trim()) {
        doctors.push({ 
          name: name.toString().trim(), 
          specialty: specialty ? specialty.toString().trim() : '' 
        });
      }
    }
    
    return { success: true, doctors: doctors };
  } catch(e) {
    return { success: false, error: e.toString(), doctors: [] };
  }
}

// ============================================
// Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©
// ============================================

/**
 * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
 */
function createTask_(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    let tasksSheet = ss.getSheetByName('Tasks');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´ÙŠØª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (!tasksSheet) {
      tasksSheet = ss.insertSheet('Tasks');
      tasksSheet.appendRow([
        'ID', 'Ø§Ù„Ø·Ø¨ÙŠØ¨', 'Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù', 'Ø±Ø§ÙØ¹ Ø§Ù„Ù…Ù„Ù', 'Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø±Ø§ÙØ¹', 
        'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„Ù…Ø­Ù„Ù„', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù„ÙŠÙ„', 
        'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'Ø§Ù„ØªÙˆÙ‚ÙŠØ¹', 'Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù'
      ]);
      tasksSheet.getRange(1, 1, 1, 13).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
    }
    
    const taskId = Utilities.getUuid();
    const uploadDate = Utilities.formatDate(new Date(), 'Asia/Riyadh', 'yyyy-MM-dd HH:mm');
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive - Ù‡Ø°Ø§ Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    let fileUrl = '';
    try {
      const folder = DriveApp.getFolderById(TASKS_FOLDER_ID);
      const fileBlob = Utilities.newBlob(
        Utilities.base64Decode(data.fileData), 
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
        data.fileName
      );
      const file = folder.createFile(fileBlob);
      fileUrl = file.getUrl();
      Logger.log('File saved to Drive: ' + fileUrl);
    } catch(e) {
      Logger.log('CRITICAL: Could not save to Drive: ' + e.message);
      return { success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive: ' + e.message };
    }
    
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø­ÙÙØ¸ ÙÙŠ Drive
    if (!fileUrl || fileUrl.length < 10) {
      return { success: false, error: 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ù…Ù† Drive' };
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø´ÙŠØª - Ù„Ø§ Ù†Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© Ù„Ø£Ù†Ù‡Ø§ ØªÙÙ‚Ø·Ø¹!
    // Ø§Ù„Ù…Ù„Ù ÙŠÙØ­ÙØ¸ ÙÙŠ Drive ÙÙ‚Ø· ÙˆÙŠÙÙ‚Ø±Ø£ Ù…Ù† Ù‡Ù†Ø§Ùƒ
    tasksSheet.appendRow([
      taskId,
      data.doctorName || '',
      data.fileName || '',
      data.uploadedBy || '',
      data.uploadedByEmail || '',
      uploadDate,
      'pending',
      '',
      '',
      '',
      '',
      fileUrl,
      'FILE_IN_DRIVE' // Ø¹Ù„Ø§Ù…Ø© Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive ÙˆÙ„ÙŠØ³ Ù‡Ù†Ø§
    ]);
    
    return { success: true, taskId: taskId };
  } catch(e) {
    Logger.log('createTask error: ' + e);
    return { success: false, error: e.toString() };
  }
}

/**
 * Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
 */
function getTasks_() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const tasksSheet = ss.getSheetByName('Tasks');
    
    if (!tasksSheet) {
      return { success: true, tasks: [] };
    }
    
    const data = tasksSheet.getDataRange().getValues();
    const tasks = [];
    
    for (let i = 1; i < data.length; i++) {
      // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ø§Ù… ØºÙŠØ± Ø§Ù„Ù…Ø³Ù„Ù…Ø© ÙÙ‚Ø·
      if (data[i][6] !== 'delivered') {
        tasks.push({
          id: data[i][0],
          doctorName: data[i][1],
          fileName: data[i][2],
          uploadedBy: data[i][3],
          uploadDate: data[i][5],
          status: data[i][6],
          analyzedBy: data[i][7],
          fileUrl: data[i][11],
          reportHtml: data[i][13] || '', // Column 14 (index 13) - saved report
          rowIndex: i + 1
        });
      }
    }
    
    return { success: true, tasks: tasks };
  } catch(e) {
    Logger.log('getTasks error: ' + e);
    return { success: false, error: e.toString() };
  }
}

/**
 * Ø¬Ù„Ø¨ Ù…Ù„Ù Ø§Ù„Ù…Ù‡Ù…Ø© - ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙÙ‚Ø±Ø£ Ù…Ù† Drive ÙÙ‚Ø· Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
 */
function getTaskFile_(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const tasksSheet = ss.getSheetByName('Tasks');
    
    if (!tasksSheet) {
      return { success: false, error: 'Tasks sheet not found' };
    }
    
    const allData = tasksSheet.getDataRange().getValues();
    
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0] === data.taskId) {
        const fileUrl = allData[i][11]; // Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive
        const fileName = allData[i][2];
        
        Logger.log('Getting file for task: ' + data.taskId);
        Logger.log('File URL: ' + fileUrl);
        Logger.log('File name: ' + fileName);
        
        // ÙŠØ¬Ø¨ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ù…Ù† Drive Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±)
        if (fileUrl && fileUrl.length > 10) {
          try {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ File ID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
            let fileId = null;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ ID Ù…Ù† Ø±Ø§Ø¨Ø· Google Drive
            const fileIdMatch = fileUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (fileIdMatch && fileIdMatch[1]) {
              fileId = fileIdMatch[1];
            } else {
              // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù† Ø±Ø§Ø¨Ø· open?id=
              const openIdMatch = fileUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/);
              if (openIdMatch && openIdMatch[1]) {
                fileId = openIdMatch[1];
              }
            }
            
            if (fileId) {
              const file = DriveApp.getFileById(fileId);
              const blob = file.getBlob();
              const bytes = blob.getBytes();
              const base64Data = Utilities.base64Encode(bytes);
              
              Logger.log('SUCCESS: File loaded from Drive: ' + fileName);
              Logger.log('File size: ' + bytes.length + ' bytes');
              Logger.log('Base64 length: ' + base64Data.length + ' chars');
              
              return { 
                success: true, 
                fileData: base64Data,
                fileName: fileName,
                fileSize: bytes.length,
                source: 'drive'
              };
            } else {
              Logger.log('ERROR: Could not extract file ID from URL: ' + fileUrl);
            }
          } catch(driveError) {
            Logger.log('ERROR: Drive read failed: ' + driveError.toString());
            return { success: false, error: 'ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ù…Ù† Drive: ' + driveError.message };
          }
        }
        
        // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ù„ÙŠØ© Ø£Ø¨Ø¯Ø§Ù‹ - Ø§Ù„Ù…Ù„ÙØ§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙÙ‚Ø±Ø£ Ù…Ù† Drive ÙÙ‚Ø·
        Logger.log('ERROR: No valid Drive URL found for task');
        return { success: false, error: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù.' };
      }
    }
    
    return { success: false, error: 'Task not found' };
  } catch(e) {
    Logger.log('getTaskFile error: ' + e);
    return { success: false, error: e.toString() };
  }
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©
 */
function updateTaskStatus_(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const tasksSheet = ss.getSheetByName('Tasks');
    
    if (!tasksSheet) {
      return { success: false, error: 'Tasks sheet not found' };
    }
    
    const allData = tasksSheet.getDataRange().getValues();
    
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0] === data.taskId) {
        tasksSheet.getRange(i + 1, 7).setValue(data.status);
        
        if (data.status === 'analyzed' || data.status === 'analyzing') {
          if (data.analyzedBy) {
            tasksSheet.getRange(i + 1, 8).setValue(data.analyzedBy);
            tasksSheet.getRange(i + 1, 9).setValue(Utilities.formatDate(new Date(), 'Asia/Riyadh', 'yyyy-MM-dd HH:mm'));
          }
        }
        
        return { success: true };
      }
    }
    
    return { success: false, error: 'Task not found' };
  } catch(e) {
    Logger.log('updateTaskStatus error: ' + e);
    return { success: false, error: e.toString() };
  }
}

/**
 * Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„
 */
function saveTaskReport_(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const tasksSheet = ss.getSheetByName('Tasks');
    
    if (!tasksSheet) {
      return { success: false, error: 'Tasks sheet not found' };
    }
    
    const allData = tasksSheet.getDataRange().getValues();
    
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0] === data.taskId) {
        // Update status to analyzed
        tasksSheet.getRange(i + 1, 7).setValue('analyzed');
        
        // Save analyzed by and date
        if (data.analyzedBy) {
          tasksSheet.getRange(i + 1, 8).setValue(data.analyzedBy);
          tasksSheet.getRange(i + 1, 9).setValue(Utilities.formatDate(new Date(), 'Asia/Riyadh', 'yyyy-MM-dd HH:mm'));
        }
        
        // Save report HTML in column 14 (index 13)
        if (data.reportHtml) {
          // Compress report if too large (Google Sheets cell limit is ~50000 chars)
          let reportToSave = data.reportHtml;
          if (reportToSave.length > 45000) {
            reportToSave = reportToSave.substring(0, 45000) + '<!-- ØªÙ… Ø§Ù‚ØªØ·Ø§Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->';
          }
          tasksSheet.getRange(i + 1, 14).setValue(reportToSave);
        }
        
        return { success: true };
      }
    }
    
    return { success: false, error: 'Task not found' };
  } catch(e) {
    Logger.log('saveTaskReport error: ' + e);
    return { success: false, error: e.toString() };
  }
}

/**
 * ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù…Ø¹ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
 */
function confirmDelivery_(data) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const tasksSheet = ss.getSheetByName('Tasks');
    
    if (!tasksSheet) {
      return { success: false, error: 'Tasks sheet not found' };
    }
    
    const allData = tasksSheet.getDataRange().getValues();
    
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0] === data.taskId) {
        tasksSheet.getRange(i + 1, 7).setValue('delivered');
        tasksSheet.getRange(i + 1, 10).setValue(Utilities.formatDate(new Date(), 'Asia/Riyadh', 'yyyy-MM-dd HH:mm'));
        
        // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙƒØ§Ù…Ù„Ø§Ù‹ - base64 ÙŠØ¹Ù…Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ img src
        let signatureToSave = data.signature || '';
        Logger.log('Signature length: ' + signatureToSave.length);
        
        tasksSheet.getRange(i + 1, 11).setValue(signatureToSave);
        
        return { success: true };
      }
    }
    
    return { success: false, error: 'Task not found' };
  } catch(e) {
    Logger.log('confirmDelivery error: ' + e);
    return { success: false, error: e.toString() };
  }
}

/**
 * Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª
 */
function getDeliveryLog_() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const tasksSheet = ss.getSheetByName('Tasks');
    
    if (!tasksSheet) {
      return { success: true, logs: [] };
    }
    
    const data = tasksSheet.getDataRange().getValues();
    const logs = [];
    
    for (let i = 1; i < data.length; i++) {
      logs.push({
        id: data[i][0],
        doctorName: data[i][1],
        fileName: data[i][2],
        uploadedBy: data[i][3],
        uploadDate: data[i][5],
        status: data[i][6],
        analyzedBy: data[i][7] || '-',
        analysisDate: data[i][8] || '-',
        deliveryDate: data[i][9] || '-',
        signature: data[i][10] || ''
      });
    }
    
    logs.reverse();
    
    return { success: true, logs: logs };
  } catch(e) {
    Logger.log('getDeliveryLog error: ' + e);
    return { success: false, error: e.toString() };
  }
}

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­ÙØ¸ HTML
 */
function logUsageAndSaveHTML(params) {
  try {
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
    logInsuranceUsage(params);
    
    // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    const saveResult = saveReportToDrive(params);
    
    if (saveResult.success) {
      return {
        success: true,
        message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­',
        reportLink: saveResult.fileUrl
      };
    } else {
      return {
        success: true,
        message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„ÙƒÙ† ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Drive',
        reportLink: '',
        error: saveResult.error
      };
    }
  } catch(error) {
    Logger.log('âŒ Ø®Ø·Ø£ ÙÙŠ logUsageAndSaveHTML: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­ÙØ¸ PDF
 */
function logUsageAndSavePDF(params) {
  return logUsageAndSaveHTML(params);
}

/**
 * Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
 */
function testSetup() {
  const result = setupSheets();
  Logger.log(result);
  
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ Ø§ÙØªØ±Ø§Ø¶ÙŠ
  addInsurancePermission('owner@m2020m.org', 'Ø§Ù„Ù…Ø§Ù„Ùƒ', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
  Logger.log('Setup complete!');
}

/**
 * âš ï¸ ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ø±ÙŠ Ù„Ù„Ù‡ÙŠØ¯Ø±Ø² - ÙŠØ­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙˆÙŠØ¹ÙŠØ¯ ÙƒØªØ§Ø¨ØªÙ‡
 * Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‡ÙŠØ¯Ø±Ø² Ù‚Ø¯ÙŠÙ…Ø© Ø£Ùˆ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©
 * 
 * Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:
 * 1. Ø§ÙØªØ­ Apps Script Editor
 * 2. Ø§Ø®ØªØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
 * 3. Ø§Ø¶ØºØ· Run
 * 
 * Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ù„Ù† ÙŠØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙÙ‚Ø· Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ù‡ÙŠØ¯Ø±Ø²)
 */
function forceUpdateAllHeaders() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const results = [];
  
  // ========== 1. ØªØ­Ø¯ÙŠØ« InsuranceUsageLog (18 Ø¹Ù…ÙˆØ¯) ==========
  const logHeaders = [
    'timestamp', 'userEmail', 'userName', 'doctorName', 'caseType', 'filesCount',
    'totalCases', 'totalServices', 'acceptedItems', 'reviewItems', 'docItems',
    'vitalSignsRate', 'docQuality', 'medicalQuality', 'eligibility', 'insuranceDocQuality',
    'reportLink', 'notes'
  ];
  
  let logSheet = ss.getSheetByName('InsuranceUsageLog');
  if (logSheet) {
    // Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
    logSheet.deleteRow(1);
    // Ø¥Ø¯Ø±Ø§Ø¬ ØµÙ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    logSheet.insertRowBefore(1);
    // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    logSheet.getRange(1, 1, 1, logHeaders.length).setValues([logHeaders]);
    logSheet.getRange(1, 1, 1, logHeaders.length)
      .setFontWeight('bold')
      .setBackground('#1e3a5f')
      .setFontColor('white');
    results.push('âœ… InsuranceUsageLog: ØªÙ… ØªØ­Ø¯ÙŠØ« 18 Ø¹Ù…ÙˆØ¯');
  } else {
    results.push('âš ï¸ InsuranceUsageLog: Ø§Ù„ÙˆØ±Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
  }
  
  // ========== 2. ØªØ­Ø¯ÙŠØ« DoctorStats (15 Ø¹Ù…ÙˆØ¯) ==========
  const statsHeaders = [
    'doctorName', 'totalReports', 'sumCases', 'sumServices', 'sumAccepted', 
    'sumReview', 'sumDoc', 'avgVitalRate', 'avgDocQuality', 'avgMedicalQuality',
    'avgEligibility', 'avgInsuranceDocQuality', 'lastCaseDate', 'folderLink', 'status'
  ];
  
  let statsSheet = ss.getSheetByName('DoctorStats');
  if (statsSheet) {
    statsSheet.deleteRow(1);
    statsSheet.insertRowBefore(1);
    statsSheet.getRange(1, 1, 1, statsHeaders.length).setValues([statsHeaders]);
    statsSheet.getRange(1, 1, 1, statsHeaders.length)
      .setFontWeight('bold')
      .setBackground('#1e3a5f')
      .setFontColor('white');
    results.push('âœ… DoctorStats: ØªÙ… ØªØ­Ø¯ÙŠØ« 15 Ø¹Ù…ÙˆØ¯');
  } else {
    results.push('âš ï¸ DoctorStats: Ø§Ù„ÙˆØ±Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
  }
  
  // ========== 3. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ==========
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨ØªØ±ØªÙŠØ¨ Ø®Ø§Ø·Ø¦ØŒ Ø§Ø­Ø°ÙÙ‡Ø§
  // ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„ØµÙØ±
  /*
  if (statsSheet && statsSheet.getLastRow() > 1) {
    statsSheet.deleteRows(2, statsSheet.getLastRow() - 1);
    results.push('ğŸ—‘ï¸ DoctorStats: ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©');
  }
  */
  
  const summary = results.join('\n');
  Logger.log('========== Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ø¯ÙŠØ« ==========');
  Logger.log(summary);
  Logger.log('===================================');
  
  return {
    success: true,
    message: summary,
    updatedSheets: results.length
  };
}

/**
 * Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† DoctorStats ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯
 * âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ ÙŠØ­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©!
 */
function resetDoctorStats() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const statsSheet = ss.getSheetByName('DoctorStats');
  
  if (!statsSheet) {
    return { success: false, error: 'ÙˆØ±Ù‚Ø© DoctorStats ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' };
  }
  
  const lastRow = statsSheet.getLastRow();
  if (lastRow > 1) {
    statsSheet.deleteRows(2, lastRow - 1);
  }
  
  Logger.log('âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª DoctorStats');
  return { success: true, message: 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡' };
}