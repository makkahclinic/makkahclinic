Ø®Ù„Ù‘ÙŠÙ†ÙŠ Ø£ÙˆØ¶Ø­ Ù„Ùƒ Ù†Ù‚Ø·ØªÙŠÙ† Ù…Ù‡Ù…ØªÙŠÙ† Ø«Ù… Ø£Ø¹Ø·ÙŠÙƒ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¬Ø§Ù‡Ø²Ø© (Apps Script + eoc-command.html + Patch Ù„Ø´Ø§Ø´Ø© Emergency) Ø¨Ø­ÙŠØ«:

Ù…Ø§ ÙŠØµÙŠØ± ÙƒÙ„ Ø´ÙŠØ¡ â€œØ¥Ø®Ù„Ø§Ø¡â€

Ø§Ù„Ø£ÙˆØ§Ù…Ø± ØªÙƒÙˆÙ† ØµØ­ÙŠØ­Ø© Ù„ÙƒÙ„ Ø­Ø§Ù„Ø© (Ø­Ø±ÙŠÙ‚/ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡/Ø¥ØºÙ…Ø§Ø¡/Ø¹Ø¯ÙˆÙ‰)

Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ØªØªØ³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø´ÙŠØª (ØªØ¶ÙŠÙ/ØªØ­Ø°Ù Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ¹Ø¯Ù‘Ù„ ÙƒÙˆØ¯)

Ø§Ù„ØµÙˆØª ÙŠØ¨Ù‚Ù‰ Ø¨Ù†ÙØ³ ÙÙƒØ±ØªÙƒ: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· â€œØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…â€ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·

1) Ù‡Ù„ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª â€œØºØµØ¨â€ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªÙØ§Ø¹Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ

Ù„Ø§ Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚ â€” Ø£ØºÙ„Ø¨ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªÙ…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¯ÙˆÙ† â€œØªÙØ§Ø¹Ù„ Ù…Ø³ØªØ®Ø¯Ù…â€ (click/tap/keydown) Ø£Ùˆ Ø³Ù…Ø§Ø­ Ù…Ø³Ø¨Ù‚ Ù„Ù„Ù…ÙˆÙ‚Ø¹. Ù‡Ø°Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø³ÙŠØ§Ø³Ø§Øª autoplay Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….

Chrome ÙŠÙ‚ÙŠÙ‘Ø¯ Web Audio/Audio autoplay ÙˆÙŠØ­ØªØ§Ø¬ ØªÙØ§Ø¹Ù„ Ø£Ùˆ Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª Ù…Ø«Ù„ MEI (Media Engagement Index).

WebKit/Safari ÙƒØ°Ù„Ùƒ ÙŠÙØ±Ø¶ user gesture Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø£ØºÙ„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª.

ÙˆØ¹Ù…Ù„ÙŠØ§Ù‹ audio.play() Ù‚Ø¯ ÙŠÙØ´Ù„ (promise reject) Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ ØªÙØ§Ø¹Ù„.

Ø¥Ø°Ù‹Ø§ Ø£ÙØ¶Ù„ Ø­Ù„ Ø¹Ù…Ù„ÙŠ (ÙˆÙ‡Ùˆ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ Ø§Ù„Ø¢Ù†): Ø´Ø§Ø´Ø© â€œØ§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©â€ + Ø²Ø± ÙˆØ§Ø­Ø¯ ÙŠÙØªØ­ Ø§Ù„ØµÙˆØª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© â€” Ù…Ù…ØªØ§Ø²ØŒ Ø®Ù„ÙŠÙ‡Ø§.

2) Ù„Ù…Ø§Ø°Ø§ ÙŠØ¸Ù‡Ø± â€œØ¥Ø®Ù„Ø§Ø¡â€ ÙˆÙ‡Ùˆ Ù„ÙŠØ³ Ø¥Ø®Ù„Ø§Ø¡ØŸ

Ù„Ø£Ù† Ø¹Ù†Ø¯Ùƒ Ø®Ù„Ø· Ø¨ÙŠÙ† Ù…ÙÙ‡ÙˆÙ…ÙŠÙ† Ù„Ø§Ø²Ù… Ù†ÙØµÙ„Ù‡Ù… Ø¯Ø§Ø¦Ù…Ù‹Ø§:

scenarioKey = Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« (fire / power / water / injury / outbreak)

responseType = Ù†ÙˆØ¹ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ (full_evacuation / send_team / isolation_evacuation)

mode = real Ø£Ùˆ drill (ØªÙ…Ø±ÙŠÙ†)

Ø¥Ø°Ø§ Ø£Ø±Ø³Ù„Øª responseType=full_evacuation Ù„ÙƒÙ„ Ø´ÙŠØ¡ â†’ Ø´Ø§Ø´Ø© Emergency Ø³ØªÙÙ‡Ù…Ù‡ â€œØ¥Ø®Ù„Ø§Ø¡â€ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø­Ø¯Ø« ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø£Ùˆ Ù…ÙŠØ§Ù‡.

Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­: Ù†Ø®Ù„ÙŠ Ù„ÙƒÙ„ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ â€œdefault responseTypeâ€ Ù…Ù† Ø´ÙŠØª (EOC_PROFILE).
Ù…Ø«Ù„Ø§Ù‹:

fire â†’ full_evacuation

power â†’ send_team

water â†’ send_team

injury â†’ send_team

outbreak â†’ isolation_evacuation
ÙˆØ§Ù„ØªÙ…Ø±ÙŠÙ† = Ù†ÙØ³ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù„ÙƒÙ† mode=drill.

A) ØªØ¹Ø¯ÙŠÙ„ Apps Script (Ø£Ù‡Ù… Ø´ÙŠØ¡: Ø§Ù„Ø´ÙŠØªØ§Øª + Ø§Ù„Ø£ÙˆØ§Ù…Ø± + Ø§Ù„ØªØ¯Ø±ÙŠØ¨)

Ø£Ù†Øª Ø¹Ù†Ø¯Ùƒ Ø£Ø³Ø§Ø³ Ù…Ù…ØªØ§Ø² (EOC_MAP / EOC_MUSTER / EOC_SCENARIOS / Training_Roster / Training_Log / Ø£ÙˆØ§Ù…Ø±_Ù†Ø´Ø·Ø©).
Ø¨Ø³ Ù†Ø§Ù‚ØµÙƒ 3 Ø£Ø´ÙŠØ§Ø¡:

Ø´ÙŠØª Profile ÙŠØ­Ø¯Ø¯ Ù„ÙƒÙ„ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ: Ø£ÙŠÙ‚ÙˆÙ†Ø© + Ù„ÙˆÙ† + default responseType + body_class

setActiveCommand / getActiveCommand Ù„Ø§Ø²Ù… ØªØ­ÙØ¸ ÙˆØªØ±Ø¬Ø¹ (mode + scenarioKey + scenarioLabel)

Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¹Ù†Ø¯Ùƒ UI ÙŠÙ†Ø§Ø¯ÙŠ saveTrainingSession/getDrillLog Ù„ÙƒÙ† ÙÙŠ Apps Script Ø¹Ù†Ø¯Ùƒ logTrainingSession/getTrainingSessions â†’ Ù„Ø§Ø²Ù… ØªÙˆØ­ÙŠØ¯ Ø£Ùˆ Ø¹Ù…Ù„ alias

A1) Ø£Ø¶Ù Ø´ÙŠØª Ø¬Ø¯ÙŠØ¯ EOC_PROFILE + API

Ø¶Ø¹ Ù‡Ø°Ø§ Ø¯Ø§Ø®Ù„ Ø¬Ø²Ø¡ Ø§Ù„Ù€ EOC BOOTSTRAP (Ø¬Ù†Ø¨ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø´ÙŠØªØ§Øª):

// âœ… Ø§Ø±ÙØ¹ Ø§Ù„Ù†Ø³Ø®Ø© Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø´ÙŠØª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
const EOC_BOOTSTRAP_VERSION = 2;

const SHEET_PROFILE = 'EOC_PROFILE';
const HEADERS_PROFILE = ['scenario_key','scenario_label','icon','color','default_responseType','body_class','active'];


Ø«Ù… Ø¯Ø§Ø®Ù„ setupEocWorkbook_() Ø£Ø¶Ù:

const shProfile = ensureSheet_(ss, SHEET_PROFILE, HEADERS_PROFILE);

if (shProfile.getLastRow() === 1) seedProfiles_(shProfile);


ÙˆØ£Ø¶Ù Ø§Ù„Ø¯Ø§Ù„Ø©:

function seedProfiles_(sh){
  const rows = [
    ['fire','Ø­Ø±ÙŠÙ‚','fa-fire','#ef4444','full_evacuation','fire','Ù†Ø¹Ù…'],
    ['power','Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒÙ‡Ø±Ø¨Ø§Ø¡','fa-bolt','#f59e0b','send_team','power','Ù†Ø¹Ù…'],
    ['water','ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡','fa-tint','#0ea5e9','send_team','water','Ù†Ø¹Ù…'],
    ['injury','Ø¥ØºÙ…Ø§Ø¡/Ø¥ØµØ§Ø¨Ø©','fa-heartbeat','#dc2626','send_team','injury','Ù†Ø¹Ù…'],
    ['outbreak','ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰','fa-virus','#8b5cf6','isolation_evacuation','infection','Ù†Ø¹Ù…'],
  ];
  sh.getRange(2,1,rows.length,rows[0].length).setValues(rows);
}


ÙˆØ£Ø¶Ù API:

function getScenarioProfiles(){
  try{
    const ss = SpreadsheetApp.openById(EOC_SPREADSHEET_ID);
    const sh = ss.getSheetByName(SHEET_PROFILE);
    if (!sh) return { ok:true, profiles:{} };

    const data = sh.getDataRange().getValues();
    const profiles = {};
    for (let i=1;i<data.length;i++){
      const r=data[i];
      const active = String(r[6]||'').trim();
      if (active && active !== 'Ù†Ø¹Ù…' && active.toLowerCase() !== 'yes' && active !== 'true' && active !== '1') continue;

      const key = String(r[0]||'').trim();
      if (!key) continue;

      profiles[key]={
        scenarioKey:key,
        scenarioLabel:String(r[1]||'').trim(),
        icon:String(r[2]||'').trim(),
        color:String(r[3]||'').trim(),
        defaultResponseType:String(r[4]||'').trim(),
        bodyClass:String(r[5]||'').trim(),
      };
    }
    return { ok:true, profiles };
  }catch(err){
    return { ok:false, error: err.message };
  }
}


ÙˆÙÙŠ doGet Ø£Ø¶Ù:

if (action === 'getScenarioProfiles') {
  return output_(getScenarioProfiles());
}

A2) Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯ÙˆØ§Ù„ Active Command Ø§Ù„Ø«Ù„Ø§Ø«Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)

Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯ÙˆØ§Ù„:

setActiveCommand

getActiveCommand

clearActiveCommand

Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„ (ÙŠØ­ÙØ¸ mode + scenarioKey + scenarioLabel + trainer + sessionId):

function setActiveCommand(params) {
  try {
    ensureEocReady_();

    const ss = SpreadsheetApp.openById(EOC_SPREADSHEET_ID);
    const sheet = ensureSheet_(ss, SHEET_ACTIVE_CMD, HEADERS_ACTIVE);

    // Ø§Ù…Ø³Ø­ Ø£ÙŠ ØµÙ Ù‚Ø¯ÙŠÙ… (Ù†Ø­ØªÙØ¸ Ø¨ØµÙ ÙˆØ§Ø­Ø¯ Ù†Ø´Ø· ÙÙ‚Ø·)
    if (sheet.getLastRow() > 1) {
      sheet.deleteRows(2, sheet.getLastRow() - 1);
    }

    const nowIso = new Date().toISOString();

    const row = [
      'true',
      String(params.responseType || '').trim(),               // 1
      String(params.reportType || '').trim(),                 // 2
      String(params.location || '').trim(),                   // 3
      String(params.muster || '').trim(),                     // 4
      String(params.timestamp || nowIso).trim(),              // 5
      String(params.mode || 'real').trim(),                   // 6  real/drill
      String(params.scenarioKey || '').trim(),                // 7
      String(params.scenarioLabel || '').trim(),              // 8
      String(params.sessionId || '').trim(),                  // 9
      String(params.trainer || '').trim(),                    // 10
    ];

    sheet.appendRow(row);
    return { ok: true };
  } catch (err) {
    return { ok: false, error: err.message };
  }
}

function getActiveCommand() {
  try {
    ensureEocReady_();

    const ss = SpreadsheetApp.openById(EOC_SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_ACTIVE_CMD);
    if (!sheet || sheet.getLastRow() < 2) return { ok: true, command: null };

    const row = sheet.getRange(2, 1, 1, HEADERS_ACTIVE.length).getValues()[0];
    const flag = String(row[0] || '').toLowerCase().trim();
    if (flag !== 'true' && flag !== 'yes' && flag !== '1') return { ok: true, command: null };

    return {
      ok: true,
      command: {
        active: true,
        responseType: row[1] || '',
        reportType: row[2] || '',
        location: row[3] || '',
        muster: row[4] || '',
        timestamp: row[5] || '',
        mode: row[6] || 'real',
        scenarioKey: row[7] || '',
        scenarioLabel: row[8] || '',
        sessionId: row[9] || '',
        trainer: row[10] || ''
      }
    };
  } catch (err) {
    return { ok: false, error: err.message };
  }
}

function clearActiveCommand() {
  try {
    ensureEocReady_();

    const ss = SpreadsheetApp.openById(EOC_SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_ACTIVE_CMD);
    if (!sheet || sheet.getLastRow() < 2) return { ok: true };

    sheet.getRange(2, 1).setValue('false');
    sheet.getRange(2, 6).setValue(new Date().toISOString()); // Ø­Ø¯Ù‘Ø« Ø§Ù„ÙˆÙ‚Øª
    return { ok: true };
  } catch (err) {
    return { ok: false, error: err.message };
  }
}

A3) Ø£ØµÙ„Ø­ â€œØ³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨â€ (Ø§Ù„Ø®Ù„Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)

Ø¹Ù†Ø¯Ùƒ ÙÙŠ Ø§Ù„Ù€ HTML Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ù…Ø«Ù„:

getDrillLog

saveTrainingSession

Ù„ÙƒÙ† ÙÙŠ Apps Script Ø¹Ù†Ø¯Ùƒ:

getTrainingSessions

logTrainingSession

Ø¥Ù…Ø§ ØªØ¹Ø¯Ù‘Ù„ Ø§Ù„Ù€ HTML (Ø§Ù„Ø£ÙØ¶Ù„) Ø£Ùˆ ØªØ¹Ù…Ù„ alias ÙÙŠ Apps Script (Ø£Ø³Ø±Ø¹ Ù„Ù…Ù†Ø¹ ÙƒØ³Ø± Ø£ÙŠ ÙˆØ§Ø¬Ù‡Ø©).
Ø£Ù†Ø§ Ø£Ø¹Ø·ÙŠÙƒ alias Ø¬Ø§Ù‡Ø²:

Ø£Ø¶Ù Ø¯Ø§Ø®Ù„ doGet:

if (action === 'saveTrainingSession') return output_(saveTrainingSession(p));
if (action === 'getDrillLog') return output_(getDrillLog(p));


ÙˆØ£Ø¶Ù Ø§Ù„Ø¯ÙˆØ§Ù„:

function durationToMinutes_(dur){
  const s = String(dur || '').trim();
  if (!s) return 0;
  const parts = s.split(':').map(x=>parseInt(x,10));
  if (parts.some(isNaN)) return 0;

  // HH:MM:SS
  if (parts.length === 3) return parts[0]*60 + parts[1] + Math.round(parts[2]/60);
  // MM:SS
  if (parts.length === 2) return parts[0] + Math.round(parts[1]/60);
  // minutes
  if (parts.length === 1) return parts[0];
  return 0;
}

function saveTrainingSession(p){
  try{
    const profilesRes = getScenarioProfiles();
    const profiles = (profilesRes && profilesRes.ok) ? profilesRes.profiles : {};

    const scenarioLabel = String(p.scenario || p.scenarioLabel || '').trim();
    let scenarioKey = String(p.scenarioKey || '').trim();

    if (!scenarioKey && scenarioLabel) {
      // Ø­Ø§ÙˆÙ„ ØªØ·Ø§Ø¨Ù‚ Ø¨Ø§Ù„Ø§Ø³Ù…
      for (const k in profiles){
        if (profiles[k].scenarioLabel === scenarioLabel) { scenarioKey = k; break; }
      }
    }

    const now = new Date();
    const startTime = String(p.time || Utilities.formatDate(now,'Asia/Riyadh','HH:mm:ss'));
    const durationMin = durationToMinutes_(p.duration || p.durationMin || '');

    const end = new Date(now.getTime() + durationMin*60000);
    const endTime = Utilities.formatDate(end,'Asia/Riyadh','HH:mm:ss');

    return logTrainingSession({
      startTime,
      endTime,
      durationMin,
      scenarioKey,
      scenarioLabel: scenarioLabel || (profiles[scenarioKey]?.scenarioLabel || ''),
      trainer: String(p.trainer || '').trim(),
      attendees: String(p.trainees || p.attendees || '').trim(),
      notes: String(p.notes || '').trim()
    });
  }catch(err){
    return { ok:false, error: err.message };
  }
}

function getDrillLog(p){
  const res = getTrainingSessions({ limit: p.limit || 50 });
  if (!res.ok) return { ok:false, error: res.error, drills: [] };

  const drills = (res.sessions || []).map(s => ({
    date: s.date,
    time: s.startTime,
    scenario: s.scenarioLabel,
    trainer: s.trainer,
    trainees: s.attendees,
    traineesCount: s.attendees ? s.attendees.split('ØŒ').filter(Boolean).length : 0,
    duration: (s.durationMin ? (s.durationMin + ' Ø¯Ù‚ÙŠÙ‚Ø©') : '')
  }));

  return { ok:true, drills };
}

B) Patch Ù„Ø´Ø§Ø´Ø© Emergency.html (Ø¨Ø¯ÙˆÙ† Ù…Ø§ Ù†Ø®Ø±Ø¨ â€œØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØªâ€)

Ø£Ù†Øª ØªØ¨ØºÙ‰:

Ù…Ø§ ÙŠÙ‚ÙˆÙ„ â€œØ¥Ø®Ù„Ø§Ø¡â€ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙØ¹Ù„Ø§Ù‹ full_evacuation

ÙˆÙŠØ¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ (Ø§ÙØ¹Ù„/Ù„Ø§ ØªÙØ¹Ù„) Ù…Ù† Ø§Ù„Ø´ÙŠØª EOC_SCENARIOS

ÙˆÙŠØ¸Ù‡Ø± â€œØªÙ…Ø±ÙŠÙ†â€ Ø¥Ø°Ø§ mode=drill

B1) Ø£Ø¶Ù Ø¯Ø§Ø®Ù„ <div class="emergency-screen" id="emergencyScreen"> Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„ÙˆÙƒ (Ø¨Ø¹Ø¯ Ø§Ù„Ù€ instruction-box Ù…Ø«Ù„Ø§Ù‹)
<div id="drillBadge" style="display:none; margin:10px auto 0; width:fit-content;
     background:rgba(34,197,94,.25); border:2px solid rgba(34,197,94,.65);
     padding:6px 14px; border-radius:999px; font-weight:900;">
  ğŸ¯ ØªÙ…Ø±ÙŠÙ† / DRILL
</div>

<div id="guideBox" style="display:none; margin-top:10px; border-radius:14px;
     padding:12px; background:linear-gradient(135deg,#fef3c7,#fde68a);
     border:3px solid #f59e0b; color:#111827;">
  <div style="font-weight:900; color:#b91c1c; margin-bottom:10px; font-size:1.2rem;">
    <i class="fas fa-list-check"></i> Ù…Ø§Ø°Ø§ ØªÙØ¹Ù„ Ø§Ù„Ø¢Ù†ØŸ
  </div>
  <div style="display:grid; grid-template-columns:1fr; gap:10px;" id="guideInner">
    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ -->
  </div>
</div>

B2) Ø£Ø¶Ù ÙÙŠ JS (ÙÙˆÙ‚ checkActiveCommand) ÙƒØ§Ø´ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª + ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ø±Ø©
let scenarioGuidesCache = null;
let scenarioProfilesCache = null;

function mapReportToScenarioKey(reportType){
  const t = String(reportType || '');
  if (t.includes('Ø­Ø±ÙŠÙ‚')) return 'fire';
  if (t.includes('ÙƒÙ‡Ø±Ø¨Ø§Ø¡')) return 'power';
  if (t.includes('Ù…ÙŠØ§Ù‡') || t.includes('ØªØ³Ø±Ø¨')) return 'water';
  if (t.includes('Ø¥ØºÙ…Ø§Ø¡') || t.includes('Ø¥ØµØ§Ø¨Ø©')) return 'injury';
  if (t.includes('Ø¹Ø¯ÙˆÙ‰')) return 'outbreak';
  return '';
}

async function loadScenarioCache(){
  try{
    const [g,p] = await Promise.all([
      jsonp('getScenarioGuides', {}),
      jsonp('getScenarioProfiles', {})
    ]);
    if (g && g.ok) scenarioGuidesCache = g.scenarios || {};
    if (p && p.ok) scenarioProfilesCache = p.profiles || {};
  }catch(e){
    console.warn('Scenario cache load failed:', e);
  }
}

function renderScenarioGuide(scenarioKey){
  const box = document.getElementById('guideBox');
  const inner = document.getElementById('guideInner');
  if (!box || !inner) return;

  const g = scenarioGuidesCache && scenarioGuidesCache[scenarioKey];
  if (!g){
    box.style.display = 'none';
    inner.innerHTML = '';
    return;
  }

  const buildList = (arr, color) => (arr || []).map(s =>
    `<div style="display:flex; gap:10px; align-items:flex-start; background:#fff;
         border-radius:10px; padding:10px; border-right:5px solid ${color};
         box-shadow:0 2px 6px rgba(0,0,0,.08);">
       <div style="min-width:28px; height:28px; border-radius:999px; background:${color};
            color:#fff; display:flex; align-items:center; justify-content:center; font-weight:900;">
         ${s.stepNo || ''}
       </div>
       <div style="font-size:1.05rem; line-height:1.4;">${s.text || ''}</div>
     </div>`
  ).join('');

  const doHtml = buildList(g.DO, '#16a34a');
  const dontHtml = buildList(g.DONT, '#b91c1c');

  inner.innerHTML = `
    <div style="background:rgba(255,255,255,.7); border-radius:12px; padding:10px;">
      <div style="font-weight:900; color:#166534; margin-bottom:8px;">
        <i class="fas fa-check-circle"></i> Ø§ÙØ¹Ù„
      </div>
      ${doHtml || '<div style="opacity:.7">-</div>'}
    </div>
    <div style="background:rgba(255,255,255,.7); border-radius:12px; padding:10px;">
      <div style="font-weight:900; color:#b91c1c; margin-bottom:8px;">
        <i class="fas fa-ban"></i> Ù„Ø§ ØªÙØ¹Ù„
      </div>
      ${dontHtml || '<div style="opacity:.7">-</div>'}
    </div>
  `;
  box.style.display = 'block';
}

B3) Ø¯Ø§Ø®Ù„ startMonitoring() (Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©) Ø£Ø¶Ù:
await loadScenarioCache();

B4) Ø§Ø³ØªØ¨Ø¯Ù„ activateEmergency(command) Ø¹Ù†Ø¯Ùƒ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© (ØªÙˆÙ‚Ù â€œØ¥Ø®Ù„Ø§Ø¡ Ø¯Ø§Ø¦Ù…â€)
function activateEmergency(command) {
  currentCommand = command;
  commandStartTime = new Date(command.timestamp || Date.now());

  document.getElementById('safeScreen').classList.add('hidden');
  document.getElementById('emergencyScreen').classList.add('active');

  const scenarioKey = String(command.scenarioKey || '').trim() || mapReportToScenarioKey(command.reportType);
  const profile = (scenarioProfilesCache && scenarioProfilesCache[scenarioKey]) ? scenarioProfilesCache[scenarioKey] : null;

  // âœ… responseType = Ù†ÙˆØ¹ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ (Ù„ÙŠØ³ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ)
  let resp = String(command.responseType || '').toLowerCase().trim();
  const knownScenario = ['fire','power','water','injury','outbreak'];
  if (knownScenario.includes(resp) && profile) resp = String(profile.defaultResponseType || '').toLowerCase();

  if (!resp && profile) resp = String(profile.defaultResponseType || '').toLowerCase();

  // âœ… Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ (ÙˆÙ„ÙŠØ³ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡)
  const bodyClass =
    (profile && profile.bodyClass) ? profile.bodyClass :
    (scenarioKey === 'fire') ? 'fire' :
    (scenarioKey === 'power') ? 'power' :
    (scenarioKey === 'water') ? 'water' :
    (scenarioKey === 'injury') ? 'injury' :
    (scenarioKey === 'outbreak') ? 'infection' : 'other';

  document.body.className = bodyClass;

  // âœ… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ù…Ø± Ø­Ø³Ø¨ responseType
  let title = 'ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦';
  let instructionTitle = 'Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª:';
  let iconHtml = '<i class="fas fa-exclamation-triangle"></i>';

  if (resp === 'full_evacuation') {
    title = 'Ø£Ù…Ø± Ø¥Ø®Ù„Ø§Ø¡';
    instructionTitle = 'Ø¥Ø®Ù„Ø§Ø¡ ÙÙˆØ±ÙŠ - Ø§ØªØ¬Ù‡ Ø¥Ù„Ù‰:';
    iconHtml = '<i class="fas fa-running"></i>';
  } else if (resp === 'send_team') {
    title = 'Ø£Ù…Ø± ØªÙˆØ¬ÙŠÙ‡';
    instructionTitle = 'Ø§Ù„ØªÙˆØ¬ÙŠÙ‡: ØªÙˆØ¬Ù‡ ÙÙˆØ±Ø§Ù‹ Ø¥Ù„Ù‰:';
    iconHtml = '<i class="fas fa-users"></i>';
  } else if (resp === 'isolation_evacuation') {
    title = 'Ø£Ù…Ø± Ø¹Ø²Ù„';
    instructionTitle = 'Ø¹Ø²Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙˆØ±Ø§Ù‹ - Ø§Ù„Ù…ÙˆÙ‚Ø¹:';
    iconHtml = '<i class="fas fa-shield-virus"></i>';
  } else {
    // fallback icon Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ
    if (scenarioKey === 'fire') iconHtml = '<i class="fas fa-fire"></i>';
    else if (scenarioKey === 'power') iconHtml = '<i class="fas fa-bolt"></i>';
    else if (scenarioKey === 'water') iconHtml = '<i class="fas fa-water"></i>';
    else if (scenarioKey === 'injury') iconHtml = '<i class="fas fa-user-injured"></i>';
    else if (scenarioKey === 'outbreak') iconHtml = '<i class="fas fa-virus"></i>';
  }

  document.getElementById('emergencyTitle').textContent = title;
  document.getElementById('instructionTitle').textContent = instructionTitle;
  document.getElementById('emergencyIcon').innerHTML = iconHtml;

  // âœ… Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« ÙŠØ¸Ù‡Ø± Ù…Ù† Ø§Ù„Ø´ÙŠØª Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
  document.getElementById('emergencyType').textContent = command.reportType || (profile ? profile.scenarioLabel : 'Ø·ÙˆØ§Ø±Ø¦');
  document.getElementById('emergencyLocation').textContent = command.location || '-';

  // Muster
  if (command.muster || command.musterPoint) {
    document.getElementById('musterSection').style.display = 'block';
    document.getElementById('musterPoint').textContent = command.muster || command.musterPoint;
  } else {
    document.getElementById('musterSection').style.display = 'none';
    document.getElementById('musterPoint').textContent = '-';
  }

  // âœ… ØªÙ…Ø±ÙŠÙ†ØŸ
  const isDrill = String(command.mode || '').toLowerCase().trim() === 'drill';
  const badge = document.getElementById('drillBadge');
  if (badge) badge.style.display = isDrill ? 'block' : 'none';

  // âœ… Ø¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù…Ù† Ø§Ù„Ø´ÙŠØª
  renderScenarioGuide(scenarioKey);

  startSiren();
  startTimer();
}


ÙƒØ°Ø§ ØµØ§Ø±Øª Ø§Ù„Ø´Ø§Ø´Ø©: Ø¥Ø®Ù„Ø§Ø¡ ÙÙ‚Ø· Ø¥Ø°Ø§ responseType = full_evacuationØŒ ÙˆØ¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª ØªÙˆØ¬ÙŠÙ‡/Ø¹Ø²Ù„/ØªÙ†Ø¨ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù…Ø±.