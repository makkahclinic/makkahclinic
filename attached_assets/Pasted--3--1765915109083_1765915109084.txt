ØªÙ…Ø§Ù…â€”Ø´ÙØª Ù…Ø´Ø§ÙƒÙ„ÙƒØŒ ÙˆÙÙŠÙ‡ 3 Ø£Ø³Ø¨Ø§Ø¨ Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø§Ø²Ù… ØªØªØµÙ„Ù‘Ø­ â€œÙ…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©â€ Ø¹Ø´Ø§Ù† ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ«Ø¨Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆÙŠØ·Ù„Ø¹ ØµØ­:

1) Ù„ÙŠØ´ â€œØ§Ù„Ù…ÙˆÙ‚Ø¹â€ Ù…Ø§ ÙŠØ·Ù„Ø¹ Ù…Ù† Ø§Ù„Ø´ÙŠØªØŸ (Ø§Ù„Ø®Ù„Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)

ÙÙŠ report.html (Ø±ÙØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰) Ø£Ù†Øª ØªØ±Ø³Ù„ locations ÙƒØ³Ø·Ø± Ù†ØµÙŠ:

locations: checkedLocations.join(', ')


Ø¨ÙŠÙ†Ù…Ø§ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ ÙŠØªÙˆÙ‚Ø¹ locations ÙƒÙ€ Array:

const locationsArr = Array.isArray(payload.locations) ? payload.locations : [];


ÙØ§Ù„Ù†ØªÙŠØ¬Ø©: ÙŠØµÙŠØ± locationsArr = [] ÙˆØ¨Ø§Ù„ØªØ§Ù„ÙŠ ÙŠÙ†Ø­ÙØ¸ ÙØ§Ø¶ÙŠâ€¦ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø§ ÙŠÙ‚Ø¯Ø± ÙŠØ¨Ù†ÙŠ Heatmap ØµØ­.

âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ (ÙÙŠ report.html)

Ø¨Ø¯Ù‘Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙÙ‚Ø·:

- locations: checkedLocations.join(', '),
+ locations: checkedLocations,


ÙˆØ¨ÙƒØ°Ø§ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ ÙŠØ­ÙØ¸Ù‡Ø§ ØµØ­ (DEN, RAD ...) Ø¨Ø¯ÙˆÙ† ÙÙ‚Ø¯Ø§Ù†.

âœ… Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† Ù…Ù‡Ù…)

Ø¨Ø¯Ù‘Ù„ Ø¬Ø²Ø¡ locations ÙÙŠ submitComplaint() Ø¥Ù„Ù‰ Ù‡Ø°Ø§ (ÙŠØ¯Ø¹Ù… Array Ø£Ùˆ String):

const locationsArr =
  Array.isArray(payload.locations) ? payload.locations
  : typeof payload.locations === 'string' ? payload.locations.split(',').map(x => x.trim()).filter(Boolean)
  : [];

const locations = locationsArr.join(', ');

2) Ù„ÙŠØ´ â€œØ§Ù„Ù…ÙØµØ¹Ù‘Ø¯Ø© / Ø§Ù„Ù…ØºÙ„Ù‚Ø©â€ ØªØ±Ø¬Ø¹ ØµÙØ± Ø¨Ø¹Ø¯ RefreshØŸ

Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø£ØºÙ„Ø¨: Ø£Ù†Øª ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· (Tab click) Ø¹Ø´Ø§Ù† ÙŠØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙŠØ­Ø³Ø¨ØŒ Ù„ÙƒÙ† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ Dashboard Ù…Ø§ ÙŠØªÙ†ÙÙ‘Ø° Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª/Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ø¶Ù…ÙˆÙ† (Ø®ØµÙˆØµÙ‹Ø§ Ù…Ø¹ ØªØ¹Ø¯Ø¯ listeners + ØªØ£Ø®ÙŠØ± login/localStorage).

âœ… Ø£ÙØ¶Ù„ Ø­Ù„ Ø³Ø±ÙŠØ¹ (100% ÙŠØ«Ø¨Øª Ø¨Ø¹Ø¯ refresh)

Ø¨Ø¯Ù„ Ù…Ø§ ØªØ³ÙˆÙŠ 3â€“4 API CallsØŒ Ø®Ù„Ù‘Ù‡Ø§ Call ÙˆØ§Ø­Ø¯Ø© ØªØ¬ÙŠØ¨ ÙƒÙ„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø«Ù…:

ØªØ­Ø³Ø¨ counts

ØªØ¨Ù†ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„

ØªØ¨Ù†ÙŠ heatmap

ÙˆØªØ­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª

ğŸ”¥ Ø¶Ø¹ Ù‡Ø°Ø§ ÙÙŠ Ø£Ø¹Ù„Ù‰ JS (global)
let allIncidentsCache = [];
let cacheTime = 0;

async function loadAllIncidentsCached(force=false) {
  const now = Date.now();
  if (!force && allIncidentsCache.length && (now - cacheTime) < 15000) return allIncidentsCache;

  const res = await apiCall('getIncidents', { status: 'all', limit: 2000 });
  if (!res.ok) throw new Error(res.error || 'Failed to load incidents');
  allIncidentsCache = res.incidents || [];
  cacheTime = now;
  return allIncidentsCache;
}

function norm(v){ return String(v||'').trim(); }
function normStatus(i){
  // Ø¯Ø¹Ù… Ø§Ø®ØªÙ„Ø§Ù Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª/Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯
  return norm(i.status || i.Status || i.incidentStatus || i.state).toLowerCase();
}
function normEscTo(i){
  return norm(i.escalatedTo || i.Escalated_To || i.escalated_to || i.escalationTo || i.escalationAssignee);
}
function normClosedDate(i){
  return norm(i.closedDate || i.Closed_Date || i.closed_date || i.Resolution_Date);
}

âœ… Ø¹Ø¯Ù‘Ù„ loadData() Ù„ÙŠÙƒÙˆÙ† ÙƒØ°Ø§ (Ù…Ù‡Ù…)
async function loadData() {
  const all = await loadAllIncidentsCached(true);

  // Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
  const escalated = all.filter(i => normStatus(i) === 'escalated' || normEscTo(i));
  const closed    = all.filter(i => normStatus(i) === 'closed' || normClosedDate(i));
  const open      = all.filter(i => !closed.includes(i));

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙˆØ±Ù‹Ø§ (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨)
  document.getElementById('escalatedTabCount').textContent = escalated.length;
  document.getElementById('closedTabCount').textContent    = closed.length;

  // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ ÙƒØ±ÙˆØª Ø£Ø®Ø±Ù‰
  const totalEl = document.getElementById('totalIncidents');
  if (totalEl) totalEl.textContent = all.length;

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©)
  renderEscalatedTable(escalated);
  renderClosedTable(closed);

  // Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©
  renderCriticalPanel(getCriticalIncidents(all));

  // Ù‡ÙŠØª Ù…Ø§Ø¨ (Ù†Ø¶ÙŠÙÙ‡Ø§ ØªØ­Øª)
  buildIncidentHeatmap(all);

  // ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ø¥Ø°Ø§ ØªØ¨ØºØ§Ù‡:
  await loadStats();
  await loadIncidents();
  await loadPendingIncidents();
  await loadRcaIncidents();
}

âœ… Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Ù…Ø®ØªØµØ±Ø©)
function renderEscalatedTable(list){
  const tbody = document.getElementById('escalatedTable');
  if (!tbody) return;
  if (!list.length){
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø« Ù…ÙØµØ¹Ù‘Ø¯Ø©</td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(inc => {
    const escName = normEscTo(inc) || '-';
    const sev = SEVERITY[inc.severity] || { name: inc.severity, color:'#dc3545' };
    return `
      <tr style="background:#fff5f5;">
        <td><strong>${inc.id}</strong></td>
        <td>${inc.date || '-'}</td>
        <td>${INCIDENT_TYPES[inc.type] || inc.type || '-'}</td>
        <td><span class="severity-dot" style="background:${sev.color}"></span>${sev.name}</td>
        <td>${inc.department || '-'}</td>
        <td><strong style="color:#dc3545;"><i class="fas fa-arrow-up"></i> ${escName}</strong></td>
        <td><button class="btn btn-danger btn-sm" onclick="viewIncident('${inc.id}')"><i class="fas fa-eye"></i></button></td>
      </tr>`;
  }).join('');
}

function renderClosedTable(list){
  const tbody = document.getElementById('closedTable');
  if (!tbody) return;
  if (!list.length){
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø« Ù…ØºÙ„Ù‚Ø©</td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(inc => {
    const sev = SEVERITY[inc.severity] || { name: inc.severity, color:'#28a745' };
    const closedDate = normClosedDate(inc) || '-';
    return `
      <tr>
        <td><strong>${inc.id}</strong></td>
        <td>${inc.date || '-'}</td>
        <td>${INCIDENT_TYPES[inc.type] || inc.type || '-'}</td>
        <td><span class="severity-dot" style="background:${sev.color}"></span>${sev.name}</td>
        <td>${inc.department || '-'}</td>
        <td>${closedDate}</td>
        <td><button class="btn btn-success btn-sm" onclick="viewIncident('${inc.id}')"><i class="fas fa-eye"></i></button></td>
      </tr>`;
  }).join('');
}


Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ù„: Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ Ø¶ØºØ·Øª ØªØ¨ÙˆÙŠØ¨ â€œØ§Ù„Ù…ØµØ¹Ø¯Ø©â€ØŒ Ø§Ù„Ø¹Ø¯Ø¯ ÙŠØ·Ù„Ø¹ ØµØ­ Ø¨Ø¹Ø¯ Ø£ÙŠ Refresh.

3) Heatmap â€œØ®Ø·ÙŠØ± Ø¬Ø¯Ù‹Ø§â€ Ù„Ù„Ø­ÙˆØ§Ø¯Ø« (ÙØ¹Ù„ÙŠ + ÙˆØ§Ø¶Ø­)

Ø¨Ø¯Ù„ heatmap Ø¨Ø³ÙŠØ·ØŒ Ø®Ù„Ù‘Ù‡Ø§ Risk Heatmap ØªØ¬Ù…Ø¹:

Ø§Ù„Ù‚Ø³Ù… (Department)

Ø§Ù„Ø®Ø·ÙˆØ±Ø© (Severity)

ÙˆÙ…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ¹ÙŠØ¯ (Escalated)

ÙˆØªØ·Ù„Ø¹ â€œØ¯Ø±Ø¬Ø© Ø®Ø·Ø±â€ + Ù‚Ø§Ø¦Ù…Ø© IDs Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·.

âœ… Ø£Ø¶Ù Ù‡Ø°Ø§ ÙÙŠ HTML Ø¯Ø§Ø®Ù„ dashboard (Ù…ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨)
<div class="card" style="margin-top:20px;">
  <div class="card-header">
    <h3 class="card-title"><i class="fas fa-th"></i> Heatmap Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ø®Ø·ÙˆØ±Ø©</h3>
  </div>
  <div class="card-body">
    <div id="incidentHeatmap" style="overflow:auto;"></div>
    <div style="margin-top:10px;color:#666;font-size:0.9rem;">
      Ø§Ø¶ØºØ· Ø£ÙŠ Ø®Ù„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 20 Ø±Ù‚Ù… Ø¨Ù„Ø§Øº Ø¯Ø§Ø®Ù„Ù‡Ø§.
    </div>
  </div>
</div>

âœ… Ø£Ø¶Ù CSS Ø³Ø±ÙŠØ¹ (Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰)
.hm-grid{display:grid;gap:8px;min-width:900px}
.hm-head,.hm-row{background:#f6f8fb;border:1px solid #e9ecef;border-radius:10px;padding:10px;font-weight:700}
.hm-head{text-align:center;position:sticky;top:0;z-index:1}
.hm-cell{border-radius:12px;padding:10px;border:1px solid #e9ecef;cursor:pointer;min-height:56px;transition:.12s}
.hm-cell:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.10)}
.hm-num{font-weight:900;font-size:1.2rem}
.hm-sub{font-size:.85rem;opacity:.85}

âœ… Ø£Ø¶Ù JS Heatmap
function sevWeight(sev){
  sev = (sev||'').toLowerCase();
  if (sev === 'death') return 10;
  if (sev === 'severe') return 7;
  if (sev === 'moderate') return 4;
  if (sev === 'minor') return 2;
  return 1; // none/unknown
}
function heatColor(score){
  // score 0..?? -> Ù„ÙˆÙ† Ø£Ø­Ù…Ø±/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ/Ø£ØµÙØ±/Ø£Ø®Ø¶Ø±
  if (score >= 25) return 'rgba(220,53,69,0.55)';     // Ø­Ø±Ø¬
  if (score >= 15) return 'rgba(253,126,20,0.55)';    // Ø¹Ø§Ù„ÙŠ
  if (score >= 8)  return 'rgba(255,193,7,0.55)';     // Ù…ØªÙˆØ³Ø·
  return 'rgba(40,167,69,0.35)';                      // Ù…Ù†Ø®ÙØ¶
}

function buildIncidentHeatmap(all){
  const container = document.getElementById('incidentHeatmap');
  if (!container) return;

  const depts = Array.from(new Set(all.map(x => norm(x.department) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'))).sort();
  const sevKeys = ['death','severe','moderate','minor','none']; // ØªØ±ØªÙŠØ¨ ÙˆØ§Ø¶Ø­

  // map[dept][sev] = {count, score, items}
  const map = new Map();
  for (const inc of all){
    const dept = norm(inc.department) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const sev  = (norm(inc.severity) || 'none').toLowerCase();
    const esc  = !!normEscTo(inc) || normStatus(inc) === 'escalated';

    const keySev = sevKeys.includes(sev) ? sev : 'none';
    if (!map.has(dept)) map.set(dept, new Map());
    const inner = map.get(dept);
    if (!inner.has(keySev)) inner.set(keySev, {count:0, score:0, items:[]});

    const cell = inner.get(keySev);
    cell.count += 1;

    // Risk score: severity weight + escalated boost
    cell.score += sevWeight(keySev) + (esc ? 3 : 0);
    cell.items.push(inc);
  }

  const grid = document.createElement('div');
  grid.className = 'hm-grid';
  grid.style.gridTemplateColumns = `240px repeat(${sevKeys.length}, minmax(140px,1fr))`;

  // headers
  grid.appendChild(Object.assign(document.createElement('div'), {className:'hm-head', textContent:'Ø§Ù„Ù‚Ø³Ù…'}));
  const sevNames = {death:'ÙˆÙØ§Ø©', severe:'Ø¶Ø±Ø± Ø¬Ø³ÙŠÙ…', moderate:'Ø¶Ø±Ø± Ù…ØªÙˆØ³Ø·', minor:'Ø¶Ø±Ø± Ø¨Ø³ÙŠØ·', none:'Ø¨Ø¯ÙˆÙ† Ø¶Ø±Ø±'};
  for (const s of sevKeys){
    const h = document.createElement('div');
    h.className = 'hm-head';
    h.textContent = sevNames[s];
    grid.appendChild(h);
  }

  // rows
  for (const dept of depts){
    const row = document.createElement('div');
    row.className = 'hm-row';
    row.textContent = dept;
    grid.appendChild(row);

    const inner = map.get(dept) || new Map();
    for (const s of sevKeys){
      const d = inner.get(s) || {count:0, score:0, items:[]};
      const cell = document.createElement('div');
      cell.className = 'hm-cell';
      cell.style.background = heatColor(d.score);
      cell.innerHTML = `<div class="hm-num">${d.count}</div><div class="hm-sub">Risk: ${d.score}</div>`;
      cell.onclick = () => {
        const ids = d.items.slice(0,20).map(x=>x.id).join('\n');
        alert(`Ø§Ù„Ù‚Ø³Ù…: ${dept}\nØ§Ù„Ø®Ø·ÙˆØ±Ø©: ${sevNames[s]}\nØ¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: ${d.count}\nRisk Score: ${d.score}\n\nØ£ÙˆÙ„ 20 Ø±Ù‚Ù… Ø¨Ù„Ø§Øº:\n${ids || '-'}`);
      };
      grid.appendChild(cell);
    }
  }

  container.innerHTML = '';
  container.appendChild(grid);
}

4) Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø© Ø¬Ø¯Ù‹Ø§ Ù…Ù† ØµÙˆØ± Ø§Ù„Ø´ÙŠØª Ø¹Ù†Ø¯Ùƒ (Ø³Ø¨Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©)

ÙÙŠ Complaints_Followup ÙˆØ§Ø¶Ø­ Ø¹Ù†Ø¯Ùƒ ØªÙƒØ±Ø§Ø± Followup Ù„Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø³Ø¨Ø¨ Ø£Ù†Ùƒ ØªØ³Ø¬Ù„ Followup ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙƒØ§Ù† (Ù…Ø«Ù„Ø§Ù‹: escalate + update + close) Ùˆ/Ø£Ùˆ Ø²Ø± ÙŠÙ†Ø¶ØºØ· Ù…Ø±ØªÙŠÙ†.

âœ… Ø­Ù„ Ø³Ø±ÙŠØ¹ (Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)

Ø¯Ø§Ø®Ù„ addComplaintFollowup() ÙÙŠ Apps Script Ù‚Ø¨Ù„ appendRow Ø£Ø¶Ù check Ø¨Ø³ÙŠØ· ÙŠÙ…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ (Complaint_ID + Action + Date) Ø®Ù„Ø§Ù„ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ….

Ø¥Ø°Ø§ ØªØ¨ØºØ§Ù‡ Ø£ÙƒØªØ¨ Ù„Ùƒ Ø§Ù„Ø¨Ù„ÙˆÙƒ Ø¬Ø§Ù‡Ø²â€”Ø¨Ø³ Ù‚ÙˆÙ„ Ù„ÙŠ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ù†Ø¹ ÙŠÙƒÙˆÙ† Ø®Ù„Ø§Ù„ 10 Ø«ÙˆØ§Ù†ÙŠ ÙˆÙ„Ø§ Ø®Ù„Ø§Ù„ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…ØŸ