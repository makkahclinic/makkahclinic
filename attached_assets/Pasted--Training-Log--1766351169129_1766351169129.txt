ุชูุงู โ ุงููุดููุฉ ูู ูู ุงูุดูุช. ุงูุฏููู: ุนูุฏู ุจูุงูุงุช ููุฌูุฏุฉ ูุนููุง ุฏุงุฎู Training_Log (ูุงุถุญ ูู ุตูุฑุฉ ุงูุดูุช)ุ ูุงูู WebApp ูุฑุฌูุน sessions (ูุงุถุญ ูู ุตูุญุฉ ุงูู JSON). ุงููุดููุฉ ุตุงุฑุช ูู ุงูููุชุฑุฉ/ุชูุณูู ุงูุชุงุฑูุฎ + ุงุฎุชูุงู ุงุณู ุงูุญูู ุจูู ุงููุงุฌูุฉ ูุงูู API (ูุฃุญูุงููุง URL ุบูุท ุฃู ูุณุฎุฉ ูุฏููุฉ ุบูุฑ ูููุดูุฑุฉ).
ุฎููููู ุฃุนุทูู ุงูุญู โุงูุณุญ/ุญุทโ ุจุดูู ุนููู.

1) ุณุจุจ ุนุฏู ุธููุฑ ุณุฌู ุงูุชุฏุฑูุจ (ุงูุฌุฐุฑ ุงูุญูููู)
ุงูุณุจุจ ุฑูู (A): ุชุงุฑูุฎ ุงูุฌูุณุงุช ูุฑุฌุน ูุณูุณูุฉ ุทูููุฉ ูุซู:
Sun Dec 21 2025 03:00:00 GMT-0500 ...
ูุฃูุช ูู ุงููุงุฌูุฉ ุชูุงุฑููุง ูุน ูุฏุฎูุงุช type="date" ุงูุชู ุชุนุทู:
2025-12-08 ู 2025-12-21
ูุชุตูุฑ ุงูููุงุฑูุฉ ุงููุตูุฉ ุบูุทุ ููุชู ุงุณุชุจุนุงุฏ ูู ุงูุณุฌูุงุช (ูุชุธูุฑ โูุง ุชูุฌุฏ ุฌูุณุงุชโ).

ูุฐุง ูุญุตู ูุซูุฑูุง ูุฃู Google Sheets ูุฑุฌูุน ุงูุชุงุฑูุฎ ูู Date objectุ ูุฅุฐุง ุณููุช String(date) ูุนุทู ุงููุต ุงูุทููู. Google for Developers+1

ุงูุณุจุจ ุฑูู (B): ุงููุงุฌูุฉ ุฃุญูุงููุง ุชุชููุน drills ุจูููุง ุงูู API ูุฑุฌูุน sessions ููุท (ุฃูุช ุนุงูุฌุช ุฌุฒุฆููุง ุจู alias getDrillLog โ ููุชุงุฒ).
ุงูุณุจุจ ุฑูู (C) (ุฎุทูุฑ ุนูุฏู ูู emergency.html/ุดุงุดุฉ ุงูุนุฑุถ): ุนูุฏู ุณุทุฑ ุบูุท:
const WEB_APP_URL = 'const WEB_APP_URL = 'https://script.google.com/macros/s/...../exec';

ูุฐุง ููุณุฑ ูู JSONP ูุฃู ุงููุชุบูุฑ ุตุงุฑ ูุต ุบูุฑ ุตุงูุญ. (ูุฐุง ูุญุฏู ูููู ูููู ุฃู ุชุญููู).

2) ุงูุญู ุงูุณุฑูุน ุงููุคูุฏ (Front-end) โ ุจุฏูู ูุง ุชุนุชูุฏ ุนูู ููุชุฑุฉ ุงูู Backend
โ ูู ุตูุญุฉ eoc-command.html (ุฃู emergency-report.html ุฅุฐุง ูู ููุณ ุงูููุฏ)
ุงุจุญุซ ุนู ุงูุฏุงูุฉ:
async function fetchTrainingSessions(limit=120, startDate='', endDate=''){
  const res = await jsonp('getTrainingSessions', { limit:String(limit), startDate, endDate });
  ...
}

โ๏ธ ุงูุณุญูุง ุจุงููุงูู ูุงุณุชุจุฏููุง ุจูุฐู (ููู: ุจุฏูู startDate/endDate ููุจุงููุฏ):
function toYMD(value){
  if (!value) return '';
  // already YYYY-MM-DD
  const s = String(value).trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // try parse any other date string / Date
  const d = new Date(value);
  if (!isNaN(d.getTime())){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  return s;
}

async function fetchTrainingSessions(limit=250){
  const res = await jsonp('getTrainingSessions', { limit:String(limit) });
  if (!res || !res.ok) throw new Error(res?.error || 'getTrainingSessions failed');

  const sessions = Array.isArray(res.sessions) ? res.sessions : [];
  // normalize for filtering + UI
  return sessions.map(s => ({
    ...s,
    _dateYMD: toYMD(s.date),
  }));
}

ุซู ุนุฏูู ููุชุฑ ุงูุชุฏุฑูุจ ุฏุงุฎู:
applyTrainingFilter() (ุฃู ุฃู ููุชุฑ ุนูุฏู ููุชุฏุฑูุจ)
โ๏ธ ุงูุณุญ ุดุฑุท ุงูููุงุฑูุฉ ุงููุฏูู ูุซู:
const d = String(s.date||'');
if (from && d < from) return false;
if (to && d > to) return false;

โ ูุงุณุชุจุฏูู ุจูุฐุง:
const d = s._dateYMD || toYMD(s.date);
if (from && d < from) return false;
if (to && d > to) return false;
return true;

ูุฃูุถูุง ูู renderTrainingTable(list) ุจุฏูู ุนุฑุถ ุงูุชุงุฑูุฎ ูู:
<td>${escapeHtml(s.date||'')}</td>

ุฅูู:
<td>${escapeHtml(s._dateYMD || toYMD(s.date) || '')}</td>

โ ุจูุฐุง ุงูุดูู ุงูุณุฌู ูุธูุฑ ููุฑูุง ุญุชู ูู ุงูู API ูุฑุฌูุน ุชุงุฑูุฎ ุจุตูุบุฉ โSun Dec โฆโ.

3) ุงูุญู ุงูุตุญูุญ (Back-end) โ ูู ุชุจุบู ุงูููุชุฑุฉ ุชุชู ูู Apps Script
ุฃูุช ุจุงููุนู ูุชุจุช ูุณุฎุฉ ุฌุฏูุฏุฉ ูู getTrainingSessions ูู ุขุฎุฑ ุงูููุฏ (ุชุญููู Date โ yyyy-MM-dd).
ุจุณ ุงูุชุจู: ุฅุฐุง ูู ุชุนูู Deploy ุฌุฏูุฏ ูู /exec ูุงุฒุงู ูุดุบูู ุงููุณุฎุฉ ุงููุฏููุฉ (ููุฐุง ุดุงุฆุน ุฌุฏูุง).
Google Apps Script Web App ูุงุฒู โManage deployments โ Edit โ New version โ Deployโ ุนุดุงู ูุชุญุฏูุซ /exec. Google for Developers

4) ุฅุตูุงุญ โุงููุถุน ุทุจูุนูโ ููุตูุฑ ุฃุญูุฑ ูุงุจุถ + ูุงุจู ููููุฑ ูุฅูุบุงุก ุงูุทูุงุฑุฆ (ุชูุญูุฏ ุงูุชุญูู)
(A) ุชุนุฏูู HTML ูู ุงูููุฏุฑ
ุจุฏูู:
<div class="status-badge" id="systemStatus">
  <i class="fas fa-check-circle"></i><span>ุงููุถุน ุทุจูุนู</span>
</div>

ุฅูู:
<button class="status-badge" id="systemStatus" type="button" onclick="onStatusBadgeClick()">
  <i class="fas fa-check-circle"></i><span>ุงููุถุน ุทุจูุนู</span>
</button>

(B) ุชุนุฏูู CSS (ุนุดุงู ุฒุฑ ูุง ูุทูุน ุดููู ุบุฑูุจ)
ุฃุถู ุชุญุช .status-badge:
.status-badge{
  cursor:pointer;
  border:none;
}
.status-badge:active{ transform: scale(.98); }

(C) ุงูุณุญ ุฒุฑ ุงูุฅูุบุงุก ุงูุฒุงุฆุฏ ุฃู ูุญูุฏู
ุนูุฏู ุฒุฑ cancelEmergencyBtn โ ุฅุฐุง ุชุจุบู โููุงู ูุงุญุฏ ููุทโ ููุฅูุบุงุก:


ุฅููุง ุชุญุฐูู ูู ุงูู HTML ุจุงููุงูู


ุฃู ุชุฎููู ููู ูุฎุฏู ููุณ ุงูุฏุงูุฉ onStatusBadgeClick().


(D) ุฃุถู ุงูุฏุงูุฉ ูุฐู ูู JS (ุจุฏู clearActiveCommand)
async function onStatusBadgeClick(){
  try{
    const ac = await jsonp('getActiveCommand', {});
    const cmd = ac && ac.ok ? ac.command : null;

    if (!cmd || !cmd.active){
      toast('ูุง ุชูุฌุฏ ุญุงูุฉ ุทูุงุฑุฆ ูุดุทุฉ', 'warn');
      return;
    }

    const closedBy = prompt('ุงุณู ุงูุดุฎุต ุงูุฐู ุณููููู ุงูุญุงูุฉ:');
    if (!closedBy) return;

    const closeReason = prompt('ุณุจุจ ุงูุฅููุงุก (ุงุฎุชูุงุฑู):') || '';

    // โ ุฅุบูุงู ุฑุณูู ูุน ุชุณุฌูู
    const res = await jsonp('closeActiveCommand', { closedBy, closeReason });
    if (!res || !res.ok) throw new Error(res?.error || 'closeActiveCommand failed');

    setStatusAlert(false);
    toast('ุชู ุฅููุงุก ุงูุญุงูุฉ ูุชุณุฌูู ูู ุฃุบูููุง', 'success');
    await refreshLists();
    await syncActiveCommandUI();
  } catch(e){
    console.error(e);
    toast('ุชุนุฐุฑ ุฅููุงุก ุงูุญุงูุฉ: ' + (e.message || ''), 'error');
  }
}


ุงุณุชุฎุฏุงู closeActiveCommand + LockService ูู ุงูุฃุณูู ูุชุฌูุจ ุงูุชุนุงุฑุถ ูุชุณุฌูู ุงูุฅุบูุงู ุฑุณูููุง. Google for Developers+1


5) ููุน โุงูุฑูุฑุด ูููู ุงูุทูุงุฑุฆโ (ุชุซุจูุช ุงูุญุงูุฉ ุจุนุฏ ุงูุชุญุฏูุซ)
ุงูููุฑูุถ ุงูุฑูุฑุด ูุง ููุณุญ ุงูุฃูุฑ ูู ุงูุดุงุดุงุช ูุฃู ุงูุฃูุฑ ูุญููุธ ูู ุงูุดูุช.
ููู ุงูุฐู ูุณุจุจ ุฅุญุณุงุณ โุงุฎุชูุชโ ูู ุฃู ุงููุงุฌูุฉ ุชุฑุฌุน โุทุจูุนูโ ูุคูุชูุง ุจุนุฏ ุงูุฑูุฑุด.
โ ุงูุญู: ุนูุฏ ุงูุชุญููู ุงูุฑุฃ ุงูุฃูุฑ ุงููุดุท ูุงุถุจุท UI ููุฑูุง.
ุฃุถู:
async function syncActiveCommandUI(){
  try{
    const ac = await jsonp('getActiveCommand', {});
    const cmd = (ac && ac.ok) ? ac.command : null;

    if (cmd && cmd.active){
      const label = (String(cmd.mode||'').toLowerCase()==='training') ? '๐ฏ ุชูุฑูู ุฌุงุฑู' : 'ุญุงูุฉ ุทูุงุฑุฆ!';
      setStatusAlert(true, label);
    } else {
      setStatusAlert(false);
    }
  } catch(e) {
    console.warn('syncActiveCommandUI failed', e);
  }
}

ุซู ุฏุงุฎู init() ุจุนุฏ loadCoreData() ูุจุงุดุฑุฉ:
await syncActiveCommandUI();
setInterval(syncActiveCommandUI, 5000);


6) ุฅุตูุงุญ ุฎุทุฃ WEB_APP_URL ูู ุดุงุดุฉ ุงูุนุฑุถ (emergency.html)
ูู ููุฏู ุงูุญุงูู ุนูุฏู ุณุทุฑ ููุณูุฑ. โ๏ธ ุงูุณุญู ุจุงููุงูู:
const WEB_APP_URL = 'const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzNH6oKKX09plvwfS4g-fTp2H91ZO7DWLTS6kKjpvbqPQibTf0nAr8-0xJvGYie1GPL2A/exec';

โ ูุงูุชุจ ุจุฏููุง:
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzNH6oKKX09plvwfS4g-fTp2H91ZO7DWLTS6kKjpvbqPQibTf0nAr8-0xJvGYie1GPL2A/exec';


ููุงุญุธุฉ ูููุฉ ุนู ุงูุตูุช (ูุง ูููู โุบุตุจโ ุจุฏูู ุชูุงุนู)
ุญุชู ูู ููุฏู ุตุญูุญุ ุงููุชุตูุญ ูุฏ ูููุน ุชุดุบูู ุงูุตูุช ุชููุงุฆููุง ุฅูุง ุจุนุฏ ุชูุงุนู ุงููุณุชุฎุฏู (Click/Touch) โ ููุฐุง ุณููู ููุงุณู ูู Chrome/ูุชุตูุญุงุช ุฃุฎุฑู. Chrome for Developers+1
ูุงูุญู ุงููู ุนูุฏู (Start button + unlockAudio) ูู ุงูุตุญูุญ.

ุฎูุงุตุฉ ุงูุชูููุฐ (ูุฎุชุตุฑ ุฌุฏูุง)


Front-end: ุทุจูู toYMD() + ูุง ุชุฑุณู startDate/endDate ููุจุงููุฏ + ููุชุฑุฉ ูุญููุฉ โ ุงูุณุฌู ูุทูุน ููุฑูุง.


Back-end: ูู ุชุจุบู ููุชุฑุฉ ูู ุงูุดูุช: ูุงุฒู getTrainingSessions ูุญููู ุงูุชุงุฑูุฎ ูู yyyy-MM-dd + Deploy ุฌุฏูุฏ. Google for Developers


UI: ุฎููู systemStatus ุฒุฑ clickable ูููู ุงูุญุงูุฉ ุนุจุฑ closeActiveCommand (ุงุณู + ุณุจุจ + ุชุณุฌูู).


Fix WEB_APP_URL ูู ุดุงุดุฉ ุงูุนุฑุถ ูุฃูู ููุณูุฑ.


ุฅุฐุง ุชุจุบูุ ุงูุณุฎ ูู ุฌุฒุก JavaScript ุงูุฎุงุต ุจุณุฌู ุงูุชุฏุฑูุจ ูู ุตูุญุชู (ุงููู ููู loadTrainingLog ู applyTrainingFilter) ูุฃูุง ุฃุนุทูู patch ุฌุงูุฒ 100% ูุทุงุจู ุญุฑูููุง ูููุณ ุฃุณูุงุก ุงูุฏูุงู ุนูุฏู ุจุฏูู ูุง ุชุชุนุจ.
