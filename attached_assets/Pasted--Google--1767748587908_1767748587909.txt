/**
 * Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø®Ø¯Ù…Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠ
 * Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±
 * 
 * Google Sheet ID: 1rTGa4WOw1q0IQE7KCS8TtRJ58J0guTbfgcP30cE-EWk
 * Drive Folder ID: 18NsJAyzWXEuopa-ZfSyYXRWSFxENV9g4
 * 
 * Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Google Sheet:
 * 1. InsurancePermissions - ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
 * 2. InsuranceUsageLog - Ø³Ø¬Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø©
 * 3. DoctorStats - Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©
 */

const SHEET_ID = '1rTGa4WOw1q0IQE7KCS8TtRJ58J0guTbfgcP30cE-EWk';
const DRIVE_FOLDER_ID = '18NsJAyzWXEuopa-ZfSyYXRWSFxENV9g4';

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø§Ù„ÙƒÙŠÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù… Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
const OWNER_EMAILS = [
  'dr.mansour2012@hotmail.com',
  'owner@m2020m.org',
  'husseinbabsail@gmail.com'
];

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  try {
    let params = {};
    
    if (e.postData && e.postData.contents) {
      params = JSON.parse(e.postData.contents);
    } else if (e.parameter) {
      params = e.parameter;
    }
    
    const action = params.action || e.parameter.action;
    let result;
    
    switch(action) {
      case 'checkPermission':
        result = checkInsurancePermission(params.email);
        break;
      case 'getPermissions':
      case 'getAuthorizedUsers':
        result = getAllInsurancePermissions();
        break;
      case 'addPermission':
      case 'addAuthorizedUser':
        result = addInsurancePermission(params.email, params.name, params.department || params.dept);
        break;
      case 'removePermission':
      case 'removeAuthorizedUser':
        result = removeInsurancePermission(params.email);
        break;
      case 'logUsage':
        result = logInsuranceUsage(params);
        break;
      case 'getUsageLog':
        result = getUsageLog(params.email);
        break;
      case 'getDoctorStats':
        result = getDoctorStats();
        break;
      case 'updateDoctorRating':
        result = updateDoctorRating(params.doctorName, params.insuranceRating, params.serviceRating);
        break;
      case 'saveReport':
        result = saveReportToDrive(params);
        break;
      case 'getDashboardStats':
        result = getDashboardStats(params.email);
        break;
      case 'getDoctorsList':
        result = getDoctorsList();
        break;
      case 'logUsageAndSavePDF':
        result = logUsageAndSavePDF(params);
        break;
      case 'logUsageAndSaveHTML':
        result = logUsageAndSaveHTML(params);
        break;
      default:
        result = { success: false, error: 'Unknown action: ' + action };
    }
    
    output.setContent(JSON.stringify(result));
    
  } catch(error) {
    output.setContent(JSON.stringify({ 
      success: false, 
      error: error.toString() 
    }));
  }
  
  return output;
}

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‡Ùˆ Ù…Ø§Ù„Ùƒ
 */
function isOwnerEmail(email) {
  if (!email) return false;
  return OWNER_EMAILS.map(e => e.toLowerCase()).includes(email.toLowerCase());
}

/**
 * Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
 */
function setupSheets() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  
  // ÙˆØ±Ù‚Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  let permSheet = ss.getSheetByName('InsurancePermissions');
  if (!permSheet) {
    permSheet = ss.insertSheet('InsurancePermissions');
    permSheet.appendRow(['email', 'name', 'department', 'addedDate', 'addedBy', 'active']);
    permSheet.getRange(1, 1, 1, 6).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
  }
  
  // ÙˆØ±Ù‚Ø© Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
  let logSheet = ss.getSheetByName('InsuranceUsageLog');
  if (!logSheet) {
    logSheet = ss.insertSheet('InsuranceUsageLog');
    logSheet.appendRow([
      'timestamp', 'userEmail', 'userName', 'doctorName', 'caseType',
      'filesCount', 'insuranceRating', 'serviceRating', 'overallRating',
      'reportLink', 'notes'
    ]);
    logSheet.getRange(1, 1, 1, 11).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
  }
  
  // ÙˆØ±Ù‚Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
  let statsSheet = ss.getSheetByName('DoctorStats');
  if (!statsSheet) {
    statsSheet = ss.insertSheet('DoctorStats');
    statsSheet.appendRow([
      'doctorName', 'totalCases', 'avgInsuranceRating', 'avgServiceRating',
      'avgOverallRating', 'lastCaseDate', 'folderLink', 'status'
    ]);
    statsSheet.getRange(1, 1, 1, 8).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
  }
  
  return { success: true, message: 'ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¨Ù†Ø¬Ø§Ø­' };
}

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†
 */
function checkInsurancePermission(email) {
  if (!email) {
    return { success: false, hasPermission: false, error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨' };
  }
  
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName('InsurancePermissions');
  
  if (!sheet) {
    setupSheets();
    sheet = ss.getSheetByName('InsurancePermissions');
  }
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString().toLowerCase() === email.toLowerCase() && data[i][5] === true) {
      return { 
        success: true, 
        hasPermission: true,
        user: {
          email: data[i][0],
          name: data[i][1],
          department: data[i][2]
        }
      };
    }
  }
  
  return { success: true, hasPermission: false };
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ù„Ù„Ù…Ø§Ù„Ùƒ)
 */
function getAllInsurancePermissions() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName('InsurancePermissions');
  
  if (!sheet) {
    setupSheets();
    return { success: true, permissions: [] };
  }
  
  const data = sheet.getDataRange().getValues();
  const permissions = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      permissions.push({
        email: data[i][0],
        name: data[i][1],
        department: data[i][2],
        addedDate: data[i][3] ? Utilities.formatDate(new Date(data[i][3]), 'Asia/Riyadh', 'yyyy-MM-dd HH:mm') : '',
        addedBy: data[i][4],
        active: data[i][5] === true || data[i][5] === 'TRUE'
      });
    }
  }
  
  return { success: true, permissions: permissions, users: permissions };
}

/**
 * Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù…ÙˆØ¸Ù
 */
function addInsurancePermission(email, name, department) {
  if (!email || !name) {
    return { success: false, error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨Ø§Ù†' };
  }
  
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName('InsurancePermissions');
  
  if (!sheet) {
    setupSheets();
    sheet = ss.getSheetByName('InsurancePermissions');
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString().toLowerCase() === email.toLowerCase()) {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
      sheet.getRange(i + 1, 6).setValue(true);
      return { success: true, message: 'ØªÙ… ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù' };
    }
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
  sheet.appendRow([
    email,
    name,
    department || '',
    new Date(),
    Session.getActiveUser().getEmail() || 'owner',
    true
  ]);
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø®Ø§Øµ Ù„Ù„Ù…ÙˆØ¸Ù
  createUserFolder(name, email);
  
  return { success: true, message: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­' };
}

/**
 * Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ© Ù…ÙˆØ¸Ù
 */
function removeInsurancePermission(email) {
  if (!email) {
    return { success: false, error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨' };
  }
  
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName('InsurancePermissions');
  
  if (!sheet) {
    return { success: false, error: 'ÙˆØ±Ù‚Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' };
  }
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0].toString().toLowerCase() === email.toLowerCase()) {
      sheet.getRange(i + 1, 6).setValue(false);
      return { success: true, message: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¸Ù' };
    }
  }
  
  return { success: false, error: 'Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
}

/**
 * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø®Ø§Øµ Ù„Ù„Ù…ÙˆØ¸Ù
 */
function createUserFolder(name, email) {
  try {
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const folderName = name + ' - ' + email.split('@')[0];
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¬Ù„Ø¯
    const folders = parentFolder.getFoldersByName(folderName);
    if (folders.hasNext()) {
      return folders.next().getUrl();
    }
    
    const newFolder = parentFolder.createFolder(folderName);
    return newFolder.getUrl();
  } catch(e) {
    Logger.log('Error creating folder: ' + e);
    return null;
  }
}

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø©
 */
function logInsuranceUsage(params) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let logSheet = ss.getSheetByName('InsuranceUsageLog');
  
  if (!logSheet) {
    setupSheets();
    logSheet = ss.getSheetByName('InsuranceUsageLog');
  }
  
  const timestamp = new Date();
  const insuranceRating = parseFloat(params.insuranceRating) || 0;
  const serviceRating = parseFloat(params.serviceRating) || 0;
  const overallRating = ((insuranceRating + serviceRating) / 2).toFixed(1);
  
  logSheet.appendRow([
    timestamp,
    params.userEmail || '',
    params.userName || '',
    params.doctorName || '',
    params.caseType || '',
    params.filesCount || 0,
    insuranceRating,
    serviceRating,
    overallRating,
    params.reportLink || '',
    params.notes || ''
  ]);
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
  updateDoctorStats(params.doctorName, insuranceRating, serviceRating, params.reportLink);
  
  return { success: true, message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­' };
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨
 */
function updateDoctorStats(doctorName, insuranceRating, serviceRating, reportLink) {
  if (!doctorName) return;
  
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let statsSheet = ss.getSheetByName('DoctorStats');
  
  if (!statsSheet) {
    setupSheets();
    statsSheet = ss.getSheetByName('DoctorStats');
  }
  
  const data = statsSheet.getDataRange().getValues();
  let doctorRow = -1;
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] && data[i][0].toString().toLowerCase() === doctorName.toLowerCase()) {
      doctorRow = i + 1;
      break;
    }
  }
  
  const timestamp = new Date();
  const formattedDate = Utilities.formatDate(timestamp, 'Asia/Riyadh', 'yyyy-MM-dd HH:mm');
  
  if (doctorRow > 0) {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
    const currentCases = parseInt(data[doctorRow - 1][1]) || 0;
    const currentInsRating = parseFloat(data[doctorRow - 1][2]) || 0;
    const currentSvcRating = parseFloat(data[doctorRow - 1][3]) || 0;
    
    const newCases = currentCases + 1;
    const newInsRating = ((currentInsRating * currentCases + insuranceRating) / newCases).toFixed(1);
    const newSvcRating = ((currentSvcRating * currentCases + serviceRating) / newCases).toFixed(1);
    const newOverall = ((parseFloat(newInsRating) + parseFloat(newSvcRating)) / 2).toFixed(1);
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
    let status = 'Ù…Ù…ØªØ§Ø²';
    if (newOverall < 5) status = 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
    else if (newOverall < 7) status = 'Ø¬ÙŠØ¯';
    else if (newOverall < 9) status = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
    
    statsSheet.getRange(doctorRow, 2).setValue(newCases);
    statsSheet.getRange(doctorRow, 3).setValue(newInsRating);
    statsSheet.getRange(doctorRow, 4).setValue(newSvcRating);
    statsSheet.getRange(doctorRow, 5).setValue(newOverall);
    statsSheet.getRange(doctorRow, 6).setValue(formattedDate);
    statsSheet.getRange(doctorRow, 8).setValue(status);
    
  } else {
    // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨ Ø¬Ø¯ÙŠØ¯
    const overallRating = ((insuranceRating + serviceRating) / 2).toFixed(1);
    let status = 'Ù…Ù…ØªØ§Ø²';
    if (overallRating < 5) status = 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
    else if (overallRating < 7) status = 'Ø¬ÙŠØ¯';
    else if (overallRating < 9) status = 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù„Ù„Ø·Ø¨ÙŠØ¨
    const folderUrl = createDoctorFolder(doctorName);
    
    statsSheet.appendRow([
      doctorName,
      1,
      insuranceRating,
      serviceRating,
      overallRating,
      formattedDate,
      folderUrl || '',
      status
    ]);
  }
}

/**
 * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù„Ù„Ø·Ø¨ÙŠØ¨
 */
function createDoctorFolder(doctorName) {
  try {
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const folderName = 'Ø¯. ' + doctorName;
    
    const folders = parentFolder.getFoldersByName(folderName);
    if (folders.hasNext()) {
      return folders.next().getUrl();
    }
    
    const newFolder = parentFolder.createFolder(folderName);
    return newFolder.getUrl();
  } catch(e) {
    Logger.log('Error creating doctor folder: ' + e);
    return null;
  }
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
 */
function getUsageLog(email) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const logSheet = ss.getSheetByName('InsuranceUsageLog');
  
  if (!logSheet) {
    return { success: true, logs: [] };
  }
  
  const data = logSheet.getDataRange().getValues();
  const logs = [];
  
  for (let i = 1; i < data.length; i++) {
    if (!email || data[i][1].toString().toLowerCase() === email.toLowerCase()) {
      logs.push({
        timestamp: data[i][0] ? Utilities.formatDate(new Date(data[i][0]), 'Asia/Riyadh', 'yyyy-MM-dd HH:mm') : '',
        userEmail: data[i][1],
        userName: data[i][2],
        doctorName: data[i][3],
        caseType: data[i][4],
        filesCount: data[i][5],
        insuranceRating: data[i][6],
        serviceRating: data[i][7],
        overallRating: data[i][8],
        reportLink: data[i][9],
        notes: data[i][10]
      });
    }
  }
  
  return { success: true, logs: logs.reverse() };
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
 */
function getDoctorStats() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const statsSheet = ss.getSheetByName('DoctorStats');
  
  if (!statsSheet) {
    return { success: true, doctors: [] };
  }
  
  const data = statsSheet.getDataRange().getValues();
  const doctors = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      doctors.push({
        doctorName: data[i][0],
        totalCases: data[i][1],
        avgInsuranceRating: data[i][2],
        avgServiceRating: data[i][3],
        avgOverallRating: data[i][4],
        lastCaseDate: data[i][5],
        folderLink: data[i][6],
        status: data[i][7]
      });
    }
  }
  
  // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹
  doctors.sort((a, b) => b.totalCases - a.totalCases);
  
  return { success: true, doctors: doctors };
}

/**
 * Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Drive
 */
function saveReportToDrive(params) {
  try {
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    
    // Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨
    const doctorFolderName = 'Ø¯. ' + (params.doctorName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
    let doctorFolder;
    
    const folders = parentFolder.getFoldersByName(doctorFolderName);
    if (folders.hasNext()) {
      doctorFolder = folders.next();
    } else {
      doctorFolder = parentFolder.createFolder(doctorFolderName);
    }
    
    // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ…Ù„Ù HTML Ù…Ø¹ Ø¨Ù†ÙŠØ© ÙƒØ§Ù…Ù„Ø©
    const timestamp = Utilities.formatDate(new Date(), 'Asia/Riyadh', 'yyyy-MM-dd_HHmm');
    const fileName = 'ØªÙ‚Ø±ÙŠØ±_' + timestamp + '.html';
    
    const reportBody = params.reportHtml || '<p>No content</p>';
    
    // Ø¥Ù†Ø´Ø§Ø¡ HTML ÙƒØ§Ù…Ù„ Ù…Ø¹ CSS
    const fullHtml = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ© - ${params.doctorName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Tajawal', sans-serif; background: #f8fafc; padding: 20px; direction: rtl; }
    .print-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; background: linear-gradient(135deg, #1e3a5f, #2d4a6f); border-radius: 12px; margin-bottom: 20px; color: white; }
    .print-header img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #c9a962; background: white; }
    .print-header-text h1 { color: #c9a962; font-size: 1.4rem; margin-bottom: 5px; }
    .print-header-text p { font-size: 0.9rem; opacity: 0.9; }
    .print-header-dates { text-align: left; font-size: 0.85rem; }
    .print-footer { margin-top: 30px; padding: 15px; background: #f1f5f9; border-radius: 8px; text-align: center; font-size: 0.8rem; color: #64748b; border-top: 3px solid #c9a962; }
    .audit-report { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .audit-report h1 { color: #1e3a5f; font-size: 1.5rem; text-align: center; padding: 15px; border-bottom: 3px solid #c9a962; margin-bottom: 20px; }
    .audit-report h2 { color: #1e3a5f; font-size: 1.2rem; margin-top: 25px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
    .audit-report h3 { color: #334155; font-size: 1rem; margin-top: 15px; }
    .audit-report p, .audit-report li { line-height: 1.9; color: #334155; }
    .audit-report ul { list-style: none; padding: 0; }
    .audit-report li { padding: 12px 15px; margin: 8px 0; border-radius: 8px; border-right: 4px solid #cbd5e1; background: #f8fafc; }
    .success, li:has(.success) { background: #dcfce7 !important; border-right-color: #22c55e !important; }
    .error, li:has(.error) { background: #fee2e2 !important; border-right-color: #ef4444 !important; }
    .warning, li:has(.warning) { background: #fef9c3 !important; border-right-color: #eab308 !important; }
    .info, li:has(.info) { background: #dbeafe !important; border-right-color: #3b82f6 !important; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 12px; text-align: right; border: 1px solid #e2e8f0; }
    th { background: #1e3a5f; color: white; }
    tr:nth-child(even) { background: #f8fafc; }
    .score-box { text-align: center; padding: 20px; border-radius: 12px; margin: 15px 0; }
    .score-high { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .score-medium { background: linear-gradient(135deg, #eab308, #ca8a04); color: white; }
    .score-low { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .score-value { font-size: 2.5rem; font-weight: bold; }
    @media print { body { background: white; padding: 0; } .audit-report { box-shadow: none; } }
  </style>
</head>
<body>
  ${reportBody}
</body>
</html>`;
    
    const file = doctorFolder.createFile(fileName, fullHtml, MimeType.HTML);
    
    return { 
      success: true, 
      fileUrl: file.getUrl(),
      folderUrl: doctorFolder.getUrl(),
      message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­' 
    };
  } catch(e) {
    return { success: false, error: e.toString() };
  }
}

/**
 * Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
 */
function getDashboardStats(email) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  
  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©
  const logSheet = ss.getSheetByName('InsuranceUsageLog');
  const statsSheet = ss.getSheetByName('DoctorStats');
  const permSheet = ss.getSheetByName('InsurancePermissions');
  
  let totalCases = 0;
  let todayCases = 0;
  let userCases = 0;
  let userTodayCases = 0;
  const today = Utilities.formatDate(new Date(), 'Asia/Riyadh', 'yyyy-MM-dd');
  
  if (logSheet) {
    const logData = logSheet.getDataRange().getValues();
    for (let i = 1; i < logData.length; i++) {
      if (logData[i][0]) {
        totalCases++;
        const logDate = Utilities.formatDate(new Date(logData[i][0]), 'Asia/Riyadh', 'yyyy-MM-dd');
        if (logDate === today) todayCases++;
        
        if (email && logData[i][1].toString().toLowerCase() === email.toLowerCase()) {
          userCases++;
          if (logDate === today) userTodayCases++;
        }
      }
    }
  }
  
  let totalDoctors = 0;
  if (statsSheet) {
    const statsData = statsSheet.getDataRange().getValues();
    totalDoctors = statsData.length - 1;
  }
  
  let totalStaff = 0;
  if (permSheet) {
    const permData = permSheet.getDataRange().getValues();
    for (let i = 1; i < permData.length; i++) {
      if (permData[i][5] === true) totalStaff++;
    }
  }
  
  return {
    success: true,
    stats: {
      totalCases: totalCases,
      todayCases: todayCases,
      totalDoctors: totalDoctors,
      totalStaff: totalStaff,
      userCases: userCases,
      userTodayCases: userTodayCases
    }
  };
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù…Ù† Ø´ÙŠØª Staff
 */
function getDoctorsList() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName('Staff');
    
    if (!sheet) {
      return { success: true, doctors: [] };
    }
    
    const data = sheet.getDataRange().getValues();
    const doctors = [];
    
    for (let i = 1; i < data.length; i++) {
      const name = data[i][0]; // Ø§Ù„Ø¹Ù…ÙˆØ¯ A - Ø§Ù„Ø§Ø³Ù…
      const specialty = data[i][1]; // Ø§Ù„Ø¹Ù…ÙˆØ¯ B - Ø§Ù„ØªØ®ØµØµ
      if (name && name.toString().trim()) {
        doctors.push({ 
          name: name.toString().trim(), 
          specialty: specialty ? specialty.toString().trim() : '' 
        });
      }
    }
    
    return { success: true, doctors: doctors };
  } catch(e) {
    return { success: false, error: e.toString(), doctors: [] };
  }
}

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF ÙÙŠ Drive
 * Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¬Ù…Ø¹ Ø¨ÙŠÙ† logInsuranceUsage Ùˆ saveReportToDrive
 */
function logUsageAndSavePDF(params) {
  try {
    Logger.log('ğŸ“¥ logUsageAndSavePDF called');
    Logger.log('ğŸ“¥ pdfBase64 length: ' + (params.pdfBase64 ? params.pdfBase64.length : 0));
    Logger.log('ğŸ“¥ fileName: ' + params.fileName);
    
    // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø´ÙŠØª
    const logResult = logInsuranceUsage({
      userEmail: params.userEmail,
      userName: params.userName,
      doctorName: params.doctorName,
      caseType: params.caseType || 'Ù…Ø±Ø§Ø¬Ø¹Ø© ØªØ£Ù…ÙŠÙ†',
      filesCount: params.filesCount || 1,
      insuranceRating: params.insuranceRating,
      serviceRating: params.serviceRating,
      notes: params.notes || ''
    });
    
    if (!logResult.success) {
      return { success: false, error: 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ' + logResult.error };
    }
    
    // 2. Ø­ÙØ¸ PDF ÙÙŠ Drive
    let reportLink = '';
    let pdfSize = 0;
    
    if (params.pdfBase64 && params.fileName && params.pdfBase64.length > 100) {
      try {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ base64 Ù…Ù† Ø£ÙŠ Ø¨Ø§Ø¯Ø¦Ø©
        let cleanBase64 = params.pdfBase64;
        if (cleanBase64.includes(',')) {
          cleanBase64 = cleanBase64.split(',')[1];
        }
        
        Logger.log('ğŸ“¥ Clean base64 length: ' + cleanBase64.length);
        
        const decodedBytes = Utilities.base64Decode(cleanBase64);
        pdfSize = decodedBytes.length;
        Logger.log('ğŸ“¥ Decoded bytes length: ' + pdfSize);
        
        const pdfBlob = Utilities.newBlob(
          decodedBytes,
          'application/pdf',
          params.fileName
        );
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¤Ù‡
        const folder = getOrCreateDoctorFolder(params.doctorName);
        const file = folder.createFile(pdfBlob);
        reportLink = file.getUrl();
        
        Logger.log('âœ… PDF saved: ' + reportLink + ' (size: ' + pdfSize + ' bytes)');
        
        // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
        updateLastLogReportLink(reportLink);
        
      } catch(pdfError) {
        Logger.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ PDF: ' + pdfError.toString());
        return { 
          success: true, 
          message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„ÙƒÙ† ÙØ´Ù„ Ø­ÙØ¸ PDF: ' + pdfError.toString(),
          reportLink: '',
          pdfError: pdfError.toString()
        };
      }
    } else {
      Logger.log('âš ï¸ No valid pdfBase64 received');
    }
    
    return { 
      success: true, 
      message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­',
      reportLink: reportLink,
      pdfSize: pdfSize
    };
    
  } catch(error) {
    Logger.log('âŒ Ø®Ø·Ø£ ÙÙŠ logUsageAndSavePDF: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¤Ù‡
 */
function getOrCreateDoctorFolder(doctorName) {
  const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
  const folders = parentFolder.getFoldersByName(doctorName);
  
  if (folders.hasNext()) {
    return folders.next();
  }
  
  return parentFolder.createFolder(doctorName);
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø¢Ø®Ø± Ø³Ø¬Ù„
 */
function updateLastLogReportLink(reportLink) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const logSheet = ss.getSheetByName('InsuranceUsageLog');
    if (!logSheet) return;
    
    const lastRow = logSheet.getLastRow();
    if (lastRow > 1) {
      logSheet.getRange(lastRow, 10).setValue(reportLink); // Ø¹Ù…ÙˆØ¯ reportLink
    }
  } catch(e) {
    Logger.log('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + e);
  }
}

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ HTML ÙÙŠ Drive
 * Ø£ÙƒØ«Ø± Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ù…Ù† PDF Ù„Ø£Ù† HTML Ø£ØµØºØ± Ø­Ø¬Ù…Ø§Ù‹
 */
function logUsageAndSaveHTML(params) {
  try {
    Logger.log('ğŸ“¥ logUsageAndSaveHTML called');
    Logger.log('ğŸ“¥ htmlContent length: ' + (params.htmlContent ? params.htmlContent.length : 0));
    
    // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
    const logResult = logInsuranceUsage({
      userEmail: params.userEmail,
      userName: params.userName,
      doctorName: params.doctorName,
      caseType: params.caseType || 'Ù…Ø±Ø§Ø¬Ø¹Ø© ØªØ£Ù…ÙŠÙ†',
      filesCount: params.filesCount || 1,
      insuranceRating: params.insuranceRating,
      serviceRating: params.serviceRating,
      notes: params.notes || ''
    });
    
    if (!logResult.success) {
      return { success: false, error: 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ' + logResult.error };
    }
    
    // 2. Ø­ÙØ¸ HTML ÙÙŠ Drive
    let reportLink = '';
    
    if (params.htmlContent && params.fileName) {
      try {
        // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© HTML ÙƒØ§Ù…Ù„Ø©
        const fullHTML = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${params.fileName}</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Tajawal', Arial, sans-serif; direction: rtl; padding: 20px; background: #f8fafc; color: #1e293b; line-height: 1.8; }
    @media print { body { background: white; padding: 10mm; } }
  </style>
</head>
<body>
${params.htmlContent}
</body>
</html>`;
        
        const folder = getOrCreateDoctorFolder(params.doctorName);
        const file = folder.createFile(params.fileName, fullHTML, MimeType.HTML);
        reportLink = file.getUrl();
        
        Logger.log('âœ… HTML saved: ' + reportLink);
        
        updateLastLogReportLink(reportLink);
        
      } catch(htmlError) {
        Logger.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ HTML: ' + htmlError.toString());
        return { 
          success: true, 
          message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„ÙƒÙ† ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Drive',
          reportLink: '',
          error: htmlError.toString()
        };
      }
    }
    
    return { 
      success: true, 
      message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­',
      reportLink: reportLink
    };
    
  } catch(error) {
    Logger.log('âŒ Ø®Ø·Ø£ ÙÙŠ logUsageAndSaveHTML: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
 */
function testSetup() {
  const result = setupSheets();
  Logger.log(result);
  
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ Ø§ÙØªØ±Ø§Ø¶ÙŠ
  addInsurancePermission('owner@m2020m.org', 'Ø§Ù„Ù…Ø§Ù„Ùƒ', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
  
  Logger.log('Setup complete!');
}