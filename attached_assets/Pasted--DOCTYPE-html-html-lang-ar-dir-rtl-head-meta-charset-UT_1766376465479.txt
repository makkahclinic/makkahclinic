<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… - EOC | Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#1e3a5f;
      --secondary:#c9a962;
      --danger:#DC143C;
      --success:#10b981;
      --warning:#f59e0b;
      --info:#3b82f6;
      --muted:#94a3b8;
      --bg1:#0f172a;
      --bg2:#1e3a5f;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Tajawal',sans-serif;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh;color:#fff;
    }

    .header{
      background:rgba(30,58,95,.95);
      backdrop-filter: blur(10px);
      padding:15px 30px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:2px solid var(--secondary);
      position:sticky;top:0;z-index:100;
      gap:12px;flex-wrap:wrap;
    }
    .header-title{display:flex;align-items:center;gap:15px}
    .header-title img{height:50px}
    .header-title h1{font-size:1.35rem;color:#fff}
    .header-title h1 span{color:var(--secondary)}
    .header-status{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .back-btn,.report-emergency-btn{
      text-decoration:none;display:flex;align-items:center;gap:8px;
      padding:10px 18px;border-radius:10px;font-weight:700;transition:.2s;
    }
    .back-btn{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
    }
    .back-btn:hover{background:var(--secondary);color:var(--primary)}
    .report-emergency-btn{
      background:linear-gradient(135deg,var(--danger),#b91c1c);
      color:#fff;border:0;
      box-shadow:0 0 0 0 rgba(220,20,60,.35);
      animation:pulseBtn 2s infinite;
    }
    .report-emergency-btn:hover{transform:scale(1.02);box-shadow:0 10px 30px rgba(220,20,60,.35)}
    @keyframes pulseBtn{
      0%,100%{box-shadow:0 0 0 0 rgba(220,20,60,.35)}
      50%{box-shadow:0 0 0 10px rgba(220,20,60,0)}
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}

    .status-badge{
      display:flex;align-items:center;gap:8px;
      padding:8px 14px;border-radius:999px;font-weight:800;font-size:.95rem;
      border:1px solid rgba(16,185,129,.45);
      color:var(--success);
      background:rgba(16,185,129,.12);
      cursor:pointer;user-select:none;
    }
    .status-badge:hover{filter:brightness(1.06)}
    .status-badge.alert{
      border-color:rgba(220,20,60,.6);
      color:var(--danger);
      background:rgba(220,20,60,.14);
      animation:pulse 1.5s infinite;
    }
    .status-badge.alert:hover{filter:brightness(1.10)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

    .main-container{
      display:grid;
      grid-template-columns: 410px 1fr;
      gap:18px;
      padding:18px;
      max-width:1700px;
      margin:0 auto;
    }
    @media(max-width:1024px){.main-container{grid-template-columns:1fr}}

    .panel-card{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:18px;
      padding:18px;
    }
    .section-title{
      display:flex;align-items:center;gap:10px;
      color:var(--secondary);
      font-weight:900;font-size:1.15rem;
      margin-bottom:14px;
    }

    /* Left column - control */
    .control-panel{display:flex;flex-direction:column;gap:14px}
    .quick-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.quick-actions{grid-template-columns:1fr}}
    .quick-action{
      background:rgba(255,255,255,.06);
      border:2px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px 12px;
      cursor:pointer;
      transition:.2s;
      text-align:center;
    }
    .quick-action:hover{
      transform:translateY(-2px);
      border-color:var(--secondary);
      box-shadow:0 12px 30px rgba(201,169,98,.16);
    }
    .qa-ico{
      width:58px;height:58px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:1.6rem;margin:0 auto 10px;
    }
    .quick-action.training .qa-ico{background:linear-gradient(135deg,#f59e0b,#d97706);box-shadow:0 8px 22px rgba(245,158,11,.35)}
    .quick-action.training-log .qa-ico{background:linear-gradient(135deg,#3b82f6,#1d4ed8);box-shadow:0 8px 22px rgba(59,130,246,.35)}
    .quick-action.reports-log .qa-ico{background:linear-gradient(135deg,#DC143C,#b91c1c);box-shadow:0 8px 22px rgba(220,20,60,.35)}
    .qa-title{font-weight:900}
    .qa-sub{opacity:.75;font-size:.85rem;margin-top:3px}

    .activate-emergency-card{
      border:2px solid rgba(220,20,60,.7);
      background:linear-gradient(135deg, rgba(220,20,60,.22), rgba(185,28,28,.25));
    }
    .main-cancel-btn{
      background:linear-gradient(135deg,#6b7280,#4b5563);
      border:none;
      color:#fff;
      padding:16px 24px;
      border-radius:12px;
      font-size:1.1rem;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:all .3s;
    }
    .main-cancel-btn:hover{
      background:linear-gradient(135deg,#4b5563,#374151);
      transform:scale(1.02);
    }
    .main-activate-btn{
      width:100%;
      padding:18px;
      background:linear-gradient(135deg,#dc2626,#b91c1c);
      border:0;border-radius:16px;
      color:#fff;
      font-size:1.2rem;
      font-weight:900;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
      box-shadow:0 0 0 0 rgba(220,38,38,.35);
      animation:emPulse 2s infinite;
    }
    @keyframes emPulse{
      0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,.35)}
      50%{box-shadow:0 0 0 12px rgba(220,38,38,0)}
    }

    /* Scenario guide icons */
    .scenario-icons{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media(max-width:600px){.scenario-icons{grid-template-columns:repeat(2,1fr)}}
    .scenario-icon{
      background:rgba(255,255,255,.06);
      border:2px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px 10px;
      cursor:pointer;
      transition:.2s;
      text-align:center;
      font-weight:800;
      font-size:.9rem;
    }
    .scenario-icon i{display:block;font-size:1.6rem;margin-bottom:8px}
    .scenario-icon:hover{transform:scale(1.02);border-color:var(--secondary)}
    .scenario-icon.active{background:rgba(201,169,98,.12);border-color:var(--secondary)}
    .scenario-icon.fire i{color:#ef4444}
    .scenario-icon.power i{color:#f59e0b}
    .scenario-icon.water i{color:#0ea5e9}
    .scenario-icon.injury i{color:#10b981}
    .scenario-icon.outbreak i{color:#8b5cf6}

    /* Guide panel */
    .guide-wrap{display:none}
    .guide-wrap.active{display:block}
    .guide-title{
      display:flex;align-items:center;gap:10px;
      font-weight:900;font-size:1.05rem;margin-bottom:12px;
    }
    .guide-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:700px){.guide-grid{grid-template-columns:1fr}}
    .guide-box{
      border-radius:16px;
      padding:14px;
      border:2px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.22);
    }
    .guide-box.do{
      background:linear-gradient(135deg,#fef3c7,#fde68a);
      border-color:#f59e0b;
      color:#111827;
    }
    .guide-box.dont{
      background:linear-gradient(135deg,#fee2e2,#fecaca);
      border-color:#dc2626;
      color:#111827;
    }
    .guide-box h4{
      display:flex;align-items:center;gap:10px;
      font-weight:900;margin-bottom:10px;
    }
    .guide-step{
      display:flex;align-items:flex-start;gap:10px;
      padding:10px 10px;
      border-radius:12px;
      background:rgba(255,255,255,.7);
      margin-bottom:8px;
      border-right:5px solid rgba(0,0,0,.2);
    }
    .guide-step:last-child{margin-bottom:0}
    .guide-step .num{
      width:28px;height:28px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;flex:0 0 auto;
    }
    .guide-box.do .num{background:#f59e0b}
    .guide-box.dont .num{background:#dc2626}
    .guide-step .txt{font-weight:700;line-height:1.5}
    .guide-step i{margin-top:2px}

    /* Right column - building */
    .building-section{order:2}
    .building-view{display:flex;flex-direction:column;gap:12px}
    .floor{
      background:rgba(255,255,255,.04);
      border:2px solid rgba(255,255,255,.1);
      border-radius:16px;
      padding:14px;
      transition:.2s;cursor:pointer;
    }
    .floor:hover{border-color:var(--secondary);transform:translateX(-3px)}
    .floor.active{border-color:var(--secondary);background:rgba(201,169,98,.1)}
    .floor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .floor-name{display:flex;align-items:center;gap:10px;font-weight:900}
    .floor-icon{
      width:40px;height:40px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .floor-status{
      padding:6px 12px;border-radius:999px;font-weight:900;font-size:.85rem;
      background:rgba(16,185,129,.14);color:var(--success);
      border:1px solid rgba(16,185,129,.4);
    }
    .departments-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
    .dept-card{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:10px;
      text-align:center;
      font-weight:800;
      font-size:.85rem;
      transition:.2s;
      position:relative;
    }
    .dept-card i{display:block;font-size:1.2rem;margin-bottom:6px;color:var(--secondary)}
    .dept-card:hover{background:rgba(201,169,98,.18);border-color:var(--secondary)}
    .dept-card.emergency-highlight{
      background:linear-gradient(135deg,#DC143C,#ff4444) !important;
      border:3px solid #fff !important;
      box-shadow:0 0 30px rgba(220,20,60,.7) !important;
      color:#fff !important;
      animation: blink .6s ease-in-out infinite alternate;
    }
    .dept-card.emergency-highlight i{color:#fff}
    @keyframes blink{from{opacity:1}to{opacity:.75}}

    .muster-points{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .muster-card{
      background:rgba(16,185,129,.1);
      border:1px solid rgba(16,185,129,.35);
      border-radius:14px;
      padding:12px;
      text-align:center;
      cursor:pointer;
      transition:.2s;
    }
    .muster-card:hover{transform:translateY(-2px);border-color:var(--secondary)}
    .muster-card i{font-size:1.35rem;color:var(--success);margin-bottom:6px}
    .muster-card h4{font-weight:900;font-size:.95rem}
    .muster-card p{opacity:.75;font-size:.82rem;margin-top:2px}

    .activate-evacuation-btn{
      width:100%;
      margin-top:14px;
      padding:16px;
      border:0;border-radius:14px;
      background:linear-gradient(135deg,var(--danger),#b91c1c);
      color:#fff;
      font-weight:900;font-size:1.1rem;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
      box-shadow:0 10px 28px rgba(220,20,60,.25);
      transition:.2s;
    }
    .activate-evacuation-btn:hover{transform:scale(1.01);box-shadow:0 14px 34px rgba(220,20,60,.32)}

    /* mini lists */
    .mini-list{max-height:260px;overflow:auto}
    .mini-item{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
    }
    .mini-item:last-child{margin-bottom:0}
    .mini-row{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .pill{
      padding:4px 10px;border-radius:999px;font-weight:900;font-size:.78rem;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.2);
    }
    .pill.new{color:#fff;background:rgba(220,20,60,.25);border-color:rgba(220,20,60,.45)}
    .pill.pending{color:#111827;background:rgba(245,158,11,.35);border-color:rgba(245,158,11,.6)}
    .pill.closed{color:#fff;background:rgba(16,185,129,.25);border-color:rgba(16,185,129,.45)}

    /* Modals */
    .modal{
      display:none;
      position:fixed;inset:0;
      background:rgba(0,0,0,.92);
      z-index:30000;
      overflow:auto;
      padding:18px;
    }
    .modal.active{display:flex;align-items:flex-start;justify-content:center}
    .modal-card{
      width:min(1100px,96vw);
      margin:12px auto;
      background:linear-gradient(135deg,#1e3a5f,#0f172a);
      border-radius:20px;
      border:2px solid rgba(201,169,98,.65);
      padding:18px;
    }
    .modal-header{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding-bottom:12px;margin-bottom:14px;border-bottom:1px solid rgba(255,255,255,.16);
    }
    .modal-header h2{display:flex;align-items:center;gap:10px;color:var(--secondary);font-weight:900;font-size:1.25rem;flex-wrap:wrap}
    .close-modal{
      width:44px;height:44px;border-radius:50%;
      border:0;background:rgba(255,255,255,.1);color:#fff;cursor:pointer;
      display:flex;align-items:center;justify-content:center;font-size:1.15rem;
    }

    /* Activation modal (6 buttons) */
    .simple-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:650px){.simple-grid{grid-template-columns:repeat(2,1fr)}}
    .simple-btn{
      border-radius:16px;
      padding:18px 12px;
      cursor:pointer;
      border:2px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-family:'Tajawal',sans-serif;
      font-weight:900;
      display:flex;flex-direction:column;align-items:center;gap:10px;
      transition:.2s;
    }
    .simple-btn i{font-size:2.1rem}
    .simple-btn:hover{transform:scale(1.02);border-color:var(--secondary)}
    .simple-btn.fire{border-color:#ef4444}
    .simple-btn.fire i{color:#ef4444}
    .simple-btn.power{border-color:#f59e0b}
    .simple-btn.power i{color:#f59e0b}
    .simple-btn.water{border-color:#0ea5e9}
    .simple-btn.water i{color:#0ea5e9}
    .simple-btn.injury{border-color:#10b981}
    .simple-btn.injury i{color:#10b981}
    .simple-btn.outbreak{border-color:#8b5cf6}
    .simple-btn.outbreak i{color:#8b5cf6}
    .simple-btn.drill{
      border-color:#22c55e;background:rgba(34,197,94,.08)
    }
    .simple-btn.drill i{color:#22c55e}

    /* Response modal */
    .report-details{
      background:rgba(220,20,60,.12);
      border:1px solid rgba(220,20,60,.5);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
    }
    .detail-row{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08)}
    .detail-row:last-child{border-bottom:0}
    .detail-label{color:var(--muted);font-weight:800}
    .detail-value{font-weight:900}

    .response-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    @media(max-width:800px){.response-type-grid{grid-template-columns:1fr}}
    .rtype-btn{
      border-radius:16px;
      padding:16px 12px;
      border:2px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      text-align:center;
      transition:.2s;
      font-weight:900;
    }
    .rtype-btn i{font-size:2rem;display:block;margin-bottom:8px}
    .rtype-btn small{display:block;opacity:.75;margin-top:4px;font-weight:700}
    .rtype-btn:hover{border-color:var(--secondary);transform:scale(1.01)}
    .rtype-btn.selected{border-color:#fff}
    .rtype-btn.selected.full{background:linear-gradient(135deg,#dc2626,#b91c1c)}
    .rtype-btn.selected.team{background:linear-gradient(135deg,#f59e0b,#d97706);color:#111827}
    .rtype-btn.selected.iso{background:linear-gradient(135deg,#8b5cf6,#6d28d9)}

    .location-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:10px}
    .loc-btn{
      border-radius:14px;
      padding:12px 12px;
      border:2px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;align-items:center;gap:10px;
      transition:.2s;
    }
    .loc-btn:hover{border-color:var(--secondary)}
    .loc-btn.selected{background:rgba(34,197,94,.25);border-color:rgba(34,197,94,.75);color:#eafff5}
    .loc-custom{
      width:100%;
      margin-top:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:#fff;
      font-family:'Tajawal',sans-serif;
      font-weight:800;
      outline:none;
    }

    .muster-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .muster-btn{
      flex:1;min-width:240px;
      border-radius:14px;
      padding:12px 12px;
      border:2px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:10px;
      transition:.2s;
    }
    .muster-btn:hover{border-color:var(--secondary)}
    .muster-btn.selected{background:rgba(34,197,94,.25);border-color:rgba(34,197,94,.75)}

    .modal-actions{display:flex;gap:12px;margin-top:16px}
    .btn{
      border:0;border-radius:14px;
      padding:14px 14px;
      cursor:pointer;
      font-weight:900;
      font-family:'Tajawal',sans-serif;
      display:flex;align-items:center;justify-content:center;gap:10px;
      transition:.2s;
      width:100%;
    }
    .btn.secondary{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.18)}
    .btn.primary{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
    .btn.primary:disabled{opacity:.5;cursor:not-allowed}
    .btn.success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}
    .btn.warn{background:linear-gradient(135deg,var(--warning),#d97706);color:#111827}

    /* Logs */
    .filters{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px
    }
    .filters input,.filters select{
      padding:10px 12px;border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.1);
      color:#fff;font-family:'Tajawal',sans-serif;font-weight:800;
    }
    .range-btns{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:9px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      font-family:'Tajawal',sans-serif;
      transition:.15s;
    }
    .chip:hover{border-color:var(--secondary)}
    .chip.active{background:rgba(201,169,98,.2);border-color:var(--secondary)}

    .table-wrap{overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.1)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:right;white-space:nowrap}
    th{background:rgba(59,130,246,.18);color:var(--secondary);font-weight:900}
    tr:hover td{background:rgba(255,255,255,.04)}
    .view-btn{
      background:var(--secondary);color:var(--primary);
      border:0;border-radius:10px;padding:8px 10px;
      cursor:pointer;font-weight:900;
      font-family:'Tajawal',sans-serif;
      display:inline-flex;align-items:center;gap:8px;
    }

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
      padding:12px 16px;border-radius:12px;
      color:#fff;font-weight:900;
      background:rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.15);
      z-index:50000;
      display:flex;align-items:center;gap:10px;
      max-width:min(90vw,520px);
    }
    .toast.success{background:rgba(16,185,129,.25);border-color:rgba(16,185,129,.5)}
    .toast.error{background:rgba(220,20,60,.25);border-color:rgba(220,20,60,.55)}
    .toast.warn{background:rgba(245,158,11,.25);border-color:rgba(245,158,11,.55)}

    /* Print Header for all modals */
    .print-header{
      display:none;
      text-align:center;
      padding:20px 0;
      border-bottom:3px solid #1e3a5f;
      margin-bottom:20px;
    }
    .print-header img{height:80px;margin-bottom:10px}
    .print-header h1{color:#1e3a5f;font-size:1.5rem;margin:8px 0}
    .print-header h2{color:#c9a962;font-size:1.1rem;font-weight:700}
    .print-header .clinic-info{color:#666;font-size:.9rem;margin-top:8px}
    .print-footer{
      display:none;
      text-align:center;
      padding:15px 0;
      border-top:2px solid #eee;
      margin-top:20px;
      color:#666;
      font-size:.85rem;
    }

    @media print{
      *{-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important}
      body{background:#fff !important;color:#000 !important;font-size:10pt}
      .header,.main-container,.filters,.range-btns,.close-modal,.modal-actions,.view-btn,
      button:not(.no-hide-print),.chip,.quick-action{display:none !important}
      
      .modal{
        position:static !important;
        display:block !important;
        background:#fff !important;
        padding:0 !important;
        overflow:visible !important;
      }
      .modal:not(.active){display:none !important}
      .modal-card{
        background:#fff !important;
        color:#000 !important;
        border:none !important;
        box-shadow:none !important;
        max-width:100% !important;
        padding:0 !important;
      }
      .modal-header{display:none !important}
      
      .print-header{display:block !important}
      .print-footer{display:block !important}
      
      .table-wrap{border:1px solid #ddd !important;border-radius:8px !important;overflow:visible !important}
      table{width:100% !important;table-layout:fixed !important}
      th,td{
        white-space:normal !important;
        word-wrap:break-word !important;
        overflow-wrap:break-word !important;
        font-size:9pt !important;
        padding:8px 5px !important;
      }
      th{background:#1e3a5f !important;color:#fff !important}
      td{color:#000 !important;border-bottom:1px solid #eee !important}
      tr:nth-child(even) td{background:#f8f9fa !important}
      
      /* Hide details column in print */
      th:last-child, td:last-child{display:none !important}
      
      .mini-item{
        background:#f8f9fa !important;
        border:1px solid #ddd !important;
        border-radius:10px !important;
        padding:15px !important;
        margin-bottom:12px !important;
        page-break-inside:avoid;
      }
      .mini-item div{color:#000 !important}
      
      @page{margin:1cm;size:A4 landscape}
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-title">
      <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Logo">
      <h1><i class="fas fa-shield-alt"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© <span>ÙˆØ§Ù„ØªØ­ÙƒÙ… EOC</span></h1>
    </div>

    <div class="header-status">
      <a href="emergency-report.html" class="report-emergency-btn">
        <i class="fas fa-exclamation-triangle"></i> Ø¥Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦
      </a>

      <button type="button" class="status-badge" id="systemStatus" onclick="onStatusBadgeClick()">
        <i class="fas fa-check-circle"></i><span>Ø§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ</span>
      </button>

      <a href="emergency-plan.html" class="back-btn">
        <i class="fas fa-arrow-right"></i> Ø®Ø·Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
      </a>
    </div>
  </header>

  <div class="main-container">
    <!-- LEFT: CONTROL -->
    <div class="control-panel">
      <div class="quick-actions">
        <div class="quick-action training" onclick="openTrainingModal()">
          <div class="qa-ico"><i class="fas fa-chalkboard-teacher"></i></div>
          <div class="qa-title">Ø¬Ù„Ø³Ø© ØªØ¯Ø±ÙŠØ¨ Ø¹Ù…Ù„ÙŠ</div>
          <div class="qa-sub">Ø§Ø®ØªØ± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ + Ø­Ø¶ÙˆØ±</div>
        </div>
        <div class="quick-action training-log" onclick="openTrainingLogModal()">
          <div class="qa-ico"><i class="fas fa-clipboard-list"></i></div>
          <div class="qa-title">Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
          <div class="qa-sub">ÙÙ„ØªØ±Ø© + Ø·Ø¨Ø§Ø¹Ø©</div>
        </div>
        <div class="quick-action reports-log" onclick="openReportsLogModal()">
          <div class="qa-ico"><i class="fas fa-exclamation-triangle"></i></div>
          <div class="qa-title">Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>
          <div class="qa-sub">Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ + ÙÙ„ØªØ±Ø©</div>
        </div>
      </div>

      <!-- DEBUG: Test Button - ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡ Ø¨Ø¹Ø¯ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© -->
      <div style="margin:10px 0;padding:10px;background:rgba(220,20,60,.15);border:2px dashed #dc143c;border-radius:12px;text-align:center">
        <div style="color:#dc143c;font-weight:900;margin-bottom:8px"><i class="fas fa-bug"></i> ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</div>
        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
          <button onclick="testAppsScript()" style="background:#dc143c;color:#fff;padding:10px 16px;border:0;border-radius:8px;cursor:pointer;font-weight:900;font-family:Tajawal">
            <i class="fas fa-flask"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­ÙØ¸
          </button>
          <button onclick="testGetSessions()" style="background:#059669;color:#fff;padding:10px 16px;border:0;border-radius:8px;cursor:pointer;font-weight:900;font-family:Tajawal">
            <i class="fas fa-download"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø­Ø¨
          </button>
        </div>
        <div style="color:#999;font-size:.8rem;margin-top:6px">Ø§Ø¶ØºØ· "Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø­Ø¨" Ù„ÙØ­Øµ Ù„Ù…Ø§Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº</div>
      </div>

      <div class="panel-card activate-emergency-card">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="main-activate-btn" onclick="openActivationModal()" style="flex:1;min-width:150px">
            <i class="fas fa-bell"></i>
            <span>ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</span>
          </button>
        </div>
        <div style="margin-top:10px;color:var(--muted);font-weight:800;font-size:.9rem;line-height:1.6">
          <i class="fas fa-info-circle"></i>
          Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙŠÙØªØ­ Ù†ÙØ³ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø±Ø§Ø± Ù…Ø«Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© + Ù…ÙˆÙ‚Ø¹ + Ù†Ù‚Ø·Ø© ØªØ¬Ù…Ø¹) Ø«Ù… ÙŠØ±Ø³Ù„ Ø£Ù…Ø± Ø§Ù„Ø´Ø§Ø´Ø§Øª.
        </div>
      </div>

      <div class="panel-card">
        <div class="section-title"><i class="fas fa-book-open"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª</div>
        <div class="scenario-icons" id="scenarioIcons">
          <div class="scenario-icon fire" data-s="fire" onclick="showScenarioGuide('fire')">
            <i class="fas fa-fire"></i><span id="lbl_fire">Ø­Ø±ÙŠÙ‚</span>
          </div>
          <div class="scenario-icon power" data-s="power" onclick="showScenarioGuide('power')">
            <i class="fas fa-bolt"></i><span id="lbl_power">Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒÙ‡Ø±Ø¨Ø§Ø¡</span>
          </div>
          <div class="scenario-icon water" data-s="water" onclick="showScenarioGuide('water')">
            <i class="fas fa-tint"></i><span id="lbl_water">ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡</span>
          </div>
          <div class="scenario-icon injury" data-s="injury" onclick="showScenarioGuide('injury')">
            <i class="fas fa-heartbeat"></i><span id="lbl_injury">Ø¥ØºÙ…Ø§Ø¡/Ø¥ØµØ§Ø¨Ø©</span>
          </div>
          <div class="scenario-icon outbreak" data-s="outbreak" onclick="showScenarioGuide('outbreak')">
            <i class="fas fa-virus"></i><span id="lbl_outbreak">ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰</span>
          </div>
        </div>

        <div class="guide-wrap" id="guideWrap" style="margin-top:14px">
          <div class="guide-title" id="guideTitle"></div>
          <div class="guide-grid">
            <div class="guide-box do">
              <h4><i class="fas fa-circle-check"></i> Ø§ÙØ¹Ù„ (DO)</h4>
              <div id="guideDo"></div>
            </div>
            <div class="guide-box dont">
              <h4><i class="fas fa-triangle-exclamation"></i> ØªØ¬Ù†Ø¨ (DON'T)</h4>
              <div id="guideDont"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-card">
        <div class="section-title"><i class="fas fa-clipboard-check"></i> Ø³Ø¬Ù„ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† (Ø¢Ø®Ø± 10)</div>
        <div class="mini-list" id="miniTrainingList">
          <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
            <i class="fas fa-spinner fa-spin"></i> ØªØ­Ù…ÙŠÙ„...
          </div>
        </div>
      </div>

      <div class="panel-card">
        <div class="section-title"><i class="fas fa-bell"></i> Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ø¢Ø®Ø± 10)</div>
        <div class="mini-list" id="miniReportsList">
          <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
            <i class="fas fa-spinner fa-spin"></i> ØªØ­Ù…ÙŠÙ„...
          </div>
        </div>
      </div>

      <div class="panel-card">
        <div class="section-title"><i class="fas fa-phone-alt"></i> Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</div>
        <div style="display:grid;gap:10px">
          <div class="mini-item"><div class="mini-row"><span><i class="fas fa-phone-alt" style="color:var(--secondary)"></i> Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ­Ø¯</span><b dir="ltr">911</b></div></div>
          <div class="mini-item"><div class="mini-row"><span><i class="fas fa-ambulance" style="color:var(--secondary)"></i> Ø§Ù„Ù‡Ù„Ø§Ù„ Ø§Ù„Ø£Ø­Ù…Ø±</span><b dir="ltr">997</b></div></div>
          <div class="mini-item"><div class="mini-row"><span><i class="fas fa-fire-extinguisher" style="color:var(--secondary)"></i> Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ</span><b dir="ltr">998</b></div></div>
          <div class="mini-item"><div class="mini-row"><span><i class="fas fa-hospital" style="color:var(--secondary)"></i> ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©</span><b dir="ltr">937</b></div></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: BUILDING -->
    <div class="panel-card building-section">
      <div class="section-title"><i class="fas fa-building"></i> Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰</div>
      <div class="building-view" id="buildingView"></div>

      <div class="muster-points" id="musterPoints"></div>

      <div style="margin-top:10px;color:var(--muted);font-weight:800;font-size:.9rem;line-height:1.6">
        <i class="fas fa-database"></i>
        ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±/Ø§Ù„Ø£Ù‚Ø³Ø§Ù…/Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ¬Ù…Ø¹ ÙŠØªÙ… Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ (EOC_MAP / EOC_MUSTER) ÙˆÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
      </div>
    </div>
  </div>

  <!-- Activation Modal -->
  <div class="modal" id="activationModal">
    <div class="modal-card">
      <div class="modal-header">
        <h2><i class="fas fa-bullhorn"></i> ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦ / ØªÙ…Ø±ÙŠÙ†</h2>
        <button class="close-modal" onclick="closeActivationModal()"><i class="fas fa-times"></i></button>
      </div>

      <div style="text-align:center;color:var(--muted);font-weight:800;margin-bottom:14px;line-height:1.6">
        Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø« Ø«Ù… Ø³Ù†ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø±Ø§Ø± Ù„Ø¥ØµØ¯Ø§Ø± Ø£Ù…Ø± Ù„Ù„Ø´Ø§Ø´Ø§Øª.
      </div>

      <div class="simple-grid">
        <button class="simple-btn fire" onclick="manualStart('fire')"><i class="fas fa-fire"></i><span id="btn_fire">Ø­Ø±ÙŠÙ‚</span></button>
        <button class="simple-btn power" onclick="manualStart('power')"><i class="fas fa-bolt"></i><span id="btn_power">Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒÙ‡Ø±Ø¨Ø§Ø¡</span></button>
        <button class="simple-btn water" onclick="manualStart('water')"><i class="fas fa-tint"></i><span id="btn_water">ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡</span></button>
        <button class="simple-btn injury" onclick="manualStart('injury')"><i class="fas fa-heartbeat"></i><span id="btn_injury">Ø¥ØºÙ…Ø§Ø¡/Ø¥ØµØ§Ø¨Ø©</span></button>
        <button class="simple-btn outbreak" onclick="manualStart('outbreak')"><i class="fas fa-virus"></i><span id="btn_outbreak">ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰</span></button>
        <button class="simple-btn drill" onclick="manualStart('drill')"><i class="fas fa-clipboard-check"></i><span>ğŸ¯ ØªÙ…Ø±ÙŠÙ†</span></button>
      </div>

      <div class="modal-actions" style="margin-top:14px">
        <button class="btn secondary" onclick="closeActivationModal()"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Response Modal (issue command) -->
  <div class="modal" id="responseModal">
    <div class="modal-card" style="max-width:900px">
      <div class="modal-header">
        <h2 style="color:var(--danger)"><i class="fas fa-bell"></i> Ù‚Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©</h2>
        <button class="close-modal" onclick="closeResponseModal()"><i class="fas fa-times"></i></button>
      </div>

      <div class="report-details">
        <div class="detail-row"><span class="detail-label">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«</span><span class="detail-value" id="rmType">-</span></div>
        <div class="detail-row"><span class="detail-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span><span class="detail-value" id="rmLocation">-</span></div>
        <div class="detail-row"><span class="detail-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span><span class="detail-value" id="rmNotes">-</span></div>
        <div class="detail-row"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº</span><span class="detail-value" id="rmId">-</span></div>
      </div>

      <div style="font-weight:900;color:var(--secondary)"><i class="fas fa-hand-pointer"></i> Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©</div>
      <div class="response-type-grid">
        <div class="rtype-btn" data-rt="full_evacuation" onclick="selectResponseType('full_evacuation')">
          <i class="fas fa-running"></i><span>Ø¥Ø®Ù„Ø§Ø¡</span><small>Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¨Ù†Ù‰/Ø¯ÙˆØ±/Ù…Ù†Ø§Ø·Ù‚</small>
        </div>
        <div class="rtype-btn" data-rt="send_team" onclick="selectResponseType('send_team')">
          <i class="fas fa-users"></i><span>ØªÙˆØ¬ÙŠÙ‡ ÙØ±ÙŠÙ‚</span><small>ØªÙˆØ¬ÙŠÙ‡ ÙØ±ÙŠÙ‚ Ù„Ù…ÙˆÙ‚Ø¹</small>
        </div>
        <div class="rtype-btn" data-rt="isolation_evacuation" onclick="selectResponseType('isolation_evacuation')">
          <i class="fas fa-shield-virus"></i><span>Ø¹Ø²Ù„</span><small>Ø¹Ø²Ù„ Ù…Ù†Ø·Ù‚Ø© + Ù…Ù†Ø¹ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨</small>
        </div>
      </div>

      <div id="locationBlock" style="display:none;margin-top:14px">
        <div style="font-weight:900;color:var(--secondary)"><i class="fas fa-crosshairs"></i> Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙˆÙ‚Ø¹)</div>
        <div class="location-grid" id="locationGrid"></div>
        <input class="loc-custom" id="customLocation" placeholder="Ù…ÙˆÙ‚Ø¹ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..." oninput="updateIssueButtonState()">
      </div>

      <div id="musterBlock" style="display:none;margin-top:14px">
        <div style="font-weight:900;color:var(--secondary)"><i class="fas fa-map-marker-alt"></i> Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¬Ù…Ø¹</div>
        <div class="muster-grid" id="musterGrid"></div>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="closeResponseModal()"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" id="issueBtn" onclick="issueCommand()" disabled><i class="fas fa-bullhorn"></i> Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø´Ø§Ø´Ø§Øª</button>
      </div>

      <div style="margin-top:10px;color:var(--muted);font-weight:800;font-size:.9rem;line-height:1.6">
        <i class="fas fa-volume-high"></i>
        ØªÙ†Ø¨ÙŠÙ‡: ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‚Ø¯ ÙŠÙÙ…Ù†Ø¹ Ø¨Ø¯ÙˆÙ† ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø³Ø¨Ø¨ Ø³ÙŠØ§Ø³Ø© Autoplay ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.
      </div>
    </div>
  </div>

  <!-- Command Display Screen (local display) -->
  <div class="modal" id="commandScreen">
    <div class="modal-card" style="max-width:900px;border-color:rgba(220,20,60,.8)">
      <div class="modal-header">
        <h2 style="color:var(--danger)"><i class="fas fa-triangle-exclamation"></i> Ø£Ù…Ø± ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø´Ø§Ø´Ø§Øª</h2>
        <button class="close-modal" onclick="endCommand(false)"><i class="fas fa-times"></i></button>
      </div>

      <div style="text-align:center;padding:10px 0">
        <div style="font-weight:1000;font-size:2rem" id="cmdTitle">-</div>
        <div style="margin-top:10px;font-weight:900;font-size:1.2rem;color:var(--secondary)" id="cmdReportType">-</div>

        <div style="margin-top:14px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px">
          <div style="display:flex;justify-content:center;align-items:center;gap:10px;font-weight:900;font-size:1.2rem">
            <i class="fas fa-map-marker-alt" style="color:var(--secondary)"></i>
            <span id="cmdLocation">-</span>
          </div>
          <div style="margin-top:10px;display:none" id="cmdMusterWrap">
            <div style="font-weight:900;color:var(--secondary);margin-bottom:6px"><i class="fas fa-location-dot"></i> Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰</div>
            <div style="font-weight:1000;font-size:1.2rem" id="cmdMuster">-</div>
          </div>
        </div>

        <div style="margin-top:14px;font-weight:900;color:var(--muted)">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ</div>
        <div style="font-family:monospace;font-size:2.4rem;font-weight:1000" id="cmdTimer">00:00</div>

        <div class="modal-actions" style="margin-top:16px">
          <button class="btn success" onclick="endCommand(true)"><i class="fas fa-check-circle"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø£Ù…Ø± (Clear)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Modal -->
  <div class="modal" id="trainingModal">
    <div class="modal-card">
      <div class="modal-header">
        <h2><i class="fas fa-chalkboard-teacher"></i> Ø¬Ù„Ø³Ø© ØªØ¯Ø±ÙŠØ¨ Ø¹Ù…Ù„ÙŠ <span style="color:#fff;background:linear-gradient(135deg,#dc2626,#991b1b);padding:5px 12px;border-radius:999px;font-size:.9rem">ğŸ¯ DRILL</span></h2>
        <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#111827;font-family:monospace;font-weight:1000;padding:10px 16px;border-radius:12px" id="trainTimer">00:00:00</div>
        <button class="close-modal" onclick="closeTrainingModal()"><i class="fas fa-times"></i></button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 360px;gap:14px">
        <div>
          <div class="section-title"><i class="fas fa-list-check"></i> Ø§Ø®ØªØ± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>

          <div class="scenario-icons" style="grid-template-columns:repeat(5,1fr)" id="trainScenarioIcons">
            <div class="scenario-icon fire" data-s="fire" onclick="selectTrainingScenario('fire')"><i class="fas fa-fire"></i><span id="t_fire">Ø­Ø±ÙŠÙ‚</span></div>
            <div class="scenario-icon power" data-s="power" onclick="selectTrainingScenario('power')"><i class="fas fa-bolt"></i><span id="t_power">Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒÙ‡Ø±Ø¨Ø§Ø¡</span></div>
            <div class="scenario-icon water" data-s="water" onclick="selectTrainingScenario('water')"><i class="fas fa-tint"></i><span id="t_water">ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡</span></div>
            <div class="scenario-icon injury" data-s="injury" onclick="selectTrainingScenario('injury')"><i class="fas fa-heartbeat"></i><span id="t_injury">Ø¥ØºÙ…Ø§Ø¡/Ø¥ØµØ§Ø¨Ø©</span></div>
            <div class="scenario-icon outbreak" data-s="outbreak" onclick="selectTrainingScenario('outbreak')"><i class="fas fa-virus"></i><span id="t_outbreak">ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰</span></div>
          </div>

          <div id="trainingGuide" style="margin-top:14px;display:none">
            <div class="guide-title" id="trainingGuideTitle"></div>
            <div class="guide-grid">
              <div class="guide-box do">
                <h4><i class="fas fa-circle-check"></i> Ø§ÙØ¹Ù„ (DO)</h4>
                <div id="trainingDo"></div>
              </div>
              <div class="guide-box dont">
                <h4><i class="fas fa-triangle-exclamation"></i> ØªØ¬Ù†Ø¨ (DON'T)</h4>
                <div id="trainingDont"></div>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;color:var(--muted);font-weight:800;line-height:1.6">
            <i class="fas fa-bullhorn"></i>
            Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„Ù„Ø´Ø§Ø´Ø§Øª (Training Mode) â€” Ø¨Ø¯ÙˆÙ† Ø£Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©.
          </div>
        </div>

        <div>
          <div style="margin-bottom:12px">
            <div style="color:var(--secondary);font-weight:900;margin-bottom:8px"><i class="fas fa-user-tie"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨</div>
            <select id="trainerSelect" class="loc-custom" onchange="onTrainerSelectChange()" style="margin-bottom:8px">
              <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø¨ --</option>
            </select>
            <input id="trainerName" class="loc-custom" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ..." oninput="updateTrainingSaveState()" style="display:none">
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
            <button class="btn warn" style="width:auto" onclick="broadcastTrainingToScreens()">
              <i class="fas fa-tower-broadcast"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„Ù„Ø´Ø§Ø´Ø§Øª
            </button>
            <button class="btn secondary" style="width:auto" onclick="stopTrainingOnScreens()">
              <i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø±Ø¶
            </button>
          </div>

          <div style="color:var(--secondary);font-weight:900;margin-bottom:8px"><i class="fas fa-users"></i> Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ†</div>
          <div class="mini-list" style="max-height:320px" id="rosterList">
            <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
              <i class="fas fa-spinner fa-spin"></i> ØªØ­Ù…ÙŠÙ„...
            </div>
          </div>

          <div style="margin-top:10px;text-align:center;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);border-radius:12px;padding:10px;font-weight:900;color:var(--success)">
            ØªÙ… Ø§Ø®ØªÙŠØ§Ø± <span id="rosterCount">0</span> Ù…ØªØ¯Ø±Ø¨
          </div>

          <button class="btn success" id="saveTrainingBtn" onclick="saveTrainingSession()" disabled style="margin-top:10px">
            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Log Modal -->
  <div class="modal" id="trainingLogModal">
    <div class="modal-card" style="max-width:1100px">
      <!-- Print Header -->
      <div class="print-header">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹">
        <h1>Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</h1>
        <h2>Ø³Ø¬Ù„ Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h2>
        <div class="clinic-info">Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© - Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© | Ù‡Ø§ØªÙ: 012-XXXXXXX</div>
      </div>
      
      <div class="modal-header">
        <h2><i class="fas fa-clipboard-list"></i> Ø³Ø¬Ù„ Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h2>
        <button class="close-modal" onclick="closeTrainingLogModal()"><i class="fas fa-times"></i></button>
      </div>

      <div class="filters">
        <div class="range-btns" id="trainRangeBtns"></div>
        <input type="date" id="trainFrom" onchange="applyTrainingFilter()">
        <input type="date" id="trainTo" onchange="applyTrainingFilter()">
        <button class="view-btn" onclick="printTrainingDetails()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
              <th>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
              <th>Ø§Ù„Ù…Ø¯Ø© (Ø¯)</th>
              <th>Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ</th>
              <th>Ø§Ù„Ù…Ø¯Ø±Ø¨</th>
              <th>Ø§Ù„Ø­Ø¶ÙˆØ±</th>
              <th>ØªÙØ§ØµÙŠÙ„</th>
            </tr>
          </thead>
          <tbody id="trainLogBody"></tbody>
        </table>
      </div>
      
      <!-- Print Footer -->
      <div class="print-footer">
        <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <span id="printDateTrain"></span></div>
        <div style="margin-top:5px">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ EOC</div>
      </div>
    </div>
  </div>

  <!-- Reports Log Modal -->
  <div class="modal" id="reportsLogModal">
    <div class="modal-card" style="max-width:1100px">
      <!-- Print Header -->
      <div class="print-header">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹">
        <h1>Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</h1>
        <h2>Ø³Ø¬Ù„ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h2>
        <div class="clinic-info">Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© - Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© | Ù‡Ø§ØªÙ: 012-XXXXXXX</div>
      </div>
      
      <div class="modal-header">
        <h2 style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©</h2>
        <button class="close-modal" onclick="closeReportsLogModal()"><i class="fas fa-times"></i></button>
      </div>

      <div class="filters">
        <div class="range-btns" id="repRangeBtns"></div>
        <input type="date" id="repFrom" onchange="applyReportsFilter()">
        <input type="date" id="repTo" onchange="applyReportsFilter()">
        <select id="repStatus" onchange="applyReportsFilter()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
          <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
          <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
        </select>
        <button class="view-btn" onclick="printTrainingDetails()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="repLogBody"></tbody>
        </table>
      </div>
      
      <!-- Print Footer -->
      <div class="print-footer">
        <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <span id="printDateRep"></span></div>
        <div style="margin-top:5px">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ EOC</div>
      </div>
    </div>
  </div>

  <!-- Training Details Modal -->
  <div class="modal" id="trainingDetailsModal">
    <div class="modal-card" style="max-width:800px">
      <!-- Print Header -->
      <div class="print-header">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹">
        <h1>Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</h1>
        <h2>ØªÙ‚Ø±ÙŠØ± Ø¬Ù„Ø³Ø© ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h2>
        <div class="clinic-info">Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø© - Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© | Ù‡Ø§ØªÙ: 012-XXXXXXX</div>
      </div>
      
      <div class="modal-header">
        <h2><i class="fas fa-info-circle"></i> ØªÙØ§ØµÙŠÙ„ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h2>
        <button class="close-modal" onclick="closeTrainingDetails()"><i class="fas fa-times"></i></button>
      </div>
      <div id="trainingDetailsContent"></div>
      
      <!-- Print Footer -->
      <div class="print-footer">
        <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <span id="printDateDetails"></span></div>
        <div style="margin-top:5px">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ EOC</div>
        <div style="margin-top:8px;font-size:.75rem">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø¨: _________________ | ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù: _________________</div>
      </div>
      
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeTrainingDetails()"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn success" onclick="printTrainingDetails()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>
  </div>

  <script>
    /******************************************************
     * CONFIG
     ******************************************************/
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbytslZrI7jIgUY0iavZPfgOiEPZKgkjFaNgTBCcWByHLARdEFb4Qkzi4Ecad0v_Q7SL1w/exec';

    const SCENARIO_META = {
      fire:    { icon:'fa-fire',          fa:'fas', color:'fire' },
      power:   { icon:'fa-bolt',          fa:'fas', color:'power' },
      water:   { icon:'fa-tint',          fa:'fas', color:'water' },
      injury:  { icon:'fa-heartbeat',     fa:'fas', color:'injury' },
      outbreak:{ icon:'fa-virus',         fa:'fas', color:'outbreak' },
    };

    const TYPE_LABELS_FALLBACK = {
      fire: 'Ø­Ø±ÙŠÙ‚',
      power: 'Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
      water: 'ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡',
      injury: 'Ø¥ØºÙ…Ø§Ø¡/Ø¥ØµØ§Ø¨Ø©',
      outbreak: 'ØªÙØ´ÙŠ Ø¹Ø¯ÙˆÙ‰',
      drill: 'ØªÙ…Ø±ÙŠÙ†'
    };

    const APP = {
      building: { floors: [], muster: [] },
      scenarios: {},        // {key:{key,label,DO[],DONT[]}}
      roster: [],           // [{name,department,role}]
      alerted: new Set(JSON.parse(localStorage.getItem('eoc_alerted_reports') || '[]')),
      currentReport: null,

      // response modal state
      responseType: '',
      selectedLocations: new Set(),
      selectedMuster: '',

      // training state
      train: {
        active: false,
        startMs: 0,
        timer: null,
        scenarioKey: '',
        selectedRoster: new Set(),
      },

      caches: {
        trainingSessions: [],
        reports: [],
      }
    };

    /******************************************************
     * JSONP helper (Apps Script ContentService JSONP)
     ******************************************************/
    function jsonp(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        params.action = action;
        params.callback = cb;

        const s = document.createElement("script");
        s.src = WEB_APP_URL + "?" + new URLSearchParams(params).toString();

        window[cb] = (data) => { cleanup(); resolve(data); };
        s.onerror = () => { cleanup(); reject(new Error("jsonp failed")); };

        function cleanup() {
          try { delete window[cb]; } catch(e) {}
          if (s.parentNode) s.parentNode.removeChild(s);
        }
        document.body.appendChild(s);
      });
    }

    /******************************************************
     * UI helpers
     ******************************************************/
    function toast(message, type='info') {
      const t = document.createElement('div');
      t.className = 'toast ' + (type || '');
      t.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':type==='error'?'fa-triangle-exclamation':type==='warn'?'fa-circle-exclamation':'fa-circle-info'}"></i> ${escapeHtml(message)}`;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 3200);
    }

    function showBigSuccess(message) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:99999;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s';
      overlay.innerHTML = `
        <div style="background:linear-gradient(135deg,#059669,#10b981);color:#fff;padding:40px 50px;border-radius:24px;text-align:center;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,.5);animation:popIn .4s">
          <div style="font-size:4rem;margin-bottom:20px">âœ…</div>
          <div style="font-size:1.4rem;font-weight:900;white-space:pre-line;line-height:1.8">${escapeHtml(message)}</div>
          <button onclick="this.closest('div').parentElement.remove()" style="margin-top:25px;background:#fff;color:#059669;border:0;padding:14px 40px;border-radius:12px;font-weight:900;font-size:1.1rem;cursor:pointer;font-family:Tajawal">
            <i class="fas fa-check"></i> Ø­Ø³Ù†Ø§Ù‹
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
      setTimeout(() => overlay.remove(), 8000);
    }

    function showBigError(message) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:99999;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s';
      overlay.innerHTML = `
        <div style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;padding:40px 50px;border-radius:24px;text-align:center;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,.5);animation:popIn .4s">
          <div style="font-size:4rem;margin-bottom:20px">âŒ</div>
          <div style="font-size:1.2rem;font-weight:900;white-space:pre-line;line-height:1.8">${escapeHtml(message)}</div>
          <button onclick="this.closest('div').parentElement.remove()" style="margin-top:25px;background:#fff;color:#dc2626;border:0;padding:14px 40px;border-radius:12px;font-weight:900;font-size:1.1rem;cursor:pointer;font-family:Tajawal">
            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function escapeHtml(str){
      return String(str || '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    function setStatusAlert(on, label){
      const el = document.getElementById('systemStatus');
      if (!el) return;
      if (on){
        el.classList.add('alert');
        el.innerHTML = `<i class="fas fa-stop-circle"></i><span>${escapeHtml(label || 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦')}</span>`;
      } else {
        el.classList.remove('alert');
        el.innerHTML = `<i class="fas fa-check-circle"></i><span>Ø§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ</span>`;
      }
    }

    /******************************************************
     * Emergency Alarm Sound System
     ******************************************************/
    let alarmAudioCtx = null;
    let alarmOscillator = null;
    let alarmGain = null;
    let alarmInterval = null;

    function playAlarmSound(){
      try {
        // Stop any existing alarm
        stopAlarmSound();

        alarmAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        alarmGain = alarmAudioCtx.createGain();
        alarmGain.connect(alarmAudioCtx.destination);
        alarmGain.gain.value = 0.8;

        let isHigh = true;
        function beep(){
          if (alarmOscillator) {
            try { alarmOscillator.stop(); } catch(e){}
          }
          alarmOscillator = alarmAudioCtx.createOscillator();
          alarmOscillator.type = 'square';
          alarmOscillator.frequency.value = isHigh ? 880 : 440;
          alarmOscillator.connect(alarmGain);
          alarmOscillator.start();
          isHigh = !isHigh;
        }

        beep();
        alarmInterval = setInterval(beep, 500);

        // Ø§Ù„ØµÙˆØª ÙŠØ³ØªÙ…Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº (Ù„Ø§ ÙŠØªÙˆÙ‚Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
      } catch(e){
        console.warn('Could not play alarm:', e);
      }
    }

    function stopAlarmSound(){
      if (alarmInterval) {
        clearInterval(alarmInterval);
        alarmInterval = null;
      }
      if (alarmOscillator) {
        try { alarmOscillator.stop(); } catch(e){}
        alarmOscillator = null;
      }
      if (alarmAudioCtx) {
        try { alarmAudioCtx.close(); } catch(e){}
        alarmAudioCtx = null;
      }
    }

    /******************************************************
     * Active Command Sync & Status Badge Click
     ******************************************************/
    let ACTIVE_CMD_CACHE = null;

    async function syncActiveCommandUI() {
      try {
        const ac = await jsonp('getActiveCommand', {});
        const cmd = (ac && ac.ok) ? ac.command : null;

        if (cmd && (cmd.active === true || String(cmd.active).toLowerCase() === 'true' || String(cmd.active) === '1')) {
          ACTIVE_CMD_CACHE = cmd;

          const isTraining =
            String(cmd.mode || '').toLowerCase() === 'training' ||
            String(cmd.reportType || '').includes('ØªÙ…Ø±ÙŠÙ†') ||
            String(cmd.reportType || '').includes('ğŸ¯');

          setStatusAlert(true, isTraining ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ†' : 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦');
        } else {
          ACTIVE_CMD_CACHE = null;
          setStatusAlert(false);
        }
      } catch (e) {
        console.error('syncActiveCommandUI:', e);
      }
    }

    async function onStatusBadgeClick(){
      try {
        const ac = await jsonp('getActiveCommand', {});
        const cmd = (ac && ac.ok) ? ac.command : null;

        if (!cmd || !(cmd.active === true || String(cmd.active).toLowerCase() === 'true' || String(cmd.active) === '1')) {
          toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'info');
          return;
        }

        const isTraining =
          String(cmd.mode || '').toLowerCase() === 'training' ||
          String(cmd.reportType || '').includes('ØªÙ…Ø±ÙŠÙ†') ||
          String(cmd.reportType || '').includes('ğŸ¯');

        const who = prompt(isTraining ? 'Ø§Ø³Ù… Ù…Ù† ÙŠØ±ÙŠØ¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ†:' : 'Ø§Ø³Ù… Ù…Ù† ÙŠØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:');
        if (!who) return;
        const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || '';

        const res = await jsonp('closeActiveCommand', {
          closedBy: who,
          closeReason: reason
        });

        if (!res || !res.ok) throw new Error(res?.error || 'closeActiveCommand failed');

        stopAlarmSound();
        toast(isTraining ? 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ…Ø±ÙŠÙ†' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', 'success');
        await syncActiveCommandUI();
        await refreshLists();
      } catch (e) {
        console.error(e);
        toast('ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© closeActiveCommand ÙÙŠ Apps Script', 'error');
      }
    }

    function fmtYMD(d){
      const x = new Date(d);
      const y = x.getFullYear();
      const m = String(x.getMonth()+1).padStart(2,'0');
      const day = String(x.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function nowYMD(){
      return fmtYMD(new Date());
    }

    function setRangeInputs(fromId, toId, daysBack){
      const to = new Date();
      const from = new Date();
      from.setDate(from.getDate() - daysBack);
      document.getElementById(fromId).value = fmtYMD(from);
      document.getElementById(toId).value = fmtYMD(to);
    }

    function buildRangeButtons(containerId, onPick){
      const host = document.getElementById(containerId);
      const presets = [
        {k:'today', label:'Ø§Ù„ÙŠÙˆÙ…', days:0},
        {k:'7d', label:'7 Ø£ÙŠØ§Ù…', days:6},
        {k:'14d', label:'14 ÙŠÙˆÙ…', days:13},
        {k:'1m', label:'Ø´Ù‡Ø±', days:29},
        {k:'2m', label:'Ø´Ù‡Ø±ÙŠÙ†', days:59},
      ];
      host.innerHTML = presets.map(p=>`<button class="chip" data-k="${p.k}">${p.label}</button>`).join('');
      host.querySelectorAll('.chip').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          host.querySelectorAll('.chip').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          onPick(presets.find(x=>x.k===btn.dataset.k));
        });
      });
      // default: 14d
      const def = host.querySelector('[data-k="14d"]');
      if (def){ def.click(); }
    }

    function scenarioLabel(key){
      const s = APP.scenarios[key];
      if (s && s.label) return s.label;
      return TYPE_LABELS_FALLBACK[key] || key;
    }

    function faIcon(icon){
      // icon might be like "fa-bolt" or already "fas fa-bolt"
      const s = String(icon||'').trim();
      if (!s) return 'fas fa-circle-info';
      if (s.includes('fa ' ) || s.startsWith('fas ') || s.startsWith('far ') || s.startsWith('fa-solid ')) return s;
      if (s.startsWith('fa-')) return 'fas ' + s;
      return 'fas ' + s;
    }

    /******************************************************
     * Load data from Sheets (Excel) - building/scenarios/roster
     ******************************************************/
    async function loadCoreData(){
      try{
        const [b, sg, ro] = await Promise.all([
          jsonp('getBuildingConfig', {}),
          jsonp('getScenarioGuides', {}),
          jsonp('getTrainingRoster', {}),
        ]);

        if (b && b.ok){
          APP.building.floors = Array.isArray(b.floors) ? b.floors : [];
          APP.building.muster = Array.isArray(b.muster) ? b.muster : [];
        }

        if (sg && sg.ok && sg.scenarios){
          APP.scenarios = sg.scenarios;
          // update labels in UI
          ['fire','power','water','injury','outbreak'].forEach(k=>{
            const lbl = scenarioLabel(k);
            const a = document.getElementById('lbl_'+k);
            const b = document.getElementById('btn_'+k);
            const t = document.getElementById('t_'+k);
            if (a) a.textContent = lbl;
            if (b) b.textContent = lbl;
            if (t) t.textContent = lbl;
          });
        }

        if (ro && ro.ok){
          APP.roster = Array.isArray(ro.roster) ? ro.roster : [];
        }

        renderBuilding();
        renderMuster();
        renderRoster();
        populateTrainerDropdown();

        // default show fire guide
        showScenarioGuide('fire');

      } catch(e){
        console.error(e);
        toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø£Ø³Ø§Ø³ÙŠØ©.', 'warn');
        // fallback minimal render
        renderBuildingFallback();
        renderMusterFallback();
        renderRosterFallback();
      }
    }

    function renderBuilding(){
      const host = document.getElementById('buildingView');
      if (!host) return;

      if (!APP.building.floors || APP.building.floors.length === 0){
        renderBuildingFallback();
        return;
      }

      host.innerHTML = APP.building.floors.map(f=>{
        const deptHtml = (f.departments||[]).map(d=>{
          return `
            <div class="dept-card" data-dept="${escapeHtml(d.name)}" data-id="${escapeHtml(d.id)}" onclick="selectDept(event,'${escapeHtml(d.id)}')">
              <i class="${faIcon(d.icon)}"></i>
              ${escapeHtml(d.name)}
            </div>
          `;
        }).join('');

        return `
          <div class="floor" data-floor="${escapeHtml(f.floorKey)}" onclick="selectFloor('${escapeHtml(f.floorKey)}')">
            <div class="floor-header">
              <div class="floor-name">
                <div class="floor-icon"><i class="fas fa-layer-group"></i></div>
                <span>${escapeHtml(f.floorName)}</span>
              </div>
              <span class="floor-status">Ø¢Ù…Ù†</span>
            </div>
            <div class="departments-grid">${deptHtml}</div>
          </div>
        `;
      }).join('');
    }

    function renderBuildingFallback(){
      const host = document.getElementById('buildingView');
      if (!host) return;
      host.innerHTML = `
        <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ù†Ù‰ Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ (EOC_MAP).
        </div>
      `;
    }

    function renderMuster(){
      const host = document.getElementById('musterPoints');
      if (!host) return;

      if (!APP.building.muster || APP.building.muster.length === 0){
        renderMusterFallback();
        return;
      }

      host.innerHTML = APP.building.muster.map(m=>{
        return `
          <div class="muster-card" data-key="${escapeHtml(m.key)}">
            <i class="fas fa-map-marker-alt"></i>
            <h4>${escapeHtml(m.name)}</h4>
            <p>${escapeHtml(m.desc || '')}</p>
          </div>
        `;
      }).join('');
    }

    function renderMusterFallback(){
      const host = document.getElementById('musterPoints');
      if (!host) return;
      host.innerHTML = `
        <div class="muster-card" data-key="A">
          <i class="fas fa-map-marker-alt"></i><h4>Ù†Ù‚Ø·Ø© ØªØ¬Ù…Ø¹ A</h4><p>Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ</p>
        </div>
        <div class="muster-card" data-key="B">
          <i class="fas fa-map-marker-alt"></i><h4>Ù†Ù‚Ø·Ø© ØªØ¬Ù…Ø¹ B</h4><p>Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</p>
        </div>
      `;
    }

    function renderRoster(){
      const host = document.getElementById('rosterList');
      if (!host) return;

      if (!APP.roster || APP.roster.length === 0){
        renderRosterFallback();
        return;
      }

      host.innerHTML = APP.roster.map((p, idx)=>{
        const id = 'r_' + idx;
        const selected = APP.train.selectedRoster.has(id);
        return `
          <div class="mini-item" style="cursor:pointer;border-color:${selected?'rgba(16,185,129,.55)':'rgba(255,255,255,.1)'};background:${selected?'rgba(16,185,129,.12)':'rgba(255,255,255,.05)'}" onclick="toggleRoster('${id}')">
            <div class="mini-row">
              <div style="display:flex;align-items:center;gap:10px">
                <span style="width:22px;height:22px;border-radius:6px;border:2px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;background:${selected?'rgba(16,185,129,.9)':'transparent'}">
                  ${selected?'<i class="fas fa-check" style="font-size:.8rem"></i>':''}
                </span>
                <div>
                  <div style="font-weight:1000">${escapeHtml(p.name || '')}</div>
                  <div style="opacity:.75;font-weight:800;font-size:.85rem">${escapeHtml(p.department || '')}${p.role?(' â€¢ '+escapeHtml(p.role)):""}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      updateRosterCount();
    }

    function renderRosterFallback(){
      const host = document.getElementById('rosterList');
      if (!host) return;
      host.innerHTML = `
        <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù…Ù† Ø§Ù„Ø¥ÙƒØ³Ù„ (Training_Roster).
        </div>
      `;
      updateRosterCount();
    }

    /******************************************************
     * Building interactions
     ******************************************************/
    function selectFloor(floorKey){
      document.querySelectorAll('.floor').forEach(f=>f.classList.remove('active'));
      const el = document.querySelector(`.floor[data-floor="${CSS.escape(String(floorKey))}"]`);
      if (el) el.classList.add('active');
    }

    function selectDept(ev, deptId){
      ev.stopPropagation();
      document.querySelectorAll('.dept-card').forEach(d=>d.classList.remove('selected'));
      const card = ev.currentTarget;
      if (card) card.classList.add('selected');
    }

    function highlightLocation(text){
      document.querySelectorAll('.dept-card').forEach(d=>d.classList.remove('emergency-highlight'));
      const t = String(text||'').trim();
      if (!t) return;

      document.querySelectorAll('.dept-card').forEach(card=>{
        const label = card.textContent.trim();
        if (label && t.includes(label)){
          card.classList.add('emergency-highlight');
          card.scrollIntoView({behavior:'smooth',block:'center'});
        }
      });
    }

    /******************************************************
     * Scenario guide
     ******************************************************/
    function showScenarioGuide(key){
      document.querySelectorAll('.scenario-icon').forEach(x=>x.classList.remove('active'));
      const btn = document.querySelector(`.scenario-icon[data-s="${CSS.escape(key)}"]`);
      if (btn) btn.classList.add('active');

      const wrap = document.getElementById('guideWrap');
      const title = document.getElementById('guideTitle');
      const doBox = document.getElementById('guideDo');
      const dontBox = document.getElementById('guideDont');

      const s = APP.scenarios[key];
      const lbl = scenarioLabel(key);

      title.innerHTML = `<i class="fas ${SCENARIO_META[key]?.icon || 'fa-circle-info'}"></i> ${escapeHtml(lbl)}`;

      const DO = (s && s.DO) ? s.DO : [];
      const DONT = (s && s.DONT) ? s.DONT : [];

      doBox.innerHTML = DO.length ? DO.map(step=>`
        <div class="guide-step">
          <div class="num">${escapeHtml(step.stepNo)}</div>
          <i class="${faIcon(step.icon)}"></i>
          <div class="txt">${escapeHtml(step.text)}</div>
        </div>
      `).join('') : `<div style="opacity:.85;font-weight:900">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ§Øª (DO) ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„.</div>`;

      dontBox.innerHTML = DONT.length ? DONT.map(step=>`
        <div class="guide-step">
          <div class="num">${escapeHtml(step.stepNo)}</div>
          <i class="${faIcon(step.icon)}"></i>
          <div class="txt">${escapeHtml(step.text)}</div>
        </div>
      `).join('') : `<div style="opacity:.85;font-weight:900">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ§Øª (DON'T) ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„.</div>`;

      wrap.classList.add('active');
    }

    /******************************************************
     * Activation flow (manual start = same as real report)
     ******************************************************/
    function openActivationModal(){ document.getElementById('activationModal').classList.add('active'); }
    function closeActivationModal(){ document.getElementById('activationModal').classList.remove('active'); }

    function manualStart(type){
      closeActivationModal();

      const isDrill = (type === 'drill');
      const scenarioKey = isDrill ? (APP.train.scenarioKey || 'fire') : type;

      // pseudo-report object (same flow as real report)
      const report = {
        id: 'MANUAL-' + Date.now(),
        date: nowYMD(),
        time: new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
        type: isDrill ? ('ğŸ¯ ØªÙ…Ø±ÙŠÙ† - ' + scenarioLabel(scenarioKey)) : scenarioLabel(scenarioKey),
        location: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±',
        notes: isDrill ? 'ØªÙ…Ø±ÙŠÙ† Ù…ÙÙØ¹Ù‘Ù„ Ù…Ù† EOC' : 'ØªÙØ¹ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ù† EOC',
        status: 'Ø¬Ø¯ÙŠØ¯',
        isDrill,
        scenarioKey
      };

      openResponseForReport(report, true);
    }

    /******************************************************
     * Response modal
     ******************************************************/
    function openResponseForReport(report, isManual=false){
      APP.currentReport = report;
      APP.responseType = '';
      APP.selectedLocations = new Set();
      APP.selectedMuster = '';

      document.getElementById('rmType').textContent = report.type || '-';
      document.getElementById('rmLocation').textContent = report.location || '-';
      document.getElementById('rmNotes').textContent = report.notes || '-';
      document.getElementById('rmId').textContent = report.id || '-';

      document.querySelectorAll('.rtype-btn').forEach(b=>{
        b.classList.remove('selected','full','team','iso');
      });

      document.getElementById('locationBlock').style.display = 'none';
      document.getElementById('musterBlock').style.display = 'none';
      document.getElementById('locationGrid').innerHTML = '';
      document.getElementById('musterGrid').innerHTML = '';
      document.getElementById('customLocation').value = '';

      document.getElementById('issueBtn').disabled = true;

      // helpful highlight
      highlightLocation(report.location);

      document.getElementById('responseModal').classList.add('active');
    }

    function closeResponseModal(){
      document.getElementById('responseModal').classList.remove('active');
    }

    function selectResponseType(rt){
      APP.responseType = rt;

      document.querySelectorAll('.rtype-btn').forEach(b=>{
        b.classList.remove('selected','full','team','iso');
      });
      const btn = document.querySelector(`.rtype-btn[data-rt="${CSS.escape(rt)}"]`);
      if (btn){
        btn.classList.add('selected');
        if (rt==='full_evacuation') btn.classList.add('full');
        if (rt==='send_team') btn.classList.add('team');
        if (rt==='isolation_evacuation') btn.classList.add('iso');
      }

      // build location options dynamically from building config
      const locGrid = document.getElementById('locationGrid');
      const options = [];

      // always include "Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº" if real report and has location
      options.push({ id:'report_location', label:'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº', icon:'fa-location-dot' });
      // building
      options.push({ id:'building', label:'Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', icon:'fa-building' });

      // floors
      (APP.building.floors||[]).forEach(f=>{
        options.push({ id:'floor_'+f.floorKey, label:f.floorName, icon:'fa-layer-group' });
      });

      locGrid.innerHTML = options.map(o=>`
        <button type="button" class="loc-btn" data-loc="${escapeHtml(o.id)}" onclick="toggleLocation('${escapeHtml(o.id)}')">
          <i class="fas ${escapeHtml(o.icon)}"></i> ${escapeHtml(o.label)}
        </button>
      `).join('');

      // muster required for evac + isolation
      const needsMuster = (rt === 'full_evacuation' || rt === 'isolation_evacuation');

      document.getElementById('locationBlock').style.display = 'block';
      document.getElementById('musterBlock').style.display = needsMuster ? 'block' : 'none';

      if (needsMuster){
        renderMusterChoices();
      }

      updateIssueButtonState();
    }

    function toggleLocation(locId){
      const id = String(locId);
      const btn = document.querySelector(`.loc-btn[data-loc="${CSS.escape(id)}"]`);
      if (APP.selectedLocations.has(id)){
        APP.selectedLocations.delete(id);
        if (btn) btn.classList.remove('selected');
      } else {
        APP.selectedLocations.add(id);
        if (btn) btn.classList.add('selected');
      }
      updateIssueButtonState();
    }

    function renderMusterChoices(){
      const host = document.getElementById('musterGrid');
      const ms = (APP.building.muster && APP.building.muster.length) ? APP.building.muster : [
        {key:'A',name:'Ù†Ù‚Ø·Ø© ØªØ¬Ù…Ø¹ A',desc:'Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ'},
        {key:'B',name:'Ù†Ù‚Ø·Ø© ØªØ¬Ù…Ø¹ B',desc:'Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©'},
      ];

      host.innerHTML = ms.map(m=>`
        <button type="button" class="muster-btn" data-m="${escapeHtml(m.key)}" onclick="selectMuster('${escapeHtml(m.key)}')">
          <i class="fas fa-map-marker-alt"></i> ${escapeHtml(m.name)}
        </button>
      `).join('');
    }

    function selectMuster(key){
      APP.selectedMuster = String(key);
      document.querySelectorAll('.muster-btn').forEach(b=>b.classList.remove('selected'));
      const btn = document.querySelector(`.muster-btn[data-m="${CSS.escape(APP.selectedMuster)}"]`);
      if (btn) btn.classList.add('selected');
      updateIssueButtonState();
    }

    function updateIssueButtonState(){
      const issue = document.getElementById('issueBtn');
      if (!issue) return;

      if (!APP.responseType){
        issue.disabled = true;
        return;
      }

      const custom = document.getElementById('customLocation').value.trim();
      const hasLocation = APP.selectedLocations.size > 0 || !!custom;

      const needsMuster = (APP.responseType === 'full_evacuation' || APP.responseType === 'isolation_evacuation');
      const hasMuster = !needsMuster || !!APP.selectedMuster;

      issue.disabled = !(hasLocation && hasMuster);
    }

    function resolveLocationLabel(locId){
      if (locId === 'report_location') return APP.currentReport?.location || 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù„Ø§Øº';
      if (locId === 'building') return 'Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
      if (locId.startsWith('floor_')){
        const k = locId.replace('floor_','');
        const f = (APP.building.floors||[]).find(x=>String(x.floorKey)===String(k));
        return f ? f.floorName : ('Ø§Ù„Ø¯ÙˆØ± ' + k);
      }
      return locId;
    }

    function resolveMusterLabel(key){
      const m = (APP.building.muster||[]).find(x=>String(x.key)===String(key));
      if (m) return `${m.name}${m.desc ? ' - ' + m.desc : ''}`;
      return key;
    }

    async function issueCommand(){
      const report = APP.currentReport;
      if (!report) return;

      const custom = document.getElementById('customLocation').value.trim();
      const locParts = Array.from(APP.selectedLocations).map(resolveLocationLabel);
      if (custom) locParts.push(custom);

      const location = locParts.join(' + ');
      const muster = APP.selectedMuster ? resolveMusterLabel(APP.selectedMuster) : '';

      // determine scenarioKey for reports
      const scenarioKey = report.scenarioKey || scenarioKeyFromReportType(report.type) || 'fire';
      const scenarioLabel = scenarioLabelFromReportType(report.type) || scenarioLabel(scenarioKey);

      const mode = report.isDrill ? 'training' : 'real';

      const cmd = {
        responseType: APP.responseType,
        reportType: report.type,
        location,
        muster,
        mode,
        scenarioKey,
        scenarioLabel
      };

      try{
        const res = await jsonp('setActiveCommand', cmd);
        if (!res || !res.ok) throw new Error(res?.error || 'setActiveCommand failed');

        // update report status only for real EMR reports
        if (!report.id.startsWith('MANUAL-') && !report.isDrill){
          await safeUpdateReportStatus(report.id, 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'EOC', 'ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø£Ù…Ø±: ' + APP.responseType);
        }

        closeResponseModal();
        openCommandScreen(cmd, report);
        toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        setStatusAlert(true, report.isDrill ? 'ğŸ¯ ØªÙ…Ø±ÙŠÙ† Ø¬Ø§Ø±ÙŠ' : 'Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦!');

      } catch(e){
        console.error(e);
        toast('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø´Ø§Ø´Ø§Øª: ' + (e.message || ''), 'error');
      }
    }

    function openCommandScreen(cmd, report){
      // title by response type
      const map = {
        full_evacuation: {t:'Ø¥Ø®Ù„Ø§Ø¡', i:'fa-running'},
        send_team: {t:'ØªÙˆØ¬ÙŠÙ‡ ÙØ±ÙŠÙ‚', i:'fa-users'},
        isolation_evacuation: {t:'Ø¹Ø²Ù„', i:'fa-shield-virus'}
      };
      const x = map[cmd.responseType] || {t:'Ø£Ù…Ø±', i:'fa-bullhorn'};

      document.getElementById('cmdTitle').innerHTML = `<i class="fas ${x.i}"></i> ${escapeHtml(x.t)}`;
      document.getElementById('cmdReportType').textContent = cmd.reportType || '-';
      document.getElementById('cmdLocation').textContent = cmd.location || '-';

      const mw = document.getElementById('cmdMusterWrap');
      if (cmd.muster){
        mw.style.display = 'block';
        document.getElementById('cmdMuster').textContent = cmd.muster;
      } else {
        mw.style.display = 'none';
      }

      window.__CMD_STATE__ = {
        startedAt: Date.now(),
        reportId: report?.id || '',
        isDrill: !!report?.isDrill,
        timer: null
      };

      const timerEl = document.getElementById('cmdTimer');
      timerEl.textContent = '00:00';
      if (window.__CMD_STATE__.timer) clearInterval(window.__CMD_STATE__.timer);
      window.__CMD_STATE__.timer = setInterval(()=>{
        const diff = Math.floor((Date.now() - window.__CMD_STATE__.startedAt)/1000);
        const mm = String(Math.floor(diff/60)).padStart(2,'0');
        const ss = String(diff%60).padStart(2,'0');
        timerEl.textContent = `${mm}:${ss}`;
      }, 1000);

      document.getElementById('commandScreen').classList.add('active');
    }

    async function endCommand(clearRemote){
      // close modal
      document.getElementById('commandScreen').classList.remove('active');

      try{
        if (window.__CMD_STATE__ && window.__CMD_STATE__.timer){
          clearInterval(window.__CMD_STATE__.timer);
        }
      } catch(e){}

      if (!clearRemote) return;

      try{
        const res = await jsonp('clearActiveCommand', {});
        if (!res || !res.ok) throw new Error(res?.error || 'clearActiveCommand failed');

        // if there was a real report, close it
        const st = window.__CMD_STATE__ || {};
        if (st.reportId && !String(st.reportId).startsWith('MANUAL-') && !st.isDrill){
          await safeUpdateReportStatus(st.reportId, 'Ù…ØºÙ„Ù‚', 'EOC', 'ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø£Ù…Ø±');
        }

        setStatusAlert(false);
        toast('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø£Ù…Ø± ÙˆÙ…Ø³Ø­Ù‡ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø§Øª', 'success');
        await refreshLists();
      } catch(e){
        console.error(e);
        toast('ØªØ¹Ø°Ø± Ù…Ø³Ø­ Ø§Ù„Ø£Ù…Ø± Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø§Øª', 'error');
      }
    }

    function scenarioKeyFromReportType(type){
      const t = String(type||'');
      if (t.includes('Ø­Ø±ÙŠÙ‚')) return 'fire';
      if (t.includes('ÙƒÙ‡Ø±Ø¨Ø§Ø¡')) return 'power';
      if (t.includes('Ù…ÙŠØ§Ù‡')) return 'water';
      if (t.includes('Ø¥ØºÙ…Ø§Ø¡') || t.includes('Ø¥ØµØ§Ø¨Ø©')) return 'injury';
      if (t.includes('Ø¹Ø¯ÙˆÙ‰')) return 'outbreak';
      if (t.includes('ØªÙ…Ø±ÙŠÙ†')) return 'fire';
      return 'fire';
    }
    function scenarioLabelFromReportType(type){
      // if reportType already Arabic label, keep it
      return String(type||'').replace('ğŸ¯','').trim();
    }

    /******************************************************
     * Reports (real) polling
     ******************************************************/
    async function fetchEmergencyReports(limit=30){
      const res = await jsonp('getEmergencyReports', { limit: String(limit) });
      if (!res || !res.ok) throw new Error(res?.error || 'getEmergencyReports failed');
      return Array.isArray(res.reports) ? res.reports : [];
    }

    async function safeUpdateReportStatus(reportId, status, responder, actionNotes){
      // doGet action name is updateEmergencyStatus in your script
      const res = await jsonp('updateEmergencyStatus', {
        reportId: String(reportId),
        status: String(status),
        responder: String(responder || ''),
        actionNotes: String(actionNotes || '')
      });
      if (!res || !res.ok) throw new Error(res?.error || 'updateEmergencyStatus failed');
      return res;
    }

    function statusPillClass(s){
      const t = String(s||'').trim();
      if (t === 'Ø¬Ø¯ÙŠØ¯') return 'new';
      if (t === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©') return 'pending';
      if (t === 'Ù…ØºÙ„Ù‚') return 'closed';
      return 'pending';
    }

    async function pollReports(){
      try{
        const reports = await fetchEmergencyReports(60);
        APP.caches.reports = reports;

        // detect new
        const newOnes = reports.filter(r=> String(r.status||'')==='Ø¬Ø¯ÙŠØ¯' && !APP.alerted.has(String(r.id)));
        if (newOnes.length){
          newOnes.forEach(r=>APP.alerted.add(String(r.id)));
          localStorage.setItem('eoc_alerted_reports', JSON.stringify(Array.from(APP.alerted)));

          const r = newOnes[0];
          // alert with loud sound
          playAlarmSound();
          toast('ğŸš¨ Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦ Ø¬Ø¯ÙŠØ¯: ' + (r.type || ''), 'error');
          highlightLocation(r.location);

          // open response flow
          const report = {
            id: String(r.id||''),
            date: String(r.date||''),
            time: String(r.time||''),
            type: String(r.type||''),
            location: String(r.location||''),
            notes: String(r.notes||''),
            status: String(r.status||'Ø¬Ø¯ÙŠØ¯'),
            isDrill: false,
            scenarioKey: scenarioKeyFromReportType(r.type)
          };
          openResponseForReport(report);
        }

        renderMiniReports();
      } catch(e){
        console.error(e);
        // do not spam
      }
    }

    function renderMiniReports(){
      const host = document.getElementById('miniReportsList');
      if (!host) return;

      const list = (APP.caches.reports || []).slice(0,10);
      if (!list.length){
        host.innerHTML = `<div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª</div>`;
        return;
      }

      host.innerHTML = list.map(r=>{
        const st = String(r.status||'Ø¬Ø¯ÙŠØ¯');
        return `
          <div class="mini-item">
            <div class="mini-row">
              <div style="font-weight:1000"><i class="fas ${getReportIcon(r.type)}" style="color:var(--secondary)"></i> ${escapeHtml(r.type||'')}</div>
              <span class="pill ${statusPillClass(st)}">${escapeHtml(st)}</span>
            </div>
            <div style="margin-top:6px;opacity:.85;font-weight:800">
              <i class="fas fa-map-marker-alt"></i> ${escapeHtml(r.location||'')}
            </div>
            <div style="margin-top:4px;opacity:.75;font-weight:800;font-size:.9rem">
              <i class="fas fa-clock"></i> ${escapeHtml(r.date||'')} - ${escapeHtml(r.time||'')}
            </div>
          </div>
        `;
      }).join('');
    }

    function getReportIcon(type){
      const t = String(type||'');
      if (t.includes('Ø­Ø±ÙŠÙ‚')) return 'fa-fire';
      if (t.includes('ÙƒÙ‡Ø±Ø¨Ø§Ø¡')) return 'fa-bolt';
      if (t.includes('Ù…ÙŠØ§Ù‡')) return 'fa-tint';
      if (t.includes('Ø¥ØºÙ…Ø§Ø¡') || t.includes('Ø¥ØµØ§Ø¨Ø©')) return 'fa-heartbeat';
      if (t.includes('Ø¹Ø¯ÙˆÙ‰')) return 'fa-virus';
      return 'fa-triangle-exclamation';
    }

    /******************************************************
     * Training sessions (log)
     ******************************************************/
    function toYMD(value){
      if (!value) return '';
      const s = String(value).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(value);
      if (!isNaN(d.getTime())){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }
      return s;
    }

    async function fetchTrainingSessions(limit=250){
      const res = await jsonp('getTrainingSessions', { limit:String(limit) });
      if (!res || !res.ok) throw new Error(res?.error || 'getTrainingSessions failed');
      const sessions = Array.isArray(res.sessions) ? res.sessions : [];
      return sessions.map(s => ({
        ...s,
        _dateYMD: toYMD(s.date),
      }));
    }

    async function refreshMiniTraining(){
      try{
        const list = await fetchTrainingSessions(30);
        APP.caches.trainingSessions = list;
        renderMiniTraining();
      } catch(e){
        console.error(e);
        document.getElementById('miniTrainingList').innerHTML =
          `<div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>`;
      }
    }

    function renderMiniTraining(){
      const host = document.getElementById('miniTrainingList');
      const list = (APP.caches.trainingSessions||[]).slice(0,10);
      if (!list.length){
        host.innerHTML = `<div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª</div>`;
        return;
      }
      host.innerHTML = list.map(s=>{
        const label = s.scenarioLabel || scenarioLabel(s.scenarioKey) || '-';
        const dur = (s.durationMin!=null) ? String(s.durationMin) : '';
        return `
          <div class="mini-item">
            <div class="mini-row">
              <div style="font-weight:1000"><i class="fas fa-clipboard-check" style="color:var(--secondary)"></i> ${escapeHtml(label)}</div>
              <span class="pill closed">${escapeHtml(dur ? (dur+' Ø¯') : '')}</span>
            </div>
            <div style="margin-top:6px;opacity:.85;font-weight:800">
              <i class="fas fa-user-tie"></i> ${escapeHtml(s.trainer||'-')}
            </div>
            <div style="margin-top:4px;opacity:.75;font-weight:800;font-size:.9rem">
              <i class="fas fa-clock"></i> ${escapeHtml(s._dateYMD || toYMD(s.date) || '')} - ${escapeHtml(s.startTime||'')}
            </div>
          </div>
        `;
      }).join('');
    }

    /******************************************************
     * Training modal logic
     ******************************************************/
    function openTrainingModal(){
      APP.train.active = true;
      APP.train.startMs = Date.now();
      APP.train.scenarioKey = '';
      APP.train.selectedRoster = new Set();

      updateTrainingTimer(true);
      APP.train.timer = setInterval(()=>updateTrainingTimer(false), 1000);

      // reset UI
      document.getElementById('trainerName').value = '';
      document.getElementById('trainingGuide').style.display = 'none';
      document.querySelectorAll('#trainScenarioIcons .scenario-icon').forEach(x=>x.classList.remove('active'));

      renderRoster(); // refresh selection state
      updateTrainingSaveState();

      document.getElementById('trainingModal').classList.add('active');
    }

    function closeTrainingModal(){
      document.getElementById('trainingModal').classList.remove('active');
      APP.train.active = false;
      if (APP.train.timer) clearInterval(APP.train.timer);
      APP.train.timer = null;
      APP.train.startMs = 0;
      APP.train.scenarioKey = '';
      APP.train.selectedRoster = new Set();
      updateRosterCount();
    }

    function updateTrainingTimer(reset){
      if (!APP.train.active) return;
      const elapsed = Math.floor((Date.now() - APP.train.startMs)/1000);
      const hh = String(Math.floor(elapsed/3600)).padStart(2,'0');
      const mm = String(Math.floor((elapsed%3600)/60)).padStart(2,'0');
      const ss = String(elapsed%60).padStart(2,'0');
      document.getElementById('trainTimer').textContent = `${hh}:${mm}:${ss}`;
    }

    function toggleRoster(id){
      if (APP.train.selectedRoster.has(id)) APP.train.selectedRoster.delete(id);
      else APP.train.selectedRoster.add(id);
      renderRoster();
      updateTrainingSaveState();
    }

    function updateRosterCount(){
      const c = document.getElementById('rosterCount');
      if (c) c.textContent = String(APP.train.selectedRoster.size || 0);
    }

    function selectTrainingScenario(key){
      APP.train.scenarioKey = key;
      document.querySelectorAll('#trainScenarioIcons .scenario-icon').forEach(x=>x.classList.remove('active'));
      const el = document.querySelector(`#trainScenarioIcons .scenario-icon[data-s="${CSS.escape(key)}"]`);
      if (el) el.classList.add('active');

      // render guide
      const s = APP.scenarios[key] || null;
      const title = document.getElementById('trainingGuideTitle');
      const doBox = document.getElementById('trainingDo');
      const dontBox = document.getElementById('trainingDont');

      title.innerHTML = `<i class="fas ${SCENARIO_META[key]?.icon || 'fa-circle-info'}"></i> ${escapeHtml('ØªÙ…Ø±ÙŠÙ†: ' + scenarioLabel(key))}`;
      const DO = (s && s.DO) ? s.DO : [];
      const DONT = (s && s.DONT) ? s.DONT : [];

      doBox.innerHTML = DO.length ? DO.map(step=>`
        <div class="guide-step">
          <div class="num">${escapeHtml(step.stepNo)}</div>
          <i class="${faIcon(step.icon)}"></i>
          <div class="txt">${escapeHtml(step.text)}</div>
        </div>
      `).join('') : `<div style="opacity:.85;font-weight:900">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ§Øª (DO).</div>`;

      dontBox.innerHTML = DONT.length ? DONT.map(step=>`
        <div class="guide-step">
          <div class="num">${escapeHtml(step.stepNo)}</div>
          <i class="${faIcon(step.icon)}"></i>
          <div class="txt">${escapeHtml(step.text)}</div>
        </div>
      `).join('') : `<div style="opacity:.85;font-weight:900">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ§Øª (DON'T).</div>`;

      document.getElementById('trainingGuide').style.display = 'block';
      updateTrainingSaveState();
    }

    function updateTrainingSaveState(){
      updateRosterCount();
      const trainer = getSelectedTrainer();
      const can = !!APP.train.scenarioKey && APP.train.selectedRoster.size>0 && !!trainer;
      document.getElementById('saveTrainingBtn').disabled = !can;
    }

    function getSelectedTrainer(){
      const sel = document.getElementById('trainerSelect');
      const inp = document.getElementById('trainerName');
      if (sel.value === '__external__') {
        return inp.value.trim();
      }
      return sel.value;
    }

    function onTrainerSelectChange(){
      const sel = document.getElementById('trainerSelect');
      const inp = document.getElementById('trainerName');
      if (sel.value === '__external__') {
        inp.style.display = 'block';
        inp.focus();
      } else {
        inp.style.display = 'none';
        inp.value = '';
      }
      updateTrainingSaveState();
    }

    function populateTrainerDropdown(){
      const sel = document.getElementById('trainerSelect');
      sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø¨ --</option>';
      
      // Add staff from roster
      APP.roster.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name + (p.department ? ' - ' + p.department : '');
        sel.appendChild(opt);
      });
      
      // Add external trainer option
      const extOpt = document.createElement('option');
      extOpt.value = '__external__';
      extOpt.textContent = 'ğŸ‘¤ Ù…Ø¯Ø±Ø¨ Ø®Ø§Ø±Ø¬ÙŠ (Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…)';
      extOpt.style.fontWeight = '900';
      sel.appendChild(extOpt);
    }

    async function broadcastTrainingToScreens(){
      if (!APP.train.scenarioKey){
        toast('Ø§Ø®ØªØ± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø£ÙˆÙ„Ø§Ù‹', 'warn');
        return;
      }
      const btn = event?.target?.closest('button');
      const originalHTML = btn ? btn.innerHTML : '';
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
      }
      
      const trainer = getSelectedTrainer() || 'TRAINER';
      const payload = {
        responseType: 'training',
        reportType: 'ğŸ¯ ØªÙ…Ø±ÙŠÙ† - ' + scenarioLabel(APP.train.scenarioKey),
        location: 'ØªØ¯Ø±ÙŠØ¨ Ø¹Ù…Ù„ÙŠ - Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª',
        muster: '',
        mode: 'training',
        scenarioKey: APP.train.scenarioKey,
        scenarioLabel: scenarioLabel(APP.train.scenarioKey),
        trainer: trainer
      };
      try{
        const r = await jsonp('setActiveCommand', payload);
        if (!r || !r.ok) throw new Error(r?.error || 'setActiveCommand failed');
        showBigSuccess('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ğŸ“º');
        setStatusAlert(true, 'ğŸ¯ ØªÙ…Ø±ÙŠÙ† Ø¬Ø§Ø±ÙŠ');
      } catch(e){
        console.error(e);
        toast('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ† Ù„Ù„Ø´Ø§Ø´Ø§Øª', 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      }
    }

    async function stopTrainingOnScreens(){
      const btn = event?.target?.closest('button');
      const originalHTML = btn ? btn.innerHTML : '';
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù...';
      }
      
      try{
        const ac = await jsonp('getActiveCommand', {});
        const cmd = (ac && ac.ok) ? ac.command : null;
        if (!cmd) {
          toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ù…Ø± Ù†Ø´Ø·', 'warn');
          return;
        }
        if (String(cmd.mode || '').toLowerCase() !== 'training'){
          toast('Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù†Ø´Ø· Ù„ÙŠØ³ ØªÙ…Ø±ÙŠÙ†Ù‹Ø§ (Ù„Ù† ÙŠØªÙ… Ù…Ø³Ø­Ù‡ Ù‡Ù†Ø§)', 'warn');
          return;
        }
        const r = await jsonp('clearActiveCommand', {});
        if (!r || !r.ok) throw new Error(r?.error || 'clearActiveCommand failed');
        showBigSuccess('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¹Ø±Ø¶ Ø§Ù„ØªÙ…Ø±ÙŠÙ†! â¹ï¸');
        setStatusAlert(false);
        await syncActiveCommandUI();
      } catch(e){
        console.error(e);
        toast('ØªØ¹Ø°Ø± Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø±Ø¶', 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      }
    }

    async function saveTrainingSession(){
      const trainer = getSelectedTrainer();
      if (!APP.train.scenarioKey || !trainer || APP.train.selectedRoster.size===0){
        toast('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨', 'error');
        return;
      }

      const btn = document.getElementById('saveTrainingBtn');
      const originalHTML = btn ? btn.innerHTML : '';
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
      }

      const attendees = Array.from(APP.train.selectedRoster).map(id=>{
        const idx = Number(String(id).replace('r_',''));
        const p = APP.roster[idx];
        return p ? p.name : '';
      }).filter(Boolean).join('ØŒ ');

      const now = new Date();
      const start = new Date(APP.train.startMs);
      const durationMin = Math.max(0, Math.round((now.getTime()-start.getTime())/60000));

      const payload = {
        startTime: start.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
        endTime: now.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
        durationMin: String(durationMin),
        scenarioKey: APP.train.scenarioKey,
        scenarioLabel: scenarioLabel(APP.train.scenarioKey),
        trainer: trainer,
        attendees: attendees,
        notes: 'ØªÙ…Ø±ÙŠÙ† Ø¹Ù…Ù„ÙŠ',
        startIso: start.toISOString(),
        endIso: now.toISOString()
      };

      console.log('=== SAVING TRAINING SESSION ===');
      console.log('Payload:', JSON.stringify(payload, null, 2));

      try{
        const res = await jsonp('logTrainingSession', payload);
        console.log('Response:', JSON.stringify(res, null, 2));
        if (!res || !res.ok) throw new Error(res?.error || 'logTrainingSession failed');
        
        const sid = res.sessionId || res.session_id || '';
        showBigSuccess('ØªÙ… Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­! âœ…\n\nØ§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ: ' + scenarioLabel(APP.train.scenarioKey) + '\nØ§Ù„Ù…Ø¯Ø±Ø¨: ' + trainer + '\nØ§Ù„Ø­Ø¶ÙˆØ±: ' + APP.train.selectedRoster.size + ' Ù…ØªØ¯Ø±Ø¨' + (sid ? '\n\nØ±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø©: ' + sid : ''));
        
        closeTrainingModal();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
        setTimeout(async () => {
          await refreshMiniTraining();
          console.log('Mini training refreshed after save');
        }, 500);
        
      } catch(e){
        console.error('SAVE ERROR:', e);
        showBigError('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸!\n\n' + e.message + '\n\nâš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Apps Script Ø¬Ø¯ÙŠØ¯:\nDeploy â†’ Manage deployments â†’ âœï¸ â†’ New version');
      } finally {
        if (btn) {
          btn.innerHTML = originalHTML;
          btn.style.background = '';
          updateTrainingSaveState();
        }
      }
    }

    /******************************************************
     * Training Log modal
     ******************************************************/
    function openTrainingLogModal(){
      document.getElementById('trainingLogModal').classList.add('active');
      loadTrainingLog();
    }
    function closeTrainingLogModal(){
      document.getElementById('trainingLogModal').classList.remove('active');
    }

    async function loadTrainingLog(){
      const body = document.getElementById('trainLogBody');
      body.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:22px"><i class="fas fa-spinner fa-spin"></i> ØªØ­Ù…ÙŠÙ„...</td></tr>`;
      try{
        console.log('Loading training log...');
        const list = await fetchTrainingSessions(250);
        console.log('Training sessions loaded:', list.length, 'sessions');
        APP.caches.trainingSessions = list;
        applyTrainingFilter();
      } catch(e){
        console.error('Load training log error:', e);
        body.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:22px;color:var(--danger)">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨<br><small style="opacity:.7">ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Apps Script</small></td></tr>`;
      }
    }

    function renderTrainingTable(list){
      const body = document.getElementById('trainLogBody');
      if (!list || !list.length){
        body.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:22px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª</td></tr>`;
        return;
      }
      body.innerHTML = list.map((s,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${escapeHtml(s._dateYMD || toYMD(s.date) || '')}</td>
          <td>${escapeHtml(s.startTime||'')}</td>
          <td>${escapeHtml(s.endTime||'')}</td>
          <td>${escapeHtml(String(s.durationMin ?? ''))}</td>
          <td>${escapeHtml(s.scenarioLabel || scenarioLabel(s.scenarioKey) || '')}</td>
          <td>${escapeHtml(s.trainer||'')}</td>
          <td>${escapeHtml(s.attendees || '-')}</td>
          <td><button class="view-btn" onclick="showTrainingDetails(${i})"><i class="fas fa-eye"></i> Ø¹Ø±Ø¶</button></td>
        </tr>
      `).join('');
    }

    function applyTrainingFilter(){
      const from = document.getElementById('trainFrom').value;
      const to = document.getElementById('trainTo').value;
      const filtered = (APP.caches.trainingSessions||[]).filter(s=>{
        const d = s._dateYMD || toYMD(s.date);
        if (from && d < from) return false;
        if (to && d > to) return false;
        return true;
      });
      renderTrainingTable(filtered);
    }

    function showTrainingDetails(index){
      const s = (APP.caches.trainingSessions||[])[index];
      if (!s) return;

      const html = `
        <div class="mini-item" style="border-radius:16px;padding:14px">
          <div style="font-weight:1000;color:var(--secondary);margin-bottom:10px"><i class="fas fa-calendar"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</div>
          <div style="display:grid;gap:6px;font-weight:900">
            <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${escapeHtml(s._dateYMD || toYMD(s.date) || '-')}</div>
            <div>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${escapeHtml(s.startTime||'-')}</div>
            <div>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${escapeHtml(s.endTime||'-')}</div>
            <div>Ø§Ù„Ù…Ø¯Ø©: ${escapeHtml(String(s.durationMin ?? '-'))} Ø¯Ù‚ÙŠÙ‚Ø©</div>
            <div>Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ: ${escapeHtml(s.scenarioLabel || scenarioLabel(s.scenarioKey) || '-')}</div>
            <div>Ø§Ù„Ù…Ø¯Ø±Ø¨: ${escapeHtml(s.trainer||'-')}</div>
          </div>
        </div>
        <div class="mini-item" style="border-radius:16px;padding:14px;margin-top:10px">
          <div style="font-weight:1000;color:var(--secondary);margin-bottom:10px"><i class="fas fa-users"></i> Ø§Ù„Ø­Ø¶ÙˆØ±</div>
          <div style="font-weight:800;line-height:1.8">${escapeHtml(s.attendees || '-')}</div>
        </div>
        <div class="mini-item" style="border-radius:16px;padding:14px;margin-top:10px">
          <div style="font-weight:1000;color:var(--secondary);margin-bottom:10px"><i class="fas fa-note-sticky"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          <div style="font-weight:800;line-height:1.8">${escapeHtml(s.notes || '-')}</div>
        </div>
      `;
      document.getElementById('trainingDetailsContent').innerHTML = html;
      document.getElementById('trainingDetailsModal').classList.add('active');
    }

    function closeTrainingDetails(){
      document.getElementById('trainingDetailsModal').classList.remove('active');
    }
    
    function printTrainingDetails(){
      // Set print date
      const now = new Date();
      const dateStr = now.toLocaleDateString('ar-SA', {year:'numeric',month:'long',day:'numeric'}) + ' - ' + now.toLocaleTimeString('ar-SA');
      const printDateEl = document.getElementById('printDateDetails');
      if(printDateEl) printDateEl.textContent = dateStr;
      
      // Also set for other modals if open
      const trainEl = document.getElementById('printDateTrain');
      const repEl = document.getElementById('printDateRep');
      if(trainEl) trainEl.textContent = dateStr;
      if(repEl) repEl.textContent = dateStr;
      
      window.print();
    }

    /******************************************************
     * Reports Log modal
     ******************************************************/
    function openReportsLogModal(){
      document.getElementById('reportsLogModal').classList.add('active');
      loadReportsLog();
    }
    function closeReportsLogModal(){
      document.getElementById('reportsLogModal').classList.remove('active');
    }

    async function loadReportsLog(){
      const body = document.getElementById('repLogBody');
      body.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:22px"><i class="fas fa-spinner fa-spin"></i> ØªØ­Ù…ÙŠÙ„...</td></tr>`;
      try{
        const list = await fetchEmergencyReports(200);
        APP.caches.reports = list;
        renderReportsTable(list);
      } catch(e){
        console.error(e);
        body.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:22px;color:var(--danger)">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</td></tr>`;
      }
    }

    function renderReportsTable(list){
      const body = document.getElementById('repLogBody');
      if (!list || !list.length){
        body.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:22px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª</td></tr>`;
        return;
      }
      body.innerHTML = list.map(r=>{
        const st = String(r.status||'Ø¬Ø¯ÙŠØ¯');
        const pill = statusPillClass(st);
        const action =
          st === 'Ø¬Ø¯ÙŠØ¯' ? `<button class="view-btn" onclick="updateReportFlow('${escapeHtml(r.id)}','Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©')">Ø§Ø³ØªØ¬Ø§Ø¨Ø©</button>` :
          st === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' ? `<button class="view-btn" onclick="updateReportFlow('${escapeHtml(r.id)}','Ù…ØºÙ„Ù‚')">Ø¥ØºÙ„Ø§Ù‚</button>` :
          `<span style="color:var(--success);font-weight:1000"><i class="fas fa-check"></i></span>`;

        return `
          <tr>
            <td>${escapeHtml(r.id||'')}</td>
            <td>${escapeHtml(r.date||'')}</td>
            <td>${escapeHtml(r.time||'')}</td>
            <td>${escapeHtml(r.type||'')}</td>
            <td>${escapeHtml(r.location||'')}</td>
            <td><span class="pill ${pill}">${escapeHtml(st)}</span></td>
            <td>${action}</td>
          </tr>
        `;
      }).join('');
    }

    async function updateReportFlow(id, newStatus){
      const responder = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¬ÙŠØ¨:');
      if (!responder) return;
      const actionNotes = prompt('Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || '';
      try{
        await safeUpdateReportStatus(id, newStatus, responder, actionNotes);
        toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'success');
        await refreshLists();
        await loadReportsLog();
      } catch(e){
        console.error(e);
        toast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
      }
    }

    function applyReportsFilter(){
      const from = document.getElementById('repFrom').value;
      const to = document.getElementById('repTo').value;
      const st = document.getElementById('repStatus').value;

      const filtered = (APP.caches.reports||[]).filter(r=>{
        const d = String(r.date||'');
        if (from && d < from) return false;
        if (to && d > to) return false;
        if (st && String(r.status||'') !== st) return false;
        return true;
      });
      renderReportsTable(filtered);
    }

    /******************************************************
     * Init & refresh
     ******************************************************/
    async function refreshLists(){
      await Promise.allSettled([refreshMiniTraining(), pollReports()]);
    }

    async function init(){
      // range buttons
      buildRangeButtons('trainRangeBtns', (p)=>{ setRangeInputs('trainFrom','trainTo', p.days); applyTrainingFilter(); });
      buildRangeButtons('repRangeBtns', (p)=>{ setRangeInputs('repFrom','repTo', p.days); applyReportsFilter(); });

      // core sheet data
      await loadCoreData();

      // initial lists
      await refreshMiniTraining();
      await pollReports();

      // check if emergency is active
      await syncActiveCommandUI();

      // polling every 5 seconds
      setInterval(pollReports, 5000);

      // small refresh training list every 30s
      setInterval(refreshMiniTraining, 30000);

      // sync active command every 5 seconds
      setInterval(syncActiveCommandUI, 5000);
    }

    document.addEventListener('DOMContentLoaded', init);

    /******************************************************
     * DEBUG: Test Apps Script directly
     ******************************************************/
    async function testGetSessions(){
      console.log('=== TESTING getTrainingSessions ===');
      const btn = event?.target?.closest('button');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      }
      
      try {
        const res = await jsonp('getTrainingSessions', { limit: '50' });
        console.log('getTrainingSessions Response:', res);
        
        if (!res) {
          showBigError('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ Ù…Ù† Apps Script!\n\nØªØ£ÙƒØ¯ Ù…Ù†:\n1. Ù†Ø´Ø± Apps Script Ø¬Ø¯ÙŠØ¯\n2. Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­');
          return;
        }
        
        if (!res.ok) {
          showBigError('Ø®Ø·Ø£ Ù…Ù† Apps Script:\n\n' + (res.error || 'Unknown error'));
          return;
        }
        
        const sessions = res.sessions || [];
        const debugInfo = res.debug || '';
        console.log('Debug info:', debugInfo);
        
        if (sessions.length === 0) {
          showBigError('Apps Script Ø£Ø±Ø¬Ø¹ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©!\n\nDebug: ' + debugInfo + '\n\nâš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Code.gs Ø§Ù„Ø¬Ø¯ÙŠØ¯!');
        } else {
          showBigSuccess('ØªÙ… Ø³Ø­Ø¨ ' + sessions.length + ' Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­! âœ…\n\n' + debugInfo + '\n\nØ£ÙˆÙ„ Ø¬Ù„Ø³Ø©:\n' + sessions[0].scenarioLabel + ' - ' + sessions[0].date);
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
          APP.caches.trainingSessions = sessions;
          renderMiniTraining();
        }
      } catch(e) {
        console.error('Test Error:', e);
        showBigError('ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:\n\n' + e.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-download"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø­Ø¨';
        }
      }
    }

    async function testAppsScript(){
      console.log('=== TESTING APPS SCRIPT ===');
      console.log('Web App URL:', WEB_APP_URL);
      
      const testPayload = {
        startTime: '10:00',
        endTime: '10:05',
        durationMin: '5',
        scenarioKey: 'fire',
        scenarioLabel: 'Ø­Ø±ÙŠÙ‚ (Ø§Ø®ØªØ¨Ø§Ø±)',
        trainer: 'TEST_USER',
        attendees: 'Test Person 1',
        notes: 'Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± - ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡',
        startIso: new Date().toISOString(),
        endIso: new Date().toISOString()
      };
      
      console.log('Test Payload:', testPayload);
      
      try {
        const res = await jsonp('logTrainingSession', testPayload);
        console.log('Test Response:', res);
        if (res && res.ok) {
          alert('Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±! sessionId = ' + res.sessionId + '\n\nØªØ­Ù‚Ù‚ Ù…Ù† Ø´ÙŠØª Training_Log');
        } else {
          alert('ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!\n\nØ§Ù„Ø®Ø·Ø£: ' + (res?.error || JSON.stringify(res)) + '\n\nØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Apps Script Ø¬Ø¯ÙŠØ¯!');
        }
      } catch(e) {
        console.error('Test Error:', e);
        alert('ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!\n\n' + e.message + '\n\nØªØ£ÙƒØ¯ Ù…Ù†:\n1. Ù†Ø´Ø± Apps Script (Deploy â†’ New version)\n2. Ø±Ø§Ø¨Ø· Web App ØµØ­ÙŠØ­');
      }
    }
    
    // Add test button to console
    console.log('%c Ø§Ø®ØªØ¨Ø§Ø± Apps Script: Ø§ÙƒØªØ¨ testAppsScript() ÙÙŠ Console ', 'background: #1e3a5f; color: #c9a962; font-size: 14px; padding: 5px;');

    /******************************************************
     * Notes:
     * - Apps Script Web Apps doGet/doPost support JSONP via callback parameter.
     * - LockService recommended for concurrent sheet writes.
     ******************************************************/
  </script>
</body>
</html>
