<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة سلامة المرافق - مكة كلينك</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #1a5f7a; text-align: center; margin-bottom: 20px; }
        .status { background: #27ae60; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; }
        .btn { background: #1a5f7a; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn-success { background: #27ae60; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; color: #1a5f7a; }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; }
        .badge-danger { background: #e74c3c; color: white; }
        .badge-warning { background: #f39c12; color: white; }
        .badge-success { background: #27ae60; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>نظام إدارة سلامة المرافق (FMS)</h1>
        
        <div class="status" id="connection-status">✅ جاهز للتشغيل</div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn" onclick="loadData()">🔄 تحديث البيانات</button>
            <button class="btn btn-success" onclick="addTask()">➕ إضافة مهمة</button>
        </div>

        <div id="stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                <h3 id="pending-tasks">0</h3>
                <p>مهمة معلقة</p>
            </div>
            <div style="background: #ffeaa7; padding: 15px; border-radius: 8px; text-align: center;">
                <h3 id="high-priority">0</h3>
                <p>مهمة عاجلة</p>
            </div>
            <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                <h3 id="completed-tasks">0</h3>
                <p>مهمة مكتملة</p>
            </div>
            <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; text-align: center;">
                <h3 id="compliance-rate">0%</h3>
                <p>مستوى الامتثال</p>
            </div>
        </div>

        <h2>المهام العاجلة <span class="badge badge-danger" id="urgent-count">0 عاجل</span></h2>
        <table>
            <thead>
                <tr>
                    <th>المهمة</th>
                    <th>المسؤول</th>
                    <th>القسم</th>
                    <th>الأولوية</th>
                    <th>الموعد</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="urgent-tasks-table">
                <!-- سيتم ملؤها بالبيانات -->
            </tbody>
        </table>

        <h2 style="margin-top: 30px;">جميع المهام</h2>
        <table>
            <thead>
                <tr>
                    <th>المهمة</th>
                    <th>المسؤول</th>
                    <th>القسم</th>
                    <th>الأولوية</th>
                    <th>الموعد</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="tasks-table">
                <!-- سيتم ملؤها بالبيانات -->
            </tbody>
        </table>
    </div>

    <script>
        // ضع هنا الرابط الجديد الذي نسخته من الخطوة 1
        const WEB_APP_URL = 'الرابط_الجديد_ضع_هنا';
        
        let tasks = [];

        async function loadData() {
            try {
                document.getElementById('connection-status').textContent = '🔄 جاري تحميل البيانات...';
                
                const response = await fetch(`${WEB_APP_URL}?action=getFMSData`);
                const data = await response.json();
                
                if (data.success) {
                    tasks = data.tasks || getSampleTasks();
                    document.getElementById('connection-status').textContent = '✅ تم تحميل البيانات بنجاح';
                    updateDisplay();
                } else {
                    throw new Error('فشل في تحميل البيانات');
                }
            } catch (error) {
                tasks = getSampleTasks();
                document.getElementById('connection-status').textContent = '⚠️ استخدام بيانات تجريبية';
                updateDisplay();
            }
        }

        function getSampleTasks() {
            return [
                {
                    id: '1',
                    title: 'تجديد ترخيص الدفاع المدني',
                    assignedTo: 'أحمد محمد',
                    department: 'شؤون التراخيص',
                    priority: 'high',
                    dueDate: '2025-11-15',
                    status: 'pending'
                },
                {
                    id: '2',
                    title: 'صيانة أنظمة الإنذار',
                    assignedTo: 'خالد إبراهيم',
                    department: 'قسم الصيانة',
                    priority: 'high',
                    dueDate: '2025-11-10',
                    status: 'in_progress'
                }
            ];
        }

        function updateDisplay() {
            // تحديث الإحصائيات
            const pendingTasks = tasks.filter(t => t.status === 'pending').length;
            const highPriority = tasks.filter(t => t.priority === 'high').length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const totalTasks = tasks.length;
            const complianceRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('pending-tasks').textContent = pendingTasks;
            document.getElementById('high-priority').textContent = highPriority;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('compliance-rate').textContent = complianceRate + '%';
            document.getElementById('urgent-count').textContent = highPriority + ' عاجل';

            // تحديث الجداول
            updateUrgentTasksTable();
            updateTasksTable();
        }

        function updateUrgentTasksTable() {
            const urgentTasks = tasks.filter(task => task.priority === 'high' && task.status !== 'completed');
            const tbody = document.getElementById('urgent-tasks-table');
            
            tbody.innerHTML = urgentTasks.map(task => `
                <tr>
                    <td>${task.title}</td>
                    <td>${task.assignedTo}</td>
                    <td>${task.department}</td>
                    <td><span class="badge badge-danger">عالي</span></td>
                    <td>${task.dueDate}</td>
                    <td><button class="btn btn-success" onclick="completeTask('${task.id}')">إكمال</button></td>
                </tr>
            `).join('');
        }

        function updateTasksTable() {
            const tbody = document.getElementById('tasks-table');
            
            tbody.innerHTML = tasks.map(task => `
                <tr>
                    <td>${task.title}</td>
                    <td>${task.assignedTo}</td>
                    <td>${task.department}</td>
                    <td><span class="badge ${task.priority === 'high' ? 'badge-danger' : 'badge-warning'}">
                        ${task.priority === 'high' ? 'عالي' : 'متوسط'}
                    </span></td>
                    <td>${task.dueDate}</td>
                    <td><span class="badge ${task.status === 'completed' ? 'badge-success' : 'badge-warning'}">
                        ${task.status === 'completed' ? 'مكتمل' : 'معلق'}
                    </span></td>
                    <td><button class="btn btn-success" onclick="completeTask('${task.id}')">إكمال</button></td>
                </tr>
            `).join('');
        }

        function addTask() {
            const title = prompt('أدخل اسم المهمة الجديدة:');
            if (title) {
                const newTask = {
                    id: 'task_' + Date.now(),
                    title: title,
                    assignedTo: 'مدير النظام',
                    department: 'الإدارة',
                    priority: 'medium',
                    dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: 'pending'
                };
                tasks.push(newTask);
                updateDisplay();
                alert('تم إضافة المهمة بنجاح!');
            }
        }

        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && confirm(`هل تريد إكمال المهمة: ${task.title}؟`)) {
                task.status = 'completed';
                updateDisplay();
                alert('تم إكمال المهمة بنجاح!');
            }
        }

        // تحميل البيانات عند فتح الصفحة
        loadData();
    </script>
</body>
</html>
