<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>بوابة FMS – مجمع مكة الطبي بالزاهر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Tajawal', sans-serif; background-color: #f9f9f9; }
    .dark body { background-color: #1a1a1a; color: #eee; }
    .sidebar { width: 260px; background: linear-gradient(180deg, #7B1E24, #C55A44); color: white; }
    .nav-link { display: block; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; }
    .nav-link:hover { background-color: rgba(255,255,255,0.15); }
    .active-link { background-color: rgba(255,255,255,0.25); }
    @media print {
      header, .sidebar, footer, #darkModeBtn { display: none !important; }
      body::after {
        content: "";
        background: url('logo.png') center center no-repeat;
        background-size: 40%;
        opacity: 0.07;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: -1;
      }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex justify-between items-center bg-white shadow-md px-6 py-3 sticky top-0 z-50">
    <div class="flex items-center gap-3">
      <img src="logo.png" alt="شعار مجمع مكة الطبي" class="h-12 w-auto">
      <div>
        <h1 class="text-xl font-bold text-gray-800">بوابة FMS – مجمع مكة الطبي بالزاهر</h1>
        <p class="text-sm text-gray-500">إدارة السلامة والمرافق – الإصدار 2025</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button id="darkModeBtn" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">🌙 وضع ليلي</button>
      <button onclick="window.print()" class="px-3 py-2 bg-[#7B1E24] text-white rounded-lg hover:bg-[#8f2b33]">🖨️ طباعة / PDF</button>
    </div>
  </header>

  <!-- Main Layout -->
  <div class="flex flex-1">

    <!-- Sidebar -->
    <aside class="sidebar p-4 text-sm leading-relaxed">
      <div class="font-bold mb-3">📊 لوحة التحكم</div>
      <a href="#dashboard" class="nav-link active-link">لوحة المؤشرات</a>
      <div class="font-bold mt-4 mb-2">🏛️ القيادة والحوكمة</div>
      <a href="#leadership" class="nav-link">الهيكل الإداري</a>
      <a href="#committees" class="nav-link">اللجان الرسمية</a>
      <div class="font-bold mt-4 mb-2">🗂️ الخطط الثمانية</div>
      <a href="#plans" class="nav-link">الخطط (FMS-P01 إلى FMS-P08)</a>
      <div class="font-bold mt-4 mb-2">📋 النماذج والسجلات</div>
      <a href="#forms" class="nav-link">النماذج (F01–F11)</a>
      <div class="font-bold mt-4 mb-2">📈 عرض البيانات</div>
      <a href="#sheet" class="nav-link">جلب بيانات الشيت</a>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto" id="mainContent">
      <section id="dashboard">
        <h2 class="text-2xl font-bold mb-4 text-[#7B1E24]">📊 لوحة المؤشرات الرئيسية</h2>
        <p class="text-gray-600 mb-6">نظرة عامة على أداء إدارة السلامة والمرافق.</p>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
          <div class="bg-white shadow-lg rounded-xl p-5 border-t-4 border-[#7B1E24]">
            <h3 class="text-lg font-semibold">نسبة الجولات المنفذة</h3>
            <p class="text-3xl font-bold text-[#7B1E24]" id="roundsRate">--%</p>
            <p class="text-sm text-gray-500">من إجمالي الجولات المجدولة</p>
          </div>
          <div class="bg-white shadow-lg rounded-xl p-5 border-t-4 border-[#C55A44]">
            <h3 class="text-lg font-semibold">نسبة الصيانة الوقائية</h3>
            <p class="text-3xl font-bold text-[#C55A44]" id="maintenanceRate">--%</p>
            <p class="text-sm text-gray-500">من إجمالي أوامر الصيانة</p>
          </div>
          <div class="bg-white shadow-lg rounded-xl p-5 border-t-4 border-[#7B1E24]">
            <h3 class="text-lg font-semibold">نسبة التدريب المنفذ</h3>
            <p class="text-3xl font-bold text-[#7B1E24]" id="trainingRate">--%</p>
            <p class="text-sm text-gray-500">من إجمالي الموظفين المستهدفين</p>
          </div>
          <div class="bg-white shadow-lg rounded-xl p-5 border-t-4 border-[#C55A44]">
            <h3 class="text-lg font-semibold">عدد الاجتماعات</h3>
            <p class="text-3xl font-bold text-[#C55A44]" id="meetingCount">--</p>
            <p class="text-sm text-gray-500">من لجان RM / FMS / PSC / EOC</p>
          </div>
          <div class="bg-white shadow-lg rounded-xl p-5 border-t-4 border-[#7B1E24]">
            <h3 class="text-lg font-semibold">اختبارات الإنذار / الإطفاء الناجحة</h3>
            <p class="text-3xl font-bold text-[#7B1E24]" id="fireTests">--%</p>
            <p class="text-sm text-gray-500">نسبة نجاح الاختبارات من السجلات</p>
          </div>
          <div class="bg-white shadow-lg rounded-xl p-5 border-t-4 border-[#C55A44]">
            <h3 class="text-lg font-semibold">📸 عدد الصور المرفقة هذا الشهر</h3>
            <p class="text-3xl font-bold text-[#C55A44]" id="photoCount">--</p>
            <p class="text-sm text-gray-500">إجمالي صور الجولات والإصلاحات</p>
          </div>
        </div>

        <!-- زر اختبار الاتصال -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg">
          <button onclick="testConnection()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">
            🔄 اختبار الاتصال بالسيرفر
          </button>
          <div id="connectionStatus" class="mt-2 text-sm"></div>
        </div>
<section id="committees" class="mt-10">
  <h2 class="text-2xl font-bold mb-4 text-[#7B1E24]">📋 اللجان الرسمية (حسب سباهي)</h2>
  <p class="text-gray-600 mb-6">تمثل اللجان الرسمية الأطر القيادية والتشغيلية لضمان الجودة والسلامة في جميع إدارات المجمع، وفق معايير CBAHI.</p>

  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">

    <!-- لجنة إدارة المخاطر -->
    <div class="bg-blue-50 shadow-md rounded-xl p-5 border-t-4 border-blue-600">
      <h3 class="text-lg font-bold text-blue-700 mb-2">⚠️ لجنة إدارة المخاطر (RM)</h3>
      <p><strong>الرئيس:</strong> د. حسين بابصيل</p>
      <p><strong>المنسق/السكرتير:</strong> أ. عدنان الرفاعي</p>
      <p><strong>الأعضاء:</strong> بلال، صابر، معاذ، خالد</p>
      <p><strong>تكرار الاجتماعات:</strong> شهريًا</p>
    </div>

    <!-- لجنة السلامة والمرافق -->
    <div class="bg-green-50 shadow-md rounded-xl p-5 border-t-4 border-green-600">
      <h3 class="text-lg font-bold text-green-700 mb-2">🛠️ لجنة السلامة والمرافق (FMS)</h3>
      <p><strong>الرئيس:</strong> أ. صابر عبده</p>
      <p><strong>منسق التدريب:</strong> أ. بلال نتو</p>
      <p><strong>الأعضاء:</strong> عدنان الرفاعي، خالد الخطيب، مندوب الأمن</p>
      <p><strong>تكرار الاجتماعات:</strong> شهريًا</p>
    </div>

    <!-- لجنة سلامة المرضى -->
    <div class="bg-orange-50 shadow-md rounded-xl p-5 border-t-4 border-orange-500">
      <h3 class="text-lg font-bold text-orange-700 mb-2">❤️‍🩹 لجنة سلامة المرضى (PSC)</h3>
      <p><strong>الرئيس:</strong> د. معاذ البيوش</p>
      <p><strong>نائب الرئيس:</strong> د. خالد الخطيب</p>
      <p><strong>الأعضاء:</strong> د. حسين، هيثم، بلال</p>
      <p><strong>السكرتير:</strong> عدنان</p>
      <p><strong>تكرار الاجتماعات:</strong> شهريًا</p>
    </div>

    <!-- لجنة مكافحة العدوى -->
    <div class="bg-red-50 shadow-md rounded-xl p-5 border-t-4 border-red-600">
      <h3 class="text-lg font-bold text-red-700 mb-2">🧫 لجنة مكافحة العدوى (IPC)</h3>
      <p><strong>الرئيس:</strong> د. مجدي عسكر</p>
      <p><strong>الأعضاء:</strong> خالد، التمريض، المختبر، التعقيم</p>
      <p><strong>السكرتير:</strong> عدنان</p>
      <p><strong>تكرار الاجتماعات:</strong> شهريًا</p>
    </div>

    <!-- لجنة الجودة والتحسين المستمر -->
    <div class="bg-purple-50 shadow-md rounded-xl p-5 border-t-4 border-purple-600">
      <h3 class="text-lg font-bold text-purple-700 mb-2">📈 لجنة الجودة والتحسين المستمر (QI)</h3>
      <p><strong>الرئيس:</strong> د. حسين بابصيل</p>
      <p><strong>الأعضاء:</strong> ممثلين من الأقسام</p>
      <p><strong>السكرتير:</strong> عدنان</p>
      <p><strong>تكرار الاجتماعات:</strong> ربع سنوي</p>
    </div>

    <!-- لجنة الطوارئ والكوارث -->
    <div class="bg-yellow-50 shadow-md rounded-xl p-5 border-t-4 border-yellow-500">
      <h3 class="text-lg font-bold text-yellow-700 mb-2">🚨 لجنة الطوارئ والكوارث (EOC)</h3>
      <p><strong>الرئيس:</strong> أ. بلال نتو</p>
      <p><strong>الأعضاء:</strong> صابر، معاذ، خالد، الأمن، التمريض</p>
      <p><strong>تكرار الاجتماعات:</strong> نصف سنوي</p>
    </div>

  </div>
</section>

      </section>
    </main>
  </div>
<section id="committees" class="mt-12">
  <h2 class="text-2xl font-bold mb-4 text-[#7B1E24]">📋 اللجان الرسمية (حسب سباهي)</h2>
  <p class="text-gray-600 mb-6">تمثل اللجان الرسمية الأطر القيادية والتشغيلية لضمان الجودة والسلامة في جميع إدارات المجمع، وفق معايير CBAHI.</p>

  <div class="space-y-4">

    <!-- لجنة إدارة المخاطر -->
    <details class="bg-blue-50 border border-blue-200 rounded-xl p-5 shadow-sm open:shadow-lg">
      <summary class="cursor-pointer text-lg font-bold text-blue-700 flex justify-between items-center">
        ⚠️ لجنة إدارة المخاطر (RM)
        <span class="text-sm text-blue-500">اضغط لعرض التفاصيل</span>
      </summary>
      <div class="mt-4 space-y-2 text-gray-700">
        <p><strong>الرئيس:</strong> د. حسين بابصيل</p>
        <p><strong>المنسق/السكرتير:</strong> أ. عدنان الرفاعي</p>
        <p><strong>الأعضاء:</strong> بلال، صابر، معاذ، خالد</p>
        <p><strong>تكرار الاجتماعات:</strong> شهريًا</p>

        <div class="mt-4">
          <h4 class="font-semibold text-blue-700 mb-2">📑 النماذج والسياسات:</h4>
          <ul class="list-disc ml-6">
            <li><a href="#" class="text-blue-600 hover:underline">نموذج تقييم المخاطر البيئية FRM-RM-2025-001</a></li>
            <li><a href="#" class="text-blue-600 hover:underline">سياسة إدارة المخاطر LD.31 & LD.32</a></li>
            <li><a href="#" class="text-blue-600 hover:underline">نموذج تحليل RCA / HFMEA</a></li>
          </ul>
        </div>
      </div>
    </details>

    <!-- لجنة السلامة والمرافق -->
    <details class="bg-green-50 border border-green-200 rounded-xl p-5 shadow-sm">
      <summary class="cursor-pointer text-lg font-bold text-green-700 flex justify-between items-center">
        🛠️ لجنة السلامة والمرافق (FMS)
        <span class="text-sm text-green-500">اضغط لعرض التفاصيل</span>
      </summary>
      <div class="mt-4 space-y-2 text-gray-700">
        <p><strong>الرئيس:</strong> أ. صابر عبده</p>
        <p><strong>منسق التدريب:</strong> أ. بلال نتو</p>
        <p><strong>الأعضاء:</strong> عدنان الرفاعي، خالد الخطيب، مندوب الأمن</p>
        <p><strong>تكرار الاجتماعات:</strong> شهريًا</p>

        <div class="mt-4">
          <h4 class="font-semibold text-green-700 mb-2">📑 النماذج والسياسات:</h4>
          <ul class="list-disc ml-6">
            <li><a href="#" class="text-green-600 hover:underline">خطة سلامة المبنى FMS-P01</a></li>
            <li><a href="#" class="text-green-600 hover:underline">خطة الطوارئ الداخلية FMS-P04</a></li>
            <li><a href="#" class="text-green-600 hover:underline">نموذج جولة السلامة F-01</a></li>
          </ul>
        </div>
      </div>
    </details>

    <!-- لجنة سلامة المرضى -->
    <details class="bg-orange-50 border border-orange-200 rounded-xl p-5 shadow-sm">
      <summary class="cursor-pointer text-lg font-bold text-orange-700 flex justify-between items-center">
        ❤️‍🩹 لجنة سلامة المرضى (PSC)
        <span class="text-sm text-orange-500">اضغط لعرض التفاصيل</span>
      </summary>
      <div class="mt-4 space-y-2 text-gray-700">
        <p><strong>الرئيس:</strong> د. معاذ البيوش</p>
        <p><strong>نائب الرئيس:</strong> د. خالد الخطيب</p>
        <p><strong>الأعضاء:</strong> د. حسين، هيثم، بلال</p>
        <p><strong>السكرتير:</strong> عدنان</p>
        <p><strong>تكرار الاجتماعات:</strong> شهريًا</p>

        <div class="mt-4">
          <h4 class="font-semibold text-orange-700 mb-2">📑 النماذج والسياسات:</h4>
          <ul class="list-disc ml-6">
            <li><a href="#" class="text-orange-600 hover:underline">نموذج تبليغ عن حدث جسيم PSC-INC-2025-001</a></li>
            <li><a href="#" class="text-orange-600 hover:underline">سياسة تعريف هوية المريض</a></li>
            <li><a href="#" class="text-orange-600 hover:underline">إجراءات منع الأخطاء الدوائية</a></li>
          </ul>
        </div>
      </div>
    </details>

    <!-- لجنة مكافحة العدوى -->
    <details class="bg-red-50 border border-red-200 rounded-xl p-5 shadow-sm">
      <summary class="cursor-pointer text-lg font-bold text-red-700 flex justify-between items-center">
        🧫 لجنة مكافحة العدوى (IPC)
        <span class="text-sm text-red-500">اضغط لعرض التفاصيل</span>
      </summary>
      <div class="mt-4 space-y-2 text-gray-700">
        <p><strong>الرئيس:</strong> د. مجدي عسكر</p>
        <p><strong>الأعضاء:</strong> خالد، التمريض، المختبر، التعقيم</p>
        <p><strong>السكرتير:</strong> عدنان</p>
        <p><strong>تكرار الاجتماعات:</strong> شهريًا</p>

        <div class="mt-4">
          <h4 class="font-semibold text-red-700 mb-2">📑 النماذج والسياسات:</h4>
          <ul class="list-disc ml-6">
            <li><a href="#" class="text-red-600 hover:underline">سياسة غسيل الأيدي IPC-2025-001</a></li>
            <li><a href="#" class="text-red-600 hover:underline">خطة مكافحة العدوى السنوية</a></li>
          </ul>
        </div>
      </div>
    </details>

    <!-- لجنة الجودة والتحسين المستمر -->
    <details class="bg-purple-50 border border-purple-200 rounded-xl p-5 shadow-sm">
      <summary class="cursor-pointer text-lg font-bold text-purple-700 flex justify-between items-center">
        📈 لجنة الجودة والتحسين المستمر (QI)
        <span class="text-sm text-purple-500">اضغط لعرض التفاصيل</span>
      </summary>
      <div class="mt-4 space-y-2 text-gray-700">
        <p><strong>الرئيس:</strong> د. حسين بابصيل</p>
        <p><strong>الأعضاء:</strong> ممثلين من الأقسام</p>
        <p><strong>السكرتير:</strong> عدنان</p>
        <p><strong>تكرار الاجتماعات:</strong> ربع سنوي</p>

        <div class="mt-4">
          <h4 class="font-semibold text-purple-700 mb-2">📑 النماذج والسياسات:</h4>
          <ul class="list-disc ml-6">
            <li><a href="#" class="text-purple-600 hover:underline">سياسة التحسين المستمر للجودة QI-2025-001</a></li>
            <li><a href="#" class="text-purple-600 hover:underline">نموذج متابعة مؤشرات الأداء KPI Tracker</a></li>
          </ul>
        </div>
      </div>
    </details>

    <!-- لجنة الطوارئ والكوارث -->
    <details class="bg-yellow-50 border border-yellow-200 rounded-xl p-5 shadow-sm">
      <summary class="cursor-pointer text-lg font-bold text-yellow-700 flex justify-between items-center">
        🚨 لجنة الطوارئ والكوارث (EOC)
        <span class="text-sm text-yellow-500">اضغط لعرض التفاصيل</span>
      </summary>
      <div class="mt-4 space-y-2 text-gray-700">
        <p><strong>الرئيس:</strong> أ. بلال نتو</p>
        <p><strong>الأعضاء:</strong> صابر، معاذ، خالد، الأمن، التمريض</p>
        <p><strong>تكرار الاجتماعات:</strong> نصف سنوي</p>

        <div class="mt-4">
          <h4 class="font-semibold text-yellow-700 mb-2">📑 النماذج والسياسات:</h4>
          <ul class="list-disc ml-6">
            <li><a href="#" class="text-yellow-600 hover:underline">خطة الطوارئ الخارجية FMS-P05</a></li>
            <li><a href="#" class="text-yellow-600 hover:underline">نموذج تقرير تمرين الإخلاء F-04</a></li>
          </ul>
        </div>
      </div>
    </details>

  </div>
</section>

  <!-- Footer -->
  <footer class="bg-[#7B1E24] text-white text-center py-3 text-sm">
    © 2025 مجمع عيادات مكة الطبي بالزاهر – جميع الحقوق محفوظة
  </footer>

  <!-- JavaScript -->
  <script>
    // زر الوضع الليلي
    document.getElementById('darkModeBtn').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
    });

    // رابط Google Script
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyECw5N9TioHpaDLUl7YdIuzOpHJBRxQmRLtnvqsgNTolb9guSdMcJlwnEEaTO9Dy_6JQ/exec";

    // تحميل البيانات من الشيت
    async function loadDashboard() {
      try {
        const timestamp = new Date().getTime(); // لتجنب الكاش
        const url = `${WEB_APP_URL}?action=getDashboard&t=${timestamp}`;
        console.log("Attempting to fetch from:", url);

        const res = await fetch(url, { method: "GET", redirect: "follow" });
        console.log("Response status:", res.status);

        const text = await res.text();
        console.log("Raw response:", text);

        let data;
        try { data = JSON.parse(text); }
        catch (err) { console.error("JSON parse error:", err); return; }

        updateDashboard(data);
      } catch (err) {
        console.error("❌ خطأ في جلب بيانات FMS:", err);
      }
    }

    // تحديث القيم في الصفحة
    function updateDashboard(data) {
      const format = (k, v) =>
        (k.includes("Rate") || k === "fireTests") ? v + "%" : v;

      ["roundsRate","maintenanceRate","trainingRate",
       "meetingCount","fireTests","photoCount"].forEach(k => {
        const el = document.getElementById(k);
        if (el) el.textContent = format(k, data[k] ?? "--");
      });
      console.log("✅ تم تحميل بيانات FMS:", data);
    }

    // اختبار الاتصال بالسيرفر
    async function testConnection() {
      const statusEl = document.getElementById("connectionStatus");
      try {
        statusEl.innerHTML = '<span class="text-blue-500">🔄 جاري اختبار الاتصال...</span>';
        const res = await fetch(WEB_APP_URL);
        const data = await res.json();
        statusEl.innerHTML = `<span class="text-green-600">✅ ${data.message}</span>`;
        console.log("Connection OK:", data);
      } catch (err) {
        statusEl.innerHTML = `<span class="text-red-600">❌ فشل الاتصال: ${err.message}</span>`;
        console.error("Connection failed:", err);
      }
    }

    // تشغيل عند تحميل الصفحة
    loadDashboard();
  </script>
</body>
</html>
