<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة سلامة المرافق - مكة كلينك</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        
        .header { 
            background: linear-gradient(135deg, #1a5f7a 0%, #159895 100%); 
            color: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            text-align: center; 
        }
        
        .status { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            text-align: center; 
            font-weight: 600; 
            font-size: 1.1rem; 
        }
        .success { background: #27ae60; color: white; }
        .warning { background: #f39c12; color: white; }
        .error { background: #e74c3c; color: white; }
        
        .btn { 
            background: #1a5f7a; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 1rem; 
            font-weight: 600; 
            transition: all 0.3s; 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 25px 0; 
        }
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 3px 15px rgba(0,0,0,0.1); 
            text-align: center; 
            border-top: 5px solid #1a5f7a; 
        }
        .stat-card.urgent { border-top-color: #e74c3c; }
        .stat-card.completed { border-top-color: #27ae60; }
        .stat-card h3 { font-size: 2.5rem; margin: 10px 0; color: #1a5f7a; }
        .stat-card.urgent h3 { color: #e74c3c; }
        .stat-card.completed h3 { color: #27ae60; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0; 
            background: white; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 3px 15px rgba(0,0,0,0.1); 
        }
        th, td { 
            padding: 15px; 
            text-align: right; 
            border-bottom: 1px solid #eaeaea; 
        }
        th { 
            background: #f8f9fa; 
            color: #1a5f7a; 
            font-weight: 700; 
            font-size: 1.05rem; 
        }
        tr:hover { background: #f8f9fa; }
        
        .badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 700; 
        }
        .badge-danger { background: #e74c3c; color: white; }
        .badge-warning { background: #f39c12; color: white; }
        .badge-success { background: #27ae60; color: white; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #2c3e50; }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 1rem; 
        }
        .form-group input:focus, .form-group select:focus { 
            border-color: #1a5f7a; 
            outline: none; 
        }
        
        .task-form { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 12px; 
            margin: 20px 0; 
            border: 2px dashed #1a5f7a; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 نظام إدارة سلامة المرافق (FMS)</h1>
            <p>مكة كلينك - الإصدار النهائي المضمون</p>
        </div>
        
        <div class="status success" id="connection-status">
            ✅ جاهز للتشغيل - انتظر تحميل البيانات...
        </div>
        
        <div style="text-align: center; margin: 25px 0;">
            <button class="btn" onclick="loadData()">🔄 تحديث البيانات</button>
            <button class="btn btn-success" onclick="showTaskForm()">➕ إضافة مهمة جديدة</button>
            <button class="btn" style="background: #3498db;" onclick="testConnection()">🔗 اختبار الاتصال</button>
        </div>

        <!-- الإحصائيات -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="pending-tasks">0</h3>
                <p>📋 المهام المعلقة</p>
            </div>
            <div class="stat-card urgent">
                <h3 id="high-priority">0</h3>
                <p>🚨 المهام العاجلة</p>
            </div>
            <div class="stat-card completed">
                <h3 id="completed-tasks">0</h3>
                <p>✅ المهام المكتملة</p>
            </div>
            <div class="stat-card">
                <h3 id="compliance-rate">0%</h3>
                <p>📊 مستوى الامتثال</p>
            </div>
        </div>

        <!-- نموذج إضافة مهمة -->
        <div class="task-form" id="task-form" style="display: none;">
            <h3 style="color: #1a5f7a; margin-bottom: 20px; text-align: center;">📝 إضافة مهمة جديدة</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="taskTitle">عنوان المهمة:</label>
                    <input type="text" id="taskTitle" placeholder="أدخل عنوان المهمة" required>
                </div>
                <div class="form-group">
                    <label for="taskAssignedTo">المسؤول:</label>
                    <input type="text" id="taskAssignedTo" value="مدير النظام">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="taskDepartment">القسم:</label>
                    <select id="taskDepartment">
                        <option value="الإدارة">الإدارة</option>
                        <option value="شؤون التراخيص">شؤون التراخيص</option>
                        <option value="قسم الصيانة">قسم الصيانة</option>
                        <option value="إدارة المخاطر">إدارة المخاطر</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskPriority">الأولوية:</label>
                    <select id="taskPriority">
                        <option value="high">🚨 عالي (عاجل)</option>
                        <option value="medium" selected>⚠️ متوسط</option>
                        <option value="low">✅ منخفض</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="taskDueDate">تاريخ الاستحقاق:</label>
                    <input type="date" id="taskDueDate" required>
                </div>
                <div class="form-group">
                    <label for="taskCategory">التصنيف:</label>
                    <select id="taskCategory">
                        <option value="تراخيص">تراخيص</option>
                        <option value="سلامة">سلامة</option>
                        <option value="صيانة">صيانة</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="taskLocation">المكان:</label>
                <input type="text" id="taskLocation" value="المبنى الرئيسي">
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button class="btn btn-success" onclick="addTask()">💾 حفظ المهمة في النظام</button>
                <button class="btn btn-danger" onclick="hideTaskForm()">❌ إلغاء</button>
            </div>
        </div>

        <h2 style="color: #e74c3c; margin: 30px 0 20px 0;">🚨 المهام العاجلة 
            <span class="badge badge-danger" id="urgent-count">0 عاجل</span>
        </h2>
        
        <table>
            <thead>
                <tr>
                    <th>المهمة</th>
                    <th>المسؤول</th>
                    <th>القسم</th>
                    <th>الأولوية</th>
                    <th>الموعد</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="urgent-tasks-table">
                <tr><td colspan="6" style="text-align: center; padding: 30px; color: #7f8c8d;">جاري تحميل المهام العاجلة...</td></tr>
            </tbody>
        </table>

        <h2 style="color: #1a5f7a; margin: 40px 0 20px 0;">📋 جميع المهام</h2>
        
        <table>
            <thead>
                <tr>
                    <th>المهمة</th>
                    <th>المسؤول</th>
                    <th>القسم</th>
                    <th>الأولوية</th>
                    <th>الموعد</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="tasks-table">
                <tr><td colspan="7" style="text-align: center; padding: 30px; color: #7f8c8d;">جاري تحميل جميع المهام...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // 🔗 الرابط الجديد - الإصدار النهائي
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzag89wJfUeJC8wx6XsCKi2OIhZx7aC-qiOdye4GRcNIiP7WXJu7kvsgpToiY7WDP268Q/exec';
        
        let tasks = [];

        // 🚀 تحميل البيانات عند فتح الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين تاريخ افتراضي (بعد أسبوع)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('taskDueDate').value = nextWeek.toISOString().split('T')[0];
            
            loadData();
        });

        // 📊 تحميل البيانات من Google Sheets
        async function loadData() {
            try {
                updateStatus('🔄 جاري تحميل البيانات من Google Sheets...', 'warning');
                
                const response = await fetch(`${WEB_APP_URL}?action=getFMSData`);
                const data = await response.json();
                
                if (data.success) {
                    tasks = data.tasks || [];
                    updateStatus(`✅ تم تحميل ${tasks.length} مهمة من Google Sheets`, 'success');
                    updateDisplay();
                } else {
                    throw new Error(data.error || 'فشل في تحميل البيانات');
                }
            } catch (error) {
                updateStatus(`❌ خطأ في التحميل: ${error.message}`, 'error');
                // استخدام بيانات تجريبية
                tasks = getSampleTasks();
                updateDisplay();
            }
        }

        // 🧪 بيانات تجريبية
        function getSampleTasks() {
            return [
                {
                    id: '1',
                    title: 'تجديد ترخيص الدفاع المدني',
                    assignedTo: 'أحمد محمد',
                    department: 'شؤون التراخيص',
                    priority: 'high',
                    dueDate: '2025-11-15',
                    status: 'pending',
                    category: 'تراخيص',
                    location: 'المبنى الرئيسي'
                }
            ];
        }

        // 🔄 تحديث العرض
        function updateDisplay() {
            // تحديث الإحصائيات
            const pendingTasks = tasks.filter(t => t.status === 'pending').length;
            const highPriority = tasks.filter(t => t.priority === 'high').length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const totalTasks = tasks.length;
            const complianceRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('pending-tasks').textContent = pendingTasks;
            document.getElementById('high-priority').textContent = highPriority;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('compliance-rate').textContent = complianceRate + '%';
            document.getElementById('urgent-count').textContent = highPriority + ' عاجل';

            // تحديث الجداول
            updateUrgentTasksTable();
            updateTasksTable();
        }

        // 🚨 تحديث جدول المهام العاجلة
        function updateUrgentTasksTable() {
            const urgentTasks = tasks.filter(task => task.priority === 'high' && task.status !== 'completed');
            const tbody = document.getElementById('urgent-tasks-table');
            
            if (urgentTasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #27ae60;">🎉 لا توجد مهام عاجلة</td></tr>';
            } else {
                tbody.innerHTML = urgentTasks.map(task => `
                    <tr>
                        <td><strong>${task.title}</strong></td>
                        <td>${task.assignedTo}</td>
                        <td>${task.department}</td>
                        <td><span class="badge badge-danger">🚨 عالي</span></td>
                        <td>${task.dueDate}</td>
                        <td>
                            <button class="btn btn-success" onclick="completeTask('${task.id}')">✅ إكمال</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // 📋 تحديث جدول جميع المهام
        function updateTasksTable() {
            const tbody = document.getElementById('tasks-table');
            
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #7f8c8d;">لا توجد مهام في النظام</td></tr>';
            } else {
                tbody.innerHTML = tasks.map(task => `
                    <tr>
                        <td><strong>${task.title}</strong></td>
                        <td>${task.assignedTo}</td>
                        <td>${task.department}</td>
                        <td><span class="badge ${task.priority === 'high' ? 'badge-danger' : task.priority === 'medium' ? 'badge-warning' : 'badge-success'}">
                            ${task.priority === 'high' ? '🚨 عالي' : task.priority === 'medium' ? '⚠️ متوسط' : '✅ منخفض'}
                        </span></td>
                        <td>${task.dueDate}</td>
                        <td><span class="badge ${task.status === 'completed' ? 'badge-success' : 'badge-warning'}">
                            ${task.status === 'completed' ? '✅ مكتمل' : '🕒 معلق'}
                        </span></td>
                        <td>
                            <button class="btn btn-success" onclick="completeTask('${task.id}')" ${task.status === 'completed' ? 'disabled style="background: #95a5a6;"' : ''}>
                                ✅ إكمال
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // ➕ إظهار نموذج إضافة مهمة
        function showTaskForm() {
            document.getElementById('task-form').style.display = 'block';
        }

        function hideTaskForm() {
            document.getElementById('task-form').style.display = 'none';
        }

        // 💾 إضافة مهمة جديدة - الطريقة المضمونة
        async function addTask() {
            const newTask = {
                title: document.getElementById('taskTitle').value,
                assignedTo: document.getElementById('taskAssignedTo').value,
                department: document.getElementById('taskDepartment').value,
                priority: document.getElementById('taskPriority').value,
                dueDate: document.getElementById('taskDueDate').value,
                category: document.getElementById('taskCategory').value,
                location: document.getElementById('taskLocation').value
            };

            // التحقق من الحقول المطلوبة
            if (!newTask.title || !newTask.dueDate) {
                alert('⚠️ يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            try {
                updateStatus('🔄 جاري إضافة المهمة إلى Google Sheets...', 'warning');

                // طريقة GET لتجنب مشاكل CORS
                const taskDataParam = encodeURIComponent(JSON.stringify(newTask));
                const response = await fetch(`${WEB_APP_URL}?action=addTask&taskData=${taskDataParam}`);
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus(`✅ ${result.message} - تمت الإضافة بنجاح!`, 'success');
                    
                    // إضافة المهمة محلياً
                    newTask.id = result.taskId;
                    newTask.status = 'pending';
                    newTask.createdAt = new Date().toISOString();
                    tasks.push(newTask);
                    
                    updateDisplay();
                    hideTaskForm();
                    
                    // تنظيف الحقول
                    document.getElementById('taskTitle').value = '';
                    
                    // إعادة تحميل البيانات من الخادم للتأكد
                    setTimeout(() => loadData(), 2000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                updateStatus(`❌ فشل في إضافة المهمة: ${error.message}`, 'error');
                console.error('Error details:', error);
            }
        }

        // ✅ إكمال المهمة
        async function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && confirm(`هل تريد إكمال المهمة: ${task.title}؟`)) {
                task.status = 'completed';
                updateDisplay();
                updateStatus('✅ تم تحديث حالة المهمة', 'success');
            }
        }

        // 🔗 اختبار الاتصال
        async function testConnection() {
            try {
                updateStatus('🔄 جاري اختبار الاتصال...', 'warning');
                const response = await fetch(`${WEB_APP_URL}?action=test`);
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(`✅ ${data.message} - النظام يعمل بشكل مثالي`, 'success');
                } else {
                    throw new Error('فشل اختبار الاتصال');
                }
            } catch (error) {
                updateStatus(`❌ فشل اختبار الاتصال: ${error.message}`, 'error');
            }
        }

        // 📝 تحديث حالة النظام
        function updateStatus(message, type) {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
    </script>
</body>
</html>
