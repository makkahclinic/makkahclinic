/***** Google Apps Script (Code.gs) *****/
const SPREADSHEET_ID = '1cGxMCYqGfPH2UiE-nsCoytIRjIPSDYxutnq04XF5YGs'; // من رابطك
const SHEET_NAME     = 'FMS_Rounds'; // غيّرها لاسم الورقة المطلوب داخل الملف

function _sheet() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sh = ss.getSheetByName(SHEET_NAME);
  if (!sh) sh = ss.insertSheet(SHEET_NAME);
  // اجعل الصف الأول عناوين إن لم تكن موجودة
  if (sh.getLastRow() === 0) {
    sh.appendRow(['timestamp','inspector','area','observation','priority','category','needMaintenance','attachment','followUp','status']);
  }
  return sh;
}

// إضافة سجل عبر POST (x-www-form-urlencoded) لتجنّب preflight
function doPost(e) {
  try {
    const p = e.parameter || {};
    if (p.mode === 'add') {
      const sh = _sheet();
      const row = [
        new Date(),
        p.inspector || '',
        p.area || '',
        p.observation || '',
        p.priority || '',
        p.category || '',
        p.needMaintenance || '',
        p.attachment || '',
        p.followUp || '',
        p.status || ''
      ];
      sh.appendRow(row);
      // نعيد JSON (قد لا يكون مقروءًا عبر CORS من دومين خارجي، لكنه مفيد للاختبار المباشر)
      return ContentService.createTextOutput(JSON.stringify({ok:true, message:'added'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({ok:false, message:'bad mode'}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ok:false, error:String(err)}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// جلب آخر N سجلات عبر GET (قد يلزم ضبط الوصول/الأصل بسبب CORS)
function doGet(e) {
  const p = e.parameter || {};
  if (p.mode === 'list') {
    const last = Math.max(1, Math.min(200, Number(p.last||30)));
    const sh = _sheet();
    const rng = sh.getRange(2,1,Math.max(0, sh.getLastRow()-1), sh.getLastColumn());
    const values = rng.getValues();
    const sliced = values.slice(-last);
    const rows = sliced.map(r => ({
      timestamp: Utilities.formatDate(new Date(r[0]), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm'),
      inspector: r[1], area: r[2], observation: r[3], priority: r[4], category: r[5],
      needMaintenance: r[6], attachment: r[7], followUp: r[8], status: r[9]
    }));
    return ContentService.createTextOutput(JSON.stringify({rows}))
      .setMimeType(ContentService.MimeType.JSON);
  }
  return ContentService.createTextOutput('OK');
}
