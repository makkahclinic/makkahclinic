<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>بوابة سباهي الإلكترونية – مجمع مكة الطبي بالزاهر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { --brand:#7B1E24; --brand2:#C55A44; }
    body { font-family:'Tajawal',sans-serif; background:#f9f9f9; }
    .dark body { background:#1a1a1a; color:#eee; }
    .sidebar { width:270px; background:linear-gradient(180deg,var(--brand),var(--brand2)); color:white; }
    .nav-link { display:block; padding:.75rem 1rem; border-radius:.5rem; transition:.2s; }
    .nav-link:hover { background-color:rgba(255,255,255,.15); }
    .active-link { background-color:rgba(255,255,255,.25); }
    .content-section { display:none; }
    .content-section.active { display:block; }
    .org-chart{ display:flex; flex-direction:column; align-items:center; }
    .org-level{ display:flex; justify-content:center; margin:20px 0; }
    .org-node{ background:white; border:1px solid #ddd; border-radius:8px; padding:15px; margin:0 10px; text-align:center; width:200px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    .org-node.director{ background:var(--brand); color:white; }
    .org-node.manager{ background:var(--brand2); color:white; }
    .org-node.head{ background:#e9c46a; }
    .committee-card{ background:white; border-radius:8px; padding:20px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    .committee-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .committee-code{ background:var(--brand); color:white; padding:5px 10px; border-radius:4px; font-weight:bold; }
    .indicator-card{ background:white; border-radius:8px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); text-align:center; }
    .indicator-value{ font-size:2rem; font-weight:bold; margin:10px 0; }
    .progress-bar{ height:10px; background:#e0e0e0; border-radius:5px; overflow:hidden; margin:10px 0; }
    .progress-fill{ height:100%; background:var(--brand); }
    .document-card{ background:white; border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .badge{ font-size:.8rem; background:#f1f5f9; padding:.15rem .4rem; border-radius:.35rem; }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .8rem; border-radius:.5rem; }
    .btn-primary{ background:var(--brand); color:#fff; }
    .btn-primary:hover{ background:#8f2b33; }
    .btn-muted{ background:#e5e7eb; }
    .btn-muted:hover{ background:#d1d5db; }
    .field{ display:flex; flex-direction:column; gap:.3rem; }
    .label{ font-weight:600; color:#374151; }
    .input,.select,.textarea{ border:1px solid #d1d5db; border-radius:.5rem; padding:.55rem .7rem; background:#fff; }
    .textarea{ min-height:120px; }
    .pill{ padding:.15rem .5rem; border-radius:999px; font-size:.75rem; background:#f3f4f6; }
    .watermark { position: absolute; inset-inline-end: 1rem; inset-block-start: 1rem; opacity:.08; }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- Header with logo -->
  <header class="flex justify-between items-center bg-white shadow-md px-6 py-4 sticky top-0 z-50 relative">
    <img id="orgLogoWater" class="watermark h-24 w-24 object-contain pointer-events-none select-none" alt="">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-3">
        <!-- شعار في الطرف (الترويسة) -->
        <img id="orgLogo" src="assets/logo.png" alt="شعار مجمع مكة الطبي العام بالزاهر"
             class="h-14 w-14 object-contain rounded-xl bg-white p-1 shadow-lg">
        <div>
          <h1 class="text-xl font-bold text-gray-800">بوابة سباهي الإلكترونية</h1>
          <p class="text-sm text-gray-500">مجمع مكة الطبي العام بالزاهر – الإصدار 2025</p>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button id="darkModeBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
        <i class="fas fa-moon ml-1"></i> وضع ليلي
      </button>
      <button onclick="window.print()" class="px-4 py-2 btn btn-primary">
        <i class="fas fa-print ml-1"></i> طباعة / PDF
      </button>
    </div>
  </header>

  <div class="flex flex-1">
    <!-- Sidebar -->
    <aside class="sidebar p-4 text-sm leading-relaxed">
      <!-- شعار في الجانب -->
      <div class="flex items-center gap-2 mb-4">
        <img id="orgLogoSide" src="assets/logo.png" alt="شعار" class="h-10 w-10 object-contain rounded bg-white p-1 shadow">
        <div class="font-bold">مجمع مكة الطبي</div>
      </div>

      <div class="font-bold mb-3 text-lg">📚 أقسام بوابة سباهي</div>
      <a href="#home" class="nav-link active-link" onclick="showSection('home')">🏠 الصفحة الرئيسية</a>

      <div class="font-bold mt-4 mb-2">🏛️ القيادة والحوكمة (LD)</div>
      <a href="#leadership" class="nav-link" onclick="showSection('leadership')">الدليل الإداري والتنظيمي</a>
      <a href="#organizational-structure" class="nav-link" onclick="showSection('organizational-structure')">الهيكل التنظيمي</a>
      <a href="#committees" class="nav-link" onclick="showSection('committees')">اللجان الرسمية</a>
      <a href="#key-indicators" class="nav-link" onclick="showSection('key-indicators')">المؤشرات الأساسية</a>

      <div class="font-bold mt-4 mb-2">🛠️ السلامة والمرافق (FMS)</div>
      <a href="#fms-workspace" class="nav-link" onclick="showSection('fms-workspace')">مساحة عمل FMS</a>
      <a href="#dashboard" class="nav-link" onclick="showSection('dashboard')">لوحة المؤشرات</a>
      <a href="#plans" class="nav-link" onclick="showSection('plans')">الخطط الثمانية</a>
      <a href="#forms" class="nav-link" onclick="showSection('forms')">النماذج والسجلات</a>
      <a href="#sources2025" class="nav-link" onclick="showSection('sources2025')">📦 مصادر FMS 2025</a>

      <div class="font-bold mt-4 mb-2">📈 الجودة والتحسين المستمر (QI)</div>
      <a href="#qi" class="nav-link" onclick="showSection('qi')">مؤشرات الجودة</a>

      <div class="font-bold mt-4 mb-2">⚠️ إدارة المخاطر (RM)</div>
      <a href="#rm" class="nav-link" onclick="showSection('rm')">نماذج وتحاليل المخاطر</a>

      <div class="font-bold mt-4 mb-2">🧫 مكافحة العدوى (IPC)</div>
      <a href="#ipc" class="nav-link" onclick="showSection('ipc')">الخطط والسياسات</a>

      <div class="font-bold mt-4 mb-2">❤️‍🩹 سلامة المرضى (PSC)</div>
      <a href="#psc" class="nav-link" onclick="showSection('psc')">سياسات ونماذج سلامة المرضى</a>

      <div class="font-bold mt-4 mb-2">🚨 الطوارئ والكوارث (EOC)</div>
      <a href="#eoc" class="nav-link" onclick="showSection('eoc')">الخطط والإخلاء</a>

      <div class="font-bold mt-4 mb-2">🗂️ التقارير والاعتمادات</div>
      <a href="#reports" class="nav-link" onclick="showSection('reports')">التقارير السنوية</a>
      <a href="#accreditation" class="nav-link" onclick="showSection('accreditation')">ملفات الاعتماد</a>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6 overflow-y-auto" id="mainContent">

      <!-- Home -->
      <section id="home" class="content-section active">
        <div class="flex flex-col items-center justify-center h-full mt-10 relative">
          <div class="h-40 w-40 bg-gradient-to-br from-[var(--brand)] to-[var(--brand2)] rounded-full flex items-center justify-center text-white text-4xl font-bold mb-6 shadow-xl">
            <!-- شعار داخل النص -->
            <img id="orgLogoInHero" src="assets/logo.png" alt="الشعار" class="h-24 w-24 object-contain rounded bg-white p-2 shadow-md">
          </div>
          <h2 class="text-3xl font-bold text-[var(--brand)] mb-3">CBAHI Electronic Portal</h2>
          <p class="text-gray-600 text-lg mb-2">بوابة سباهي الإلكترونية – مجمع مكة الطبي العام بالزاهر</p>
          <p class="text-sm text-gray-400 mb-8">الإصدار الرسمي 2025 – جميع الحقوق محفوظة</p>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
            <div class="bg-white p-6 rounded-lg shadow-md border hover:shadow-lg transition">
              <i class="fas fa-chart-line text-3xl text-[var(--brand)] mb-3"></i>
              <h3 class="font-bold text-lg mb-2">المؤشرات الحيوية</h3>
              <p class="text-gray-600">متابعة مؤشرات الأداء والجودة</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border hover:shadow-lg transition">
              <i class="fas fa-file-alt text-3xl text-[var(--brand)] mb-3"></i>
              <h3 class="font-bold text-lg mb-2">الوثائق والسياسات</h3>
              <p class="text-gray-600">جميع وثائق العمل المعتمدة</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border hover:shadow-lg transition">
              <i class="fas fa-chart-bar text-3xl text-[var(--brand)] mb-3"></i>
              <h3 class="font-bold text-lg mb-2">التقارير الإدارية</h3>
              <p class="text-gray-600">تقارير الأداء والإحصائيات</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Committees (مختصر) -->
      <section id="committees" class="content-section">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-2xl font-bold text-[var(--brand)] mb-6">👥 اللجان الرسمية (حسب سباهي)</h2>
          <!-- (تفاصيل اللجان كما في النسخة السابقة) -->
          <div class="committee-card">
            <div class="committee-header">
              <h3 class="text-xl font-bold">لجنة إدارة المخاطر</h3><span class="committee-code">RM</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div><p class="font-bold text-[var(--brand)]">الرئيس:</p><p>د. حسين بابصيل</p></div>
              <div><p class="font-bold text-[var(--brand)]">المنسق/السكرتير:</p><p>أ. عدنان الرفاعي</p></div>
              <div><p class="font-bold text-[var(--brand)]">تكرار الاجتماعات:</p><p>شهريًا</p></div>
            </div>
            <div>
              <p class="font-bold text-[var(--brand)] mb-2">الأعضاء:</p>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <div class="pill">بلال نتو</div><div class="pill">صابر عبده</div>
                <div class="pill">د. معاذ البيوش</div><div class="pill">د. خالد الخطيب</div>
              </div>
            </div>
          </div>
          <!-- باقي اللجان يمكنك تكرارها من نسختك الأصلية -->
        </div>
      </section>

      <!-- Key Indicators -->
      <section id="key-indicators" class="content-section">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-2xl font-bold text-[var(--brand)] mb-6">📊 المؤشرات الأساسية للقياس والمتابعة</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="indicator-card"><h3 class="font-bold text-lg text-[var(--brand)]">مؤشرات القيادة</h3><div class="indicator-value">92%</div><p>معدل حضور اجتماعات القيادة</p><div class="progress-bar"><div class="progress-fill" style="width:92%"></div></div></div>
            <div class="indicator-card"><h3 class="font-bold text-lg text-[var(--brand)]">مؤشرات الإدارة</h3><div class="indicator-value">88%</div><p>تنفيذ الخطط الإستراتيجية</p><div class="progress-bar"><div class="progress-fill" style="width:88%"></div></div></div>
            <div class="indicator-card"><h3 class="font-bold text-lg text-[var(--brand)]">مؤشرات الموارد البشرية</h3><div class="indicator-value">85%</div><p>معدل إنجاز تقييم الأداء</p><div class="progress-bar"><div class="progress-fill" style="width:85%"></div></div></div>
            <div class="indicator-card"><h3 class="font-bold text-lg text-[var(--brand)]">مؤشرات المالية</h3><div class="indicator-value">94%</div><p>دقة التقارير المالية</p><div class="progress-bar"><div class="progress-fill" style="width:94%"></div></div></div>
            <div class="indicator-card"><h3 class="font-bold text-lg text-[var(--brand)]">مؤشرات الجودة</h3><div class="indicator-value">89%</div><p>معدل تحقيق أهداف الجودة</p><div class="progress-bar"><div class="progress-fill" style="width:89%"></div></div></div>
            <div class="indicator-card"><h3 class="font-bold text-lg text-[var(--brand)]">مؤشرات السلامة</h3><div class="indicator-value">91%</div><p>معدل تنفيذ متطلبات السلامة</p><div class="progress-bar"><div class="progress-fill" style="width:91%"></div></div></div>
          </div>
        </div>
      </section>

      <!-- FMS Workspace -->
      <section id="fms-workspace" class="content-section">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-[var(--brand)]">🛠️ مساحة عمل FMS (متطلبات سباهي)</h2>
            <div class="flex gap-2">
              <button onclick="window.print()" class="px-3 py-2 text-sm btn btn-primary">🖨️ طباعة هذه الصفحة</button>
            </div>
          </div>

          <div class="border-b border-gray-200 mb-4 flex flex-wrap gap-2">
            <button class="px-3 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200" data-fms-tab="needs" onclick="switchFmsTab('needs')">✅ باني الاحتياجات</button>
            <button class="px-3 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200" data-fms-tab="plans" onclick="switchFmsTab('plans')">📁 الخطط الثمانية</button>
            <button class="px-3 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200" data-fms-tab="governance" onclick="switchFmsTab('governance')">🏛️ الحوكمة والسياسات</button>
            <button class="px-3 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200" data-fms-tab="forms" onclick="switchFmsTab('forms')">🗂️ النماذج والسجلات</button>
            <button class="px-3 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200" data-fms-tab="kpis" onclick="switchFmsTab('kpis')">📊 مؤشرات FMS</button>
            <button class="px-3 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200" data-fms-tab="rounds" onclick="switchFmsTab('rounds')">📝 نموذج جولة السلامة</button>
          </div>

          <div id="fmsTabContent" class="space-y-4"></div>
        </div>
      </section>

      <!-- Sources 2025 -->
      <section id="sources2025" class="content-section">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-2xl font-bold text-[var(--brand)] mb-4">📦 مصادر FMS 2025 (خطط/سياسات/نماذج/سجلات)</h2>
          <p class="text-gray-600 mb-3">تُعرض أدناه جميع المصادر التي زوّدتني بها. إذا كان ملف <span class="font-mono bg-gray-100 px-1 rounded">index.json</span> في Google Drive عاماً ويحتوي على ربط (Code → File ID)، فسيتم فتح كل مصدر مباشرة داخل العارض. وإلا ستظهر وصلة إلى مجلد المصادر.</p>
          <div id="sourcesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div class="mt-3 text-sm text-gray-600">📂 مجلد المصادر: <a id="sourcesFolderLink" class="underline text-blue-700" target="_blank" rel="noopener"></a></div>
        </div>
      </section>

      <!-- Other sections headings only -->
      <section id="dashboard" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">📊 لوحة مؤشرات السلامة والمرافق</h2></section>
      <section id="plans" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">🗂️ الخطط الثمانية</h2></section>
      <section id="forms" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">📋 النماذج والسجلات</h2></section>
      <section id="qi" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">📈 مؤشرات الجودة</h2></section>
      <section id="rm" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">⚠️ نماذج وتحاليل المخاطر</h2></section>
      <section id="ipc" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">🧫 الخطط والسياسات</h2></section>
      <section id="psc" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">❤️‍🩹 سياسات ونماذج سلامة المرضى</h2></section>
      <section id="eoc" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">🚨 الخطط والإخلاء</h2></section>
      <section id="reports" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">🗂️ التقارير السنوية</h2></section>
      <section id="accreditation" class="content-section"><h2 class="text-2xl font-bold mb-6 text-[var(--brand)]">🏆 ملفات الاعتماد</h2></section>

    </main>
  </div>

  <footer class="bg-[var(--brand)] text-white text-center py-3 text-sm">
    © 2025 مجمع مكة الطبي العام بالزاهر – بوابة سباهي الإلكترونية
  </footer>

  <!-- ===== Scripts ===== -->
  <script>
  // ====== الإعدادات العامة ======
  // رابط Web App بعد نشر سكربت Google Apps Script (قسم ②)
  const FMS_API_URL = 'YOUR_APPS_SCRIPT_WEB_APP_URL';

  // شعار عبر Google Drive (اختياري): ضع ID للصورة العامة إن رغبت
  const LOGO_DRIVE_ID = ''; // مثال: '1ABCDEF...'
  if (LOGO_DRIVE_ID) {
    const logoURL = `https://drive.google.com/uc?export=view&id=${LOGO_DRIVE_ID}`;
    document.addEventListener('DOMContentLoaded', () => {
      ['orgLogo','orgLogoSide','orgLogoInHero','orgLogoWater'].forEach(id=>{
        const el=document.getElementById(id); if(el) el.src = logoURL;
      });
    });
  }

  // أسماء المراقبين (قابلة للتعديل)
  const INSPECTORS = [
    'أ. بلال نتو','أ. عدنان الرفاعي','أ. صابر عبده','أ. عبدالله حموده',
    'أ. هيثم الجعلي','د. معاذ البيوش','د. خالد الخطيب','د. حسين بابصيل'
  ];

  // روابط Google Drive السابقة للخطط/الحوكمة/النماذج (يمكن الإبقاء عليها كما فعّلنا سابقاً)
  const FMS_PLANS = [];
  const FMS_GOV = [];
  const FMS_FORMS = [];

  // ===== مصادر FMS 2025 التي زوّدتني بها (Code + Title) =====
  const SOURCES_FOLDER_ID = '11CvxbZpNVfRvTXFyJPgbE3y8QM68x461'; // مجلد المصادر
  const INDEX_JSON_ID    = '1FSJ6H5o4I4iG1DZV9-fJLnnsXiAjZwd3'; // index.json إن وُجد

  const FMS_SOURCES = [
    {code:'LOG-FMS-2025-005', title:'سجل الصيانة الوقائية'},
    {code:'PLN-FMS-2025-018', title:'خطة الأمن المادي للمرافق'},
    {code:'LOG-FMS-2025-014', title:'سجل زيارات الدفاع المدني والجهات التنظيمية'},
    {code:'POL-FMS-2025-015', title:'سياسة مراقبة جودة الهواء والتهوية'},
    {code:'CHK-FMS-2025-003', title:'قائمة التحقق الدورية للسلامة'},
    {code:'CHK-FMS-2025-009', title:'سجل جولات لجنة السلامة'},
    {code:'PLN-FMS-2025-012', title:'خطة إدارة الطاقة والمياه'},
    {code:'SOP-FMS-2025-002', title:'إجراءات التشغيل القياسية للجولات وفحص الأنظمة'},
    {code:'FRM-FMS-2025-011', title:'نموذج تقييم المخاطر البيئية والمادية'},
    {code:'FRM-FMS-2025-017', title:'نموذج متابعة تنفيذ التوصيات'},
    {code:'FMS_Docs_2025_endorsed', title:'مجموعة وثائق FMS 2025 المعتمدة'},
    {code:'LOG-FMS-2025-006', title:'سجل الحوادث والملاحظات'},
    {code:'REP-FMS-2025-013', title:'تقرير الحوادث الطارئة'},
    {code:'PLN-FMS-2025-016', title:'خطة الصيانة الطارئة'},
    {code:'POL-FMS-2025-001', title:'سياسة إدارة السلامة والمرافق'},
    {code:'REP-FMS-2025-008', title:'تقرير فحص الطفايات وأنظمة الإنذار'},
    {code:'TRN-FMS-2025-010', title:'خطة تدريب الأمن والسلامة'},
    {code:'DEC-FMS-2025-001', title:'قرار تشكيل لجنة السلامة'},
    {code:'PLN-FMS-2025-007', title:'خطة إدارة النفايات'},
    {code:'PLN-FMS-2025-004', title:'خطة الطوارئ والإخلاء'},
  ];

  // ===== أدوات عامة ======
  const toPreviewById = (id) => `https://drive.google.com/file/d/${id}/preview`;
  const toFolderLink  = (id) => `https://drive.google.com/drive/folders/${id}?usp=sharing`;

  // الوضع الليلي
  document.getElementById('darkModeBtn').addEventListener('click',()=>document.documentElement.classList.toggle('dark'));

  // إظهار الأقسام
  function showSection(sectionId){
    document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(link=>link.classList.remove('active-link'));
    const targetLink=document.querySelector(`.nav-link[href="#${sectionId}"]`); if(targetLink) targetLink.classList.add('active-link');
  }

  // ====== مساحة عمل FMS (نموذج الجولات) ======
  function switchFmsTab(tab){
    document.querySelectorAll('[data-fms-tab]').forEach(btn=>{
      btn.classList.remove('bg-[var(--brand)]','text-white'); btn.classList.add('bg-gray-100','hover:bg-gray-200');
      if(btn.getAttribute('data-fms-tab')===tab){ btn.classList.add('bg-[var(--brand)]','text-white'); btn.classList.remove('bg-gray-100','hover:bg-gray-200'); }
    });
    const c=document.getElementById('fmsTabContent'); c.innerHTML='';
    if(tab==='needs') renderNeeds(c);
    if(tab==='plans') renderList(c, FMS_PLANS, 'خطة/برنامج');
    if(tab==='governance') renderList(c, FMS_GOV, 'سياسة/حوكمة');
    if(tab==='forms') renderList(c, FMS_FORMS, 'نموذج/سجل');
    if(tab==='kpis') renderKpis(c);
    if(tab==='rounds') renderRounds(c);
  }

  // باني الاحتياجات
  const FMS_NEEDS = [
    {key:'charter', label:'ميثاق لجنة السلامة وإدارة المرافق (G01) معتمد', required:true},
    {key:'plans8', label:'اعتماد وتوفر الخطط الثمانية (P01–P08)', required:true},
    {key:'ppmpolicy', label:'سياسة PPM + خطة سنوية موقّعة (G04)', required:true},
    {key:'tours', label:'جولات سلامة ربع سنوية + سجلات F-01/F-08', required:true},
    {key:'civildef', label:'ترخيص الدفاع المدني ساري + سجل F-07', required:true},
    {key:'fire', label:'سجلات إنذار/إطفاء/إنارة طوارئ (F-02/F-03/F-10)', required:true},
    {key:'waste', label:'سجل التخلص من النفايات الطبية/الخطرة (F-09)', required:true},
    {key:'medgas', label:'سياسة/سجل الغازات الطبية (إن وجدت) (G11/F-06)', required:false},
    {key:'training', label:'تعريف الموظفين الجدد + خطة تمارين (G08/G09)', required:true},
    {key:'risk', label:'HVA سنوية + FMEA للعمليات الحرجة (G07)', required:true},
    {key:'compliance', label:'سياسة الامتثال للقوانين والأنظمة (G05)', required:true},
  ];
  function renderNeeds(container){
    const wrap=document.createElement('div'); wrap.className='grid grid-cols-1 md:grid-cols-2 gap-4';
    FMS_NEEDS.forEach(item=>{
      const card=document.createElement('div'); card.className='p-4 rounded border shadow-sm bg-gray-50';
      card.innerHTML = `
        <div class="flex items-start gap-3">
          <input type="checkbox" id="need_${item.key}" class="mt-1 h-5 w-5" ${item.required?'data-required="1"':''}>
          <div><label for="need_${item.key}" class="font-semibold">${item.label}</label>${item.required?'<div class="text-xs text-red-600 mt-1">مطلوب</div>':''}</div>
        </div>`;
      wrap.appendChild(card);
    });
    const actions=document.createElement('div'); actions.className='flex items-center gap-2 mt-2';
    actions.innerHTML = `<button class="btn btn-primary" onclick="validateNeeds()">تحقّق من الاكتمال</button>
                         <button class="btn btn-muted" onclick="window.print()">طباعة</button>`;
    container.appendChild(wrap); container.appendChild(actions);
  }
  function validateNeeds(){
    const missing=[...document.querySelectorAll('input[data-required="1"]')].filter(cb=>!cb.checked);
    alert(missing.length===0?'ممتاز ✅ — جميع المتطلبات الإلزامية مُؤشّر عليها.':('⚠️ عناصر إلزامية غير مكتملة: '+missing.length));
  }

  // قوائم الوثائق العامة
  function renderList(container, items, kind){
    const list=document.createElement('div'); list.className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
    items.forEach(d=>{
      const card=document.createElement('div'); card.className='p-4 rounded border shadow-sm bg-white';
      const openBtn = d.url ? `<button class="px-3 py-1 text-sm btn btn-primary" onclick="openFmsDoc('${d.code||''}: ${d.name||''}', '${d.url}')">📄 عرض</button>`
                            : `<button class="px-3 py-1 text-sm btn btn-muted" disabled>—</button>`;
      const openNew = d.url ? `<a class="px-3 py-1 text-sm btn btn-muted" href="${d.url}" target="_blank" rel="noopener">↗ فتح</a>` : '';
      card.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold text-[var(--brand)]">${d.code||''}</div>
          <span class="text-xs bg-gray-100 px-2 py-1 rounded">${kind}</span>
        </div>
        <div class="mb-3 font-medium">${d.name||''}</div>
        <div class="flex items-center gap-2">${openBtn}${openNew}</div>`;
      list.appendChild(card);
    });
    container.appendChild(list);
  }

  // KPIs
  function renderKpis(container){
    const box=document.createElement('div'); box.className='grid grid-cols-1 md:grid-cols-3 gap-4';
    box.innerHTML = `
      <div class="bg-white p-4 rounded border shadow"><div class="text-sm text-gray-500">نسبة إنجاز الجولات</div><div class="text-2xl font-bold text-[var(--brand)]">85%</div></div>
      <div class="bg-white p-4 rounded border shadow"><div class="text-sm text-gray-500">الصيانة الوقائية (PPM)</div><div class="text-2xl font-bold text-[var(--brand2)]">92%</div></div>
      <div class="bg-white p-4 rounded border shadow"><div class="text-sm text-gray-500">التدريب المنفذ</div><div class="text-2xl font-bold text-[var(--brand)]">78%</div></div>`;
    container.appendChild(box);
  }

  // ===== نموذج الجولات (يرسل إلى Google Sheets عبر Web App) =====
  function renderRounds(container){
    const wrap=document.createElement('div'); wrap.className='grid grid-cols-1 gap-4';
    wrap.innerHTML = `
      <div class="p-4 rounded border shadow-sm bg-white">
        <h3 class="font-bold text-lg mb-3 text-[var(--brand)]">📝 إدخال جولة سلامة</h3>
        <form id="roundForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="field">
            <label class="label">اسم المراقب</label>
            <select name="inspector" id="inspector" class="select" required></select>
          </div>
          <div class="field">
            <label class="label">الموقع/القسم</label>
            <input name="area" id="area" class="input" placeholder="مثال: عيادات الأسنان / المختبر" required/>
          </div>
          <div class="field md:col-span-2">
            <label class="label">الوصف/الملاحظة</label>
            <textarea name="observation" id="observation" class="textarea" placeholder="وصف الملاحظة بدقة" required></textarea>
          </div>
          <div class="field">
            <label class="label">الأولوية</label>
            <select name="priority" id="priority" class="select" required>
              <option value="حرجة">حرجة (عالية جدًا)</option>
              <option value="عالية">عالية</option>
              <option value="متوسطة" selected>متوسطة</option>
              <option value="منخفضة">منخفضة</option>
            </select>
          </div>
          <div class="field">
            <label class="label">التصنيف</label>
            <select name="category" id="category" class="select">
              <option>سلامة عامة</option><option>كهرباء</option><option>ميكانيك</option><option>غازات طبية</option>
              <option>نظافة</option><option>أمن</option><option>نفايات</option><option>حريق</option><option>أخرى</option>
            </select>
          </div>
          <div class="field">
            <label class="label">هل تحتاج تذكرة صيانة؟</label>
            <select name="needMaintenance" id="needMaintenance" class="select">
              <option value="نعم">نعم</option><option value="لا" selected>لا</option>
            </select>
          </div>
          <div class="field">
            <label class="label">رابط مرفق (اختياري)</label>
            <input name="attachment" id="attachment" class="input" placeholder="رابط صورة Google Drive/ملف"/>
          </div>
          <div class="field">
            <label class="label">تاريخ المتابعة (اختياري)</label>
            <input type="date" name="followUp" id="followUp" class="input"/>
          </div>
          <div class="field">
            <label class="label">الحالة</label>
            <select name="status" id="status" class="select">
              <option>مفتوحة</option><option>قيد المعالجة</option><option>منجزة</option>
            </select>
          </div>
          <div class="md:col-span-2 flex items-center gap-2">
            <button class="btn btn-primary" type="submit">إرسال السجل</button>
            <button class="btn btn-muted" type="button" id="refreshRounds">تحديث السجل (آخر الإدخالات)</button>
            <span id="roundMsg" class="text-sm"></span>
          </div>
        </form>
      </div>

      <div class="p-4 rounded border shadow-sm bg-white">
        <h3 class="font-bold text-lg mb-3 text-[var(--brand)]">📜 أحدث الإدخالات</h3>
        <div id="roundsTable" class="overflow-x-auto text-sm">—</div>
      </div>`;
    container.appendChild(wrap);

    // تعبئة أسماء المراقبين
    const sel=document.getElementById('inspector'); sel.innerHTML = INSPECTORS.map(n=>`<option>${n}</option>`).join('');

    // إرسال
    document.getElementById('roundForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!FMS_API_URL || FMS_API_URL==='YOUR_APPS_SCRIPT_WEB_APP_URL'){
        alert('⚠️ رجاءً ضع رابط Web App في المتغير FMS_API_URL أعلى الصفحة.'); return;
      }
      const data = new URLSearchParams({
        mode:'add',
        inspector: document.getElementById('inspector').value,
        area: document.getElementById('area').value,
        observation: document.getElementById('observation').value,
        priority: document.getElementById('priority').value,
        category: document.getElementById('category').value,
        needMaintenance: document.getElementById('needMaintenance').value,
        attachment: document.getElementById('attachment').value,
        followUp: document.getElementById('followUp').value,
        status: document.getElementById('status').value
      });

      const msg=document.getElementById('roundMsg'); msg.textContent='جارٍ الإرسال…';
      try{
        // نستخدم x-www-form-urlencoded لتجنّب مشاكل preflight CORS (طلب بسيط)
        const res = await fetch(FMS_API_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
          body:data.toString()
        });
        if(res.ok){ msg.textContent='✅ تمّ الإرسال بنجاح.'; (e.target).reset(); }
        else { msg.textContent='⚠️ لم يتم الإرسال (تحقق من صلاحيات الويب آب).'; }
      }catch(err){ console.error(err); msg.textContent='⚠️ تعذّر الإرسال — تحقق من الرابط/الصلاحيات.'; }
    });

    // جلب آخر الإدخالات
    async function loadRounds(){
      if(!FMS_API_URL || FMS_API_URL==='YOUR_APPS_SCRIPT_WEB_APP_URL'){
        document.getElementById('roundsTable').textContent='ضع رابط Web App في FMS_API_URL لعرض السجل.'; return;
      }
      try{
        const url = FMS_API_URL + '?mode=list&last=30';
        const res = await fetch(url);
        const json = await res.json();
        const rows = json.rows || [];
        if(rows.length===0){ document.getElementById('roundsTable').textContent='لا توجد بيانات بعد.'; return; }
        const headers = ['التاريخ/الوقت','المراقب','الموقع','الأولوية','التصنيف','الوصف','تذكرة صيانة','رابط','متابعة','الحالة'];
        const html = `
          <table class="min-w-full bg-white border border-gray-200">
            <thead class="bg-gray-100">
              <tr>${headers.map(h=>`<th class="px-3 py-2 text-right border-b">${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${rows.map(r=>`
                <tr class="border-b hover:bg-gray-50">
                  <td class="px-3 py-2">${r.timestamp||''}</td>
                  <td class="px-3 py-2">${r.inspector||''}</td>
                  <td class="px-3 py-2">${r.area||''}</td>
                  <td class="px-3 py-2">${r.priority||''}</td>
                  <td class="px-3 py-2">${r.category||''}</td>
                  <td class="px-3 py-2">${r.observation||''}</td>
                  <td class="px-3 py-2">${r.needMaintenance||''}</td>
                  <td class="px-3 py-2">${r.attachment?`<a class="text-blue-600 underline" href="${r.attachment}" target="_blank">فتح</a>`:''}</td>
                  <td class="px-3 py-2">${r.followUp||''}</td>
                  <td class="px-3 py-2">${r.status||''}</td>
                </tr>`).join('')}
            </tbody>
          </table>`;
        document.getElementById('roundsTable').innerHTML = html;
      }catch(err){
        console.warn('CORS?', err);
        document.getElementById('roundsTable').innerHTML =
          '<div class="text-red-600">⚠️ تعذّر جلب السجل من الويب آب (قد تكون قيود CORS). الإرسال سيعمل، لكن عرض السجل داخل البوابة قد يحتاج ضبط إعدادات النشر.</div>';
      }
    }
    document.getElementById('refreshRounds').addEventListener('click', loadRounds);
    setTimeout(loadRounds, 300);
  }

  // ===== مصادر 2025: بناء القائمة والروابط =====
  async function buildSources(){
    const folderLink = toFolderLink(SOURCES_FOLDER_ID);
    document.getElementById('sourcesFolderLink').href = folderLink;
    document.getElementById('sourcesFolderLink').textContent = folderLink;

    // جرّب تحميل index.json (مرفوع كـ "عام")
    let indexMap = {};
    try {
      const indexUrl = `https://drive.google.com/uc?export=download&id=${INDEX_JSON_ID}`;
      const res = await fetch(indexUrl);
      if (res.ok) {
        const data = await res.json();
        // نتوقع شكلاً مثل: { "LOG-FMS-2025-005": "FILE_ID", ... }
        indexMap = data || {};
      }
    } catch(e) { console.warn('index.json not reachable or not JSON', e); }

    const list = document.getElementById('sourcesList');
    list.innerHTML = '';
    FMS_SOURCES.forEach(src=>{
      const id = indexMap[src.code]; // قد تكون غير موجودة
      const previewUrl = id ? toPreviewById(id) : null;

      const card=document.createElement('div'); card.className='p-4 rounded border shadow-sm bg-white';
      card.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="font-bold text-[var(--brand)]">${src.code}</div>
          <span class="text-xs bg-gray-100 px-2 py-1 rounded">مصدر</span>
        </div>
        <div class="mb-3 font-medium">${src.title}</div>
        <div class="flex items-center gap-2">
          ${ previewUrl
              ? `<button class="px-3 py-1 text-sm btn btn-primary" onclick="openFmsDoc('${src.code}: ${src.title}', '${previewUrl}')">📄 عرض</button>
                 <a class="px-3 py-1 text-sm btn btn-muted" href="${previewUrl}" target="_blank" rel="noopener">↗ فتح</a>`
              : `<a class="px-3 py-1 text-sm btn btn-primary" href="${folderLink}" target="_blank" rel="noopener">📂 فتح المجلد</a>
                 <span class="text-xs text-gray-500">لم يُحدَّد المعرّف في index.json</span>`
          }
        </div>`;
      list.appendChild(card);
    });
  }

  // Modal
  function openFmsDoc(title,url){
    document.getElementById('fmsModalTitle').textContent=title;
    document.getElementById('fmsModalFrame').src=url||'about:blank';
    document.getElementById('fmsModalOpenNew').href=url||'#';
    document.getElementById('fmsModal').classList.remove('hidden'); document.getElementById('fmsModal').classList.add('flex');
  }
  function closeFmsModal(){
    document.getElementById('fmsModal').classList.add('hidden'); document.getElementById('fmsModal').classList.remove('flex');
    document.getElementById('fmsModalFrame').src='about:blank';
  }

  // افتح تبويب «الاحتياجات» افتراضياً عند دخول مساحة العمل
  document.addEventListener('DOMContentLoaded', ()=>{
    const activeSection=document.querySelector('.content-section.active');
    if(activeSection && activeSection.id==='fms-workspace'){ switchFmsTab('needs'); }
    document.querySelectorAll('.nav-link').forEach(link=>{
      link.addEventListener('click',(e)=>{
        const sectionId=e.target.getAttribute('href').substring(1);
        if(sectionId==='fms-workspace'){ setTimeout(()=>switchFmsTab('needs'),50); }
        if(sectionId==='sources2025'){ setTimeout(buildSources, 50); }
      });
    });
    // عيّن رابط المجلد أسفل قسم المصادر
    const folderLink = toFolderLink(SOURCES_FOLDER_ID);
    const a = document.getElementById('sourcesFolderLink'); a.href = folderLink; a.textContent = folderLink;

    // شعار مائي خفيف
    const wm = document.getElementById('orgLogoWater');
    const mainLogo = document.getElementById('orgLogo');
    if (mainLogo && wm && mainLogo.src) { wm.src = mainLogo.src; }
  });
  </script>

  <!-- FMS Modal -->
  <div id="fmsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white w-[95vw] max-w-4xl rounded-lg shadow-xl overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <h3 id="fmsModalTitle" class="font-bold text-lg">عرض الوثيقة</h3>
        <button onclick="closeFmsModal()" class="text-gray-600 hover:text-gray-900">✕</button>
      </div>
      <div class="p-0"><iframe id="fmsModalFrame" class="w-full h-[70vh]" src="about:blank" allow="autoplay"></iframe></div>
      <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
        <a id="fmsModalOpenNew" href="#" target="_blank" class="text-[var(--brand)] underline">فتح في تبويب جديد</a>
        <button onclick="closeFmsModal()" class="px-3 py-2 btn btn-muted">إغلاق</button>
      </div>
    </div>
  </div>
</body>
</html>
