<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>بوابة سباهي الإلكترونية – مجمع مكة الطبي بالزاهر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background-color: #f9f9f9; }
    .dark body { background-color: #1a1a1a; color: #eee; }
    .sidebar { width: 270px; background: linear-gradient(180deg, #7B1E24, #C55A44); color: white; }
    .nav-link { display: block; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; }
    .nav-link:hover { background-color: rgba(255,255,255,0.15); }
    .active-link { background-color: rgba(255,255,255,0.25); }
    .content-section { display: none; }
    .content-section.active { display: block; }
    .org-chart { display: flex; flex-direction: column; align-items: center; }
    .org-level { display: flex; justify-content: center; margin: 20px 0; flex-wrap: wrap; } /* Added flex-wrap */
    .org-node { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px; text-align: center; width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .org-node.director { background: #7B1E24; color: white; }
    .org-node.manager { background: #C55A44; color: white; }
    .org-node.head { background: #e9c46a; }
    .committee-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .committee-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .committee-code { background: #7B1E24; color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold; }
    .committee-members { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .member-card { background: #f5f5f5; padding: 10px; border-radius: 5px; }
    .indicator-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
    .indicator-value { font-size: 2rem; font-weight: bold; margin: 10px 0; }
    .progress-bar { height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; margin: 10px 0; }
    .progress-fill { height: 100%; background: #7B1E24; }
    .document-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    /* Loader for form submission */
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #7B1E24; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="min-h-screen flex flex-col">

    <header class="flex justify-between items-center bg-white shadow-md px-6 py-4 sticky top-0 z-50">
    <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
        <div class="h-14 w-14 bg-gradient-to-br from-[#7B1E24] to-[#C55A44] rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">
          <i class="fas fa-hospital-alt"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-800">بوابة سباهي الإلكترونية</h1>
          <p class="text-sm text-gray-500">مجمع مكة الطبي العام بالزاهر – الإصدار 2025</p>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button id="darkModeBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-200">
        <i class="fas fa-moon ml-1"></i>
        وضع ليلي
      </button>
      <button onclick="window.print()" class="px-4 py-2 bg-[#7B1E24] text-white rounded-lg hover:bg-[#8f2b33] transition duration-200">
        <i class="fas fa-print ml-1"></i>
        طباعة / PDF
      </button>
    </div>
  </header>

    <div class="flex flex-1 overflow-hidden">

        <aside class="sidebar p-4 text-sm leading-relaxed overflow-y-auto flex-shrink-0">
      <div class="font-bold mb-3 text-lg">📚 أقسام بوابة سباهي</div>
      <a href="#home" class="nav-link active-link" onclick="showSection('home')">🏠 الصفحة الرئيسية</a>

      <div class="font-bold mt-4 mb-2">🏛️ القيادة والحوكمة (LD)</div>
      <a href="#leadership" class="nav-link" onclick="showSection('leadership')">الدليل الإداري والتنظيمي</a>
      <a href="#organizational-structure" class="nav-link" onclick="showSection('organizational-structure')">الهيكل التنظيمي</a>
      <a href="#committees" class="nav-link" onclick="showSection('committees')">اللجان الرسمية</a>
      <a href="#key-indicators" class="nav-link" onclick="showSection('key-indicators')">المؤشرات الأساسية</a>

      <div class="font-bold mt-4 mb-2">🛠️ السلامة والمرافق (FMS)</div>
      <a href="#fms-workspace" class="nav-link" onclick="showSection('fms-workspace')">مساحة عمل FMS</a>
      <a href="#dashboard" class="nav-link" onclick="showSection('dashboard')">لوحة المؤشرات العامة</a>
            <div class="font-bold mt-4 mb-2">📈 الجودة والتحسين المستمر (QI)</div>
      <a href="#qi" class="nav-link" onclick="showSection('qi')">مؤشرات الجودة</a>

      <div class="font-bold mt-4 mb-2">⚠️ إدارة المخاطر (RM)</div>
      <a href="#rm" class="nav-link" onclick="showSection('rm')">نماذج وتحاليل المخاطر</a>

      <div class="font-bold mt-4 mb-2">🧫 مكافحة العدوى (IPC)</div>
      <a href="#ipc" class="nav-link" onclick="showSection('ipc')">الخطط والسياسات</a>

      <div class="font-bold mt-4 mb-2">❤️‍🩹 سلامة المرضى (PSC)</div>
      <a href="#psc" class="nav-link" onclick="showSection('psc')">سياسات ونماذج سلامة المرضى</a>

      <div class="font-bold mt-4 mb-2">🚨 الطوارئ والكوارث (EOC)</div>
      <a href="#eoc" class="nav-link" onclick="showSection('eoc')">الخطط والإخلاء</a>

      <div class="font-bold mt-4 mb-2">🗂️ التقارير والاعتمادات</div>
      <a href="#reports" class="nav-link" onclick="showSection('reports')">التقارير السنوية</a>
      <a href="#accreditation" class="nav-link" onclick="showSection('accreditation')">ملفات الاعتماد</a>
    </aside>

        <main class="flex-1 p-6 overflow-y-auto" id="mainContent">
      
            <section id="home" class="content-section active">
        <div class="flex flex-col items-center justify-center h-full mt-10">
                    <div class="h-40 w-40 bg-gradient-to-br from-[#7B1E24] to-[#C55A44] rounded-full flex items-center justify-center text-white text-4xl font-bold mb-6 shadow-xl">
            <i class="fas fa-hospital-user"></i>
          </div>
          <h2 class="text-3xl font-bold text-[#7B1E24] mb-3">CBAHI Electronic Portal</h2>
          <p class="text-gray-600 text-lg mb-2">بوابة سباهي الإلكترونية – مجمع مكة الطبي العام بالزاهر</p>
          <p class="text-sm text-gray-400 mb-8">الإصدار الرسمي 2025 – جميع الحقوق محفوظة</p>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
            <div class="bg-white p-6 rounded-lg shadow-md border hover:shadow-lg transition duration-300">
              <i class="fas fa-chart-line text-3xl text-[#7B1E24] mb-3"></i>
              <h3 class="font-bold text-lg mb-2">المؤشرات الحيوية</h3>
              <p class="text-gray-600">متابعة مؤشرات الأداء والجودة</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border hover:shadow-lg transition duration-300">
              <i class="fas fa-file-alt text-3xl text-[#7B1E24] mb-3"></i>
              <h3 class="font-bold text-lg mb-2">الوثائق والسياسات</h3>
              <p class="text-gray-600">جميع وثائق العمل المعتمدة</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border hover:shadow-lg transition duration-300">
              <i class="fas fa-chart-bar text-3xl text-[#7B1E24] mb-3"></i>
              <h3 class="font-bold text-lg mb-2">التقارير الإدارية</h3>
              <p class="text-gray-600">تقارير الأداء والاحصائيات</p>
            </div>
          </div>
        </div>
      </section>

        <section id="fms-workspace" class="content-section">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-[#7B1E24]">🛠️ مساحة عمل FMS (متطلبات سباهي)</h2>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="px-3 py-2 text-sm bg-[#7B1E24] text-white rounded-lg hover:bg-[#8f2b33]">
                            🖨️ طباعة هذه الصفحة
                        </button>
                    </div>
                </div>

                <div class="border-b border-gray-200 mb-4 flex flex-wrap gap-2">
                    <button class="px-3 py-2 text-sm rounded" data-fms-tab="rounds" onclick="switchFmsTab('rounds')">📝 تسجيل جولة سلامة</button>
                    <button class="px-3 py-2 text-sm rounded" data-fms-tab="needs" onclick="switchFmsTab('needs')">✅ باني الاحتياجات</button>
                    <button class="px-3 py-2 text-sm rounded" data-fms-tab="plans" onclick="switchFmsTab('plans')">📁 الخطط الثمانية</button>
                    <button class="px-3 py-2 text-sm rounded" data-fms-tab="governance" onclick="switchFmsTab('governance')">🏛️ الحوكمة والسياسات</button>
                    <button class="px-3 py-2 text-sm rounded" data-fms-tab="forms" onclick="switchFmsTab('forms')">🗂️ النماذج والسجلات</button>
                    <button class="px-3 py-2 text-sm rounded" data-fms-tab="kpis" onclick="switchFmsTab('kpis')">📊 مؤشرات FMS</button>
                </div>

                <div id="fmsTabContent" class="space-y-4">
                    </div>
            </div>
        </section>

            <section id="leadership" class="content-section">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-[#7B1E24]">🏛️ الدليل الإداري والتنظيمي المختصر</h2>
            <span class="bg-[#7B1E24] text-white px-3 py-1 rounded text-sm">الإصدار 2025</span>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <p class="text-blue-800 font-medium">يعتمد هذا الدليل من قبل المدير العام / المالك:</p>
            <p class="text-blue-800 text-lg font-bold mt-2">د. حسين بن محمد حسن شيخ بابصيل</p>
            <p class="text-blue-700 text-sm mt-2">على أن يُراجع سنويًا أو عند أي تعديل تنظيمي.</p>
          </div>
          
          <h3 class="text-xl font-bold text-[#7B1E24] mb-4">القيادة العليا</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <h4 class="font-bold text-lg text-[#7B1E24] mb-2">المدير العام / المالك</h4>
              <p class="font-medium">د. حسين بن محمد حسن شيخ بابصيل</p>
              <p class="text-sm text-gray-600 mt-2">الإشراف العام على المجمع واتخاذ القرارات الاستراتيجية</p>
            </div>
          </div>
          
          <h3 class="text-xl font-bold text-[#7B1E24] mt-6 mb-4">الإدارات التنفيذية</h3>
          <p class="text-gray-600 mb-4">(مرتبة حسب العرض المعتمد)</p>
          
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
              <thead class="bg-[#7B1E24] text-white">
                <tr>
                  <th class="py-3 px-4 text-right">القسم</th>
                  <th class="py-3 px-4 text-right">المدير</th>
                  <th class="py-3 px-4 text-right">المهام الأساسية</th>
                </tr>
              </thead>
              <tbody>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">الإدارة الإدارية</td>
                  <td class="py-3 px-4">أ. بلال نتو</td>
                  <td class="py-3 px-4">التشغيل اليومي، الموارد البشرية، التدريب، الاستقبال والمواعيد</td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">الإدارة الطبية</td>
                  <td class="py-3 px-4">د. معاذ البيوش (نائب: د. خالد الخطيب)</td>
                  <td class="py-3 px-4">الإشراف على العيادات والخدمات السريرية وجودتها</td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">الإدارة المالية والتأمين</td>
                  <td class="py-3 px-4">أ. صابر عبده</td>
                  <td class="py-3 px-4">الحسابات، المطالبات، إدارة دورة الإيراد، التقارير المالية</td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">الصيانة والمرافق</td>
                  <td class="py-3 px-4">أ. عدنان الرفاعي</td>
                  <td class="py-3 px-4">الصيانة الوقائية، السلامة المرافقية، الطوارئ، المشتريات غير الطبية، النظافة</td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">الصيدلية</td>
                  <td class="py-3 px-4">أ. عبدالله حموده</td>
                  <td class="py-3 px-4">الصرف الدوائي الآمن، ضبط الأدوية عالية الخطورة، سلسلة التبريد، المخزون</td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">المختبر</td>
                  <td class="py-3 px-4">أ. هيثم الجعلي</td>
                  <td class="py-3 px-4">ضبط الجودة المخبرية، سلامة العينات، السلامة الحيوية</td>
                </tr>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 font-medium">الأشعة</td>
                  <td class="py-3 px-4">أ. بلال نتو</td>
                  <td class="py-3 px-4">الإشراف الفني والإشعاعي وفق متطلبات NRRC</td>
                </tr>
              </tbody>
            </table>
          </div>

                    <div class="documents-section mt-8">
            <h3 class="text-xl font-bold text-[#7B1E24] mb-4">📋 الوثائق المعتمدة</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="document-card">
                <div class="flex items-center gap-3">
                  <i class="fas fa-file-pdf text-2xl text-red-500"></i>
                  <div>
                    <h4 class="font-bold">الدليل الإداري والتنظيمي والتشغيلي</h4>
                    <p class="text-sm text-gray-600">الوثيقة الرئيسية للمجمع</p>
                    <p class="text-sm text-gray-500">معتمد بتاريخ: 2025</p>
                    <p class="text-xs text-green-600">✔️ معتمد من المدير العام</p>
                  </div>
                </div>
                <div class="mt-3 flex gap-2">
                  <button onclick="showDocument('الدليل الإداري')" class="px-3 py-1 bg-[#7B1E24] text-white text-sm rounded hover:bg-[#8f2b33]">
                    📄 عرض الوثيقة
                  </button>
                  <button class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300">
                    ⬇️ تحميل PDF
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

            <section id="organizational-structure" class="content-section">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-2xl font-bold text-[#7B1E24] mb-6">🏢 الهيكل التنظيمي</h2>
          
          <div class="org-chart">
                        <div class="org-level">
              <div class="org-node director">
                <h3 class="font-bold">المدير العام / المالك</h3>
                <p class="mt-1">د. حسين بن محمد حسن شيخ بابصيل</p>
              </div>
            </div>
            
                        <div class="h-8 w-1 bg-gray-400"></div>
            
                        <div class="org-level">
              <div class="org-node manager">
                <h3 class="font-bold">الإدارة الإدارية</h3>
                <p class="mt-1">أ. بلال نتو</p>
              </div>
              <div class="org-node manager">
                <h3 class="font-bold">الإدارة الطبية</h3>
                <p class="mt-1">د. معاذ البيوش</p>
                <p class="text-sm">(نائب: د. خالد الخطيب)</p>
              </div>
              <div class="org-node manager">
                <h3 class="font-bold">الإدارة المالية</h3>
                <p class="mt-1">أ. صابر عبده</p>
              </div>
            </div>
            
                        <div class="h-8 w-1 bg-gray-400"></div>
            
                        <div class="org-level">
              <div class="org-node head">
                <h3 class="font-bold">الصيانة والمرافق</h3>
                <p class="mt-1">أ. عدنان الرفاعي</p>
              </div>
              <div class="org-node head">
                <h3 class="font-bold">الصيدلية</h3>
                <p class="mt-1">أ. عبدالله حموده</p>
              </div>
              <div class="org-node head">
                <h3 class="font-bold">المختبر</h3>
                <p class="mt-1">أ. هيثم الجعلي</p>
              </div>
              <div class="org-node head">
                <h3 class="font-bold">الأشعة</h3>
                <p class="mt-1">أ. بلال نتو</p>
              </div>
            </div>
          </div>
        </div>
      </section>

            <section id="committees" class="content-section">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-2xl font-bold text-[#7B1E24] mb-6">👥 اللجان الرسمية (حسب سباهي)</h2>
          
                    </div>
      </section>

            <section id="key-indicators" class="content-section">
              </section>

            <section id="dashboard" class="content-section">
        <h2 class="text-2xl font-bold mb-6 text-[#7B1E24]">📊 لوحة مؤشرات السلامة والمرافق (العامة)</h2>
              </section>

          </main>
  </div>

    <div id="fmsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-5xl rounded-lg shadow-xl overflow-hidden">
            <div class="flex items-center justify-between px-4 py-3 border-b bg-gray-50">
                <h3 id="fmsModalTitle" class="font-bold text-lg text-[#7B1E24]">عرض الوثيقة</h3>
                <button onclick="closeFmsModal()" class="text-gray-600 hover:text-gray-900 text-2xl">✕</button>
            </div>
            <div class="p-0">
                <iframe id="fmsModalFrame" class="w-full h-[75vh]" src="about:blank" frameborder="0"></iframe>
            </div>
            <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                <a id="fmsModalOpenNew" href="#" target="_blank" class="text-[#7B1E24] underline hover:text-[#C55A44]">فتح في تبويب جديد (Google Drive)</a>
                <button onclick="closeFmsModal()" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">إغلاق</button>
            </div>
        </div>
    </div>

    <footer class="bg-[#7B1E24] text-white text-center py-3 text-sm mt-auto">
    © 2025 مجمع مكة الطبي العام بالزاهر – بوابة سباهي الإلكترونية
  </footer>

    <script>
    // تبديل الوضع الليلي
    document.getElementById('darkModeBtn').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
    });

    // إدارة عرض الأقسام (Navigation)
    function showSection(sectionId) {
      // إخفاء جميع الأقسام
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // إظهار القسم المطلوب
      const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
        }
      
      // تحديث الروابط النشطة في الشريط الجانبي
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active-link');
      });
        
        // العثور على الرابط المطابق لـ sectionId وتفعيله
        const activeLink = document.querySelector(`.nav-link[href="#${sectionId}"]`);
        if (activeLink) {
            activeLink.classList.add('active-link');
        }

        // تهيئة مساحة عمل FMS عند فتحها لأول مرة
        if (sectionId === 'fms-workspace' && document.getElementById('fmsTabContent').innerHTML.trim() === '') {
            switchFmsTab('rounds'); // البدء بتبويب جولات السلامة
        }
    }

    // دوال مساعدة (Placeholders)
    function showCommitteeDetails(committeeCode) {
      alert(`سيتم فتح صفحة تفصيلية للجنة ${committeeCode} في التحديثات القادمة`);
    }

    function showDocument(docName) {
      alert(`سيتم فتح وثيقة ${docName} في التحديثات القادمة`);
    }
  </script>

  <script>
// ===== إعدادات عامة لمساحة FMS =====

// !!! هام جداً: استبدل هذا الرابط برابط Web App الذي نسخته من Google Apps Script (ينتهي بـ /exec) !!!
const FMS_API_URL = 'YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE'; 

// قائمة المراقبين (يمكن تعديلها حسب الحاجة)
const OBSERVERS_LIST = [
    "أ. عدنان الرفاعي (الصيانة والمرافق)",
    "أ. بلال نتو (الإدارة الإدارية)",
    "د. معاذ البيوش (الإدارة الطبية)",
    "د. خالد الخطيب (نائب الإدارة الطبية)",
    "أ. صابر عبده (الإدارة المالية)",
    "مسؤول السلامة المناوب"
];

// خرائط الوثائق (تم تحديثها بالروابط المقدمة)
const FMS_PLANS = [
    {code:'FMS-P01', name:'خطة سلامة المبنى', url:'https://drive.google.com/open?id=1AGGLtgZxTi8ayyax2_GNMxYRGzVptIIQn6wL8d1YDxI'},
    {code:'FMS-P02', name:'خطة الأمن', url:'https://drive.google.com/open?id=1F2yADLhaH1bXivI3POD-O4g-ie7eNSxxDfeTD8fodLQ'},
    {code:'FMS-P03', name:'خطة المواد الخطرة والنفايات', url:'https://drive.google.com/open?id=1xHgATBGqHfIDD1AOu72GV9VEHykuCTLTFAiA87E6n24'},
    {code:'FMS-P04', name:'خطة الطوارئ الداخلية', url:'https://drive.google.com/open?id=1VhDjLfJ87EgdPFmRQv8-iUQo9RrKopXN7R9OR05rCh4'},
    {code:'FMS-P05', name:'خطة الطوارئ الخارجية', url:'https://drive.google.com/open?id=1P_anLCQ5DL16cDVbB9TN2ixmAjhzJAvuiOn0uZNXZ3s'},
    {code:'FMS-P06', name:'برنامج/خطة السلامة من الحرائق', url:'https://drive.google.com/open?id=1jtjdCFWQZHkb5_GvYQLBnEukgQd372DafsttNgoPL1U'},
    {code:'FMS-P07', name:'برنامج إدارة الأجهزة الطبية', url:'https://drive.google.com/open?id=1HLlqjcoTy8m430Ylv_OfdNjka-vBKmGSuj6riYXHrJE'},
    {code:'FMS-P08', name:'برنامج إدارة أنظمة المرافق (Utilities)', url:'https://drive.google.com/open?id=14rRrTw26-bmvoq7C2MnDJl726shxyMiB-dfx_0ivFoA'},
];

const FMS_GOV = [
    {code:'FMS-G01', name:'ميثاق لجنة السلامة وإدارة المرافق (Charter)', url:'https://drive.google.com/open?id=1KIROSbJQD2JJeAQ26GgYiad1F6-WKh_VdyJrYJa-4ps'},
    {code:'FMS-G02', name:'الوصف الوظيفي لمدير برنامج FMS', url:'https://drive.google.com/open?id=122BI7pf6KyaxjkL-8a0JV6l-GXrIrELPR68kCfU6TvY'},
    {code:'FMS-G03', name:'سياسة الجولات الميدانية وسجل الجولات', url:'https://drive.google.com/open?id=18T5VVTTNWFlMQW1in4-ISICWeuDVadnKwFQ-w0CeKB0'},
    {code:'FMS-G04', name:'سياسة الصيانة الوقائية (PPM) والخطة السنوية', url:'https://drive.google.com/open?id=1rcVBagz1pBNy6j5kZAMeufBfr0Oi3yXO-V3XWzS6i4E'},
    {code:'FMS-G05', name:'سياسة الامتثال للقوانين والأنظمة', url:'https://drive.google.com/open?id=1drrRo-0uLYRaHb_wbYt47KrXMx8im0SYSq9zY2DoT7k'},
    {code:'FMS-G06', name:'سلامة أعمال البناء/التجديد/الهدم', url:'https://drive.google.com/open?id=1wlJTSLZG1D0r8vFbOhIntv6CCETiGYumEnUwwY_mXDw'},
    {code:'FMS-G07', name:'سياسة إدارة المخاطر (HVA/FMEA) لسلامة المرافق', url:'https://drive.google.com/open?id=196HNzcBQ7UdQebXqn0GNkeo76qOv2U2a63oPFDCFRBU'},
    {code:'FMS-G08', name:'خطة التدريب والتوعية والتوجيه (موظفون جدد)', url:'https://drive.google.com/open?id=1HHtEAcfxdjux--qf_XCmh4-BnaGDvHcmi9wJoyD-tOQ'},
    {code:'FMS-G09', name:'سياسة الاختبارات والتمارين للإخلاء والطوارئ', url:'https://drive.google.com/open?id=12q5YPfENXweWV2baN0j_Hji13ZBfm2YQLNHniZ8OHf8'},
    {code:'FMS-G10', name:'سياسة التحكم بالدخول وإدارة المفاتيح', url:'https://drive.google.com/open?id=1Qx-QjXCNnDfG5OysZbcPWot_PI4prNOxzTsN4k3Ghjs'},
    {code:'FMS-G11', name:'سياسة إدارة الغازات الطبية (إن وجدت)', url:'https://drive.google.com/open?id=1EIIWFjHAL9ND1NfErzM0SlZYCkwGT-k5di_z5S7H9Rs'},
];

const FMS_FORMS = [
    {code:'F-01', name:'نموذج جولة سلامة المرفق', url:'about:blank'}, // الرابط غير متوفر
    {code:'F-02', name:'سجل اختبار أنظمة الإنذار من الحريق', url:'https://drive.google.com/open?id=1iDZaOKZvI4Qz9bdIwyx2XWtKvb4hagGqKmcdmyNoSAQ'},
    {code:'F-03', name:'سجل صيانة معدات الإطفاء', url:'https://drive.google.com/open?id=1wk9m2MBx6yxHu-lSRqD116pxPP2fNspO5IOMS1fUt_8'},
    {code:'F-04', name:'تقرير تمرين الإخلاء وما بعد التمرين', url:'https://drive.google.com/open?id=1B_wWO7uTKkVlEc6NEFYo2xAMWoHi2lxIah6tOml6AAw'},
    {code:'F-05', name:'سجل صيانة الأجهزة الطبية', url:'https://drive.google.com/open?id=1CD_TRRgsRiBchZ9Kz8xjZ6MnYA9ceuqSKPPd8-QVbXA'},
    {code:'F-06', name:'سجل الغازات الطبية وضوابطها', url:'about:blank'}, // الرابط غير متوفر
    {code:'F-07', name:'سجل تراخيص الدفاع المدني والتقارير', url:'https://drive.google.com/open?id=1b8jzQnfZovRYgxysKMttoKfxcWxIGAP0eXBDq8PYsVc'},
    {code:'F-08', name:'قائمة تحقق السلامة اليومية لفتح العيادات', url:'https://drive.google.com/open?id=1rMND6uEum9Rn3G9sAg01KRwcrcxzdo-MdddSMmRHNtw'},
    {code:'F-09', name:'سجل التخلص من النفايات الطبية والخطرة', url:'about:blank'}, // الرابط غير متوفر
    {code:'F-10', name:'سجل اختبار إنارة الطوارئ ومخارج الخروج', url:'https://drive.google.com/open?id=1gk1SaB6Id0w7xOggJW4FNFEQGPUMMCKjwo1qH1p87XE'},
    {code:'F-11', name:'قائمة الحد الأدنى لوسائل السلامة بكل غرفة/عيادة', url:'https://drive.google.com/open?id=1aY5Px_nLZVTmckb8tBOlEXGB-Mhe53LhrigXRrE2gaw'},
];

// قائمة «باني الاحتياجات» (كما كانت سابقاً)
const FMS_NEEDS = [
    {key:'charter', label:'ميثاق لجنة السلامة وإدارة المرافق (G01) معتمد', required:true},
    {key:'plans8', label:'اعتماد وتوفر الخطط الثمانية (P01–P08)', required:true},
    {key:'ppmpolicy', label:'سياسة PPM + خطة سنوية موقّعة (G04)', required:true},
    {key:'tours', label:'جولات سلامة ربع سنوية + سجلات F-01', required:true},
    {key:'civildef', label:'ترخيص الدفاع المدني ساري + سجل F-07', required:true},
    {key:'fire', label:'سجلات إنذار/إطفاء/إنارة طوارئ (F-02/F-03/F-10)', required:true},
    {key:'waste', label:'سجل التخلص من النفايات الطبية/الخطرة (F-09)', required:true},
    {key:'medgas', label:'سياسة/سجل الغازات الطبية (إن وجدت) (G11/F-06)', required:false},
    {key:'training', label:'تعريف الموظفين الجدد + خطة تدريب/تمارين (G08/G09)', required:true},
    {key:'risk', label:'HVA سنوية + FMEA للعمليات الحرجة (G07)', required:true},
    {key:'compliance', label:'سياسة الامتثال للقوانين والأنظمة (G05)', required:true},
];

// =========== تبويبات FMS ===========
function switchFmsTab(tab) {
    document.querySelectorAll('[data-fms-tab]').forEach(btn=>{
        // إعادة اللون الافتراضي ثم تفعيل الحالي
        if (btn.getAttribute('data-fms-tab') === tab) {
            btn.classList.add('bg-[#7B1E24]', 'text-white');
            btn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
        } else {
            btn.classList.remove('bg-[#7B1E24]', 'text-white');
            btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
        }
    });

    const container = document.getElementById('fmsTabContent');
    container.innerHTML = ''; // تفريغ المحتوى الحالي
    
    // عرض المحتوى المطلوب
    if (tab === 'rounds') renderRoundsForm(container);
    if (tab === 'needs') renderNeeds(container);
    if (tab === 'plans') renderList(container, FMS_PLANS, 'خطة/برنامج');
    if (tab === 'governance') renderList(container, FMS_GOV, 'سياسة/حوكمة');
    if (tab === 'forms') renderList(container, FMS_FORMS, 'نموذج/سجل');
    if (tab === 'kpis') renderKpis(container);
}

// === وظيفة عرض نموذج جولات السلامة (جديد) ===
function renderRoundsForm(container) {
    const form = document.createElement('form');
    form.id = 'roundsForm';
    form.className = 'space-y-4 p-6 border rounded-lg bg-gray-50 shadow-sm max-w-3xl';
    form.onsubmit = submitRound;

    let observerOptions = OBSERVERS_LIST.map(name => `<option value="${name}">${name}</option>`).join('');

    form.innerHTML = `
        <h3 class="text-xl font-bold text-[#7B1E24] mb-4">تسجيل ملاحظة جولة سلامة جديدة</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="inspector" class="block text-sm font-medium text-gray-700">اسم المراقب</label>
                <select id="inspector" name="inspector" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-[#7B1E24] focus:border-[#7B1E24] sm:text-sm">
                    <option value="">اختر المراقب...</option>
                    ${observerOptions}
                </select>
            </div>
            <div>
                <label for="location" class="block text-sm font-medium text-gray-700">الموقع/القسم</label>
                <input type="text" id="location" name="location" required placeholder="مثال: عيادة 5، المدخل الرئيسي" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#7B1E24] focus:border-[#7B1E24] sm:text-sm">
            </div>
            <div>
                <label for="priority" class="block text-sm font-medium text-gray-700">أولوية الصيانة/الإجراء</label>
                <select id="priority" name="priority" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-[#7B1E24] focus:border-[#7B1E24] sm:text-sm">
                    <option value="عالية (High)">🔴 عالية (إجراء فوري)</option>
                    <option value="متوسطة (Medium)" selected>🟡 متوسطة (خلال أسبوع)</option>
                    <option value="منخفضة (Low)">🟢 منخفضة (مجدول)</option>
                </select>
            </div>
        </div>
        <div>
            <label for="observation" class="block text-sm font-medium text-gray-700">الملاحظة والتوصية</label>
            <textarea id="observation" name="observation" rows="4" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#7B1E24] focus:border-[#7B1E24] sm:text-sm" placeholder="اذكر الملاحظة بالتفصيل والإجراء المقترح..."></textarea>
        </div>
        <div class="flex items-center gap-3 pt-2">
            <button type="submit" id="submitBtn" class="px-4 py-2 bg-[#7B1E24] text-white rounded-lg hover:bg-[#8f2b33] transition duration-200 disabled:opacity-50">
                إرسال الملاحظة إلى Google Sheet
            </button>
            <div id="formLoader" class="loader"></div>
            <span id="formStatus" class="text-sm"></span>
        </div>
        <div class="mt-4 text-sm text-gray-600">
            لعرض السجل الكامل: <a href="https://docs.google.com/spreadsheets/d/1cGxMCYqGfPH2UiE-nsCoytIRjIPSDYxutnq04XF5YGs/edit" target="_blank" class="text-[#7B1E24] underline">فتح ملف Google Sheet</a>.
        </div>
    `;
    container.appendChild(form);
}

// === وظيفة إرسال البيانات إلى Google Apps Script ===
async function submitRound(event) {
    event.preventDefault();
    const form = document.getElementById('roundsForm');
    const submitBtn = document.getElementById('submitBtn');
    const loader = document.getElementById('formLoader');
    const statusMsg = document.getElementById('formStatus');

    if (FMS_API_URL.includes('YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE')) {
        alert('خطأ في الإعداد: لم يتم تحديث رابط Google Apps Script (FMS_API_URL) في الكود.');
        return;
    }

    submitBtn.disabled = true;
    loader.style.display = 'block';
    statusMsg.textContent = 'جارٍ الإرسال...';
    statusMsg.className = 'text-sm text-blue-600';

    // استخدام FormData هو الطريقة الأفضل لتجاوز قيود CORS عند الإرسال لـ Google Script
    const formData = new FormData(form);

    try {
        // إرسال البيانات باستخدام fetch
        const response = await fetch(FMS_API_URL, {
            method: 'POST',
            body: formData,
            // لا نحتاج لضبط Headers عند استخدام FormData
        });

        // نجاح الطلب
        statusMsg.textContent = '✅ تم الإرسال بنجاح إلى Google Sheet!';
        statusMsg.className = 'text-sm text-green-600';
        form.reset(); // تفريغ النموذج

    } catch (error) {
        console.error('Error submitting round:', error);
        statusMsg.textContent = '❌ فشل الإرسال. تحقق من إعدادات Google Script (الخطوة الأولى) أو اتصال الشبكة.';
        statusMsg.className = 'text-sm text-red-600';
    } finally {
        submitBtn.disabled = false;
        loader.style.display = 'none';
    }
}

    // «باني الاحتياجات»
    function renderNeeds(container) {
        const wrap = document.createElement('div');
        wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';

        FMS_NEEDS.forEach(item=>{
            const card = document.createElement('div');
            card.className = 'p-4 rounded border shadow-sm bg-gray-50';
            card.innerHTML = `
            <div class="flex items-start gap-3">
            <input type="checkbox" id="need_${item.key}" class="mt-1 h-5 w-5" ${item.required ? 'data-required="1"' : ''}>
            <div>
            <label for="need_${item.key}" class="font-semibold">${item.label}</label>
            ${item.required ? '<div class="text-xs text-red-600 mt-1">مطلوب</div>' : ''}
            </div>
            </div>
            `;
            wrap.appendChild(card);
        });

        const actions = document.createElement('div');
        actions.className = 'flex items-center gap-2 mt-2';
        actions.innerHTML = `
        <button class="px-3 py-2 bg-[#7B1E24] text-white rounded hover:bg-[#8f2b33]" onclick="validateNeeds()">تحقّق من الاكتمال</button>
        <button class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300" onclick="window.print()">طباعة</button>
        `;

        container.appendChild(wrap);
        container.appendChild(actions);
    }

    function validateNeeds() {
        const required = [...document.querySelectorAll('input[data-required="1"]')];
        const missing = required.filter(cb => !cb.checked);
        if (missing.length === 0) {
            alert('ممتاز ✅ — جميع المتطلبات الإلزامية مُؤشّر عليها.');
        } else {
            alert('⚠️ هناك عناصر إلزامية غير مكتملة: ' + missing.length);
        }
    }

    // قوائم الخطط/الحوكمة/النماذج
    function renderList(container, items, kind) {
        const list = document.createElement('div');
        list.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';

        items.forEach(d=>{
            const card = document.createElement('div');
            card.className = 'p-4 rounded border shadow-sm bg-white hover:shadow-md transition duration-200';
            
            // تحديد إذا كان الرابط متاحاً
            const isDisabled = d.url === 'about:blank';
            const buttonClass = isDisabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#7B1E24] hover:bg-[#8f2b33]';
            const linkClass = isDisabled ? 'bg-gray-300 cursor-not-allowed text-gray-500' : 'bg-gray-200 hover:bg-gray-300 text-gray-800';

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="font-bold text-[#7B1E24]">${d.code}</div>
                    <span class="text-xs bg-gray-100 px-2 py-1 rounded">${kind}</span>
                </div>
                <div class="mb-4 font-medium text-gray-800">${d.name}</div>
                <div class="flex items-center gap-2">
                    <button class="px-3 py-1 text-sm text-white rounded ${buttonClass}"
                        onclick="openFmsDoc('${d.code}: ${d.name}', '${d.url}')" ${isDisabled ? 'disabled' : ''}>📄 عرض</button>
                    <a class="px-3 py-1 text-sm rounded ${linkClass}" 
                       href="${d.url}" target="_blank" 
                       ${isDisabled ? 'onclick="event.preventDefault()"' : ''}>↗ فتح خارجي</a>
                </div>
                ${isDisabled ? '<p class="text-xs text-red-500 mt-2">الرابط غير متوفر</p>' : ''}
            `;
            list.appendChild(card);
        });
        container.appendChild(list);
    }

    function renderKpis(container) {
        const box = document.createElement('div');
        box.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
        box.innerHTML = `
        <div class="bg-white p-4 rounded border shadow">
        <div class="text-sm text-gray-500">نسبة إنجاز الجولات</div>
        <div class="text-2xl font-bold text-[#7B1E24]">85%</div>
        </div>
        <div class="bg-white p-4 rounded border shadow">
        <div class="text-sm text-gray-500">الصيانة الوقائية (PPM)</div>
        <div class="text-2xl font-bold text-[#C55A44]">92%</div>
        </div>
        <div class="bg-white p-4 rounded border shadow">
        <div class="text-sm text-gray-500">التدريب المنفذ</div>
        <div class="text-2xl font-bold text-[#7B1E24]">78%</div>
        </div>
        `;
        container.appendChild(box);
    }

    // Modal
    function openFmsDoc(title, url) {
        if (!url || url === 'about:blank') {
            return;
        }
        document.getElementById('fmsModalTitle').textContent = title;

        // نعرض الرابط مباشرة، روابط Drive تعمل عادة داخل iframe إذا كانت الصلاحيات مفتوحة
        document.getElementById('fmsModalFrame').src = url; 
        document.getElementById('fmsModalOpenNew').href = url;
        document.getElementById('fmsModal').classList.remove('hidden');
        document.getElementById('fmsModal').classList.add('flex');
    }
    function closeFmsModal() {
        document.getElementById('fmsModal').classList.add('hidden');
        document.getElementById('fmsModal').classList.remove('flex');
        document.getElementById('fmsModalFrame').src = 'about:blank'; // تفريغ الـ iframe
    }
  </script>
</body>
</html>
