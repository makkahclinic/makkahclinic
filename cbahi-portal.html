<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>بوابة سباهي الإلكترونية – مجمع مكة الطبي بالزاهر (الإصدار 2025)</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --maroon: #7B1E24;
    --burgundy: #C55A44;
    --gold: #E9C46A;
    --brand1: #7B1E24;
    --brand2: #C55A44;
  }
  
  body {
    font-family: 'Tajawal', sans-serif;
    background: linear-gradient(180deg, #fff, #faf5f4 45%, #fff);
    overflow-x: hidden;
    margin: 0;
    padding: 0;
  }
  
  header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,.08);
  }
  
  .container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  
  .hero {
    background: linear-gradient(180deg, var(--maroon), var(--burgundy));
    color: #fff;
    text-align: center;
  }
  
  .hero-inner {
    padding: 56px 16px 72px;
  }
  
  .hero-logo-wrap {
    position: relative;
    display: inline-block;
  }
  
  .hero-logo-wrap::before {
    content: "";
    position: absolute;
    inset: -28px;
    border-radius: 9999px;
    background: radial-gradient(closest-side, rgba(233,196,106,.22), transparent 70%);
    filter: blur(1px);
  }
  
  .hero img {
    position: relative;
    z-index: 1;
    width: 150px;
    height: auto;
    filter: drop-shadow(0 0 24px var(--gold));
    animation: glow 3s ease-in-out infinite alternate;
  }
  
  @keyframes glow {
    from { filter: drop-shadow(0 0 10px var(--gold)); }
    to { filter: drop-shadow(0 0 32px var(--gold)); }
  }
  
  .sidebar {
    width: 270px;
    background: linear-gradient(180deg, var(--maroon), var(--burgundy));
    color: #fff;
    border-radius: 14px;
    padding: 1rem;
  }
  
  .nav-link {
    display: block;
    padding: .55rem .8rem;
    border-radius: .6rem;
    transition: .2s;
    color: white;
    text-decoration: none;
    margin-bottom: 0.25rem;
  }
  
  .nav-link:hover {
    background-color: rgba(255,255,255,.16);
    transform: translateX(-3px);
  }
  
  .nav-link.active {
    background-color: rgba(255,255,255,.28);
    font-weight: 700;
  }
  
  .card {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 14px;
    box-shadow: 0 6px 16px rgba(0,0,0,.06);
  }
  
  .hidden {
    display: none !important;
  }
  
  #scrollTopBtn {
    position: fixed;
    left: 18px;
    bottom: 18px;
    display: none;
    width: 48px;
    height: 48px;
    border-radius: 9999px;
    background: var(--gold);
    color: var(--maroon);
    box-shadow: 0 8px 18px rgba(123,30,36,.35);
    font-size: 20px;
    border: none;
    cursor: pointer;
    place-items: center;
  }
  
  #scrollTopBtn:hover {
    transform: scale(1.08);
  }
  
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 60;
  }
  
  .modal.open {
    display: flex;
  }
  
  .modal .panel {
    background: #fff;
    border-radius: 14px;
    overflow: hidden;
    width: min(1200px, 96vw);
    height: 80vh;
  }
  
  /* --- FMS tabs & cards --- */
  .tabs {
    display: flex;
    gap: 8px;
    overflow: auto;
    padding-bottom: 8px;
  }
  
  .tab {
    white-space: nowrap;
    border: 1px solid #e5e7eb;
    border-radius: 9999px;
    background: #fff;
    color: var(--maroon);
    padding: .4rem .9rem;
    cursor: pointer;
  }
  
  .tab.active {
    background: var(--maroon);
    color: #fff;
    border-color: transparent;
  }
  
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
    gap: 14px;
  }
  
  .doc-card {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 14px;
    border: 1px solid #eee;
    border-radius: 12px;
    background: #fff;
    height: 100%;
  }
  
  .doc-code {
    color: var(--maroon);
    font-weight: 700;
  }
  
  .content-section {
    display: none;
  }
  
  .content-section.active {
    display: block;
  }
  
  .gold-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--maroon);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border: 1px solid var(--gold);
    border-radius: 8px;
    background: rgba(233, 196, 106, 0.1);
    transition: all 0.3s;
  }
  
  .gold-link:hover {
    background: var(--gold);
    color: var(--maroon);
  }
  
  .table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .table th, .table td {
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    text-align: right;
  }
  
  .table th {
    background-color: #f9fafb;
    font-weight: 700;
  }
  
  .chip {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: #f3f4f6;
    border-radius: 9999px;
    font-size: 0.75rem;
    margin-right: 0.5rem;
  }
  
  .grid-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }
  
  .box {
    background: white;
    border-radius: 14px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    overflow: hidden;
  }
  
  .kpi-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  
  .kpi-table th, .kpi-table td {
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
    text-align: center;
  }
  
  .kpi-table th {
    background-color: var(--maroon);
    color: white;
    font-weight: 600;
  }
  
  .kpi-table tr:nth-child(even) {
    background-color: #f9fafb;
  }
  
  .good {
    background-color: #dcfce7 !important;
    color: #166534;
  }
  
  .warning {
    background-color: #fef9c3 !important;
    color: #854d0e;
  }
  
  .critical {
    background-color: #fee2e2 !important;
    color: #991b1b;
  }
</style>
</head>
<body class="min-h-screen">

<!-- Header -->
<header>
  <div class="container flex items-center justify-between px-4 py-3">
    <div class="flex items-center gap-3">
      <img id="logoSmall" class="h-12 w-auto rounded bg-white p-1 shadow" alt="شعار المجمع" src="logo.png">
      <button id="btnSetLogo" class="text-[var(--maroon)] text-sm underline underline-offset-4 hover:text-[var(--burgundy)]">
        تغيير/تحديث الشعار
      </button>
      <input id="logoPicker" type="file" accept="image/*" class="hidden">
    </div>
    <div class="text-center">
      <div class="text-lg md:text-xl font-bold text-gray-800">بوابة سباهي الإلكترونية</div>
      <div class="text-xs md:text-sm text-gray-500">مجمع مكة الطبي بالزاهر – الإصدار 2025</div>
    </div>
    <div class="flex items-center gap-2">
      <a href="https://makkahclinic.com.sa" target="_blank" class="px-3 py-2 rounded text-[var(--maroon)] hover:bg-gray-100">🏥 موقع المجمع</a>
      <button onclick="window.print()" class="bg-[var(--maroon)] hover:bg-[var(--burgundy)] text-white px-4 py-2 rounded"><i class="fas fa-print ml-2"></i> طباعة / PDF</button>
    </div>
  </div>
</header>

<!-- Hero -->
<section class="hero">
  <div class="hero-inner container">
    <div class="hero-logo-wrap">
      <img id="logoHero" alt="شعار مجمع مكة الطبي" src="logo.png">
    </div>
    <h1 class="text-3xl md:text-4xl font-bold mt-4">بوابة سباهي الإلكترونية</h1>
    <p class="text-base md:text-lg opacity-95 mt-1">مجمع مكة الطبي بالزاهر – الإصدار 2025</p>
    <div class="text-[13px] md:text-[14px] mt-2" style="color:#f8e8cc">بوابة داخلية لإدارة الوثائق والمعايير — لا تتضمن أي ادعاء بالحصول على الاعتماد.</div>
  </div>
</section>

<!-- Layout -->
<div class="container px-4 py-6 flex gap-6">
  <!-- Sidebar -->
  <aside class="sidebar h-max sticky top-[92px]">
    <div class="font-bold mb-2 text-lg">📚 أقسام البوابة</div>
    <a class="nav-link active" href="#home" onclick="navTo('home')">🏠 الصفحة الرئيسية</a>
    <a class="nav-link" href="#manuals" onclick="navTo('manuals')">📘 الدليل الإداري</a>
    <a class="nav-link" href="#leadership" onclick="navTo('leadership')">🏛️ القيادة والحوكمة (LD)</a>
    <a class="nav-link" href="#committees" onclick="navTo('committees')">👥 اللجان الرسمية</a>
    <a class="nav-link" href="#rm" onclick="navTo('rm')">⚠️ إدارة المخاطر (RM)</a>
    <a class="nav-link" href="#fms" onclick="navTo('fms')">🛠️ السلامة والمرافق (FMS)</a>
    <a class="nav-link" href="#psc" onclick="navTo('psc')">❤️ سلامة المرضى (PSC)</a>
    <a class="nav-link" href="#ipc" onclick="navTo('ipc')">🧼 مكافحة العدوى (IPC)</a>
    <a class="nav-link" href="#qi" onclick="navTo('qi')">📈 الجودة والتحسين (QI)</a>
    <a class="nav-link" href="#eoc" onclick="navTo('eoc')">🚨 الطوارئ والكوارث (EOC)</a>
    <a class="nav-link" target="_blank" href="https://docs.google.com/spreadsheets/d/1cGxMCYqGfPH2UiE-nsCoytIRjIPSDYxutnq04XF5YGs/edit?gid=597653922#gid=597653922">🗂️ السجل الإلكتروني (Google Sheet)</a>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 space-y-8">
    <!-- الصفحة الرئيسية -->
    <section id="home" class="content-section active">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-2xl font-extrabold text-[var(--brand1)] mb-3">📌 الرسالة (Mission Statement)</h2>
        <p class="text-gray-800 leading-8 text-lg">
          "نلتزم بتقديم رعاية صحية أولية وتخصصية آمنة ومتمحورة حول المريض في منطقة مكة المكرمة،
          من خلال فريق عمل مؤهل ومرافق متطورة، لتعزيز صحة المجتمع والوصول لأعلى مستويات الجودة."
        </p>
        <div class="mt-4">
          <a class="gold-link" target="_blank" href="https://docs.google.com/document/d/1YUE5GKeQmY3rrHk1j3dX3ztPAwX_3GdNjG9fB_fjPsQ/edit?usp=drive_link" title="وثيقة الرسالة، الرؤية، والقيم المُعتمدة (LD.4.2)">
            <i class="fas fa-file-word"></i> وثيقة الرسالة، الرؤية، والقيم المُعتمدة (LD.4.2)
          </a>
        </div>
      </div>
    </section>

    <!-- الدليل الإداري -->
    <section id="manuals" class="content-section">
      <div class="bg-white rounded-xl shadow p-6 space-y-5">
        <h2 class="text-2xl font-extrabold text-[var(--brand1)]">📘 الدليل الإداري والتنظيمي</h2>
        <div class="space-y-3">
          <div class="font-semibold">الدليل التنظيمي المختصر:</div>
          <a class="gold-link" target="_blank" href="https://docs.google.com/document/d/1jGkTVk6WJeWvCnMw62NXZJ_qj9UL3fychiKmJCpR-ZE/edit?tab=t.0">
            <i class="fas fa-file"></i> الدليل التنظيمي المختصر (مستند Google)
          </a>
        </div>
        <div class="space-y-3">
          <div class="font-semibold">الدليل الإداري التنظيمي التفصيلي:</div>
          <a class="gold-link" target="_blank" href="https://docs.google.com/document/d/1hswi3r_fTUKQoVIj3lG9kEIQpFF7Ol7OLCXe3A45-Ao/edit?tab=t.0#heading=h.93zeqi5ae78k">
            <i class="fas fa-file-lines"></i> الدليل الإداري التنظيمي التفصيلي (مستند Google)
          </a>
        </div>
      </div>
    </section>

    <!-- القيادة والحوكمة -->
    <section id="leadership" class="content-section">
      <div class="bg-white rounded-xl shadow p-6 space-y-6">
        <h2 class="text-2xl font-extrabold text-[var(--brand1)]">🏛️ القيادة والحوكمة (LD)</h2>
        <!-- بطاقة القائد -->
        <div class="border rounded-xl p-5 flex items-center gap-4 bg-gradient-to-br from-[#fff] to-[#fff9f6]">
          <div class="h-14 w-14 rounded-full bg-gradient-to-br from-[var(--brand1)] to-[var(--brand2)] grid place-items-center text-white text-xl shadow">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="flex-1">
            <div class="text-lg font-extrabold text-gray-900">القائد/المدير العام: د. حسين بن محمد حسن شيخ بابصيل</div>
            <div class="text-gray-600">يتبع إداريًا لمجلس الإدارة/المالك ويشرف على الإدارة الطبية، التمريض، الأقسام السريرية والداعمة.</div>
          </div>
          <a class="gold-link" target="_blank" href="https://docs.google.com/document/d/1sZC9bpoqlOgJDN-akgPt5wYrpGC5bvdo-2VL7ZIKCvM/edit?tab=t.0" title="قرار التعيين">
            <i class="fas fa-file-signature"></i> قرار التعيين (LD)
          </a>
        </div>
        <!-- الإدارات التنفيذية -->
        <div>
          <h3 class="text-xl font-extrabold text-[var(--brand1)] mb-2">الإدارات التنفيذية (حسب العرض المعتمد)</h3>
          <div class="overflow-auto">
            <table class="table text-right">
              <thead>
                <tr>
                  <th>القسم</th>
                  <th>المدير</th>
                  <th>المهام الأساسية</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>الإدارة الإدارية</td>
                  <td>أ. بلال نتو</td>
                  <td>التشغيل اليومي، الموارد البشرية، التدريب، الاستقبال والمواعيد.</td>
                </tr>
                <tr>
                  <td>الإدارة الطبية</td>
                  <td>د. معاذ البيوش <span class="chip">نائب: د. خالد الخطيب</span></td>
                  <td>الإشراف على العيادات والخدمات السريرية وجودتها.</td>
                </tr>
                <tr>
                  <td>الإدارة المالية والتأمين</td>
                  <td>أ. صابر عبده</td>
                  <td>الحسابات، المطالبات، إدارة دورة الإيراد، التقارير المالية.</td>
                </tr>
                <tr>
                  <td>الصيانة والمرافق</td>
                  <td>أ. عدنان الرفاعي</td>
                  <td>الصيانة الوقائية، السلامة المرافقية، الطوارئ، المشتريات غير الطبية، النظافة.</td>
                </tr>
                <tr>
                  <td>الصيدلية</td>
                  <td>أ. عبدالله حموده</td>
                  <td>الصرف الدوائي الآمن، ضبط الأدوية عالية الخطورة، سلسلة التبريد، المخزون.</td>
                </tr>
                <tr>
                  <td>المختبر</td>
                  <td>أ. هيثم الجعلي</td>
                  <td>ضبط الجودة المخبرية، سلامة العينات، السلامة الحيوية.</td>
                </tr>
                <tr>
                  <td>الأشعة</td>
                  <td>أ. بلال نتو</td>
                  <td>الإشراف الفني والإشعاعي وفق متطلبات NRRC.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- قرار تعيين القادة -->
        <div class="pt-2">
          <a class="gold-link" target="_blank" href="https://docs.google.com/document/d/1LeyR6WnpUVth3hfr8UX2i5QKIHegA6RvKpkgEhfamA4/edit?usp=drive_link">
            <i class="fas fa-download"></i> قرار تعيين القادة – نسخة للطباعة/التنزيل
          </a>
        </div>
      </div>
    </section>

    <!-- اللجان الرسمية -->
    <section id="committees" class="content-section">
      <div class="bg-white rounded-xl shadow p-6 space-y-5">
        <h2 class="text-2xl font-extrabold text-[var(--brand1)]">👥 اللجان الرسمية (حسب سباهي)</h2>
        <div class="overflow-auto">
          <table class="table text-right">
            <thead>
              <tr>
                <th>الرمز</th>
                <th>اسم اللجنة</th>
                <th>الرئيس</th>
                <th>المنسق/السكرتير + الأعضاء</th>
                <th>تكرار الاجتماعات</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="chip">RM</span></td>
                <td>لجنة إدارة المخاطر</td>
                <td>د. حسين بابصيل</td>
                <td>المنسق/السكرتير: أ. عدنان الرفاعي – الأعضاء: بلال، صابر، معاذ، خالد</td>
                <td>شهريًا</td>
              </tr>
              <tr>
                <td><span class="chip">FMS</span></td>
                <td>لجنة السلامة والمرافق</td>
                <td>أ. صابر عبده</td>
                <td>منسق التدريب: أ. بلال نتو – الأعضاء: عدنان الرفاعي، خالد الخطيب، مندوب من الأمن</td>
                <td>شهريًا</td>
              </tr>
              <tr>
                <td><span class="chip">PSC</span></td>
                <td>لجنة سلامة المرضى</td>
                <td>د. معاذ البيوش</td>
                <td>نائب الرئيس: د. خالد الخطيب – الأعضاء: د. حسين، هيثم، بلال – السكرتير: عدنان</td>
                <td>شهريًا</td>
              </tr>
              <tr>
                <td><span class="chip">IPC</span></td>
                <td>لجنة مكافحة العدوى</td>
                <td>د. مجدي عسكر</td>
                <td>الأعضاء: خالد، التمريض، المختبر، التعقيم – السكرتير: عدنان</td>
                <td>شهريًا</td>
              </tr>
              <tr>
                <td><span class="chip">QI</span></td>
                <td>لجنة الجودة والتحسين المستمر</td>
                <td>د. حسين بابصيل</td>
                <td>الأعضاء: ممثلين من الأقسام – السكرتير: عدنان</td>
                <td>ربع سنوي</td>
              </tr>
              <tr>
                <td><span class="chip">EOC</span></td>
                <td>لجنة الطوارئ والكوارث</td>
                <td>أ. بلال نتو</td>
                <td>الأعضاء: صابر، معاذ، خالد، الأمن، التمريض</td>
                <td>نصف سنوي</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pt-2">
          <a class="gold-link" target="_blank" href="https://docs.google.com/document/d/1jGkTVk6WJeWvCnMw62NXZJ_qj9UL3fychiKmJCpR-ZE/edit?tab=t.0">
            <i class="fas fa-file"></i> تفاصيل اللجان – نسخة من المستند (Google Doc)
          </a>
        </div>
      </div>
    </section>

    <!-- إدارة المخاطر (RM) -->
    <section id="rm" class="content-section">
      <div class="bg-white rounded-xl shadow p-6 space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-2xl font-extrabold text-[var(--brand1)]">⚠️ إدارة المخاطر (RM)</h2>
          <a href="https://www.m2020m.org/report.html" target="_blank" class="px-4 py-2 rounded-lg bg-[var(--brand1)] text-white hover:bg-[var(--brand2)] transition">
            <i class="fas fa-bullhorn ml-2"></i> الإبلاغ الإلكتروني للشكاوى/الحوادث
          </a>
        </div>
        <!-- مكتبة RM الأساسية -->
        <div class="border rounded-xl p-4">
          <h3 class="font-extrabold text-[var(--brand1)] mb-3">📚 مكتبة الأدلة الأساسية</h3>
          <div id="rmLib"></div>
        </div>
        <!-- التوعية والتدريب -->
        <div class="border rounded-xl p-4">
          <h3 class="font-extrabold text-[var(--brand1)] mb-2">📢 التوعية والتدريب — تسجيل حضور متدرب</h3>
          <form id="trainForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">اسم المتدرب *</label>
              <input name="trainee_name" required class="w-full border rounded-lg px-3 py-2" placeholder="الاسم الثلاثي">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">موضوع التدريب *</label>
              <input name="training_topic" required class="w-full border rounded-lg px-3 py-2" placeholder="مثال: سياسة الإبلاغ عن الحوادث">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">تاريخ التدريب *</label>
              <input type="date" name="training_date" required class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">مكان التدريب *</label>
              <input name="training_place" required class="w-full border rounded-lg px-3 py-2" placeholder="قاعة الاجتماعات / عيادة ...">
            </div>
            <div class="sm:col-span-2 flex items-center gap-3 pt-2">
              <button type="submit" class="px-4 py-2 rounded-lg bg-[var(--brand1)] text-white hover:bg-[var(--brand2)]">حفظ الحضور</button>
              <span id="trainMsg" class="text-sm"></span>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- السلامة والمرافق (FMS) -->
    <section id="fms" class="content-section">
      <div class="bg-white rounded-xl shadow p-6 space-y-6">
        <h2 class="text-2xl font-extrabold text-[var(--brand1)]">🛠️ السلامة والمرافق (FMS)</h2>
        <!-- تبويبات -->
        <div class="flex flex-wrap gap-2 border-b pb-3">
          <button class="px-3 py-1.5 rounded-md bg-[var(--brand1)] text-white" data-fms-tab="library" onclick="switchFmsTab('library')">📚 مكتبة الوثائق</button>
          <button class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200" data-fms-tab="rounds" onclick="switchFmsTab('rounds')">📝 تسجيل جولة سلامة</button>
          <button class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200" data-fms-tab="needs" onclick="switchFmsTab('needs')">✅ متطلبات سباهي</button>
        </div>
        <div id="fmsTabContent"></div>
      </div>
    </section>

    <!-- سلامة المرضى (PSC) - القسم المحدث بالكامل -->
    <section id="psc" class="content-section">
      <div class="bg-white rounded-xl shadow p-6 space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-2xl font-extrabold text-[var(--brand1)]">❤️ سلامة المرضى (PSC)</h2>
          <div class="flex gap-2">
            <a href="https://www.m2020m.org/report.html" target="_blank" class="px-4 py-2 rounded-lg bg-[var(--brand1)] text-white hover:bg-[var(--brand2)] transition">
              <i class="fas fa-bullhorn ml-2"></i> الإبلاغ عن حادث
            </a>
          </div>
        </div>

        <!-- تبويبات PSC -->
        <div class="flex flex-wrap gap-2 border-b pb-3">
          <button class="px-3 py-1.5 rounded-md bg-[var(--brand1)] text-white" data-psc-tab="library" onclick="switchPscTab('library')">📚 مكتبة الوثائق</button>
          <button class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200" data-psc-tab="indicators" onclick="switchPscTab('indicators')">📊 مؤشرات الأداء</button>
          <button class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200" data-psc-tab="reporting" onclick="switchPscTab('reporting')">📝 نماذج الإبلاغ</button>
          <button class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200" data-psc-tab="needs" onclick="switchPscTab('needs')">✅ متطلبات سباهي</button>
        </div>

        <!-- محتوى تبويبات PSC -->
        <div id="pscTabContent"></div>
      </div>
    </section>

    <!-- بقية اللجان -->
    <section id="ipc" class="content-section">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-2xl font-extrabold text-[var(--brand1)]">🧼 مكافحة العدوى (IPC)</h2>
        <p class="text-gray-700">سيتم تغذية هذا القسم لاحقًا بالخطط والسياسات والنماذج المعتمدة.</p>
      </div>
    </section>

    <section id="qi" class="content-section">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-2xl font-extrabold text-[var(--brand1)]">📈 الجودة والتحسين المستمر (QI)</h2>
        <p class="text-gray-700">سيتم إضافة مؤشرات الأداء وخطط التحسين لاحقًا.</p>
      </div>
    </section>

    <section id="eoc" class="content-section">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-2xl font-extrabold text-[var(--brand1)]">🚨 الطوارئ والكوارث (EOC)</h2>
        <p class="text-gray-700">سيتم إضافة خطط الطوارئ وجداول الإخلاء والتمارين لاحقًا.</p>
      </div>
    </section>
  </main>
</div>

<!-- Scroll to top -->
<button id="scrollTopBtn" title="إلى الأعلى" onclick="window.scrollTo({top:0,behavior:'smooth'})">
  <i class="fas fa-arrow-up"></i>
</button>

<!-- Document Modal -->
<div id="docModal" class="modal" role="dialog" aria-modal="true">
  <div class="panel">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between px-4 py-3 border-b bg-gray-50">
        <div class="font-bold text-[var(--brand1)]" id="docTitle">عرض الوثيقة</div>
        <button class="text-2xl" onclick="closeDocModal()">&times;</button>
      </div>
      <iframe id="docFrame" class="w-full flex-1 border-0" src="about:blank" allowfullscreen></iframe>
    </div>
  </div>
</div>

<script>
  // ====== الإعدادات ======
  const FMS_API_URL = 'YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE';
  const TRAIN_API_URL = 'YOUR_GAS_TRAINING_WEB_APP_URL_HERE';

  // ====== دوال إدارة الشعار ======
  function setupLogoChange() {
    const logoPicker = document.getElementById('logoPicker');
    const btnSetLogo = document.getElementById('btnSetLogo');
    
    if (btnSetLogo && logoPicker) {
      // عند النقر على زر تغيير الشعار، فتح نافذة اختيار الملف
      btnSetLogo.addEventListener('click', function() {
        logoPicker.click();
      });
      
      // عند اختيار ملف صورة، تحديث الشعار
      logoPicker.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const imageDataUrl = e.target.result;
            
            // تحديث الشعار في الهيدر
            const logoSmall = document.getElementById('logoSmall');
            if (logoSmall) {
              logoSmall.src = imageDataUrl;
            }
            
            // تحديث الشعار في الهيرو
            const logoHero = document.getElementById('logoHero');
            if (logoHero) {
              logoHero.src = imageDataUrl;
            }
            
            // حفظ الشعار في localStorage للاستخدام المستقبلي
            try {
              localStorage.setItem('customLogo', imageDataUrl);
            } catch (error) {
              console.log('لا يمكن حفظ الشعار في التخزين المحلي');
            }
          };
          
          reader.readAsDataURL(file);
        }
      });
    }
  }
  
  function loadSavedLogo() {
    try {
      const savedLogo = localStorage.getItem('customLogo');
      if (savedLogo) {
        const logoSmall = document.getElementById('logoSmall');
        const logoHero = document.getElementById('logoHero');
        
        if (logoSmall) logoSmall.src = savedLogo;
        if (logoHero) logoHero.src = savedLogo;
      }
    } catch (error) {
      console.log('لا يمكن تحميل الشعار المحفوظ');
    }
  }

  // ====== دوال التنقل ======
  function navTo(sectionId) {
    // إخفاء جميع الأقسام
    document.querySelectorAll('.content-section').forEach(section => {
      section.classList.remove('active');
    });
    
    // إزالة النشط من جميع الروابط
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });
    
    // إظهار القسم المطلوب
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
      targetSection.classList.add('active');
      targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // تعيين الرابط كنشط
    const activeLink = document.querySelector(`[onclick="navTo('${sectionId}')"]`);
    if (activeLink) {
      activeLink.classList.add('active');
    }
    
    // تهيئة FMS إذا لزم الأمر
    if (sectionId === 'fms') {
      const fmsContent = document.getElementById('fmsTabContent');
      if (fmsContent && fmsContent.innerHTML.trim() === '') {
        switchFmsTab('library');
      }
    }
    
    // تهيئة PSC إذا لزم الأمر
    if (sectionId === 'psc') {
      const pscContent = document.getElementById('pscTabContent');
      if (pscContent && pscContent.innerHTML.trim() === '') {
        switchPscTab('library');
      }
    }
  }

  // ====== دوال النافذة المنبثقة ======
  function openDocModal(title, previewUrl) {
    document.getElementById('docTitle').textContent = title;
    document.getElementById('docFrame').src = previewUrl;
    document.getElementById('docModal').style.display = 'flex';
  }

  function closeDocModal() {
    document.getElementById('docFrame').src = 'about:blank';
    document.getElementById('docModal').style.display = 'none';
  }

  // ====== مكتبة وثائق PSC ======
  const PSC_DOCS_LIBRARY = [
    { code:'POL-PSC-2025-001', name:'سياسة برنامج سلامة المرضى', category:'POL', url:'https://drive.google.com/file/d/1FEdKvutCYqWXYwnp70OsjRO-CIzzmZU2CAFstiFVmMw/preview' },
    { code:'DEC-PSC-2025-001', name:'قرار تشكيل لجنة سلامة المرضى', category:'DEC', url:'https://drive.google.com/file/d/1Qz7s61wIuWh1RbSLbMyrzWB_GwoPnfwqhZQHMKpgeyc/preview' },
    { code:'CHT-PSC-2025-001', name:'ميثاق لجنة سلامة المرضى', category:'CHT', url:'https://drive.google.com/file/d/1pDDwB4Y-l7EQbwJpLH5o9PpCbdhTFQleai7PvU2Ltjg/preview' },
    { code:'POL-PSC-2025-003', name:'سياسة التعرف المزدوج على المريض', category:'POL', url:'https://drive.google.com/file/d/1yNGDW_yLN9OrguG-_lJzXKxk6y0rJfjfc7aONgQiNqQ/preview' },
    { code:'POL-PSC-2025-002', name:'سياسة الإبلاغ والتعلم من الأخطاء الدوائية', category:'POL', url:'https://drive.google.com/file/d/1VRoEZjXxeIoHlDvtmmus-NM-zNK-oARCh_8_u74S7c0/preview' },
    { code:'FRM-PSC-2025-001', name:'نموذج محضر اجتماع لجنة سلامة المرضى', category:'FRM', url:'https://drive.google.com/file/d/1KVTIutS3sdWTYhc1ZB-p9J3fXDjEu-CajxwlYyocz44/preview' },
    { code:'CHK-PSC-2025-001', name:'نموذج مراجعة تعريف المريض', category:'CHK', url:'https://drive.google.com/file/d/1oS_fO9mBIggmaXbPfaXB3H1YKyTlwgGfT8Hwbs9qi7E/preview' },
    { code:'CHK-PSC-2025-002', name:'مراجعة أدوية عالية الخطورة', category:'CHK', url:'https://drive.google.com/file/d/1t4Pt6bkxp9ER5mnc3lcDqy_E5z3eMm9WTqilWIPAIBM/preview' },
    { code:'LOG-PSC-2025-001', name:'سجل الحوادث وسلامة المرضى', category:'LOG', url:'https://drive.google.com/file/d/12SS-Nn_TpvIsIoUfdOPRzC_tgLqmb2hfZZi53_dSyVI/preview' },
    { code:'FRM-PSC-2025-002', name:'نموذج SBAR للتسليم', category:'FRM', url:'https://drive.google.com/file/d/1JgEPxYvK6X_cQ7eroNCkymfUzbTCbzljqvrOKYKBw1g/preview' },
    { code:'FRM-PSC-2025-003', name:'نموذج PDSA لتحسين الجودة', category:'FRM', url:'https://drive.google.com/file/d/1XE45nGctQGK3WIFnUxE5CqsIZu8BdBLZuqOLgsZaPXk/preview' },
    { code:'FRM-PSC-2025-004', name:'نموذج إحالة للجنة M&M', category:'FRM', url:'https://drive.google.com/file/d/1LbD4aaIcyIDPJi2Cn_J69OEnpeCF3XTFCjjDstr2ny8/preview' },
    { code:'REP-PSC-2025-001', name:'تقرير مؤشرات سلامة المرضى', category:'REP', url:'https://drive.google.com/file/d/1wZGnfGcj1O-329jBUXfPHXqA09k6VS58mpu4rNELS20/preview' },
    { code:'TRN-PSC-2025-001', name:'خطة التوعية والتدريب', category:'TRN', url:'https://drive.google.com/file/d/1Ohj-mB-Jk3mmdrW9Lm6GNSojRJaT__GQpjO7aFG4twY/preview' },
    { code:'TRN-PSC-2025-002', name:'سجل حضور تدريب', category:'TRN', url:'https://drive.google.com/file/d/1Sgj_Qps21a3GoalpZAf-08b43UmL30GLUvY8UQqyxjg/preview' },
  ];

  const PSC_CATEGORY_NAMES = {
    POL:'السياسات', 
    DEC:'القرارات', 
    CHT:'الميثاق',
    FRM:'النماذج', 
    CHK:'قوائم التحقق', 
    LOG:'السجلات', 
    REP:'التقارير', 
    TRN:'التدريب'
  };

  // ====== مؤشرات PSC ======
  const PSC_KPI_DATA = [
    { الشهر: 'يناير', تعريف_المريض: 98, التزام_غسل_اليدين: 85, أخطاء_دواء: 5.2, سقوط: 3.1, بلاغات_قريبة: 12 },
    { الشهر: 'فبراير', تعريف_المريض: 99, التزام_غسل_اليدين: 82, أخطاء_دواء: 6.1, سقوط: 3.5, بلاغات_قريبة: 8 },
    { الشهر: 'مارس', تعريف_المريض: 92, التزام_غسل_اليدين: 88, أخطاء_دواء: 8.5, سقوط: 4.8, بلاغات_قريبة: 15 },
    { الشهر: 'أبريل', تعريف_المريض: 99, التزام_غسل_اليدين: 95, أخطاء_دواء: 4.0, سقوط: 3.0, بلاغات_قريبة: 35 },
    { الشهر: 'مايو', تعريف_المريض: 100, التزام_غسل_اليدين: 96, أخطاء_دواء: 3.5, سقوط: 2.9, بلاغات_قريبة: 28 },
  ];

  // ====== دوال PSC ======
  function switchPscTab(tab) {
    // تحديث أزرار التبويب
    document.querySelectorAll('[data-psc-tab]').forEach(button => {
      if (button.getAttribute('data-psc-tab') === tab) {
        button.classList.add('bg-[var(--brand1)]', 'text-white');
        button.classList.remove('bg-gray-100');
      } else {
        button.classList.remove('bg-[var(--brand1)]', 'text-white');
        button.classList.add('bg-gray-100');
      }
    });
    
    const container = document.getElementById('pscTabContent');
    container.innerHTML = '';
    
    if (tab === 'library') {
      renderPscLibrary(container, PSC_DOCS_LIBRARY);
    } else if (tab === 'indicators') {
      renderPscIndicators(container);
    } else if (tab === 'reporting') {
      renderPscReporting(container);
    } else if (tab === 'needs') {
      renderPscNeeds(container);
    }
  }

  function renderPscLibrary(container, docs) {
    // عناصر التحكم
    const categories = [...new Set(docs.map(doc => doc.category))];
    const controls = document.createElement('div');
    controls.className = 'flex flex-wrap items-center gap-2 mb-4';
    controls.innerHTML = `
      <div class="flex flex-wrap gap-2">
        <button data-psc-filter="ALL" class="px-3 py-1 rounded-full bg-[var(--brand1)] text-white text-sm">الكل</button>
        ${categories.map(cat => 
          `<button data-psc-filter="${cat}" class="px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">${PSC_CATEGORY_NAMES[cat] || cat}</button>`
        ).join('')}
      </div>
      <div class="ml-auto w-full md:w-64">
        <input id="pscSearch" type="text" placeholder="ابحث بالرمز أو العنوان..." class="w-full border rounded-lg px-3 py-2">
      </div>
    `;
    
    const grid = document.createElement('div');
    grid.className = 'grid-cards';
    grid.id = 'pscGrid';
    
    container.appendChild(controls);
    container.appendChild(grid);
    
    // دالة التصفية والعرض
    function renderFilteredDocs(filter = 'ALL', query = '') {
      grid.innerHTML = '';
      const searchQuery = query.toLowerCase();
      
      const filteredDocs = docs.filter(doc => {
        const matchesFilter = filter === 'ALL' || doc.category === filter;
        const matchesQuery = !searchQuery || 
          doc.code.toLowerCase().includes(searchQuery) || 
          doc.name.toLowerCase().includes(searchQuery);
        return matchesFilter && matchesQuery;
      });
      
      filteredDocs.forEach(doc => {
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl border bg-white shadow-sm hover:shadow-md transition flex flex-col';
        card.innerHTML = `
          <div class="text-xs text-gray-500 mb-1">${PSC_CATEGORY_NAMES[doc.category] || doc.category}</div>
          <div class="font-extrabold text-[var(--brand1)]">${doc.code}</div>
          <div class="text-gray-800 mt-1 flex-1">${doc.name}</div>
          <div class="mt-3 flex gap-2">
            <button class="px-3 py-2 text-sm text-white rounded-lg bg-[var(--brand1)] hover:bg-[var(--brand2)]" 
                    onclick="openDocModal('${doc.code}: ${doc.name}', '${doc.url}')">
              <i class="fas fa-eye ml-1"></i> عرض
            </button>
            <a class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50" 
               target="_blank" href="${doc.url.replace('/preview', '/view')}">
              <i class="fas fa-up-right-from-square ml-1"></i> فتح في تبويب
            </a>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    
    // إضافة مستمعي الأحداث
    controls.querySelectorAll('button[data-psc-filter]').forEach(button => {
      button.addEventListener('click', () => {
        controls.querySelectorAll('button[data-psc-filter]').forEach(btn => {
          btn.classList.remove('bg-[var(--brand1)]', 'text-white');
        });
        button.classList.add('bg-[var(--brand1)]', 'text-white');
        renderFilteredDocs(button.getAttribute('data-psc-filter'), document.getElementById('pscSearch').value);
      });
    });
    
    document.getElementById('pscSearch').addEventListener('input', (e) => {
      const activeFilter = controls.querySelector('button[data-psc-filter].bg-[var(--brand1)]') || 
                          { getAttribute: () => 'ALL' };
      renderFilteredDocs(activeFilter.getAttribute('data-psc-filter'), e.target.value);
    });
    
    // التهيئة الأولية
    renderFilteredDocs('ALL', '');
  }

  function renderPscIndicators(container) {
    const wrapper = document.createElement('div');
    wrapper.className = 'space-y-6';
    
    // جدول المؤشرات
    const tableSection = document.createElement('div');
    tableSection.innerHTML = `
      <h3 class="text-xl font-bold text-[var(--brand1)] mb-4">📊 مؤشرات سلامة المرضى الشهرية</h3>
      <div class="overflow-auto">
        <table class="kpi-table">
          <thead>
            <tr>
              <th>الشهر</th>
              <th>تعريف المريض %</th>
              <th>التزام غسل اليدين %</th>
              <th>أخطاء دوائية لكل 1000 وصفة</th>
              <th>سقوط لكل 1000 زيارة</th>
              <th>بلاغات قريبة من الوقوع</th>
            </tr>
          </thead>
          <tbody id="kpiTableBody"></tbody>
        </table>
      </div>
    `;
    
    // مخطط بياني مبسط
    const chartSection = document.createElement('div');
    chartSection.innerHTML = `
      <h3 class="text-xl font-bold text-[var(--brand1)] mb-4">📈 تطور مؤشرات السلامة</h3>
      <div class="border rounded-xl p-4 bg-white">
        <div class="flex flex-wrap gap-4 mb-4">
          <button class="px-3 py-1 rounded-full bg-[var(--brand1)] text-white text-sm" onclick="renderPscChart('تعريف_المريض')">تعريف المريض</button>
          <button class="px-3 py-1 rounded-full bg-gray-200 text-sm" onclick="renderPscChart('التزام_غسل_اليدين')">غسل اليدين</button>
          <button class="px-3 py-1 rounded-full bg-gray-200 text-sm" onclick="renderPscChart('أخطاء_دواء')">الأخطاء الدوائية</button>
          <button class="px-3 py-1 rounded-full bg-gray-200 text-sm" onclick="renderPscChart('سقوط')">معدل السقوط</button>
        </div>
        <div id="pscChart" class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
          <p class="text-gray-500">اختر مؤشراً لعرض الرسم البياني</p>
        </div>
      </div>
    `;
    
    wrapper.appendChild(tableSection);
    wrapper.appendChild(chartSection);
    container.appendChild(wrapper);
    
    // ملء جدول المؤشرات
    renderPscKpiTable();
  }

  function renderPscKpiTable() {
    const tableBody = document.getElementById('kpiTableBody');
    tableBody.innerHTML = '';
    
    PSC_KPI_DATA.forEach(row => {
      const tr = document.createElement('tr');
      
      // تحديد فئات الألوان بناءً على القيم
      const patientIdClass = row.تعريف_المريض >= 95 ? 'good' : row.تعريف_المريض >= 90 ? 'warning' : 'critical';
      const handHygieneClass = row.التزام_غسل_اليدين >= 90 ? 'good' : row.التزام_غسل_اليدين >= 80 ? 'warning' : 'critical';
      const medErrorsClass = row.أخطاء_دواء <= 4 ? 'good' : row.أخطاء_دواء <= 6 ? 'warning' : 'critical';
      const fallsClass = row.سقوط <= 3 ? 'good' : row.سقوط <= 4 ? 'warning' : 'critical';
      const nearMissClass = row.بلاغات_قريبة >= 20 ? 'good' : row.بلاغات_قريبة >= 10 ? 'warning' : 'critical';
      
      tr.innerHTML = `
        <td class="font-semibold">${row.الشهر}</td>
        <td class="${patientIdClass}">${row.تعريف_المريض}%</td>
        <td class="${handHygieneClass}">${row.التزام_غسل_اليدين}%</td>
        <td class="${medErrorsClass}">${row.أخطاء_دواء}</td>
        <td class="${fallsClass}">${row.سقوط}</td>
        <td class="${nearMissClass}">${row.بلاغات_قريبة}</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  function renderPscChart(indicator) {
    const chartContainer = document.getElementById('pscChart');
    const indicatorName = {
      'تعريف_المريض': 'تعريف المريض %',
      'التزام_غسل_اليدين': 'التزام غسل اليدين %', 
      'أخطاء_دواء': 'الأخطاء الدوائية',
      'سقوط': 'معدل السقوط'
    }[indicator];
    
    // رسم بياني مبسط باستخدام HTML وCSS
    const maxValue = Math.max(...PSC_KPI_DATA.map(row => row[indicator]));
    const minValue = Math.min(...PSC_KPI_DATA.map(row => row[indicator]));
    
    let chartHTML = `
      <div class="w-full h-full p-4">
        <h4 class="text-center font-bold mb-4">${indicatorName}</h4>
        <div class="flex items-end justify-between h-40 gap-2">
    `;
    
    PSC_KPI_DATA.forEach((row, index) => {
      const value = row[indicator];
      const percentage = ((value - minValue) / (maxValue - minValue)) * 80 + 20;
      
      chartHTML += `
        <div class="flex flex-col items-center flex-1">
          <div class="text-xs mb-1">${row.الشهر}</div>
          <div class="w-full bg-[var(--brand1)] rounded-t transition-all" style="height: ${percentage}%"></div>
          <div class="text-xs mt-1">${value}</div>
        </div>
      `;
    });
    
    chartHTML += `</div></div>`;
    chartContainer.innerHTML = chartHTML;
    
    // تحديث أزرار المؤشرات النشطة
    document.querySelectorAll('#pscChart').closest('.border').querySelectorAll('button').forEach(btn => {
      btn.classList.remove('bg-[var(--brand1)]', 'text-white');
      btn.classList.add('bg-gray-200');
    });
    
    const activeButton = document.querySelector(`[onclick="renderPscChart('${indicator}')"]`);
    if (activeButton) {
      activeButton.classList.add('bg-[var(--brand1)]', 'text-white');
      activeButton.classList.remove('bg-gray-200');
    }
  }

  function renderPscReporting(container) {
    const wrapper = document.createElement('div');
    wrapper.className = 'space-y-6';
    
    // نماذج الإبلاغ السريع
    const quickReports = document.createElement('div');
    quickReports.innerHTML = `
      <h3 class="text-xl font-bold text-[var(--brand1)] mb-4">📝 نماذج الإبلاغ السريع</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <a href="https://drive.google.com/file/d/1rFQjcCWP010zLNb4FfRtT1aTmrbY9fyjGcMeYIXSQqQ/view" target="_blank" class="p-4 border rounded-xl bg-white hover:shadow-md transition flex items-center gap-3">
          <div class="h-12 w-12 rounded-full bg-red-100 grid place-items-center text-red-600">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div>
            <div class="font-bold">بلاغ حادث</div>
            <div class="text-sm text-gray-600">للبطالات عن الأحداث السلبية التي وقعت</div>
          </div>
        </a>
        
        <a href="https://drive.google.com/file/d/1DhGR9WtVrM2LxITiv8WBMSCKs407Kb-vUZXg0mZVwD0/view" target="_blank" class="p-4 border rounded-xl bg-white hover:shadow-md transition flex items-center gap-3">
          <div class="h-12 w-12 rounded-full bg-yellow-100 grid place-items-center text-yellow-600">
            <i class="fas fa-bullseye"></i>
          </div>
          <div>
            <div class="font-bold">بلاغ قريب من الوقوع</div>
            <div class="text-sm text-gray-600">للبطالات عن الأحداث التي كادت تقع</div>
          </div>
        </a>
        
        <a href="https://drive.google.com/file/d/1Yw7CFRvzssAWU0JYFkNz1Z9o0fQoMKCqoqrRhEHWZ_I/view" target="_blank" class="p-4 border rounded-xl bg-white hover:shadow-md transition flex items-center gap-3">
          <div class="h-12 w-12 rounded-full bg-orange-100 grid place-items-center text-orange-600">
            <i class="fas fa-triangle-exclamation"></i>
          </div>
          <div>
            <div class="font-bold">بلاغ خطر/شرط غير آمن</div>
            <div class="text-sm text-gray-600">للبطالات عن المخاطر المحتملة</div>
          </div>
        </a>
        
        <a href="https://drive.google.com/file/d/17tZnAvhWCvPbb5Bp3UymLxzEz-IciEjxV4Tn97tIWwQ/view" target="_blank" class="p-4 border rounded-xl bg-white hover:shadow-md transition flex items-center gap-3">
          <div class="h-12 w-12 rounded-full bg-blue-100 grid place-items-center text-blue-600">
            <i class="fas fa-toolbox"></i>
          </div>
          <div>
            <div class="font-bold">بلاغ عطل جهاز/تجهيز</div>
            <div class="text-sm text-gray-600">للبطالات عن الأعطال في الأجهزة الطبية</div>
          </div>
        </a>
      </div>
    `;
    
    // نموذج إدخال بيانات المؤشرات
    const dataEntry = document.createElement('div');
    dataEntry.className = 'border rounded-xl p-4 bg-white';
    dataEntry.innerHTML = `
      <h3 class="text-xl font-bold text-[var(--brand1)] mb-4">➕ إدخال بيانات مؤشر جديد</h3>
      <form id="kpiForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">الشهر *</label>
          <select name="month" required class="w-full border rounded-lg px-3 py-2">
            <option value="">اختر الشهر</option>
            <option value="يناير">يناير</option>
            <option value="فبراير">فبراير</option>
            <option value="مارس">مارس</option>
            <option value="أبريل">أبريل</option>
            <option value="مايو">مايو</option>
            <option value="يونيو">يونيو</option>
            <option value="يوليو">يوليو</option>
            <option value="أغسطس">أغسطس</option>
            <option value="سبتمبر">سبتمبر</option>
            <option value="أكتوبر">أكتوبر</option>
            <option value="نوفمبر">نوفمبر</option>
            <option value="ديسمبر">ديسمبر</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">تعريف المريض % *</label>
          <input type="number" min="0" max="100" name="patient_id" required class="w-full border rounded-lg px-3 py-2" placeholder="النسبة المئوية">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">التزام غسل اليدين % *</label>
          <input type="number" min="0" max="100" name="hand_hygiene" required class="w-full border rounded-lg px-3 py-2" placeholder="النسبة المئوية">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">الأخطاء الدوائية *</label>
          <input type="number" step="0.1" min="0" name="med_errors" required class="w-full border rounded-lg px-3 py-2" placeholder="لكل 1000 وصفة">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">معدل السقوط *</label>
          <input type="number" step="0.1" min="0" name="falls" required class="w-full border rounded-lg px-3 py-2" placeholder="لكل 1000 زيارة">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">البلاغات قريبة الوقوع *</label>
          <input type="number" min="0" name="near_miss" required class="w-full border rounded-lg px-3 py-2" placeholder="العدد">
        </div>
        <div class="md:col-span-2 flex items-center gap-3 pt-2">
          <button type="submit" class="px-4 py-2 rounded-lg bg-[var(--brand1)] text-white hover:bg-[var(--brand2)]">حفظ البيانات</button>
          <span id="kpiMsg" class="text-sm"></span>
        </div>
      </form>
    `;
    
    wrapper.appendChild(quickReports);
    wrapper.appendChild(dataEntry);
    container.appendChild(wrapper);
    
    // معالجة نموذج إدخال البيانات
    const kpiForm = document.getElementById('kpiForm');
    if (kpiForm) {
      kpiForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const messageElement = document.getElementById('kpiMsg');
        messageElement.textContent = 'جارٍ حفظ البيانات...';
        messageElement.className = 'text-sm text-blue-600';
        
        // في بيئة حقيقية، هنا سيتم إرسال البيانات لخادم
        setTimeout(() => {
          messageElement.textContent = '✅ تم حفظ البيانات بنجاح (في بيئة حقيقية سيتم حفظها في قاعدة البيانات)';
          messageElement.className = 'text-sm text-green-600';
          kpiForm.reset();
        }, 1000);
      });
    }
  }

  function renderPscNeeds(container) {
    const needs = [
      { key: 'charter', text: 'ميثاق لجنة سلامة المرضى معتمد (CHT-PSC-2025-001)', required: true },
      { key: 'policy', text: 'سياسة برنامج سلامة المرضى معتمدة (POL-PSC-2025-001)', required: true },
      { key: 'committee', text: 'قرار تشكيل اللجنة مفعل (DEC-PSC-2025-001)', required: true },
      { key: 'patient_id', text: 'سياسة التعرف المزدوج على المريض معتمدة (POL-PSC-2025-003)', required: true },
      { key: 'med_errors', text: 'سياسة الإبلاغ عن الأخطاء الدوائية معتمدة (POL-PSC-2025-002)', required: true },
      { key: 'meetings', text: 'محاضر اجتماعات اللجنة مسجلة ومنظمة', required: true },
      { key: 'indicators', text: 'نظام متابعة مؤشرات السلامة مفعل', required: true },
      { key: 'training', text: 'خطة تدريب سلامة المرضى منفذة', required: true },
    ];
    
    const wrapper = document.createElement('div');
    wrapper.className = 'grid-cards';
    
    needs.forEach(need => {
      const card = document.createElement('div');
      card.className = 'p-4 rounded-xl border bg-white shadow-sm';
      card.innerHTML = `
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="checkbox" class="mt-1 h-5 w-5" data-required="${need.required ? 1 : 0}">
          <span class="font-semibold">${need.text}</span>
        </label>
        ${need.required ? '<div class="text-xs text-red-600 mt-1">متطلب إلزامي</div>' : ''}
      `;
      wrapper.appendChild(card);
    });
    
    const actions = document.createElement('div');
    actions.className = 'pt-4 flex gap-3';
    actions.innerHTML = `
      <button class="px-4 py-2 rounded-lg bg-[var(--brand1)] text-white hover:bg-[var(--brand2)]" onclick="validatePscNeeds()">
        تحقّق من الاكتمال
      </button>
      <button class="px-4 py-2 rounded-lg border hover:bg-gray-50" onclick="generatePscReport()">
        إنشاء تقرير الجاهزية
      </button>
    `;
    
    container.appendChild(wrapper);
    container.appendChild(actions);
  }

  function validatePscNeeds() {
    const requiredCheckboxes = [...document.querySelectorAll('#pscTabContent input[data-required="1"]')];
    const missingCount = requiredCheckboxes.filter(checkbox => !checkbox.checked).length;
    
    if (missingCount === 0) {
      alert('ممتاز ✅ — جميع متطلبات سلامة المرضى الإلزامية مكتملة.');
    } else {
      alert(`⚠️ تنبيه: يوجد ${missingCount} متطلب(ات) إلزامي غير مكتمل في قسم سلامة المرضى.`);
    }
  }

  function generatePscReport() {
    const checkboxes = [...document.querySelectorAll('#pscTabContent input[type="checkbox"]')];
    const checkedCount = checkboxes.filter(checkbox => checkbox.checked).length;
    const totalCount = checkboxes.length;
    const percentage = Math.round((checkedCount / totalCount) * 100);
    
    alert(`📋 تقرير جاهزية سلامة المرضى:\n\n✅ ${checkedCount} من ${totalCount} بند مكتمل\n📊 نسبة الإكمال: ${percentage}%\n\n${percentage >= 80 ? 'مستوى جيد ✓' : 'يحتاج إلى تحسين ⚠️'}`);
  }

  // ====== دوال FMS ======
  const FMS_DOCS_LIBRARY = [
    { code:'POL-FMS-2025-001', name:'سياسة إدارة السلامة والمرافق', category:'POL', url:'https://drive.google.com/file/d/1YS1Jk5FgwJoY5in71yUQ1oIjE4JEsaecMGWTt00aQ0o/preview' },
    { code:'POL-FMS-2025-015', name:'سياسة مراقبة جودة الهواء والتهوية', category:'POL', url:'https://drive.google.com/file/d/18caApXqHeQSZdBFSvgyIKICX0qMSsN7UuRxz3u7R10o/preview' },
    { code:'SOP-FMS-2025-002', name:'إجراءات التشغيل القياسية للجولات وفحص الأنظمة', category:'SOP', url:'https://drive.google.com/file/d/1mrKI8YTjSphAk-noRO8sp9GhYYLzR1FCBti2EDyDZOU/preview' },
    { code:'DEC-FMS-2025-001', name:'قرار تشكيل لجنة السلامة', category:'DEC', url:'https://drive.google.com/file/d/1KJcIqUbXfHIH0qt1UwoJ0Dohc_7n-745rhx90shaqNg/preview' },
    { code:'PLN-FMS-2025-004', name:'خطة الطوارئ والإخلاء', category:'PLN', url:'https://drive.google.com/file/d/1rPIuA5g52gQSroaaxznZ_SQNOj1TjEDuZ9DF0j3jvf4/preview' },
    { code:'PLN-FMS-2025-007', name:'خطة إدارة النفايات', category:'PLN', url:'https://drive.google.com/file/d/1iSoFBh8u4uTHzDJECxyjlEMeWqaScZwezgOXygEVdso/preview' },
    { code:'PLN-FMS-2025-012', name:'خطة إدارة الطاقة والمياه', category:'PLN', url:'https://drive.google.com/file/d/1b8oP_LOE_k7A0qXqhhVKWXF9zAvJMuSUOLFc1rBoflA/preview' },
    { code:'PLN-FMS-2025-016', name:'خطة الصيانة الطارئة', category:'PLN', url:'https://drive.google.com/file/d/1tQYPW6VHtr1liM7qMoPGgzDxopw9njYivS7WyKxokZw/preview' },
    { code:'PLN-FMS-2025-018', name:'خطة الأمن المادي للمرافق', category:'PLN', url:'https://drive.google.com/file/d/1aF0KTinNcF3gMIotj_byzrAkubX6Y30nZWmVuFM7BcA/preview' },
    { code:'TRN-FMS-2025-010', name:'خطة تدريب الأمن والسلامة', category:'TRN', url:'https://drive.google.com/file/d/1IwnBiZp11BjIDQLUtT5Ntr7kEhv3jmssvF5Vj6D7yRk/preview' },
    { code:'LOG-FMS-2025-005', name:'سجل الصيانة الوقائية', category:'LOG', url:'https://drive.google.com/file/d/10QjYYiAppgrOJpb6F2GxxwmRgRt2ooNOClo0etgzWpw/preview' },
    { code:'LOG-FMS-2025-006', name:'سجل الحوادث والملاحظات', category:'LOG', url:'https://drive.google.com/file/d/12D_ESZYNwjEfKZM6C0yzswbsccugSZZBOcMdHELd3TY/preview' },
    { code:'LOG-FMS-2025-014', name:'سجل زيارات الدفاع المدني والجهات التنظيمية', category:'LOG', url:'https://drive.google.com/file/d/1VMNxaSlkz_LX4OqktVHQsj1IT-GA6Y3eUnZa2rgegMA/preview' },
    { code:'CHK-FMS-2025-003', name:'قائمة التحقق الدورية للسلامة', category:'CHK', url:'https://drive.google.com/file/d/1C07oXDzj_Vfok81wQUde3P-ExeXhJh6LDwOS35jTDpk/preview' },
    { code:'CHK-FMS-2025-009', name:'سجل جولات لجنة السلامة', category:'CHK', url:'https://drive.google.com/file/d/1fKMIzns80N9IeSU18WudplOpA8DmbL4zmq72PRUmfZw/preview' },
    { code:'FRM-FMS-2025-011', name:'نموذج تقييم المخاطر البيئية والمادية', category:'FRM', url:'https://drive.google.com/file/d/15uefBzxMrX33-lBCHP3sZb_OZqoQ4hyiymQRnBrN_jo/preview' },
    { code:'FRM-FMS-2025-017', name:'نموذج متابعة تنفيذ التوصيات', category:'FRM', url:'https://drive.google.com/file/d/1Z7Bof_s4Dchx3G5tPzHAC77M4EDVGaxKVRlvJG_wMNY/preview' },
    { code:'REP-FMS-2025-008', name:'تقرير فحص الطفايات وأنظمة الإنذار', category:'REP', url:'https://drive.google.com/file/d/1Doz1piFf3dnYXKYtWoV4ExjXG_gmgRLVXkP7ej0sw9E/preview' },
    { code:'REP-FMS-2025-013', name:'تقرير الحوادث الطارئة', category:'REP', url:'https://drive.google.com/file/d/126D1IVGQpoCUxXZeNlob1fBD0LkXeNQdITDzL5OLXn0/preview' },
    { code:'FMS_Docs_2025_endorsed', name:'فهرس وثائق FMS المعتمدة 2025', category:'INDEX', url:'https://drive.google.com/file/d/1fTJG9dYRDsgBo0UFSKWlOIkVLkKCY0zO/preview' },
  ];

  const CATEGORY_NAMES = {
    POL:'السياسات', 
    SOP:'إجراءات التشغيل', 
    DEC:'القرارات', 
    PLN:'الخطط', 
    TRN:'التدريب', 
    LOG:'السجلات', 
    CHK:'قوائم التحقق', 
    FRM:'النماذج', 
    REP:'التقارير', 
    INDEX:'الفهرس'
  };

  function switchFmsTab(tab) {
    // تحديث أزرار التبويب
    document.querySelectorAll('[data-fms-tab]').forEach(button => {
      if (button.getAttribute('data-fms-tab') === tab) {
        button.classList.add('bg-[var(--brand1)]', 'text-white');
        button.classList.remove('bg-gray-100');
      } else {
        button.classList.remove('bg-[var(--brand1)]', 'text-white');
        button.classList.add('bg-gray-100');
      }
    });
    
    const container = document.getElementById('fmsTabContent');
    container.innerHTML = '';
    
    if (tab === 'library') {
      renderFmsLibrary(container, FMS_DOCS_LIBRARY);
    } else if (tab === 'rounds') {
      renderRoundsForm(container);
    } else if (tab === 'needs') {
      renderNeeds(container);
    }
  }

  function renderFmsLibrary(container, docs) {
    // عناصر التحكم
    const categories = [...new Set(docs.map(doc => doc.category))];
    const controls = document.createElement('div');
    controls.className = 'flex flex-wrap items-center gap-2 mb-4';
    controls.innerHTML = `
      <div class="flex flex-wrap gap-2">
        <button data-filter="ALL" class="px-3 py-1 rounded-full bg-[var(--brand1)] text-white text-sm">الكل</button>
        ${categories.map(cat => 
          `<button data-filter="${cat}" class="px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">${CATEGORY_NAMES[cat] || cat}</button>`
        ).join('')}
      </div>
      <div class="ml-auto w-full md:w-64">
        <input id="fmsSearch" type="text" placeholder="ابحث بالرمز أو العنوان..." class="w-full border rounded-lg px-3 py-2">
      </div>
    `;
    
    const grid = document.createElement('div');
    grid.className = 'grid-cards';
    grid.id = 'fmsGrid';
    
    container.appendChild(controls);
    container.appendChild(grid);
    
    // دالة التصفية والعرض
    function renderFilteredDocs(filter = 'ALL', query = '') {
      grid.innerHTML = '';
      const searchQuery = query.toLowerCase();
      
      const filteredDocs = docs.filter(doc => {
        const matchesFilter = filter === 'ALL' || doc.category === filter;
        const matchesQuery = !searchQuery || 
          doc.code.toLowerCase().includes(searchQuery) || 
          doc.name.toLowerCase().includes(searchQuery);
        return matchesFilter && matchesQuery;
      });
      
      filteredDocs.forEach(doc => {
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl border bg-white shadow-sm hover:shadow-md transition flex flex-col';
        card.innerHTML = `
          <div class="text-xs text-gray-500 mb-1">${CATEGORY_NAMES[doc.category] || doc.category}</div>
          <div class="font-extrabold text-[var(--brand1)]">${doc.code}</div>
          <div class="text-gray-800 mt-1 flex-1">${doc.name}</div>
          <div class="mt-3 flex gap-2">
            <button class="px-3 py-2 text-sm text-white rounded-lg bg-[var(--brand1)] hover:bg-[var(--brand2)]" 
                    onclick="openDocModal('${doc.code}: ${doc.name}', '${doc.url}')">
              <i class="fas fa-eye ml-1"></i> عرض
            </button>
            <a class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50" 
               target="_blank" href="${doc.url.replace('/preview', '/view')}">
              <i class="fas fa-up-right-from-square ml-1"></i> فتح في تبويب
            </a>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    
    // إضافة مستمعي الأحداث
    controls.querySelectorAll('button[data-filter]').forEach(button => {
      button.addEventListener('click', () => {
        controls.querySelectorAll('button[data-filter]').forEach(btn => {
          btn.classList.remove('bg-[var(--brand1)]', 'text-white');
        });
        button.classList.add('bg-[var(--brand1)]', 'text-white');
        renderFilteredDocs(button.getAttribute('data-filter'), document.getElementById('fmsSearch').value);
      });
    });
    
    document.getElementById('fmsSearch').addEventListener('input', (e) => {
      const activeFilter = controls.querySelector('button[data-filter].bg-[var(--brand1)]') || 
                          { getAttribute: () => 'ALL' };
      renderFilteredDocs(activeFilter.getAttribute('data-filter'), e.target.value);
    });
    
    // التهيئة الأولية
    renderFilteredDocs('ALL', '');
  }

  function renderRoundsForm(container) {
    const form = document.createElement('form');
    form.id = 'roundsForm';
    form.className = 'space-y-4 p-4 border rounded-xl';
    form.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">اسم المراقب *</label>
          <input name="inspector" required class="w-full border rounded-lg px-3 py-2" placeholder="اختر/اكتب اسم المراقب">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">الموقع/القسم *</label>
          <input name="location" required class="w-full border rounded-lg px-3 py-2" placeholder="عيادة 5، المدخل الرئيسي...">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">الأولوية *</label>
          <select name="priority" class="w-full border rounded-lg px-3 py-2">
            <option>🔴 عالية (إجراء فوري)</option>
            <option selected>🟡 متوسطة (خلال أسبوع)</option>
            <option>🟢 منخفضة (مجدول)</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">الملاحظة والتوصية *</label>
        <textarea name="observation" rows="4" required class="w-full border rounded-lg px-3 py-2" placeholder="اذكر الملاحظة والإجراء المقترح..."></textarea>
      </div>
      <div class="flex items-center gap-3">
        <button type="submit" class="px-4 py-2 rounded-lg bg-[var(--brand1)] text-white hover:bg-[var(--brand2)]">إرسال</button>
        <a class="px-4 py-2 rounded-lg bg-[var(--gold)] text-[var(--brand1)] shadow hover:opacity-90" target="_blank"
           href="https://docs.google.com/spreadsheets/d/1cGxMCYqGfPH2UiE-nsCoytIRjIPSDYxutnq04XF5YGs/edit?gid=597653922">🔄 عرض آخر الجولات</a>
        <span id="formMsg" class="text-sm"></span>
      </div>
    `;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageElement = document.getElementById('formMsg');
      messageElement.textContent = 'جارٍ الإرسال...';
      messageElement.className = 'text-sm text-blue-600';
      
      if (!FMS_API_URL || FMS_API_URL.includes('YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE')) {
        messageElement.textContent = '❗ رجاءً أضف رابط Web App أولًا.';
        messageElement.className = 'text-sm text-red-600';
        return;
      }
      
      try {
        const response = await fetch(FMS_API_URL, {
          method: 'POST',
          body: new FormData(form)
        });
        
        if (response.ok) {
          messageElement.textContent = '✅ تم الإرسال بنجاح.';
          messageElement.className = 'text-sm text-green-600';
          form.reset();
        } else {
          messageElement.textContent = '⚠️ تعذّر الإرسال. تحقق من صلاحيات Web App.';
          messageElement.className = 'text-sm text-red-600';
        }
      } catch (error) {
        messageElement.textContent = '⚠️ خطأ اتصال. افحص الرابط أو الشبكة.';
        messageElement.className = 'text-sm text-red-600';
      }
    });
    
    container.appendChild(form);
  }

  function renderNeeds(container) {
    const needs = [
      { key: 'policy', text: 'سياسة إدارة السلامة والمرافق (POL-001) معتمدة', required: true },
      { key: 'committee', text: 'قرار تشكيل لجنة السلامة (DEC-001) مُفعّل', required: true },
      { key: 'emerg', text: 'خطة الطوارئ والإخلاء (PLN-004) مُحدّثة', required: true },
      { key: 'ppm', text: 'سجل الصيانة الوقائية (LOG-005) مكتمل', required: true },
      { key: 'training', text: 'تنفيذ خطة التدريب (TRN-010)', required: true },
    ];
    
    const wrapper = document.createElement('div');
    wrapper.className = 'grid-cards';
    
    needs.forEach(need => {
      const card = document.createElement('div');
      card.className = 'p-4 rounded-xl border bg-white shadow-sm';
      card.innerHTML = `
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="checkbox" class="mt-1 h-5 w-5" data-required="${need.required ? 1 : 0}">
          <span class="font-semibold">${need.text}</span>
        </label>
        ${need.required ? '<div class="text-xs text-red-600 mt-1">متطلب إلزامي</div>' : ''}
      `;
      wrapper.appendChild(card);
    });
    
    const actions = document.createElement('div');
    actions.className = 'pt-2';
    actions.innerHTML = `
      <button class="px-4 py-2 rounded-lg bg-[var(--brand1)] text-white hover:bg-[var(--brand2)]" onclick="validateNeeds()">
        تحقّق من الاكتمال
      </button>
    `;
    
    container.appendChild(wrapper);
    container.appendChild(actions);
  }

  function validateNeeds() {
    const requiredCheckboxes = [...document.querySelectorAll('input[data-required="1"]')];
    const missingCount = requiredCheckboxes.filter(checkbox => !checkbox.checked).length;
    
    if (missingCount === 0) {
      alert('ممتاز ✅ — جميع المتطلبات الإلزامية مكتملة.');
    } else {
      alert(`⚠️ تنبيه: يوجد ${missingCount} متطلب(ات) إلزامي غير مكتمل.`);
    }
  }

  // ====== مكتبة RM ======
  const RM_DOCS_ESSENTIAL = [
    { code:'LD.31', name:'قرار اعتماد برنامج إدارة المخاطر (LD.31)', category:'DEC', url:'https://drive.google.com/file/d/1TYH87_v6rC2twWOZig2P5YDegRv6ir2dlYEU-v6KXwg/preview' },
    { code:'LD.31/32', name:'قرار تشكيل لجنة إدارة المخاطر وسلامة المرضى', category:'DEC', url:'https://drive.google.com/file/d/1yN0wiHu-mmNqFHF5XeEQIqOeMElIFSXn-xCz1AzAfco/preview' },
    { code:'LD.32', name:'قرار إداري باعتماد سياسة الإبلاغ عن الحوادث/الشكاوى', category:'POL', url:'https://drive.google.com/file/d/1irNRM1ovqwQEaEEj5gv9rmAuoV8O5aY-m0hSNykZDUk/preview' },
    { code:'IR', name:'نموذج بلاغ حادث (Incident Report)', category:'FRM', url:'https://drive.google.com/file/d/1rFQjcCWP010zLNb4FfRtT1aTmrbY9fyjGcMeYIXSQqQ/preview' },
    { code:'NM', name:'نموذج بلاغ قريب من الوقوع (Near Miss)', category:'FRM', url:'https://drive.google.com/file/d/1DhGR9WtVrM2LxITiv8WBMSCKs407Kb-vUZXg0mZVwD0/preview' },
    { code:'UNSAFE', name:'بلاغ خطر/شرط غير آمن', category:'FRM', url:'https://drive.google.com/file/d/1Yw7CFRvzssAWU0JYFkNz1Z9o0fQoMKCqoqrRhEHWZ_I/preview' },
    { code:'DEVICE', name:'بلاغ عطل جهاز/تجهيز', category:'FRM', url:'https://drive.google.com/file/d/17tZnAvhWCvPbb5Bp3UymLxzEz-IciEjxV4Tn97tIWwQ/preview' },
    { code:'SE', name:'إخطار حدث جسيم (Sentinel Event)', category:'FRM', url:'https://drive.google.com/file/d/1LrOlWxfECxyzF77DnerV15RjS-ElSTbIEa1UuKG3rD0/preview' },
    { code:'RCA/CAP', name:'تحليل السبب الجذري وخطة الإجراءات التصحيحية', category:'TOOL', url:'https://drive.google.com/file/d/1lDKsjgPDCdwXNV935kB_DfAm-ZsdzLPK8p4Pn7hgJJ0/preview' },
    { code:'HFMEA', name:'HFMEA (تحليل مسبق للمخاطر)', category:'TOOL', url:'https://drive.google.com/file/d/15ZjKLJYhe3HCUWbAO2Iw96IY1GOn1VNCWIjzdi9U4x8/preview' },
    { code:'REGISTER', name:'سجل المخاطر المؤسسي', category:'LOG', url:'https://drive.google.com/file/d/1XVMRWRZKoTpmXPzrPdXJA7PWf9r88YwLYv_tptdiZAA/preview' },
    { code:'KPI', name:'لوحة المؤشرات الشهرية لإدارة المخاطر', category:'DASH', url:'https://drive.google.com/file/d/1pj8P8rf4TZj_wVKgLrO8ayP9WNUBc1yTWeAy8r0xGOY/preview' },
    { code:'ESCALATION', name:'لوحة اتصالات وسلسلة التصعيد', category:'REF', url:'https://drive.google.com/file/d/1dZrkUB_d1XblN3QonWxPt9F1LQ6xQIbyNFT4ixI2m64/preview' },
  ];

  function renderRMLibrary() {
    const mount = document.getElementById('rmLib');
    if (!mount) return;
    
    mount.innerHTML = `
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <button data-rm="ALL" class="px-3 py-1 rounded-full bg-[var(--brand1)] text-white text-sm">الكل</button>
        ${[...new Set(RM_DOCS_ESSENTIAL.map(item => item.category))].map(cat => 
          `<button data-rm="${cat}" class="px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">${cat}</button>`
        ).join('')}
        <div class="ml-auto w-full md:w-64">
          <input id="rmSearch" type="text" placeholder="بحث..." class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>
      <div id="rmGrid" class="grid-cards"></div>
    `;
    
    const grid = mount.querySelector('#rmGrid');
    
    function renderRMItems(filter = 'ALL', query = '') {
      grid.innerHTML = '';
      const searchQuery = query.toLowerCase();
      
      const filteredItems = RM_DOCS_ESSENTIAL.filter(item => {
        const matchesFilter = filter === 'ALL' || item.category === filter;
        const matchesQuery = !searchQuery || 
          item.code.toLowerCase().includes(searchQuery) || 
          item.name.toLowerCase().includes(searchQuery);
        return matchesFilter && matchesQuery;
      });
      
      filteredItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl border bg-white shadow-sm hover:shadow-md transition flex flex-col';
        card.innerHTML = `
          <div class="text-xs text-gray-500 mb-1">${item.category}</div>
          <div class="font-extrabold text-[var(--brand1)]">${item.code}</div>
          <div class="text-gray-800 mt-1 flex-1">${item.name}</div>
          <div class="mt-3 flex gap-2">
            <button class="px-3 py-2 text-sm text-white rounded-lg bg-[var(--brand1)] hover:bg-[var(--brand2)]" 
                    onclick="openDocModal('${item.code}: ${item.name}', '${item.url}')">
              <i class="fas fa-eye ml-1"></i> عرض
            </button>
            <a class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50" 
               target="_blank" href="${item.url.replace('/preview', '/view')}">
              <i class="fas fa-up-right-from-square ml-1"></i> فتح في تبويب
            </a>
          </div>
        `;
        grid.appendChild(card);
      });
    }
    
    // إضافة مستمعي الأحداث
    mount.querySelectorAll('button[data-rm]').forEach(button => {
      button.addEventListener('click', () => {
        mount.querySelectorAll('button[data-rm]').forEach(btn => {
          btn.classList.remove('bg-[var(--brand1)]', 'text-white');
        });
        button.classList.add('bg-[var(--brand1)]', 'text-white');
        renderRMItems(button.getAttribute('data-rm'), mount.querySelector('#rmSearch').value || '');
      });
    });
    
    mount.querySelector('#rmSearch').addEventListener('input', (e) => {
      const activeFilter = mount.querySelector('button[data-rm].bg-[var(--brand1)]') || 
                          { getAttribute: () => 'ALL' };
      renderRMItems(activeFilter.getAttribute('data-rm'), e.target.value);
    });
    
    // التهيئة الأولية
    renderRMItems('ALL', '');
  }

  // ====== تهيئة الصفحة ======
  document.addEventListener('DOMContentLoaded', () => {
    // تهيئة إدارة الشعار
    setupLogoChange();
    loadSavedLogo();
    
    // تهيئة مكتبة RM
    renderRMLibrary();
    
    // زر العودة للأعلى
    window.addEventListener('scroll', () => {
      const scrollButton = document.getElementById('scrollTopBtn');
      if (scrollButton) {
        scrollButton.style.display = window.scrollY > 220 ? 'grid' : 'none';
      }
    });
    
    // نموذج التدريب
    const trainForm = document.getElementById('trainForm');
    if (trainForm) {
      trainForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageElement = document.getElementById('trainMsg');
        messageElement.textContent = 'جارٍ الحفظ...';
        messageElement.className = 'text-sm text-blue-600';
        
        if (!TRAIN_API_URL || TRAIN_API_URL.includes('YOUR_GAS_TRAINING_WEB_APP_URL_HERE')) {
          messageElement.textContent = '❗ أضف رابط سكربت التدريب لاحقًا.';
          messageElement.className = 'text-sm text-red-600';
          return;
        }
        
        try {
          const response = await fetch(TRAIN_API_URL, {
            method: 'POST',
            body: new FormData(trainForm)
          });
          
          if (response.ok) {
            messageElement.textContent = '✅ تم الحفظ.';
            messageElement.className = 'text-sm text-green-600';
            trainForm.reset();
          } else {
            messageElement.textContent = '⚠️ تعذّر الحفظ. افحص صلاحيات السكربت.';
            messageElement.className = 'text-sm text-red-600';
          }
        } catch (error) {
          messageElement.textContent = '⚠️ خطأ اتصال.';
          messageElement.className = 'text-sm text-red-600';
        }
      });
    }
  });

  // جعل الدوال متاحة عالميًا
  window.navTo = navTo;
  window.openDocModal = openDocModal;
  window.closeDocModal = closeDocModal;
  window.switchFmsTab = switchFmsTab;
  window.switchPscTab = switchPscTab;
  window.validateNeeds = validateNeeds;
  window.renderPscChart = renderPscChart;
  window.validatePscNeeds = validatePscNeeds;
  window.generatePscReport = generatePscReport;
</script>
</body>
</html>
