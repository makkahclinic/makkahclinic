<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ© â€“ Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</title>

  <!-- Ø®Ø·ÙˆØ· -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;800;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Bootstrap RTL + Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª + Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --crimson:#7d0024;
      --crimson-2:#5b001a;
      --gold:#d4af37;
      --bg:#1a0b10;
      --muted:rgba(255,255,255,.7);
      --emerald:#10b981;
      --ruby:#ef4444;
      --sapphire:#3b82f6;
      --amber:#f59e0b;
      --amethyst:#8b5cf6;
      --topaz:#f97316;
      --pearl:#f8fafc;
    }

    * { box-sizing:border-box; }

    body{
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(ellipse at 20% 10%, rgba(212,175,55,.08) 0%, transparent 50%),
                  radial-gradient(ellipse at 80% 60%, rgba(125,0,36,.06) 0%, transparent 50%),
                  linear-gradient(135deg, #2a0b14 0%, #18060a 55%, #110306 100%);
      background-size: cover, cover, auto;
      color: var(--pearl);
      min-height: 100vh;
    }

    h1,h2,h3,h4,h5{font-family:'Cairo',Tajawal,Arial;letter-spacing:.2px}

    .navbar{
      background: linear-gradient(135deg, var(--crimson), var(--crimson-2));
      border-bottom: 2px solid var(--gold);
      box-shadow:0 10px 30px rgba(0,0,0,.5);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;align-items:center;gap:.75rem;color:#fff;text-decoration:none
    }
    .brand img{
      width:48px;height:48px;border-radius:50%;background:#fff;object-fit:cover;
      box-shadow:0 0 0 3px rgba(212,175,55,.4),0 8px 24px rgba(0,0,0,.6)
    }
    .brand span{font-family:'Cairo';font-weight:800;text-shadow:0 2px 4px rgba(0,0,0,.3)}

    .tabbar{
      background: rgba(255,255,255,.08);
      border-bottom: 1px solid rgba(255,255,255,.2);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(8px);
    }

    .tabbar .nav-link{
      color:rgba(255,255,255,0.85);
      border:none;
      border-bottom:3px solid transparent;
      border-radius:8px 8px 0 0;
      font-weight:700;
      padding:10px 18px;
      transition:all .25s ease;
      position:relative;
      overflow:hidden;
    }
    .tabbar .nav-link:hover{
      background:rgba(255,255,255,0.08);
      color:#fff;
    }
    .tabbar .nav-link.active{
      border-color:var(--gold);
      background:rgba(212,175,55,0.18);
      color:#fff;
    }

    .card-glass{
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:20px;
      box-shadow:0 14px 32px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      transition:all .25s ease;
    }
    .card-glass:hover{
      transform:translateY(-4px);
      box-shadow:0 18px 36px rgba(0,0,0,.55);
      border-color:rgba(255,255,255,0.28);
    }

    .kpi{
      padding:20px;
      border-radius:18px;
      position:relative;
      overflow:hidden;
      border:1px solid transparent;
    }
    .kpi-icon{
      width:44px;height:44px;
      border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-size:1.4rem;
      margin-bottom:10px;
      background:rgba(0,0,0,0.2);
      box-shadow:0 4px 10px rgba(0,0,0,.25);
    }
    .kpi .label{
      color:var(--muted);
      font-size:.9rem;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .kpi .value{
      font-family:'Cairo';
      font-size:40px;
      font-weight:900;
      line-height:1.1;
      margin:6px 0;
      text-shadow:0 2px 8px rgba(0,0,0,.35);
    }
    .kpi .hint{
      color:var(--muted);
      font-size:.85rem;
    }

    .kpi.amethyst{background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(15,23,42,0.8));border-color:rgba(139,92,246,0.6);}
    .kpi.amethyst .kpi-icon{background:rgba(139,92,246,0.3);color:#e5e7ff;}
    .kpi.amethyst .value{color:#e5e7ff;}

    .kpi.sapphire{background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(15,23,42,0.8));border-color:rgba(59,130,246,0.6);}
    .kpi.sapphire .kpi-icon{background:rgba(59,130,246,0.3);color:#bfdbfe;}
    .kpi.sapphire .value{color:#bfdbfe;}

    .kpi.ruby{background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(15,23,42,0.8));border-color:rgba(239,68,68,0.7);}
    .kpi.ruby .kpi-icon{background:rgba(239,68,68,0.3);color:#fecaca;}
    .kpi.ruby .value{color:#fecaca;}

    .kpi.emerald{background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(15,23,42,0.8));border-color:rgba(16,185,129,0.7);}
    .kpi.emerald .kpi-icon{background:rgba(16,185,129,0.3);color:#bbf7d0;}
    .kpi.emerald .value{color:#bbf7d0;}

    .kpi.topaz{background:linear-gradient(135deg,rgba(249,115,22,0.2),rgba(15,23,42,0.8));border-color:rgba(249,115,22,0.7);}
    .kpi.topaz .kpi-icon{background:rgba(249,115,22,0.3);color:#fed7aa;}
    .kpi.topaz .value{color:#fed7aa;}

    .kpi.amber{background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(15,23,42,0.8));border-color:rgba(245,158,11,0.7);}
    .kpi.amber .kpi-icon{background:rgba(245,158,11,0.3);color:#fef3c7;}
    .kpi.amber .value{color:#fef3c7;}

    .badge-status{
      padding:.45rem .75rem;
      border-radius:999px;
      font-weight:700;
      border:2px solid rgba(255,255,255,.18);
      color:#fff;
      backdrop-filter:blur(8px);
      font-size:.8rem;
    }
    .badge-status.completed{background:linear-gradient(135deg,#16a34a,#22c55e);border-color:rgba(34,197,94,.7);}
    .badge-status.pending{background:linear-gradient(135deg,#f59e0b,#eab308);border-color:rgba(245,158,11,.7);}
    .badge-status.overdue{background:linear-gradient(135deg,#dc2626,#ef4444);border-color:rgba(239,68,68,.8);box-shadow:0 0 0 4px rgba(248,113,113,.25);}
    .badge-status.critical{background:linear-gradient(135deg,#7f1d1d,#b91c1c);border-color:rgba(248,113,113,.8);}
    .badge-status.due{background:linear-gradient(135deg,#f97316,#eab308);border-color:rgba(249,115,22,.8);}
    .badge-status.due-soon{background:linear-gradient(135deg,#eab308,#facc15);border-color:rgba(250,204,21,.8);}

    .table thead th{
      background:linear-gradient(135deg,rgba(255,255,255,.16),rgba(255,255,255,.08));
      border-bottom:2px solid rgba(255,255,255,.25);
      color:#fff;
    }
    .table{color:#fff;}
    .table tbody tr{transition:all .2s ease;}
    .table tbody tr:hover{background:rgba(255,255,255,.09);transform:translateX(3px);}

    .form-control,.form-select{
      background:rgba(0,0,0,.45) !important;
      color:#f9fafb !important;
      border:1px solid rgba(255,255,255,.25) !important;
      border-radius:10px;
      font-weight:500;
      transition:all .2s ease;
    }
    .form-control:focus,.form-select:focus{
      background:rgba(0,0,0,.7) !important;
      border-color:var(--gold) !important;
      box-shadow:0 0 0 3px rgba(212,175,55,.35) !important;
      transform:translateY(-1px);
    }

    /* ØªÙˆØ¶ÙŠØ­ Ù„ÙˆÙ† Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø£Ø¨ÙŠØ¶ ÙˆÙˆØ§Ø¶Ø­) */
    input[type="date"].form-control{
      color:#ffffff !important;
    }
    input[type="date"].form-control::-webkit-datetime-edit{
      color:#ffffff !important;
    }
    input[type="date"].form-control::-webkit-datetime-edit-text{
      color:#e5e7eb !important;
    }
    input[type="date"].form-control::-webkit-calendar-picker-indicator{
      filter:invert(1);
      cursor:pointer;
    }

    .btn-gold{
      background:linear-gradient(135deg,var(--gold),#f5d86c);
      color:#331a00;
      border:none;
      font-weight:800;
      border-radius:10px;
      box-shadow:0 4px 14px rgba(212,175,55,.35);
    }
    .btn-gold:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(212,175,55,.4);
    }
    .btn-crimson{
      background:linear-gradient(135deg,var(--crimson),var(--crimson-2));
      border:none;
      color:#fff;
      border-radius:10px;
      box-shadow:0 4px 14px rgba(125,0,36,.35);
    }
    .btn-crimson:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(125,0,36,.4);
    }
    .btn-outline-gold{
      border:2px solid var(--gold);
      color:#fff;
      border-radius:10px;
      background:rgba(212,175,55,.08);
    }
    .btn-outline-gold:hover{
      background:var(--gold);
      color:#331a00;
      transform:translateY(-1px);
    }

    .smallmuted{color:var(--muted);}

    .dropzone{
      border:2px dashed rgba(212,175,55,.55);
      border-radius:16px;
      padding:24px;
      text-align:center;
      background:rgba(212,175,55,.08);
      cursor:pointer;
      transition:all .2s ease;
    }
    .dropzone.drag,.dropzone:hover{
      background:rgba(212,175,55,.16);
      border-color:rgba(212,175,55,.8);
    }
    .preview img{
      max-height:90px;
      margin:6px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,.25);
      box-shadow:0 4px 12px rgba(0,0,0,.35);
    }
    .thumb{
      display:inline-block;
      position:relative;
      margin:6px;
    }
    .thumb .x{
      position:absolute;
      top:-10px;
      left:-10px;
      width:22px;height:22px;
      border-radius:50%;
      border:none;
      background:#b91c1c;
      color:#fff;
      font-size:14px;
      line-height:20px;
      cursor:pointer;
      box-shadow:0 3px 8px rgba(0,0,0,.45);
    }

    .toast-lite{
      position:fixed;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      z-index:9999;
      background:linear-gradient(135deg,var(--crimson),#3a0010);
      color:#fff;
      padding:10px 18px;
      border-radius:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.5);
      font-weight:700;
    }

    .chart-container{
      position:relative;
      height:220px;
      width:100%;
    }

    .alert-item{
      padding:10px 12px;
      margin-bottom:8px;
      border-radius:10px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.15);
      border-right:4px solid transparent;
      display:block;
    }
    .alert-item.critical{border-right-color:var(--ruby);}
    .alert-item.due-soon{border-right-color:var(--amber);}

    .loading-spinner{
      display:inline-block;
      width:2rem;height:2rem;
      border:.25em solid currentColor;
      border-right-color:transparent;
      border-radius:50%;
      animation:spinner-border .75s linear infinite;
    }
    @keyframes spinner-border{to{transform:rotate(360deg);}}

    footer{
      border-top:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      backdrop-filter:blur(8px);
      margin-top:20px;
    }

    @media (max-width:768px){
      .kpi .value{font-size:30px;}
      .tabbar .nav-link{padding:8px 10px;font-size:.9rem;}
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="brand" href="#">
      <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo.png" alt="Ø´Ø¹Ø§Ø±">
      <span>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</span>
    </a>
    <div class="ms-auto d-flex gap-2">
      <button id="btnExportXLSX" class="btn btn-outline-gold btn-sm">
        <i class="fa-solid fa-file-excel ms-1"></i> ØªØµØ¯ÙŠØ± Excel
      </button>
      <button id="btnExportPDF" class="btn btn-outline-gold btn-sm">
        <i class="fa-solid fa-file-pdf ms-1"></i> ØªØµØ¯ÙŠØ± PDF
      </button>
      <button id="btnRefreshAll" class="btn btn-gold btn-sm">
        <i class="fa-solid fa-rotate ms-1"></i> ØªØ­Ø¯ÙŠØ«
      </button>
      <button id="btnRepairSheets" class="btn btn-outline-warning btn-sm">
        <i class="fa-solid fa-tools ms-1"></i> Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
      </button>
    </div>
  </div>
</nav>

<section class="tabbar">
  <div class="container">
    <ul class="nav nav-tabs" id="tabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button">
          <i class="fa-solid fa-gauge-high me-1"></i> Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-log" type="button">
          <i class="fa-solid fa-list me-1"></i> Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-add" type="button">
          <i class="fa-solid fa-plus me-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©
        </button>
      </li>
    </ul>
  </div>
</section>

<div class="tab-content">
  <!-- Dashboard -->
  <div id="tab-dashboard" class="tab-pane fade show active">
    <div class="container py-4">
      <div class="row g-3">
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi amethyst h-100">
            <div class="kpi-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <div class="label"><i class="fa-solid fa-clock"></i> Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ Ù„Ù… ØªØªÙ… ØµÙŠØ§Ù†ØªÙ‡Ø§</div>
            <div id="kpiNotServiced" class="value">â€”</div>
            <div class="hint">Ø£Ø¬Ù‡Ø²Ø© Ù„Ù… ÙŠÙØ³Ø¬Ù„ Ù„Ù‡Ø§ Ø£ÙŠ Ù…Ù‡Ù…Ø© ØµÙŠØ§Ù†Ø©</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi sapphire h-100">
            <div class="kpi-icon"><i class="fa-solid fa-calendar-day"></i></div>
            <div class="label"><i class="fa-solid fa-calendar-check"></i> Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
            <div id="kpiDueThisMonth" class="value">0</div>
            <div class="hint">Ø§Ù„Ù…Ù‡Ø§Ù… ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø¯Ø§Ø®Ù„ Ø´Ù‡Ø±Ù†Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi ruby h-100">
            <div class="kpi-icon"><i class="fa-solid fa-clock-rotate-left"></i></div>
            <div class="label"><i class="fa-solid fa-calendar-xmark"></i> Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</div>
            <div id="kpiOverdue" class="value">0</div>
            <div class="hint">ØªØ¬Ø§ÙˆØ²Øª ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ ÙˆÙ„Ù… ØªÙØºÙ„Ù‚ Ø¨Ø¹Ø¯</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi amber h-100">
            <div class="kpi-icon"><i class="fa-solid fa-power-off"></i></div>
            <div class="label"><i class="fa-solid fa-ban"></i> Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</div>
            <div id="kpiOutOfService" class="value">0</div>
            <div class="hint">Ø£Ø¬Ù‡Ø²Ø© ØºÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
          </div>
        </div>

        <div class="col-6 col-lg-3">
          <div class="card-glass kpi topaz h-100">
            <div class="kpi-icon"><i class="fa-solid fa-list-check"></i></div>
            <div class="label"><i class="fa-solid fa-hourglass-half"></i> ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            <div id="kpiUncompleted" class="value">0</div>
            <div class="hint">ÙƒÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø© (Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±/Ù…ØªØ£Ø®Ø±Ø©)</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi ruby h-100">
            <div class="kpi-icon"><i class="fa-solid fa-skull-crossbones"></i></div>
            <div class="label"><i class="fa-solid fa-bolt"></i> Ø§Ù„Ø­Ø±Ø¬Ø©</div>
            <div id="kpiCritical" class="value">0</div>
            <div class="hint">Ù…Ù‡Ø§Ù… Ø­Ø±Ø¬Ø© ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„Ù‹Ø§ Ø¹Ø§Ø¬Ù„Ù‹Ø§</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi emerald h-100">
            <div class="kpi-icon"><i class="fa-solid fa-circle-check"></i></div>
            <div class="label"><i class="fa-solid fa-check-double"></i> Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            <div id="kpiCompleted" class="value">0</div>
            <div class="hint">Ù…Ù‡Ø§Ù… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi sapphire h-100">
            <div class="kpi-icon"><i class="fa-solid fa-hourglass-end"></i></div>
            <div class="label"><i class="fa-solid fa-clock"></i> Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù</div>
            <div id="kpiDowntime" class="value">0</div>
            <div class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-lg-6">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3"><i class="fa-solid fa-chart-line me-1"></i> Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ù…Ù†Ø¬Ø²)</h5>
            <div class="chart-container"><canvas id="lineMonthly"></canvas></div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3"><i class="fa-solid fa-chart-pie me-1"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</h5>
            <div class="chart-container"><canvas id="donutStatus"></canvas></div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3"><i class="fa-solid fa-bell me-1"></i> ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</h5>
            <div id="alertsList" class="small"></div>
            <div class="smallmuted mt-2">
              <i class="fa-solid fa-circle me-1" style="color:#f97316"></i> Ø®Ù„Ø§Ù„ 10 Ø£ÙŠØ§Ù…
              â€¢
              <i class="fa-solid fa-circle me-1" style="color:#ef4444"></i> Ù…ØªØ¬Ø§ÙˆØ²Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯
            </div>
          </div>
        </div>
      </div>

      <div class="card-glass p-3 mt-3">
        <h5 class="mb-3"><i class="fa-solid fa-chart-bar me-1"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
        <div class="chart-container" style="height:240px"><canvas id="barDept"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div id="tab-log" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-3 mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label"><i class="fa-solid fa-building me-1"></i> Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="filterDept" class="form-select">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label"><i class="fa-solid fa-tags me-1"></i> Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="filterType" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="PM">ÙˆÙ‚Ø§Ø¦ÙŠØ© (PM)</option>
              <option value="CM">ØªØµØ­ÙŠØ­ÙŠØ© (CM)</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label"><i class="fa-solid fa-circle-info me-1"></i> Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="filterStatus" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
              <option value="Pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="Overdue">Ù…ØªØ£Ø®Ø±Ø©</option>
              <option value="Critical">Ø­Ø±Ø¬Ø©</option>
              <option value="OutOfService">Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label"><i class="fa-solid fa-search me-1"></i> Ø¨Ø­Ø«</label>
            <input id="searchBox" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ÙÙ†ÙŠØŒ Ø§Ù„Ù‚Ø³Ù…ØŒ ...">
          </div>
          <div class="col-md-2 d-grid">
            <button id="btnShowAlertsOnly" class="btn btn-crimson">
              <i class="fa-solid fa-triangle-exclamation ms-1"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
            </button>
          </div>
        </div>
      </div>

      <div class="card-glass p-3">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù‚Ø³Ù…</th>
                <th>Ø§Ù„ÙÙ†ÙŠ</th>
                <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                <th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                <th>Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th>
                <th>Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr>
                <td colspan="13" class="text-center py-4">
                  <div class="loading-spinner text-light"></div>
                  <div class="smallmuted mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between mt-2 smallmuted">
          <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="totalCount">0</b></div>
          <div>Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: <b id="viewCount">0</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task -->
  <div id="tab-add" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-3">
        <h5 class="mb-3"><i class="fa-solid fa-plus-circle me-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ØµÙŠØ§Ù†Ø©</h5>
        <form id="formNew" class="row g-3">
          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-building me-1"></i> Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="fDepartment" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-user me-1"></i> Ø§Ù„ÙÙ†ÙŠ</label>
            <select id="fStaff" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-tag me-1"></i> Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <select id="fTaskType" class="form-select" required>
              <option value="PM">ÙˆÙ‚Ø§Ø¦ÙŠØ© (PM)</option>
              <option value="CM">ØªØµØ­ÙŠØ­ÙŠØ© (CM)</option>
            </select>
          </div>

          <div class="col-md-8">
            <label class="form-label"><i class="fa-solid fa-microchip me-1"></i> Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
            <select id="fAsset" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ù‹Ø§ â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-arrow-up me-1"></i> Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
            <select id="fPriority" class="form-select">
              <option value="High">Ø¹Ø§Ù„ÙŠØ©</option>
              <option value="Medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
              <option value="Low">Ù…Ù†Ø®ÙØ¶Ø©</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-play me-1"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</label>
            <input id="fStart" type="date" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-repeat me-1"></i> ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
            <select id="fFreq" class="form-select">
              <option value="">Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</option>
              <option value="W1">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
              <option value="M1">Ø´Ù‡Ø±ÙŠ</option>
              <option value="M3">ÙƒÙ„ 3 Ø£Ø´Ù‡Ø±</option>
              <option value="M6">ÙƒÙ„ 6 Ø£Ø´Ù‡Ø±</option>
              <option value="M12">Ø³Ù†ÙˆÙŠ</option>
              <option value="Y2">ÙƒÙ„ Ø³Ù†ØªÙŠÙ†</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-flag me-1"></i> Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
            <input id="fDue" type="date" class="form-control" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-circle-info me-1"></i> Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="fStatus" class="form-select" required>
              <option value="Pending" selected>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="Completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
              <option value="Critical">Ø­Ø±Ø¬Ø©</option>
              <option value="OutOfService">Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-hourglass-end me-1"></i> Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù</label>
            <input id="fDown" type="number" min="0" step="0.1" class="form-control" value="0">
          </div>
          <div class="col-md-4">
            <label class="form-label"><i class="fa-solid fa-stop me-1"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø¥Ù† ÙˆÙØ¬Ø¯)</label>
            <input id="fCompleted" type="date" class="form-control">
          </div>

          <div class="col-12">
            <label class="form-label"><i class="fa-solid fa-paperclip me-1"></i> Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
            <div id="dropzone" class="dropzone">
              <i class="fa-solid fa-cloud-arrow-up fa-2x mb-2"></i>
              <div class="smallmuted">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± â€” Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ù„ÙØ§Øª</div>
              <input id="fFiles" type="file" class="d-none" accept="image/*,.pdf,.doc,.docx,.xlsx,.xls" multiple>
              <div id="dzPreview" class="preview mt-2"></div>
              <div id="dzInfo" class="small mt-1"></div>
              <div class="progress d-none" id="dzProgress">
                <div class="progress-bar bg-warning" style="width:0%"></div>
              </div>
            </div>
          </div>

          <div class="col-12 d-flex gap-2 justify-content-end">
            <button type="button" id="btnReset" class="btn btn-outline-gold">
              <i class="fa-solid fa-rotate-left ms-1"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
            </button>
            <button type="submit" class="btn btn-gold">
              <i class="fa-solid fa-floppy-disk ms-1"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<footer class="container py-4">
  <div class="d-flex flex-column flex-md-row align-items-center justify-content-between smallmuted">
    <div>Â© 2025 Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</div>
    <div><i class="fa-solid fa-envelope ms-1"></i> support@makkahclinic.com</div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /*************** Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ ****************/
  const API_URL = 'https://script.google.com/macros/s/AKfycbxw6oWSHKDjeZI6dsspS3PVVwbO9KO5UnjKGqDa_yP9cYAVjNHh6WMfQrdlpkF_A25--A/exec';

  const CONFIG = {
    MAX_FILES: 5,
    MAX_MB: 10,
    AUTO_REFRESH_MS: 5 * 60 * 1000
  };

  const App = {
    records: [],
    assetsMap: {},
    staff: [],
    charts: { donut: null, bar: null, line: null },
    filters: { dept: "", type: "", status: "", search: "", alertsOnly: false }
  };

  const $  = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  function toast(msg, type="info"){
    const t = document.createElement('div');
    t.className = 'toast-lite';
    t.style.background = type === 'error'
      ? 'linear-gradient(135deg,#b91c1c,#7f1d1d)'
      : type === 'success'
      ? 'linear-gradient(135deg,#15803d,#22c55e)'
      : 'linear-gradient(135deg,var(--crimson),#3a0010)';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }

  function fmt(d){
    if (!d) return "";
    const x = new Date(d);
    return isNaN(x) ? String(d) : x.toLocaleDateString('ar-SA');
  }

  function addDays(d, n){
    const x = new Date(d);
    x.setDate(x.getDate() + n);
    return x;
  }

  function classify(r){
    const status = String(r.Status || '').trim();
    if (status === 'Completed')    return 'Completed';
    if (status === 'OutOfService') return 'OutOfService';
    if (status === 'Critical')     return 'Critical';
    if (status === 'Overdue')      return 'Overdue'; // Ù„Ùˆ ÙÙŠÙ‡ Ù‚Ø¯ÙŠÙ… ÙŠØ¯ÙˆÙŠ

    const due = r.DueDate ? new Date(r.DueDate) : null;
    if (due && !isNaN(due)){
      const today = new Date();
      today.setHours(0,0,0,0);
      due.setHours(0,0,0,0);
      if (due < today)               return 'Overdue';
      if (due <= addDays(today, 10)) return 'DueSoon';
    }
    return status || 'Pending';
  }

  function animateValue(el, to, suffix=""){
    const start = 0, dur = 900, t0 = performance.now();
    function step(now){
      const p = Math.min(1, (now - t0)/dur);
      el.textContent = Math.round(start + (to - start)*p) + suffix;
      if (p < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  /*************** Ø·Ø¨Ù‚Ø© API ****************/
  const API = {
    async _parseResponse(r){
      const raw = await r.text();
      if (!r.ok) throw new Error(`HTTP ${r.status}: ${raw.slice(0,200)}`);
      let json;
      try { json = JSON.parse(raw); }
      catch { throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± JSON Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: ' + raw.slice(0,200)); }
      if (json?.success === false || json?.error) {
        throw new Error(json.error || 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
      }
      return json.data ?? json;
    },
    async _get(action, params = {}){
      const url = new URL(API_URL);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v])=>{
        if (v !== undefined && v !== null) url.searchParams.set(k, v);
      });
      const r = await fetch(url.toString(), {method:'GET'});
      return this._parseResponse(r);
    },
    async _post(action, params = {}){
      const payload = { action, ...params };
      const r = await fetch(API_URL,{
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body:JSON.stringify(payload)
      });
      return this._parseResponse(r);
    },

    getRecords(){ return this._get('getRecords'); },
    getAssets(){  return this._get('getAssets');  },
    getStaff(){   return this._get('getStaff');   },
    getKPIs(){    return this._get('getKPIs');    },

    addRecord(p){           return this._post('addRecord', p);           },
    deleteRecord(p){        return this._post('deleteRecord', p);        },
    updateRecord(p){        return this._post('updateRecord', p);        },
    uploadFile(p){          return this._post('uploadFile', p);          },
    generateCertificate(p){ return this._post('generateCertificate', p); },

    exportData(format){ return this._get('export', {format}); },
    repairSheets(){     return this._get('repair');           },
    healthCheck(){      return this._get('health');           }
  };

  /*************** ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ ****************/
  document.addEventListener('DOMContentLoaded', async () => {
    try{
      $('#fStart').value = new Date().toISOString().split('T')[0];
      bindEvents();
      await loadAll();
      setInterval(loadAll, CONFIG.AUTO_REFRESH_MS);
    } catch(e){
      console.error('INIT error:', e);
      toast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ' + e.message, 'error');
    }
  });

  function bindEvents(){
    // ÙÙ„Ø§ØªØ±
    $('#filterDept').addEventListener('change', e => { App.filters.dept = e.target.value; renderLog(); });
    $('#filterType').addEventListener('change', e => { App.filters.type = e.target.value; renderLog(); });
    $('#filterStatus').addEventListener('change', e => { App.filters.status = e.target.value; renderLog(); });
    $('#searchBox').addEventListener('input', e => { App.filters.search = e.target.value.toLowerCase(); renderLog(); });
    $('#btnShowAlertsOnly').addEventListener('click', () => {
      App.filters.alertsOnly = !App.filters.alertsOnly;
      renderLog();
    });

    // ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚
    $('#fFreq').addEventListener('change', calcNextDue);
    $('#fStart').addEventListener('change', calcNextDue);

    // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„ÙÙˆØ±Ù…
    $('#fDepartment').addEventListener('change', () => {
      const dep = $('#fDepartment').value;
      const arr = App.assetsMap[dep] || [];
      $('#fAsset').innerHTML = arr.length
        ? '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² â€”</option>' + arr.map(a => `<option value="${a.id}">${a.name}</option>`).join('')
        : '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø©</option>';
    });

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
    const dz = $('#dropzone'), fi = $('#fFiles');
    dz.addEventListener('click', () => fi.click());
    dz.addEventListener('dragover', e => {e.preventDefault(); dz.classList.add('drag');});
    dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
    dz.addEventListener('drop', e => {
      e.preventDefault();
      dz.classList.remove('drag');
      handleFiles(e.dataTransfer.files);
    });
    fi.addEventListener('change', () => handleFiles(fi.files));

    // ÙÙˆØ±Ù…
    $('#formNew').addEventListener('submit', submitNew);
    $('#btnReset').addEventListener('click', () => { $('#formNew').reset(); resetFilesUI(); });

    // Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø©
    $('#btnExportXLSX').addEventListener('click', async () => {
      try{
        const r = await API.exportData('xlsx');
        if (r.url && r.url !== 'about:blank') window.open(r.url, '_blank');
        else toast('Ù…ÙŠØ²Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
      }catch(e){ toast('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Excel: ' + e.message, 'error'); }
    });

    $('#btnExportPDF').addEventListener('click', async () => {
      try{
        const r = await API.exportData('pdf');
        if (r.url && r.url !== 'about:blank') window.open(r.url, '_blank');
        else toast('Ù…ÙŠØ²Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
      }catch(e){ toast('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + e.message, 'error'); }
    });

    $('#btnRefreshAll').addEventListener('click', loadAll);

    $('#btnRepairSheets').addEventListener('click', async () => {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŸ')) return;
      try{
        await API.repairSheets();
        toast('ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„', 'success');
        await loadAll();
      }catch(e){ toast('ÙØ´Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ' + e.message, 'error'); }
    });

    // Ø£Ø­Ø¯Ø§Ø« Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©: Ø­Ø°Ù / Ø´Ù‡Ø§Ø¯Ø©
    document.addEventListener('click', async e => {
      const delBtn = e.target.closest('.del-rec');
      if (delBtn){
        e.preventDefault();
        await handleDelete(delBtn);
        return;
      }
      const certBtn = e.target.closest('.btn-gen-cert');
      if (certBtn){
        e.preventDefault();
        await handleGenerateCert(certBtn);
        return;
      }
    });
  }

  /*************** Ø­Ø°Ù Ùˆ Ø´Ù‡Ø§Ø¯Ø© ****************/
  async function handleDelete(btn){
    const recordId = btn.dataset.id;
    const timestamp = btn.dataset.timestamp;
    const assetName = btn.dataset.asset || '';

    if (!recordId){
      toast('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„ Ù„Ù„Ø­Ø°Ù', 'error');
      return;
    }
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„Ø¬Ù‡Ø§Ø²:\n${assetName} ØŸ`)) return;

    try{
      btn.disabled = true;
      const old = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      await API.deleteRecord({id:recordId, timestamp});
      toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
      await loadAll();
      btn.innerHTML = old;
    }catch(e){
      console.error('delete error', e);
      toast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„: ' + e.message, 'error');
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-trash"></i>';
    }
  }

  async function handleGenerateCert(btn){
    const id = btn.dataset.id;
    if (!id){
      toast('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„ Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©', 'error');
      return;
    }
    try{
      btn.disabled = true;
      const old = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      await API.generateCertificate({id});
      toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
      await loadAll();
      btn.innerHTML = old;
    }catch(e){
      console.error('cert error', e);
      toast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ' + e.message, 'error');
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-file-circle-plus"></i>';
    }
  }

  /*************** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ****************/
  async function loadAll(){
    try{
      const [recordsRes, assetsRes, staffRes, kpisRes] = await Promise.allSettled([
        API.getRecords(),
        API.getAssets(),
        API.getStaff(),
        API.getKPIs()
      ]);

      App.records   = recordsRes.status === 'fulfilled' ? (recordsRes.value || []) : [];
      App.assetsMap = assetsRes.status === 'fulfilled' ? (assetsRes.value || {}) : {};
      App.staff     = staffRes.status === 'fulfilled' ? (staffRes.value || []) : [];
      const kpis    = kpisRes.status === 'fulfilled' ? (kpisRes.value || null) : null;

      const depts = Object.keys(App.assetsMap).sort();
      $('#filterDept').innerHTML   = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>' + depts.map(d=>`<option>${d}</option>`).join('');
      $('#fDepartment').innerHTML  = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>' + depts.map(d=>`<option>${d}</option>`).join('');
      $('#fStaff').innerHTML       = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>' + (App.staff || []).map(s=>`<option>${s}</option>`).join('');

      updateKPIs(kpis);
      drawCharts();
      renderLog();

      const failed = [recordsRes,assetsRes,staffRes,kpisRes].filter(r=>r.status==='rejected').length;
      if (failed) toast('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ø²Ø¦ÙŠÙ‹Ø§. Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.', 'warning');
      else        toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success');
    }catch(e){
      console.error('loadAll error', e);
      toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + e.message, 'error');
    }
  }

  /*************** KPIs ****************/
  function updateKPIs(kpisData){
    if (kpisData && typeof kpisData === 'object'){
      animateValue($('#kpiNotServiced'), kpisData.notServiced ?? 0);
      animateValue($('#kpiOverdue'),      kpisData.overdue      ?? 0);
      animateValue($('#kpiDueThisMonth'), kpisData.dueThisMonth ?? 0);
      animateValue($('#kpiOutOfService'), kpisData.outOfService ?? 0);
      animateValue($('#kpiCompleted'),    kpisData.completed    ?? 0);
      animateValue($('#kpiCritical'),     kpisData.critical     ?? 0);
      animateValue($('#kpiUncompleted'),  kpisData.uncompleted  ?? 0);
      animateValue($('#kpiDowntime'),     kpisData.downtime     ?? 0);
    }else{
      // Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ø­Ø³Ø§Ø¨ Ù…Ø­Ù„ÙŠ Ù„Ùˆ ÙØ´Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ KPIs
      const recs = App.records || [];
      let overdue = 0, dueThisMonth = 0, outOfService=0, completed=0, critical=0, uncompleted=0, downtime=0;
      const now = new Date(); now.setHours(0,0,0,0);
      const cm = now.getMonth(), cy = now.getFullYear();

      recs.forEach(r=>{
        const st = String(r.Status || '').trim();
        if (st === 'Completed') completed++; else uncompleted++;
        if (st === 'OutOfService') outOfService++;
        if (st === 'Critical')     critical++;
        downtime += Number(r.DowntimeHours) || 0;

        if (r.DueDate){
          const d = new Date(r.DueDate); if (isNaN(d)) return;
          d.setHours(0,0,0,0);
          if (st !== 'Completed' && st !== 'OutOfService' && d < now) overdue++;
          if (st !== 'Completed' && d.getFullYear() === cy && d.getMonth() === cm) dueThisMonth++;
        }
      });

      const notServiced = calculateNotServicedDevices();

      animateValue($('#kpiNotServiced'), notServiced);
      animateValue($('#kpiOverdue'), overdue);
      animateValue($('#kpiDueThisMonth'), dueThisMonth);
      animateValue($('#kpiOutOfService'), outOfService);
      animateValue($('#kpiCompleted'), completed);
      animateValue($('#kpiCritical'), critical);
      animateValue($('#kpiUncompleted'), uncompleted);
      animateValue($('#kpiDowntime'), Math.round(downtime));
    }
    updateAlertsList();
  }

  function calculateNotServicedDevices(){
    try{
      const allDevices = new Set();
      const devicesWithRecord = new Set();

      Object.values(App.assetsMap).forEach(list=>{
        if (!Array.isArray(list)) return;
        list.forEach(a=>{
          const id = String(a.id || '').trim();
          if (id) allDevices.add(id);
        });
      });

      (App.records || []).forEach(r=>{
        const id = String(r.AssetID || '').trim();
        if (id) devicesWithRecord.add(id);
      });

      let notServiced = 0;
      allDevices.forEach(id=>{
        if (!devicesWithRecord.has(id)) notServiced++;
      });

      console.log('NotServiced (local):', {total:allDevices.size, withRecords:devicesWithRecord.size, notServiced});
      return notServiced;
    }catch(e){
      console.error('calculateNotServicedDevices error', e);
      return 0;
    }
  }

  function updateAlertsList(){
    const recs = App.records || [];
    const alerts = recs
      .filter(r=>{
        const st = classify(r);
        return ['Overdue','Critical','OutOfService','DueSoon'].includes(st);
      })
      .slice(0,8);

    const container = $('#alertsList');
    if (!alerts.length){
      container.innerHTML = '<div class="text-center smallmuted py-3"><i class="fa-solid fa-check-circle me-1"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>';
      return;
    }
    container.innerHTML = alerts.map(r=>{
      const st = classify(r);
      const icon = (st === 'DueSoon') ? 'ğŸŸ ' : 'ğŸ”´';
      const cls  = (st === 'DueSoon') ? 'due-soon' : 'critical';
      return `
        <div class="alert-item ${cls}">
          <div class="d-flex align-items-center">
            <span class="me-2">${icon}</span>
            <div class="flex-grow-1">
              <b>${r.AssetName || r.AssetID || '-'}</b> â€” ${r.Department || ''}
            </div>
          </div>
          <div class="small smallmuted mt-1">
            <i class="fa-solid fa-calendar me-1"></i>Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${fmt(r.DueDate)}
          </div>
        </div>
      `;
    }).join('');
  }

  /*************** Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ****************/
  function drawCharts(){
    try{
      const ctxD = $('#donutStatus')?.getContext('2d');
      const ctxB = $('#barDept')?.getContext('2d');
      const ctxL = $('#lineMonthly')?.getContext('2d');
      if (!ctxD || !ctxB || !ctxL) return;

      const recs = App.records || [];

      if (App.charts.donut) App.charts.donut.destroy();
      if (App.charts.bar)   App.charts.bar.destroy();
      if (App.charts.line)  App.charts.line.destroy();

      const statusCount = recs.reduce((acc,r)=>{
        const st = classify(r);
        acc[st] = (acc[st] || 0) + 1;
        return acc;
      },{});

      const deptStats = {};
      recs.forEach(r=>{
        const dept = r.Department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if (!deptStats[dept]) deptStats[dept] = {completed:0, overdue:0, pending:0};
        const st = classify(r);
        if (st === 'Completed') deptStats[dept].completed++;
        else if (['Overdue','Critical','OutOfService'].includes(st)) deptStats[dept].overdue++;
        else deptStats[dept].pending++;
      });

      const monthly = Array(12).fill(0);
      recs.forEach(r=>{
        if (r.Status === 'Completed' && r.CompletedDate){
          const m = new Date(r.CompletedDate).getMonth();
          if (!isNaN(m)) monthly[m]++;
        }
      });

      const monthLabels = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];

      App.charts.donut = new Chart(ctxD,{
        type:'doughnut',
        data:{
          labels:['Ù…ÙƒØªÙ…Ù„Ø©','Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±','Ù…ØªØ£Ø®Ø±Ø©/Ø­Ø±Ø¬Ø©','Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©'],
          datasets:[{
            data:[
              statusCount.Completed || 0,
              statusCount.Pending  || 0,
              (statusCount.Overdue || 0) + (statusCount.Critical || 0),
              statusCount.OutOfService || 0
            ],
            backgroundColor:['#10b981','#f59e0b','#ef4444','#9ca3af'],
            borderColor:['#047857','#92400e','#b91c1c','#6b7280'],
            borderWidth:2
          }]
        },
        options:{
          plugins:{
            legend:{
              position:'bottom',
              labels:{color:'#fff',font:{family:'Tajawal',size:12}}
            }
          },
          maintainAspectRatio:false
        }
      });

      const deptNames = Object.keys(deptStats);
      App.charts.bar = new Chart(ctxB,{
        type:'bar',
        data:{
          labels:deptNames,
          datasets:[
            {
              label:'Ù…ÙƒØªÙ…Ù„Ø©',
              data:deptNames.map(d=>deptStats[d].completed),
              backgroundColor:'rgba(34,197,94,.85)'
            },
            {
              label:'Ù…ØªØ£Ø®Ø±Ø©/Ø­Ø±Ø¬Ø©',
              data:deptNames.map(d=>deptStats[d].overdue),
              backgroundColor:'rgba(239,68,68,.9)'
            },
            {
              label:'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
              data:deptNames.map(d=>deptStats[d].pending),
              backgroundColor:'rgba(245,158,11,.9)'
            }
          ]
        },
        options:{
          plugins:{
            legend:{labels:{color:'#fff',font:{family:'Tajawal',size:12}}}
          },
          scales:{
            x:{ticks:{color:'#fff',font:{family:'Tajawal',size:11}}},
            y:{ticks:{color:'#fff',font:{family:'Tajawal',size:11}}}
          },
          maintainAspectRatio:false
        }
      });

      App.charts.line = new Chart(ctxL,{
        type:'line',
        data:{
          labels:monthLabels,
          datasets:[{
            label:'Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø© Ø´Ù‡Ø±ÙŠÙ‹Ø§',
            data:monthly,
            borderWidth:3,
            tension:.3,
            fill:true,
            backgroundColor:'rgba(212,175,55,.18)',
            borderColor:'#d4af37'
          }]
        },
        options:{
          plugins:{
            legend:{labels:{color:'#fff',font:{family:'Tajawal',size:12}}}
          },
          scales:{
            x:{ticks:{color:'#fff',font:{family:'Tajawal',size:11}}},
            y:{ticks:{color:'#fff',font:{family:'Tajawal',size:11}}}
          },
          maintainAspectRatio:false
        }
      });
    }catch(e){
      console.error('drawCharts error', e);
    }
  }

  /*************** Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ****************/
  function renderLog(){
    const f = App.filters;
    const filtered = (App.records || []).filter(r=>{
      if (f.dept && r.Department !== f.dept) return false;
      if (f.type && r.TaskType !== f.type)   return false;

      const cls = classify(r);
      if (f.status){
        if (f.status === 'Overdue'      && cls !== 'Overdue')      return false;
        if (f.status === 'Completed'    && cls !== 'Completed')    return false;
        if (f.status === 'Pending'      && cls !== 'Pending')      return false;
        if (f.status === 'Critical'     && cls !== 'Critical')     return false;
        if (f.status === 'OutOfService' && cls !== 'OutOfService') return false;
      }

      if (f.alertsOnly && !['Overdue','Critical','OutOfService','DueSoon'].includes(cls)) return false;

      if (f.search){
        const t = f.search;
        const text = `${r.Department||''} ${r.Staff||''} ${r.AssetName||''} ${r.AssetID||''} ${r.TaskType||''}`.toLowerCase();
        if (!text.includes(t)) return false;
      }
      return true;
    }).sort((a,b)=> new Date(b.Timestamp||0) - new Date(a.Timestamp||0));

    const tb = $('#logBody');
    if (!filtered.length){
      tb.innerHTML = '<tr><td colspan="13" class="text-center py-4 smallmuted"><i class="fa-solid fa-inbox me-1"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
      $('#viewCount').textContent  = '0';
      $('#totalCount').textContent = String(App.records.length || 0);
      return;
    }

    tb.innerHTML = filtered.map(r=>{
      const cls = classify(r);
      const badgeClass =
        cls === 'Completed'    ? 'completed' :
        cls === 'Overdue'      ? 'overdue'   :
        cls === 'Critical'     ? 'critical'  :
        cls === 'DueSoon'      ? 'due-soon'  :
        cls === 'OutOfService' ? 'critical'  :
        'pending';

      const files = [];
      if (r.File){
        String(r.File).split(',').forEach(u=>{
          u = u.trim();
          if (u && u !== 'undefined'){
            files.push(`<a href="${u}" target="_blank" class="btn btn-sm btn-outline-success me-1"><i class="fa-solid fa-paperclip ms-1"></i> Ù…Ù„Ù</a>`);
          }
        });
      }

      let certHtml = 'â€”';
      if (r.Certificate){
        certHtml = `<a class="btn btn-sm btn-outline-gold" target="_blank" href="${r.Certificate}"><i class="fa-solid fa-file-pdf"></i></a>`;
      }else if (r.Status === 'Completed'){
        certHtml = `<button class="btn btn-sm btn-outline-gold btn-gen-cert" data-id="${r.ID || r.id || ''}"><i class="fa-solid fa-file-circle-plus"></i></button>`;
      }

      const recordId = r.ID || r.id || '';
      const timestamp = r.Timestamp || r.timestamp || '';
      const assetName = r.AssetName || r.AssetID || 'Ø¬Ù‡Ø§Ø²';

      return `
        <tr>
          <td>${fmt(r.Timestamp)}</td>
          <td><b>${r.Department || '-'}</b></td>
          <td>${r.Staff || '-'}</td>
          <td title="${r.AssetID || ''}">${r.AssetName || r.AssetID || '-'}</td>
          <td><span class="badge bg-primary">${r.TaskType || '-'}</span></td>
          <td>${fmt(r.StartDate)}</td>
          <td>${fmt(r.DueDate)}</td>
          <td>${fmt(r.CompletedDate)}</td>
          <td><span class="badge-status ${badgeClass}">${r.Status || cls}</span></td>
          <td>${r.Priority || '-'}</td>
          <td>${files.join('') || 'â€”'}</td>
          <td>${certHtml}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger del-rec"
                    data-id="${recordId}"
                    data-timestamp="${timestamp}"
                    data-asset="${assetName}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        </tr>`;
    }).join('');

    $('#viewCount').textContent  = String(filtered.length);
    $('#totalCount').textContent = String(App.records.length || 0);
  }

  /*************** Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ****************/
  function calcNextDue(){
    const startDate = $('#fStart').value;
    const freq = $('#fFreq').value;
    if (!startDate || !freq){
      $('#fDue').value = '';
      return;
    }
    const start = new Date(startDate);
    const due = new Date(start);
    switch(freq){
      case 'W1': due.setDate(due.getDate()+7); break;
      case 'M1': due.setMonth(due.getMonth()+1); break;
      case 'M3': due.setMonth(due.getMonth()+3); break;
      case 'M6': due.setMonth(due.getMonth()+6); break;
      case 'M12': due.setMonth(due.getMonth()+12); break;
      case 'Y2': due.setFullYear(due.getFullYear()+2); break;
      default: $('#fDue').value = ''; return;
    }
    $('#fDue').value = due.toISOString().split('T')[0];
  }

  let selectedFiles = [];

  function resetFilesUI(){
    selectedFiles = [];
    $('#fFiles').value = '';
    $('#dzPreview').innerHTML = '';
    $('#dzInfo').textContent = '';
    $('#dzProgress').classList.add('d-none');
    $('#dzProgress .progress-bar').style.width = '0%';
  }

  function handleFiles(files){
    const list = Array.from(files || []);
    for (const f of list){
      if (selectedFiles.length >= CONFIG.MAX_FILES){
        toast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ù„ÙØ§Øª', 'error');
        break;
      }
      if (f.size > CONFIG.MAX_MB * 1024 * 1024){
        toast(`Ø§Ù„Ù…Ù„Ù ${f.name} ÙŠØªØ¬Ø§ÙˆØ² ${CONFIG.MAX_MB}MB`, 'error');
        continue;
      }
      selectedFiles.push(f);
    }

    const pv = $('#dzPreview');
    pv.innerHTML = '';
    selectedFiles.forEach((f,idx)=>{
      const wrap = document.createElement('div');
      wrap.className = 'thumb';
      const del = document.createElement('button');
      del.className = 'x';
      del.textContent = 'Ã—';
      del.addEventListener('click',e=>{
        e.stopPropagation();
        selectedFiles.splice(idx,1);
        handleFiles([]);
      });
      wrap.appendChild(del);

      if (f.type.startsWith('image/')){
        const img = document.createElement('img');
        const r = new FileReader();
        r.onload = e => img.src = e.target.result;
        r.readAsDataURL(f);
        wrap.appendChild(img);
      }else{
        const chip = document.createElement('div');
        chip.className = 'badge bg-dark';
        chip.textContent = f.name;
        wrap.appendChild(chip);
      }
      pv.appendChild(wrap);
    });

    $('#dzInfo').textContent = selectedFiles.length ? `Ù…Ù„ÙØ§Øª Ù…Ø®ØªØ§Ø±Ø©: ${selectedFiles.length}` : '';
  }

  let isSaving = false;

  async function submitNew(ev){
    ev.preventDefault();
    if (isSaving) return;
    isSaving = true;

    const submitBtn = $('#formNew button[type="submit"]');
    const oldLabel = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin ms-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

    try{
      if (!selectedFiles.length){
        toast('Ø±ÙØ¹ Ù…Ø±ÙÙ‚ Ø¥Ù„Ø²Ø§Ù…ÙŠ', 'error');
        return;
      }

      const dep   = $('#fDepartment').value;
      const staff = $('#fStaff').value;
      const type  = $('#fTaskType').value;
      const assetSel = $('#fAsset');
      const assetID  = assetSel.value;
      const assetName = assetSel.selectedOptions[0]?.textContent || assetID;
      const start = $('#fStart').value;

      if (!dep || !staff || !type || !assetID || !start){
        toast('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©', 'error');
        return;
      }

      const payload = {
        department: dep,
        staff: staff,
        taskType: type,
        assetID: assetID,
        assetName: assetName,
        startDate: start,
        dueDate: $('#fDue').value,
        completedDate: $('#fCompleted').value,
        status: $('#fStatus').value,
        priority: $('#fPriority').value,
        downtimeHours: $('#fDown').value || '0',
        notes: ''
      };

      const res = await API.addRecord(payload);
      const recordId = res.ID || '';
      const timestamp = res.Timestamp || '';

      const prog = $('#dzProgress');
      const bar  = prog.querySelector('.progress-bar');
      prog.classList.remove('d-none');

      const uploadErrors = [];
      for (let i=0;i<selectedFiles.length;i++){
        const f = selectedFiles[i];
        try{
          const base64 = await fileToBase64(f);
          await API.uploadFile({
            department: dep,
            fileName: f.name,
            mimeType: f.type || 'application/octet-stream',
            fileData: base64,
            recordId: recordId,
            timestamp: timestamp
          });
          bar.style.width = ((i+1)/selectedFiles.length*100).toFixed(0) + '%';
        }catch(e){
          console.error('upload error', e);
          uploadErrors.push(f.name);
        }
      }

      prog.classList.add('d-none');
      bar.style.width = '0%';

      if (uploadErrors.length){
        toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ù„ÙƒÙ† ÙØ´Ù„ Ø±ÙØ¹ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª: ' + uploadErrors.join(', '), 'warning');
      }else{
        toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
      }

      resetFilesUI();
      $('#formNew').reset();
      await loadAll();
    }catch(e){
      console.error('submitNew error', e);
      toast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©: ' + e.message, 'error');
    }finally{
      isSaving = false;
      submitBtn.disabled = false;
      submitBtn.innerHTML = oldLabel;
    }
  }

  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload  = e => resolve(e.target.result.split(',')[1]);
      r.onerror = () => reject(new Error('file read error'));
      r.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
