<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù„ÙˆØ­Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© â€” Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<style>
:root {
  --cr500: #d83b57; --cr600: #b91f3d; --cr700: #990a28; 
  --ink: #13090b; --paper: #271014;
  --success: #28a745; --warning: #ffc107; --danger: #dc3545;
}

* { font-family: 'Tajawal', sans-serif; box-sizing: border-box; }

body {
  background: linear-gradient(135deg, var(--ink), var(--paper)); 
  color: #fff4f6;
  min-height: 100vh;
}

.glass {
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.22);
  border-radius: 16px;
  box-shadow: 0 10px 28px rgba(0, 0, 0, 0.28);
  backdrop-filter: blur(10px);
}

.navbar {
  background: rgba(30, 0, 8, 0.94);
  border-bottom: 2px solid var(--cr600);
  backdrop-filter: blur(10px);
}

.brand-logo {
  width: 56px; height: 56px;
  border-radius: 50%;
  background: #fff;
  padding: 4px;
  object-fit: cover;
  box-shadow: 0 0 18px rgba(216, 59, 87, 0.35);
}

.btn-crimson {
  background: linear-gradient(135deg, var(--cr700), var(--cr500));
  color: #fff;
  border: none;
  transition: all 0.3s ease;
}

.btn-crimson:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(216, 59, 87, 0.4);
}

.card-kpi {
  padding: 18px;
  border-radius: 14px;
  border: 1px solid rgba(255, 255, 255, 0.22);
  transition: transform 0.3s ease;
}

.card-kpi:hover {
  transform: translateY(-5px);
}

.card-kpi .val {
  font-size: 32px;
  font-weight: 800;
  background: linear-gradient(135deg, #fff, #ffd3db);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.table {
  color: #fff;
  border-radius: 8px;
  overflow: hidden;
}

.table thead th {
  background: rgba(216, 59, 87, 0.2);
  color: #ffffff;
  border-bottom: 2px solid rgba(255, 255, 255, 0.45);
  font-weight: 700;
}

.table tbody tr {
  transition: background-color 0.3s ease;
}

.table tbody tr:hover {
  background: rgba(255, 255, 255, 0.1);
}

.toast-lite {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, var(--cr700), var(--cr500));
  color: #fff;
  padding: 12px 20px;
  border-radius: 10px;
  z-index: 9999;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.fade-in {
  animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <div class="d-flex align-items-center gap-2">
      <img class="brand-logo" src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹">
      <div>
        <div class="fw-bold fs-5 text-white">Ù„ÙˆØ­Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</div>
        <div class="small text-white-50">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ© ÙˆØ§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</div>
      </div>
    </div>
    
    <button class="navbar-toggler text-light" data-bs-toggle="collapse" data-bs-target="#nav">
      <i class="fa-solid fa-bars"></i>
    </button>
    
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto align-items-center gap-3">
        <li class="nav-item"><a class="nav-link text-light" href="#dash">Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="#table">Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</a></li>
        <li class="nav-item">
          <button id="btnRefresh" class="btn btn-outline-light btn-sm">
            <i class="fa-solid fa-rotate ms-1"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<section id="dash" class="container py-4">
  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <div class="glass p-4 mb-4 fade-in">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="m-0 fw-bold text-white">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
        <div class="text-muted mt-2">Ù…ØªØ²Ø§Ù…Ù† Ù…Ø¹ Google Sheets â€¢ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ â€¢ ØªÙ‚Ø§Ø±ÙŠØ± ÙÙˆØ±ÙŠØ©</div>
      </div>
      <div class="col-md-4 text-left">
        <div class="d-flex gap-2 justify-content-md-end">
          <button class="btn btn-crimson" data-bs-toggle="modal" data-bs-target="#modalNew">
            <i class="fa-solid fa-plus ms-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©
          </button>
          <button id="btnPrint" class="btn btn-outline-light">
            <i class="fa-solid fa-print ms-1"></i> Ø·Ø¨Ø§Ø¹Ø©
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="small text-muted">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©</div>
        <div id="kpiPM" class="val">â€”%</div>
        <div class="small text-muted">Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ã· Ø§Ù„Ù…Ø®Ø·Ø·Ø© (365 ÙŠÙˆÙ…)</div>
      </div>
    </div>
    
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="small text-muted">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</div>
        <div id="kpiOver" class="val text-warning">0</div>
        <div class="small text-muted">ØªØªØ·Ù„Ø¨ ØªØ¯Ø®Ù„Ø§Ù‹ ÙÙˆØ±ÙŠØ§Ù‹</div>
      </div>
    </div>
    
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="small text-muted">Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div>
        <div id="kpiMTTR" class="val">â€” Ø³Ø§Ø¹Ø©</div>
        <div class="small text-muted">Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ (365 ÙŠÙˆÙ…)</div>
      </div>
    </div>
    
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="small text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©</div>
        <div id="kpiAvail" class="val text-success">â€”%</div>
        <div class="small text-muted">ØªÙ‚Ø¯ÙŠØ± ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</div>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª -->
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="glass p-3 h-100">
        <h5 class="m-0 mb-3">Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
        <canvas id="deptChart" height="250"></canvas>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="glass p-3 h-100">
        <h5 class="m-0 mb-3">ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…</h5>
        <canvas id="statusChart" height="250"></canvas>
      </div>
    </div>
  </div>
</section>

<section id="table" class="container py-4">
  <div class="glass p-3">
    <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-3">
      <h5 class="m-0">Ø³Ø¬Ù„ Ù…Ù‡Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©</h5>
      
      <div class="d-flex flex-wrap gap-2">
        <select id="filterDept" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
        </select>
        
        <select id="filterType" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
          <option value="PM">ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©</option>
          <option value="CM">ØµÙŠØ§Ù†Ø© ØªØµØ­ÙŠØ­ÙŠØ©</option>
        </select>
        
        <select id="filterStatus" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="Completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
          <option value="Pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
          <option value="Overdue">Ù…ØªØ£Ø®Ø±Ø©</option>
        </select>
        
        <input id="searchBox" class="form-control form-control-sm bg-dark text-light border-secondary" 
               placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª..." style="width: 220px"/>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ø§Ù„ÙÙ†ÙŠ</th>
            <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„ØªÙ†ÙÙŠØ°</th>
            <th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
            <th>Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th>
            <th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="logBody">
          <tr>
            <td colspan="11" class="text-center py-4">
              <div class="loading-spinner me-2"></div>
              Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
    <div class="d-flex justify-content-between align-items-center mt-3 text-muted small">
      <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <span id="totalCount" class="fw-bold">0</span></div>
      <div>Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: <span id="viewCount" class="fw-bold">0</span></div>
    </div>
  </div>
</section>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
<div class="modal fade" id="modalNew" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content glass border-0">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-white">
          <i class="fa-solid fa-plus ms-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="formNew" class="row g-3">
          <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
          <div class="col-md-6">
            <label class="form-label text-white">Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="fDepartment" required class="form-select bg-dark text-light border-secondary">
              <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label class="form-label text-white">Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
            <select id="fStaff" required class="form-select bg-dark text-light border-secondary">
              <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
            </select>
          </div>

          <!-- Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ§Ù„Ø¬Ù‡Ø§Ø² -->
          <div class="col-md-4">
            <label class="form-label text-white">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <select id="fTaskType" required class="form-select bg-dark text-light border-secondary">
              <option value="PM">ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ© (PM)</option>
              <option value="CM">ØµÙŠØ§Ù†Ø© ØªØµØ­ÙŠØ­ÙŠØ© (CM)</option>
            </select>
          </div>
          
          <div class="col-md-8">
            <label class="form-label text-white">Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù…Ø¹Ø¯Ø©</label>
            <select id="fAsset" required class="form-select bg-dark text-light border-secondary">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹...</option>
            </select>
          </div>

          <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
          <div class="col-md-4">
            <label class="form-label text-white">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</label>
            <input id="fServiceDate" type="date" required 
                   class="form-control bg-dark text-light border-secondary"/>
          </div>
          
          <div class="col-md-4">
            <label class="form-label text-white">Ø§Ù„ØªÙƒØ±Ø§Ø±</label>
            <select id="fFreq" class="form-select bg-dark text-light border-secondary">
              <option value="">Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</option>
              <option value="W1">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
              <option value="M1">Ø´Ù‡Ø±ÙŠ</option>
              <option value="M3">ÙƒÙ„ 3 Ø£Ø´Ù‡Ø±</option>
              <option value="M6">ÙƒÙ„ 6 Ø£Ø´Ù‡Ø±</option>
              <option value="M12">Ø³Ù†ÙˆÙŠ</option>
              <option value="M24">ÙƒÙ„ Ø¹Ø§Ù…ÙŠÙ†</option>
            </select>
          </div>
          
          <div class="col-md-4">
            <label class="form-label text-white">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
            <input id="fNextDue" type="date" readonly
                   class="form-control bg-dark text-light border-secondary"/>
          </div>

          <!-- Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© -->
          <div class="col-md-6">
            <label class="form-label text-white">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <select id="fStatus" required class="form-select bg-dark text-light border-secondary">
              <option value="Pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="Completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
              <option value="Overdue">Ù…ØªØ£Ø®Ø±Ø©</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label class="form-label text-white">Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <select id="fPriority" class="form-select bg-dark text-light border-secondary">
              <option value="">Ø¹Ø§Ø¯ÙŠØ©</option>
              <option value="High">Ø¹Ø§Ù„ÙŠØ©</option>
              <option value="Medium">Ù…ØªÙˆØ³Ø·Ø©</option>
              <option value="Low">Ù…Ù†Ø®ÙØ¶Ø©</option>
            </select>
          </div>

          <!-- Ø§Ù„ØªÙˆÙ‚Ù ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
          <div class="col-md-6">
            <label class="form-label text-white">ÙˆÙ‚Øª Ø§Ù„ØªÙˆÙ‚Ù (Ø³Ø§Ø¹Ø§Øª)</label>
            <input id="fDown" type="number" step="0.1" min="0" 
                   class="form-control bg-dark text-light border-secondary" placeholder="0"/>
          </div>
          
          <div class="col-12">
            <label class="form-label text-white">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
            <textarea id="fNotes" rows="3" 
                      class="form-control bg-dark text-light border-secondary" 
                      placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©..."></textarea>
          </div>

          <!-- Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
          <div class="col-12">
            <label class="form-label text-white">Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="fFile" type="file" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.csv" 
                   class="form-control bg-dark text-light border-secondary"/>
            <div class="form-text text-muted">ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ Ù…Ù„ÙØ§Øª PDFØŒ Ø§Ù„ØµÙˆØ±ØŒ Ø£Ùˆ Excel - Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB</div>
          </div>

          <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
          <div class="col-12 pt-3 border-top border-secondary">
            <div class="d-flex justify-content-end gap-2">
              <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">
                Ø¥Ù„ØºØ§Ø¡
              </button>
              <button id="btnSave" type="submit" class="btn btn-crimson">
                <i class="fa-solid fa-floppy-disk ms-1"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<footer class="container py-4 mt-4 border-top border-secondary">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center text-muted small">
    <div>Â© 2025 Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</div>
    <div class="mt-2 mt-md-0">
      <i class="fa-solid fa-envelope me-1"></i>
      support@makkahclinic.com
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
const CONFIG = {
  API_URL: "https://script.google.com/macros/s/AKfycbz2QOwE8-LvR4thMXoJm9tZ-GycnksNsz9Rzwj0Jy2TWFpojSHJZ37QmvlmZEbK_jRrFQ/exec",
  AUTO_REFRESH_MS: 30000,
  MAX_FILE_MB: 10,
  WINDOW_DAYS: 365
};

// Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„ÙƒÙ„ Ù‚Ø³Ù…
const MAINTENANCE_POLICY = {
  "Ù‚Ø³Ù… Ø§Ù„Ø£Ø´Ø¹Ø©": { 
    default: "M6",
    devices: {
      "X-ray": "M6",
      "Ultrasound": "M12", 
      "CT Scan": "M3"
    }
  },
  "Ø§Ù„Ù…Ø®ØªØ¨Ø±": {
    default: "M3",
    devices: {
      "Analyzer": "M3",
      "Centrifuge": "M6"
    }
  }
};

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© =====
const AppState = {
  assetsMap: {},
  staffList: [],
  records: [],
  checksum: "",
  charts: { dept: null, status: null },
  filters: {
    department: "",
    type: "",
    status: "",
    search: ""
  }
};

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© =====
const $ = selector => document.querySelector(selector);
const $$ = selector => document.querySelectorAll(selector);

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast-lite ${type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning' : ''}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translate(-50%, -20px)';
    setTimeout(() => toast.remove(), 300);
  }, type === 'error' ? 5000 : 3000);
}

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù„Ù Ø¥Ù„Ù‰ Base64
 */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      const result = reader.result;
      const base64 = result.split(',')[1];
      resolve({
        base64: base64,
        fileName: file.name,
        mimeType: file.type
      });
    };
    reader.onerror = error => reject(error);
  });
}

function formatDate(dateString) {
  if (!dateString) return "";
  const date = new Date(dateString);
  return isNaN(date) ? dateString : date.toLocaleDateString('ar-SA');
}

function classifyStatus(record) {
  if (record.Status === 'Completed') return 'Completed';
  
  const dueDate = record.DueDate ? new Date(record.DueDate) : null;
  if (dueDate) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (dueDate < today) return 'Overdue';
  }
  
  return 'Pending';
}

function isInTimeWindow(dateString, days) {
  if (!dateString) return false;
  
  const date = new Date(dateString);
  if (isNaN(date)) return false;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const startDate = new Date(today);
  startDate.setDate(startDate.getDate() - days);
  
  return date >= startDate && date <= today;
}

// ===== Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ø¬Ù‡Ø© API =====
class ApiService {
  static async get(forceRefresh = false) {
    try {
      const url = CONFIG.API_URL + (forceRefresh ? `?refresh=${Date.now()}` : '');
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ù„Ø¨ Ø¨Ø³ÙŠØ· Ø¨Ø¯ÙˆÙ† ØªØ±ÙˆÙŠØ³Ø§Øª Ù…Ø®ØµØµØ© Ù„ØªØ¬Ù†Ø¨ CORS preflight
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.status === 'error') {
        throw new Error(data.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…');
      }
      
      return data.data || data;
    } catch (error) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      throw error;
    }
  }

  static async post(payload) {
    try {
      // Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ€ text/plain Ù„ØªØ¬Ù†Ø¨ CORS preflight
      const response = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.status !== 'success') {
        throw new Error(result.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }
      
      return result;
    } catch (error) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      throw error;
    }
  }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =====
class UIManager {
  static updateSelectors() {
    try {
      const departments = Object.keys(AppState.assetsMap).sort();
      
      // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      $('#filterDept').innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>' +
        departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
      
      $('#fDepartment').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>' +
        departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
      
      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†
      if (AppState.staffList.length > 0) {
        $('#fStaff').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙ†ÙŠ...</option>' +
          AppState.staffList.map(staff => `<option value="${staff}">${staff}</option>`).join('');
      }
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
      $('#fDepartment').addEventListener('change', function() {
        const department = this.value;
        const assets = AppState.assetsMap[department] || [];
        
        $('#fAsset').innerHTML = assets.length ? 
          '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø²...</option>' +
          assets.map(asset => `<option value="${asset.id}">${asset.name}</option>`).join('') :
          '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø©</option>';
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù‚Ø³Ù…
        UIManager.applyDepartmentPolicy(department);
      });
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…:', error);
      showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©', 'error');
    }
  }

  static applyDepartmentPolicy(department) {
    const policy = MAINTENANCE_POLICY[department];
    if (policy && policy.default) {
      $('#fFreq').value = policy.default;
      UIManager.calculateNextDueDate();
    }
  }

  static calculateNextDueDate() {
    try {
      const serviceDate = $('#fServiceDate').value;
      const frequency = $('#fFreq').value;
      
      if (!serviceDate || !frequency) {
        $('#fNextDue').value = '';
        return;
      }
      
      const nextDue = this.calculateDateFromFrequency(serviceDate, frequency);
      $('#fNextDue').value = nextDue;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚
      this.autoUpdateStatus();
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:', error);
    }
  }

  static calculateDateFromFrequency(startDate, frequency) {
    if (!startDate || !frequency) return '';
    
    const date = new Date(startDate);
    if (isNaN(date)) return '';
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆØ§Ø±ÙŠØ® Ø£Ø¯Ù‚
    switch (frequency) {
      case 'W1':
        date.setDate(date.getDate() + 7);
        break;
      case 'M1':
        date.setMonth(date.getMonth() + 1);
        break;
      case 'M3':
        date.setMonth(date.getMonth() + 3);
        break;
      case 'M6':
        date.setMonth(date.getMonth() + 6);
        break;
      case 'M8':
        date.setMonth(date.getMonth() + 8);
        break;
      case 'M12':
        date.setFullYear(date.getFullYear() + 1);
        break;
      case 'M24':
        date.setFullYear(date.getFullYear() + 2);
        break;
      default:
        return '';
    }
    
    return date.toISOString().split('T')[0];
  }

  static autoUpdateStatus() {
    const nextDue = $('#fNextDue').value;
    if (nextDue) {
      const dueDate = new Date(nextDue);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      $('#fStatus').value = dueDate < today ? 'Overdue' : 'Pending';
    }
  }

  static updateKPIs() {
    try {
      const records = AppState.records;
      
      // Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² PM
      const plannedPM = records.filter(r => 
        r.TaskType === 'PM' && 
        this.isInTimeWindow(r.DueDate, CONFIG.WINDOW_DAYS)
      );
      
      const completedPM = plannedPM.filter(r => 
        r.Status === 'Completed' && 
        (!r.CompletedDate || this.isInTimeWindow(r.CompletedDate, CONFIG.WINDOW_DAYS))
      );
      
      $('#kpiPM').textContent = plannedPM.length ? 
        `${((completedPM.length / plannedPM.length) * 100).toFixed(1)}%` : 'â€”%';
      
      // Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
      const overdueCount = records.filter(r => classifyStatus(r) === 'Overdue').length;
      $('#kpiOver').textContent = overdueCount;
      $('#kpiOver').className = overdueCount > 0 ? 'val text-warning' : 'val';
      
      // Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­
      const cmRecords = records.filter(r => 
        r.TaskType === 'CM' && 
        r.StartDate && 
        r.CompletedDate && 
        this.isInTimeWindow(r.CompletedDate, CONFIG.WINDOW_DAYS)
      );
      
      let mttr = null;
      if (cmRecords.length) {
        const repairTimes = cmRecords.map(r => 
          (new Date(r.CompletedDate) - new Date(r.StartDate)) / (60 * 60 * 1000)
        ).filter(time => time >= 0);
        
        if (repairTimes.length) {
          mttr = repairTimes.reduce((a, b) => a + b, 0) / repairTimes.length;
        }
      }
      
      $('#kpiMTTR').textContent = mttr != null ? `${mttr.toFixed(1)} Ø³Ø§Ø¹Ø©` : 'â€” Ø³Ø§Ø¹Ø©';
      
      // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©
      const totalDowntime = records.reduce((sum, r) => sum + (Number(r.DowntimeHours) || 0), 0);
      const dateRange = this.calculateDateRange(records);
      
      if (totalDowntime > 0 && dateRange > 0) {
        const availability = Math.max(0, 1 - (totalDowntime / (dateRange * 24))) * 100;
        $('#kpiAvail').textContent = `${availability.toFixed(1)}%`;
        $('#kpiAvail').className = availability >= 95 ? 'val text-success' : 
                                   availability >= 90 ? 'val text-warning' : 'val text-danger';
      } else {
        $('#kpiAvail').textContent = 'â€”%';
        $('#kpiAvail').className = 'val';
      }
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:', error);
    }
  }

  static isInTimeWindow(dateString, days) {
    return isInTimeWindow(dateString, days);
  }

  static calculateDateRange(records) {
    const dates = records
      .map(r => new Date(r.Timestamp))
      .filter(d => !isNaN(d))
      .sort((a, b) => a - b);
    
    if (dates.length < 2) return 1;
    
    const diffTime = Math.abs(dates[dates.length - 1] - dates[0]);
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
  }

  static renderTable() {
    try {
      const { department, type, status, search } = AppState.filters;
      let filteredRecords = AppState.records.slice();
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
      if (department) {
        filteredRecords = filteredRecords.filter(r => r.Department === department);
      }
      
      if (type) {
        filteredRecords = filteredRecords.filter(r => r.TaskType === type);
      }
      
      if (status) {
        filteredRecords = filteredRecords.filter(r => classifyStatus(r) === status);
      }
      
      if (search) {
        const searchTerm = search.toLowerCase();
        filteredRecords = filteredRecords.filter(r =>
          Object.values(r).some(value => 
            String(value).toLowerCase().includes(searchTerm)
          )
        );
      }
      
      // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
      filteredRecords.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
      
      const tbody = $('#logBody');
      
      if (filteredRecords.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="text-center py-4 text-muted">
              <i class="fa-solid fa-inbox me-2"></i>
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = filteredRecords.map(record => `
          <tr class="fade-in">
            <td>${formatDate(record.Timestamp)}</td>
            <td><strong>${record.Department || 'â€”'}</strong></td>
            <td>${record.Staff || 'â€”'}</td>
            <td title="${record.AssetID || ''}">${record.AssetName || record.AssetID || 'â€”'}</td>
            <td>
              <span class="badge ${record.TaskType === 'PM' ? 'bg-primary' : 'bg-warning'}">
                ${record.TaskType || 'â€”'}
              </span>
            </td>
            <td>${formatDate(record.StartDate) || 'â€”'}</td>
            <td>${formatDate(record.DueDate) || 'â€”'}</td>
            <td>${formatDate(record.CompletedDate) || 'â€”'}</td>
            <td>
              <span class="badge ${this.getStatusBadgeClass(record)}">
                ${record.Status || classifyStatus(record)}
              </span>
            </td>
            <td>
              ${record.Priority ? `
                <span class="badge ${this.getPriorityBadgeClass(record.Priority)}">
                  ${record.Priority}
                </span>
              ` : 'â€”'}
            </td>
            <td>
              ${record.Certificate ? `
                <a href="${record.Certificate}" target="_blank" class="text-danger">
                  <i class="fa-solid fa-file-pdf"></i>
                </a>
              ` : record.File ? `
                <a href="${record.File}" target="_blank" class="text-info">
                  <i class="fa-solid fa-paperclip"></i>
                </a>
              ` : 'â€”'}
            </td>
          </tr>
        `).join('');
      }
      
      $('#totalCount').textContent = AppState.records.length;
      $('#viewCount').textContent = filteredRecords.length;
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„:', error);
    }
  }

  static getStatusBadgeClass(record) {
    const status = classifyStatus(record);
    switch (status) {
      case 'Completed': return 'bg-success';
      case 'Overdue': return 'bg-danger';
      default: return 'bg-warning';
    }
  }

  static getPriorityBadgeClass(priority) {
    switch (priority) {
      case 'High': return 'bg-danger';
      case 'Medium': return 'bg-warning';
      case 'Low': return 'bg-info';
      default: return 'bg-secondary';
    }
  }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª =====
class ChartManager {
  static initializeCharts() {
    try {
      const deptCtx = $('#deptChart').getContext('2d');
      const statusCtx = $('#statusChart').getContext('2d');
      
      AppState.charts.dept = new Chart(deptCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Ù…ÙƒØªÙ…Ù„Ø©',
              data: [],
              backgroundColor: 'rgba(40, 167, 69, 0.8)',
              borderColor: 'rgba(40, 167, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'Ù…ØªØ£Ø®Ø±Ø©',
              data: [],
              backgroundColor: 'rgba(220, 53, 69, 0.8)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
              data: [],
              backgroundColor: 'rgba(255, 193, 7, 0.8)',
              borderColor: 'rgba(255, 193, 7, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#fff' }
            },
            title: {
              display: true,
              text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…',
              color: '#fff'
            }
          },
          scales: {
            x: {
              ticks: { color: '#fff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
              ticks: { color: '#fff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
      
      AppState.charts.status = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Ù…ÙƒØªÙ…Ù„Ø©', 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'Ù…ØªØ£Ø®Ø±Ø©'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: [
              'rgba(40, 167, 69, 0.8)',
              'rgba(255, 193, 7, 0.8)',
              'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
              'rgba(40, 167, 69, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#fff', font: { size: 12 } }
            }
          }
        }
      });
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª:', error);
    }
  }

  static updateCharts() {
    try {
      const records = AppState.records;
      const departmentStats = {};
      
      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
      records.forEach(record => {
        const department = record.Department || 'ØºÙŠØ± Ù…ØµÙ†Ù';
        const status = classifyStatus(record);
        
        if (!departmentStats[department]) {
          departmentStats[department] = { Completed: 0, Pending: 0, Overdue: 0 };
        }
        
        departmentStats[department][status]++;
      });
      
      const departments = Object.keys(departmentStats);
      const completedData = departments.map(dept => departmentStats[dept].Completed || 0);
      const overdueData = departments.map(dept => departmentStats[dept].Overdue || 0);
      const pendingData = departments.map(dept => departmentStats[dept].Pending || 0);
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø·Ø· Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      if (AppState.charts.dept) {
        AppState.charts.dept.data.labels = departments;
        AppState.charts.dept.data.datasets[0].data = completedData;
        AppState.charts.dept.data.datasets[1].data = overdueData;
        AppState.charts.dept.data.datasets[2].data = pendingData;
        AppState.charts.dept.update();
      }
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø·Ø· Ø§Ù„Ø­Ø§Ù„Ø§Øª
      if (AppState.charts.status) {
        const statusCounts = records.reduce((acc, record) => {
          const status = classifyStatus(record);
          acc[status] = (acc[status] || 0) + 1;
          return acc;
        }, {});
        
        AppState.charts.status.data.datasets[0].data = [
          statusCounts.Completed || 0,
          statusCounts.Pending || 0,
          statusCounts.Overdue || 0
        ];
        AppState.charts.status.update();
      }
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª:', error);
    }
  }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ =====
class FormManager {
  static init() {
    this.setupEventListeners();
    this.setupFormValidation();
  }

  static setupEventListeners() {
    // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„ØªÙƒØ±Ø§Ø±
    $('#fServiceDate').addEventListener('change', () => UIManager.calculateNextDueDate());
    $('#fFreq').addEventListener('change', () => UIManager.calculateNextDueDate());
    
    // Ù…Ø³ØªÙ…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²
    $('#fAsset').addEventListener('change', function() {
      const department = $('#fDepartment').value;
      const deviceName = this.selectedOptions[0]?.textContent || '';
      
      const policy = MAINTENANCE_POLICY[department];
      if (policy) {
        let frequencyCode = policy.default || '';
        if (policy.devices) {
          for (const [device, frequency] of Object.entries(policy.devices)) {
            if (deviceName.toLowerCase().includes(device.toLowerCase())) {
              frequencyCode = frequency;
              break;
            }
          }
        }
        if (frequencyCode) {
          $('#fFreq').value = frequencyCode;
          UIManager.calculateNextDueDate();
        }
      }
    });
  }

  static setupFormValidation() {
    $('#formNew').addEventListener('submit', this.handleFormSubmit.bind(this));
  }

  static async handleFormSubmit(event) {
    event.preventDefault();
    
    const submitBtn = $('#btnSave');
    const originalText = submitBtn.innerHTML;
    const fileInput = $('#fFile');
    
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© - ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø§Øª Ù‡Ù†Ø§
      const requiredFields = ['#fDepartment', '#fStaff', '#fTaskType', '#fAsset', '#fServiceDate'];
      const missingFields = requiredFields.filter(field => !$(field).value);
      
      if (missingFields.length > 0) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©', 'error');
        return;
      }
      
      // --- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ ---
      let fileData = {};
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù - ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ù…Ù„ÙØ§Øª Excel
        const allowedTypes = [
          'image/jpeg', 'image/png', 'image/jpg', 
          'application/pdf',
          'application/vnd.ms-excel',
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          'text/csv'
        ];
        
        if (!allowedTypes.includes(file.type)) {
          showToast('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ù…Ù„ÙØ§Øª PDFØŒ Ø§Ù„ØµÙˆØ±ØŒ Ø£Ùˆ Excel', 'error');
          return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
        const fileSizeMB = file.size / (1024 * 1024);
        if (fileSizeMB > CONFIG.MAX_FILE_MB) {
          showToast(`Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (${fileSizeMB.toFixed(1)}MB). Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ${CONFIG.MAX_FILE_MB}MB`, 'error');
          return;
        }
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Base64
        showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚...', 'info');
        fileData = await fileToBase64(file);
      }

      // --- ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ ---
      const formData = {
        department: $('#fDepartment').value,
        staff: $('#fStaff').value,
        taskType: $('#fTaskType').value,
        assetID: $('#fAsset').value,
        assetName: $('#fAsset').selectedOptions[0]?.textContent || $('#fAsset').value,
        startDate: $('#fServiceDate').value,
        dueDate: $('#fNextDue').value,
        completedDate: ($('#fTaskType').value === 'PM' || $('#fStatus').value === 'Completed') ? $('#fServiceDate').value : '',
        status: $('#fStatus').value,
        priority: $('#fPriority').value || 'Medium',
        downtimeHours: $('#fDown').value || '0',
        notes: $('#fNotes').value || ''
      };

      // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      submitBtn.innerHTML = '<div class="loading-spinner me-2"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      submitBtn.disabled = true;

      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
      const result = await ApiService.post({
        action: "createMaintenanceCertificate",
        data: formData,
        fileData: fileData
      });

      showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©');
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      event.target.reset();
      fileInput.value = ''; // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ù
      bootstrap.Modal.getInstance($('#modalNew')).hide();
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      await DataManager.loadData(true);
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
      showToast(`Ø®Ø·Ø£: ${error.message}`, 'error');
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
class DataManager {
  static async loadData(forceRefresh = false) {
    try {
      const data = await ApiService.get(forceRefresh);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const processedData = this.processData(data);
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      const newChecksum = this.generateChecksum(processedData);
      if (newChecksum === AppState.checksum && !forceRefresh) {
        return; // Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
      Object.assign(AppState, processedData);
      AppState.checksum = newChecksum;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      UIManager.updateSelectors();
      UIManager.updateKPIs();
      UIManager.renderTable();
      
      if (!AppState.charts.dept) {
        ChartManager.initializeCharts();
      }
      ChartManager.updateCharts();
      
      showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      
    } catch (error) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    }
  }

  static processData(rawData) {
    return {
      assetsMap: rawData.assetsMap || {},
      staffList: rawData.staffList || [],
      records: (rawData.records || []).map(record => ({
        Timestamp: record.Timestamp || record.timestamp || '',
        Department: record.Department || record.department || '',
        Staff: record.Staff || record.staff || '',
        AssetID: record.AssetID || record.assetID || '',
        AssetName: record.AssetName || record.assetName || record.Device || '',
        TaskType: (record.TaskType || record.taskType || '').toUpperCase(),
        StartDate: record.StartDate || record.startDate || '',
        DueDate: record.DueDate || record.nextDue || record.dueDate || '',
        CompletedDate: record.CompletedDate || record.completedDate || '',
        Status: record.Status || record.status || '',
        Priority: record.Priority || record.priority || '',
        DowntimeHours: record.DowntimeHours || record.downtimeHours || 0,
        Certificate: record.Certificate || record.CertificatePdf || record.certificate || '',
        File: record.File || record.file || ''
      }))
    };
  }

  static generateChecksum(data) {
    const str = JSON.stringify(data);
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash |= 0;
    }
    return hash + '_' + str.length;
  }
}

// ===== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© =====
document.addEventListener('DOMContentLoaded', function() {
  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  $('#fServiceDate').valueAsDate = new Date();
  
  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†
  FormManager.init();
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  DataManager.loadData(true);
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  setInterval(() => DataManager.loadData(), CONFIG.AUTO_REFRESH_MS);
  
  // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø©
  $('#btnRefresh').addEventListener('click', () => DataManager.loadData(true));
  $('#btnPrint').addEventListener('click', () => window.print());
  
  // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ±
  $('#filterDept').addEventListener('change', (e) => {
    AppState.filters.department = e.target.value;
    UIManager.renderTable();
  });
  
  $('#filterType').addEventListener('change', (e) => {
    AppState.filters.type = e.target.value;
    UIManager.renderTable();
  });
  
  $('#filterStatus').addEventListener('change', (e) => {
    AppState.filters.status = e.target.value;
    UIManager.renderTable();
  });
  
  $('#searchBox').addEventListener('input', (e) => {
    AppState.filters.search = e.target.value;
    UIManager.renderTable();
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ ØªØ±ÙƒÙŠØ² Ø§Ù„Ù†Ø§ÙØ°Ø©
  window.addEventListener('focus', () => DataManager.loadData(true));
});

console.log('ğŸš€ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ© - Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„');
</script>
</body>
</html>
