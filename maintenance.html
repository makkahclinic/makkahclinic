<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ© â€“ Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</title>

<!-- Ø®Ø·ÙˆØ· -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;800;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Bootstrap RTL + Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª + Chart.js -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

<style>
:root{
  --crimson:#7d0024;   /* Ù‚Ø±Ù…Ø²ÙŠ */
  --crimson-2:#5b001a;
  --gold:#d4af37;      /* Ø°Ù‡Ø¨ÙŠ */
  --ink:#14070b;
  --bg:#1a0b10;
  --muted:rgba(255,255,255,.7);
  --light-bg: rgba(255, 255, 255, 0.1);
  --border-light: rgba(255, 255, 255, 0.2);
}

body{
  font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background: radial-gradient(circle at 20% 10%, rgba(212,175,55,.08) 1px, transparent 1px) ,
              radial-gradient(circle at 80% 60%, rgba(212,175,55,.06) 1px, transparent 1px) ,
              linear-gradient(135deg, #2a0b14, #18060a 55%, #110306);
  background-size:12px 12px, 14px 14px, auto;
  color:#fff;
  min-height: 100vh;
}

h1,h2,h3,h4,h5{font-family:'Cairo',Tajawal,Arial;letter-spacing:.2px}

.navbar{
  background:linear-gradient(180deg, var(--crimson), var(--crimson-2));
  border-bottom:2px solid var(--gold);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.brand{
  display:flex;align-items:center;gap:.75rem;color:#fff;text-decoration:none
}

.brand img{width:48px;height:48px;border-radius:50%;background:#fff;object-fit:cover;
  box-shadow:0 0 0 3px rgba(212,175,55,.25),0 8px 24px rgba(0,0,0,.4)}
.brand span{font-family:'Cairo';font-weight:800}

.tabbar{
  background:rgba(255,255,255,.08);border-bottom:1px solid rgba(255,255,255,.15);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.tabbar .nav-link{
  color:rgba(255,255,255,0.8);border:none;border-bottom:3px solid transparent;border-radius:0;font-weight:700;
  padding: 12px 20px;
  transition: all 0.3s ease;
}

.tabbar .nav-link:hover {
  color: #fff;
  background: rgba(255,255,255,0.05);
}

.tabbar .nav-link.active{
  border-color:var(--gold);color:#fff;
  background: rgba(212, 175, 55, 0.1);
}

.card-glass{
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius:16px; 
  box-shadow:0 12px 30px rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
}

.kpi{
  padding:18px;border-radius:16px;position:relative;overflow:hidden;
  transition: transform 0.3s ease;
}

.kpi:hover {
  transform: translateY(-5px);
}

.kpi:before{
  content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(212,175,55,.08),transparent);
}

.kpi .label{color:var(--muted);font-size:.9rem}
.kpi .value{font-family:'Cairo';font-size:38px;font-weight:900;line-height:1.1}
.kpi .hint{color:var(--muted);font-size:.85rem}

.kpi.gold .value{color: #d4af37;}
.kpi.green .value{color:#71ff9d}
.kpi.red   .value{color:#ff8a8a}
.kpi.orange .value{color:#ffd08a}
.kpi.blue .value{color:#9dd7ff}
.kpi.purple .value{color:#d8aaff}

.badge-status{
  padding:.45rem .7rem;border-radius:999px;font-weight:700;border:2px solid rgba(255,255,255,.15);
  color: #fff;
}
.badge-status.completed{background:rgba(25,135,84,.6); border-color: rgba(25,135,84,.8);}
.badge-status.pending{background:rgba(255,193,7,.6); border-color: rgba(255,193,7,.8); color: #000;}
.badge-status.overdue{background:rgba(220,53,69,.7);border-color:rgba(220,53,69,.9); box-shadow:0 0 0 .35rem rgba(220,53,69,.06)}
.badge-status.critical{background:linear-gradient(135deg,#8b0000,#b30000);border-color:#ffb3b3}
.badge-status.due{background:linear-gradient(135deg,#c58a00,#e0a800); border-color: #e0a800;}

.table thead th{background:rgba(255,255,255,.1);border-bottom:2px solid rgba(255,255,255,.2); color: #fff;}
.table{color:#fff}
.table tbody tr:hover{background:rgba(255,255,255,.08);}

/* ØªØ­Ø³ÙŠÙ† Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ */
.form-control, .form-select {
  background: rgba(0,0,0,.5) !important;
  color: #ffd08a !important;
  border: 1px solid rgba(255,255,255,.3) !important;
  font-weight: 500;
}

.form-control:focus, .form-select:focus {
  background: rgba(0,0,0,.7) !important;
  color: #ffd08a !important;
  border-color: var(--gold) !important;
  box-shadow: 0 0 0 .2rem rgba(212,175,55,.25) !important;
}

/* ØªØ­Ø³ÙŠÙ† Ø®Ø§Øµ Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… */
input[type="date"], input[type="number"] {
  color: #9dd7ff !important;
  font-weight: 600;
}

input[type="date"]:focus, input[type="number"]:focus {
  color: #71ff9d !important;
}

/* ØªØ­Ø³ÙŠÙ† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… */
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1) brightness(2);
  cursor: pointer;
  padding: 4px;
}

input[type="date"]::-webkit-datetime-edit {
  color: #9dd7ff !important;
}

input[type="date"]::-webkit-datetime-edit-fields-wrapper {
  color: #9dd7ff !important;
}

input[type="date"]::-webkit-datetime-edit-text {
  color: #ffd08a !important;
}

.btn-gold{
  background:linear-gradient(135deg,var(--gold),#f5d86c);
  color:#331a00;border:none;font-weight:800
}

.btn-crimson{background:var(--crimson);color:#fff;border:none}
.btn-outline-gold{border:2px solid var(--gold);color:#fff}
.smallmuted{color:var(--muted)}

.dropzone{
  border:2px dashed rgba(212,175,55,.45);border-radius:14px;padding:22px;text-align:center;
  background:rgba(212,175,55,.05)
}

.dropzone.drag{background:rgba(212,175,55,.12)}
.preview img{max-height:90px;margin:6px;border-radius:8px;border:1px solid rgba(255,255,255,.2)}

.toast-lite{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;
  background:linear-gradient(135deg,var(--crimson),#3a0010);color:#fff;padding:10px 16px;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.45);font-weight:700
}

footer{border-top:1px solid rgba(255,255,255,.15)}

.thumb{display:inline-block; position:relative; margin:6px}
.thumb .x{position:absolute; top:-8px; left:-8px; width:22px; height:22px; border-radius:50%;
  background:#b00020; color:#fff; border:0; font-weight:900; line-height:20px; cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.35)}
  
.chart-container {
  position: relative;
  height: 220px;
  width: 100%;
}

.alert-item {
  padding: 10px 12px;
  margin-bottom: 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  border-left: 4px solid;
}

.alert-item.critical {
  border-left-color: #ff6b6b;
  background: rgba(255,107,107,0.1);
}

.alert-item.overdue {
  border-left-color: #ffa500;
  background: rgba(255,165,0,0.1);
}

.alert-item.due-soon {
  border-left-color: #ffd700;
  background: rgba(255,215,0,0.1);
}

.loading-spinner {
  display: inline-block;
  width: 2rem;
  height: 2rem;
  border: 0.25em solid currentColor;
  border-right-color: transparent;
  border-radius: 50%;
  animation: spinner-border 0.75s linear infinite;
}

@keyframes spinner-border {
  to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .kpi .value {
    font-size: 28px;
  }
  
  .brand span {
    font-size: 0.9rem;
  }
  
  .tabbar .nav-link {
    padding: 8px 12px;
    font-size: 0.9rem;
  }
}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="brand" href="#">
      <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo.png" alt="Ø´Ø¹Ø§Ø±">
      <span>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</span>
    </a>
    <div class="ms-auto d-flex gap-2">
      <button id="btnExportXLSX" class="btn btn-outline-gold btn-sm"><i class="fa-solid fa-file-excel ms-1"></i> ØªØµØ¯ÙŠØ± Excel</button>
      <button id="btnExportPDF" class="btn btn-outline-gold btn-sm"><i class="fa-solid fa-file-pdf ms-1"></i> ØªØµØ¯ÙŠØ± PDF</button>
      <button id="btnRefreshAll" class="btn btn-gold btn-sm"><i class="fa-solid fa-rotate ms-1"></i> ØªØ­Ø¯ÙŠØ«</button>
      <button id="btnRepairSheets" class="btn btn-outline-warning btn-sm"><i class="fa-solid fa-tools ms-1"></i> Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
    </div>
  </div>
</nav>

<section class="tabbar">
  <div class="container">
    <ul class="nav nav-tabs" id="tabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button"><i class="fa-solid fa-gauge-high me-1"></i> Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-log" type="button"><i class="fa-solid fa-list me-1"></i> Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-add" type="button"><i class="fa-solid fa-plus me-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button></li>
    </ul>
  </div>
</section>

<div class="tab-content">
  <!-- Dashboard -->
  <div id="tab-dashboard" class="tab-pane fade show active">
    <div class="container py-4">
      <div class="row g-3">
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi purple h-100">
            <div class="label">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ Ù„Ù… ØªØªÙ… ØµÙŠØ§Ù†ØªÙ‡Ø§</div>
            <div id="kpiNotServiced" class="value">â€”</div>
            <div class="hint">ØªØªØ·Ù„Ø¨ ØµÙŠØ§Ù†Ø© ÙÙˆØ±ÙŠØ©</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi red h-100">
            <div class="label">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
            <div id="kpiOverdue" class="value">0</div>
            <div class="hint">ØªØ¬Ø§ÙˆØ²Øª Ù…ÙˆØ¹Ø¯ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi blue h-100">
            <div class="label">Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
            <div id="kpiDueThisMonth" class="value">0</div>
            <div class="hint">ÙŠØ¬Ø¨ ØµÙŠØ§Ù†ØªÙ‡Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi orange h-100">
            <div class="label">Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</div>
            <div id="kpiOutOfService" class="value">0</div>
            <div class="hint">ØºÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi green h-100">
            <div class="label">Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            <div id="kpiCompleted" class="value">0</div>
            <div class="hint">ØªÙ…Øª ØµÙŠØ§Ù†ØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi red h-100">
            <div class="label">Ø§Ù„Ø­Ø±Ø¬Ø©</div>
            <div id="kpiCritical" class="value">0</div>
            <div class="hint">ØªØªØ·Ù„Ø¨ ØªØ¯Ø®Ù„Ù‹Ø§ Ø¹Ø§Ø¬Ù„Ù‹Ø§</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi orange h-100">
            <div class="label">ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            <div id="kpiUncompleted" class="value">0</div>
            <div class="hint">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±/Ù…ØªØ£Ø®Ø±Ø©</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi blue h-100">
            <div class="label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù</div>
            <div id="kpiDowntime" class="value">0</div>
            <div class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù</div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-lg-6">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ù…Ù†Ø¬Ø²)</h5>
            <div class="chart-container">
              <canvas id="lineMonthly"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</h5>
            <div class="chart-container">
              <canvas id="donutStatus"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</h5>
            <div id="alertsList" class="m-0 small">
              <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            <div class="smallmuted mt-2">ğŸŸ  Ø®Ù„Ø§Ù„ 10 Ø£ÙŠØ§Ù… â€¢ ğŸ”´ Ù…ØªØ¬Ø§ÙˆØ²Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯</div>
          </div>
        </div>
      </div>

      <div class="card-glass p-3 mt-3">
        <h5 class="mb-3">Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
        <div class="chart-container" style="height: 240px;">
          <canvas id="barDept"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div id="tab-log" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-3 mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="filterDept" class="form-select">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="filterType" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="PM">ÙˆÙ‚Ø§Ø¦ÙŠØ© (PM)</option>
              <option value="CM">ØªØµØ­ÙŠØ­ÙŠØ© (CM)</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="filterStatus" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
              <option value="Pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="Overdue">Ù…ØªØ£Ø®Ø±Ø©</option>
              <option value="Critical">Ø­Ø±Ø¬Ø©</option>
              <option value="OutOfService">Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ø¨Ø­Ø«</label>
            <input id="searchBox" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ÙÙ†ÙŠØŒ Ø§Ù„Ù‚Ø³Ù…ØŒ ...">
          </div>
          <div class="col-md-2 d-grid">
            <button id="btnShowAlertsOnly" class="btn btn-crimson"><i class="fa-solid fa-triangle-exclamation ms-1"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
          </div>
        </div>
      </div>

      <div class="card-glass p-3">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„ÙÙ†ÙŠ</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th><th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th><th>Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr><td colspan="13" class="text-center py-4"><div class="loading-spinner text-light"></div><div class="smallmuted mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between mt-2 smallmuted">
          <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="totalCount">0</b></div>
          <div>Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: <b id="viewCount">0</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task -->
  <div id="tab-add" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-3">
        <h5 class="mb-3">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ØµÙŠØ§Ù†Ø©</h5>
        <form id="formNew" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="fDepartment" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„ÙÙ†ÙŠ</label>
            <select id="fStaff" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <select id="fTaskType" class="form-select" required>
              <option value="PM">ÙˆÙ‚Ø§Ø¦ÙŠØ© (PM)</option>
              <option value="CM">ØªØµØ­ÙŠØ­ÙŠØ© (CM)</option>
            </select>
          </div>

          <div class="col-md-8">
            <label class="form-label">Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
            <select id="fAsset" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ù‹Ø§ â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
            <select id="fPriority" class="form-select">
              <option value="High">Ø¹Ø§Ù„ÙŠØ©</option>
              <option value="Medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
              <option value="Low">Ù…Ù†Ø®ÙØ¶Ø©</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</label>
            <input id="fStart" type="date" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
            <select id="fFreq" class="form-select">
              <option value="">Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</option>
              <option value="W1">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
              <option value="M1">Ø´Ù‡Ø±ÙŠ</option>
              <option value="M3">ÙƒÙ„ 3 Ø£Ø´Ù‡Ø±</option>
              <option value="M6">ÙƒÙ„ 6 Ø£Ø´Ù‡Ø±</option>
              <option value="M12">Ø³Ù†ÙˆÙŠ</option>
              <option value="Y2">ÙƒÙ„ Ø³Ù†ØªÙŠÙ†</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
            <input id="fDue" type="date" class="form-control" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="fStatus" class="form-select" required>
              <option value="Pending" selected>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="Completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
              <option value="Overdue">Ù…ØªØ£Ø®Ø±Ø©</option>
              <option value="Critical">Ø­Ø±Ø¬Ø©</option>
              <option value="OutOfService">Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù</label>
            <input id="fDown" type="number" min="0" step="0.1" class="form-control" value="0">
          </div>
          <div class="col-md-4">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø¥Ù† ÙˆÙØ¬Ø¯)</label>
            <input id="fCompleted" type="date" class="form-control">
          </div>

          <div class="col-12">
            <label class="form-label">Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
            <div id="dropzone" class="dropzone">
              <i class="fa-solid fa-cloud-arrow-up fa-2x mb-2"></i>
              <div class="smallmuted">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± â€” Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ù„ÙØ§Øª</div>
              <input id="fFiles" type="file" class="d-none" accept="image/*,.pdf,.doc,.docx,.xlsx,.xls" multiple>
              <div id="dzPreview" class="preview mt-2"></div>
              <div id="dzInfo" class="small mt-1"></div>
              <div class="progress d-none" id="dzProgress"><div class="progress-bar bg-warning" style="width:0%"></div></div>
            </div>
          </div>

          <div class="col-12 d-flex gap-2 justify-content-end">
            <button type="button" id="btnReset" class="btn btn-outline-gold"><i class="fa-solid fa-rotate-left ms-1"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button type="submit" class="btn btn-gold"><i class="fa-solid fa-floppy-disk ms-1"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<footer class="container py-4">
  <div class="d-flex flex-column flex-md-row align-items-center justify-content-between smallmuted">
    <div>Â© 2025 Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</div>
    <div><i class="fa-solid fa-envelope ms-1"></i> support@makkahclinic.com</div>
  </div>
</footer>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* =================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ =================== */
const API_URL = 'https://script.google.com/macros/s/AKfycbxw6oWSHKDjeZI6dsspS3PVVwbO9KO5UnjKGqDa_yP9cYAVjNHh6WMfQrdlpkF_A25--A/exec';
const CONFIG = { MAX_FILES:5, MAX_MB:10, AUTO_REFRESH_MS: 5*60*1000 };

const App = { 
  records:[], 
  assetsMap:{}, 
  staff:[], 
  charts:{donut:null,bar:null,line:null}, 
  filters:{dept:"",type:"",status:"",search:"",alertsOnly:false} 
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function toast(msg, type="info"){ 
  const t = document.createElement('div'); 
  t.className = 'toast-lite'; 
  t.style.background = type === "error" ? "linear-gradient(135deg,#a30000,#d00000)" : 
                        type === "success" ? "linear-gradient(135deg,#147a3c,#28a745)" : 
                        "linear-gradient(135deg,var(--crimson),#3a0010)"; 
  t.textContent = msg; 
  document.body.appendChild(t); 
  setTimeout(() => t.remove(), 3500); 
}

function fmt(d){ 
  if(!d) return ""; 
  const x = new Date(d); 
  return isNaN(x) ? String(d) : x.toLocaleDateString('ar-SA'); 
}

function addDays(d, n){ 
  const x = new Date(d); 
  x.setDate(x.getDate() + n); 
  return x; 
}

function classify(r){ 
  if(r.Status === "Completed") return "Completed"; 
  if(r.Status === "OutOfService") return "OutOfService"; 
  if(r.Status === "Critical") return "Critical"; 
  
  const due = r.DueDate ? new Date(r.DueDate) : null; 
  if(due){ 
    const today = new Date(); 
    today.setHours(0,0,0,0);
    due.setHours(0,0,0,0);
    
    if(due < today) return "Overdue"; 
    if(due <= addDays(today, 10)) return "DueSoon"; 
  } 
  return r.Status || "Pending"; 
}

function animateValue(el, to, suffix=""){ 
  const start = 0, dur = 900, t0 = performance.now(); 
  function step(now){
    const p = Math.min(1, (now - t0) / dur); 
    el.textContent = Math.round(start + (to - start) * p) + suffix; 
    if(p < 1) requestAnimationFrame(step);
  } 
  requestAnimationFrame(step); 
}

/* =================== Ø·Ø¨Ù‚Ø© API =================== */
const API = {
  async _parseResponse(r){
    try {
      const raw = await r.text();
      let json;

      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${raw.slice(0,200)}`);
      }
      
      try {
        json = JSON.parse(raw);
      } catch(e) {
        throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± JSON Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: ' + raw.slice(0,200));
      }
      
      if (json?.success === false || json?.error) {
        throw new Error(json.error || 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
      }
      return json.data ?? json;
    } catch (error) {
      console.error('Parse response error:', error);
      throw error;
    }
  },

  async _get(action, params = {}){
    try {
      const url = new URL(API_URL);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v]) => {
        if (v !== undefined && v !== null) url.searchParams.set(k, v);
      });

      const r = await fetch(url.toString(), { method: 'GET' });
      return this._parseResponse(r);
    } catch (error) {
      console.error('GET request error:', error);
      throw error;
    }
  },

  async _post(action, params = {}){
    try {
      const payload = { action, ...params };

      const r = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      return this._parseResponse(r);
    } catch (error) {
      console.error('POST request error:', error);
      throw error;
    }
  },

  // API methods
  getRecords(){ return this._get('getRecords'); },
  getAssets(){  return this._get('getAssets');  },
  getStaff(){   return this._get('getStaff');   },
  getKPIs(){    return this._get('getKPIs');    },

  addRecord(payload){           return this._post('addRecord', payload); },
  deleteRecord(payload){        return this._post('deleteRecord', payload); },
  updateRecord(payload){        return this._post('updateRecord', payload); },
  uploadFile(payload){          return this._post('uploadFile', payload); },
  generateCertificate(payload){ return this._post('generateCertificate', payload); },

  exportData(format){ return this._get('export', { format }); },
  repairSheets(){     return this._get('repair'); },
  healthCheck(){      return this._get('health'); }
};

/* =================== ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ ÙˆØ±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« =================== */
document.addEventListener('DOMContentLoaded', async () => {
  try{
    $('#fStart').value = new Date().toISOString().split('T')[0];
    bindEvents();
    await loadAll();
    setInterval(loadAll, CONFIG.AUTO_REFRESH_MS);
  } catch(e){ 
    console.error('INIT error:', e); 
    toast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ' + e.message, 'error'); 
  }
});

function bindEvents(){
  // Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø«
  $('#filterDept').addEventListener('change', e => { App.filters.dept = e.target.value; renderLog(); });
  $('#filterType').addEventListener('change', e => { App.filters.type = e.target.value; renderLog(); });
  $('#filterStatus').addEventListener('change', e => { App.filters.status = e.target.value; renderLog(); });
  $('#searchBox').addEventListener('input', e => { App.filters.search = e.target.value.toLowerCase(); renderLog(); });
  $('#btnShowAlertsOnly').addEventListener('click', () => { App.filters.alertsOnly = !App.filters.alertsOnly; renderLog(); });

  // Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚
  $('#fFreq').addEventListener('change', calcNextDue);
  $('#fStart').addEventListener('change', calcNextDue);

  // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù…
  $('#fDepartment').addEventListener('change', () => {
    const dep = $('#fDepartment').value;
    const arr = App.assetsMap[dep] || [];
    $('#fAsset').innerHTML = arr.length
      ? '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² â€”</option>' + arr.map(a => `<option value="${a.id}">${a.name}</option>`).join('')
      : '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø©</option>';
  });

  // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
  const dz = $('#dropzone'), fi = $('#fFiles');
  dz.addEventListener('click', () => fi.click());
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
  dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
  fi.addEventListener('change', () => handleFiles(fi.files));

  // Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  $('#formNew').addEventListener('submit', submitNew);
  $('#btnReset').addEventListener('click', () => { $('#formNew').reset(); resetFilesUI(); });

  // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰
  $('#btnExportXLSX').addEventListener('click', async () => {
    try{ 
      const r = await API.exportData('xlsx'); 
      if(r.url && r.url !== 'about:blank') {
        window.open(r.url, '_blank');
      } else {
        toast('Ù…ÙŠØ²Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
      }
    } catch(e){ 
      console.error('Export XLSX error:', e); 
      toast('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Excel: ' + e.message, 'error'); 
    }
  });

  $('#btnExportPDF').addEventListener('click', async () => {
    try{ 
      const r = await API.exportData('pdf'); 
      if(r.url && r.url !== 'about:blank') {
        window.open(r.url, '_blank');
      } else {
        toast('Ù…ÙŠØ²Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
      }
    } catch(e){ 
      console.error('Export PDF error:', e); 
      toast('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + e.message, 'error'); 
    }
  });

  $('#btnRefreshAll').addEventListener('click', loadAll);
  
  $('#btnRepairSheets').addEventListener('click', async () => {
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŸ Ù‡Ø°Ø§ Ø³ÙŠØµÙ„Ø­ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.')){
      try{ 
        await API.repairSheets(); 
        toast('ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„', 'success'); 
        await loadAll(); 
      } catch(e){ 
        toast('ÙØ´Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ' + e.message, 'error'); 
      }
    }
  });

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… event delegation Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
  document.addEventListener('click', async function(e) {
    // Ø²Ø± Ø§Ù„Ø­Ø°Ù
    if (e.target.closest('.del-rec')) {
      e.preventDefault();
      const btn = e.target.closest('.del-rec');
      await handleDelete(btn);
      return;
    }
    
    // Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
    if (e.target.closest('.btn-gen-cert')) {
      e.preventDefault();
      const btn = e.target.closest('.btn-gen-cert');
      await handleGenerateCert(btn);
      return;
    }
  });
}

/* =================== Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« =================== */
async function handleDelete(btn) {
  const recordId = btn.dataset.id;
  const timestamp = btn.dataset.timestamp;
  const assetName = btn.dataset.asset;
  
  console.log('Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù:', { recordId, timestamp, assetName });
  
  if (!recordId && !timestamp) {
    console.error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø°Ù Ù†Ø§Ù‚ØµØ©');
    toast('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„ Ù„Ù„Ø­Ø°Ù', 'error');
    return;
  }
  
  const confirmMsg = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„Ø¬Ù‡Ø§Ø²: ${assetName}ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`;
  
  if (!confirm(confirmMsg)) {
    console.log('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
    return;
  }
  
  try {
    btn.disabled = true;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø­Ø°Ù...';
    
    console.log('Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø°Ù Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…:', { id: recordId, timestamp: timestamp });
    
    await API.deleteRecord({
      id: recordId,
      timestamp: timestamp
    });
    
    toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    await loadAll();
    
  } catch (error) {
    console.error('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù:', error);
    
    let errorMsg = 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„';
    if (error.message.includes('404')) {
      errorMsg = 'Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
    } else if (error.message.includes('403')) {
      errorMsg = 'ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø­Ø°Ù - ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø±ÙÙˆØ¶Ø©';
    } else if (error.message.includes('500')) {
      errorMsg = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… - Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹';
    } else {
      errorMsg = `ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ${error.message}`;
    }
    
    toast(errorMsg, 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-trash"></i>';
  }
}

async function handleGenerateCert(btn) {
  const id = btn.dataset.id;
  if (!id) {
    toast('Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„', 'error');
    return;
  }

  try {
    btn.disabled = true;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

    await API.generateCertificate({ id });
    toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    await loadAll();
  } catch (e) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', e);
    toast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ' + e.message, 'error');
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}

/* =================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =================== */
async function loadAll(){
  console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
  try {
    const [recordsRes, assetsRes, staffRes, kpisRes] = await Promise.allSettled([
      API.getRecords(), 
      API.getAssets(), 
      API.getStaff(), 
      API.getKPIs()
    ]);

    App.records = recordsRes.status === 'fulfilled' ? (recordsRes.value || []) : [];
    App.assetsMap = assetsRes.status === 'fulfilled' ? (assetsRes.value || {}) : {};
    App.staff = staffRes.status === 'fulfilled' ? (staffRes.value || []) : [];
    const kpis = kpisRes.status === 'fulfilled' ? (kpisRes.value || null) : null;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    const depts = Object.keys(App.assetsMap).sort();
    $('#filterDept').innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>' + depts.map(d => `<option>${d}</option>`).join('');
    $('#fDepartment').innerHTML = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>' + depts.map(d => `<option>${d}</option>`).join('');
    $('#fStaff').innerHTML = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>' + (App.staff || []).map(s => `<option>${s}</option>`).join('');
    
    updateKPIs(kpis); 
    drawCharts(); 
    renderLog(); 
    
    const failedRequests = [recordsRes, assetsRes, staffRes, kpisRes].filter(r => r.status === 'rejected').length;
    if (failedRequests > 0) {
      toast('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ø²Ø¦ÙŠÙ‹Ø§. Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.', 'warning');
    } else {
      toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success');
    }
  } catch (e) {
    console.error('LoadAll error:', e);
    toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + e.message, 'error');
  }
}

/* =================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…ØµØ­Ø­ =================== */
function updateKPIs(kpisData){
  const recs = App.records;
  
  console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
  console.log('ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', recs.length);
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
  let overdueCount = 0;
  let dueThisMonthCount = 0;
  let notServicedCount = 0;
  
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  console.log('ğŸ“… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ:', now.toLocaleDateString('ar-SA'));
  console.log('ğŸ“‹ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentMonth + 1, 'Ø§Ù„Ø³Ù†Ø©:', currentYear);
  
  // ØªØ­Ù„ÙŠÙ„ ÙƒÙ„ Ø³Ø¬Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
  recs.forEach((record, index) => {
    const assetName = record.AssetName || record.AssetID || 'Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    
    // ÙÙ‚Ø· Ø§Ù„Ø³Ø¬Ù„Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    if (record.Status !== 'Completed') {
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ£Ø®ÙŠØ±
      if (record.DueDate) {
        try {
          const dueDate = new Date(record.DueDate);
          dueDate.setHours(0, 0, 0, 0);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          const daysDiff = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
          
          if (dueDate < today) {
            overdueCount++;
            console.log(`ğŸ”´ Ù…ØªØ£Ø®Ø±: ${assetName} - ${record.DueDate} (Ù‚Ø¨Ù„ ${daysDiff} ÙŠÙˆÙ…)`);
          } else {
            console.log(`ğŸŸ¢ ØºÙŠØ± Ù…ØªØ£Ø®Ø±: ${assetName} - ${record.DueDate} (Ø¨Ø¹Ø¯ ${Math.abs(daysDiff)} ÙŠÙˆÙ…)`);
          }
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
          if (dueDate.getMonth() === currentMonth && dueDate.getFullYear() === currentYear) {
            dueThisMonthCount++;
            console.log(`ğŸŸ  Ù…Ø³ØªØ­Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ${assetName} - ${record.DueDate}`);
          }
          
        } catch (error) {
          console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®: ${record.DueDate}`, error);
        }
      } else {
        console.log(`âš ï¸ Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${assetName}`);
      }
    } else {
      console.log(`âœ… Ù…ÙƒØªÙ…Ù„: ${assetName} - ${record.CompletedDate}`);
    }
  });
  
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ Ù„Ù… ØªØªÙ… ØµÙŠØ§Ù†ØªÙ‡Ø§
  notServicedCount = calculateNotServicedDevices();
  
  // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
  const outOfService = recs.filter(r => r.Status === 'OutOfService').length;
  const completed = recs.filter(r => r.Status === 'Completed').length;
  const critical = recs.filter(r => r.Status === 'Critical').length;
  const uncompleted = recs.filter(r => r.Status !== 'Completed').length;
  const downtime = recs.reduce((s, r) => s + (Number(r.DowntimeHours) || 0), 0);
  
  console.log('ğŸ‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:', {
    'Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©': overdueCount,
    'Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±': dueThisMonthCount,
    'Ø§Ù„ØªÙŠ Ù„Ù… ØªØªÙ… ØµÙŠØ§Ù†ØªÙ‡Ø§': notServicedCount,
    'Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©': outOfService,
    'Ù…ÙƒØªÙ…Ù„Ø©': completed
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  animateValue($('#kpiNotServiced'), notServicedCount);
  animateValue($('#kpiOverdue'), overdueCount);
  animateValue($('#kpiDueThisMonth'), dueThisMonthCount);
  animateValue($('#kpiOutOfService'), outOfService);
  animateValue($('#kpiCompleted'), completed);
  animateValue($('#kpiCritical'), critical);
  animateValue($('#kpiUncompleted'), uncompleted);
  animateValue($('#kpiDowntime'), Math.round(downtime));
  
  updateAlertsList();
}

function calculateNotServicedDevices() {
  try {
    const allDevices = new Set();
    const servicedDevices = new Set();
    
    // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù…Ù† assetsMap
    Object.values(App.assetsMap).forEach(devices => {
      if (devices && Array.isArray(devices)) {
        devices.forEach(device => {
          if (device && device.id) {
            allDevices.add(device.id);
          }
        });
      }
    });
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ ØªÙ…Øª ØµÙŠØ§Ù†ØªÙ‡Ø§ (Ù„Ù‡Ø§ Ø³Ø¬Ù„ Ù…ÙƒØªÙ…Ù„)
    App.records.forEach(record => {
      if (record.Status === 'Completed' && record.AssetID) {
        servicedDevices.add(record.AssetID);
      }
    });
    
    // Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ Ù„Ù… ØªØªÙ… ØµÙŠØ§Ù†ØªÙ‡Ø§ = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© - Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©
    const result = Math.max(0, allDevices.size - servicedDevices.size);
    console.log('Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ØºÙŠØ± Ø§Ù„Ù…Ø®Ø¯Ù…Ø©:', { total: allDevices.size, serviced: servicedDevices.size, notServiced: result });
    return result;
  } catch (error) {
    console.error('Error calculating not serviced devices:', error);
    return 0;
  }
}

function updateAlertsList() {
  const recs = App.records;
  const alerts = recs
    .filter(r => {
      const status = classify(r);
      return ['Overdue', 'Critical', 'OutOfService', 'DueSoon'].includes(status);
    })
    .slice(0, 8);
  
  const alertsList = $('#alertsList');
  
  if (alerts.length === 0) {
    alertsList.innerHTML = '<div class="text-center smallmuted py-3">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>';
    return;
  }
  
  alertsList.innerHTML = alerts.map(r => {
    const status = classify(r);
    let alertClass = '';
    let icon = '';
    
    if (status === 'Overdue' || status === 'Critical' || status === 'OutOfService') {
      alertClass = 'critical';
      icon = 'ğŸ”´';
    } else if (status === 'DueSoon') {
      alertClass = 'due-soon';
      icon = 'ğŸŸ ';
    }
    
    return `
      <div class="alert-item ${alertClass}">
        <div class="d-flex align-items-center">
          <span class="me-2">${icon}</span>
          <div class="flex-grow-1">
            <b>${r.AssetName || r.AssetID || '-'}</b> â€” ${r.Department || ''}
          </div>
        </div>
        <div class="small smallmuted mt-1">Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${fmt(r.DueDate)}</div>
      </div>
    `;
  }).join('');
}

/* =================== Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© =================== */
function drawCharts(){
  try {
    const ctxD = $('#donutStatus')?.getContext('2d');
    const ctxB = $('#barDept')?.getContext('2d');
    const ctxL = $('#lineMonthly')?.getContext('2d');
    
    if (!ctxD || !ctxB || !ctxL) {
      console.warn('Charts not ready yet');
      return;
    }
    
    const recs = App.records;
    
    // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    if (App.charts.donut) App.charts.donut.destroy();
    if (App.charts.bar) App.charts.bar.destroy();
    if (App.charts.line) App.charts.line.destroy();
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    const statusCount = recs.reduce((acc, r) => {
      const status = classify(r);
      acc[status] = (acc[status] || 0) + 1;
      return acc;
    }, {});
    
    const deptStats = {};
    recs.forEach(r => {
      const dept = r.Department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      if (!deptStats[dept]) {
        deptStats[dept] = { completed: 0, overdue: 0, pending: 0 };
      }
      const status = classify(r);
      if (status === 'Completed') deptStats[dept].completed++;
      else if (['Overdue', 'Critical', 'OutOfService'].includes(status)) deptStats[dept].overdue++;
      else deptStats[dept].pending++;
    });
    
    const monthlyData = Array(12).fill(0);
    recs.forEach(r => {
      if (r.Status === 'Completed' && r.CompletedDate) {
        const month = new Date(r.CompletedDate).getMonth();
        monthlyData[month]++;
      }
    });
    
    const monthLabels = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
    
    // Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø§Ù„Ø¯ÙˆÙ†Ø§Øª
    App.charts.donut = new Chart(ctxD, {
      type: 'doughnut',
      data: {
        labels: ['Ù…ÙƒØªÙ…Ù„Ø©', 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'Ù…ØªØ£Ø®Ø±Ø©/Ø­Ø±Ø¬Ø©', 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©'],
        datasets: [{
          data: [
            statusCount.Completed || 0,
            statusCount.Pending || 0,
            (statusCount.Overdue || 0) + (statusCount.Critical || 0),
            statusCount.OutOfService || 0
          ],
          backgroundColor: ['#5fd997', '#ffc44d', '#ff6b6b', '#9ea6b0'],
          borderColor: ['#2f8d5f', '#a87b11', '#b00020', '#6c757d'],
          borderWidth: 2
        }]
      },
      options: {
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#fff',
              font: { family: 'Tajawal', size: 12 }
            }
          }
        },
        maintainAspectRatio: false
      }
    });
    
    // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø´Ø±ÙŠØ·ÙŠ
    const deptNames = Object.keys(deptStats);
    App.charts.bar = new Chart(ctxB, {
      type: 'bar',
      data: {
        labels: deptNames,
        datasets: [
          {
            label: 'Ù…ÙƒØªÙ…Ù„Ø©',
            data: deptNames.map(dept => deptStats[dept].completed),
            backgroundColor: 'rgba(40,167,69,.8)'
          },
          {
            label: 'Ù…ØªØ£Ø®Ø±Ø©',
            data: deptNames.map(dept => deptStats[dept].overdue),
            backgroundColor: 'rgba(220,53,69,.85)'
          },
          {
            label: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
            data: deptNames.map(dept => deptStats[dept].pending),
            backgroundColor: 'rgba(255,193,7,.85)'
          }
        ]
      },
      options: {
        plugins: {
          legend: {
            labels: {
              color: '#fff',
              font: { family: 'Tajawal', size: 12 }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#fff',
              font: { family: 'Tajawal', size: 11 }
            }
          },
          y: {
            ticks: {
              color: '#fff',
              font: { family: 'Tajawal', size: 11 }
            }
          }
        },
        maintainAspectRatio: false
      }
    });
    
    // Ø±Ø³Ù… Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø®Ø·ÙŠ
    App.charts.line = new Chart(ctxL, {
      type: 'line',
      data: {
        labels: monthLabels,
        datasets: [{
          label: 'Ù…Ù†Ø¬Ø² Ø´Ù‡Ø±ÙŠÙ‹Ø§',
          data: monthlyData,
          borderWidth: 3,
          fill: true,
          tension: 0.3,
          backgroundColor: 'rgba(212,175,55,.15)',
          borderColor: '#d4af37'
        }]
      },
      options: {
        plugins: {
          legend: {
            labels: {
              color: '#fff',
              font: { family: 'Tajawal', size: 12 }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#fff',
              font: { family: 'Tajawal', size: 11 }
            }
          },
          y: {
            ticks: {
              color: '#fff',
              font: { family: 'Tajawal', size: 11 }
            }
          }
        },
        maintainAspectRatio: false
      }
    });
  } catch (error) {
    console.error('Error drawing charts:', error);
  }
}

/* =================== Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª =================== */
function renderLog(){
  const f = App.filters;
  const filtered = (App.records || []).filter(r => {
    if (f.dept && r.Department !== f.dept) return false;
    if (f.type && r.TaskType !== f.type) return false;
    
    const cls = classify(r);
    if (f.status) {
      if (f.status === 'Overdue' && cls !== 'Overdue') return false;
      if (f.status === 'Completed' && cls !== 'Completed') return false;
      if (f.status === 'Pending' && cls !== 'Pending') return false;
      if (f.status === 'Critical' && cls !== 'Critical') return false;
      if (f.status === 'OutOfService' && cls !== 'OutOfService') return false;
    }
    
    if (f.alertsOnly && !['Overdue', 'Critical', 'OutOfService', 'DueSoon'].includes(cls)) return false;
    
    if (f.search) {
      const searchText = f.search.toLowerCase();
      const recordText = `${r.Department || ''} ${r.Staff || ''} ${r.AssetName || ''} ${r.AssetID || ''} ${r.TaskType || ''}`.toLowerCase();
      if (!recordText.includes(searchText)) return false;
    }
    
    return true;
  }).sort((a, b) => new Date(b.Timestamp || 0) - new Date(a.Timestamp || 0));

  const tb = $('#logBody');
  if (!filtered.length) {
    tb.innerHTML = '<tr><td colspan="13" class="text-center py-4 smallmuted"><i class="fa-solid fa-inbox ms-1"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
    $('#viewCount').textContent = '0';
    $('#totalCount').textContent = App.records.length.toString();
    return;
  }

  tb.innerHTML = filtered.map(r => {
    const cls = classify(r);
    const badgeClass = 
      cls === 'Completed' ? 'completed' :
      cls === 'Overdue' ? 'overdue' :
      cls === 'Critical' ? 'critical' :
      cls === 'DueSoon' ? 'due' :
      cls === 'OutOfService' ? 'critical' : 'pending';

    const files = [];
    if (r.File) {
      String(r.File).split(',').forEach(u => {
        u = u.trim();
        if (u && u !== 'undefined') {
          files.push(`
            <a href="${u}" target="_blank" class="btn btn-sm btn-outline-success me-1" title="ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚">
              <i class="fa-solid fa-paperclip ms-1"></i> Ù…Ù„Ù
            </a>
          `);
        }
      });
    }

    let certHtml;
    if (r.Certificate) {
      certHtml = `<a class="btn btn-sm btn-outline-gold" target="_blank" href="${r.Certificate}" title="Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">
        <i class="fa-solid fa-file-pdf"></i>
      </a>`;
    } else if (r.Status === 'Completed') {
      certHtml = `<button class="btn btn-sm btn-outline-gold btn-gen-cert" data-id="${r.ID || r.id || ''}" title="Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">
        <i class="fa-solid fa-file-circle-plus"></i>
      </button>`;
    } else {
      certHtml = 'â€”';
    }

    const recordId = r.ID || r.id || '';
    const timestamp = r.Timestamp || r.timestamp || '';
    const assetName = r.AssetName || r.AssetID || 'Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

    return `<tr>
      <td>${fmt(r.Timestamp)}</td>
      <td><b>${r.Department || '-'}</b></td>
      <td>${r.Staff || '-'}</td>
      <td title="${r.AssetID || ''}">${r.AssetName || r.AssetID || '-'}</td>
      <td><span class="badge bg-primary">${r.TaskType || '-'}</span></td>
      <td>${fmt(r.StartDate)}</td>
      <td>${fmt(r.DueDate)}</td>
      <td>${fmt(r.CompletedDate)}</td>
      <td><span class="badge-status ${badgeClass}">${r.Status || cls}</span></td>
      <td>${r.Priority || '-'}</td>
      <td>${files.join('') || 'â€”'}</td>
      <td>${certHtml}</td>
      <td>
        <button class="btn btn-sm btn-outline-danger del-rec" 
                data-id="${recordId}" 
                data-timestamp="${timestamp}"
                data-asset="${assetName}"
                title="Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„">
          <i class="fa-solid fa-trash"></i>
        </button>
      </td>
    </tr>`;
  }).join('');

  $('#viewCount').textContent = filtered.length.toString();
  $('#totalCount').textContent = App.records.length.toString();
}

/* =================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ù†Ù…ÙˆØ°Ø¬ =================== */
function calcNextDue(){
  const startDate = $('#fStart').value;
  const frequency = $('#fFreq').value;
  
  if (!startDate || !frequency) {
    $('#fDue').value = '';
    return;
  }
  
  const start = new Date(startDate);
  const due = new Date(start);
  
  switch(frequency) {
    case 'W1': due.setDate(due.getDate() + 7); break;
    case 'M1': due.setMonth(due.getMonth() + 1); break;
    case 'M3': due.setMonth(due.getMonth() + 3); break;
    case 'M6': due.setMonth(due.getMonth() + 6); break;
    case 'M12': due.setMonth(due.getMonth() + 12); break;
    case 'Y2': due.setFullYear(due.getFullYear() + 2); break;
    default: $('#fDue').value = ''; return;
  }
  
  $('#fDue').value = due.toISOString().split('T')[0];
}

let selectedFiles = [];
function resetFilesUI(){ 
  selectedFiles = []; 
  $('#fFiles').value = ''; 
  $('#dzPreview').innerHTML = ''; 
  $('#dzInfo').textContent = ''; 
  $('#dzProgress').classList.add('d-none'); 
  $('#dzProgress .progress-bar').style.width = '0%'; 
}

function handleFiles(files){
  const list = Array.from(files || []);
  for (const f of list) {
    if (selectedFiles.length >= CONFIG.MAX_FILES) { 
      toast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ù„ÙØ§Øª', 'error'); 
      break; 
    }
    if (f.size > CONFIG.MAX_MB * 1024 * 1024) { 
      toast(`Ø§Ù„Ù…Ù„Ù ${f.name} ÙŠØªØ¬Ø§ÙˆØ² ${CONFIG.MAX_MB}MB`, 'error'); 
      continue; 
    }
    selectedFiles.push(f);
  }
  
  const pv = $('#dzPreview'); 
  pv.innerHTML = '';
  
  selectedFiles.forEach((f, idx) => {
    const wrap = document.createElement('div'); 
    wrap.className = 'thumb';
    const del = document.createElement('button'); 
    del.className = 'x'; 
    del.innerText = 'Ã—';
    del.addEventListener('click', (e) => { 
      e.stopPropagation(); 
      removeFileAt(idx); 
    });
    wrap.appendChild(del);
    
    if (f.type.startsWith('image/')) {
      const img = document.createElement('img'); 
      const r = new FileReader(); 
      r.onload = e => img.src = e.target.result; 
      r.readAsDataURL(f); 
      wrap.appendChild(img);
    } else {
      const chip = document.createElement('div'); 
      chip.className = 'badge bg-dark'; 
      chip.textContent = f.name; 
      wrap.appendChild(chip);
    }
    pv.appendChild(wrap);
  });
  
  $('#dzInfo').textContent = selectedFiles.length ? `Ù…Ù„ÙØ§Øª Ù…Ø®ØªØ§Ø±Ø©: ${selectedFiles.length}` : '';
}

function removeFileAt(i){ 
  selectedFiles.splice(i, 1); 
  handleFiles([]); 
}

let isSaving = false;
async function submitNew(ev){
  ev.preventDefault();

  if (isSaving) return;
  isSaving = true;

  const submitBtn = $('#formNew button[type="submit"]');
  const oldLabel = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin ms-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

  try {
    if (!selectedFiles.length) {
      toast('Ø±ÙØ¹ ØµÙˆØ±Ø©/Ù…Ø±ÙÙ‚ Ø¥Ù„Ø²Ø§Ù…ÙŠ', 'error');
      return;
    }

    const dep = $('#fDepartment').value;
    const staff = $('#fStaff').value;
    const type = $('#fTaskType').value;
    const assetSel = $('#fAsset');
    const assetID = assetSel.value;
    const assetName = assetSel.selectedOptions[0]?.textContent || assetID;

    if (!dep || !staff || !type || !assetID || !$('#fStart').value) {
      toast('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©', 'error');
      return;
    }

    const payload = {
      department: dep,
      staff: staff,
      taskType: type,
      assetID: assetID,
      assetName: assetName,
      startDate: $('#fStart').value,
      dueDate: $('#fDue').value,
      completedDate: $('#fCompleted').value,
      status: $('#fStatus').value,
      priority: $('#fPriority').value,
      downtimeHours: $('#fDown').value || '0',
      notes: ''
    };

    const res = await API.addRecord(payload);
    const recordId = res.ID || '';
    const timestamp = res.Timestamp || '';

    const prog = $('#dzProgress'),
          bar = prog.querySelector('.progress-bar');
    prog.classList.remove('d-none');

    let uploadErrors = [];

    for (let i = 0; i < selectedFiles.length; i++) {
      const f = selectedFiles[i];
      try {
        const base64 = await fileToBase64(f);
        await API.uploadFile({
          department: dep,
          fileName: f.name,
          mimeType: f.type || 'application/octet-stream',
          fileData: base64,
          recordId: recordId,
          timestamp: timestamp
        });
        bar.style.width = ((i + 1) / selectedFiles.length * 100).toFixed(0) + '%';
      } catch(e) {
        console.error('Upload error for', f.name, e);
        uploadErrors.push(f.name);
      }
    }

    prog.classList.add('d-none');
    bar.style.width = '0%';

    if (uploadErrors.length > 0) {
      toast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆÙ„ÙƒÙ† ÙØ´Ù„ Ø±ÙØ¹ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª: ${uploadErrors.join(', ')}`, 'warning');
    } else {
      toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }

    resetFilesUI();
    $('#formNew').reset();
    await loadAll();

  } catch(e) {
    console.error('submitNew error:', e);
    toast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©: ' + e.message, 'error');
  } finally {
    isSaving = false;
    submitBtn.disabled = false;
    submitBtn.innerHTML = oldLabel;
  }
}

function fileToBase64(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader(); 
    r.onload = e => resolve(e.target.result.split(',')[1]); 
    r.onerror = () => reject(new Error('file read error')); 
    r.readAsDataURL(file);
  });
}
</script>
</body>
</html>
