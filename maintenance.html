<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>لوحة صيانة الأجهزة — مجمع مكة الطبي</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<style>
/* ... نفس التنسيق لديك دون تغيير ... */
:root { --green500:#2E7D32; --green600:#1B5E20; --green700:#0D3410; --ink:#0A130B; --paper:#102714; --success:#28a745; --warning:#ffc107; --danger:#dc3545; }
* { font-family: 'Tajawal', sans-serif; box-sizing: border-box; }
body{background:linear-gradient(135deg,var(--ink),var(--paper));color:#f6fff4;min-height:100vh;margin:0;padding:0}
.glass{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.22);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.28);backdrop-filter:blur(10px)}
.navbar{background:rgba(0,30,8,.94);border-bottom:2px solid var(--green600);backdrop-filter:blur(10px)}
.brand-logo{width:56px;height:56px;border-radius:50%;background:#fff;padding:4px;object-fit:cover;box-shadow:0 0 18px rgba(46,125,50,.35)}
.btn-green{background:linear-gradient(135deg,var(--green700),var(--green500));color:#fff;border:0;transition:.3s}
.btn-green:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(46,125,50,.4)}
.card-kpi{padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,.22);transition:transform .3s}
.card-kpi:hover{transform:translateY(-5px)}
.card-kpi .val{font-size:32px;font-weight:800;background:linear-gradient(135deg,#fff,#d3ffd9);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.table{color:#fff;border-radius:8px;overflow:hidden}
.table thead th{background:rgba(46,125,50,.2);color:#fff;border-bottom:2px solid rgba(255,255,255,.45);font-weight:700}
.table tbody tr{transition:background-color .3s}
.table tbody tr:hover{background:rgba(255,255,255,.1)}
.toast-lite{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--green700),var(--green500));color:#fff;padding:12px 20px;border-radius:10px;z-index:9999;box-shadow:0 5px 15px rgba(0,0,0,.3)}
.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.fade-in{animation:fadeIn .5s ease-in}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.status-badge{padding:6px 12px;border-radius:20px;font-weight:600;font-size:.85rem;border:2px solid transparent}
.bg-critical{background:linear-gradient(135deg,#8B0000,#DC3545);color:#fff;border-color:#FF6B6B;animation:pulse 2s infinite}
.bg-due-soon{background:linear-gradient(135deg,#FF8C00,#FFA500);color:#fff;border-color:#FFD700}
.bg-out-of-service{background:linear-gradient(135deg,#6C757D,#495057);color:#fff;border-color:#ADB5BD}
.file-upload-area{border:2px dashed rgba(46,125,50,.5);border-radius:8px;padding:20px;text-align:center;transition:.3s;cursor:pointer;background:rgba(46,125,50,.05)}
.file-upload-area:hover{border-color:var(--green500);background:rgba(46,125,50,.1)}
.file-upload-area.dragover{border-color:var(--green500);background:rgba(46,125,50,.15)}
.file-preview{max-width:100px;max-height:100px;border-radius:5px;margin:5px}
@keyframes pulse{0%{opacity:1}50%{opacity:.7}100%{opacity:1}}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <div class="d-flex align-items-center gap-2">
      <img class="brand-logo" src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo.png" alt="شعار المجمع" onerror="this.style.display='none'">
      <div>
        <div class="fw-bold fs-5 text-white">لوحة صيانة الأجهزة</div>
        <div class="small text-white-50">نظام إدارة الصيانة الوقائية والتصحيحية</div>
      </div>
    </div>
    <button class="navbar-toggler text-light" data-bs-toggle="collapse" data-bs-target="#nav">
      <i class="fa-solid fa-bars"></i>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto align-items-center gap-3">
        <li class="nav-item"><a class="nav-link text-light" href="#dash">اللوحة الرئيسية</a></li>
        <li class="nav-item"><a class="nav-link text-light" href="#table">سجلات الصيانة</a></li>
        <li class="nav-item">
          <button id="btnRefresh" class="btn btn-outline-light btn-sm">
            <i class="fa-solid fa-rotate ms-1"></i> تحديث البيانات
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<section id="dash" class="container py-4">
  <div class="glass p-4 mb-4 fade-in">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="m-0 fw-bold text-white">نظام إدارة صيانة الأجهزة الطبية</h1>
        <div class="text-muted mt-2">نظام متصل مباشرة بملف Google Sheets • بيانات حية • تحديث فوري</div>
      </div>
      <div class="col-md-4 text-left">
        <div class="d-flex gap-2 justify-content-md-end">
          <button class="btn btn-green" data-bs-toggle="modal" data-bs-target="#modalNew">
            <i class="fa-solid fa-plus ms-1"></i> إضافة مهمة
          </button>
          <button id="btnPrint" class="btn btn-outline-light">
            <i class="fa-solid fa-print ms-1"></i> طباعة
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="small text-muted">إجمالي الأجهزة</div>
        <div id="kpiTotalAssets" class="val">—</div>
        <div class="small text-muted">الأجهزة المسجلة في النظام</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="small text-muted">المهام المتأخرة</div>
        <div id="kpiOver" class="val text-warning">0</div>
        <div class="small text-muted">تتطلب تدخلاً فورياً</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="small text-muted">المهام المكتملة</div>
        <div id="kpiCompleted" class="val text-success">0</div>
        <div class="small text-muted">خلال آخر 30 يوم</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="small text-muted">نسبة الجاهزية</div>
        <div id="kpiAvail" class="val">—%</div>
        <div class="small text-muted">تقدير كفاءة التشغيل</div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="glass p-3 h-100">
        <h5 class="m-0 mb-3">حالة الصيانة حسب الأقسام</h5>
        <canvas id="deptChart" height="250"></canvas>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="glass p-3 h-100">
        <h5 class="m-0 mb-3">توزيع حالات المهام</h5>
        <canvas id="statusChart" height="250"></canvas>
      </div>
    </div>
  </div>
</section>

<section id="table" class="container py-4">
  <div class="glass p-3">
    <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between mb-3">
      <h5 class="m-0">سجل مهام الصيانة</h5>

      <div class="d-flex flex-wrap gap-2">
        <select id="filterDept" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">جميع الأقسام</option>
        </select>

        <select id="filterType" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">كل الأنواع</option>
          <option value="PM">صيانة وقائية</option>
          <option value="CM">صيانة تصحيحية</option>
        </select>

        <select id="filterStatus" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">جميع الحالات</option>
          <option value="Completed">مكتملة</option>
          <option value="Pending">قيد الانتظار</option>
          <option value="Overdue">متأخرة</option>
          <option value="Critical">حرجة</option>
          <option value="OutOfService">خارج الخدمة</option>
        </select>

        <input id="searchBox" class="form-control form-control-sm bg-dark text-light border-secondary"
               placeholder="بحث في السجلات..." style="width: 220px"/>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>التاريخ</th>
            <th>القسم</th>
            <th>الفني</th>
            <th>الجهاز</th>
            <th>النوع</th>
            <th>التنفيذ</th>
            <th>الاستحقاق</th>
            <th>الإغلاق</th>
            <th>الحالة</th>
            <th>الأولوية</th>
            <th>المرفقات</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="logBody">
          <tr>
            <td colspan="12" class="text-center py-4">
              <div class="loading-spinner me-2"></div>
              جاري تحميل البيانات...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3 text-muted small">
      <div>إجمالي السجلات: <span id="totalCount" class="fw-bold">0</span></div>
      <div>السجلات المعروضة: <span id="viewCount" class="fw-bold">0</span></div>
    </div>
  </div>
</section>

<!-- نافذة إضافة مهمة جديدة -->
<div class="modal fade" id="modalNew" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content glass border-0">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-white">
          <i class="fa-solid fa-plus ms-1"></i> إضافة مهمة صيانة جديدة
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formNew" class="row g-3">
          <div class="col-md-6">
            <label class="form-label text-white">القسم</label>
            <select id="fDepartment" required class="form-select bg-dark text-light border-secondary">
              <option value="">جاري التحميل...</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label text-white">الفني المسؤول</label>
            <select id="fStaff" required class="form-select bg-dark text-light border-secondary">
              <option value="">جاري التحميل...</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label text-white">نوع المهمة</label>
            <select id="fTaskType" required class="form-select bg-dark text-light border-secondary">
              <option value="PM">صيانة وقائية (PM)</option>
              <option value="CM">صيانة تصحيحية (CM)</option>
            </select>
          </div>

          <div class="col-md-8">
            <label class="form-label text-white">الجهاز/المعدة</label>
            <select id="fAsset" required class="form-select bg-dark text-light border-secondary">
              <option value="">اختر القسم أولاً...</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label text-white">تاريخ التنفيذ</label>
            <input id="fServiceDate" type="date" required class="form-control bg-dark text-light border-secondary"/>
          </div>

          <div class="col-md-4">
            <label class="form-label text-white">التكرار</label>
            <select id="fFreq" class="form-select bg-dark text-light border-secondary">
              <option value="">بدون تكرار</option>
              <option value="W1">أسبوعي</option>
              <option value="M1">شهري</option>
              <option value="M3">كل 3 أشهر</option>
              <option value="M6">كل 6 أشهر</option>
              <option value="M12">سنوي</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label text-white">الاستحقاق القادم</label>
            <input id="fNextDue" type="date" readonly class="form-control bg-dark text-light border-secondary"/>
          </div>

          <div class="col-md-6">
            <label class="form-label text-white">حالة المهمة</label>
            <select id="fStatus" required class="form-select bg-dark text-light border-secondary">
              <option value="Pending">قيد الانتظار</option>
              <option value="Completed">مكتملة</option>
              <option value="Overdue">متأخرة</option>
              <option value="Critical">حرجة</option>
              <option value="OutOfService">خارج الخدمة</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label text-white">أولوية المهمة</label>
            <select id="fPriority" class="form-select bg-dark text-light border-secondary">
              <option value="Medium">متوسطة</option>
              <option value="High">عالية</option>
              <option value="Low">منخفضة</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label text-white">وقت التوقف (ساعات)</label>
            <input id="fDown" type="number" step="0.1" min="0" class="form-control bg-dark text-light border-secondary" placeholder="0" value="0"/>
          </div>

          <div class="col-12">
            <label class="form-label text-white">رفع المرفقات <span class="text-danger">*</span></label>
            <div id="fileUploadArea" class="file-upload-area">
              <i class="fa-solid fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
              <div class="text-muted">اسحب وأفلت الملفات هنا أو انقر للاختيار</div>
              <div class="small text-muted mt-1">الحد الأقصى: 10MB</div>
              <input type="file" id="fFile" class="d-none" accept="image/*,.pdf,.doc,.docx" required>
              <div id="filePreview" class="mt-2"></div>
            </div>
          </div>

          <div class="col-12 pt-3 border-top border-secondary">
            <div class="d-flex justify-content-end gap-2">
              <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">إلغاء</button>
              <button id="btnSave" type="submit" class="btn btn-green">
                <i class="fa-solid fa-floppy-disk ms-1"></i> حفظ المهمة
              </button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<footer class="container py-4 mt-4 border-top border-secondary">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center text-muted small">
    <div>© 2025 نظام إدارة صيانة الأجهزة الطبية — مجمع مكة الطبي</div>
    <div class="mt-2 mt-md-0">
      <i class="fa-solid fa-envelope me-1"></i>
      support@makkahclinic.com
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/** ===== إعدادات API ===== **/
const API_URL = 'https://script.google.com/macros/s/AKfycbxw6oWSHKDjeZI6dsspS3PVVwbO9KO5UnjKGqDa_yP9cYAVjNHh6WMfQrdlpkF_A25--A/exec'; // ضع رابط الويب آب هنا

/** ===== الإعدادات العامة ===== **/
var CONFIG = { AUTO_REFRESH_MS: 300000, MAX_FILE_MB: 10 };
var AppState = {
  assetsMap: {},
  staffList: [],
  records: [],
  charts: { dept: null, status: null },
  filters: { department: "", type: "", status: "", search: "" }
};

/** ===== دوال مساعدة واجهة ===== **/
function $(s){return document.querySelector(s)}; function $$(s){return document.querySelectorAll(s)};
function showToast(message, type='success'){ var t=document.createElement('div'); t.className='toast-lite';
  if(type==='error') t.style.background='linear-gradient(135deg,#dc3545,#c82333)';
  else if(type==='warning') t.style.background='linear-gradient(135deg,#ffc107,#e0a800)';
  t.textContent=message; document.body.appendChild(t); setTimeout(()=>{t.style.opacity='0'; setTimeout(()=>t.remove(),300)}, type==='error'?5000:3000);}

function formatDate(ds){ if(!ds) return ""; try{ var d=new Date(ds); return isNaN(d.getTime())? ds : d.toLocaleDateString('ar-SA'); }catch(_){return ds;} }

function classifyStatus(r){
  if(r.Status==='Completed') return 'Completed';
  if(r.Status==='OutOfService') return 'OutOfService';
  if(r.Status==='Critical') return 'Critical';
  var due=r.DueDate? new Date(r.DueDate):null;
  if(due){
    var today=new Date(); today.setHours(0,0,0,0);
    if(due<today) return 'Overdue';
    var warn=new Date(today); warn.setDate(warn.getDate()+30);
    if(due<=warn) return 'DueSoon';
  }
  return 'Pending';
}

/** ===== طبقة API (GET + POST x-www-form-urlencoded) ===== **/
const ApiManager = {
  async get(action, params={}){
    const url=new URL(API_URL); url.searchParams.set('action', action);
    Object.entries(params).forEach(([k,v])=>{ if(v!==undefined && v!==null) url.searchParams.set(k, v); });
    const res = await fetch(url.toString(), { method:'GET' });
    const data = await res.json();
    if(data && data.error){ throw new Error(data.error); }
    return data;
  },
  async post(action, params={}){
    const body = new URLSearchParams({ action });
    Object.entries(params).forEach(([k,v])=>{ if(v!==undefined && v!==null) body.append(k, v); });
    const res = await fetch(API_URL, {
      method:'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body
    });
    const data = await res.json();
    if(data && data.error){ throw new Error(data.error); }
    return data;
  },
  async getRecords(){ return await this.get('getRecords'); },
  async getAssets(){  return await this.get('getAssets');  },
  async getStaff(){   return await this.get('getStaff');   },
  async addRecord(record){ return await this.post('addRecord', record); },
  async deleteRecord(idOrTs){ return await this.post('deleteRecord', idOrTs); },
  async updateRecord(payload){ return await this.post('updateRecord', payload); },
  async uploadFileBase64(file, department){
    // تحويل إلى Base64
    const base64 = await new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    return await this.post('uploadFile', {
      department: department,
      fileName: file.name,
      mimeType: file.type || 'application/octet-stream',
      fileData: base64
    });
  }
};

/** ===== إدارة البيانات ===== **/
const DataManager = {
  async loadData(){
    try{
      const [records, assets, staff] = await Promise.all([
        ApiManager.getRecords(), ApiManager.getAssets(), ApiManager.getStaff()
      ]);
      AppState.records  = records || [];
      AppState.assetsMap = assets || {};
      AppState.staffList = staff || [];
      UIManager.updateSelectors();
      UIManager.updateKPIs();
      UIManager.renderTable();
      ChartManager.updateCharts();
      showToast('تم تحميل البيانات بنجاح');
    }catch(err){
      console.error(err); showToast('خطأ في تحميل البيانات: ' + err.message, 'error');
    }
  },
  async addRecord(formData){
    // رفع الملف أولاً
    const file = $('#fFile').files[0];
    if(!file) throw new Error('يجب اختيار ملف للرفع');
    if(file.size > CONFIG.MAX_FILE_MB*1024*1024) throw new Error('حجم الملف أكبر من ' + CONFIG.MAX_FILE_MB + 'MB');

    const upload = await ApiManager.uploadFileBase64(file, formData.department);

    const recordData = {
      department: formData.department,
      staff: formData.staff,
      taskType: formData.taskType,
      assetID: formData.assetID,
      assetName: formData.assetName,
      startDate: formData.startDate,
      dueDate: formData.dueDate,
      completedDate: formData.completedDate,
      status: formData.status,
      priority: formData.priority,
      downtimeHours: formData.downtimeHours,
      notes: formData.notes,
      file: upload.fileUrl
    };

    const result = await ApiManager.addRecord(recordData);
    await this.loadData();
    return result;
  },
  async deleteRecord(idValue, tsValue){
    const payload = idValue ? { id: idValue } : { timestamp: tsValue };
    const res = await ApiManager.deleteRecord(payload);
    await this.loadData();
    return res;
  }
};

/** ===== إدارة الواجهة ===== **/
const UIManager = {
  updateSelectors(){
    const departments = Object.keys(AppState.assetsMap).sort();
    // أقسام
    $('#filterDept').innerHTML = '<option value="">جميع الأقسام</option>' + departments.map(d=>`<option value="${d}">${d}</option>`).join('');
    $('#fDepartment').innerHTML = '<option value="">اختر القسم...</option>' + departments.map(d=>`<option value="${d}">${d}</option>`).join('');
    // فنيين
    $('#fStaff').innerHTML = '<option value="">اختر الفني...</option>' + (AppState.staffList||[]).map(s=>`<option value="${s}">${s}</option>`).join('');

    // عند تغيير القسم اختَر الجهاز
    $('#fDepartment').addEventListener('change', function(){
      const assets = AppState.assetsMap[this.value] || [];
      $('#fAsset').innerHTML = assets.length ? '<option value="">اختر الجهاز...</option>' + assets.map(a=>`<option value="${a.id}">${a.name}</option>`).join('') : '<option value="">لا توجد أجهزة</option>';
    });
  },
  calculateNextDueDate(){
    const serviceDate = $('#fServiceDate').value;
    const frequency = $('#fFreq').value;
    if(!serviceDate || !frequency){ $('#fNextDue').value=''; return; }
    const d = new Date(serviceDate); if(isNaN(d.getTime())) return;
    switch(frequency){
      case 'W1': d.setDate(d.getDate()+7); break;
      case 'M1': d.setMonth(d.getMonth()+1); break;
      case 'M3': d.setMonth(d.getMonth()+3); break;
      case 'M6': d.setMonth(d.getMonth()+6); break;
      case 'M12': d.setFullYear(d.getFullYear()+1); break;
      default: return;
    }
    $('#fNextDue').value = d.toISOString().split('T')[0];
  },
  updateKPIs(){
    const recs = AppState.records;
    const totalAssets = Object.values(AppState.assetsMap).reduce((t,arr)=> t + (arr?arr.length:0), 0);
    $('#kpiTotalAssets').textContent = totalAssets;

    const overdue = recs.filter(r => (classifyStatus(r)==='Overdue' || classifyStatus(r)==='Critical') && r.Status!=='Completed').length;
    $('#kpiOver').textContent = overdue;

    const thirtyAgo = new Date(); thirtyAgo.setDate(thirtyAgo.getDate()-30);
    const completed = recs.filter(r => r.Status==='Completed' && new Date(r.CompletedDate)>=thirtyAgo).length;
    $('#kpiCompleted').textContent = completed;

    const totalTasks = recs.length; const done = recs.filter(r=>r.Status==='Completed').length;
    $('#kpiAvail').textContent = (totalTasks? Math.round(done/totalTasks*100):0) + '%';
  },
  renderTable(){
    const f = AppState.filters;
    const filtered = (AppState.records||[]).filter(r=>{
      if(f.department && r.Department!==f.department) return false;
      if(f.type && r.TaskType!==f.type) return false;
      if(f.status && classifyStatus(r)!==f.status) return false;
      if(f.search){
        const s = f.search.toLowerCase();
        return Object.values(r).some(v => String(v).toLowerCase().includes(s));
      }
      return true;
    }).sort((a,b)=> new Date(b.Timestamp) - new Date(a.Timestamp));

    const tbody = $('#logBody');
    if(!filtered.length){
      tbody.innerHTML='<tr><td colspan="12" class="text-center py-4 text-muted"><i class="fa-solid fa-inbox me-2"></i>لا توجد سجلات مطابقة</td></tr>';
    } else {
      tbody.innerHTML = filtered.map(r=>{
        const statClass = this.getStatusBadgeClass(r);
        const priClass  = this.getPriorityBadgeClass(r.Priority);
        const fileLink  = r.File ? `<a href="${r.File}" target="_blank" class="text-success"><i class="fa-solid fa-file me-1"></i>عرض</a>` : '—';
        const recId = r.id || r.ID || r.RecordID || r.Timestamp;
        return `<tr class="fade-in">
          <td>${formatDate(r.Timestamp)}</td>
          <td><strong>${r.Department||'—'}</strong></td>
          <td>${r.Staff||'—'}</td>
          <td title="${r.AssetID||''}">${r.AssetName || r.AssetID || '—'}</td>
          <td><span class="badge ${r.TaskType==='PM'?'bg-primary':'bg-warning'}">${r.TaskType||'—'}</span></td>
          <td>${formatDate(r.StartDate)}</td>
          <td>${formatDate(r.DueDate)}</td>
          <td>${formatDate(r.CompletedDate)}</td>
          <td><span class="badge status-badge ${statClass}">${r.Status || classifyStatus(r)}</span></td>
          <td>${r.Priority ? `<span class="badge ${priClass}">${r.Priority}</span>` : '—'}</td>
          <td>${fileLink}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger delete-record" data-id="${recId}" data-ts="${r.Timestamp}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        </tr>`;
      }).join('');
      // حذف السجل
      $$('.delete-record').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const id = this.getAttribute('data-id');
          const ts = this.getAttribute('data-ts');
          if(confirm('هل أنت متأكد من حذف هذا السجل؟')){
            try{
              await DataManager.deleteRecord(id, ts);
              showToast('تم حذف السجل');
            }catch(err){ showToast('تعذّر الحذف: ' + err.message, 'error'); }
          }
        });
      });
    }
    $('#totalCount').textContent = AppState.records.length;
    $('#viewCount').textContent  = filtered.length;
  },
  getStatusBadgeClass(r){
    const s = classifyStatus(r);
    switch(s){
      case 'Completed': return 'bg-success';
      case 'Overdue':   return 'bg-danger';
      case 'Critical':  return 'bg-critical';
      case 'DueSoon':   return 'bg-due-soon';
      case 'OutOfService': return 'bg-out-of-service';
      default:          return 'bg-warning';
    }
  },
  getPriorityBadgeClass(p){
    switch(p){
      case 'High': return 'bg-danger';
      case 'Medium': return 'bg-warning';
      case 'Low': return 'bg-info';
      default: return 'bg-secondary';
    }
  }
};

/** ===== إدارة النماذج ===== **/
const FormManager = {
  init(){
    this.setupEvents(); this.setupFileUpload(); this.setupValidation();
  },
  setupEvents(){
    $('#fServiceDate').addEventListener('change', ()=> UIManager.calculateNextDueDate());
    $('#fFreq').addEventListener('change', ()=> UIManager.calculateNextDueDate());
  },
  setupFileUpload(){
    const fileInput = $('#fFile'), uploadArea = $('#fileUploadArea'), filePreview = $('#filePreview');
    uploadArea.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', function(){ if(this.files && this.files[0]) FormManager.handleFile(this.files[0]); });
    uploadArea.addEventListener('dragover', e=>{ e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', e=>{
      e.preventDefault(); uploadArea.classList.remove('dragover');
      if(e.dataTransfer.files && e.dataTransfer.files[0]) FormManager.handleFile(e.dataTransfer.files[0]);
    });
  },
  handleFile(file){
    if(file.size > CONFIG.MAX_FILE_MB*1024*1024){ showToast('حجم الملف أكبر من ' + CONFIG.MAX_FILE_MB + 'MB','error'); return; }
    const preview = $('#filePreview'); preview.innerHTML='';
    if(file.type.startsWith('image/')){
      const reader=new FileReader();
      reader.onload = e=>{ const img=document.createElement('img'); img.src=e.target.result; img.className='file-preview'; preview.appendChild(img); };
      reader.readAsDataURL(file);
    } else {
      const info=document.createElement('div'); info.className='text-success'; info.innerHTML=`<i class="fa-solid fa-file me-1"></i> ${file.name}`; preview.appendChild(info);
    }
    const area = $('#fileUploadArea');
    area.innerHTML = `
      <div class="text-success"><i class="fa-solid fa-check-circle me-1"></i> تم اختيار الملف</div>
      <div class="small text-muted mt-1">${file.name}</div>
      <button type="button" id="changeFile" class="btn btn-sm btn-outline-light mt-2">تغيير الملف</button>
    `;
    $('#changeFile').addEventListener('click', e=>{
      e.stopPropagation(); preview.innerHTML=''; FormManager.resetFileUpload();
    });
  },
  resetFileUpload(){
    const area = $('#fileUploadArea');
    area.innerHTML = `
      <i class="fa-solid fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
      <div class="text-muted">اسحب وأفلت الملفات هنا أو انقر للاختيار</div>
      <div class="small text-muted mt-1">الحد الأقصى: 10MB</div>
      <input type="file" id="fFile" class="d-none" accept="image/*,.pdf,.doc,.docx" required>
      <div id="filePreview" class="mt-2"></div>
    `;
    // إعادة الربط بعد إعادة البناء
    this.setupFileUpload();
  },
  setupValidation(){
    $('#formNew').addEventListener('submit', this.submit.bind(this));
  },
  async submit(ev){
    ev.preventDefault();
    const btn = $('#btnSave'); const original = btn.innerHTML;
    try{
      const required = ['#fDepartment','#fStaff','#fTaskType','#fAsset','#fServiceDate'];
      const missing = required.filter(sel => !$(sel).value);
      if(missing.length){ showToast('يرجى ملء جميع الحقول الإلزامية','error'); return; }
      if(!$('#fFile').files || !$('#fFile').files[0]){ showToast('يجب رفع ملف للمهمة','error'); return; }

      btn.innerHTML = '<div class="loading-spinner me-2"></div> جاري الحفظ...'; btn.disabled=true;

      const formData = {
        department: $('#fDepartment').value,
        staff: $('#fStaff').value,
        taskType: $('#fTaskType').value,
        assetID: $('#fAsset').value,
        assetName: $('#fAsset').selectedOptions[0] ? $('#fAsset').selectedOptions[0].textContent : $('#fAsset').value,
        startDate: $('#fServiceDate').value,
        dueDate: $('#fNextDue').value,
        completedDate: ($('#fTaskType').value==='PM' || $('#fStatus').value==='Completed') ? $('#fServiceDate').value : '',
        status: $('#fStatus').value,
        priority: $('#fPriority').value || 'Medium',
        downtimeHours: $('#fDown').value || '0',
        notes: $('#fNotes') ? $('#fNotes').value : ''
      };

      await DataManager.addRecord(formData);

      showToast('تم إضافة المهمة ورفع الملف بنجاح');
      ev.target.reset(); this.resetFileUpload();
      const modal = bootstrap.Modal.getInstance($('#modalNew')); if(modal) modal.hide();
    }catch(err){
      console.error(err); showToast('خطأ: ' + err.message, 'error');
    }finally{
      btn.innerHTML = original; btn.disabled=false;
    }
  }
};

/** ===== المخططات ===== **/
const ChartManager = {
  initializeCharts(){
    try{
      const deptCtx = $('#deptChart').getContext('2d');
      const statusCtx = $('#statusChart').getContext('2d');

      AppState.charts.dept = new Chart(deptCtx, {
        type:'bar',
        data:{ labels:[], datasets:[
          { label:'مكتملة', data:[], backgroundColor:'rgba(40, 167, 69, 0.8)', borderColor:'rgba(40, 167, 69, 1)', borderWidth:1 },
          { label:'متأخرة', data:[], backgroundColor:'rgba(220, 53, 69, 0.8)', borderColor:'rgba(220, 53, 69, 1)', borderWidth:1 },
          { label:'قيد الانتظار', data:[], backgroundColor:'rgba(255, 193, 7, 0.8)', borderColor:'rgba(255, 193, 7, 1)', borderWidth:1 }
        ]},
        options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#fff' } } },
          scales:{ x:{ ticks:{ color:'#fff' }, grid:{ color:'rgba(255,255,255,.1)'} },
                   y:{ ticks:{ color:'#fff' }, grid:{ color:'rgba(255,255,255,.1)'} } }
        }
      });

      AppState.charts.status = new Chart(statusCtx, {
        type:'doughnut',
        data:{ labels:['مكتملة','قيد الانتظار','متأخرة','حرجة','خارج الخدمة'],
          datasets:[{ data:[0,0,0,0,0],
            backgroundColor:['rgba(40, 167, 69, 0.8)','rgba(255, 193, 7, 0.8)','rgba(220, 53, 69, 0.8)','rgba(139, 0, 0, 0.8)','rgba(108, 117, 125, 0.8)'],
            borderColor:['rgba(40, 167, 69, 1)','rgba(255, 193, 7, 1)','rgba(220, 53, 69, 1)','rgba(139, 0, 0, 1)','rgba(108, 117, 125, 1)'], borderWidth:2 }]
        },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ color:'#fff', font:{ size:12 } } } } }
      });
    }catch(err){ console.error('Chart init error', err); }
  },
  updateCharts(){
    try{
      const recs = AppState.records;
      const stats = {};
      recs.forEach(r=>{
        const d = r.Department || 'غير مصنف';
        const s = classifyStatus(r);
        if(!stats[d]) stats[d] = { Completed:0, Pending:0, Overdue:0, Critical:0, OutOfService:0 };
        stats[d][s] = (stats[d][s]||0) + 1;
      });
      const depts = Object.keys(stats);
      const completed = depts.map(d=> stats[d].Completed||0);
      const overdue   = depts.map(d=> stats[d].Overdue||0);
      const pending   = depts.map(d=> stats[d].Pending||0);

      if(AppState.charts.dept){
        AppState.charts.dept.data.labels = depts;
        AppState.charts.dept.data.datasets[0].data = completed;
        AppState.charts.dept.data.datasets[1].data = overdue;
        AppState.charts.dept.data.datasets[2].data = pending;
        AppState.charts.dept.update();
      }

      if(AppState.charts.status){
        const sc = { Completed:0, Pending:0, Overdue:0, Critical:0, OutOfService:0 };
        recs.forEach(r=> sc[classifyStatus(r)]++);
        AppState.charts.status.data.datasets[0].data = [sc.Completed, sc.Pending, sc.Overdue, sc.Critical, sc.OutOfService];
        AppState.charts.status.update();
      }
    }catch(err){ console.error('Chart update error', err); }
  }
};

/** ===== تهيئة الصفحة ===== **/
document.addEventListener('DOMContentLoaded', function(){
  const today = new Date().toISOString().split('T')[0];
  $('#fServiceDate').value = today;
  FormManager.init();
  ChartManager.initializeCharts();
  DataManager.loadData();

  $('#btnRefresh').addEventListener('click', ()=> DataManager.loadData());
  $('#btnPrint').addEventListener('click', ()=> window.print());
  $('#filterDept').addEventListener('change', e=>{ AppState.filters.department = e.target.value; UIManager.renderTable(); });
  $('#filterType').addEventListener('change', e=>{ AppState.filters.type = e.target.value; UIManager.renderTable(); });
  $('#filterStatus').addEventListener('change', e=>{ AppState.filters.status = e.target.value; UIManager.renderTable(); });
  $('#searchBox').addEventListener('input', e=>{ AppState.filters.search = e.target.value; UIManager.renderTable(); });
});
</script>
</body>
</html>
