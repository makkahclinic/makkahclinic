<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ© â€“ Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</title>

<!-- Ø®Ø·ÙˆØ· -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;800;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Bootstrap RTL + Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª + Chart.js -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<style>
:root{
  --crimson:#7d0024;   /* Ù‚Ø±Ù…Ø²ÙŠ */
  --crimson-2:#5b001a;
  --gold:#d4af37;      /* Ø°Ù‡Ø¨ÙŠ */
  --ink:#14070b;
  --bg:#1a0b10;
  --muted:rgba(255,255,255,.7);
}
/* Ø®Ù„ÙÙŠØ© Ù‚Ø±Ù…Ø²ÙŠØ© Ù…Ø¹ Ù†Ù…Ø· Ø°Ù‡Ø¨ÙŠ Ø®ÙÙŠÙ */
body{
  font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background: radial-gradient(circle at 20% 10%, rgba(212,175,55,.08) 1px, transparent 1px) ,
              radial-gradient(circle at 80% 60%, rgba(212,175,55,.06) 1px, transparent 1px) ,
              linear-gradient(135deg, #2a0b14, #18060a 55%, #110306);
  background-size:12px 12px, 14px 14px, auto;
  color:#fff;
}
h1,h2,h3,h4,h5{font-family:'Cairo',Tajawal,Arial;letter-spacing:.2px}
.navbar{
  background:linear-gradient(180deg, var(--crimson), var(--crimson-2));
  border-bottom:2px solid var(--gold);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.brand{
  display:flex;align-items:center;gap:.75rem;color:#fff;text-decoration:none
}
.brand img{width:48px;height:48px;border-radius:50%;background:#fff;object-fit:cover;
  box-shadow:0 0 0 3px rgba(212,175,55,.25),0 8px 24px rgba(0,0,0,.4)}
.brand span{font-family:'Cairo';font-weight:800}
.tabbar{
  background:rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.1)
}
.tabbar .nav-link{
  color:#fff;border:none;border-bottom:3px solid transparent;border-radius:0;font-weight:700
}
.tabbar .nav-link.active{border-color:var(--gold);color:#fff}
.card-glass{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px; box-shadow:0 12px 30px rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
}
.kpi{
  padding:18px;border-radius:16px;position:relative;overflow:hidden
}
.kpi:before{
  content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(212,175,55,.08),transparent);
}
.kpi .label{color:var(--muted);font-size:.9rem}
.kpi .value{font-family:'Cairo';font-size:38px;font-weight:900;line-height:1.1}
.kpi .hint{color:var(--muted);font-size:.85rem}
.kpi.gold .value{background:linear-gradient(135deg,#fff,#ffe9a8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.kpi.green .value{color:#71ff9d}
.kpi.red   .value{color:#ff8a8a}
.kpi.orange .value{color:#ffd08a}
.kpi.blue .value{color:#9dd7ff}
.badge-status{padding:.45rem .7rem;border-radius:999px;font-weight:700;border:2px solid rgba(255,255,255,.15)}
.badge-status.completed{background:rgba(25,135,84,.25)}
.badge-status.pending{background:rgba(255,193,7,.22)}
.badge-status.overdue{background:rgba(220,53,69,.25);box-shadow:0 0 0 .35rem rgba(220,53,69,.06)}
.badge-status.critical{background:linear-gradient(135deg,#8b0000,#b30000);border-color:#ffb3b3}
.badge-status.due{background:linear-gradient(135deg,#c58a00,#e0a800)}
.table thead th{background:rgba(255,255,255,.08);border-bottom:2px solid rgba(255,255,255,.2)}
.table{color:#fff}
.table tbody tr:hover{background:rgba(255,255,255,.06)}
.form-control,.form-select{
  background:rgba(0,0,0,.35);color:#fff;border:1px solid rgba(255,255,255,.18)
}
.form-control:focus,.form-select:focus{border-color:var(--gold);box-shadow:0 0 0 .2rem rgba(212,175,55,.25)}
.btn-gold{
  background:linear-gradient(135deg,var(--gold),#f5d86c);
  color:#331a00;border:none;font-weight:800
}
.btn-crimson{background:var(--crimson);color:#fff;border:none}
.btn-outline-gold{border:2px solid var(--gold);color:#fff}
.smallmuted{color:var(--muted)}
/* Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª */
.dropzone{
  border:2px dashed rgba(212,175,55,.45);border-radius:14px;padding:22px;text-align:center;
  background:rgba(212,175,55,.05)
}
.dropzone.drag{background:rgba(212,175,55,.12)}
.preview img{max-height:90px;margin:6px;border-radius:8px;border:1px solid rgba(255,255,255,.2)}
.toast-lite{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;
  background:linear-gradient(135deg,var(--crimson),#3a0010);color:#fff;padding:10px 16px;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.45);font-weight:700
}
footer{border-top:1px solid rgba(255,255,255,.15)}
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="brand" href="#">
      <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo.png" alt="Ø´Ø¹Ø§Ø±">
      <span>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</span>
    </a>
    <div class="ms-auto d-flex gap-2">
      <button id="btnExportXLSX" class="btn btn-outline-gold btn-sm"><i class="fa-solid fa-file-excel ms-1"></i> ØªØµØ¯ÙŠØ± Excel</button>
      <button id="btnExportPDF" class="btn btn-outline-gold btn-sm"><i class="fa-solid fa-file-pdf ms-1"></i> ØªØµØ¯ÙŠØ± PDF</button>
      <button id="btnRefreshAll" class="btn btn-gold btn-sm"><i class="fa-solid fa-rotate ms-1"></i> ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>
</nav>

<section class="tabbar">
  <div class="container">
    <ul class="nav nav-tabs" id="tabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button">Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-log" type="button">Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cert" type="button">Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-add" type="button">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button></li>
    </ul>
  </div>
</section>

<div class="tab-content">
  <!-- Dashboard -->
  <div id="tab-dashboard" class="tab-pane fade show active">
    <div class="container py-4">
      <div class="row g-3">
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi gold h-100">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</div>
            <div id="kpiAssets" class="value">â€”</div>
            <div class="hint">Ø§Ù„Ù…ÙØ³Ø¬Ù‘Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi green h-100">
            <div class="label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
            <div id="kpiDonePct" class="value">â€”%</div>
            <div class="hint">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi red h-100">
            <div class="label">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø±Ø¬Ø©</div>
            <div id="kpiCritical" class="value">0</div>
            <div class="hint">ØªØªØ·Ù„Ø¨ ØªØ¯Ø®Ù„Ù‹Ø§ Ø¹Ø§Ø¬Ù„Ù‹Ø§</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi orange h-100">
            <div class="label">ØºÙŠØ± Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div>
            <div id="kpiUncompleted" class="value">0</div>
            <div class="hint">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±/Ù…ØªØ£Ø®Ø±Ø©</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi blue h-100">
            <div class="label">Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
            <div id="kpiMTTR" class="value">â€”</div>
            <div class="hint">Ø£ÙŠØ§Ù…</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card-glass kpi blue h-100">
            <div class="label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù</div>
            <div id="kpiDowntime" class="value">0</div>
            <div class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±</div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-lg-6">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ù…Ù†Ø¬Ø²)</h5>
            <canvas id="lineMonthly" height="220"></canvas>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</h5>
            <canvas id="donutStatus" height="220"></canvas>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="card-glass p-3 h-100">
            <h5 class="mb-3">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</h5>
            <ul id="alertsList" class="list-unstyled m-0 small"></ul>
            <div class="smallmuted mt-2">ğŸŸ  Ø®Ù„Ø§Ù„ 10 Ø£ÙŠØ§Ù… â€¢ ğŸ”´ Ù…ØªØ¬Ø§ÙˆØ²Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯</div>
          </div>
        </div>
      </div>

      <div class="card-glass p-3 mt-3">
        <h5 class="mb-3">Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
        <canvas id="barDept" height="240"></canvas>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div id="tab-log" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-3 mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="filterDept" class="form-select">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="filterType" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="PM">ÙˆÙ‚Ø§Ø¦ÙŠØ© (PM)</option>
              <option value="CM">ØªØµØ­ÙŠØ­ÙŠØ© (CM)</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="filterStatus" class="form-select">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
              <option value="Pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="Overdue">Ù…ØªØ£Ø®Ø±Ø©</option>
              <option value="Critical">Ø­Ø±Ø¬Ø©</option>
              <option value="OutOfService">Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
              <option value="DueSoon">Ù‚Ø±ÙŠØ¨Ø©</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ø¨Ø­Ø«</label>
            <input id="searchBox" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„ÙÙ†ÙŠØŒ Ø§Ù„Ù‚Ø³Ù…ØŒ ...">
          </div>
          <div class="col-md-2 d-grid">
            <button id="btnShowAlertsOnly" class="btn btn-crimson"><i class="fa-solid fa-triangle-exclamation ms-1"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
          </div>
        </div>
      </div>

      <div class="card-glass p-3">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„ÙÙ†ÙŠ</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th><th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th><th>Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr><td colspan="13" class="text-center py-4"><div class="spinner-border text-light"></div><div class="smallmuted mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between mt-2 smallmuted">
          <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="totalCount">0</b></div>
          <div>Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: <b id="viewCount">0</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Certificates -->
  <div id="tab-cert" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</h5>
          <button id="btnGenMissingCerts" class="btn btn-gold btn-sm"><i class="fa-solid fa-magic ms-1"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© (Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙÙ‚Ø·)</button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr><th>#</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„ÙÙ†ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
            </thead>
            <tbody id="certBody"><tr><td colspan="8" class="text-center py-4">â€”</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task -->
  <div id="tab-add" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-3">
        <h5 class="mb-3">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ØµÙŠØ§Ù†Ø©</h5>
        <form id="formNew" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="fDepartment" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„ÙÙ†ÙŠ</label>
            <select id="fStaff" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <select id="fTaskType" class="form-select" required>
              <option value="PM">ÙˆÙ‚Ø§Ø¦ÙŠØ© (PM)</option>
              <option value="CM">ØªØµØ­ÙŠØ­ÙŠØ© (CM)</option>
            </select>
          </div>

          <div class="col-md-8">
            <label class="form-label">Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
            <select id="fAsset" class="form-select" required>
              <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ù‹Ø§ â€”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
            <select id="fPriority" class="form-select">
              <option value="High">Ø¹Ø§Ù„ÙŠØ©</option>
              <option value="Medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
              <option value="Low">Ù…Ù†Ø®ÙØ¶Ø©</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</label>
            <input id="fStart" type="date" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
            <select id="fFreq" class="form-select">
              <option value="">Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</option>
              <option value="W1">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
              <option value="M1">Ø´Ù‡Ø±ÙŠ</option>
              <option value="M3">ÙƒÙ„ 3 Ø£Ø´Ù‡Ø±</option>
              <option value="M6">ÙƒÙ„ 6 Ø£Ø´Ù‡Ø±</option>
              <option value="M12">Ø³Ù†ÙˆÙŠ</option>
              <option value="Y2">ÙƒÙ„ Ø³Ù†ØªÙŠÙ†</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
            <input id="fDue" type="date" class="form-control" readonly>
          </div>

          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="fStatus" class="form-select" required>
              <option value="Pending" selected>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="Completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
              <option value="Overdue">Ù…ØªØ£Ø®Ø±Ø©</option>
              <option value="Critical">Ø­Ø±Ø¬Ø©</option>
              <option value="OutOfService">Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù</label>
            <input id="fDown" type="number" min="0" step="0.1" class="form-control" value="0">
          </div>
          <div class="col-md-4">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø¥Ù† ÙˆÙØ¬Ø¯)</label>
            <input id="fCompleted" type="date" class="form-control">
          </div>

          <div class="col-12">
            <label class="form-label">Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
            <div id="dropzone" class="dropzone">
              <i class="fa-solid fa-cloud-arrow-up fa-2x mb-2"></i>
              <div class="smallmuted">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± â€” Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ù„ÙØ§Øª</div>
              <input id="fFiles" type="file" class="d-none" accept="image/*,.pdf,.doc,.docx,.xlsx,.xls" multiple>
              <div id="dzPreview" class="preview mt-2"></div>
              <div id="dzInfo" class="small mt-1"></div>
              <div class="progress d-none" id="dzProgress"><div class="progress-bar bg-warning" style="width:0%"></div></div>
            </div>
          </div>

          <div class="col-12 d-flex gap-2 justify-content-end">
            <button type="button" id="btnReset" class="btn btn-outline-gold"><i class="fa-solid fa-rotate-left ms-1"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button type="submit" class="btn btn-gold"><i class="fa-solid fa-floppy-disk ms-1"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<footer class="container py-4">
  <div class="d-flex flex-column flex-md-row align-items-center justify-content-between smallmuted">
    <div>Â© 2025 Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</div>
    <div><i class="fa-solid fa-envelope ms-1"></i> support@makkahclinic.com</div>
  </div>
</footer>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* =================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ =================== */
const API_URL = "https://script.google.com/macros/s/AKfycbxw6oWSHKDjeZI6dsspS3PVVwbO9KO5UnjKGqDa_yP9cYAVjNHh6WMfQrdlpkF_A25--A/exec";
const CONFIG = { MAX_FILES:5, MAX_MB:10, AUTO_REFRESH_MS: 5*60*1000 };

/* =================== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =================== */
const App = {
  records: [],
  assetsMap: {},
  staff: [],
  charts: { donut:null, bar:null, line:null },
  filters: { dept:"", type:"", status:"", search:"", alertsOnly:false }
};

/* =================== Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø© =================== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function toast(msg, type="info"){
  const t=document.createElement('div');t.className='toast-lite';
  t.style.background = type==="error"
    ? "linear-gradient(135deg,#a30000,#d00000)"
    : type==="success" ? "linear-gradient(135deg,#147a3c,#28a745)" : t.style.background;
  t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);
}
function fmt(d){
  if(!d) return ""; const x=new Date(d); return isNaN(x)? String(d) : x.toLocaleDateString('ar-SA');
}
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function classify(r){
  if(r.Status==="Completed") return "Completed";
  if(r.Status==="OutOfService") return "OutOfService";
  if(r.Status==="Critical") return "Critical";
  const due = r.DueDate ? new Date(r.DueDate) : null;
  if(due){
    const today=new Date(); today.setHours(0,0,0,0);
    if(due < today) return "Overdue";
    const warn = addDays(today,10);
    if(due <= warn) return "DueSoon";
  }
  return r.Status || "Pending";
}
function animateValue(el, to, suffix=""){
  const start=0, dur=900, t0=performance.now();
  function step(now){const p=Math.min(1,(now-t0)/dur); el.textContent = Math.round(start+(to-start)*p) + suffix; if(p<1) requestAnimationFrame(step);}
  requestAnimationFrame(step);
}

/* =================== Ø·Ø¨Ù‚Ø© API =================== */
const API = {
  async _get(action, params={}){
    const url = new URL(API_URL); url.searchParams.set('action', action);
    Object.entries(params).forEach(([k,v])=>{ if(v!==undefined && v!==null) url.searchParams.set(k,v) });
    const r = await fetch(url.toString(), {method:'GET'});
    const j = await r.json(); if(j.error || j.success===false) throw new Error(j.error||'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return j.data || j;
  },
  async _post(action, params={}){
    const body = new URLSearchParams({action}); for(const [k,v] of Object.entries(params)){ if(v!==undefined && v!==null) body.append(k, v); }
    const r = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body});
    const j = await r.json(); if(j.error || j.success===false) throw new Error(j.error||'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'); return j.data || j;
  },
  getRecords(){ return this._get('getRecords'); },
  getAssets(){ return this._get('getAssets'); },
  getStaff(){  return this._get('getStaff'); },
  getKPIs(){   return this._get('getKPIs'); },
  addRecord(payload){ return this._post('addRecord', payload); },
  deleteRecord(payload){ return this._post('deleteRecord', payload); },
  updateRecord(payload){ return this._post('updateRecord', payload); },
  uploadFile({department,fileName,mimeType,base64,recordId,timestamp}){
    return this._post('uploadFile',{department,fileName,mimeType,fileData:base64,recordId,timestamp});
  },
  generateCertificate({id,timestamp}){
    return this._post('generateCertificate',{id,timestamp});
  },
  exportData(format){ return this._get('export',{format}); }
};

/* =================== Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ =================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const today = new Date().toISOString().split('T')[0]; $('#fStart').value = today;

  bindEvents();
  await loadAll();

  setInterval(loadAll, CONFIG.AUTO_REFRESH_MS);
});

/* =================== Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« =================== */
function bindEvents(){
  // Ø§Ù„ÙÙ„Ø§ØªØ±
  $('#filterDept').addEventListener('change', e=>{ App.filters.dept=e.target.value; renderLog(); renderCerts(); });
  $('#filterType').addEventListener('change', e=>{ App.filters.type=e.target.value; renderLog(); renderCerts(); });
  $('#filterStatus').addEventListener('change', e=>{ App.filters.status=e.target.value; renderLog(); renderCerts(); });
  $('#searchBox').addEventListener('input', e=>{ App.filters.search=e.target.value.toLowerCase(); renderLog(); renderCerts(); });
  $('#btnShowAlertsOnly').addEventListener('click', ()=>{ App.filters.alertsOnly=!App.filters.alertsOnly; renderLog(); });

  // ØªØ¨ÙˆÙŠØ¨ "Ø¥Ø¶Ø§ÙØ©" â€“ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…
  $('#fFreq').addEventListener('change', calcNextDue);
  $('#fStart').addEventListener('change', calcNextDue);

  // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… â†’ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© + Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ø±ÙØ¹ ØµÙˆØ±Ø©
  $('#fDepartment').addEventListener('change', ()=>{
    const dep = $('#fDepartment').value;
    const arr = App.assetsMap[dep] || [];
    $('#fAsset').innerHTML = arr.length
      ? '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø§Ø² â€”</option>'+arr.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')
      : '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø©</option>';
  });

  // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Ø¥Ù„Ø²Ø§Ù…ÙŠ)
  const dz = $('#dropzone'), fi = $('#fFiles');
  dz.addEventListener('click', ()=> fi.click());
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', ()=> dz.classList.remove('drag'));
  dz.addEventListener('drop', e=>{ e.preventDefault(); dz.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
  fi.addEventListener('change', ()=> handleFiles(fi.files));

  // Ø­ÙØ¸/Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
  $('#formNew').addEventListener('submit', submitNew);
  $('#btnReset').addEventListener('click', ()=>{ $('#formNew').reset(); $('#dzPreview').innerHTML=''; $('#dzInfo').textContent=''; });

  // ØªØµØ¯ÙŠØ±
  $('#btnExportXLSX').addEventListener('click', async ()=>{
    try{ const r=await API.exportData('xlsx'); window.open(r.url,'_blank'); }catch(e){ toast('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Excel: '+e.message,'error'); }
  });
  $('#btnExportPDF').addEventListener('click', async ()=>{
    try{ const r=await API.exportData('pdf'); window.open(r.url,'_blank'); }catch(e){ toast('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: '+e.message,'error'); }
  });
  $('#btnRefreshAll').addEventListener('click', loadAll);

  // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©
  $('#btnGenMissingCerts').addEventListener('click', genMissingCerts);
}

/* =================== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ API =================== */
async function loadAll(){
  try{
    const [records, assets, staff, kpis] = await Promise.all([
      API.getRecords(), API.getAssets(), API.getStaff(), API.getKPIs().catch(()=>null)
    ]);
    App.records = records || [];
    App.assetsMap = assets || {};
    App.staff = staff || [];

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    const depts = Object.keys(App.assetsMap).sort();
    $('#filterDept').innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>'+ depts.map(d=>`<option>${d}</option>`).join('');
    $('#fDepartment').innerHTML = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>'+ depts.map(d=>`<option>${d}</option>`).join('');
    $('#fStaff').innerHTML = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>'+ (App.staff||[]).map(s=>`<option>${s}</option>`).join('');

    // Ù…Ø¤Ø´Ø±Ø§Øª
    updateKPIs(kpis);

    // Ø±Ø³ÙˆÙ…
    drawCharts();

    // Ø¬Ø¯Ø§ÙˆÙ„
    renderLog();
    renderCerts();

    toast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success');
  }catch(e){
    console.error(e);
    toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: '+e.message, 'error');
  }
}

/* =================== KPIs =================== */
function updateKPIs(k){
  // Ø¥Ù† Ù„Ù… ÙŠØ±Ø³Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± KPIsØŒ Ù†Ø­Ø³Ø¨Ù‡Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§
  const recs = App.records;
  const total = recs.length;
  const done = recs.filter(r=> (r.Status==='Completed')).length;
  const uncompleted = total - done;
  const critical = recs.filter(r=> classify(r)==='Critical' || classify(r)==='OutOfService').length;
  const downtime = recs.reduce((s,r)=> s + (Number(r.DowntimeHours)||0), 0);

  // MTTR
  const completed = recs.filter(r => r.Status==='Completed' && r.StartDate && r.CompletedDate);
  const mttr = completed.length
    ? Math.round( completed.reduce((s,r)=> (s + ((new Date(r.CompletedDate)-new Date(r.StartDate))/(1000*3600*24))), 0) / completed.length )
    : 0;

  // Ø§Ù„Ø£ØµÙˆÙ„ Ù…Ù† Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
  const assets = Object.values(App.assetsMap).reduce((a,arr)=> a + (arr?arr.length:0), 0);

  animateValue($('#kpiAssets'), assets);
  animateValue($('#kpiDonePct'), total? Math.round(done/total*100):0, '%');
  animateValue($('#kpiCritical'), critical);
  animateValue($('#kpiUncompleted'), uncompleted);
  animateValue($('#kpiMTTR'), mttr);
  animateValue($('#kpiDowntime'), Math.round(downtime));
  
  // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  const alerts = recs
    .filter(r=>['Overdue','Critical','OutOfService','DueSoon'].includes(classify(r)))
    .slice(0,8);
  $('#alertsList').innerHTML = alerts.map(r=>{
    const c = classify(r);
    const ico = c==='Overdue'||c==='Critical'||c==='OutOfService' ? 'ğŸ”´' : 'ğŸŸ ';
    return `<li class="mb-1">${ico} <b>${r.AssetName||r.AssetID||'-'}</b> â€” ${r.Department||''} â€¢ Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${fmt(r.DueDate)}</li>`;
  }).join('') || '<div class="smallmuted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>';
}

/* =================== Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© =================== */
function drawCharts(){
  const ctxD = $('#donutStatus').getContext('2d');
  const ctxB = $('#barDept').getContext('2d');
  const ctxL = $('#lineMonthly').getContext('2d');
  // Ø¨ÙŠØ§Ù†Ø§Øª
  const recs = App.records;
  const countBy = (fn)=> recs.reduce((m,r)=>{ const k=fn(r); m[k]=(m[k]||0)+1; return m; },{});
  const st = countBy(r => classify(r));
  const depts = {};
  recs.forEach(r=>{
    const d=r.Department||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    depts[d] = depts[d] || {Completed:0,Pending:0,Overdue:0};
    const c = classify(r);
    if(c==='Completed') depts[d].Completed++;
    else if(c==='Overdue' || c==='Critical' || c==='OutOfService') depts[d].Overdue++;
    else depts[d].Pending++;
  });
  const months = Array.from({length:12}).map((_,i)=>i);
  const monthLab = ['ÙŠÙ†Ø§','ÙØ¨Ø±','Ù…Ø§Ø±','Ø£Ø¨Ø±','Ù…Ø§ÙŠ','ÙŠÙˆÙ†','ÙŠÙˆÙ„','Ø£ØºØ³','Ø³Ø¨Øª','Ø£ÙƒØª','Ù†ÙˆÙ','Ø¯ÙŠØ³'];
  const series = Array(12).fill(0);
  recs.filter(r=> r.Status==='Completed' && r.CompletedDate).forEach(r=>{
    const m = new Date(r.CompletedDate).getMonth(); series[m] += 1;
  });

  App.charts.donut?.destroy();
  App.charts.bar?.destroy();
  App.charts.line?.destroy();

  App.charts.donut = new Chart(ctxD,{
    type:'doughnut',
    data:{ labels:['Ù…ÙƒØªÙ…Ù„Ø©','Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±','Ù…ØªØ£Ø®Ø±Ø©/Ø­Ø±Ø¬Ø©','Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©'], datasets:[{
      data:[st.Completed||0, st.Pending||0, (st.Overdue||0)+(st.Critical||0), st.OutOfService||0],
      backgroundColor:['#5fd997','#ffc44d','#ff6b6b','#9ea6b0'],
      borderColor:['#2f8d5f','#a87b11','#b00020','#6c757d'], borderWidth:2
    }]},
    options:{ plugins:{ legend:{position:'bottom', labels:{color:'#fff'} } } }
  });

  const dKeys = Object.keys(depts);
  App.charts.bar = new Chart(ctxB,{
    type:'bar',
    data:{
      labels:dKeys, datasets:[
        {label:'Ù…ÙƒØªÙ…Ù„Ø©', data:dKeys.map(k=>depts[k].Completed), backgroundColor:'rgba(40,167,69,.8)'},
        {label:'Ù…ØªØ£Ø®Ø±Ø©', data:dKeys.map(k=>depts[k].Overdue),   backgroundColor:'rgba(220,53,69,.85)'},
        {label:'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', data:dKeys.map(k=>depts[k].Pending), backgroundColor:'rgba(255,193,7,.85)'}
      ]
    },
    options:{ plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}}}
  });

  App.charts.line = new Chart(ctxL,{
    type:'line',
    data:{ labels:monthLab, datasets:[{label:'Ù…Ù†Ø¬Ø² Ø´Ù‡Ø±ÙŠÙ‹Ø§', data:months.map(i=>series[i]),
      borderWidth:3, fill:true, tension:.3, backgroundColor:'rgba(212,175,55,.15)', borderColor:'#d4af37'}]
    },
    options:{ plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}}}
  });
}

/* =================== Ø§Ù„Ø¬Ø¯ÙˆÙ„ =================== */
function renderLog(){
  const f = App.filters;
  const filtered = (App.records||[]).filter(r=>{
    if(f.dept && r.Department!==f.dept) return false;
    if(f.type && r.TaskType!==f.type) return false;
    const cls = classify(r);
    if(f.status && cls!==f.status) return false;
    if(f.alertsOnly && !['Overdue','Critical','OutOfService','DueSoon'].includes(cls)) return false;
    if(f.search){
      const s=f.search;
      const text = Object.values(r).join(' ').toLowerCase();
      if(!text.includes(s)) return false;
    }
    return true;
  }).sort((a,b)=> new Date(b.Timestamp) - new Date(a.Timestamp));

  const tb = $('#logBody');
  if(!filtered.length){
    tb.innerHTML = '<tr><td colspan="13" class="text-center py-4 smallmuted"><i class="fa-solid fa-inbox ms-1"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
    $('#viewCount').textContent = 0; $('#totalCount').textContent = App.records.length; return;
  }

  tb.innerHTML = filtered.map(r=>{
    const cls = classify(r);
    const bClass = cls==='Completed'?'completed':cls==='Overdue'?'overdue':cls==='Critical'?'critical':cls==='DueSoon'?'due':cls==='OutOfService'?'critical':'pending';
    const files = [];
    if(r.File){ String(r.File).split(',').forEach(u=>{u=u.trim(); if(u && u!=='undefined') files.push(`<a href="${u}" target="_blank" class="me-2 text-success"><i class="fa-solid fa-paperclip"></i></a>`); }); }
    const certBtn = (r.Status==='Completed' && (!r.Certificate || r.Certificate==='')) 
      ? `<button class="btn btn-sm btn-gold gen-cert" data-id="${r.ID||''}" data-ts="${r.Timestamp||''}"><i class="fa-solid fa-award"></i></button>`
      : (r.Certificate ? `<a class="btn btn-sm btn-outline-gold" target="_blank" href="${r.Certificate}"><i class="fa-solid fa-file-pdf"></i></a>` : 'â€”');

    return `<tr>
      <td>${fmt(r.Timestamp)}</td>
      <td><b>${r.Department||'-'}</b></td>
      <td>${r.Staff||'-'}</td>
      <td title="${r.AssetID||''}">${r.AssetName||r.AssetID||'-'}</td>
      <td><span class="badge bg-primary">${r.TaskType||'-'}</span></td>
      <td>${fmt(r.StartDate)}</td>
      <td>${fmt(r.DueDate)}</td>
      <td>${fmt(r.CompletedDate)}</td>
      <td><span class="badge-status ${bClass}">${r.Status||cls}</span></td>
      <td>${r.Priority||'-'}</td>
      <td>${files.join('')||'â€”'}</td>
      <td>${certBtn}</td>
      <td>
        <button class="btn btn-sm btn-outline-danger del-rec" data-id="${r.ID||''}" data-ts="${r.Timestamp||''}"><i class="fa-solid fa-trash"></i></button>
      </td>
    </tr>`;
  }).join('');

  // Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
  $$('.del-rec').forEach(b=> b.addEventListener('click', async function(){
    if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
    try{ await API.deleteRecord({id:this.dataset.id||'', timestamp:this.dataset.ts||''}); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','success'); await loadAll(); }
    catch(e){ toast('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: '+e.message,'error'); }
  }));
  $$('.gen-cert').forEach(b=> b.addEventListener('click', async function(){
    try{
      const r = await API.generateCertificate({id:this.dataset.id||'', timestamp:this.dataset.ts||''});
      toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©','success');
      if(r && r.url) window.open(r.url,'_blank');
      await loadAll();
    }catch(e){ toast('ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: '+e.message,'error'); }
  }));

  $('#viewCount').textContent = filtered.length;
  $('#totalCount').textContent = App.records.length;
}
function renderCerts(){
  const body = $('#certBody');
  const recs = App.records.filter(r=> r.Status==='Completed');
  if(!recs.length){ body.innerHTML='<tr><td colspan="8" class="text-center py-4 smallmuted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø©</td></tr>'; return; }
  const f = App.filters;
  const arr = recs.filter(r=>{
    if(f.dept && r.Department!==f.dept) return false;
    if(f.search){ const s=f.search; if(!Object.values(r).join(' ').toLowerCase().includes(s)) return false; }
    return true;
  });
  body.innerHTML = arr.map((r,i)=> `<tr>
    <td>${i+1}</td><td>${r.Department||'-'}</td><td>${r.AssetName||r.AssetID||'-'}</td><td>${r.Staff||'-'}</td>
    <td>${fmt(r.CompletedDate||r.StartDate||r.Timestamp)}</td>
    <td>${r.Status||'-'}</td>
    <td>${r.Certificate? `<a target="_blank" href="${r.Certificate}" class="btn btn-sm btn-outline-gold"><i class="fa-solid fa-file-pdf"></i> ÙØªØ­</a>`:'â€”'}</td>
    <td>${
      r.Certificate
      ? `<a target="_blank" href="${r.Certificate}" class="btn btn-sm btn-gold"><i class="fa-solid fa-download"></i></a>`
      : `<button class="btn btn-sm btn-gold gen-cert" data-id="${r.ID||''}" data-ts="${r.Timestamp||''}"><i class="fa-solid fa-award"></i> ØªÙˆÙ„ÙŠØ¯</button>`
    }</td></tr>`).join('');
  $$('.gen-cert').forEach(b=> b.addEventListener('click', async function(){
    try{ const r= await API.generateCertificate({id:this.dataset.id||'', timestamp:this.dataset.ts||''}); toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©','success'); if(r && r.url) window.open(r.url,'_blank'); await loadAll(); }
    catch(e){ toast('ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: '+e.message,'error'); }
  }));
}

/* =================== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© =================== */
function calcNextDue(){
  const s=$('#fStart').value, f=$('#fFreq').value; if(!s||!f){ $('#fDue').value=''; return; }
  const d=new Date(s);
  if(f==='W1') d.setDate(d.getDate()+7);
  if(f==='M1') d.setMonth(d.getMonth()+1);
  if(f==='M3') d.setMonth(d.getMonth()+3);
  if(f==='M6') d.setMonth(d.getMonth()+6);
  if(f==='M12') d.setMonth(d.getMonth()+12);
  if(f==='Y2') d.setFullYear(d.getFullYear()+2);
  $('#fDue').value = d.toISOString().split('T')[0];
}
let selectedFiles = [];
function handleFiles(files){
  const list = Array.from(files||[]);
  if(list.length + selectedFiles.length > CONFIG.MAX_FILES){ toast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…Ù„ÙØ§Øª','error'); return; }
  for(const f of list){
    if(f.size > CONFIG.MAX_MB*1024*1024){ toast(`Ø§Ù„Ù…Ù„Ù ${f.name} ÙŠØªØ¬Ø§ÙˆØ² ${CONFIG.MAX_MB}MB`,'error'); continue; }
    selectedFiles.push(f);
  }
  const pv = $('#dzPreview'); pv.innerHTML=''; selectedFiles.forEach(f=>{
    if(f.type.startsWith('image/')){
      const img=document.createElement('img'); const r=new FileReader(); r.onload=e=> img.src=e.target.result; r.readAsDataURL(f); pv.appendChild(img);
    }else{
      const d=document.createElement('div'); d.className='badge bg-dark me-2'; d.textContent = f.name; pv.appendChild(d);
    }
  });
  $('#dzInfo').textContent = selectedFiles.length ? `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${selectedFiles.length} Ù…Ù„Ù` : '';
}
async function submitNew(ev){
  ev.preventDefault();
  if(!selectedFiles.length){ toast('Ø±ÙØ¹ ØµÙˆØ±Ø©/Ù…Ø±ÙÙ‚ Ø¥Ù„Ø²Ø§Ù…ÙŠ','error'); return; }
  const dep=$('#fDepartment').value, staff=$('#fStaff').value, type=$('#fTaskType').value;
  const assetSel = $('#fAsset'), assetID=assetSel.value, assetName = assetSel.selectedOptions[0]?.textContent || assetID;
  if(!dep||!staff||!type||!assetID||!$('#fStart').value){ toast('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„','error'); return; }

  const payload = {
    department:dep, staff:staff, taskType:type,
    assetID:assetID, assetName:assetName,
    startDate:$('#fStart').value, dueDate:$('#fDue').value, completedDate:$('#fCompleted').value,
    status:$('#fStatus').value, priority:$('#fPriority').value,
    downtimeHours:$('#fDown').value||'0', notes:''
  };
  try{
    const res = await API.addRecord(payload);
    const rec = res.record || res; const id = rec.ID || '';
    // Ø±ÙØ¹ ÙƒÙ„ Ù…Ù„Ù
    const prog = $('#dzProgress'), bar=prog.querySelector('.progress-bar'); prog.classList.remove('d-none');
    for(let i=0;i<selectedFiles.length;i++){
      const f = selectedFiles[i];
      const base64 = await fileToBase64(f);
      await API.uploadFile({department:dep, fileName:f.name, mimeType:f.type||'application/octet-stream', base64, recordId:id});
      bar.style.width = ((i+1)/selectedFiles.length*100).toFixed(0)+'%';
    }
    prog.classList.add('d-none'); bar.style.width='0%';
    toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª','success');
    selectedFiles=[]; $('#formNew').reset(); $('#dzPreview').innerHTML=''; $('#dzInfo').textContent='';
    await loadAll();
  }catch(e){ toast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+e.message,'error'); }
}
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader(); r.onload=e=> resolve(e.target.result.split(',')[1]); r.onerror=()=>reject(new Error('file read error')); r.readAsDataURL(file);
  });
}
async function genMissingCerts(){
  const toGen = App.records.filter(r=> r.Status==='Completed' && (!r.Certificate || r.Certificate===''));
  if(!toGen.length){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª Ù†Ø§Ù‚ØµØ©','info'); return; }
  for(const r of toGen){
    try{ await API.generateCertificate({id:r.ID||'', timestamp:r.Timestamp||''}); }catch(e){ console.warn(e); }
  }
  toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©','success'); await loadAll();
}
</script>
</body>
</html>
