<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>لوحة صيانة الأجهزة — مجمع مكة الطبي</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<style>
:root{
  /* لوحة ألوان واضحة على خلفية داكنة (تباين مرتفع) */
  --bg:#0b1a12; --panel:#102518; --panel-border:#1c3b28; --ink:#eaf6ee;
  --primary:#16a34a; --primary-2:#0e7a38;
  --warn:#f59e0b; --danger:#dc2626; --muted:#9aa8a1; --gray:#6b7280;
}

*{font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji'; box-sizing:border-box}
body{background:linear-gradient(135deg,#08140f,var(--bg)); color:var(--ink); margin:0; min-height:100vh}
.navbar{background:#08160f; border-bottom:1px solid var(--panel-border)}
.glass{background:rgba(255,255,255,.04); border:1px solid var(--panel-border); border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.3)}
.btn-green{background:linear-gradient(135deg,var(--primary-2),var(--primary)); border:none; color:#fff}
.btn-green:hover{filter:brightness(1.05)}
.card-kpi{padding:18px; border-radius:14px; border:1px solid var(--panel-border)}
.card-kpi .title{font-size:.9rem; color:var(--muted)}
.card-kpi .val{font-size:36px; font-weight:800}
.card-kpi .hint{font-size:.8rem; color:var(--muted)}
.kpi-badge{background:#0f2419; color:#a7f3d0; border:1px solid var(--panel-border); padding:2px 8px; border-radius:999px; font-size:.75rem}
.table{color:#fff}
.table thead th{background:#0f2419; color:#dff4e7; border-bottom:1px solid var(--panel-border)}
.table tbody tr:hover{background:rgba(255,255,255,.06)}
.badge{font-weight:700}
.status-ok{background:#15803d}
.status-pending{background:#f59e0b}
.status-over{background:#dc2626}
.status-crit{background:linear-gradient(90deg,#7f1d1d,#dc2626)}
.status-oos{background:#6b7280}
.toast-lite{position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#0f2419; color:#bef7d8; border:1px solid var(--panel-border); padding:12px 16px; border-radius:10px; z-index:9999}
.loading-spinner{display:inline-block; width:18px; height:18px; border:3px solid rgba(255,255,255,.25); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.file-upload{border:2px dashed var(--panel-border); border-radius:10px; padding:14px; background:#0c1d14}
.file-actions .btn{min-width:140px}
a.link{color:#86efac; text-decoration:none}
a.link:hover{text-decoration:underline}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <div class="d-flex align-items-center gap-2">
      <div class="fw-bold text-white">لوحة صيانة الأجهزة الطبية</div>
      <span class="ms-2 kpi-badge d-none d-md-inline">إجمالي الأجهزة: <span id="kpiTotalAssets">—</span></span>
    </div>
    <div class="ms-auto d-flex gap-2">
      <button class="btn btn-green btn-sm" data-bs-toggle="modal" data-bs-target="#modalNew"><i class="fa-solid fa-plus ms-1"></i> إضافة مهمة</button>
      <button id="btnPrint" class="btn btn-outline-light btn-sm"><i class="fa-solid fa-print ms-1"></i> طباعة</button>
    </div>
  </div>
</nav>

<section class="container py-4">

  <!-- KPIs -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="title">المهام غير المكتملة</div>
        <div id="kpiUnserviced" class="val">—</div>
        <div class="hint">كل الحالات عدا “مكتملة”</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="title">المتأخرة / الحرجة</div>
        <div id="kpiOverCrit" class="val">—</div>
        <div class="hint">تتطلب تدخلاً سريعًا</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="title">مكتملة (آخر 30 يوم)</div>
        <div id="kpiCompleted30" class="val">—</div>
        <div class="hint">بحسب تاريخ الإغلاق</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="glass card-kpi h-100">
        <div class="title">نسبة الجاهزية</div>
        <div id="kpiAvail" class="val">—%</div>
        <div class="hint">المكتملة ÷ إجمالي المهام</div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="glass p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="m-0">حالة الصيانة حسب الأقسام</h6>
          <span class="kpi-badge">إجمالي الأجهزة: <span id="kpiTotalAssets2">—</span></span>
        </div>
        <canvas id="deptChart" height="250"></canvas>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="glass p-3 h-100">
        <h6 class="m-0 mb-2">توزيع حالات المهام</h6>
        <canvas id="statusChart" height="250"></canvas>
      </div>
    </div>
  </div>

  <!-- Filters + Table -->
  <div class="glass p-3 mt-4">
    <div class="d-flex flex-wrap gap-2 mb-3">
      <select id="filterDept" class="form-select form-select-sm bg-dark text-light border-secondary" style="max-width:220px"><option value="">جميع الأقسام</option></select>
      <select id="filterType" class="form-select form-select-sm bg-dark text-light border-secondary" style="max-width:180px">
        <option value="">كل الأنواع</option><option value="PM">صيانة وقائية</option><option value="CM">صيانة تصحيحية</option></select>
      <select id="filterStatus" class="form-select form-select-sm bg-dark text-light border-secondary" style="max-width:200px">
        <option value="">جميع الحالات</option><option value="Completed">مكتملة</option><option value="Pending">قيد الانتظار</option><option value="Overdue">متأخرة</option><option value="Critical">حرجة</option><option value="OutOfService">خارج الخدمة</option></select>
      <input id="searchBox" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="بحث..." style="max-width:220px"/>
      <div class="ms-auto small text-muted">إجمالي السجلات: <span id="totalCount">0</span> • المعروضة: <span id="viewCount">0</span></div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead><tr>
          <th>التاريخ</th><th>القسم</th><th>الفني</th><th>الجهاز</th><th>النوع</th>
          <th>التنفيذ</th><th>الاستحقاق</th><th>الإغلاق</th><th>الحالة</th><th>الأولوية</th>
          <th>المرفقات</th><th>الشهادة</th><th>إجراءات</th>
        </tr></thead>
        <tbody id="logBody"><tr><td colspan="13" class="text-center py-4"><div class="loading-spinner me-2"></div>جاري التحميل...</td></tr></tbody>
      </table>
    </div>
  </div>

</section>

<!-- نافذة إضافة مهمة -->
<div class="modal fade" id="modalNew" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content glass border-0">
      <div class="modal-header border-secondary"><h5 class="modal-title text-white"><i class="fa-solid fa-plus ms-1"></i> إضافة مهمة صيانة</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="formNew" class="row g-3">
          <div class="col-md-6">
            <label class="form-label text-white">القسم</label>
            <select id="fDepartment" required class="form-select bg-dark text-light border-secondary"><option value="">جاري التحميل...</option></select>
          </div>
          <div class="col-md-6">
            <label class="form-label text-white">الفني المسؤول</label>
            <select id="fStaff" required class="form-select bg-dark text-light border-secondary"><option value="">جاري التحميل...</option></select>
          </div>
          <div class="col-md-4">
            <label class="form-label text-white">نوع المهمة</label>
            <select id="fTaskType" required class="form-select bg-dark text-light border-secondary">
              <option value="PM">صيانة وقائية (PM)</option><option value="CM">صيانة تصحيحية (CM)</option></select>
          </div>
          <div class="col-md-8">
            <label class="form-label text-white">الجهاز/المعدة</label>
            <select id="fAsset" required class="form-select bg-dark text-light border-secondary"><option value="">اختر القسم أولاً...</option></select>
          </div>
          <div class="col-md-4">
            <label class="form-label text-white">تاريخ التنفيذ</label>
            <input id="fServiceDate" type="date" required class="form-control bg-dark text-light border-secondary"/>
          </div>
          <div class="col-md-4">
            <label class="form-label text-white">التكرار</label>
            <select id="fFreq" class="form-select bg-dark text-light border-secondary">
              <option value="">بدون تكرار</option><option value="W1">أسبوعي</option><option value="M1">شهري</option>
              <option value="M3">كل 3 أشهر</option><option value="M6">كل 6 أشهر</option><option value="M12">سنوي</option></select>
          </div>
          <div class="col-md-4">
            <label class="form-label text-white">الاستحقاق القادم</label>
            <input id="fNextDue" type="date" readonly class="form-control bg-dark text-light border-secondary"/>
          </div>
          <div class="col-md-6">
            <label class="form-label text-white">الحالة</label>
            <select id="fStatus" required class="form-select bg-dark text-light border-secondary">
              <option value="Pending">قيد الانتظار</option><option value="Completed">مكتملة</option>
              <option value="Overdue">متأخرة</option><option value="Critical">حرجة</option><option value="OutOfService">خارج الخدمة</option></select>
          </div>
          <div class="col-md-6">
            <label class="form-label text-white">الأولوية</label>
            <select id="fPriority" class="form-select bg-dark text-light border-secondary">
              <option value="Medium">متوسطة</option><option value="High">عالية</option><option value="Low">منخفضة</option></select>
          </div>
          <div class="col-md-6">
            <label class="form-label text-white">وقت التوقف (ساعات)</label>
            <input id="fDown" type="number" step="0.1" min="0" class="form-control bg-dark text-light border-secondary" placeholder="0" value="0"/>
          </div>
          <div class="col-12">
            <label class="form-label text-white">ملاحظات</label>
            <textarea id="fNotes" rows="3" class="form-control bg-dark text-light border-secondary" placeholder="أي ملاحظات إضافية..."></textarea>
          </div>

          <!-- رفع ملف — تجربة واضحة وثابتة -->
          <div class="col-12">
            <label class="form-label text-white">المرفق (صورة/ملف) <span class="text-danger">*</span></label>
            <div class="file-upload">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 file-actions">
                <input type="file" id="fFile" class="form-control form-control-sm bg-dark text-light border-secondary" accept="image/*,.pdf,.doc,.docx" required style="max-width:320px">
                <button type="button" id="btnPick" class="btn btn-outline-light btn-sm"><i class="fa-regular fa-folder-open ms-1"></i> اختيار ملف</button>
                <div class="small text-muted">الحد الأقصى: 10MB</div>
              </div>
              <div id="filePreview" class="mt-2 small text-success"></div>
            </div>
          </div>

          <div class="col-12 pt-3 border-top border-secondary">
            <div class="d-flex justify-content-end gap-2">
              <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">إلغاء</button>
              <button id="btnSave" type="submit" class="btn btn-green"><i class="fa-solid fa-floppy-disk ms-1"></i> حفظ</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/** ===== إعدادات API ===== **/
const API_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec'; // ← ضع رابط الويب آب

/** ===== حالة التطبيق ===== **/
const CONFIG = { MAX_FILE_MB: 10 };
const AppState = { assetsMap:{}, staffList:[], records:[], charts:{dept:null,status:null}, filters:{department:'', type:'', status:'', search:''} };

/** ===== مساعدين ===== **/
const $ = (s)=>document.querySelector(s), $$=(s)=>document.querySelectorAll(s);
const toast = (m,t='success')=>{ const n=document.createElement('div'); n.className='toast-lite'; n.textContent=m; document.body.appendChild(n); setTimeout(()=>{n.style.opacity='0'; setTimeout(()=>n.remove(),300)}, t==='error'?5000:2500); };
function fmtDate(x){ if(!x) return ''; const d=new Date(x); return isNaN(d)? String(x): d.toLocaleDateString('ar-SA'); }
function classify(r){
  if(r.Status==='Completed') return 'Completed';
  if(r.Status==='OutOfService') return 'OutOfService';
  if(r.Status==='Critical') return 'Critical';
  const due=r.DueDate? new Date(r.DueDate):null;
  if(due){ const today=new Date(); today.setHours(0,0,0,0); if(due<today) return 'Overdue';
    const warn=new Date(today); warn.setDate(warn.getDate()+30); if(due<=warn) return 'Pending'; }
  return 'Pending';
}

/** ===== طبقة API (GET + POST) ===== **/
const Api = {
  async get(action, params={}){
    const url=new URL(API_URL); url.searchParams.set('action',action);
    Object.entries(params).forEach(([k,v])=>{ if(v!==undefined && v!==null) url.searchParams.set(k,v); });
    const res=await fetch(url.toString(),{method:'GET'}); const data=await res.json(); if(data.error) throw new Error(data.error); return data;
  },
  async post(action, params={}){
    const body=new URLSearchParams({action}); Object.entries(params).forEach(([k,v])=>{ if(v!==undefined && v!==null) body.append(k,v); });
    const res=await fetch(API_URL,{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body}); 
    const data=await res.json(); if(data.error) throw new Error(data.error); return data;
  },
  getRecords(){ return this.get('getRecords'); },
  getAssets(){  return this.get('getAssets');  },
  getStaff(){   return this.get('getStaff');   },
  addRecord(payload){ return this.post('addRecord', payload); },
  updateRecord(payload){ return this.post('updateRecord', payload); },
  deleteRecord(payload){ return this.post('deleteRecord', payload); },
  uploadFileBase64({fileBase64, department, fileName, mimeType}){ return this.post('uploadFile',{fileData:fileBase64, department, fileName, mimeType}); },
  generateCertificate(id,timestamp){ return this.post('generateCertificate', id?{id}:{timestamp}); }
};

/** ===== إدارة البيانات ===== **/
const Data = {
  async load(){
    try{
      const [recs, assets, staff] = await Promise.allSettled([Api.getRecords(), Api.getAssets(), Api.getStaff()]);
      AppState.records   = recs.status==='fulfilled'   ? recs.value   : [];
      AppState.assetsMap = assets.status==='fulfilled' ? assets.value : {};
      AppState.staffList = staff.status==='fulfilled'  ? staff.value  : [];
      UI.updateSelectors(); UI.updateKPIs(); UI.renderTable(); Charts.update();
      toast('تم تحميل البيانات');
    }catch(e){ console.error(e); toast('تعذّر التحميل: '+e.message,'error'); }
  },
  async addRecord(form){
    // رفع الملف أولاً
    const f=$('#fFile').files[0]; if(!f) throw new Error('الرجاء اختيار ملف');
    if(f.size > CONFIG.MAX_FILE_MB*1024*1024) throw new Error('حجم الملف أكبر من '+CONFIG.MAX_FILE_MB+'MB');

    const base64 = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(f); });
    const up = await Api.uploadFileBase64({ fileBase64:base64, department:form.department, fileName:f.name, mimeType:f.type||'application/octet-stream' });

    const payload = {
      department: form.department, staff: form.staff, taskType: form.taskType,
      assetID: form.assetID, assetName: form.assetName,
      startDate: form.startDate, dueDate: form.dueDate, completedDate: form.completedDate,
      status: form.status, priority: form.priority, downtimeHours: form.downtimeHours,
      notes: form.notes, file: up.fileUrl
    };
    const res = await Api.addRecord(payload);
    await this.load();
    return res;
  },
  async createCertificateFor(rec){
    const id = rec.id || rec.ID || rec.RecordID || null;
    const ts = id ? null : rec.Timestamp;
    const res = await Api.generateCertificate(id, ts);
    toast('تم إنشاء الشهادة'); await this.load(); return res;
  }
};

/** ===== واجهة المستخدم ===== **/
const UI = {
  updateSelectors(){
    const depts = Object.keys(AppState.assetsMap).sort();
    $('#filterDept').innerHTML = '<option value="">جميع الأقسام</option>' + depts.map(d=>`<option value="${d}">${d}</option>`).join('');
    $('#fDepartment').innerHTML= '<option value="">اختر القسم...</option>' + depts.map(d=>`<option value="${d}">${d}</option>`).join('');
    $('#fStaff').innerHTML     = '<option value="">اختر الفني...</option>' + AppState.staffList.map(s=>`<option value="${s}">${s}</option>`).join('');
    $('#fDepartment').onchange = function(){ const assets = AppState.assetsMap[this.value]||[]; $('#fAsset').innerHTML = assets.length? '<option value="">اختر الجهاز...</option>'+assets.map(a=>`<option value="${a.id}">${a.name}</option>`).join('') : '<option value="">لا توجد أجهزة</option>'; };
  },
  updateKPIs(){
    const recs = AppState.records;
    const totalAssets = Object.values(AppState.assetsMap).reduce((t,a)=>t+(a?a.length:0),0);
    $('#kpiTotalAssets').textContent = totalAssets; $('#kpiTotalAssets2').textContent = totalAssets;

    const unserviced = recs.filter(r=> classify(r)!=='Completed').length;
    $('#kpiUnserviced').textContent = unserviced;

    const overCrit = recs.filter(r=> ['Overdue','Critical'].includes(classify(r))).length;
    $('#kpiOverCrit').textContent = overCrit;

    const ago = new Date(); ago.setDate(ago.getDate()-30);
    const completed30 = recs.filter(r=> r.Status==='Completed' && new Date(r.CompletedDate)>=ago).length;
    $('#kpiCompleted30').textContent = completed30;

    const avail = recs.length ? Math.round(recs.filter(r=>r.Status==='Completed').length / recs.length * 100) : 0;
    $('#kpiAvail').textContent = avail + '%';
  },
  renderTable(){
    const f = AppState.filters;
    const rows = AppState.records.filter(r=>{
      if(f.department && r.Department!==f.department) return false;
      if(f.type && r.TaskType!==f.type) return false;
      if(f.status && classify(r)!==f.status) return false;
      if(f.search){ const s=f.search.toLowerCase(); return Object.values(r).some(v => String(v).toLowerCase().includes(s)); }
      return true;
    }).sort((a,b)=> new Date(b.Timestamp) - new Date(a.Timestamp));

    const tbody = $('#logBody');
    if(!rows.length){ tbody.innerHTML='<tr><td colspan="13" class="text-center py-4 text-muted"><i class="fa-regular fa-face-meh me-1"></i> لا توجد سجلات</td></tr>'; }
    else{
      tbody.innerHTML = rows.map(r=>{
        const stat = classify(r);
        const statClass = stat==='Completed'?'status-ok':stat==='Overdue'?'status-over':stat==='Critical'?'status-crit':stat==='OutOfService'?'status-oos':'status-pending';
        const priClass  = r.Priority==='High'?'bg-danger': r.Priority==='Medium'?'bg-warning':'bg-info';
        const fileLink  = r.File ? `<a class="link" href="${r.File}" target="_blank"><i class="fa-regular fa-file-lines ms-1"></i>عرض</a>` : '—';
        const certLink  = r.Certificate ? `<a class="link" href="${r.Certificate}" target="_blank"><i class="fa-solid fa-file-signature ms-1"></i>عرض/طباعة</a>` : `<button class="btn btn-sm btn-outline-light gen-cert" data-id="${r.id||r.ID||r.RecordID||''}" data-ts="${r.Timestamp||''}"><i class="fa-solid fa-scroll"></i> إنشاء</button>`;
        return `<tr>
          <td>${fmtDate(r.Timestamp)}</td>
          <td><strong>${r.Department||'—'}</strong></td>
          <td>${r.Staff||'—'}</td>
          <td title="${r.AssetID||''}">${r.AssetName||r.AssetID||'—'}</td>
          <td><span class="badge ${r.TaskType==='PM'?'bg-primary':'bg-warning'}">${r.TaskType||'—'}</span></td>
          <td>${fmtDate(r.StartDate)}</td>
          <td>${fmtDate(r.DueDate)}</td>
          <td>${fmtDate(r.CompletedDate)}</td>
          <td><span class="badge ${statClass}">${r.Status || stat}</span></td>
          <td>${r.Priority? `<span class="badge ${priClass}">${r.Priority}</span>`:'—'}</td>
          <td>${fileLink}</td>
          <td>${certLink}</td>
          <td><button class="btn btn-sm btn-outline-danger del" data-id="${r.id||r.ID||r.RecordID||''}" data-ts="${r.Timestamp||''}"><i class="fa-solid fa-trash"></i></button></td>
        </tr>`;
      }).join('');
      $$('.gen-cert').forEach(b=> b.onclick = async function(){
        try{
          const id = this.getAttribute('data-id') || null;
          const ts = this.getAttribute('data-ts') || null;
          const rec = { id, Timestamp: ts };
          await Data.createCertificateFor(rec);
        }catch(e){ toast('فشل إنشاء الشهادة: '+e.message,'error'); }
      });
      $$('.del').forEach(b=> b.onclick = ()=> toast('الحذف متاح لاحقًا','warning'));
    }
    $('#totalCount').textContent = AppState.records.length;
    $('#viewCount').textContent  = rows.length;
  }
};

/** ===== الرسوم ===== **/
const Charts = {
  init(){
    const deptCtx = $('#deptChart').getContext('2d');
    AppState.charts.dept = new Chart(deptCtx, {
      type:'bar',
      data:{ labels:[], datasets:[
        { label:'مكتملة', data:[], backgroundColor:'#16a34a' },
        { label:'متأخرة', data:[], backgroundColor:'#dc2626' },
        { label:'قيد الانتظار', data:[], backgroundColor:'#f59e0b' }
      ]},
      options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#e6ffe9' } } },
        scales:{ x:{ ticks:{ color:'#cfe9d7' }, grid:{ color:'rgba(255,255,255,.08)'} },
                 y:{ ticks:{ color:'#cfe9d7' }, grid:{ color:'rgba(255,255,255,.08)'} } }
      }
    });
    const statusCtx = $('#statusChart').getContext('2d');
    AppState.charts.status = new Chart(statusCtx, {
      type:'doughnut',
      data:{ labels:['مكتملة','قيد الانتظار','متأخرة','حرجة','خارج الخدمة'],
        datasets:[{ data:[0,0,0,0,0], backgroundColor:['#16a34a','#f59e0b','#dc2626','#7f1d1d','#6b7280'], borderWidth:0 }]},
      options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ color:'#e6ffe9' } } } }
    });
  },
  update(){
    const recs = AppState.records;
    const byDept = {};
    recs.forEach(r=>{ const d=r.Department||'غير مصنف', s=classify(r); byDept[d]=byDept[d]||{Completed:0,Pending:0,Overdue:0}; if(s==='Completed')byDept[d].Completed++; else if(s==='Overdue'||s==='Critical')byDept[d].Overdue++; else byDept[d].Pending++; });
    const labels = Object.keys(byDept);
    const completed = labels.map(d=>byDept[d].Completed);
    const overdue   = labels.map(d=>byDept[d].Overdue);
    const pending   = labels.map(d=>byDept[d].Pending);
    const D = AppState.charts.dept; if(D){ D.data.labels=labels; D.data.datasets[0].data=completed; D.data.datasets[1].data=overdue; D.data.datasets[2].data=pending; D.update(); }

    const counts = {Completed:0,Pending:0,Overdue:0,Critical:0,OutOfService:0};
    recs.forEach(r=> counts[classify(r)]++ );
    const S = AppState.charts.status; if(S){ S.data.datasets[0].data=[counts.Completed,counts.Pending,counts.Overdue,counts.Critical,counts.OutOfService]; S.update(); }
  }
};

/** ===== تهيئة الصفحة ===== **/
document.addEventListener('DOMContentLoaded', ()=>{
  Charts.init(); Data.load();
  $('#btnPrint').onclick = ()=> window.print();
  $('#filterDept').onchange   = e=>{ AppState.filters.department=e.target.value; UI.renderTable(); };
  $('#filterType').onchange   = e=>{ AppState.filters.type=e.target.value; UI.renderTable(); };
  $('#filterStatus').onchange = e=>{ AppState.filters.status=e.target.value; UI.renderTable(); };
  $('#searchBox').oninput     = e=>{ AppState.filters.search=e.target.value; UI.renderTable(); };

  // حساب تاريخ الاستحقاق القادم تلقائيًا
  $('#fServiceDate').onchange = calcNext; $('#fFreq').onchange = calcNext;
  function calcNext(){ const s=$('#fServiceDate').value, f=$('#fFreq').value; if(!s||!f){ $('#fNextDue').value=''; return; }
    const d=new Date(s); if(isNaN(d)) return; if(f==='W1')d.setDate(d.getDate()+7); if(f==='M1')d.setMonth(d.getMonth()+1);
    if(f==='M3')d.setMonth(d.getMonth()+3); if(f==='M6')d.setMonth(d.getMonth()+6); if(f==='M12')d.setFullYear(d.getFullYear()+1);
    $('#fNextDue').value=d.toISOString().split('T')[0]; }

  // تجربة رفع ثابتة: زر يفتح اختيار الملف، لا نُعيد البناء بعد الاختيار
  $('#btnPick').onclick = ()=> $('#fFile').click();
  $('#fFile').onchange = function(){
    const f=this.files[0]; const p=$('#filePreview'); p.innerHTML='';
    if(!f) return; if(f.size > CONFIG.MAX_FILE_MB*1024*1024){ toast('حجم الملف أكبر من '+CONFIG.MAX_FILE_MB+'MB','error'); this.value=''; return; }
    if(f.type.startsWith('image/')){ const r=new FileReader(); r.onload=e=>{ p.innerHTML='<img src="'+e.target.result+'" style="max-width:120px;border-radius:6px"> <span class="ms-2">'+f.name+'</span>'; }; r.readAsDataURL(f); }
    else{ p.textContent = 'سيتم رفع: ' + f.name; }
  };

  // إرسال النموذج
  $('#formNew').onsubmit = async (ev)=>{
    ev.preventDefault();
    const btn=$('#btnSave'); const org=btn.innerHTML; btn.innerHTML='<span class="loading-spinner me-1"></span>جاري الحفظ...'; btn.disabled=true;
    try{
      const form = {
        department: $('#fDepartment').value, staff: $('#fStaff').value, taskType: $('#fTaskType').value,
        assetID: $('#fAsset').value, assetName: $('#fAsset').selectedOptions[0]?$('#fAsset').selectedOptions[0].textContent:'',
        startDate: $('#fServiceDate').value, dueDate: $('#fNextDue').value,
        completedDate: ($('#fStatus').value==='Completed')? $('#fServiceDate').value : '',
        status: $('#fStatus').value, priority: $('#fPriority').value||'Medium',
        downtimeHours: $('#fDown').value||'0', notes: $('#fNotes').value||''
      };
      const req = ['department','staff','taskType','assetID','startDate']; for(const k of req){ if(!form[k]){ toast('يرجى إكمال الحقول الإلزامية','error'); btn.innerHTML=org; btn.disabled=false; return; } }
      await Data.addRecord(form);
      toast('تم حفظ المهمة ورفع المرفق');
      ev.target.reset(); $('#filePreview').innerHTML='';
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalNew')); if(modal) modal.hide();
    }catch(e){ console.error(e); toast('خطأ: '+e.message,'error'); }
    finally{ btn.innerHTML=org; btn.disabled=false; }
  };
});
</script>
</body>
</html>
