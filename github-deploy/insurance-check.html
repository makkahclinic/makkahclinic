<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام مراجعة جودة الرعاية الطبية - مجمع مكة الطبي</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- DOMPurify for XSS protection -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --primary: #1e3a5f;
      --primary-light: #2d4a6f;
      --gold: #c9a962;
      --gold-light: #d4b872;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #eab308;
      --info: #3b82f6;
      --bg: #0f1a2b;
      --card-bg: #1a2d4a;
      --text: #ffffff;
      --text-muted: #94a3b8;
      --border: rgba(201, 169, 98, 0.3);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Tajawal", sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #152238 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      padding: 1rem 0;
      border-bottom: 3px solid var(--gold);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .header-content {
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;
    }
    .logo-section { display: flex; align-items: center; gap: 1rem; }
    .logo-section img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); }
    .logo-section h1 { font-size: 1.3rem; color: var(--gold); }
    .logo-section p { font-size: 0.85rem; color: var(--text-muted); }
    .header-tabs {
      display: none;
      gap: 0.5rem;
      background: rgba(0,0,0,0.2);
      padding: 6px;
      border-radius: 50px;
      border: 2px solid rgba(201, 169, 98, 0.3);
    }
    .header-tabs.visible {
      display: flex;
    }
    .header-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 50px;
      background: transparent;
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .header-tab:hover {
      background: rgba(201, 169, 98, 0.2);
    }
    .header-tab.active {
      background: var(--gold);
      color: var(--primary);
      box-shadow: 0 4px 15px rgba(201, 169, 98, 0.4);
    }
    .header-tab i {
      font-size: 1rem;
    }
    .header-btns { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .home-btn, .logout-btn {
      display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem;
      border-radius: 12px; text-decoration: none; font-weight: 700; transition: all 0.3s;
      border: none; cursor: pointer; font-family: inherit;
    }
    .home-btn { background: var(--gold); color: var(--primary); }
    .home-btn:hover { background: var(--gold-light); transform: translateY(-2px); }
    .logout-btn { background: var(--error); color: white; }
    .logout-btn:hover { background: #dc2626; }
    .user-info { color: var(--gold); font-size: 0.9rem; }

    .main-content { padding: 2rem 0; }
    
    .access-denied {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 3rem; text-align: center;
      border: 2px solid var(--error);
    }
    .access-denied i { font-size: 4rem; color: var(--error); margin-bottom: 1rem; }
    .access-denied h2 { color: var(--error); margin-bottom: 1rem; }
    .access-denied p { color: var(--text-muted); margin-bottom: 2rem; }
    
    .login-card {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 3rem; text-align: center;
      border: 1px solid var(--border); max-width: 500px; margin: 0 auto;
    }
    .login-card h2 { color: var(--gold); margin-bottom: 1rem; }
    .login-card p { color: var(--text-muted); margin-bottom: 2rem; }
    .login-btn {
      display: inline-flex; align-items: center; gap: 0.75rem;
      padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: var(--primary); border: none; border-radius: 14px;
      cursor: pointer; transition: all 0.3s;
    }
    .login-btn:hover { transform: translateY(-3px); }

    .stats-bar {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem; margin-bottom: 2rem;
    }
    .stat-card {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 12px; padding: 1.25rem; text-align: center;
      border: 1px solid var(--border);
    }
    .stat-card i { font-size: 1.5rem; color: var(--gold); margin-bottom: 0.5rem; }
    .stat-card .value { font-size: 1.8rem; font-weight: 800; color: var(--gold); }
    .stat-card .label { font-size: 0.8rem; color: var(--text-muted); }
    
    .hero-card {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 2rem; margin-bottom: 2rem;
      border: 1px solid var(--border);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      text-align: center;
    }
    .hero-card h2 { font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem; }
    .hero-card p { color: var(--text-muted); font-size: 1.1rem; max-width: 700px; margin: 0 auto; }

    .upload-section {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 2rem; margin-bottom: 2rem;
      border: 1px solid var(--border);
    }
    .section-title {
      display: flex; align-items: center; gap: 0.75rem;
      font-size: 1.3rem; color: var(--gold); margin-bottom: 1.5rem;
      padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);
    }
    .section-title i { font-size: 1.5rem; }

    .doctor-input {
      margin-bottom: 1.5rem;
      position: relative;
    }
    .doctor-input > label {
      display: block; color: var(--gold); margin-bottom: 0.5rem; font-weight: 600;
    }
    
    /* Custom Dropdown */
    .custom-dropdown {
      position: relative;
      width: 100%;
    }
    .custom-dropdown-selected {
      width: 100%; padding: 1rem 1.25rem; border-radius: 12px;
      border: 2px solid var(--border); background: var(--card-bg);
      color: var(--text); font-family: inherit; font-size: 1rem;
      cursor: pointer; transition: all 0.3s ease;
      display: flex; justify-content: space-between; align-items: center;
    }
    .custom-dropdown-selected:hover {
      border-color: var(--gold);
    }
    .custom-dropdown-selected.active {
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.2);
      border-radius: 12px 12px 0 0;
    }
    .custom-dropdown-selected i {
      color: var(--gold);
      transition: transform 0.3s;
    }
    .custom-dropdown-selected.active i {
      transform: rotate(180deg);
    }
    .custom-dropdown-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1e3a5f;
      border: 2px solid var(--gold);
      border-top: none;
      border-radius: 0 0 12px 12px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .custom-dropdown-options.show {
      display: block;
    }
    .custom-dropdown-option {
      padding: 0.875rem 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 1px solid rgba(201, 169, 98, 0.2);
      color: white;
      font-size: 0.95rem;
    }
    .custom-dropdown-option:last-child {
      border-bottom: none;
      border-radius: 0 0 10px 10px;
    }
    .custom-dropdown-option:hover {
      background: var(--gold);
      color: #1e3a5f;
    }
    .custom-dropdown-option.selected {
      background: rgba(201, 169, 98, 0.3);
      color: var(--gold);
      font-weight: 600;
    }
    .custom-dropdown-option .specialty {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-right: 0.5rem;
    }
    .custom-dropdown-options::-webkit-scrollbar {
      width: 8px;
    }
    .custom-dropdown-options::-webkit-scrollbar-track {
      background: #152238;
      border-radius: 4px;
    }
    .custom-dropdown-options::-webkit-scrollbar-thumb {
      background: var(--gold);
      border-radius: 4px;
    }

    .uploader {
      border: 2px dashed var(--gold);
      border-radius: 16px;
      padding: 3rem 2rem;
      text-align: center;
      background: rgba(201, 169, 98, 0.05);
      cursor: pointer;
      transition: all 0.3s;
    }
    .uploader:hover, .uploader.drag {
      background: rgba(201, 169, 98, 0.15);
      border-color: var(--gold-light);
      transform: scale(1.01);
    }
    .uploader input { display: none; }
    .uploader i { font-size: 3rem; color: var(--gold); margin-bottom: 1rem; display: block; }
    .uploader h3 { color: var(--text); margin-bottom: 0.5rem; }
    .uploader p { color: var(--text-muted); font-size: 0.9rem; }
    .file-types { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
    .file-type {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.8rem;
    }
    .file-type i { color: var(--gold); }

    .files-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .file-card {
      position: relative;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }
    .file-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .file-card img {
      width: 100%; height: 140px; object-fit: cover;
      border-bottom: 1px solid var(--border);
    }
    .file-card .excel-preview {
      width: 100%; height: 140px; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #217346 0%, #185c37 100%);
      border-bottom: 1px solid var(--border);
    }
    .file-card .excel-preview i { font-size: 3rem; color: white; }
    .file-card .meta {
      padding: 0.75rem; font-size: 0.8rem; color: var(--text-muted);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .file-card .remove {
      position: absolute; top: 8px; right: 8px;
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--error); color: white; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; transition: all 0.2s;
    }
    .file-card .remove:hover { background: #dc2626; transform: scale(1.1); }

    .analyze-section {
      display: flex; gap: 1rem; align-items: center; justify-content: center;
      flex-wrap: wrap; margin: 2rem 0;
    }
    .analyze-btn {
      display: inline-flex; align-items: center; gap: 0.75rem;
      padding: 1rem 2.5rem; font-size: 1.2rem; font-weight: 700;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: var(--primary); border: none; border-radius: 14px;
      cursor: pointer; transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(201, 169, 98, 0.4);
    }
    .analyze-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(201, 169, 98, 0.5);
    }
    .analyze-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .analyze-btn i { font-size: 1.3rem; }
    
    .status-msg {
      display: flex; align-items: center; gap: 0.5rem;
      color: var(--gold); font-size: 1rem;
    }
    .status-msg i { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .report-section {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 2rem; margin-top: 2rem;
      border: 1px solid var(--border);
      display: none;
    }
    .report-section.show { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .rating-section {
      background: rgba(201, 169, 98, 0.1);
      border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;
      border: 1px solid var(--border);
    }
    .rating-section h4 { color: var(--gold); margin-bottom: 1rem; text-align: center; }
    .rating-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .rating-item { text-align: center; }
    .rating-item label { display: block; color: var(--text); margin-bottom: 0.5rem; font-weight: 600; }
    .rating-stars { display: flex; justify-content: center; gap: 0.25rem; }
    .rating-stars i {
      font-size: 1.5rem; color: #475569; cursor: pointer; transition: all 0.2s;
    }
    .rating-stars i:hover, .rating-stars i.active { color: var(--gold); transform: scale(1.1); }
    .rating-value { color: var(--gold); font-weight: 700; margin-top: 0.5rem; }

    .report-content {
      background: #ffffff;
      color: #1e293b;
      border-radius: 16px;
      padding: 2rem;
      line-height: 1.8;
    }
    .report-content h1 { color: var(--primary); font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; border-bottom: 3px solid var(--gold); padding-bottom: 1rem; }
    .report-content h2 { color: var(--primary); font-size: 1.4rem; margin: 1.5rem 0 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .report-content h3 { color: #334155; font-size: 1.1rem; margin: 1rem 0 0.5rem; }
    .report-content p { color: #475569; margin: 0.5rem 0; }
    .report-content ul { list-style: none; padding: 0; }
    .report-content li { padding: 0.75rem 1rem; margin: 0.5rem 0; border-radius: 8px; background: #f8fafc; border-right: 4px solid #cbd5e1; }
    .report-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    .report-content th, .report-content td { padding: 0.75rem; text-align: right; border: 1px solid #e2e8f0; }
    .report-content th { background: var(--primary); color: white; }
    .report-content tr:nth-child(even) { background: #f8fafc; }
    .report-content .status-rejected,
    .report-content td[style*="مرفوض"] { background: #dc2626 !important; color: white !important; font-weight: bold; border-radius: 6px; }
    .report-content .status-accepted { background: #dcfce7 !important; color: #166534 !important; font-weight: bold; }
    .report-content .status-needs-correction { background: #fef9c3 !important; color: #854d0e !important; font-weight: bold; }

    .report-actions {
      display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; flex-wrap: wrap;
    }
    .report-actions button {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.75rem 1.5rem; border-radius: 10px; border: none;
      cursor: pointer; font-family: inherit; font-weight: 600; transition: all 0.3s;
    }
    .btn-save { background: var(--success); color: white; }
    .btn-save:hover { background: #16a34a; }
    .btn-print { background: var(--info); color: white; }
    .btn-print:hover { background: #2563eb; }
    .btn-pdf { background: #dc2626; color: white; }
    .btn-pdf:hover { background: #b91c1c; }
    .btn-translate { background: #8b5cf6; color: white; }
    .btn-translate:hover { background: #7c3aed; }
    .btn-new { background: var(--warning); color: var(--primary); }
    .btn-new:hover { background: #ca8a04; }

    .doctors-stats {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px; padding: 2rem; margin-top: 2rem;
      border: 1px solid var(--border);
    }
    .doctors-table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
    }
    .doctors-table th, .doctors-table td {
      padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--border);
    }
    .doctors-table th { color: var(--gold); font-weight: 600; }
    .doctors-table td { color: var(--text-muted); }
    .doctors-table tr:hover td { background: rgba(201, 169, 98, 0.1); }
    .rating-badge {
      display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px;
      font-size: 0.85rem; font-weight: 700;
    }
    .rating-excellent { background: #dcfce7; color: #166534; }
    .rating-good { background: #fef9c3; color: #854d0e; }
    .rating-needs { background: #fee2e2; color: #991b1b; }

    .powered-by {
      text-align: center; margin-top: 2rem; padding: 1rem;
      color: var(--text-muted); font-size: 0.85rem;
    }
    .powered-by i { color: var(--gold); }

    @media (max-width: 768px) {
      .header-content { justify-content: center; text-align: center; }
      .logo-section { flex-direction: column; }
      .hero-card h2 { font-size: 1.5rem; }
      .uploader { padding: 2rem 1rem; }
      .analyze-btn { width: 100%; justify-content: center; }
      .rating-grid { grid-template-columns: 1fr; }
    }

    /* Scroll Navigation Buttons */
    .scroll-nav {
      position: fixed;
      left: 20px;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    .scroll-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--gold);
      color: var(--primary);
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
      opacity: 0;
      transform: translateX(-100px);
    }
    .scroll-btn.visible {
      opacity: 1;
      transform: translateX(0);
    }
    .scroll-btn:hover {
      background: var(--gold-light);
      transform: scale(1.1) translateX(0);
    }
    .scroll-btn:active {
      transform: scale(0.95);
    }
    @media (max-width: 768px) {
      .scroll-nav { left: 10px; bottom: 10px; }
      .scroll-btn { width: 45px; height: 45px; font-size: 1rem; }
    }

    @media print {
      .scroll-nav, .header, .header-tabs, .upload-section, .analyze-section, .report-actions, 
      .powered-by, .hero-card, .stats-bar, .rating-section, .doctors-stats, .stepper,
      .tab-btn, .tabs-header, .quick-actions-fab { display: none !important; }
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      html, body { 
        direction: rtl !important; 
        text-align: right !important;
        background: white !important; 
        margin: 0; 
        padding: 15mm !important; 
        font-size: 11pt; 
      }
      .report-section { 
        margin: 0 !important; 
        padding: 0 !important; 
        border: none !important; 
        background: white !important; 
        display: block !important;
        direction: rtl !important;
      }
      .report-content { 
        padding: 0 !important; 
        box-shadow: none !important; 
        border-radius: 0 !important;
        direction: rtl !important;
        text-align: right !important;
      }
      .report-content table {
        direction: rtl !important;
        width: 100% !important;
        font-size: 10pt;
      }
      .report-content th, .report-content td { 
        padding: 8px 10px; 
        text-align: right !important;
      }
      .print-header {
        display: block !important; 
        border-bottom: 2px solid #1e3a5f; 
        padding-bottom: 10px; 
        margin-bottom: 15px;
        direction: rtl !important;
      }
      .print-header-text h1 { color: #1e3a5f !important; font-size: 16pt; margin: 10px 0 5px; text-align: center; }
      .print-header-text p { font-size: 10pt; margin: 3px 0; text-align: center; color: #333; }
      .report-footer-box { 
        display: block !important; margin-top: 25px; padding: 15px; 
        border: 2px solid #1e3a5f; border-radius: 8px; background: #f8fafc !important;
        page-break-inside: avoid;
        direction: rtl !important;
      }
      .report-content h1 { display: none !important; }
      .report-content h2 { 
        font-size: 12pt; 
        color: #1e3a5f !important; 
        background: #f1f5f9; 
        padding: 8px 12px; 
        border-radius: 4px; 
        border-right: 4px solid #c9a962; 
        page-break-after: avoid;
        text-align: right !important;
      }
      @page { size: A4 portrait; margin: 10mm; }
    }
    .print-header, .report-footer-box { display: none; }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      padding: 1rem 2rem;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: toastIn 0.5s ease, toastOut 0.5s ease 3.5s forwards;
      min-width: 300px;
      justify-content: center;
    }
    .toast.success {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }
    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    .toast.info {
      background: linear-gradient(135deg, var(--gold) 0%, #b8963d 100%);
      color: var(--primary);
    }
    .toast i {
      font-size: 1.5rem;
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(-50px) scale(0.8); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-30px) scale(0.8); }
    }
    
    /* Upload Button Animation */
    .btn-upload-task.uploading {
      background: linear-gradient(135deg, var(--gold) 0%, #b8963d 100%);
      pointer-events: none;
    }
    .btn-upload-task.success-flash {
      animation: successFlash 0.6s ease;
    }
    @keyframes successFlash {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); background: #22c55e; }
    }

    .hidden { display: none !important; }
    
    /* Tab Content */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    /* Quick Actions FAB */
    .quick-actions-fab {
      position: fixed;
      left: 20px;
      bottom: 20px;
      z-index: 1000;
    }
    .fab-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--gold), #b8963d);
      color: var(--primary);
      border: none;
      border-radius: 50px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 25px rgba(201, 169, 98, 0.5);
      transition: all 0.3s ease;
      animation: fabPulse 2s infinite;
    }
    .fab-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 30px rgba(201, 169, 98, 0.7);
    }
    .fab-btn i {
      font-size: 1.1rem;
      animation: bounceDown 1s infinite;
    }
    @keyframes bounceDown {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(4px); }
    }
    @keyframes fabPulse {
      0%, 100% { box-shadow: 0 6px 25px rgba(201, 169, 98, 0.5); }
      50% { box-shadow: 0 6px 35px rgba(201, 169, 98, 0.8); }
    }
    
    
    /* Tasks Management Styles */
    .tasks-section {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border);
    }
    .tasks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
    }
    .task-card {
      background: rgba(30, 58, 95, 0.5);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      transition: all 0.3s;
    }
    .task-card:hover {
      border-color: var(--gold);
      transform: translateY(-2px);
    }
    .task-card .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    .task-card .task-doctor {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .task-card .task-status {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .task-status.pending { background: var(--warning); color: #000; }
    .task-status.analyzing { background: var(--info); color: white; }
    .task-status.analyzed { background: #8b5cf6; color: white; }
    .task-status.printed { background: #f59e0b; color: #000; }
    .task-status.delivered { background: var(--success); color: white; }
    .task-card .task-info {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }
    .task-card .task-actions {
      display: flex;
      gap: 0.5rem;
    }
    .task-btn {
      flex: 1;
      padding: 0.6rem;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }
    .task-btn.analyze { 
      background: linear-gradient(135deg, var(--info), #1d7fc2);
      color: white;
      font-size: 1rem;
      padding: 12px 24px;
      box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4);
      animation: analyzeGlow 2s infinite;
    }
    @keyframes analyzeGlow {
      0%, 100% { box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4); }
      50% { box-shadow: 0 4px 25px rgba(56, 189, 248, 0.7); }
    }
    .task-btn.view { background: #8b5cf6; color: white; }
    .task-btn.deliver { background: var(--success); color: white; }
    .task-btn:hover { opacity: 0.9; transform: scale(1.05); }
    
    /* Signature Modal */
    .signature-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 1rem;
    }
    .signature-modal-content {
      background: linear-gradient(145deg, var(--card-bg), #152238);
      border-radius: 20px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      border: 2px solid var(--gold);
    }
    .signature-modal h3 {
      color: var(--gold);
      text-align: center;
      margin-bottom: 1rem;
    }
    .signature-info {
      background: rgba(201,169,98,0.1);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      text-align: center;
    }
    .signature-info p {
      margin: 0.25rem 0;
      color: var(--text);
    }
    .signature-canvas-container {
      background: white;
      border-radius: 12px;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    #signatureCanvas {
      width: 100%;
      height: 200px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      cursor: crosshair;
      touch-action: none;
    }
    .signature-actions {
      display: flex;
      gap: 0.75rem;
    }
    .signature-actions button {
      flex: 1;
      padding: 0.9rem;
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .btn-clear { background: var(--text-muted); color: white; }
    .btn-confirm { background: var(--success); color: white; }
    .btn-cancel { background: var(--error); color: white; }
    
    /* Upload Task Form */
    .upload-task-form {
      background: rgba(30, 58, 95, 0.5);
      border: 2px dashed var(--gold);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    .upload-task-form h4 {
      color: var(--gold);
      margin-bottom: 1.5rem;
      text-align: center;
      font-size: 1.3rem;
    }
    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
      max-width: 100%;
    }
    .form-group label {
      display: block;
      color: var(--gold);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .form-group select, .form-group input[type="file"] {
      width: 100%;
      padding: 0.9rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--card-bg);
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
    }
    .form-group select:focus {
      border-color: var(--gold);
      outline: none;
    }
    .btn-upload-task {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: var(--primary);
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s;
    }
    .btn-upload-task:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(201,169,98,0.3);
    }
    .btn-upload-task:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* File Upload Zone */
    .file-upload-zone {
      border: 2px dashed var(--gold);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(201,169,98,0.05);
    }
    .file-upload-zone:hover {
      background: rgba(201,169,98,0.15);
      border-color: var(--gold-light);
    }
    .file-upload-zone i {
      font-size: 2rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
      display: block;
    }
    .file-upload-zone span {
      color: var(--text-muted);
    }
    
    /* Selected File Preview */
    .selected-file-preview {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid #22c55e;
      border-radius: 10px;
      margin-top: 0.5rem;
    }
    .selected-file-preview i.fa-file-excel {
      color: #22c55e;
      font-size: 1.5rem;
    }
    .selected-file-preview span {
      flex: 1;
      color: var(--text);
      font-weight: 500;
      word-break: break-all;
    }
    .remove-file-btn {
      background: #ef4444;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .remove-file-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }
    
    /* Delivery Log Table */
    .delivery-log {
      margin-top: 2rem;
    }
    .delivery-log h4 {
      color: var(--gold);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .delivery-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(30, 58, 95, 0.5);
      border-radius: 12px;
      overflow: hidden;
    }
    .delivery-table th, .delivery-table td {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .delivery-table th {
      background: var(--primary);
      color: var(--gold);
      font-weight: 600;
    }
    .delivery-table td {
      color: var(--text);
    }
    .delivery-table tr:hover {
      background: rgba(201,169,98,0.05);
    }
    .signature-thumb {
      width: 60px;
      height: 40px;
      object-fit: contain;
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }

    /* === Missing Helper Classes === */
    .muted { color: var(--text-secondary, #9ca3af); font-size: 14px; }
    .no-print { /* default visible */ }
    .avoid-break { break-inside: avoid; page-break-inside: avoid; }

    /* === Responsive Spacing === */
    .main-content {
      padding: clamp(16px, 3vw, 32px);
      margin: clamp(16px, 3vw, 32px) auto;
    }

    /* === File name overflow fix === */
    .file-card .meta { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }

    /* === Reduce motion for accessibility === */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { 
        animation-duration: 0.01ms !important; 
        transition-duration: 0.01ms !important; 
      }
    }

    /* === Print support === */
    @media print {
      .no-print { display: none !important; }
      .page-wrapper { position: static; backdrop-filter: none; }
      .main-content { margin: 0; border: none; box-shadow: none; }
      header { display: none !important; }
    }

    /* === Stepper styling === */
    .stepper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      margin-bottom: 2rem;
      padding: 0 1rem;
    }
    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      color: var(--text-muted);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .step:hover {
      background: rgba(201,169,98,0.1);
    }
    .step.active {
      background: linear-gradient(135deg, rgba(201,169,98,0.2), rgba(201,169,98,0.1));
      border-color: var(--gold);
      color: var(--gold);
    }
    .step.completed {
      background: rgba(16,185,129,0.15);
      border-color: #10b981;
      color: #10b981;
    }
    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      background: rgba(255,255,255,0.1);
      border: 2px solid currentColor;
    }
    .step.completed .step-number {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }
    .step.completed .step-number::after {
      content: '✓';
    }
    .step.completed .step-number span {
      display: none;
    }
    .step-label {
      font-size: 14px;
      font-weight: 600;
    }
    .step-connector {
      width: 40px;
      height: 3px;
      background: rgba(255,255,255,0.1);
      margin: 0 5px;
    }
    .step-connector.completed {
      background: #10b981;
    }
    @media (max-width: 600px) {
      .stepper { flex-wrap: wrap; gap: 8px; }
      .step { padding: 8px 12px; }
      .step-label { font-size: 12px; }
      .step-connector { width: 20px; }
    }

    /* === Sidebar Summary === */
    .sidebar-summary {
      position: sticky;
      top: 100px;
      background: linear-gradient(135deg, rgba(30,58,95,0.95), rgba(15,23,42,0.95));
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 1.5rem;
      min-width: 260px;
      max-width: 300px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .sidebar-summary h4 {
      color: var(--gold);
      margin: 0 0 1rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
      font-size: 14px;
    }
    .summary-item:last-child { border-bottom: none; }
    .summary-value {
      font-weight: 700;
      color: var(--gold);
    }
    .sidebar-summary .analyze-btn {
      width: 100%;
      margin-top: 1rem;
    }
    @media (max-width: 900px) {
      .sidebar-summary { display: none; }
    }

    /* === Main layout with sidebar === */
    .analysis-layout {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 2rem;
      align-items: start;
    }
    @media (max-width: 900px) {
      .analysis-layout { grid-template-columns: 1fr; }
    }

    /* === Progress bar styling === */
    .progress-container {
      margin-top: 12px;
      display: none;
    }
    .progress-container.active { display: block; }
    .progress-status {
      color: var(--gold);
      font-size: 14px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
      overflow: hidden;
    }
    .progress-bar progress {
      width: 100%;
      height: 100%;
      -webkit-appearance: none;
      appearance: none;
    }
    .progress-bar progress::-webkit-progress-bar {
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
    }
    .progress-bar progress::-webkit-progress-value {
      background: linear-gradient(90deg, var(--gold), #e6c56a);
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo-section">
          <img src="https://www.m2020m.org/logo-transparent.png" alt="شعار المجمع">
          <div>
            <h1>نظام مراجعة جودة الرعاية الطبية</h1>
            <p>مجمع مكة الطبي بالزاهر</p>
          </div>
        </div>
        <div class="header-tabs" id="headerTabs">
          <button id="headerAnalysisBtn" onclick="switchTab('analysis')" class="header-tab active">
            <i class="fas fa-search-dollar"></i>
            <span>التحليل</span>
          </button>
          <button id="headerTasksBtn" onclick="switchTab('tasks')" class="header-tab">
            <i class="fas fa-tasks"></i>
            <span>المهام</span>
          </button>
        </div>
        <div class="header-btns">
          <span class="user-info" id="userInfo"></span>
          <a class="home-btn" href="https://www.m2020m.org/portal.html">
            <i class="fas fa-home"></i>
            <span>الرئيسية</span>
          </a>
          <button class="logout-btn hidden" id="logoutBtn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>خروج</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      
      <!-- Login Screen -->
      <div class="login-card" id="loginScreen">
        <i class="fas fa-user-shield" style="font-size:4rem;color:var(--gold);margin-bottom:1rem;"></i>
        <h2>تسجيل الدخول مطلوب</h2>
        <p>هذه الخدمة متاحة فقط للموظفين المصرح لهم</p>
        
        <form id="emailLoginForm" style="display:flex; flex-direction:column; gap:12px; width:100%;" onsubmit="event.preventDefault(); loginWithEmail();" autocomplete="on">
          <input type="email" id="loginEmail" placeholder="البريد الإلكتروني" autocomplete="email" style="padding:12px 15px; border:2px solid #e2e8f0; border-radius:8px; font-size:1rem; direction:ltr; text-align:left;">
          <input type="password" id="loginPassword" placeholder="كلمة المرور" autocomplete="current-password" style="padding:12px 15px; border:2px solid #e2e8f0; border-radius:8px; font-size:1rem; direction:ltr; text-align:left;">
          <button type="submit" class="login-btn" style="background:linear-gradient(135deg, #10b981, #059669);">
            <i class="fas fa-sign-in-alt"></i>
            تسجيل الدخول
          </button>
          <button type="button" class="login-btn" onclick="registerWithEmail()" style="background:linear-gradient(135deg, #3b82f6, #2563eb);">
            <i class="fas fa-user-plus"></i>
            تسجيل جديد
          </button>
          <div style="display:flex; align-items:center; gap:10px; margin:10px 0;">
            <hr style="flex:1; border:none; border-top:1px solid #e2e8f0;">
            <span style="color:#666; font-size:0.9rem;">أو</span>
            <hr style="flex:1; border:none; border-top:1px solid #e2e8f0;">
          </div>
          <button type="button" class="login-btn" onclick="loginWithGoogle()">
            <i class="fab fa-google"></i>
            تسجيل الدخول بـ Google
          </button>
        </form>
      </div>

      <!-- Access Denied Screen -->
      <div class="access-denied hidden" id="accessDenied">
        <i class="fas fa-ban"></i>
        <h2>غير مصرح لك بالوصول</h2>
        <p>عذراً، ليس لديك صلاحية لاستخدام هذه الخدمة.<br>يرجى التواصل مع الإدارة للحصول على الصلاحية.</p>
        <button class="login-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          تسجيل الخروج
        </button>
      </div>

      <!-- Main Content (only for authorized users) -->
      <div class="hidden" id="mainApp">
        
        <div class="stats-bar">
          <div class="stat-card">
            <i class="fas fa-file-medical"></i>
            <div class="value" id="todayCases">0</div>
            <div class="label">حالاتي اليوم</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-chart-line"></i>
            <div class="value" id="totalCases">0</div>
            <div class="label">إجمالي حالاتي</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-user-md"></i>
            <div class="value" id="totalDoctors">0</div>
            <div class="label">الأطباء</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-calendar-day"></i>
            <div class="value" id="allTodayCases">0</div>
            <div class="label">حالات اليوم</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-tasks"></i>
            <div class="value" id="pendingTasks">0</div>
            <div class="label">مهام معلقة</div>
          </div>
        </div>
        
        
        <!-- Tab 1: Analysis (Current Content) -->
        <div class="tab-content active" id="analysisTab">
        
        <!-- Stepper -->
        <div class="stepper no-print" id="analysisStepper">
          <div class="step active" id="step1" onclick="goToStep(1)">
            <div class="step-number"><span>1</span></div>
            <span class="step-label">اختيار الطبيب</span>
          </div>
          <div class="step-connector" id="connector1"></div>
          <div class="step" id="step2" onclick="goToStep(2)">
            <div class="step-number"><span>2</span></div>
            <span class="step-label">رفع الملفات</span>
          </div>
          <div class="step-connector" id="connector2"></div>
          <div class="step" id="step3">
            <div class="step-number"><span>3</span></div>
            <span class="step-label">النتيجة</span>
          </div>
        </div>
        
        <div class="analysis-layout">
          <div class="analysis-main">
        
        <div class="upload-section" style="text-align:center;">
          <h2 style="color:var(--gold);font-size:1.8rem;margin-bottom:0.5rem;">
            <i class="fas fa-user-tie"></i> مراجعة الحالات الطبية
          </h2>
          <p style="color:var(--text-muted);margin-bottom:1.5rem;">ارفع الملفات واحصل على تقرير تدقيق شامل</p>
          
          <div class="doctor-input" style="max-width:400px;margin:0 auto 1.5rem;">
            <label><i class="fas fa-user-md"></i> اسم الطبيب المعالج</label>
            <div class="custom-dropdown" id="doctorDropdown">
              <div class="custom-dropdown-selected" id="doctorSelected">
                <span>-- اختر الطبيب --</span>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="custom-dropdown-options" id="doctorOptions">
              </div>
            </div>
            <input type="hidden" id="doctorName" value="">
          </div>
          
          <div style="display:flex;gap:20px;max-width:900px;margin:0 auto;flex-wrap:wrap;">
            <div style="flex:1;min-width:280px;">
              <label class="uploader" for="fileInput" id="dropZone" style="padding:2.5rem 1.5rem;height:100%;display:flex;flex-direction:column;justify-content:center;">
                <i class="fas fa-cloud-upload-alt" style="font-size:3rem;margin-bottom:0.75rem;"></i>
                <h3 style="font-size:1.2rem;margin-bottom:0.5rem;">رفع ملفات</h3>
                <p style="margin-bottom:0.75rem;font-size:0.9rem;">اسحب أو انقر للاختيار</p>
                <input id="fileInput" type="file" multiple accept="image/*,application/pdf,.xlsx,.xls,.csv" />
                <div class="file-types" style="justify-content:center;gap:0.5rem;">
                  <span class="file-type" style="padding:0.3rem 0.6rem;font-size:0.75rem;"><i class="fas fa-image"></i> صور</span>
                  <span class="file-type" style="padding:0.3rem 0.6rem;font-size:0.75rem;"><i class="fas fa-file-excel"></i> Excel</span>
                </div>
              </label>
            </div>
            
            <div style="flex:1;min-width:280px;">
              <div style="border:2px dashed var(--gold);border-radius:16px;padding:1.5rem;background:rgba(201,169,98,0.05);height:100%;">
                <h3 style="color:var(--gold);margin:0 0 0.75rem;font-size:1.1rem;text-align:center;">
                  <i class="fas fa-keyboard"></i> أو اكتب الحالة يدوياً
                </h3>
                <textarea id="manualCaseInput" placeholder="اكتب بيانات الحالة هنا...
مثال:
التشخيص: التهاب الحلق J06.9
الأدوية: Augmentin 1g, Panadol 500mg
التحاليل: CBC, CRP
الإجراءات: كشف عيادة" 
                  style="width:100%;height:140px;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--card-bg);color:var(--text);font-family:inherit;font-size:0.95rem;resize:none;"></textarea>
              </div>
            </div>
          </div>

          <div id="filesGrid" class="files-grid"></div>
          
          <!-- Progress indicator for file processing -->
          <div class="progress-container no-print" id="progressContainer">
            <div class="progress-status" id="progressStatus" role="status" aria-live="polite">
              <i class="fas fa-spinner fa-spin"></i>
              <span id="progressText">جاري معالجة الملفات...</span>
            </div>
            <div class="progress-bar">
              <progress id="fileProgress" value="0" max="100"></progress>
            </div>
          </div>
        </div>

        <div class="analyze-section">
          <button class="analyze-btn" id="analyzeBtn" disabled>
            <i class="fas fa-search-dollar"></i>
            <span>مراجعة الحالة</span>
          </button>
          <div class="status-msg" id="statusMsg" style="display:none;">
            <i class="fas fa-spinner"></i>
            <span id="statusText">جاري التحليل...</span>
          </div>
        </div>

        <div class="report-section" id="reportSection">
          <h3 class="section-title">
            <i class="fas fa-clipboard-check"></i>
            تقرير مراجعة جودة الرعاية الطبية
          </h3>
          
          
          <div class="report-content" id="reportContent"></div>
          <div class="report-actions">
            <button class="btn-save" id="saveBtn" onclick="saveAndLog()">
              <i class="fas fa-save"></i> حفظ وتسجيل
            </button>
            <button class="btn-print" onclick="printAndTrack()">
              <i class="fas fa-print"></i> طباعة
            </button>
            <button class="btn-translate" id="translateBtn" onclick="translateReport()">
              <i class="fas fa-language"></i> <span id="translateText">English</span>
            </button>
            <button class="btn-new" onclick="resetAnalysis()">
              <i class="fas fa-plus"></i> تحليل جديد
            </button>
          </div>
        </div>

        <div class="doctors-stats" id="doctorsStats">
          <h3 class="section-title">
            <i class="fas fa-chart-bar"></i>
            إحصائيات الأطباء
          </h3>
          
          <!-- Bar Chart for Cases Count -->
          <div class="chart-container" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            <h4 style="color: #c9a962; margin: 0 0 20px 0; font-size: 1.2rem; text-align: center;">
              <i class="fas fa-file-medical" style="margin-left: 8px;"></i>
              عدد الحالات لكل طبيب
            </h4>
            <canvas id="casesChart" style="max-height: 280px;"></canvas>
          </div>
          
          <!-- Bar Chart for Ratings -->
          <div class="chart-container" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            <h4 style="color: #c9a962; margin: 0 0 20px 0; font-size: 1.2rem; text-align: center;">
              <i class="fas fa-star" style="margin-left: 8px;"></i>
              تقييمات الأداء (من 10)
            </h4>
            <canvas id="ratingsChart" style="max-height: 280px;"></canvas>
          </div>
          
          <table class="doctors-table">
            <thead>
              <tr>
                <th>الطبيب</th>
                <th>عدد الحالات</th>
                <th>معايير التأمين</th>
                <th>جودة الخدمات</th>
                <th>المتوسط</th>
                <th>الحالة</th>
                <th>آخر مراجعة</th>
              </tr>
            </thead>
            <tbody id="doctorsTableBody"></tbody>
          </table>
        </div>

        <div class="powered-by">
          <i class="fas fa-shield-alt"></i> لجنة متابعة الجودة والتدقيق الطبي - مجمع مكة الطبي
        </div>
        
          </div> <!-- End of analysis-main -->
          
          <!-- Sidebar Summary -->
          <aside class="sidebar-summary no-print" id="sidebarSummary">
            <h4><i class="fas fa-clipboard-list"></i> ملخص الحالة</h4>
            <div class="summary-item">
              <span>الطبيب</span>
              <span class="summary-value" id="summaryDoctor">لم يُحدد</span>
            </div>
            <div class="summary-item">
              <span>عدد الملفات</span>
              <span class="summary-value" id="summaryFilesCount">0</span>
            </div>
            <div class="summary-item">
              <span>صفحات PDF</span>
              <span class="summary-value" id="summaryPdfPages">0</span>
            </div>
            <div class="summary-item">
              <span>ملفات Excel</span>
              <span class="summary-value" id="summaryExcelCount">0</span>
            </div>
            <button class="analyze-btn" id="sidebarAnalyzeBtn" disabled onclick="document.getElementById('analyzeBtn').click()">
              <i class="fas fa-search-dollar"></i>
              <span>مراجعة الحالة</span>
            </button>
          </aside>
          
        </div> <!-- End of analysis-layout -->
        
        </div> <!-- End of Analysis Tab -->
        
        <!-- Tab 2: Tasks Management -->
        <div class="tab-content" id="tasksTab">
          
          <!-- Upload Task Form (for Saber) -->
          <div class="tasks-section">
            <h3 class="section-title">
              <i class="fas fa-cloud-upload-alt"></i>
              رفع ملف للتحليل
            </h3>
            <div class="upload-task-form">
              <h4><i class="fas fa-file-upload"></i> إضافة مهمة تحليل جديدة</h4>
              <div class="form-row">
                <div class="form-group">
                  <label><i class="fas fa-user-md"></i> الطبيب المطلوب تحليله</label>
                  <select id="taskDoctorSelect">
                    <option value="">-- اختر الطبيب --</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label><i class="fas fa-file-excel"></i> ملف الإكسل</label>
                  <input type="file" id="taskFileInput" accept=".xlsx,.xls,.csv" onchange="showFilePreview(this)" style="display:none;">
                  <div class="file-upload-zone" onclick="document.getElementById('taskFileInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>اضغط لاختيار الملف</span>
                  </div>
                  <div id="selectedFilePreview" class="selected-file-preview" style="display:none;">
                    <i class="fas fa-file-excel"></i>
                    <span id="selectedFileName"></span>
                    <button type="button" class="remove-file-btn" onclick="removeSelectedFile(event)">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
              <button class="btn-upload-task" onclick="uploadTask()" id="uploadTaskBtn" disabled>
                <i class="fas fa-plus-circle"></i>
                إضافة المهمة
              </button>
            </div>
          </div>
          
          <!-- Pending Tasks -->
          <div class="tasks-section">
            <h3 class="section-title">
              <i class="fas fa-clock"></i>
              المهام المعلقة
            </h3>
            <div class="tasks-grid" id="pendingTasksGrid">
              <p style="text-align:center;color:var(--text-muted);grid-column:1/-1;">
                <i class="fas fa-check-circle" style="font-size:2rem;margin-bottom:0.5rem;display:block;"></i>
                لا توجد مهام معلقة حالياً
              </p>
            </div>
          </div>
          
          <!-- Delivery Log -->
          <div class="tasks-section delivery-log">
            <h4>
              <i class="fas fa-history"></i>
              سجل التسليمات
            </h4>
            <div style="overflow-x:auto;">
              <table class="delivery-table">
                <thead>
                  <tr>
                    <th>الطبيب</th>
                    <th>رافع الملف</th>
                    <th>تاريخ الرفع</th>
                    <th>المحلل</th>
                    <th>تاريخ التحليل</th>
                    <th>تاريخ التسليم</th>
                    <th>التوقيع</th>
                    <th>الحالة</th>
                  </tr>
                </thead>
                <tbody id="deliveryLogBody">
                  <tr>
                    <td colspan="8" style="color:var(--text-muted);">لا توجد تسليمات مسجلة</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
        </div> <!-- End of Tasks Tab -->
        
      </div>
    </div>
  </main>
  
  <!-- Signature Modal -->
  <div class="signature-modal hidden" id="signatureModal">
    <div class="signature-modal-content">
      <h3><i class="fas fa-signature"></i> توقيع استلام التقرير</h3>
      <div class="signature-info">
        <p><strong>الطبيب المستلم:</strong> <span id="sigDoctorName">-</span></p>
        <p><strong>التقرير:</strong> <span id="sigReportInfo">-</span></p>
        <p><strong>التاريخ:</strong> <span id="sigDate">-</span></p>
      </div>
      <p style="text-align:center;color:var(--text-muted);margin-bottom:0.5rem;">
        <i class="fas fa-hand-pointer"></i> وقّع في المربع أدناه للتأكيد على الاستلام
      </p>
      <div class="signature-canvas-container">
        <canvas id="signatureCanvas"></canvas>
      </div>
      <div class="signature-actions">
        <button class="btn-clear" onclick="clearSignature()">
          <i class="fas fa-eraser"></i> مسح
        </button>
        <button class="btn-confirm" onclick="confirmDelivery()">
          <i class="fas fa-check"></i> تأكيد التسليم
        </button>
        <button class="btn-cancel" onclick="closeSignatureModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Quick Actions Floating Button -->
  <div class="quick-actions-fab hidden" id="quickActionsFab">
    <button class="fab-btn" onclick="scrollToReportActions()" title="الذهاب للحفظ والطباعة">
      <i class="fas fa-arrow-down"></i>
      <span>حفظ/طباعة</span>
    </button>
  </div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
  authDomain: "insurance-check-6cec9.firebaseapp.com",
  projectId: "insurance-check-6cec9"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// URLs - All insurance-related APIs use Google Apps Script
const INSURANCE_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbxhKSq0qMIT85_pUfiba5V5Pi-kO_Df4Qw98MRIM4fmCb-XcheI8uGQccFxuKjigATHlQ/exec';
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwlizY8v800tI9TewDEwtAAVs3vrpbLnT3uI8Bn0pHFOqcfe3E9AYZwOIeFSymzvTSPMA/exec';
const TASKS_API_URL = INSURANCE_APPS_SCRIPT;
const API_URL = INSURANCE_APPS_SCRIPT;

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

// State
const filesState = [];
let currentUser = null;
let currentLang = 'ar';
let originalReport = '';
let translatedReport = '';
let insuranceRatingValue = 0;
let serviceRatingValue = 0;

// DOM Elements
const loginScreen = document.getElementById('loginScreen');
const accessDenied = document.getElementById('accessDenied');
const mainApp = document.getElementById('mainApp');
const userInfo = document.getElementById('userInfo');
const logoutBtn = document.getElementById('logoutBtn');
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const filesGrid = document.getElementById('filesGrid');
const analyzeBtn = document.getElementById('analyzeBtn');
const statusMsg = document.getElementById('statusMsg');
const statusText = document.getElementById('statusText');
const reportSection = document.getElementById('reportSection');
const reportContent = document.getElementById('reportContent');
const doctorNameInput = document.getElementById('doctorName');

// Auth State Observer
auth.onAuthStateChanged(async (user) => {
  if (user) {
    // Check permission using UID first, then email
    const hasPermission = await checkPermission(user.uid, user.email);
    
    if (hasPermission) {
      currentUser = {
        email: user.email,
        name: user.displayName || user.email.split('@')[0],
        photo: user.photoURL
      };
      
      showMainApp();
      loadStats();
      loadDoctorStats();
    } else {
      showAccessDenied();
    }
  } else {
    showLoginScreen();
  }
});


async function checkPermission(uid, email) {
  console.log('Checking permission for:', email, 'UID:', uid);
  try {
    // 1. أولاً: البحث بـ UID (الطريقة الصحيحة)
    const uidDoc = await db.collection('staff_roles').doc(uid).get();
    if (uidDoc.exists) {
      const result = evaluatePermission(uidDoc.data());
      if (result !== null) return result;
    }
    
    // 2. ثانياً: البحث بالإيميل (للسجلات القديمة)
    console.log('Searching by email...');
    const snapshot = await db.collection('staff_roles').where('email', '==', email.toLowerCase()).get();
    console.log('Found', snapshot.size, 'records for email');
    
    if (!snapshot.empty) {
      // فحص جميع السجلات وأخذ أعلى صلاحية
      let bestResult = false;
      
      for (const doc of snapshot.docs) {
        const result = evaluatePermission(doc.data());
        if (result === true) {
          bestResult = true;
          break; // وجدنا صلاحية، نتوقف
        }
      }
      
      return bestResult;
    }
    
    console.log('Access denied: no permission found');
    return false;
  } catch(e) {
    console.error('Permission check error:', e);
    return false;
  }
}

// تقييم صلاحية سجل واحد
function evaluatePermission(userData) {
  const role = userData.role || '';
  const permissions = userData.permissions || {};
  const status = userData.status || 'active';
  
  // تحقق من الحالة النشطة
  if (status === 'suspended') {
    console.log('User account is suspended');
    return false;
  }
  
  // المالك والمدير لهم صلاحية كاملة
  if (role === 'owner' || role === 'admin') {
    console.log('Access granted: owner/admin role');
    return true;
  }
  
  // تحقق من صلاحية insurance
  if (permissions.insurance === true) {
    console.log('Access granted: insurance permission');
    return true;
  }
  
  return null; // لم يتم تحديد الصلاحية من هذا السجل
}

function showLoginScreen() {
  loginScreen.classList.remove('hidden');
  accessDenied.classList.add('hidden');
  mainApp.classList.add('hidden');
  logoutBtn.classList.add('hidden');
  document.getElementById('headerTabs').classList.remove('visible');
  userInfo.textContent = '';
}

function showAccessDenied() {
  loginScreen.classList.add('hidden');
  accessDenied.classList.remove('hidden');
  mainApp.classList.add('hidden');
  logoutBtn.classList.remove('hidden');
}

function showMainApp() {
  loginScreen.classList.add('hidden');
  accessDenied.classList.add('hidden');
  mainApp.classList.remove('hidden');
  logoutBtn.classList.remove('hidden');
  document.getElementById('headerTabs').classList.add('visible');
  userInfo.innerHTML = `<i class="fas fa-user"></i> ${currentUser.name}`;
  loadDoctorsList(); // تحميل قائمة الأطباء
}

async function loadDoctorsList() {
  try {
    // Get doctors from Staff sheet in the main Apps Script
    const response = await fetch(INSURANCE_APPS_SCRIPT, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'getStaffDoctors' })
    });
    const data = await response.json();
    
    const optionsContainer = document.getElementById('doctorOptions');
    optionsContainer.innerHTML = '';
    
    if (data.success && data.doctors) {
      // Also fill the task doctor dropdown
      const taskDoctorSelect = document.getElementById('taskDoctorSelect');
      if (taskDoctorSelect) {
        taskDoctorSelect.innerHTML = '<option value="">-- اختر الطبيب --</option>';
      }
      
      data.doctors.forEach(doc => {
        // Analysis tab dropdown
        const optionDiv = document.createElement('div');
        optionDiv.className = 'custom-dropdown-option';
        optionDiv.dataset.value = doc.name;
        optionDiv.innerHTML = `<span>${doc.name}</span>${doc.specialty ? `<span class="specialty">(${doc.specialty})</span>` : ''}`;
        optionDiv.addEventListener('click', () => selectDoctor(doc.name, doc.specialty));
        optionsContainer.appendChild(optionDiv);
        
        // Tasks tab dropdown
        if (taskDoctorSelect) {
          const option = document.createElement('option');
          option.value = doc.name;
          option.textContent = doc.name + (doc.specialty ? ` (${doc.specialty})` : '');
          taskDoctorSelect.appendChild(option);
        }
      });
      console.log('Loaded', data.doctors.length, 'doctors');
    }
  } catch(e) {
    console.error('Failed to load doctors:', e);
  }
}

function selectDoctor(name, specialty) {
  const hiddenInput = document.getElementById('doctorName');
  const selectedDiv = document.getElementById('doctorSelected');
  const optionsDiv = document.getElementById('doctorOptions');
  
  hiddenInput.value = name;
  selectedDiv.querySelector('span').textContent = name + (specialty ? ` - ${specialty}` : '');
  selectedDiv.classList.remove('active');
  optionsDiv.classList.remove('show');
  
  // Mark selected option
  optionsDiv.querySelectorAll('.custom-dropdown-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.value === name);
  });
  
  // Update sidebar summary and stepper
  updateSidebarSummary();
}

// Initialize custom dropdown
document.addEventListener('DOMContentLoaded', () => {
  const selectedDiv = document.getElementById('doctorSelected');
  const optionsDiv = document.getElementById('doctorOptions');
  
  if (selectedDiv) {
    selectedDiv.addEventListener('click', (e) => {
      e.stopPropagation();
      selectedDiv.classList.toggle('active');
      optionsDiv.classList.toggle('show');
    });
  }
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.custom-dropdown')) {
      selectedDiv?.classList.remove('active');
      optionsDiv?.classList.remove('show');
    }
  });
});

function loginWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => {
    console.error('Login error:', err);
    alert('حدث خطأ أثناء تسجيل الدخول');
  });
}

function loginWithEmail() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    alert('الرجاء إدخال البريد وكلمة المرور');
    return;
  }
  
  auth.signInWithEmailAndPassword(email, password)
    .catch(err => {
      console.error('Email login error:', err);
      if (err.code === 'auth/user-not-found') {
        alert('المستخدم غير موجود. استخدم "تسجيل جديد" للتسجيل أولاً');
      } else if (err.code === 'auth/wrong-password') {
        alert('كلمة المرور غير صحيحة');
      } else {
        alert('خطأ في تسجيل الدخول: ' + err.message);
      }
    });
}

function registerWithEmail() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    alert('الرجاء إدخال البريد وكلمة المرور');
    return;
  }
  
  if (password.length < 6) {
    alert('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
    return;
  }
  
  auth.createUserWithEmailAndPassword(email, password)
    .then(() => {
      alert('تم التسجيل بنجاح! سيتم التحقق من صلاحياتك...');
    })
    .catch(err => {
      console.error('Registration error:', err);
      if (err.code === 'auth/email-already-in-use') {
        alert('هذا البريد مسجل مسبقاً. استخدم "تسجيل الدخول"');
      } else if (err.code === 'auth/weak-password') {
        alert('كلمة المرور ضعيفة. استخدم 6 أحرف على الأقل');
      } else {
        alert('خطأ في التسجيل: ' + err.message);
      }
    });
}

function logout() {
  auth.signOut();
}

async function loadStats() {
  try {
    const response = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'getDashboardStats', email: currentUser.email })
    });
    const data = await response.json();
    
    if (data.success && data.stats) {
      document.getElementById('todayCases').textContent = data.stats.userTodayCases || 0;
      document.getElementById('totalCases').textContent = data.stats.userCases || 0;
      document.getElementById('totalDoctors').textContent = data.stats.totalDoctors || 0;
      document.getElementById('allTodayCases').textContent = data.stats.todayCases || 0;
    }
  } catch(e) {
    console.error('Stats load error:', e);
  }
}

async function loadDoctorStats() {
  try {
    const response = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'getDoctorStats' })
    });
    const data = await response.json();
    
    if (data.success && data.doctors) {
      renderDoctorStats(data.doctors);
    }
  } catch(e) {
    console.error('Doctor stats error:', e);
  }
}

function renderDoctorStats(doctors) {
  const tbody = document.getElementById('doctorsTableBody');
  tbody.innerHTML = '';
  
  // Render table
  doctors.forEach(doc => {
    const avgRating = parseFloat(doc.avgOverallRating) || 0;
    let badgeClass = 'rating-needs';
    if (avgRating >= 8) badgeClass = 'rating-excellent';
    else if (avgRating >= 5) badgeClass = 'rating-good';
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${doc.doctorName}</strong></td>
      <td>${doc.totalCases}</td>
      <td>${doc.avgInsuranceRating}/10</td>
      <td>${doc.avgServiceRating}/10</td>
      <td><strong>${doc.avgOverallRating}/10</strong></td>
      <td><span class="rating-badge ${badgeClass}">${doc.status}</span></td>
      <td>${doc.lastCaseDate || '-'}</td>
    `;
    tbody.appendChild(row);
  });
  
  // Render Bar Chart
  renderDoctorsChart(doctors);
}

let casesChartInstance = null;
let ratingsChartInstance = null;

function renderDoctorsChart(doctors) {
  if (typeof Chart === 'undefined') {
    setTimeout(() => renderDoctorsChart(doctors), 500);
    return;
  }
  
  const labels = doctors.map(d => d.doctorName);
  const casesData = doctors.map(d => parseInt(d.totalCases) || 0);
  const insuranceData = doctors.map(d => Math.min(Math.max(parseFloat(d.avgInsuranceRating) || 0, 0), 10));
  const serviceData = doctors.map(d => Math.min(Math.max(parseFloat(d.avgServiceRating) || 0, 0), 10));
  const maxCases = Math.max(...casesData, 5);
  
  // === رسم بياني عدد الحالات ===
  const casesCtx = document.getElementById('casesChart');
  if (casesCtx) {
    if (casesChartInstance) casesChartInstance.destroy();
    
    casesChartInstance = new Chart(casesCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'عدد الحالات',
          data: casesData,
          backgroundColor: 'rgba(201, 169, 98, 0.9)',
          borderColor: '#c9a962',
          borderWidth: 0,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            rtl: true,
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleFont: { family: 'Tajawal', size: 14, weight: 'bold' },
            bodyFont: { family: 'Tajawal', size: 13 },
            padding: 12,
            cornerRadius: 8,
            borderColor: '#c9a962',
            borderWidth: 1,
            callbacks: {
              label: ctx => `${ctx.raw} حالة`
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#c9a962', font: { family: 'Tajawal', size: 11, weight: 'bold' } },
            grid: { display: false }
          },
          y: {
            min: 0,
            max: maxCases + Math.ceil(maxCases * 0.2),
            ticks: { color: '#c9a962', font: { family: 'Tajawal', size: 10 } },
            grid: { color: 'rgba(201, 169, 98, 0.1)' }
          }
        }
      }
    });
  }
  
  // === رسم بياني التقييمات ===
  const ratingsCtx = document.getElementById('ratingsChart');
  if (ratingsCtx) {
    if (ratingsChartInstance) ratingsChartInstance.destroy();
    
    ratingsChartInstance = new Chart(ratingsCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'معايير التأمين',
            data: insuranceData,
            backgroundColor: 'rgba(34, 197, 94, 0.9)',
            borderColor: '#22c55e',
            borderWidth: 0,
            borderRadius: 6
          },
          {
            label: 'جودة الخدمات',
            data: serviceData,
            backgroundColor: 'rgba(59, 130, 246, 0.9)',
            borderColor: '#3b82f6',
            borderWidth: 0,
            borderRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'top',
            rtl: true,
            labels: {
              color: '#e2e8f0',
              font: { family: 'Tajawal', size: 12, weight: 'bold' },
              padding: 15,
              usePointStyle: true,
              pointStyle: 'rectRounded'
            }
          },
          tooltip: {
            rtl: true,
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleFont: { family: 'Tajawal', size: 14, weight: 'bold' },
            bodyFont: { family: 'Tajawal', size: 13 },
            padding: 12,
            cornerRadius: 8,
            borderColor: '#c9a962',
            borderWidth: 1,
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.raw.toFixed(1)}/10`
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#c9a962', font: { family: 'Tajawal', size: 11, weight: 'bold' } },
            grid: { display: false }
          },
          y: {
            min: 0,
            max: 10,
            ticks: { 
              color: '#94a3b8', 
              font: { family: 'Tajawal', size: 10 },
              stepSize: 2
            },
            grid: { color: 'rgba(148, 163, 184, 0.1)' }
          }
        }
      }
    });
  }
}


function extractAndApplyAIRatings(html) {
  try {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    const ratingsDiv = tempDiv.querySelector('#ai-ratings');
    if (ratingsDiv) {
      const insuranceSpan = ratingsDiv.querySelector('[data-insurance-rating]');
      const serviceSpan = ratingsDiv.querySelector('[data-service-rating]');
      
      if (insuranceSpan) {
        insuranceRatingValue = parseInt(insuranceSpan.getAttribute('data-insurance-rating')) || 0;
      }
      if (serviceSpan) {
        serviceRatingValue = parseInt(serviceSpan.getAttribute('data-service-rating')) || 0;
      }
    } else {
      const insuranceMatch = html.match(/data-insurance-rating="(\d+)"/);
      const serviceMatch = html.match(/data-service-rating="(\d+)"/);
      if (insuranceMatch) insuranceRatingValue = parseInt(insuranceMatch[1]) || 0;
      if (serviceMatch) serviceRatingValue = parseInt(serviceMatch[1]) || 0;
    }
    console.log('AI Ratings extracted:', { insurance: insuranceRatingValue, service: serviceRatingValue });
  } catch(e) {
    console.error('Error extracting AI ratings:', e);
  }
}


// Smart Excel Processing with Header Mapping and Validation
const MEDICAL_COLUMN_MAPPING = {
  'name': ['الاسم', 'اسم المريض', 'patient name', 'name', 'اسم', 'المريض'],
  'mrn': ['رقم الملف', 'mrn', 'medical record', 'رقم السجل', 'file no', 'رقم الملف الطبي', 'file number'],
  'age': ['العمر', 'age', 'السن', 'عمر'],
  'gender': ['الجنس', 'gender', 'sex', 'النوع'],
  'height': ['الطول', 'height', 'طول', 'الطول بالسم', 'height cm'],
  'weight': ['الوزن', 'weight', 'وزن', 'الوزن بالكجم', 'weight kg'],
  'bmi': ['مؤشر كتلة الجسم', 'bmi', 'body mass index'],
  'bp_systolic': ['الضغط الانقباضي', 'systolic', 'sbp', 'ضغط الدم العلوي', 'الضغط العلوي'],
  'bp_diastolic': ['الضغط الانبساطي', 'diastolic', 'dbp', 'ضغط الدم السفلي', 'الضغط السفلي'],
  'blood_pressure': ['ضغط الدم', 'blood pressure', 'bp', 'الضغط'],
  'pulse': ['النبض', 'pulse', 'heart rate', 'hr', 'نبض', 'معدل ضربات القلب', 'نبضات القلب'],
  'spo2': ['تشبع الأكسجين', 'spo2', 'oxygen saturation', 'o2 sat', 'الأكسجين', 'نسبة الأكسجين', 'oxygen'],
  'respiratory_rate': ['معدل التنفس', 'respiratory rate', 'rr', 'التنفس', 'عدد مرات التنفس', 'respiration'],
  'temperature': ['الحرارة', 'temperature', 'temp', 'درجة الحرارة'],
  'diagnosis': ['التشخيص', 'diagnosis', 'dx', 'المرض', 'التشخيص الرئيسي'],
  'icd10': ['رمز التشخيص', 'icd10', 'icd-10', 'icd code', 'رمز المرض', 'كود التشخيص'],
  'procedure': ['الإجراء', 'procedure', 'عملية', 'الإجراء الطبي'],
  'cpt': ['رمز الإجراء', 'cpt', 'cpt code', 'كود الإجراء'],
  'medications': ['الأدوية', 'medications', 'drugs', 'medicine', 'العلاج', 'الدواء'],
  'lab_results': ['نتائج المختبر', 'lab results', 'lab', 'التحاليل', 'المختبر'],
  'date': ['التاريخ', 'date', 'visit date', 'تاريخ الزيارة'],
  'insurance': ['التأمين', 'insurance', 'شركة التأمين', 'الضامن', 'payer'],
  'claim_status': ['حالة المطالبة', 'claim status', 'status', 'الحالة'],
  'notes': ['ملاحظات', 'notes', 'remarks', 'comments', 'التعليقات']
};

const VITAL_SIGNS_VALIDATION = {
  age: { min: 0, max: 120, unit: 'سنة', fieldAr: 'العمر' },
  height: { min: 30, max: 250, unit: 'سم', fieldAr: 'الطول' },
  weight: { min: 0.5, max: 350, unit: 'كجم', fieldAr: 'الوزن' },
  pulse: { min: 30, max: 220, unit: 'نبضة/دقيقة', fieldAr: 'النبض' },
  spo2: { min: 70, max: 100, unit: '%', fieldAr: 'تشبع الأكسجين' },
  respiratory_rate: { min: 8, max: 60, unit: '/دقيقة', fieldAr: 'معدل التنفس' },
  temperature: { min: 34, max: 42, unit: '°C', fieldAr: 'الحرارة' },
  bp_systolic: { min: 60, max: 250, unit: 'mmHg', fieldAr: 'الضغط الانقباضي' },
  bp_diastolic: { min: 30, max: 150, unit: 'mmHg', fieldAr: 'الضغط الانبساطي' }
};

function normalizeColumnName(name) {
  if (!name) return '';
  return String(name).toLowerCase().trim()
    .replace(/[_\-\.]/g, ' ')
    .replace(/\s+/g, ' ');
}

function findColumnMapping(headerRow) {
  const mapping = {};
  if (!headerRow || !Array.isArray(headerRow)) return mapping;
  
  headerRow.forEach((header, index) => {
    const normalized = normalizeColumnName(header);
    if (!normalized) return;
    
    for (const [standardField, aliases] of Object.entries(MEDICAL_COLUMN_MAPPING)) {
      for (const alias of aliases) {
        const normalizedAlias = normalizeColumnName(alias);
        if (normalized === normalizedAlias || 
            (normalized.length > 3 && normalizedAlias.length > 3 && 
             (normalized.startsWith(normalizedAlias) || normalizedAlias.startsWith(normalized)))) {
          if (!mapping[standardField]) {
            mapping[standardField] = { index, originalName: header };
          }
          break;
        }
      }
    }
  });
  
  return mapping;
}

function validateVitalSign(field, value) {
  const rules = VITAL_SIGNS_VALIDATION[field];
  if (!rules) return { valid: true };
  
  const numValue = parseFloat(value);
  if (isNaN(numValue)) return { valid: true };
  
  if (numValue < rules.min || numValue > rules.max) {
    return {
      valid: false,
      warning: `قيمة ${rules.fieldAr} (${numValue} ${rules.unit}) خارج النطاق الطبيعي (${rules.min}-${rules.max})`,
      field: rules.fieldAr,
      value: numValue,
      range: `${rules.min}-${rules.max}`
    };
  }
  return { valid: true };
}

function detectDataShiftErrors(records) {
  const errors = [];
  let impossibleCount = 0;
  
  records.forEach((record, idx) => {
    const recordErrors = [];
    
    for (const [field, value] of Object.entries(record)) {
      if (value === null || value === undefined || value === '') continue;
      const validation = validateVitalSign(field, value);
      if (!validation.valid) {
        recordErrors.push(validation);
        impossibleCount++;
      }
    }
    
    if (recordErrors.length > 0) {
      errors.push({ recordIndex: idx + 1, errors: recordErrors });
    }
  });
  
  if (impossibleCount > records.length * 0.3) {
    return {
      hasSystematicError: true,
      message: `⚠️ تحذير: تم اكتشاف ${impossibleCount} قيمة غير منطقية في ${errors.length} سجل. قد يكون هناك خطأ في ترتيب أعمدة الملف أو في تصدير البيانات. يرجى التحقق من صحة البيانات قبل الاعتماد على نتائج التحليل.`,
      errors
    };
  }
  
  return { hasSystematicError: false, errors };
}

function processExcelWithSmartMapping(allData) {
  const warnings = [];
  let processedText = '';
  let totalErrors = 0;
  let totalRecords = 0;
  
  allData.forEach(sheetData => {
    const { sheet, data } = sheetData;
    if (!data || data.length < 2) {
      processedText += `=== ${sheet} ===\n(بيانات فارغة)\n\n`;
      return;
    }
    
    const headerRow = data[0];
    const columnMapping = findColumnMapping(headerRow);
    const mappedFields = Object.keys(columnMapping);
    
    processedText += `=== ${sheet} ===\n`;
    
    if (mappedFields.length > 0) {
      const fieldNames = mappedFields.map(f => {
        const rules = VITAL_SIGNS_VALIDATION[f];
        return rules ? rules.fieldAr : MEDICAL_COLUMN_MAPPING[f]?.[0] || f;
      });
      processedText += `[تم التعرف على الحقول: ${fieldNames.join(', ')}]\n\n`;
    }
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (!row || row.every(cell => !cell)) continue;
      totalRecords++;
      
      let hasError = false;
      const formattedFields = [];
      
      for (const [field, { index, originalName }] of Object.entries(columnMapping)) {
        const value = row[index];
        if (value === null || value === undefined || value === '') continue;
        
        const rules = VITAL_SIGNS_VALIDATION[field];
        const fieldLabel = rules ? rules.fieldAr : originalName;
        
        if (rules) {
          const numValue = parseFloat(value);
          if (!isNaN(numValue) && (numValue < rules.min || numValue > rules.max)) {
            formattedFields.push(`${fieldLabel}: [خطأ في البيانات - القيمة ${numValue} خارج النطاق ${rules.min}-${rules.max}]`);
            hasError = true;
          } else {
            formattedFields.push(`${fieldLabel}: ${value}`);
          }
        } else {
          formattedFields.push(`${fieldLabel}: ${value}`);
        }
      }
      
      for (let j = 0; j < headerRow.length; j++) {
        const isMapped = Object.values(columnMapping).some(m => m.index === j);
        if (!isMapped && row[j]) {
          formattedFields.push(`${headerRow[j]}: ${row[j]}`);
        }
      }
      
      if (hasError) totalErrors++;
      processedText += `سجل ${i}: ${formattedFields.join(' | ')}\n`;
    }
    
    processedText += '\n';
  });
  
  if (totalRecords > 0 && totalErrors > totalRecords * 0.3) {
    const systemWarning = `⚠️ تحذير هام: تم اكتشاف ${totalErrors} سجل من أصل ${totalRecords} يحتوي على قيم مستحيلة طبياً (${Math.round(totalErrors/totalRecords*100)}%). هذا يشير إلى خطأ في ترتيب أعمدة الملف أو في تصدير البيانات. القيم الخاطئة تم وسمها بـ [خطأ في البيانات]. يرجى عدم الاعتماد على هذه القيم في التحليل السريري.`;
    warnings.push(systemWarning);
    processedText = `[تحذير جودة البيانات]\n${systemWarning}\n\n` + processedText;
  } else if (totalErrors > 0) {
    warnings.push(`تحذير: ${totalErrors} سجل يحتوي على قيم خارج النطاق الطبيعي`);
  }
  
  return { textContent: processedText, warnings };
}

// File Handling
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
});
dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag'));
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
dropZone.addEventListener('drop', e => {
  dropZone.classList.remove('drag');
  handleFiles(Array.from(e.dataTransfer.files));
});
fileInput.addEventListener('change', () => handleFiles(Array.from(fileInput.files)));

// Filtered file pickers
function openFilePicker(type) {
  const pickers = {
    'images': document.getElementById('imageFilePicker'),
    'pdf': document.getElementById('pdfFilePicker'),
    'excel': document.getElementById('excelFilePicker')
  };
  if (pickers[type]) pickers[type].click();
}

document.getElementById('imageFilePicker')?.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));
document.getElementById('pdfFilePicker')?.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));
document.getElementById('excelFilePicker')?.addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));

async function handleFiles(files) {
  const progressContainer = document.getElementById('progressContainer');
  const progressText = document.getElementById('progressText');
  const fileProgress = document.getElementById('fileProgress');
  
  // Defensive checks for progress elements
  const hasProgressUI = progressContainer && progressText && fileProgress;
  
  statusText.textContent = 'جاري معالجة الملفات...';
  statusMsg.style.display = 'flex';
  if (hasProgressUI) progressContainer.classList.add('active');
  
  // Track completed work units (each page/file = 1 unit)
  let completedUnits = 0;
  let totalUnits = files.length; // Start with file count, will be updated for PDFs

  for (const f of files) {
    const ext = f.name.split('.').pop().toLowerCase();
    
    if (f.type === 'application/pdf') {
      try {
        if (hasProgressUI) progressText.textContent = `جاري قراءة PDF: ${f.name}...`;
        const arrayBuffer = await f.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(new Uint8Array(arrayBuffer)).promise;
        
        // Replace this file's 1 unit with actual page count
        totalUnits += pdf.numPages - 1;
        
        for (let i = 1; i <= pdf.numPages; i++) {
          if (hasProgressUI) {
            progressText.textContent = `معالجة صفحة ${i} من ${pdf.numPages} - ${f.name}`;
          }
          
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          await page.render({ canvasContext: context, viewport: viewport }).promise;
          
          const base64Url = canvas.toDataURL('image/jpeg', 0.8);
          filesState.push({ 
            name: `${f.name} - صفحة ${i}`, 
            mimeType: 'image/jpeg', 
            data: base64Url,
            isExcel: false
          });
          completedUnits++;
          if (hasProgressUI) fileProgress.value = Math.round((completedUnits / totalUnits) * 100);
          renderFiles();
          await new Promise(requestAnimationFrame); // Yield to UI
        }
      } catch(err) {
        console.error("PDF error:", err);
        alert(`خطأ في معالجة PDF: ${err.message}`);
      }
    } else if (['xlsx', 'xls', 'csv'].includes(ext)) {
      try {
        if (hasProgressUI) {
          progressText.textContent = `جاري معالجة ملف Excel: ${f.name}...`;
          fileProgress.value = Math.round((completedUnits / totalUnits) * 100);
        }
        
        const arrayBuffer = await f.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        let allData = [];
        workbook.SheetNames.forEach(sheetName => {
          const sheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          allData.push({ sheet: sheetName, data: jsonData });
        });
        
        const processedData = processExcelWithSmartMapping(allData);
        
        filesState.push({ 
          name: f.name, 
          mimeType: 'text/plain', 
          data: processedData.textContent,
          textContent: processedData.textContent,
          isExcel: true,
          dataQualityWarnings: processedData.warnings
        });
        completedUnits++;
        if (hasProgressUI) fileProgress.value = Math.round((completedUnits / totalUnits) * 100);
        renderFiles();
      } catch(err) {
        console.error("Excel error:", err);
        alert(`خطأ في معالجة Excel: ${err.message}`);
        completedUnits++; // Count as done even on error
      }
    } else {
      if (hasProgressUI) {
        progressText.textContent = `جاري معالجة: ${f.name}...`;
        fileProgress.value = Math.round((completedUnits / totalUnits) * 100);
      }
      
      const base64Url = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = reject;
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(f);
      });
      filesState.push({ 
        name: f.name, 
        mimeType: f.type || 'image/jpeg', 
        data: base64Url,
        isExcel: false
      });
      completedUnits++;
      if (hasProgressUI) fileProgress.value = Math.round((completedUnits / totalUnits) * 100);
    }
  }
  
  // Show 100% briefly before hiding
  if (hasProgressUI) {
    fileProgress.value = 100;
    progressText.textContent = 'اكتملت المعالجة!';
  }
  await new Promise(resolve => setTimeout(resolve, 300)); // Brief 100% visibility
  
  renderFiles();
  statusMsg.style.display = 'none';
  if (progressContainer) progressContainer.classList.remove('active');
  if (fileProgress) fileProgress.value = 0;
  fileInput.value = '';
}

function renderFiles() {
  filesGrid.innerHTML = '';
  filesState.forEach((f, i) => {
    const el = document.createElement('div');
    el.className = 'file-card';
    
    if (f.isExcel) {
      el.innerHTML = `
        <button class="remove" data-index="${i}" title="إزالة"><i class="fas fa-times"></i></button>
        <div class="excel-preview"><i class="fas fa-file-excel"></i></div>
        <div class="meta">${f.name}</div>
      `;
    } else {
      el.innerHTML = `
        <button class="remove" data-index="${i}" title="إزالة"><i class="fas fa-times"></i></button>
        <img src="${f.data}" alt="${f.name}">
        <div class="meta">${f.name}</div>
      `;
    }
    filesGrid.appendChild(el);
  });
  
  filesGrid.querySelectorAll('.remove').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const i = +e.currentTarget.dataset.index;
      filesState.splice(i, 1);
      renderFiles();
    });
  });
  
  const manualText = document.getElementById('manualCaseInput')?.value?.trim() || '';
  analyzeBtn.disabled = filesState.length === 0 && manualText.length === 0;
  
  // Update sidebar summary
  updateSidebarSummary();
}

document.getElementById('manualCaseInput')?.addEventListener('input', () => {
  renderFiles();
  updateSidebarSummary();
});

function getHijriDate() {
  try {
    return new Date().toLocaleDateString('ar-SA-u-ca-islamic-umalqura', 
      { day: 'numeric', month: 'long', year: 'numeric' });
  } catch(e) { return ''; }
}

function getGregorianDate() {
  return new Date().toLocaleDateString('ar-SA', { day: 'numeric', month: 'long', year: 'numeric' });
}

// Scroll to report actions (save/print)
function scrollToReportActions() {
  const reportActions = document.querySelector('.report-actions');
  if (reportActions) {
    reportActions.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// Show/hide quick actions FAB based on report visibility
function updateQuickActionsFab() {
  const fab = document.getElementById('quickActionsFab');
  const reportSection = document.getElementById('reportSection');
  if (fab && reportSection) {
    if (reportSection.classList.contains('show') && originalReport) {
      fab.classList.remove('hidden');
    } else {
      fab.classList.add('hidden');
    }
  }
}

// Highlight rejected cells with red background
function highlightRejectedCells() {
  const reportContent = document.getElementById('reportContent');
  if (!reportContent) return;
  
  // Find all table cells
  const cells = reportContent.querySelectorAll('td');
  cells.forEach(cell => {
    const text = cell.textContent.trim();
    // Check for rejection keywords
    if (text.includes('مرفوض') || text === 'مرفوض' || text.includes('❌ مرفوض')) {
      cell.style.background = '#dc2626';
      cell.style.color = 'white';
      cell.style.fontWeight = 'bold';
      cell.style.borderRadius = '6px';
      cell.style.padding = '8px 12px';
    }
    // Highlight accepted cells
    if (text.includes('مقبول') || text === 'مقبول' || text.includes('✅ مقبول')) {
      cell.style.background = '#16a34a';
      cell.style.color = 'white';
      cell.style.fontWeight = 'bold';
      cell.style.borderRadius = '6px';
    }
    // Highlight warning cells
    if (text.includes('تحذير') || text === 'تحذير' || text.includes('⚠️ تحذير')) {
      cell.style.background = '#f59e0b';
      cell.style.color = 'white';
      cell.style.fontWeight = 'bold';
      cell.style.borderRadius = '6px';
    }
  });
}

analyzeBtn.addEventListener('click', async () => {
  const manualText = document.getElementById('manualCaseInput')?.value?.trim() || '';
  
  if (filesState.length === 0 && manualText.length === 0) return;
  
  const doctorName = doctorNameInput.value.trim();
  if (!doctorName) {
    alert('يرجى إدخال اسم الطبيب المعالج');
    doctorNameInput.focus();
    return;
  }
  
  analyzeBtn.disabled = true;
  statusText.textContent = 'جاري التدقيق الطبي وفقاً لمعايير الصحة العالمية...';
  statusMsg.style.display = 'flex';
  reportSection.classList.remove('show');
  currentLang = 'ar';
  document.getElementById('translateText').textContent = 'English';
  
  // Reset ratings
  insuranceRatingValue = 0;
  serviceRatingValue = 0;

  // إضافة النص المكتوب يدوياً كملف نصي
  let filesToSend = [...filesState];
  if (manualText.length > 0) {
    filesToSend.push({
      name: 'manual-input.txt',
      isExcel: true,
      textContent: manualText,
      data: manualText
    });
  }

  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        files: filesToSend, 
        lang: 'ar',
        doctorName: doctorName
      })
    });

    const data = await resp.json();
    
    if (data.success) {
      const printHeader = `
        <div class="print-header" style="border-bottom:3px solid #1e3a5f;padding-bottom:15px;margin-bottom:20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:10px;">
              <div style="width:40px;height:40px;border:2px solid #1e3a5f;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#1e3a5f;font-size:12px;">MCC</div>
              <div>
                <div style="font-weight:bold;color:#1e3a5f;font-size:14px;">مجمع مكة الطبي بالزاهر</div>
                <div style="font-size:11px;color:#666;">قسم متابعة الجودة والتدقيق الطبي</div>
              </div>
            </div>
            <div style="text-align:left;font-size:12px;color:#666;">
              <div>${getHijriDate()}</div>
              <div>${getGregorianDate()}</div>
            </div>
          </div>
          <h1 style="text-align:center;color:#1e3a5f;margin:15px 0 10px;font-size:18px;border:none;padding:0;">تقرير مراجعة جودة الرعاية الطبية</h1>
          <p style="text-align:center;color:#666;font-size:12px;margin:0;">الطبيب المعالج: <strong>${doctorName}</strong></p>
        </div>
        <div style="background:#f0f9ff;border:2px solid #0ea5e9;border-radius:8px;padding:12px;margin-bottom:20px;text-align:center;font-size:13px;color:#0369a1;">
          <strong>تقرير صادر عن قسم متابعة الجودة والتدقيق الطبي</strong><br>
          موافق مع حوكمة المجمع ومتطلبات CBAHI<br>
          <span style="color:#dc2626;font-weight:bold;">يجب معالجة القضايا المرصودة والمحددة في هذا التقرير من قبل الطبيب المعالج</span>
        </div>
      `;
      
      const printFooter = `
        <div class="report-footer-box" style="margin-top:30px;padding:20px;border:2px solid #1e3a5f;border-radius:10px;background:#f8fafc;">
          <div style="text-align:center;margin-bottom:10px;">
            <strong style="color:#1e3a5f;font-size:14px;">مجمع مكة الطبي بالزاهر</strong>
          </div>
          <div style="background:#e0f2fe;padding:12px;border-radius:6px;text-align:center;font-size:12px;color:#0369a1;line-height:1.8;">
            هذا التقرير صادر من <strong>قسم متابعة الجودة ومراقبة مستوى تقديم الخدمات الطبية</strong><br>
            ويُعد وثيقة رسمية لتحسين جودة الرعاية الصحية المقدمة
          </div>
          <div style="margin-top:15px;display:flex;justify-content:space-between;font-size:11px;color:#666;">
            <span>المراجع: ${currentUser.name}</span>
            <span>www.m2020m.org</span>
          </div>
        </div>
      `;
      
      // Sanitize HTML with DOMPurify for XSS protection
      const sanitizedHtml = typeof DOMPurify !== 'undefined' 
        ? DOMPurify.sanitize(data.html, { ADD_ATTR: ['style'], ALLOW_DATA_ATTR: false })
        : data.html;
      
      originalReport = printHeader + sanitizedHtml + printFooter;
      translatedReport = '';
      reportContent.innerHTML = originalReport;
      highlightRejectedCells();
      reportSection.classList.add('show');
      updateQuickActionsFab();
      reportSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // Update stepper to step 3 (Result)
      updateStepper(3);
      
      // Extract AI ratings automatically
      extractAndApplyAIRatings(sanitizedHtml);
      
      // Save report to task if analyzing from task
      if (currentAnalyzingTaskId) {
        await saveReportToTask(currentAnalyzingTaskId, originalReport);
      }
    } else {
      throw new Error(data.error || 'فشل في التحليل');
    }

  } catch (err) {
    console.error('Analysis error:', err);
    // Sanitize error message to prevent XSS
    const safeErrorMsg = err.message ? err.message.replace(/[<>&"']/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;'}[c])) : 'خطأ غير معروف';
    reportContent.innerHTML = `
      <div style="background:#fee2e2;border:2px solid #ef4444;padding:2rem;border-radius:12px;text-align:center;">
        <h3 style="color:#dc2626;margin:0 0 1rem;"><i class="fas fa-exclamation-triangle"></i> حدث خطأ</h3>
        <p style="color:#7f1d1d;">${safeErrorMsg}</p>
      </div>
    `;
    reportSection.classList.add('show');
  } finally {
    analyzeBtn.disabled = false;
    statusMsg.style.display = 'none';
  }
});

async function saveAndLog() {
  const doctorName = doctorNameInput.value.trim();
  
  const saveBtn = document.getElementById('saveBtn');
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
  
  try {
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    const timeStr = today.toTimeString().split(' ')[0].replace(/:/g, '');
    const fileName = `تقرير_${doctorName}_${dateStr}_${timeStr}.html`;
    
    // Get clean content
    let cleanContent = reportContent.innerHTML;
    cleanContent = cleanContent.replace(/<div id="ai-ratings"[^>]*>[\s\S]*?<\/div>/gi, '');
    cleanContent = cleanContent.replace(/<script[\s\S]*?<\/script>/gi, '');
    
    // Create full HTML document for saving
    const htmlContent = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${fileName}</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Tajawal', Arial, sans-serif; direction: rtl; padding: 20px; background: #f8fafc; color: #1e293b; line-height: 1.8; }
    @media print { body { background: white; padding: 10mm; } }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: right; }
    th { background: #1e3a5f; color: white; }
    .status-accepted { background: #16a34a !important; color: white !important; font-weight: bold; border-radius: 6px; }
    .status-rejected { background: #dc2626 !important; color: white !important; font-weight: bold; border-radius: 6px; }
    .status-needs-correction, .status-warning { background: #f59e0b !important; color: white !important; font-weight: bold; border-radius: 6px; }
  </style>
</head>
<body>
  <div style="border-bottom:3px solid #1e3a5f;padding-bottom:15px;margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:40px;height:40px;border:2px solid #1e3a5f;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#1e3a5f;font-size:12px;">MCC</div>
        <div>
          <div style="font-weight:bold;color:#1e3a5f;font-size:14px;">مجمع مكة الطبي بالزاهر</div>
          <div style="font-size:11px;color:#666;">قسم متابعة الجودة والتدقيق الطبي</div>
        </div>
      </div>
      <div style="text-align:left;font-size:12px;color:#666;">
        <div>${getHijriDate()}</div>
        <div>${getGregorianDate()}</div>
      </div>
    </div>
    <h1 style="text-align:center;color:#1e3a5f;margin:15px 0 10px;font-size:18px;">تقرير مراجعة جودة الرعاية الطبية</h1>
    <p style="text-align:center;color:#666;font-size:12px;margin:0;">الطبيب المعالج: <strong>${doctorName}</strong></p>
  </div>
  <div style="background:#f0f9ff;border:2px solid #0ea5e9;border-radius:8px;padding:12px;margin-bottom:20px;text-align:center;font-size:13px;color:#0369a1;">
    <strong>تقرير صادر عن قسم متابعة الجودة والتدقيق الطبي</strong><br>
    موافق مع حوكمة المجمع ومتطلبات CBAHI<br>
    <span style="color:#dc2626;font-weight:bold;">يجب معالجة القضايا المرصودة والمحددة في هذا التقرير من قبل الطبيب المعالج</span>
  </div>
  ${cleanContent}
  <div style="margin-top:30px;padding:20px;border:2px solid #1e3a5f;border-radius:10px;background:#f8fafc;">
    <div style="text-align:center;margin-bottom:10px;">
      <strong style="color:#1e3a5f;font-size:14px;">مجمع مكة الطبي بالزاهر</strong>
    </div>
    <div style="background:#e0f2fe;padding:12px;border-radius:6px;text-align:center;font-size:12px;color:#0369a1;line-height:1.8;">
      هذا التقرير صادر من <strong>قسم متابعة الجودة ومراقبة مستوى تقديم الخدمات الطبية</strong><br>
      ويُعد وثيقة رسمية لتحسين جودة الرعاية الصحية المقدمة
    </div>
    <div style="margin-top:15px;display:flex;justify-content:space-between;font-size:11px;color:#666;">
      <span>المراجع: ${currentUser.name}</span>
      <span>www.m2020m.org</span>
    </div>
  </div>
</body>
</html>`;
    
    // Save HTML to Drive
    console.log('📤 Sending save request to Google Apps Script...');
    const saveData = {
      action: 'logUsageAndSaveHTML',
      userEmail: currentUser.email,
      userName: currentUser.name,
      doctorName: doctorName,
      caseType: 'مراجعة تأمين',
      filesCount: filesState.length,
      insuranceRating: insuranceRatingValue,
      serviceRating: serviceRatingValue,
      notes: '',
      htmlContent: htmlContent,
      fileName: fileName
    };
    
    const response = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(saveData)
    });
    
    const resultText = await response.text();
    let result;
    try {
      result = JSON.parse(resultText);
    } catch(e) {
      result = { success: false, error: resultText };
    }
    
    if (result.success) {
      // Drive فقط - بدون تنزيل
      alert('✅ تم حفظ التقرير في Google Drive بنجاح!\n\n📂 يمكنك الوصول للتقرير من Drive أو طباعته مباشرة.');
    } else {
      alert('⚠️ لم يتم الحفظ في Drive: ' + (result.error || 'خطأ غير معروف'));
    }
    
    loadStats();
    loadDoctorStats();
    
  } catch(err) {
    console.error('Save error:', err);
    alert('حدث خطأ أثناء الحفظ: ' + err.message);
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-save"></i> حفظ وتسجيل';
  }
}

async function translateReport() {
  const translateBtn = document.getElementById('translateBtn');
  const translateText = document.getElementById('translateText');
  
  if (currentLang === 'ar') {
    if (translatedReport) {
      reportContent.innerHTML = translatedReport;
      currentLang = 'en';
      translateText.textContent = 'العربية';
      return;
    }
    
    translateBtn.disabled = true;
    translateText.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          files: filesState, 
          lang: 'en' 
        })
      });

      const data = await resp.json();
      
      if (data.success) {
        const doctorName = doctorNameInput.value.trim();
        const printHeader = `
          <div class="print-header" style="direction: ltr;">
            <img src="https://www.m2020m.org/logo-transparent.png" alt="Logo">
            <div class="print-header-text">
              <h1 style="font-family: Arial, sans-serif;">Medical Care Quality Review Report</h1>
              <p style="font-family: Arial, sans-serif;">Makkah Medical Complex - Insurance Experts</p>
              <p style="font-family: Arial, sans-serif;">Doctor: ${doctorName}</p>
            </div>
            <div class="print-header-dates">
              <div>${new Date().toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' })}</div>
            </div>
          </div>
        `;
        
        const printFooter = `
          <div class="print-footer" style="direction: ltr; font-family: Arial, sans-serif;">
            <strong>Makkah Medical Complex Al-Zaher</strong> - All Rights Reserved<br>
            www.m2020m.org | Reviewer: ${currentUser.name}
          </div>
        `;
        
        translatedReport = printHeader + data.html + printFooter;
        reportContent.innerHTML = translatedReport;
        currentLang = 'en';
        translateText.textContent = 'العربية';
      }
    } catch(err) {
      console.error('Translation error:', err);
      alert('حدث خطأ أثناء الترجمة');
    } finally {
      translateBtn.disabled = false;
    }
  } else {
    reportContent.innerHTML = originalReport;
    currentLang = 'ar';
    translateText.textContent = 'English';
  }
}

function resetAnalysis() {
  filesState.length = 0;
  renderFiles();
  reportSection.classList.remove('show');
  reportContent.innerHTML = '';
  originalReport = '';
  translatedReport = '';
  currentLang = 'ar';
  doctorNameInput.value = '';
  document.getElementById('doctorSelected').querySelector('span').textContent = '-- اختر الطبيب --';
  document.querySelectorAll('.custom-dropdown-option').forEach(opt => opt.classList.remove('selected'));
  updateQuickActionsFab(); // Hide FAB
  insuranceRatingValue = 0;
  serviceRatingValue = 0;
  document.getElementById('translateText').textContent = 'English';
  
  // مسح حقل الإدخال اليدوي
  document.getElementById('manualCaseInput').value = '';
  
  // مسح حقل الملفات
  document.getElementById('fileInput').value = '';
  
  // تعطيل زر المراجعة
  analyzeBtn.disabled = true;
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ============================================
// TASKS MANAGEMENT SYSTEM
// ============================================

let tasksData = [];
let currentAnalyzingTaskId = null;
let currentDeliveryTask = null;
let signatureCanvas, signatureCtx;
let signatureStore = []; // Store signatures for viewing
let isDrawing = false;

// Tab Switching
function switchTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  document.querySelector(`[onclick="switchTab('${tabName}')"]`)?.classList.add('active');
  document.getElementById(tabName + 'Tab').classList.add('active');
  
  // Update header tab buttons
  document.getElementById('headerAnalysisBtn')?.classList.toggle('active', tabName === 'analysis');
  document.getElementById('headerTasksBtn')?.classList.toggle('active', tabName === 'tasks');
  
  if (tabName === 'tasks') {
    loadTasksDoctorDropdown();
    loadTasks();
    loadDeliveryLog();
  }
  
  // Scroll to top on tab switch
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ============================================
// STEPPER SYSTEM
// ============================================

let currentStepperStep = 1;

function updateStepper(step) {
  currentStepperStep = step;
  
  for (let i = 1; i <= 3; i++) {
    const stepEl = document.getElementById('step' + i);
    const connectorEl = document.getElementById('connector' + (i - 1));
    
    if (stepEl) {
      stepEl.classList.remove('active', 'completed');
      if (i < step) {
        stepEl.classList.add('completed');
      } else if (i === step) {
        stepEl.classList.add('active');
      }
    }
    
    if (connectorEl) {
      connectorEl.classList.toggle('completed', i < step);
    }
  }
}

function goToStep(step) {
  if (step <= currentStepperStep || step === currentStepperStep + 1) {
    updateStepper(step);
    
    // Scroll to relevant section
    if (step === 1) {
      document.getElementById('doctorDropdown')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else if (step === 2) {
      document.getElementById('dropZone')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else if (step === 3) {
      document.getElementById('reportSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
}

// ============================================
// SIDEBAR SUMMARY SYSTEM
// ============================================

function updateSidebarSummary() {
  const doctorName = document.getElementById('doctorName')?.value || '';
  const summaryDoctor = document.getElementById('summaryDoctor');
  const summaryFilesCount = document.getElementById('summaryFilesCount');
  const summaryPdfPages = document.getElementById('summaryPdfPages');
  const summaryExcelCount = document.getElementById('summaryExcelCount');
  const sidebarAnalyzeBtn = document.getElementById('sidebarAnalyzeBtn');
  
  // Update doctor name
  if (summaryDoctor) {
    summaryDoctor.textContent = doctorName || 'لم يُحدد';
  }
  
  // Count files by type
  let pdfPages = 0;
  let excelCount = 0;
  let totalFiles = filesState.length;
  
  filesState.forEach(f => {
    if (f.isExcel) {
      excelCount++;
    } else if (f.name.includes('صفحة')) {
      pdfPages++;
    }
  });
  
  if (summaryFilesCount) summaryFilesCount.textContent = totalFiles;
  if (summaryPdfPages) summaryPdfPages.textContent = pdfPages;
  if (summaryExcelCount) summaryExcelCount.textContent = excelCount;
  
  // Update sidebar analyze button state
  const canAnalyze = (doctorName && totalFiles > 0) || document.getElementById('manualCaseInput')?.value.trim();
  if (sidebarAnalyzeBtn) {
    sidebarAnalyzeBtn.disabled = !canAnalyze;
  }
  
  // Update stepper based on progress
  if (doctorName && !totalFiles) {
    updateStepper(2);
  } else if (doctorName && totalFiles > 0) {
    updateStepper(2);
  } else {
    updateStepper(1);
  }
}

// Load doctors for task dropdown - called by loadDoctorsList already
// This is a fallback if loadDoctorsList doesn't populate the task dropdown
async function loadTasksDoctorDropdown() {
  // loadDoctorsList already populates taskDoctorSelect, so just check if it's populated
  const select = document.getElementById('taskDoctorSelect');
  if (select && select.options.length > 1) {
    console.log('Task doctor dropdown already populated');
    return;
  }
  // If not populated, call loadDoctorsList
  await loadDoctorsList();
}

// Toast Notification System
// File preview and remove functions
function showFilePreview(input) {
  const preview = document.getElementById('selectedFilePreview');
  const fileName = document.getElementById('selectedFileName');
  const uploadZone = document.querySelector('.file-upload-zone');
  const uploadBtn = document.getElementById('uploadTaskBtn');
  
  if (input.files && input.files[0]) {
    fileName.textContent = input.files[0].name;
    preview.style.display = 'flex';
    uploadZone.style.display = 'none';
    uploadBtn.disabled = false;
  } else {
    preview.style.display = 'none';
    uploadZone.style.display = 'block';
    uploadBtn.disabled = true;
  }
}

function removeSelectedFile(event) {
  event.stopPropagation();
  const fileInput = document.getElementById('taskFileInput');
  const preview = document.getElementById('selectedFilePreview');
  const uploadZone = document.querySelector('.file-upload-zone');
  const uploadBtn = document.getElementById('uploadTaskBtn');
  
  fileInput.value = '';
  preview.style.display = 'none';
  uploadZone.style.display = 'block';
  uploadBtn.disabled = true;
}

function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: 'fa-check-circle',
    error: 'fa-exclamation-circle',
    info: 'fa-info-circle'
  };
  
  toast.innerHTML = `<i class="fas ${icons[type]}"></i> <span>${message}</span>`;
  container.appendChild(toast);
  
  // Remove after animation
  setTimeout(() => toast.remove(), 4000);
}

// Upload new task
async function uploadTask() {
  const doctorSelect = document.getElementById('taskDoctorSelect');
  const fileInput = document.getElementById('taskFileInput');
  
  const doctor = doctorSelect.value;
  const file = fileInput.files[0];
  
  if (!doctor) {
    showToast('الرجاء اختيار الطبيب', 'error');
    return;
  }
  if (!file) {
    showToast('الرجاء رفع ملف الإكسل', 'error');
    return;
  }
  
  const btn = document.querySelector('.btn-upload-task');
  btn.disabled = true;
  btn.classList.add('uploading');
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع...';
  
  try {
    // Read file as base64
    const reader = new FileReader();
    reader.onload = async function(e) {
      const base64Data = e.target.result.split(',')[1];
      
      const response = await fetch(TASKS_API_URL + '?action=addTask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          doctorName: doctor,
          fileName: file.name,
          fileData: base64Data,
          uploadedBy: currentUser.name
        })
      });
      
      const result = await response.json();
      
      btn.disabled = false;
      btn.classList.remove('uploading');
      btn.innerHTML = '<i class="fas fa-plus-circle"></i> إضافة المهمة';
      
      if (result.success) {
        // Success animation
        btn.classList.add('success-flash');
        setTimeout(() => btn.classList.remove('success-flash'), 600);
        
        showToast('تم إضافة المهمة بنجاح!', 'success');
        doctorSelect.value = '';
        fileInput.value = '';
        // Reset file preview
        document.getElementById('selectedFilePreview').style.display = 'none';
        document.querySelector('.file-upload-zone').style.display = 'block';
        document.getElementById('uploadTaskBtn').disabled = true;
        await loadTasks();
        updateTasksBadge();
        
        // Scroll to pending tasks section
        const pendingSection = document.getElementById('pendingTasksGrid');
        if (pendingSection) {
          pendingSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } else {
        showToast('خطأ: ' + (result.error || 'فشل في إضافة المهمة'), 'error');
      }
    };
    reader.readAsDataURL(file);
  } catch(err) {
    console.error('Upload task error:', err);
    showToast('حدث خطأ أثناء رفع المهمة', 'error');
    btn.disabled = false;
    btn.classList.remove('uploading');
    btn.innerHTML = '<i class="fas fa-plus-circle"></i> إضافة المهمة';
  }
}

// Load pending tasks
async function loadTasks() {
  try {
    const response = await fetch(TASKS_API_URL + '?action=getTasks');
    const data = await response.json();
    
    const grid = document.getElementById('pendingTasksGrid');
    
    if (data.success && data.tasks && data.tasks.length > 0) {
      tasksData = data.tasks;
      
      grid.innerHTML = data.tasks.map((task, index) => `
        <div class="task-card">
          <div class="task-header">
            <span class="task-doctor"><i class="fas fa-user-md"></i> ${task.doctorName}</span>
            <span class="task-status ${task.status}">${getStatusLabel(task.status)}</span>
          </div>
          <div class="task-info">
            <p><i class="fas fa-file-excel"></i> ${task.fileName}</p>
            <p><i class="fas fa-user"></i> رُفع بواسطة: ${task.uploadedBy}</p>
            <p><i class="fas fa-calendar"></i> ${task.uploadDate}</p>
            ${task.analyzedBy ? `<p><i class="fas fa-user-check"></i> حُلل بواسطة: ${task.analyzedBy}</p>` : ''}
          </div>
          <div class="task-actions">
            ${task.status === 'pending' ? `
              <button class="task-btn analyze" onclick="startAnalysis(${index})">
                <i class="fas fa-microscope"></i> بدء التحليل
              </button>
            ` : ''}
            ${task.status === 'analyzing' ? `
              <button class="task-btn analyze" onclick="startAnalysis(${index})">
                <i class="fas fa-redo"></i> استئناف التحليل
              </button>
              ${task.reportHtml ? `
                <button class="task-btn view" onclick="viewSavedReport(${index})">
                  <i class="fas fa-file-alt"></i> عرض التقرير
                </button>
              ` : ''}
            ` : ''}
            ${task.status === 'analyzed' || task.status === 'printed' ? `
              <button class="task-btn view" onclick="viewSavedReport(${index})">
                <i class="fas fa-file-alt"></i> عرض التقرير
              </button>
              <button class="task-btn deliver" onclick="openDeliveryModal(${index})">
                <i class="fas fa-signature"></i> تسليم للطبيب
              </button>
            ` : ''}
            ${task.status === 'delivered' ? `
              <button class="task-btn view" onclick="viewSavedReport(${index})">
                <i class="fas fa-file-alt"></i> عرض التقرير
              </button>
              <button class="task-btn analyze" onclick="startAnalysis(${index})" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <i class="fas fa-redo"></i> إعادة التحليل
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
      
      updateTasksBadge();
    } else {
      grid.innerHTML = `
        <p style="text-align:center;color:var(--text-muted);grid-column:1/-1;">
          <i class="fas fa-check-circle" style="font-size:2rem;margin-bottom:0.5rem;display:block;"></i>
          لا توجد مهام معلقة حالياً
        </p>
      `;
    }
  } catch(e) {
    console.error('Error loading tasks:', e);
  }
}

function getStatusLabel(status) {
  const labels = {
    'pending': 'في الانتظار',
    'analyzing': 'قيد التحليل',
    'analyzed': 'تم التحليل',
    'printed': 'تمت الطباعة',
    'delivered': 'تم التسليم'
  };
  return labels[status] || status;
}

// View saved report from task
async function viewSavedReport(taskIndex) {
  const task = tasksData[taskIndex];
  
  if (!task.reportHtml) {
    alert('لم يتم حفظ التقرير بعد. قم بالتحليل أولاً.');
    return;
  }
  
  // Switch to analysis tab
  switchTab('analysis');
  
  // Set doctor name
  document.getElementById('doctorName').value = task.doctorName;
  document.getElementById('doctorSelected').querySelector('span').textContent = task.doctorName;
  
  // Display the saved report
  const reportSection = document.getElementById('reportSection');
  const reportContent = document.getElementById('reportContent');
  
  originalReport = task.reportHtml;
  translatedReport = '';
  reportContent.innerHTML = task.reportHtml;
  highlightRejectedCells();
  reportSection.classList.add('show');
  updateQuickActionsFab();
  reportSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  // Store current task for tracking
  currentAnalyzingTaskId = task.id;
}

function updateTasksBadge() {
  if (!tasksData || !Array.isArray(tasksData)) return;
  
  const pendingCount = tasksData.filter(t => t.status === 'pending' || t.status === 'analyzed').length;
  const badge = document.getElementById('tasksBadge');
  const pendingTasksEl = document.getElementById('pendingTasks');
  
  if (badge) {
    if (pendingCount > 0) {
      badge.textContent = pendingCount;
      badge.classList.remove('hidden');
    } else {
      badge.textContent = '0';
      badge.classList.add('hidden');
    }
  }
  
  if (pendingTasksEl) {
    pendingTasksEl.textContent = pendingCount;
  }
}

// Start analysis from task
async function startAnalysis(taskIndex) {
  const task = tasksData[taskIndex];
  
  // Store task ID for tracking
  currentAnalyzingTaskId = task.id;
  
  // Switch to analysis tab
  switchTab('analysis');
  
  // Scroll to top of analysis section
  const analysisTab = document.getElementById('analysisTab');
  if (analysisTab) {
    analysisTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  
  // Set doctor name
  document.getElementById('doctorName').value = task.doctorName;
  document.getElementById('doctorSelected').querySelector('span').textContent = task.doctorName;
  
  // Load file from task (using Apps Script)
  try {
    const response = await fetch(TASKS_API_URL + '?action=getTaskFile&taskId=' + task.id);
    const data = await response.json();
    
    if (data.success && data.fileData) {
      // Parse Excel - same way as direct upload (handleFiles)
      const workbook = XLSX.read(data.fileData, { type: 'base64' });
      
      // Process ALL sheets (same as handleFiles)
      let allData = [];
      let totalRows = 0;
      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        allData.push({ sheet: sheetName, data: jsonData });
        totalRows += jsonData.length;
      });
      
      // Format exactly like handleFiles uses ' | ' as separator
      const textContent = allData.map(s => {
        return `=== ${s.sheet} ===\n` + s.data.map(row => row.join(' | ')).join('\n');
      }).join('\n\n');
      
      // Clear previous files
      filesState.length = 0;
      
      // Add file with correct format for analysis (matching handleFiles format)
      filesState.push({
        name: task.fileName,
        mimeType: 'text/plain',
        data: textContent,
        textContent: textContent,
        isExcel: true
      });
      
      renderFiles();
      
      // Update task status
      await updateTaskStatus(task.id, 'analyzing');
      
      console.log('Loaded file:', task.fileName, 'Total rows:', totalRows, 'Sheets:', workbook.SheetNames.length);
      alert('تم تحميل الملف (' + totalRows + ' صف من ' + workbook.SheetNames.length + ' شيت). اضغط "مراجعة الحالة" لبدء التحليل.');
    }
  } catch(e) {
    console.error('Error loading task file:', e);
    alert('خطأ في تحميل الملف');
  }
}

async function updateTaskStatus(taskId, status) {
  try {
    await fetch(TASKS_API_URL + '?action=updateTaskStatus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        taskId: taskId,
        status: status,
        analyzedBy: currentUser.name
      })
    });
  } catch(e) {
    console.error('Error updating task status:', e);
  }
}

// Save report to task after analysis
async function saveReportToTask(taskId, reportHtml) {
  try {
    const response = await fetch(TASKS_API_URL + '?action=saveReport', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        taskId: taskId,
        reportHtml: reportHtml,
        analyzedBy: currentUser.name
      })
    });
    const result = await response.json();
    if (result.success) {
      console.log('Report saved to task successfully');
      loadTasks(); // Refresh tasks list
    }
  } catch(e) {
    console.error('Error saving report to task:', e);
  }
}

// Mark task as printed
async function markTaskAsPrinted(taskId) {
  try {
    await fetch(TASKS_API_URL + '?action=updateTaskStatus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        taskId: taskId,
        status: 'printed',
        printedBy: currentUser.name
      })
    });
    loadTasks();
  } catch(e) {
    console.error('Error marking task as printed:', e);
  }
}

// Print and track
function printAndTrack() {
  // Mark as printed if analyzing from task
  if (currentAnalyzingTaskId) {
    markTaskAsPrinted(currentAnalyzingTaskId);
  }
  // Trigger print
  window.print();
}

// ============================================
// SIGNATURE SYSTEM
// ============================================

function initSignatureCanvas() {
  signatureCanvas = document.getElementById('signatureCanvas');
  signatureCtx = signatureCanvas.getContext('2d');
  
  // Set FIXED canvas size (don't rely on offsetWidth which is 0 when hidden)
  const CANVAS_WIDTH = 500;
  const CANVAS_HEIGHT = 200;
  
  signatureCanvas.width = CANVAS_WIDTH;
  signatureCanvas.height = CANVAS_HEIGHT;
  signatureCanvas.style.width = '100%';
  signatureCanvas.style.maxWidth = CANVAS_WIDTH + 'px';
  
  // Clear canvas with white background
  signatureCtx.fillStyle = 'white';
  signatureCtx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
  
  // Remove old listeners to avoid duplicates
  signatureCanvas.removeEventListener('mousedown', startDrawing);
  signatureCanvas.removeEventListener('mousemove', draw);
  signatureCanvas.removeEventListener('mouseup', stopDrawing);
  signatureCanvas.removeEventListener('mouseout', stopDrawing);
  signatureCanvas.removeEventListener('touchstart', handleTouchStart);
  signatureCanvas.removeEventListener('touchmove', handleTouchMove);
  signatureCanvas.removeEventListener('touchend', stopDrawing);
  
  // Drawing events
  signatureCanvas.addEventListener('mousedown', startDrawing);
  signatureCanvas.addEventListener('mousemove', draw);
  signatureCanvas.addEventListener('mouseup', stopDrawing);
  signatureCanvas.addEventListener('mouseout', stopDrawing);
  
  // Touch events
  signatureCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
  signatureCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
  signatureCanvas.addEventListener('touchend', stopDrawing);
  
  console.log('Canvas initialized:', CANVAS_WIDTH, 'x', CANVAS_HEIGHT);
}

function startDrawing(e) {
  isDrawing = true;
  signatureCtx.beginPath();
  signatureCtx.moveTo(e.offsetX, e.offsetY);
}

function draw(e) {
  if (!isDrawing) return;
  signatureCtx.lineWidth = 2;
  signatureCtx.lineCap = 'round';
  signatureCtx.strokeStyle = '#1e3a5f';
  signatureCtx.lineTo(e.offsetX, e.offsetY);
  signatureCtx.stroke();
}

function stopDrawing() {
  isDrawing = false;
}

function handleTouchStart(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const rect = signatureCanvas.getBoundingClientRect();
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  
  isDrawing = true;
  signatureCtx.beginPath();
  signatureCtx.moveTo(x, y);
}

function handleTouchMove(e) {
  e.preventDefault();
  if (!isDrawing) return;
  
  const touch = e.touches[0];
  const rect = signatureCanvas.getBoundingClientRect();
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  
  signatureCtx.lineWidth = 2;
  signatureCtx.lineCap = 'round';
  signatureCtx.strokeStyle = '#1e3a5f';
  signatureCtx.lineTo(x, y);
  signatureCtx.stroke();
}

function clearSignature() {
  signatureCtx.fillStyle = 'white';
  signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
}

function openDeliveryModal(taskIndex) {
  currentDeliveryTask = tasksData[taskIndex];
  
  document.getElementById('sigDoctorName').textContent = currentDeliveryTask.doctorName;
  document.getElementById('sigReportInfo').textContent = currentDeliveryTask.fileName;
  document.getElementById('sigDate').textContent = new Date().toLocaleDateString('ar-SA');
  
  document.getElementById('signatureModal').classList.remove('hidden');
  
  // Use requestAnimationFrame to ensure modal is visible before initializing canvas
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      initSignatureCanvas();
    });
  });
}

function closeSignatureModal() {
  document.getElementById('signatureModal').classList.add('hidden');
  currentDeliveryTask = null;
}

async function confirmDelivery() {
  if (!currentDeliveryTask) return;
  
  // Check if signature is empty
  const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
  const pixels = imageData.data;
  let isBlank = true;
  for (let i = 0; i < pixels.length; i += 4) {
    if (pixels[i] !== 255 || pixels[i + 1] !== 255 || pixels[i + 2] !== 255) {
      isBlank = false;
      break;
    }
  }
  
  if (isBlank) {
    alert('الرجاء التوقيع أولاً');
    return;
  }
  
  const signatureData = signatureCanvas.toDataURL('image/png');
  
  try {
    const response = await fetch(TASKS_API_URL + '?action=deliverTask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        taskId: currentDeliveryTask.id,
        signature: signatureData,
        deliveredBy: currentUser.name
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('تم تأكيد التسليم بنجاح! ✅');
      closeSignatureModal();
      loadTasks();
      loadDeliveryLog();
    } else {
      alert('خطأ: ' + (result.error || 'فشل في تأكيد التسليم'));
    }
  } catch(e) {
    console.error('Confirm delivery error:', e);
    alert('حدث خطأ أثناء تأكيد التسليم');
  }
}

// Load delivery log
async function loadDeliveryLog() {
  try {
    const response = await fetch(TASKS_API_URL + '?action=getDeliveryLog');
    const data = await response.json();
    
    const tbody = document.getElementById('deliveryLogBody');
    
    // Clear and rebuild signature store
    signatureStore = [];
    
    if (data.success && data.logs && data.logs.length > 0) {
      tbody.innerHTML = data.logs.map((log, idx) => {
        // Store signature in array and use index
        if (log.signature) {
          signatureStore[idx] = log.signature;
        }
        return `
        <tr>
          <td>${log.doctorName}</td>
          <td>${log.uploadedBy}</td>
          <td>${log.uploadDate}</td>
          <td>${log.analyzedBy || '-'}</td>
          <td>${log.analysisDate || '-'}</td>
          <td>${log.deliveryDate || '-'}</td>
          <td>
            ${log.signature ? `<img src="${log.signature}" class="signature-thumb" onclick="viewSignature(${idx})" title="اضغط للتكبير">` : '-'}
          </td>
          <td>
            <span class="task-status ${log.status}">${getStatusLabel(log.status)}</span>
          </td>
        </tr>
      `}).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="8" style="color:var(--text-muted);">لا توجد تسليمات مسجلة</td></tr>';
    }
  } catch(e) {
    console.error('Error loading delivery log:', e);
  }
}

function viewSignature(idx) {
  const signatureData = signatureStore[idx];
  if (!signatureData) {
    alert('التوقيع غير متوفر');
    return;
  }
  
  // Check if it's a Drive URL or base64 data
  let imgSrc = signatureData;
  if (signatureData.includes('drive.google.com') || signatureData.includes('googleusercontent.com')) {
    // It's a Google Drive URL - use it directly
    imgSrc = signatureData;
  }
  // If it starts with data: it's already base64
  
  const win = window.open('', '_blank', 'width=600,height=400');
  win.document.write(`
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
      <title>توقيع الاستلام</title>
      <style>
        body { 
          display: flex; 
          justify-content: center; 
          align-items: center; 
          min-height: 100vh; 
          margin: 0; 
          background: #f5f5f5;
          font-family: Tajawal, sans-serif;
        }
        .container {
          text-align: center;
          background: white;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        img { max-width: 500px; border: 1px solid #ddd; border-radius: 5px; }
        h3 { color: #1e3a5f; margin-bottom: 15px; }
      </style>
    </head>
    <body>
      <div class="container">
        <h3>توقيع استلام التقرير</h3>
        <img src="${imgSrc}" alt="التوقيع" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='; this.alt='خطأ في تحميل التوقيع'">
      </div>
    </body>
    </html>
  `);
}

// ============================================
// SCROLL NAVIGATION SYSTEM
// ============================================

function scrollToBottom() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

// Show/hide scroll buttons based on scroll position
function updateScrollButtons() {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollHeight = document.documentElement.scrollHeight;
  const clientHeight = document.documentElement.clientHeight;
  
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  const scrollBottomBtn = document.getElementById('scrollBottomBtn');
  
  if (!scrollTopBtn || !scrollBottomBtn) return;
  
  // Show buttons only when page is scrollable
  const isScrollable = scrollHeight > clientHeight + 200;
  
  if (isScrollable) {
    // Show up button when scrolled down
    if (scrollTop > 300) {
      scrollTopBtn.classList.add('visible');
    } else {
      scrollTopBtn.classList.remove('visible');
    }
    
    // Show down button when not at bottom
    if (scrollTop + clientHeight < scrollHeight - 300) {
      scrollBottomBtn.classList.add('visible');
    } else {
      scrollBottomBtn.classList.remove('visible');
    }
  } else {
    scrollTopBtn.classList.remove('visible');
    scrollBottomBtn.classList.remove('visible');
  }
}

// Listen to scroll events
window.addEventListener('scroll', updateScrollButtons);
window.addEventListener('resize', updateScrollButtons);

// Initial check after page load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(updateScrollButtons, 500);
});

// Also check when report is generated
const originalUpdateScrollObserver = new MutationObserver(() => {
  updateScrollButtons();
});
document.addEventListener('DOMContentLoaded', () => {
  const reportContent = document.getElementById('reportContent');
  if (reportContent) {
    originalUpdateScrollObserver.observe(reportContent, { childList: true, subtree: true });
  }
});
</script>
</body>
</html>
