<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>توقيع استلام التقرير - مجمع مكة الطبي</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #e2e8f0;
    }
    .sign-container {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      border: 2px solid #c9a962;
      border-radius: 24px;
      padding: 40px 35px;
      max-width: 550px;
      width: 100%;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5), 0 0 40px rgba(201,169,98,0.1);
    }
    .logo-section {
      text-align: center;
      margin-bottom: 25px;
    }
    .logo-section img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 2px solid #c9a962;
    }
    .logo-section h2 {
      color: #c9a962;
      font-size: 1.3rem;
      margin-top: 10px;
    }
    .logo-section p {
      color: #94a3b8;
      font-size: 0.9rem;
    }
    .info-card {
      background: linear-gradient(135deg, #1e3a5f, #2d4a6f);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(201,169,98,0.3);
    }
    .info-card .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .info-card .row:last-child { border-bottom: none; }
    .info-card .label {
      color: #94a3b8;
      font-size: 0.9rem;
    }
    .info-card .value {
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
    }
    .sign-instruction {
      text-align: center;
      color: #c9a962;
      margin-bottom: 12px;
      font-size: 1rem;
    }
    .canvas-wrapper {
      background: #fff;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 20px;
      border: 2px solid #c9a962;
    }
    #signCanvas {
      width: 100%;
      display: block;
      border-radius: 10px;
      touch-action: none;
      cursor: crosshair;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    .btn:active { transform: scale(0.97); }
    .btn-confirm {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      flex: 1;
      justify-content: center;
    }
    .btn-clear {
      background: linear-gradient(135deg, #475569, #334155);
      color: #fff;
    }
    .status-msg {
      text-align: center;
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      display: none;
    }
    .status-msg.success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: #fff;
      display: block;
    }
    .status-msg.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
      display: block;
    }
    .status-msg.loading {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
      display: block;
    }
    .expired-container {
      text-align: center;
      padding: 40px 20px;
    }
    .expired-container i {
      font-size: 4rem;
      color: #ef4444;
      margin-bottom: 20px;
    }
    .expired-container h3 {
      color: #ef4444;
      font-size: 1.4rem;
      margin-bottom: 10px;
    }
    .expired-container p {
      color: #94a3b8;
      font-size: 1rem;
    }
    .already-signed {
      text-align: center;
      padding: 30px 20px;
    }
    .already-signed i {
      font-size: 4rem;
      color: #22c55e;
      margin-bottom: 15px;
      display: block;
    }
    .already-signed h3 {
      color: #22c55e;
      font-size: 1.4rem;
      margin-bottom: 10px;
    }
    .already-signed p {
      color: #94a3b8;
    }
    @media (max-width: 480px) {
      .sign-container { padding: 25px 18px; }
      .btn { padding: 12px 18px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>

<div class="sign-container" id="mainContainer">
  <div class="logo-section">
    <img src="https://m2020m.org/logo-transparent.png" alt="Logo" onerror="this.style.display='none'">
    <h2>مجمع مكة الطبي بالزاهر</h2>
    <p>توقيع استلام تقرير المراجعة</p>
  </div>

  <div id="loadingState" style="text-align:center;padding:40px;">
    <i class="fas fa-spinner fa-spin" style="font-size:2.5rem;color:#c9a962;"></i>
    <p style="margin-top:15px;color:#94a3b8;">جاري تحميل بيانات التقرير...</p>
  </div>

  <div id="signContent" style="display:none;">
    <div class="info-card">
      <div class="row">
        <span class="label">الطبيب المستلم</span>
        <span class="value" id="doctorName">-</span>
      </div>
      <div class="row">
        <span class="label">التقرير</span>
        <span class="value" id="reportName">-</span>
      </div>
      <div class="row">
        <span class="label">التاريخ</span>
        <span class="value" id="signDate">-</span>
      </div>
      <div class="row">
        <span class="label">مرسل بواسطة</span>
        <span class="value" id="sentBy">-</span>
      </div>
    </div>

    <p class="sign-instruction"><i class="fas fa-hand-pointer"></i> وقّع بإصبعك أو القلم في المربع أدناه</p>

    <div class="canvas-wrapper">
      <canvas id="signCanvas"></canvas>
    </div>

    <div class="actions">
      <button class="btn btn-clear" onclick="clearCanvas()">
        <i class="fas fa-eraser"></i> مسح
      </button>
      <button class="btn btn-confirm" id="confirmBtn" onclick="submitSignature()">
        <i class="fas fa-check-circle"></i> تأكيد التوقيع
      </button>
    </div>

    <div class="status-msg" id="statusMsg"></div>
  </div>

  <div id="errorState" style="display:none;"></div>
</div>

<script>
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxm_hI1j-4GTd7rttxGrCH49d-xdtinlW9MKt_Otbc09YRrzTIXbcyDcFUv7g2OrF4Y-A/exec';

let canvas, ctx, isDrawing = false;
let taskInfo = null;

const params = new URLSearchParams(window.location.search);
const token = params.get('token');

async function init() {
  if (!token) {
    showError('رابط غير صالح', 'لم يتم العثور على معرف التوقيع. تأكد من الرابط المرسل إليك.');
    return;
  }

  try {
    const response = await fetch(BACKEND_URL + '?action=getSigningTask&token=' + encodeURIComponent(token));
    const data = await response.json();

    if (!data.success) {
      if (data.alreadySigned) {
        showAlreadySigned(data.doctorName, data.signedDate);
      } else {
        showError('رابط منتهي أو غير صالح', data.error || 'لا يمكن تحميل بيانات التقرير. قد يكون الرابط منتهي الصلاحية.');
      }
      return;
    }

    taskInfo = data.task;
    document.getElementById('doctorName').textContent = taskInfo.doctorName || '-';
    document.getElementById('reportName').textContent = taskInfo.fileName || '-';
    document.getElementById('signDate').textContent = new Date().toLocaleDateString('ar-SA');
    document.getElementById('sentBy').textContent = taskInfo.sentBy || '-';

    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('signContent').style.display = 'block';

    initCanvas();
  } catch(e) {
    console.error(e);
    showError('خطأ في الاتصال', 'تعذر الاتصال بالسيرفر. حاول مرة أخرى.');
  }
}

function showError(title, msg) {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('errorState').innerHTML = `
    <div class="expired-container">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>${title}</h3>
      <p>${msg}</p>
    </div>`;
}

function showAlreadySigned(name, date) {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('errorState').innerHTML = `
    <div class="already-signed">
      <i class="fas fa-check-circle"></i>
      <h3>تم التوقيع مسبقاً</h3>
      <p>قام ${name || 'الطبيب'} بالتوقيع على هذا التقرير${date ? ' بتاريخ ' + date : ''}</p>
    </div>`;
}

function initCanvas() {
  canvas = document.getElementById('signCanvas');
  ctx = canvas.getContext('2d');

  const W = Math.min(500, canvas.parentElement.offsetWidth - 8);
  const H = 200;
  canvas.width = W;
  canvas.height = H;
  canvas.style.width = '100%';
  canvas.style.maxWidth = W + 'px';

  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, W, H);

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', drawing);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseout', stopDraw);
  canvas.addEventListener('touchstart', touchStart, { passive: false });
  canvas.addEventListener('touchmove', touchMove, { passive: false });
  canvas.addEventListener('touchend', stopDraw);
}

function startDraw(e) {
  isDrawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
}
function drawing(e) {
  if (!isDrawing) return;
  ctx.lineWidth = 2.5;
  ctx.lineCap = 'round';
  ctx.strokeStyle = '#1e3a5f';
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
}
function stopDraw() { isDrawing = false; }

function touchStart(e) {
  e.preventDefault();
  const t = e.touches[0], r = canvas.getBoundingClientRect();
  const scaleX = canvas.width / r.width;
  const scaleY = canvas.height / r.height;
  isDrawing = true;
  ctx.beginPath();
  ctx.moveTo((t.clientX - r.left) * scaleX, (t.clientY - r.top) * scaleY);
}
function touchMove(e) {
  e.preventDefault();
  if (!isDrawing) return;
  const t = e.touches[0], r = canvas.getBoundingClientRect();
  const scaleX = canvas.width / r.width;
  const scaleY = canvas.height / r.height;
  ctx.lineWidth = 2.5;
  ctx.lineCap = 'round';
  ctx.strokeStyle = '#1e3a5f';
  ctx.lineTo((t.clientX - r.left) * scaleX, (t.clientY - r.top) * scaleY);
  ctx.stroke();
}

function clearCanvas() {
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function isCanvasBlank() {
  const d = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
  for (let i = 0; i < d.length; i += 4) {
    if (d[i] !== 255 || d[i+1] !== 255 || d[i+2] !== 255) return false;
  }
  return true;
}

async function submitSignature() {
  if (isCanvasBlank()) {
    showStatus('الرجاء التوقيع أولاً قبل التأكيد', 'error');
    return;
  }

  const btn = document.getElementById('confirmBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
  showStatus('جاري إرسال التوقيع...', 'loading');

  const signatureData = canvas.toDataURL('image/png');

  try {
    const response = await fetch(BACKEND_URL + '?action=confirmRemoteSignature', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        token: token,
        signature: signatureData
      })
    });

    const result = await response.json();

    if (result.success) {
      showStatus('تم التوقيع بنجاح! شكراً لتعاونك ✓', 'success');
      btn.style.display = 'none';
      document.querySelector('.btn-clear').style.display = 'none';
      canvas.style.pointerEvents = 'none';
      canvas.style.opacity = '0.6';
    } else {
      showStatus(result.error || 'حدث خطأ. حاول مرة أخرى.', 'error');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-check-circle"></i> تأكيد التوقيع';
    }
  } catch(e) {
    console.error(e);
    showStatus('خطأ في الاتصال. تأكد من الإنترنت وحاول مرة أخرى.', 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-check-circle"></i> تأكيد التوقيع';
  }
}

function showStatus(msg, type) {
  const el = document.getElementById('statusMsg');
  el.className = 'status-msg ' + type;
  el.textContent = msg;
  el.style.display = 'block';
  if (type !== 'success') {
    setTimeout(() => { el.style.display = 'none'; }, 4000);
  }
}

init();
</script>
</body>
</html>
