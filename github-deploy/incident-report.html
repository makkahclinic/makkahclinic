<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نموذج الإبلاغ عن حادث - مجمع مكة الطبي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --crimson: #9E1B32;
            --blue: #0056A3;
            --blue-dark: #003E75;
            --white: #FFFFFF;
            --off-white: #F8F9FA;
            --gray-light: #E9ECEF;
            --gray: #6C757D;
            --gray-dark: #343A40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --radius-md: 10px;
            --radius-lg: 14px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, var(--crimson), var(--blue-dark));
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .header-content {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .logo {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .logo img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }
        
        .header h1 {
            font-family: 'Cairo', sans-serif;
            font-size: 1.6rem;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .main-container {
            flex: 1;
            display: flex;
            justify-content: center;
            padding: 30px 15px;
        }
        
        .form-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 650px;
            overflow: hidden;
        }
        
        .form-header {
            background: linear-gradient(135deg, var(--blue), var(--crimson));
            color: white;
            padding: 18px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .form-header i { font-size: 1.5rem; }
        .form-header h2 { font-size: 1.2rem; font-weight: 700; }
        
        .form-body {
            padding: 25px;
        }
        
        .alert {
            padding: 14px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .alert i { margin-top: 2px; }
        .alert-info { background: #e7f3ff; color: #0056A3; border: 1px solid #b8daff; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--gray-dark);
            font-size: 0.95rem;
        }
        
        .form-group label .required { color: var(--danger); }
        
        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-md);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
            background: var(--white);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0,86,163,0.1);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .severity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
        }
        
        .severity-option {
            position: relative;
        }
        
        .severity-option input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .severity-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 10px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            background: var(--white);
        }
        
        .severity-option label:hover {
            border-color: var(--blue);
        }
        
        .severity-option input:checked + label {
            border-color: var(--blue);
            background: var(--blue);
            color: white;
        }
        
        .severity-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .anonymous-box {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .anonymous-box label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .anonymous-box input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--blue);
        }
        
        .reporter-fields {
            background: var(--off-white);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 15px;
            transition: all 0.3s;
        }
        
        .reporter-fields.hidden {
            display: none;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--crimson), var(--blue-dark));
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,86,163,0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .success-message.show {
            display: block;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2.5rem;
        }
        
        .success-message h3 {
            font-family: 'Cairo', sans-serif;
            font-size: 1.5rem;
            color: var(--success);
            margin-bottom: 10px;
        }
        
        .incident-id {
            background: var(--off-white);
            padding: 12px 20px;
            border-radius: var(--radius-md);
            display: inline-block;
            font-family: monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--blue-dark);
            margin: 15px 0;
        }
        
        .btn-new {
            background: var(--blue);
            color: white;
            margin-top: 20px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.85rem;
        }
        
        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .severity-grid { grid-template-columns: repeat(2, 1fr); }
            .header h1 { font-size: 1.3rem; }
            .form-body { padding: 20px 16px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="logo-new.png" alt="الشعار">
            </div>
            <h1>نموذج الإبلاغ عن حادث سلامة المرضى</h1>
            <p>التبليغ حماية للمريض وليس محاسبة - يمكنك التبليغ دون ذكر اسمك</p>
        </div>
    </header>
    
    <div class="main-container">
        <div class="form-card">
            <div class="form-header">
                <i class="fas fa-file-medical-alt"></i>
                <h2>بيانات الحادث</h2>
            </div>
            
            <div class="form-body">
                <div id="formContainer">
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <strong>سرية تامة:</strong> 
                            جميع البلاغات سرية ولا تستخدم للمحاسبة. الهدف هو التعلم والتحسين.
                        </div>
                    </div>
                    
                    <form id="incidentForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>تاريخ الحادث <span class="required">*</span></label>
                                <input type="date" class="form-control" id="incidentDate" required>
                            </div>
                            <div class="form-group">
                                <label>وقت الحادث</label>
                                <input type="time" class="form-control" id="incidentTime">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>القسم <span class="required">*</span></label>
                                <select class="form-control" id="department" required>
                                    <option value="">اختر القسم</option>
                                    <option value="الاستقبال">الاستقبال</option>
                                    <option value="العيادات">العيادات</option>
                                    <option value="المختبر">المختبر</option>
                                    <option value="الأشعة">الأشعة</option>
                                    <option value="الصيدلية">الصيدلية</option>
                                    <option value="التمريض">التمريض</option>
                                    <option value="الطوارئ">الطوارئ</option>
                                    <option value="العمليات">العمليات</option>
                                    <option value="التعقيم">التعقيم</option>
                                    <option value="الإدارة">الإدارة</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>الموقع المحدد</label>
                                <input type="text" class="form-control" id="location" placeholder="مثال: غرفة الفحص 3">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>نوع الحادث <span class="required">*</span></label>
                            <select class="form-control" id="incidentType" required>
                                <option value="">اختر نوع الحادث</option>
                                <option value="medication_error">خطأ دوائي</option>
                                <option value="patient_fall">سقوط مريض</option>
                                <option value="infection">عدوى مكتسبة</option>
                                <option value="diagnosis_error">خطأ تشخيصي</option>
                                <option value="procedure_error">خطأ إجراءات</option>
                                <option value="near_miss">كاد يحدث (Near Miss)</option>
                                <option value="equipment_failure">عطل معدات طبية</option>
                                <option value="communication">خطأ في التواصل</option>
                                <option value="documentation">خطأ في التوثيق</option>
                                <option value="patient_id_error">خطأ في هوية المريض</option>
                                <option value="delay_care">تأخر في تقديم الرعاية</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>مستوى الخطورة <span class="required">*</span></label>
                            <div class="severity-grid">
                                <div class="severity-option">
                                    <input type="radio" name="severity" id="sev-none" value="none" required>
                                    <label for="sev-none">
                                        <span class="severity-dot" style="background:#28a745"></span>
                                        بدون ضرر
                                    </label>
                                </div>
                                <div class="severity-option">
                                    <input type="radio" name="severity" id="sev-minor" value="minor">
                                    <label for="sev-minor">
                                        <span class="severity-dot" style="background:#ffc107"></span>
                                        ضرر بسيط
                                    </label>
                                </div>
                                <div class="severity-option">
                                    <input type="radio" name="severity" id="sev-moderate" value="moderate">
                                    <label for="sev-moderate">
                                        <span class="severity-dot" style="background:#fd7e14"></span>
                                        ضرر متوسط
                                    </label>
                                </div>
                                <div class="severity-option">
                                    <input type="radio" name="severity" id="sev-severe" value="severe">
                                    <label for="sev-severe">
                                        <span class="severity-dot" style="background:#dc3545"></span>
                                        ضرر جسيم
                                    </label>
                                </div>
                                <div class="severity-option">
                                    <input type="radio" name="severity" id="sev-death" value="death">
                                    <label for="sev-death">
                                        <span class="severity-dot" style="background:#000"></span>
                                        وفاة
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>وصف الحادث <span class="required">*</span></label>
                            <textarea class="form-control" id="description" placeholder="اشرح ماذا حدث بالتفصيل..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>كيف تم اكتشاف الحادث؟</label>
                            <textarea class="form-control" id="discoveryMethod" placeholder="كيف ومتى تم اكتشاف الحادث؟" style="min-height:70px"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>الإجراءات الفورية المتخذة</label>
                            <textarea class="form-control" id="immediateAction" placeholder="ما الذي تم عمله فوراً للتعامل مع الموقف؟" style="min-height:70px"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>هل تم إبلاغ الطبيب المعالج؟</label>
                                <select class="form-control" id="doctorNotified">
                                    <option value="لا">لا</option>
                                    <option value="نعم">نعم</option>
                                    <option value="غير مطلوب">غير مطلوب</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>هل تم إبلاغ المريض/ذويه؟</label>
                                <select class="form-control" id="patientNotified">
                                    <option value="لا">لا</option>
                                    <option value="نعم">نعم</option>
                                    <option value="غير مطلوب">غير مطلوب</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="anonymous-box">
                            <label>
                                <input type="checkbox" id="anonymous">
                                <span>أرغب بالتبليغ دون ذكر اسمي (تبليغ مجهول الهوية)</span>
                            </label>
                            
                            <div class="reporter-fields" id="reporterFields">
                                <div class="form-row">
                                    <div class="form-group" style="margin-bottom:0">
                                        <label>اسم المبلغ</label>
                                        <input type="text" class="form-control" id="reporterName" placeholder="اسمك (اختياري)">
                                    </div>
                                    <div class="form-group" style="margin-bottom:0">
                                        <label>رقم التواصل</label>
                                        <input type="tel" class="form-control" id="reporterContact" placeholder="للتواصل إن لزم">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-paper-plane"></i>
                            إرسال البلاغ
                        </button>
                    </form>
                </div>
                
                <div id="successMessage" class="success-message">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h3>تم إرسال البلاغ بنجاح</h3>
                    <p>شكراً لك على المساهمة في تحسين سلامة المرضى</p>
                    <div class="incident-id" id="displayIncidentId"></div>
                    <p style="color:var(--gray);font-size:0.9rem;">احتفظ بهذا الرقم للمتابعة</p>
                    <div id="rcaWarning" style="display:none;margin-top:15px;padding:12px;background:#fff3cd;border-radius:8px;color:#856404;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>تنبيه:</strong> هذا الحادث يتطلب تحليل السبب الجذري (RCA)
                    </div>
                    <button class="btn btn-new" onclick="resetForm()">
                        <i class="fas fa-plus"></i>
                        تبليغ جديد
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        مجمع مكة الطبي بالزاهر - لجنة سلامة المرضى
    </footer>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz-vImcmRIh0M86i44V5Rm1C0m23lrN4q1aql9R7HNfQZUgShVyg7JlYlD5xLK2H9Gurg/exec';
        
        document.getElementById('incidentDate').valueAsDate = new Date();
        
        document.getElementById('anonymous').addEventListener('change', function() {
            const fields = document.getElementById('reporterFields');
            fields.classList.toggle('hidden', this.checked);
            if (this.checked) {
                document.getElementById('reporterName').value = '';
                document.getElementById('reporterContact').value = '';
            }
        });
        
        document.getElementById('incidentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const severity = document.querySelector('input[name="severity"]:checked');
            if (!severity) {
                alert('الرجاء اختيار مستوى الخطورة');
                return;
            }
            
            const description = document.getElementById('description').value.trim();
            if (description.length < 10) {
                alert('الرجاء كتابة وصف تفصيلي للحادث (10 أحرف على الأقل)');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
            
            const payload = {
                incidentDate: document.getElementById('incidentDate').value,
                incidentTime: document.getElementById('incidentTime').value,
                department: document.getElementById('department').value,
                location: document.getElementById('location').value,
                incidentType: document.getElementById('incidentType').value,
                severity: severity.value,
                description: description,
                discoveryMethod: document.getElementById('discoveryMethod').value,
                immediateAction: document.getElementById('immediateAction').value,
                doctorNotified: document.getElementById('doctorNotified').value,
                patientNotified: document.getElementById('patientNotified').value,
                anonymous: document.getElementById('anonymous').checked,
                reporterName: document.getElementById('reporterName').value,
                reporterContact: document.getElementById('reporterContact').value
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'submitIncident', payload })
                });
                
                const result = await response.json();
                
                if (result.ok && result.success) {
                    document.getElementById('formContainer').style.display = 'none';
                    document.getElementById('successMessage').classList.add('show');
                    document.getElementById('displayIncidentId').textContent = result.incidentId;
                    
                    if (result.requiresRCA) {
                        document.getElementById('rcaWarning').style.display = 'block';
                    }
                } else {
                    throw new Error(result.error || 'حدث خطأ في إرسال البلاغ');
                }
            } catch (err) {
                console.error(err);
                alert('حدث خطأ: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> إرسال البلاغ';
            }
        });
        
        function resetForm() {
            document.getElementById('incidentForm').reset();
            document.getElementById('incidentDate').valueAsDate = new Date();
            document.getElementById('reporterFields').classList.remove('hidden');
            document.getElementById('formContainer').style.display = 'block';
            document.getElementById('successMessage').classList.remove('show');
            document.getElementById('rcaWarning').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-paper-plane"></i> إرسال البلاغ';
        }
    </script>
</body>
</html>
