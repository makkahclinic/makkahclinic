<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ - ŸÖÿ¨ŸÖÿπ ŸÖŸÉÿ© ÿßŸÑÿ∑ÿ®Ÿä</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background 0.5s ease;
            color: #fff;
        }
        
        body.safe {
            background: linear-gradient(135deg, #166534 0%, #14532d 50%, #052e16 100%);
        }
        
        body.fire {
            background: linear-gradient(135deg, #DC143C, #7f1d1d);
            animation: emergencyPulse 0.5s ease-in-out infinite alternate;
        }
        
        body.injury {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        body.infection {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        }
        
        body.power {
            background: linear-gradient(135deg, #eab308, #ca8a04);
        }
        
        body.water {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
        }
        
        body.other {
            background: linear-gradient(135deg, #475569, #334155);
        }
        
        @keyframes emergencyPulse {
            0% { filter: brightness(1); }
            100% { filter: brightness(0.8); }
        }
        
        /* ========== ÿ™ÿ£ÿ´Ÿäÿ± ÿ£ÿ∂Ÿàÿßÿ° ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿßŸÑŸàÿßŸÖÿ∂ÿ© ========== */
        .emergency-lights {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 9999;
        }
        
        .emergency-lights.active {
            display: block;
        }
        
        .light-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            display: flex;
        }
        
        .light-bar.bottom {
            top: auto;
            bottom: 0;
        }
        
        .light-left, .light-right {
            flex: 1;
            animation: flashLight 0.15s ease-in-out infinite alternate;
        }
        
        .light-left {
            background: #ff0000;
            box-shadow: 0 0 60px 30px rgba(255, 0, 0, 0.8);
        }
        
        .light-right {
            background: #0066ff;
            box-shadow: 0 0 60px 30px rgba(0, 102, 255, 0.8);
            animation-delay: 0.15s;
        }
        
        .side-light {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
        }
        
        .side-light.left {
            left: 0;
            background: linear-gradient(to bottom, #ff0000 50%, #0066ff 50%);
            animation: sideFlash 0.3s ease-in-out infinite;
        }
        
        .side-light.right {
            right: 0;
            background: linear-gradient(to bottom, #0066ff 50%, #ff0000 50%);
            animation: sideFlash 0.3s ease-in-out infinite;
            animation-delay: 0.15s;
        }
        
        @keyframes flashLight {
            0% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        
        @keyframes sideFlash {
            0%, 100% { 
                background: linear-gradient(to bottom, #ff0000 50%, #0066ff 50%);
                box-shadow: 0 0 40px 20px rgba(255, 0, 0, 0.5);
            }
            50% { 
                background: linear-gradient(to bottom, #0066ff 50%, #ff0000 50%);
                box-shadow: 0 0 40px 20px rgba(0, 102, 255, 0.5);
            }
        }
        
        /* Corner strobes */
        .corner-strobe {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            animation: strobeFlash 0.2s ease-in-out infinite;
        }
        
        .corner-strobe.top-left {
            top: 10px;
            left: 10px;
            background: radial-gradient(circle, #ff0000, transparent);
            box-shadow: 0 0 80px 40px rgba(255, 0, 0, 0.9);
        }
        
        .corner-strobe.top-right {
            top: 10px;
            right: 10px;
            background: radial-gradient(circle, #0066ff, transparent);
            box-shadow: 0 0 80px 40px rgba(0, 102, 255, 0.9);
            animation-delay: 0.1s;
        }
        
        .corner-strobe.bottom-left {
            bottom: 10px;
            left: 10px;
            background: radial-gradient(circle, #0066ff, transparent);
            box-shadow: 0 0 80px 40px rgba(0, 102, 255, 0.9);
            animation-delay: 0.15s;
        }
        
        .corner-strobe.bottom-right {
            bottom: 10px;
            right: 10px;
            background: radial-gradient(circle, #ff0000, transparent);
            box-shadow: 0 0 80px 40px rgba(255, 0, 0, 0.9);
            animation-delay: 0.05s;
        }
        
        @keyframes strobeFlash {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(0.8); }
        }
        
        .container {
            text-align: center;
            padding: 5px;
            width: 100%;
            max-width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden;
        }
        
        .safe-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .safe-screen.hidden {
            display: none;
        }
        
        .logo-container {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: logoPulse 3s ease-in-out infinite;
            border: 2px solid rgba(201, 169, 98, 0.5);
            overflow: hidden;
        }
        
        .logo-container img {
            width: 70px;
            height: auto;
        }
        
        .logo-fallback {
            display: none;
        }
        
        @keyframes logoPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 30px rgba(201, 169, 98, 0.3);
            }
            50% { 
                transform: scale(1.03); 
                box-shadow: 0 0 50px rgba(201, 169, 98, 0.5);
            }
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(34, 197, 94, 0.2);
            padding: 10px 25px;
            border-radius: 50px;
            border: 2px solid rgba(34, 197, 94, 0.5);
        }
        
        .status-badge i {
            font-size: 1.8rem;
            color: #22c55e;
            animation: checkPulse 2s ease-in-out infinite;
        }
        
        .status-badge span {
            font-size: 1.8rem;
            font-weight: 900;
            color: #22c55e;
        }
        
        @keyframes checkPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .clinic-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #c9a962;
            margin-top: 5px;
        }
        
        .current-time {
            font-size: 2.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .date-display {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 3px;
        }
        
        .connection-indicator {
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            transition: all 0.3s ease;
        }
        
        .connection-indicator.connected {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }
        
        .connection-indicator.polling {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border: 1px solid #eab308;
        }
        
        .connection-indicator i {
            font-size: 0.7rem;
        }
        
        .emergency-screen {
            display: none;
        }
        
        .emergency-screen.active {
            display: block;
        }
        
        /* Badge ÿ™ŸÖÿ±ŸäŸÜ */
        .drill-badge {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 6px 20px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 900;
            margin-bottom: 3px;
            animation: drillPulse 1.5s infinite;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
        }
        
        @keyframes drillPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.6); }
            50% { box-shadow: 0 0 50px rgba(34, 197, 94, 0.9); }
        }
        
        body.drill {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            animation: none !important;
        }
        
        body.control-mode {
            background: linear-gradient(135deg, #1e3a5f, #0f172a);
            animation: none !important;
        }
        
        /* Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ */
        .control-panel {
            display: none;
            text-align: center;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .control-panel.active {
            display: block;
        }
        
        .control-header {
            margin-bottom: 25px;
        }
        
        .control-header h1 {
            font-size: 1.6rem;
            color: #c9a962;
            margin-bottom: 8px;
        }
        
        .control-header p {
            color: rgba(255,255,255,0.7);
            font-size: 0.95rem;
        }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .scenario-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .scenario-card:hover {
            transform: scale(1.03);
            background: rgba(255,255,255,0.15);
        }
        
        .scenario-card.selected {
            border-color: #c9a962;
            background: rgba(201, 169, 98, 0.2);
            box-shadow: 0 0 20px rgba(201, 169, 98, 0.3);
        }
        
        .scenario-card i {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }
        
        .scenario-card.fire i { color: #ef4444; }
        .scenario-card.power i { color: #f59e0b; }
        .scenario-card.water i { color: #3b82f6; }
        .scenario-card.medical i { color: #22c55e; }
        .scenario-card.infection i { color: #8b5cf6; }
        .scenario-card.drill i { color: #10b981; }
        
        .scenario-card span {
            display: block;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .drill-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 20px;
            cursor: pointer;
        }
        
        .drill-toggle input {
            width: 20px;
            height: 20px;
            accent-color: #10b981;
        }
        
        .drill-toggle label {
            font-size: 1rem;
            color: #10b981;
            font-weight: 600;
            cursor: pointer;
        }
        
        .activate-control-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .activate-control-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
        }
        
        .activate-control-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .activate-control-btn.drill-mode {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .back-link {
            margin-top: 20px;
            display: inline-block;
            color: rgba(255,255,255,0.6);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .back-link:hover {
            color: #fff;
        }
        
        /* ŸÖŸÑÿÆÿµ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ */
        .steps-summary {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 8px 12px;
            margin: 5px 0;
            text-align: right;
        }
        
        .steps-summary h3 {
            color: #fbbf24;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .steps-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 3px 15px;
        }
        
        .step-item-mini {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 0;
        }
        
        .step-num-mini {
            background: #fbbf24;
            color: #000;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .step-text-mini {
            font-size: 0.85rem;
            line-height: 1.3;
            font-weight: 500;
        }
        
        @media (min-width: 1200px) {
            .step-text-mini {
                font-size: 1rem;
            }
            .step-num-mini {
                width: 24px;
                height: 24px;
                font-size: 0.85rem;
            }
            .steps-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .emergency-logo {
            width: 40px;
            height: 40px;
            margin: 0 auto 3px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .emergency-logo img {
            width: 26px;
            height: auto;
        }
        
        .emergency-icon {
            font-size: 2rem;
            animation: iconBlink 0.5s ease-in-out infinite alternate;
            margin-bottom: 0;
        }
        
        @keyframes iconBlink {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .emergency-screen h1 {
            font-size: 1.4rem;
            font-weight: 900;
            margin-bottom: 2px;
            text-shadow: 0 3px 15px rgba(0,0,0,0.5);
            animation: textBlink 0.6s ease-in-out infinite alternate;
        }
        
        @keyframes textBlink {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .emergency-type {
            font-size: 1rem;
            background: rgba(0,0,0,0.5);
            padding: 4px 16px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 3px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .instruction-box {
            background: rgba(0,0,0,0.4);
            padding: 5px;
            border-radius: 10px;
            margin: 3px 0;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .instruction-box h2 {
            font-size: 0.9rem;
            margin-bottom: 2px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .instruction-box .location {
            font-size: 1.8rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 3px 10px rgba(0,0,0,0.5);
        }
        
        .muster-point {
            background: rgba(34,197,94,0.3);
            padding: 5px;
            border-radius: 10px;
            margin-top: 3px;
            border: 2px solid rgba(34,197,94,0.5);
        }
        
        .muster-point h3 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .muster-point .point-name {
            font-size: 1.1rem;
            font-weight: 900;
            color: #86efac;
        }
        
        .timer {
            margin-top: 4px;
            font-size: 0.85rem;
        }
        
        .timer .time-display {
            font-size: 1.4rem;
            font-weight: 900;
            font-family: monospace;
        }
        
        .emergency-numbers {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .emergency-number {
            background: rgba(0,0,0,0.4);
            padding: 3px 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .emergency-number i {
            font-size: 0.75rem;
        }
        
        .emergency-number span {
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .footer {
            padding: 4px;
            text-align: center;
            font-size: 0.7rem;
            opacity: 0.7;
            background: rgba(0,0,0,0.2);
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .logo-container {
                width: 120px;
                height: 120px;
            }
            
            .logo-container img {
                width: 90px;
            }
            
            .status-badge {
                padding: 10px 25px;
            }
            
            .status-badge i {
                font-size: 1.8rem;
            }
            
            .status-badge span {
                font-size: 1.8rem;
            }
            
            .clinic-name {
                font-size: 1.4rem;
            }
            
            .current-time {
                font-size: 3rem;
            }
            
            .emergency-screen h1 {
                font-size: 2.5rem;
            }
            
            .emergency-type {
                font-size: 1.5rem;
                padding: 12px 25px;
            }
            
            .instruction-box .location {
                font-size: 2rem;
            }
            
            .emergency-icon {
                font-size: 5rem;
            }
            
            .timer .time-display {
                font-size: 3rem;
            }
        }
        
        /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© */
        .start-screen {
          position: fixed;
          inset: 0;
          background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          text-align: center;
          padding: 20px;
        }
        .start-screen.hidden { display: none; }
        
        .start-logo {
          width: 120px;
          height: 120px;
          background: rgba(255,255,255,0.1);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 25px;
          border: 3px solid rgba(201, 169, 98, 0.5);
        }
        .start-logo img {
          width: 80px;
          height: auto;
        }
        
        .start-title {
          font-size: 1.8rem;
          font-weight: 900;
          color: #c9a962;
          margin-bottom: 10px;
        }
        
        .start-subtitle {
          font-size: 1.1rem;
          color: rgba(255,255,255,0.8);
          margin-bottom: 30px;
          line-height: 1.6;
        }
        
        .start-btn {
          background: linear-gradient(135deg, #22c55e, #16a34a);
          color: #fff;
          border: none;
          padding: 20px 50px;
          font-size: 1.4rem;
          font-weight: 900;
          border-radius: 60px;
          cursor: pointer;
          box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4);
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .start-btn:hover {
          transform: scale(1.05);
          box-shadow: 0 12px 40px rgba(34, 197, 94, 0.5);
        }
        .start-btn i {
          margin-left: 10px;
        }
        
        .start-note {
          margin-top: 25px;
          font-size: 0.9rem;
          color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body class="safe">
    <!-- ÿ™ÿ£ÿ´Ÿäÿ± ÿ£ÿ∂Ÿàÿßÿ° ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿßŸÑŸàÿßŸÖÿ∂ÿ© -->
    <div id="emergencyLights" class="emergency-lights">
        <div class="light-bar top">
            <div class="light-left"></div>
            <div class="light-right"></div>
        </div>
        <div class="light-bar bottom">
            <div class="light-left"></div>
            <div class="light-right"></div>
        </div>
        <div class="side-light left"></div>
        <div class="side-light right"></div>
        <div class="corner-strobe top-left"></div>
        <div class="corner-strobe top-right"></div>
        <div class="corner-strobe bottom-left"></div>
        <div class="corner-strobe bottom-right"></div>
    </div>
    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© -->
    <div class="start-screen" id="startScreen">
      <div class="start-logo">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¨ŸÖÿπ">
      </div>
      <div class="start-title">ŸÜÿ∏ÿßŸÖ ÿ•ŸÜÿ∞ÿßÿ± ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶</div>
      <div class="start-subtitle">
        ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá ŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©<br>
        ÿ≥ŸäÿµÿØÿ± ÿµŸàÿ™ ÿ™ŸÜÿ®ŸäŸá ÿπŸÜÿØ ÿ£Ÿä ÿ≠ÿßŸÑÿ© ÿ∑Ÿàÿßÿ±ÿ¶
      </div>
      <button class="start-btn" id="startBtn">
        <i class="fas fa-bell"></i>
        ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©
      </button>
      <div class="start-note">ÿßÿ™ÿ±ŸÉ Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖŸÅÿ™Ÿàÿ≠ÿ©</div>
    </div>
    <div class="container">
        <!-- Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ (ÿ™ÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ) -->
        <div class="control-panel" id="controlPanel">
            <div class="control-header">
                <h1><i class="fas fa-broadcast-tower"></i> ÿ™ŸÅÿπŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶</h1>
                <p>ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ŸÑŸÑÿ™ŸÅÿπŸäŸÑ</p>
            </div>
            
            <div class="scenario-grid">
                <div class="scenario-card fire" onclick="selectScenario('fire', event)">
                    <i class="fas fa-fire"></i>
                    <span>ÿ≠ÿ±ŸäŸÇ</span>
                </div>
                <div class="scenario-card power" onclick="selectScenario('power', event)">
                    <i class="fas fa-bolt"></i>
                    <span>ÿßŸÜŸÇÿ∑ÿßÿπ ŸÉŸáÿ±ÿ®ÿßÿ°</span>
                </div>
                <div class="scenario-card water" onclick="selectScenario('water', event)">
                    <i class="fas fa-tint"></i>
                    <span>ÿ™ÿ≥ÿ±ÿ® ŸÖŸäÿßŸá</span>
                </div>
                <div class="scenario-card medical" onclick="selectScenario('injury', event)">
                    <i class="fas fa-heartbeat"></i>
                    <span>ÿ•ÿ∫ŸÖÿßÿ°/ÿ•ÿµÿßÿ®ÿ©</span>
                </div>
                <div class="scenario-card infection" onclick="selectScenario('infection', event)">
                    <i class="fas fa-virus"></i>
                    <span>ÿ™ŸÅÿ¥Ÿä ÿπÿØŸàŸâ</span>
                </div>
            </div>
            
            <div class="drill-toggle" onclick="toggleDrill(event)">
                <input type="checkbox" id="drillCheckbox">
                <label for="drillCheckbox">üéØ ÿ™ŸÖÿ±ŸäŸÜ ŸÅŸÇÿ∑ (ÿ®ÿØŸàŸÜ ÿµŸàÿ™)</label>
            </div>
            
            <button class="activate-control-btn" id="activateControlBtn" onclick="activateFromControl()" disabled>
                <i class="fas fa-bell"></i>
                <span>ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿ£ŸàŸÑÿßŸã</span>
            </button>
            
            <a href="eoc-command.html" class="back-link">
                <i class="fas fa-arrow-right"></i> ÿßŸÑÿπŸàÿØÿ© ŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑŸÇŸäÿßÿØÿ©
            </a>
        </div>
        
        <div class="safe-screen" id="safeScreen">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¨ŸÖÿπ" id="logoImg">
            </div>
            
            <div class="status-badge">
                <i class="fas fa-shield-check"></i>
                <span>ÿßŸÑŸàÿ∂ÿπ ÿ¢ŸÖŸÜ</span>
            </div>
            
            <div class="clinic-name">ŸÖÿ¨ŸÖÿπ ŸÖŸÉÿ© ÿßŸÑÿ∑ÿ®Ÿä ÿ®ÿßŸÑÿ≤ÿßŸáÿ±</div>
            
            <div class="current-time" id="currentTime">--:--</div>
            <div class="date-display" id="currentDate">--</div>
            <div class="connection-indicator polling" id="connectionIndicator" title="ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ">
                <i class="fas fa-wifi"></i>
                <span class="status-text">ÿ¨ÿßÿ±Ÿç ÿßŸÑÿßÿ™ÿµÿßŸÑ...</span>
            </div>
        </div>
        
        <div class="emergency-screen" id="emergencyScreen">
            <div class="emergency-logo">
                <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¨ŸÖÿπ">
            </div>
            <div class="drill-badge" id="drillBadge" style="display: none;">
                üéØ ÿ™ŸÖÿ±ŸäŸÜ - DRILL
            </div>
            <div class="emergency-icon" id="emergencyIcon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h1 id="emergencyTitle">ÿ™ŸÜÿ®ŸäŸá ÿ∑Ÿàÿßÿ±ÿ¶</h1>
            <div class="emergency-type" id="emergencyType">-</div>
            
            <div class="instruction-box">
                <h2 id="instructionTitle">ÿßŸÑÿ™Ÿàÿ¨ŸäŸáÿßÿ™:</h2>
                <div class="location" id="emergencyLocation">-</div>
            </div>
            
            <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ -->
            <div class="steps-summary" id="stepsSummary" style="display: none;">
                <h3><i class="fas fa-list-ol"></i> ÿßŸÑÿÆÿ∑Ÿàÿßÿ™:</h3>
                <div id="stepsContent" class="steps-container"></div>
            </div>
            
            <div class="muster-point" id="musterSection" style="display: none;">
                <h3><i class="fas fa-location-arrow"></i> ÿßŸÑÿ™Ÿàÿ¨Ÿá ÿ•ŸÑŸâ:</h3>
                <div class="point-name" id="musterPoint">-</div>
            </div>
            
            <div class="timer">
                <span>ÿßŸÑŸàŸÇÿ™ ŸÖŸÜÿ∞ ÿßŸÑÿ®ŸÑÿßÿ∫:</span>
                <span class="time-display" id="elapsedTime">00:00</span>
            </div>
            
            <div class="emergency-numbers" id="emergencyNumbers">
                <div class="emergency-number">
                    <i class="fas fa-phone"></i>
                    <span>911</span>
                </div>
                <div class="emergency-number">
                    <i class="fas fa-fire-extinguisher"></i>
                    <span>998</span>
                </div>
                <div class="emergency-number">
                    <i class="fas fa-ambulance"></i>
                    <span>997</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        ŸÖÿ¨ŸÖÿπ ŸÖŸÉÿ© ÿßŸÑÿ∑ÿ®Ÿä ÿ®ÿßŸÑÿ≤ÿßŸáÿ± - ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿßŸÑŸÖÿ±ŸÉÿ≤Ÿä
    </div>

    <!-- ÿ≤ÿ± ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™ (Ÿäÿ∏Ÿáÿ± ŸÅŸä ÿßŸÑÿ≤ÿßŸàŸäÿ© ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÖŸÜÿπ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ) -->
    <div id="soundGate" class="sound-gate hidden">
      <button id="enableSoundBtn" class="sound-btn">
        <i class="fas fa-volume-up"></i> ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™
      </button>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbztSmY_O_ITwKYXVNzs2wH8Wsid05XEZ5bEG6KJf4453dlFE8JHG_zRmuJbOksa6UgogQ/exec';

        let currentCommand = null;
        let sirenInterval = null;
        let timerInterval = null;
        let commandStartTime = null;

        // Web Audio API Siren System
        let audioCtx = null;
        let sirenOsc1 = null;
        let sirenOsc2 = null;
        let sirenGain = null;
        let sirenPlaying = false;

        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function startSiren() {
            try {
                initAudioContext();
                if (sirenPlaying) return;
                sirenPlaying = true;

                sirenGain = audioCtx.createGain();
                sirenGain.gain.value = 0.6;
                sirenGain.connect(audioCtx.destination);

                sirenOsc1 = audioCtx.createOscillator();
                sirenOsc1.type = 'sawtooth';
                sirenOsc1.frequency.value = 600;
                sirenOsc1.connect(sirenGain);
                sirenOsc1.start();

                sirenOsc2 = audioCtx.createOscillator();
                sirenOsc2.type = 'square';
                sirenOsc2.frequency.value = 800;
                sirenOsc2.connect(sirenGain);
                sirenOsc2.start();

                let ascending = true;
                sirenInterval = setInterval(() => {
                    if (!sirenOsc1 || !sirenOsc2) return;
                    const now = audioCtx.currentTime;
                    if (ascending) {
                        sirenOsc1.frequency.linearRampToValueAtTime(1200, now + 0.5);
                        sirenOsc2.frequency.linearRampToValueAtTime(1400, now + 0.5);
                    } else {
                        sirenOsc1.frequency.linearRampToValueAtTime(400, now + 0.5);
                        sirenOsc2.frequency.linearRampToValueAtTime(600, now + 0.5);
                    }
                    ascending = !ascending;
                }, 500);

            } catch(e) {
                console.error('Siren error:', e);
                showSoundGate();
            }
        }

        function stopSiren() {
            sirenPlaying = false;
            if (sirenInterval) {
                clearInterval(sirenInterval);
                sirenInterval = null;
            }
            try {
                if (sirenOsc1) { sirenOsc1.stop(); sirenOsc1.disconnect(); sirenOsc1 = null; }
                if (sirenOsc2) { sirenOsc2.stop(); sirenOsc2.disconnect(); sirenOsc2 = null; }
                if (sirenGain) { sirenGain.disconnect(); sirenGain = null; }
            } catch(e) {}
        }

        // ========== ÿµŸàÿ™ ŸÜÿ®ÿ∂ÿßÿ™ ÿßŸÑŸÇŸÑÿ® (ŸÑŸÑÿ™Ÿàÿ¨ŸäŸá) ==========
        let heartbeatInterval = null;
        let heartbeatPlaying = false;
        
        function startHeartbeat() {
            try {
                initAudioContext();
                if (heartbeatPlaying) return;
                heartbeatPlaying = true;
                
                function playBeat() {
                    if (!heartbeatPlaying) return;
                    
                    // ŸÜÿ®ÿ∂ÿ© ŸÇŸàŸäÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ oscillators ŸÖÿ™ÿπÿØÿØÿ©
                    const osc1 = audioCtx.createOscillator();
                    const osc2 = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    
                    osc1.type = 'sine';
                    osc1.frequency.value = 60; // bass ÿπŸÖŸäŸÇ
                    osc2.type = 'sine';
                    osc2.frequency.value = 120; // ÿ∑ÿ®ŸÇÿ© ÿ´ÿßŸÜŸäÿ©
                    
                    osc1.connect(gain);
                    osc2.connect(gain);
                    gain.connect(audioCtx.destination);
                    
                    const now = audioCtx.currentTime;
                    
                    // ÿØŸàŸÖ-ÿØŸàŸÖ ÿ£ŸàŸÑ (ŸÇŸàŸä ÿ¨ÿØÿßŸã)
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(1.0, now + 0.03);
                    gain.gain.linearRampToValueAtTime(0.3, now + 0.1);
                    gain.gain.linearRampToValueAtTime(0, now + 0.18);
                    
                    // ÿØŸàŸÖ-ÿØŸàŸÖ ÿ´ÿßŸÜŸä (ŸÇŸàŸä)
                    gain.gain.linearRampToValueAtTime(0.9, now + 0.25);
                    gain.gain.linearRampToValueAtTime(0.2, now + 0.32);
                    gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    
                    osc1.start(now);
                    osc2.start(now);
                    osc1.stop(now + 0.45);
                    osc2.stop(now + 0.45);
                }
                
                playBeat();
                heartbeatInterval = setInterval(playBeat, 700);
                
            } catch(e) {
                console.error('Heartbeat error:', e);
                showSoundGate();
            }
        }
        
        function stopHeartbeat() {
            heartbeatPlaying = false;
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // ========== ÿµŸàÿ™ ÿ™ŸÜÿ®ŸäŸá ÿßŸÑÿπÿ≤ŸÑ (ŸÑŸÑÿπÿØŸàŸâ) ==========
        let isolationInterval = null;
        let isolationPlaying = false;
        
        function startIsolationAlert() {
            try {
                initAudioContext();
                if (isolationPlaying) return;
                isolationPlaying = true;
                
                function playAlert() {
                    if (!isolationPlaying) return;
                    
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    
                    osc.type = 'triangle';
                    osc.frequency.value = 520;
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    
                    const now = audioCtx.currentTime;
                    
                    // 3 beeps ÿ≥ÿ±Ÿäÿπÿ©
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.6, now + 0.05);
                    gain.gain.linearRampToValueAtTime(0, now + 0.12);
                    
                    gain.gain.linearRampToValueAtTime(0.6, now + 0.18);
                    gain.gain.linearRampToValueAtTime(0, now + 0.25);
                    
                    gain.gain.linearRampToValueAtTime(0.6, now + 0.31);
                    gain.gain.linearRampToValueAtTime(0, now + 0.38);
                    
                    osc.start(now);
                    osc.stop(now + 0.5);
                }
                
                playAlert();
                isolationInterval = setInterval(playAlert, 1200);
                
            } catch(e) {
                console.error('Isolation alert error:', e);
                showSoundGate();
            }
        }
        
        function stopIsolationAlert() {
            isolationPlaying = false;
            if (isolationInterval) {
                clearInterval(isolationInterval);
                isolationInterval = null;
            }
        }

        // ========== ÿ•ŸäŸÇÿßŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿµŸàÿßÿ™ ==========
        function stopAllSounds() {
            stopSiren();
            stopHeartbeat();
            stopIsolationAlert();
        }

        // ========== Text-to-Speech ŸÑŸÑÿ£ŸàÿßŸÖÿ± ÿßŸÑÿµŸàÿ™Ÿäÿ© ==========
        let bestArabicVoice = null;
        
        function findBestArabicVoice() {
            const voices = speechSynthesis.getVoices();
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÅÿ∂ŸÑŸäÿ©: Google Arabic > Microsoft Arabic > ÿ£Ÿä ÿµŸàÿ™ ÿπÿ±ÿ®Ÿä
            const priorities = [
                v => v.name.includes('Google') && v.lang.startsWith('ar'),
                v => v.name.includes('Microsoft') && v.lang.startsWith('ar'),
                v => v.name.includes('Majed') || v.name.includes('ŸÖÿßÿ¨ÿØ'),
                v => v.name.includes('Hoda') || v.name.includes('ŸáÿØŸâ'),
                v => v.name.includes('Naayf') || v.name.includes('ŸÜÿßŸäŸÅ'),
                v => v.lang === 'ar-SA',
                v => v.lang === 'ar-XA',
                v => v.lang.startsWith('ar')
            ];
            
            for (const check of priorities) {
                const found = voices.find(check);
                if (found) {
                    console.log('Selected Arabic voice:', found.name, found.lang);
                    return found;
                }
            }
            return null;
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿµŸàÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ¨ÿßŸáÿ≤Ÿäÿ©
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                bestArabicVoice = findBestArabicVoice();
            };
            // ŸÖÿ≠ÿßŸàŸÑÿ© ŸÅŸàÿ±Ÿäÿ©
            bestArabicVoice = findBestArabicVoice();
        }
        
        function speakCommand(text, repeat = 2) {
            if (!('speechSynthesis' in window)) {
                console.warn('TTS not supported');
                return;
            }
            
            // ÿ•ŸäŸÇÿßŸÅ ÿ£Ÿä ŸÜÿ∑ŸÇ ÿ≥ÿßÿ®ŸÇ
            speechSynthesis.cancel();
            
            let count = 0;
            function speak() {
                if (count >= repeat) return;
                count++;
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = 0.85; // ÿ£ÿ®ÿ∑ÿ£ ŸÇŸÑŸäŸÑÿßŸã ŸÑŸÑŸàÿ∂Ÿàÿ≠
                utterance.pitch = 1.1; // ÿ£ÿπŸÑŸâ ŸÇŸÑŸäŸÑÿßŸã
                utterance.volume = 1;
                
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ£ŸÅÿ∂ŸÑ ÿµŸàÿ™ ÿπÿ±ÿ®Ÿä
                if (bestArabicVoice) {
                    utterance.voice = bestArabicVoice;
                } else {
                    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÖÿ¨ÿØÿØÿßŸã
                    bestArabicVoice = findBestArabicVoice();
                    if (bestArabicVoice) utterance.voice = bestArabicVoice;
                }
                
                utterance.onend = () => {
                    if (count < repeat) {
                        setTimeout(speak, 2000); // ŸÅÿßÿµŸÑ ÿ£ÿ∑ŸàŸÑ
                    }
                };
                
                utterance.onerror = (e) => {
                    console.error('Speech error:', e);
                };
                
                speechSynthesis.speak(utterance);
            }
            
            // ÿ™ÿ£ÿÆŸäÿ± ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿµŸàÿßÿ™
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.onvoiceschanged = () => {
                    bestArabicVoice = findBestArabicVoice();
                    speak();
                };
            } else {
                speak();
            }
        }

        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }

        function isTrue(v){
          const s = String(v).toLowerCase().trim();
          return v === true || s === 'true' || s === 'yes' || s === '1';
        }

        let audioUnlocked = false;

        function showSoundGate(){
          const g = document.getElementById('soundGate');
          if (g) g.classList.remove('hidden');
        }
        function hideSoundGate(){
          const g = document.getElementById('soundGate');
          if (g) g.classList.add('hidden');
        }

        // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿ®ÿ£Ÿä ŸÜŸÇÿ±ÿ© ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©
        function unlockAudioOnInteraction() {
          if (audioUnlocked) return;
          try {
            initAudioContext();
            audioUnlocked = true;
            hideSoundGate();
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ•ŸÜÿ∞ÿßÿ± ŸÜÿ¥ÿ∑ÿå ÿ¥ÿ∫ŸÑ ÿßŸÑÿµŸàÿ™ ŸÅŸàÿ±ÿßŸã
            if (currentCommand && !sirenPlaying) {
              startSiren();
            }
            // ÿ£ÿ≤ŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπŸäŸÜ ÿ®ÿπÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑ
            document.removeEventListener('click', unlockAudioOnInteraction);
            document.removeEventListener('touchstart', unlockAudioOnInteraction);
            document.removeEventListener('keydown', unlockAudioOnInteraction);
          } catch(e) {
            console.warn('Audio unlock failed:', e);
          }
        }

        // ÿßÿ≥ÿ™ŸÖÿπ ŸÑÿ£Ÿä ÿ™ŸÅÿßÿπŸÑ ŸÖÿπ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('click', unlockAudioOnInteraction);
        document.addEventListener('touchstart', unlockAudioOnInteraction);
        document.addEventListener('keydown', unlockAudioOnInteraction);

        let monitoringStarted = false;
        let eventSource = null;
        let sseConnected = false;
        let sseReconnectAttempts = 0;
        let pollingInterval = null;
        const MAX_SSE_RECONNECT = 5;

        function connectSSE() {
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }

          const sseUrl = '/api/emergency-stream';
          console.log('üîå Connecting to SSE...');
          
          eventSource = new EventSource(sseUrl);
          
          eventSource.onopen = () => {
            console.log('‚úÖ SSE Connected - ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ŸÅŸàÿ±Ÿäÿ©!');
            sseConnected = true;
            sseReconnectAttempts = 0;
            updateConnectionStatus(true);
            if (pollingInterval) {
              clearInterval(pollingInterval);
              pollingInterval = null;
            }
          };

          eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              
              if (data.connected) {
                console.log('üü¢ SSE Ready');
                return;
              }
              
              if (data.error) {
                console.warn('SSE Error:', data.error);
                return;
              }

              if (data.command) {
                const cmd = data.command;
                if (cmd && isTrue(cmd.active)) {
                  if (!currentCommand || currentCommand.timestamp !== cmd.timestamp) {
                    activateEmergency(cmd);
                  }
                }
              } else if (data.cleared) {
                if (currentCommand) {
                  console.log('üî¥ Emergency cleared via SSE');
                  deactivateEmergency();
                }
              }
            } catch (e) {
              console.error('SSE parse error:', e);
            }
          };

          eventSource.onerror = (e) => {
            console.warn('‚ö†Ô∏è SSE Error - attempting reconnect');
            sseConnected = false;
            updateConnectionStatus(false);
            
            if (eventSource) {
              eventSource.close();
              eventSource = null;
            }
            
            sseReconnectAttempts++;
            if (sseReconnectAttempts < MAX_SSE_RECONNECT) {
              setTimeout(connectSSE, 3000);
            } else {
              console.log('üì° Falling back to polling mode');
              startPollingFallback();
            }
          };
        }

        function startPollingFallback() {
          if (pollingInterval) return;
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }
          console.log('üì° Using fast polling (1 second)');
          updateConnectionStatus(false);
          checkActiveCommand();
          pollingInterval = setInterval(checkActiveCommand, 1000);
        }

        function updateConnectionStatus(connected) {
          const indicator = document.getElementById('connectionIndicator');
          if (indicator) {
            indicator.className = connected ? 'connection-indicator connected' : 'connection-indicator polling';
            indicator.title = connected ? 'SSE - ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ŸÅŸàÿ±Ÿäÿ©' : 'Polling - ŸÉŸÑ ÿ´ÿßŸÜŸäÿ©';
            const statusText = indicator.querySelector('.status-text');
            if (statusText) {
              statusText.textContent = connected ? '‚ö° SSE - ŸÅŸàÿ±Ÿä' : 'üì° 1 ÿ´ÿßŸÜŸäÿ©';
            }
          }
        }

        function startMonitoring() {
          if (monitoringStarted) return;
          monitoringStarted = true;
          
          // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™
          try {
            initAudioContext();
            audioUnlocked = true;
          } catch(e) {}
          
          // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ©
          const startScreen = document.getElementById('startScreen');
          if (startScreen) startScreen.classList.add('hidden');
          
          // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ SSE ÿ£ŸàŸÑÿßŸã
          if (typeof EventSource !== 'undefined') {
            connectSSE();
            // fallback ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜŸä ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ÿµŸÑ SSE
            setTimeout(() => {
              if (!sseConnected) {
                console.log('SSE timeout - using polling');
                startPollingFallback();
              }
            }, 5000);
          } else {
            // ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ SSE
            startPollingFallback();
          }
        }

        document.addEventListener('DOMContentLoaded', () => {
          // ÿ™ŸáŸäÿ¶ÿ© Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸÅÿπŸÑÿßŸã
          initControlMode();
          
          // ÿ≤ÿ± ÿßŸÑÿ®ÿØÿßŸäÿ©
          const startBtn = document.getElementById('startBtn');
          if (startBtn) startBtn.addEventListener('click', startMonitoring);
          
          // ÿ≤ÿ± ÿßŸÑÿµŸàÿ™ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
          const soundBtn = document.getElementById('enableSoundBtn');
          if (soundBtn) soundBtn.addEventListener('click', unlockAudioOnInteraction);
        });

        function jsonp(action, params = {}) {
            return new Promise((resolve, reject) => {
                const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
                params.action = action;
                params.callback = cb;

                const s = document.createElement("script");
                s.src = WEB_APP_URL + "?" + new URLSearchParams(params).toString();

                window[cb] = (data) => { cleanup(); resolve(data); };
                s.onerror = () => { cleanup(); reject(new Error("jsonp failed")); };

                function cleanup() {
                    try { delete window[cb]; } catch(e) {}
                    if (s.parentNode) s.parentNode.removeChild(s);
                }
                document.body.appendChild(s);
            });
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            document.getElementById('currentDate').textContent =
                now.toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        async function checkActiveCommand() {
            try {
                const data = await jsonp('getActiveCommand', {});
                const cmd = data && data.ok ? data.command : null;

                if (cmd && isTrue(cmd.active)) {
                    if (!currentCommand || currentCommand.timestamp !== cmd.timestamp) {
                        activateEmergency(cmd);
                    }
                } else {
                    if (currentCommand) deactivateEmergency();
                }
            } catch (e) {
                console.error('checkActiveCommand:', e);
            }
        }

        // ========== Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ==========
        let controlMode = false;
        let selectedScenario = null;
        let isDrillMode = false;
        
        const typeLabels = {
            'fire': 'ÿ≠ÿ±ŸäŸÇ',
            'power': 'ÿßŸÜŸÇÿ∑ÿßÿπ ŸÉŸáÿ±ÿ®ÿßÿ°',
            'water': 'ÿ™ÿ≥ÿ±ÿ® ŸÖŸäÿßŸá',
            'injury': 'ÿ•ÿ∫ŸÖÿßÿ°/ÿ•ÿµÿßÿ®ÿ©',
            'infection': 'ÿ™ŸÅÿ¥Ÿä ÿπÿØŸàŸâ'
        };
        
        function initControlMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'control') {
                controlMode = true;
                document.body.classList.add('control-mode');
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('safeScreen').classList.add('hidden');
                document.getElementById('controlPanel').classList.add('active');
            }
        }
        
        function selectScenario(type, evt) {
            selectedScenario = type;
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
            const target = evt ? evt.target : event.target;
            if (target) {
                const card = target.closest('.scenario-card');
                if (card) card.classList.add('selected');
            }
            updateActivateButton();
        }
        
        function toggleDrill(evt) {
            if (evt) evt.stopPropagation();
            const checkbox = document.getElementById('drillCheckbox');
            isDrillMode = !isDrillMode;
            checkbox.checked = isDrillMode;
            updateActivateButton();
        }
        
        function updateActivateButton() {
            const btn = document.getElementById('activateControlBtn');
            if (!selectedScenario) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-bell"></i><span>ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿ£ŸàŸÑÿßŸã</span>';
                btn.classList.remove('drill-mode');
            } else {
                btn.disabled = false;
                const label = typeLabels[selectedScenario];
                if (isDrillMode) {
                    btn.innerHTML = `<i class="fas fa-clipboard-check"></i><span>ÿ™ŸÅÿπŸäŸÑ ÿ™ŸÖÿ±ŸäŸÜ: ${label}</span>`;
                    btn.classList.add('drill-mode');
                } else {
                    btn.innerHTML = `<i class="fas fa-bell"></i><span>ÿ™ŸÅÿπŸäŸÑ ÿ∑Ÿàÿßÿ±ÿ¶: ${label}</span>`;
                    btn.classList.remove('drill-mode');
                }
            }
        }
        
        async function activateFromControl() {
            if (!selectedScenario) return;
            
            const label = typeLabels[selectedScenario];
            const confirmMsg = isDrillMode
                ? `ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ŸÅÿπŸäŸÑ ÿ™ŸÖÿ±ŸäŸÜ: ${label}ÿü`
                : `‚ö†Ô∏è ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ŸÅÿπŸäŸÑ ÿ∑Ÿàÿßÿ±ÿ¶ ÿ≠ŸÇŸäŸÇŸäÿ©: ${label}ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿ¥ÿπÿßÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ!`;
            
            if (!confirm(confirmMsg)) return;
            
            const btn = document.getElementById('activateControlBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÅÿπŸäŸÑ...</span>';
            
            const payload = {
                responseType: selectedScenario,
                reportType: label,
                location: 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿØŸàÿßÿ±',
                muster: 'ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ™ÿ¨ŸÖÿπ A - ÿßŸÑŸÖŸàŸÇŸÅ ÿßŸÑÿ£ŸÖÿßŸÖŸä',
                isDrill: isDrillMode
            };
            
            try {
                await jsonp('setActiveCommand', payload);
                
                // ÿ•ÿÆŸÅÿßÿ° Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ Ÿàÿπÿ±ÿ∂ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶
                document.getElementById('controlPanel').classList.remove('active');
                activateEmergency(payload);
                
            } catch(e) {
                console.error('Activation error:', e);
                // ÿ≠ÿ™Ÿâ ŸÑŸà ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑÿå ŸÜŸÅÿπŸëŸÑ ŸÖÿ≠ŸÑŸäÿßŸã
                document.getElementById('controlPanel').classList.remove('active');
                activateEmergency(payload);
            }
        }
        
        // ========== ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ==========
        const scenarioSteps = {
            'fire': ['üÜò R: ÿ£ŸÜŸÇÿ∞ ŸÖŸÜ ŸÅŸä ÿÆÿ∑ÿ±', 'üö® A: ÿ•ŸÜÿ∞ÿßÿ± + ÿßÿ™ÿµŸÑ 998', 'üö™ C: ÿ£ÿ∫ŸÑŸÇ ÿßŸÑÿ£ÿ®Ÿàÿßÿ®', 'üèÉ E: ÿ£ÿÆŸÑŸê ŸÑŸÑÿ™ÿ¨ŸÖÿπ', 'üßØ PASS: ÿ∑ŸÅÿßŸäÿ©', 'üõó ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿµÿπÿØ!'],
            'ÿ≠ÿ±ŸäŸÇ': ['üÜò R: ÿ£ŸÜŸÇÿ∞ ŸÖŸÜ ŸÅŸä ÿÆÿ∑ÿ±', 'üö® A: ÿ•ŸÜÿ∞ÿßÿ± + ÿßÿ™ÿµŸÑ 998', 'üö™ C: ÿ£ÿ∫ŸÑŸÇ ÿßŸÑÿ£ÿ®Ÿàÿßÿ®', 'üèÉ E: ÿ£ÿÆŸÑŸê ŸÑŸÑÿ™ÿ¨ŸÖÿπ', 'üßØ PASS: ÿ∑ŸÅÿßŸäÿ©', 'üõó ŸÑÿß ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿµÿπÿØ!'],
            'power': ['üîã ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖŸàŸÑÿØ', 'üîå ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿ≠ÿ±ÿ¨ÿ© ÿπŸÑŸâ UPS', 'üè• ÿ™ŸÅŸÇÿØ ÿßŸÑŸÖÿ±ÿ∂Ÿâ', 'üìû ÿ£ÿ®ŸÑÿ∫ ÿßŸÑÿµŸäÿßŸÜÿ©+EOC', 'üõó ÿ£ÿÆŸÑŸê ÿßŸÑŸÖÿµÿπÿØ!', '‚ùÑÔ∏è ŸÑÿß ÿ™ŸÅÿ™ÿ≠ ÿ´ŸÑÿßÿ¨ÿßÿ™ ÿßŸÑÿ£ÿØŸàŸäÿ©'],
            'ŸÉŸáÿ±ÿ®ÿßÿ°': ['üîã ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖŸàŸÑÿØ', 'üîå ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿ≠ÿ±ÿ¨ÿ© ÿπŸÑŸâ UPS', 'üè• ÿ™ŸÅŸÇÿØ ÿßŸÑŸÖÿ±ÿ∂Ÿâ', 'üìû ÿ£ÿ®ŸÑÿ∫ ÿßŸÑÿµŸäÿßŸÜÿ©+EOC', 'üõó ÿ£ÿÆŸÑŸê ÿßŸÑŸÖÿµÿπÿØ!', '‚ùÑÔ∏è ŸÑÿß ÿ™ŸÅÿ™ÿ≠ ÿ´ŸÑÿßÿ¨ÿßÿ™ ÿßŸÑÿ£ÿØŸàŸäÿ©'],
            'ÿßŸÜŸÇÿ∑ÿßÿπ ŸÉŸáÿ±ÿ®ÿßÿ°': ['üîã ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖŸàŸÑÿØ', 'üîå ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿ≠ÿ±ÿ¨ÿ© ÿπŸÑŸâ UPS', 'üè• ÿ™ŸÅŸÇÿØ ÿßŸÑŸÖÿ±ÿ∂Ÿâ', 'üìû ÿ£ÿ®ŸÑÿ∫ ÿßŸÑÿµŸäÿßŸÜÿ©+EOC', 'üõó ÿ£ÿÆŸÑŸê ÿßŸÑŸÖÿµÿπÿØ!', '‚ùÑÔ∏è ŸÑÿß ÿ™ŸÅÿ™ÿ≠ ÿ´ŸÑÿßÿ¨ÿßÿ™ ÿßŸÑÿ£ÿØŸàŸäÿ©'],
            'water': ['üèÉ ÿ£ÿ®ÿπÿØ ÿßŸÑŸÜÿßÿ≥ ŸÅŸàÿ±ÿßŸã', '‚ö° ÿßŸÅÿµŸÑ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ°!', 'üö∞ ÿ£ÿ∫ŸÑŸÇ ÿßŸÑŸÖÿ≠ÿ®ÿ≥', 'üíª ÿßÿ±ŸÅÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿπŸÜ ÿßŸÑÿ£ÿ±ÿ∂!', '‚ö†Ô∏è ÿπŸÑÿßŸÖÿ© "ÿ£ÿ±ÿ∂Ÿäÿ© ÿ≤ŸÑŸÇÿ©"', 'üìû ÿ£ÿ®ŸÑÿ∫ ÿßŸÑÿµŸäÿßŸÜÿ©'],
            'ŸÖŸäÿßŸá': ['üèÉ ÿ£ÿ®ÿπÿØ ÿßŸÑŸÜÿßÿ≥ ŸÅŸàÿ±ÿßŸã', '‚ö° ÿßŸÅÿµŸÑ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ°!', 'üö∞ ÿ£ÿ∫ŸÑŸÇ ÿßŸÑŸÖÿ≠ÿ®ÿ≥', 'üíª ÿßÿ±ŸÅÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿπŸÜ ÿßŸÑÿ£ÿ±ÿ∂!', '‚ö†Ô∏è ÿπŸÑÿßŸÖÿ© "ÿ£ÿ±ÿ∂Ÿäÿ© ÿ≤ŸÑŸÇÿ©"', 'üìû ÿ£ÿ®ŸÑÿ∫ ÿßŸÑÿµŸäÿßŸÜÿ©'],
            'ÿ™ÿ≥ÿ±ÿ® ŸÖŸäÿßŸá': ['üèÉ ÿ£ÿ®ÿπÿØ ÿßŸÑŸÜÿßÿ≥ ŸÅŸàÿ±ÿßŸã', '‚ö° ÿßŸÅÿµŸÑ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ°!', 'üö∞ ÿ£ÿ∫ŸÑŸÇ ÿßŸÑŸÖÿ≠ÿ®ÿ≥', 'üíª ÿßÿ±ŸÅÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿπŸÜ ÿßŸÑÿ£ÿ±ÿ∂!', '‚ö†Ô∏è ÿπŸÑÿßŸÖÿ© "ÿ£ÿ±ÿ∂Ÿäÿ© ÿ≤ŸÑŸÇÿ©"', 'üìû ÿ£ÿ®ŸÑÿ∫ ÿßŸÑÿµŸäÿßŸÜÿ©'],
            'injury': ['üõ°Ô∏è ÿ£ŸÖŸëŸÜ ÿßŸÑŸÖŸÉÿßŸÜ', 'üëã ÿßŸÅÿ≠ÿµ ÿßŸÑŸàÿπŸä', 'üìû ÿßÿ™ÿµŸÑ 997', 'ü¶µ ÿßÿ±ŸÅÿπ ÿßŸÑÿ±ÿ¨ŸÑŸäŸÜ 30ÿ≥ŸÖ', 'üí® ÿßŸÅÿ™ÿ≠ ŸÖÿ¨ÿ±Ÿâ ÿßŸÑŸáŸàÿßÿ°', 'ü¶∑ ÿ£ÿ≥ŸÜÿßŸÜ: ÿ£ÿÆÿ±ÿ¨ ÿßŸÑÿ£ÿØŸàÿßÿ™!'],
            'ÿ•ÿ∫ŸÖÿßÿ°': ['üõ°Ô∏è ÿ£ŸÖŸëŸÜ ÿßŸÑŸÖŸÉÿßŸÜ', 'üëã ÿßŸÅÿ≠ÿµ ÿßŸÑŸàÿπŸä', 'üìû ÿßÿ™ÿµŸÑ 997', 'ü¶µ ÿßÿ±ŸÅÿπ ÿßŸÑÿ±ÿ¨ŸÑŸäŸÜ 30ÿ≥ŸÖ', 'üí® ÿßŸÅÿ™ÿ≠ ŸÖÿ¨ÿ±Ÿâ ÿßŸÑŸáŸàÿßÿ°', 'ü¶∑ ÿ£ÿ≥ŸÜÿßŸÜ: ÿ£ÿÆÿ±ÿ¨ ÿßŸÑÿ£ÿØŸàÿßÿ™!'],
            'ÿ•ÿµÿßÿ®ÿ©': ['üõ°Ô∏è ÿ£ŸÖŸëŸÜ ÿßŸÑŸÖŸÉÿßŸÜ', 'üëã ÿßŸÅÿ≠ÿµ ÿßŸÑŸàÿπŸä', 'üìû ÿßÿ™ÿµŸÑ 997', 'ü¶µ ÿßÿ±ŸÅÿπ ÿßŸÑÿ±ÿ¨ŸÑŸäŸÜ 30ÿ≥ŸÖ', 'üí® ÿßŸÅÿ™ÿ≠ ŸÖÿ¨ÿ±Ÿâ ÿßŸÑŸáŸàÿßÿ°', 'ü¶∑ ÿ£ÿ≥ŸÜÿßŸÜ: ÿ£ÿÆÿ±ÿ¨ ÿßŸÑÿ£ÿØŸàÿßÿ™!'],
            'ÿ•ÿ∫ŸÖÿßÿ°/ÿ•ÿµÿßÿ®ÿ©': ['üõ°Ô∏è ÿ£ŸÖŸëŸÜ ÿßŸÑŸÖŸÉÿßŸÜ', 'üëã ÿßŸÅÿ≠ÿµ ÿßŸÑŸàÿπŸä', 'üìû ÿßÿ™ÿµŸÑ 997', 'ü¶µ ÿßÿ±ŸÅÿπ ÿßŸÑÿ±ÿ¨ŸÑŸäŸÜ 30ÿ≥ŸÖ', 'üí® ÿßŸÅÿ™ÿ≠ ŸÖÿ¨ÿ±Ÿâ ÿßŸÑŸáŸàÿßÿ°', 'ü¶∑ ÿ£ÿ≥ŸÜÿßŸÜ: ÿ£ÿÆÿ±ÿ¨ ÿßŸÑÿ£ÿØŸàÿßÿ™!'],
            'infection': ['üîí ÿßÿπÿ≤ŸÑ ÿßŸÑŸÖÿ±Ÿäÿ∂ ŸÅŸàÿ±ÿßŸã', 'üß§ ÿßŸÑÿ®ÿ≥ ŸÇŸÅÿßÿ≤ÿßÿ™+ŸÉŸÖÿßŸÖÿ©+ÿπÿ®ÿßÿ°ÿ©', 'üìû ÿ£ÿ®ŸÑÿ∫ ŸÖŸÉÿßŸÅÿ≠ÿ© ÿßŸÑÿπÿØŸàŸâ', 'üß¥ ÿßÿ∫ÿ≥ŸÑ ŸäÿØŸäŸÉ 20 ÿ´ÿßŸÜŸäÿ©', 'ü©∏ ÿØŸÖ ÿπŸÑŸâ ÿßŸÑÿ£ÿ±ÿ∂ÿü ÿ∫ÿ∑ŸëŸá ÿ´ŸÖ ÿµÿ® ŸÉŸÑŸàÿ± ŸÖÿÆŸÅŸÅ', 'üî¥ ÿßŸÑŸÜŸÅÿßŸäÿßÿ™ ŸÅŸä ŸÉŸäÿ≥ ÿ£ÿ≠ŸÖÿ±'],
            'ÿπÿØŸàŸâ': ['üîí ÿßÿπÿ≤ŸÑ ÿßŸÑŸÖÿ±Ÿäÿ∂ ŸÅŸàÿ±ÿßŸã', 'üß§ ÿßŸÑÿ®ÿ≥ ŸÇŸÅÿßÿ≤ÿßÿ™+ŸÉŸÖÿßŸÖÿ©+ÿπÿ®ÿßÿ°ÿ©', 'üìû ÿ£ÿ®ŸÑÿ∫ ŸÖŸÉÿßŸÅÿ≠ÿ© ÿßŸÑÿπÿØŸàŸâ', 'üß¥ ÿßÿ∫ÿ≥ŸÑ ŸäÿØŸäŸÉ 20 ÿ´ÿßŸÜŸäÿ©', 'ü©∏ ÿØŸÖ ÿπŸÑŸâ ÿßŸÑÿ£ÿ±ÿ∂ÿü ÿ∫ÿ∑ŸëŸá ÿ´ŸÖ ÿµÿ® ŸÉŸÑŸàÿ± ŸÖÿÆŸÅŸÅ', 'üî¥ ÿßŸÑŸÜŸÅÿßŸäÿßÿ™ ŸÅŸä ŸÉŸäÿ≥ ÿ£ÿ≠ŸÖÿ±'],
            'outbreak': ['üîí ÿßÿπÿ≤ŸÑ ÿßŸÑŸÖÿ±Ÿäÿ∂ ŸÅŸàÿ±ÿßŸã', 'üß§ ÿßŸÑÿ®ÿ≥ ŸÇŸÅÿßÿ≤ÿßÿ™+ŸÉŸÖÿßŸÖÿ©+ÿπÿ®ÿßÿ°ÿ©', 'üìû ÿ£ÿ®ŸÑÿ∫ ŸÖŸÉÿßŸÅÿ≠ÿ© ÿßŸÑÿπÿØŸàŸâ', 'üß¥ ÿßÿ∫ÿ≥ŸÑ ŸäÿØŸäŸÉ 20 ÿ´ÿßŸÜŸäÿ©', 'ü©∏ ÿØŸÖ ÿπŸÑŸâ ÿßŸÑÿ£ÿ±ÿ∂ÿü ÿ∫ÿ∑ŸëŸá ÿ´ŸÖ ÿµÿ® ŸÉŸÑŸàÿ± ŸÖÿÆŸÅŸÅ', 'üî¥ ÿßŸÑŸÜŸÅÿßŸäÿßÿ™ ŸÅŸä ŸÉŸäÿ≥ ÿ£ÿ≠ŸÖÿ±'],
            'ÿ™ŸÅÿ¥Ÿä ÿπÿØŸàŸâ': ['üîí ÿßÿπÿ≤ŸÑ ÿßŸÑŸÖÿ±Ÿäÿ∂ ŸÅŸàÿ±ÿßŸã', 'üß§ ÿßŸÑÿ®ÿ≥ ŸÇŸÅÿßÿ≤ÿßÿ™+ŸÉŸÖÿßŸÖÿ©+ÿπÿ®ÿßÿ°ÿ©', 'üìû ÿ£ÿ®ŸÑÿ∫ ŸÖŸÉÿßŸÅÿ≠ÿ© ÿßŸÑÿπÿØŸàŸâ', 'üß¥ ÿßÿ∫ÿ≥ŸÑ ŸäÿØŸäŸÉ 20 ÿ´ÿßŸÜŸäÿ©', 'ü©∏ ÿØŸÖ ÿπŸÑŸâ ÿßŸÑÿ£ÿ±ÿ∂ÿü ÿ∫ÿ∑ŸëŸá ÿ´ŸÖ ÿµÿ® ŸÉŸÑŸàÿ± ŸÖÿÆŸÅŸÅ', 'üî¥ ÿßŸÑŸÜŸÅÿßŸäÿßÿ™ ŸÅŸä ŸÉŸäÿ≥ ÿ£ÿ≠ŸÖÿ±'],
            'ÿ™ŸÅÿ¥Ÿä ÿπÿØŸàŸâ / ŸÖŸÉÿßŸÅÿ≠ÿ© ÿßŸÑÿπÿØŸàŸâ': ['üîí ÿßÿπÿ≤ŸÑ ÿßŸÑŸÖÿ±Ÿäÿ∂ ŸÅŸàÿ±ÿßŸã', 'üß§ ÿßŸÑÿ®ÿ≥ ŸÇŸÅÿßÿ≤ÿßÿ™+ŸÉŸÖÿßŸÖÿ©+ÿπÿ®ÿßÿ°ÿ©', 'üìû ÿ£ÿ®ŸÑÿ∫ ŸÖŸÉÿßŸÅÿ≠ÿ© ÿßŸÑÿπÿØŸàŸâ', 'üß¥ ÿßÿ∫ÿ≥ŸÑ ŸäÿØŸäŸÉ 20 ÿ´ÿßŸÜŸäÿ©', 'ü©∏ ÿØŸÖ ÿπŸÑŸâ ÿßŸÑÿ£ÿ±ÿ∂ÿü ÿ∫ÿ∑ŸëŸá ÿ´ŸÖ ÿµÿ® ŸÉŸÑŸàÿ± ŸÖÿÆŸÅŸÅ', 'üî¥ ÿßŸÑŸÜŸÅÿßŸäÿßÿ™ ŸÅŸä ŸÉŸäÿ≥ ÿ£ÿ≠ŸÖÿ±']
        };

        function activateEmergency(command) {
            currentCommand = command;
            commandStartTime = new Date(command.timestamp || Date.now());

            document.getElementById('safeScreen').classList.add('hidden');
            document.getElementById('emergencyScreen').classList.add('active');
            
            // ÿ™ŸÅÿπŸäŸÑ ÿ£ÿ∂Ÿàÿßÿ° ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿßŸÑŸàÿßŸÖÿ∂ÿ© üö®
            document.getElementById('emergencyLights').classList.add('active');

            const resp = String(command.responseType || '').toLowerCase().trim();
            const rt = String(command.reportType || '');
            const isDrill = command.isDrill === true || command.isDrill === 'true' || resp === 'drill' || rt.includes('ÿ™ŸÖÿ±ŸäŸÜ');
            let bodyClass = 'other';
            let iconHtml = '<i class="fas fa-exclamation-triangle"></i>';
            
            // ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° badge ÿßŸÑÿ™ŸÖÿ±ŸäŸÜ
            const drillBadge = document.getElementById('drillBadge');
            if (isDrill) {
                drillBadge.style.display = 'block';
                bodyClass = 'drill';
                iconHtml = '<i class="fas fa-clipboard-check"></i>';
                document.getElementById('emergencyTitle').textContent = 'ÿ™ŸÖÿ±ŸäŸÜ ÿ∑Ÿàÿßÿ±ÿ¶';
            } else {
                drillBadge.style.display = 'none';
            }

            // ÿßŸÑŸÖŸàŸÇÿπ ŸàŸÜŸÇÿ∑ÿ© ÿßŸÑÿ™ÿ¨ŸÖÿπ
            const loc = command.location || '-';
            const muster = command.muster || command.musterPoint || '';

            // ÿßŸÑŸÑŸàŸÜ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ£ŸÖÿ± (responseType) ÿ£ŸàŸÑÿßŸã
            if (resp.includes('full_evacuation') || resp.includes('ÿ•ÿÆŸÑÿßÿ°') || resp.includes('ÿßÿÆŸÑÿßÿ°')) {
                bodyClass = 'fire'; // ÿ£ÿ≠ŸÖÿ± ŸÑŸÑÿ•ÿÆŸÑÿßÿ°
                document.getElementById('emergencyTitle').textContent = 'ÿ£ŸÖÿ± ÿ•ÿÆŸÑÿßÿ°';
                // ÿπÿ±ÿ∂: "ÿ•ÿÆŸÑÿßÿ° ŸÅŸàÿ±Ÿä - ÿßŸÑŸÖŸàŸÇÿπ"
                document.getElementById('instructionTitle').textContent = 'ÿ•ÿÆŸÑÿßÿ° ŸÅŸàÿ±Ÿä - ' + loc;
                iconHtml = '<i class="fas fa-running"></i>';
            } else if (resp.includes('send_team') || resp.includes('ÿ™Ÿàÿ¨ŸäŸá') || resp.includes('ÿ™Ÿàÿ¨Ÿá')) {
                bodyClass = 'injury'; // ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ŸÑŸÑÿ™Ÿàÿ¨ŸäŸá
                document.getElementById('emergencyTitle').textContent = 'ÿ£ŸÖÿ± ÿ™Ÿàÿ¨ŸäŸá';
                document.getElementById('instructionTitle').textContent = 'ÿ™Ÿàÿ¨ŸäŸá ŸÅÿ±ŸäŸÇ - ' + loc;
                iconHtml = '<i class="fas fa-user-shield"></i>';
            } else if (resp.includes('isolation_evacuation') || resp.includes('ÿπÿ≤ŸÑ')) {
                bodyClass = 'infection'; // ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä ŸÑŸÑÿπÿ≤ŸÑ
                document.getElementById('emergencyTitle').textContent = 'ÿ£ŸÖÿ± ÿπÿ≤ŸÑ';
                document.getElementById('instructionTitle').textContent = 'ÿπÿ≤ŸÑ ŸÅŸàÿ±Ÿä - ' + loc;
                iconHtml = '<i class="fas fa-virus"></i>';
            } else {
                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ responseTypeÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ reportType ŸÑŸÑŸàŸÜ
                if (rt.includes('ÿ≠ÿ±ŸäŸÇ') || rt.includes('ÿØÿÆÿßŸÜ')) {
                    bodyClass = 'fire';
                    iconHtml = '<i class="fas fa-fire"></i>';
                } else if (rt.includes('ÿ•ÿ∫ŸÖÿßÿ°') || rt.includes('ÿ•ÿµÿßÿ®ÿ©')) {
                    bodyClass = 'injury';
                    iconHtml = '<i class="fas fa-user-injured"></i>';
                } else if (rt.includes('ÿπÿØŸàŸâ')) {
                    bodyClass = 'infection';
                    iconHtml = '<i class="fas fa-virus"></i>';
                } else if (rt.includes('ŸÉŸáÿ±ÿ®ÿßÿ°')) {
                    bodyClass = 'power';
                    iconHtml = '<i class="fas fa-bolt"></i>';
                } else if (rt.includes('ŸÖŸäÿßŸá') || rt.includes('ÿ™ÿ≥ÿ±ÿ®')) {
                    bodyClass = 'water';
                    iconHtml = '<i class="fas fa-water"></i>';
                }
                document.getElementById('emergencyTitle').textContent = 'ÿ™ŸÜÿ®ŸäŸá ÿ∑Ÿàÿßÿ±ÿ¶';
                document.getElementById('instructionTitle').textContent = 'ÿßŸÑÿ™Ÿàÿ¨ŸäŸáÿßÿ™ - ' + loc;
            }

            document.body.className = bodyClass;
            document.getElementById('emergencyIcon').innerHTML = iconHtml;
            document.getElementById('emergencyType').textContent = command.reportType || 'ÿ∑Ÿàÿßÿ±ÿ¶';
            
            // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑŸÖŸÜŸÅÿµŸÑ (ÿ£ÿµÿ®ÿ≠ ŸÖÿØŸÖŸàÿ¨ ŸÖÿπ ÿßŸÑÿπŸÜŸàÿßŸÜ)
            document.getElementById('emergencyLocation').style.display = 'none';

            // ÿπÿ±ÿ∂ ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ™ÿ¨ŸÖÿπ ŸÉŸÄ "ÿßŸÑÿ™Ÿàÿ¨Ÿá ÿ•ŸÑŸâ:"
            if (muster) {
                document.getElementById('musterSection').style.display = 'block';
                document.getElementById('musterPoint').textContent = muster;
            } else {
                document.getElementById('musterSection').style.display = 'none';
                document.getElementById('musterPoint').textContent = '-';
            }
            
            // ÿπÿ±ÿ∂ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™
            const stepsContainer = document.getElementById('stepsSummary');
            const stepsContent = document.getElementById('stepsContent');
            let steps = scenarioSteps[resp] || scenarioSteps[rt] || null;
            
            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÜÿµ
            if (!steps) {
                for (let key in scenarioSteps) {
                    if (rt.includes(key) || resp.includes(key)) {
                        steps = scenarioSteps[key];
                        break;
                    }
                }
            }
            
            if (steps && steps.length > 0) {
                stepsContent.innerHTML = steps.map((step, i) => `
                    <div class="step-item-mini">
                        <span class="step-num-mini">${i + 1}</span>
                        <span class="step-text-mini">${step}</span>
                    </div>
                `).join('');
                stepsContainer.style.display = 'block';
            } else {
                stepsContainer.style.display = 'none';
            }

            // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ£ŸÖÿ±
            if (!isDrill) {
                // ÿ•ŸäŸÇÿßŸÅ ÿ£Ÿä ÿµŸàÿ™ ÿ≥ÿßÿ®ŸÇ ÿ£ŸàŸÑÿßŸã
                stopAllSounds();
                
                if (resp.includes('send_team') || resp.includes('ÿ™Ÿàÿ¨ŸäŸá')) {
                    // ÿ£ŸÖÿ± ÿ™Ÿàÿ¨ŸäŸá: ŸÜÿ®ÿ∂ÿßÿ™ ŸÇŸÑÿ® üíì
                    startHeartbeat();
                } else if (resp.includes('isolation') || resp.includes('ÿπÿ≤ŸÑ') || rt.includes('ÿπÿØŸàŸâ')) {
                    // ÿπÿ≤ŸÑ/ÿπÿØŸàŸâ: ÿµŸàÿ™ ÿ™ŸÜÿ®ŸäŸá ŸÖÿ™ŸÇÿ∑ÿπ üîä
                    startIsolationAlert();
                } else {
                    // ÿ•ÿÆŸÑÿßÿ°/ÿ≠ÿ±ŸäŸÇ: ÿµŸÅÿßÿ±ÿ© ÿ•ŸÜÿ∞ÿßÿ± üö®
                    startSiren();
                }
            }
            startTimer();
        }

        function deactivateEmergency() {
            currentCommand = null;
            document.getElementById('safeScreen').classList.remove('hidden');
            document.getElementById('emergencyScreen').classList.remove('active');
            
            // ÿ•ŸäŸÇÿßŸÅ ÿ£ÿ∂Ÿàÿßÿ° ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶ ÿßŸÑŸàÿßŸÖÿ∂ÿ©
            document.getElementById('emergencyLights').classList.remove('active');
            document.body.className = 'safe';
            stopAllSounds();
            stopSpeaking();
            hideSoundGate();
            document.getElementById('musterSection').style.display = 'none';
            document.getElementById('musterPoint').textContent = '-';
            stopTimer();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!commandStartTime) return;
                const diff = Math.floor((Date.now() - commandStartTime.getTime()) / 1000);
                const mins = Math.floor(diff / 60).toString().padStart(2, '0');
                const secs = (diff % 60).toString().padStart(2, '0');
                document.getElementById('elapsedTime').textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('elapsedTime').textContent = '00:00';
        }

        // ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿ™ÿ®ÿØÿ£ ŸÅŸÇÿ∑ ÿ®ÿπÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± "ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©"
    </script>
</body>
</html>
