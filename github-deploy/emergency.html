<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ - Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background 0.5s ease;
            color: #fff;
        }
        
        body.safe {
            background: linear-gradient(135deg, #166534 0%, #14532d 50%, #052e16 100%);
        }
        
        body.fire {
            background: linear-gradient(135deg, #DC143C, #7f1d1d);
            animation: emergencyPulse 0.5s ease-in-out infinite alternate;
        }
        
        body.injury {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        body.infection {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        }
        
        body.power {
            background: linear-gradient(135deg, #eab308, #ca8a04);
        }
        
        body.water {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
        }
        
        body.other {
            background: linear-gradient(135deg, #475569, #334155);
        }
        
        @keyframes emergencyPulse {
            0% { filter: brightness(1); }
            100% { filter: brightness(0.8); }
        }
        
        .container {
            text-align: center;
            padding: 10px;
            width: 100%;
            max-width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }
        
        .safe-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .safe-screen.hidden {
            display: none;
        }
        
        .logo-container {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: logoPulse 3s ease-in-out infinite;
            border: 2px solid rgba(201, 169, 98, 0.5);
            overflow: hidden;
        }
        
        .logo-container img {
            width: 70px;
            height: auto;
        }
        
        .logo-fallback {
            display: none;
        }
        
        @keyframes logoPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 30px rgba(201, 169, 98, 0.3);
            }
            50% { 
                transform: scale(1.03); 
                box-shadow: 0 0 50px rgba(201, 169, 98, 0.5);
            }
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(34, 197, 94, 0.2);
            padding: 10px 25px;
            border-radius: 50px;
            border: 2px solid rgba(34, 197, 94, 0.5);
        }
        
        .status-badge i {
            font-size: 1.8rem;
            color: #22c55e;
            animation: checkPulse 2s ease-in-out infinite;
        }
        
        .status-badge span {
            font-size: 1.8rem;
            font-weight: 900;
            color: #22c55e;
        }
        
        @keyframes checkPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .clinic-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #c9a962;
            margin-top: 5px;
        }
        
        .current-time {
            font-size: 2.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .date-display {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 3px;
        }
        
        .emergency-screen {
            display: none;
        }
        
        .emergency-screen.active {
            display: block;
        }
        
        /* Badge ØªÙ…Ø±ÙŠÙ† */
        .drill-badge {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 10px;
            animation: drillPulse 1.5s infinite;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
        }
        
        @keyframes drillPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.6); }
            50% { box-shadow: 0 0 50px rgba(34, 197, 94, 0.9); }
        }
        
        body.drill {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            animation: none !important;
        }
        
        /* Ù…Ù„Ø®Øµ Ø§Ù„Ø®Ø·ÙˆØ§Øª */
        .steps-summary {
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 12px;
            margin: 10px 0;
            text-align: right;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .steps-summary h3 {
            color: #fbbf24;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .step-item-mini {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .step-item-mini:last-child {
            border-bottom: none;
        }
        
        .step-num-mini {
            background: #fbbf24;
            color: #000;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .step-text-mini {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .emergency-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 8px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .emergency-logo img {
            width: 40px;
            height: auto;
        }
        
        .emergency-icon {
            font-size: 4rem;
            animation: iconBlink 0.5s ease-in-out infinite alternate;
            margin-bottom: 5px;
        }
        
        @keyframes iconBlink {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .emergency-screen h1 {
            font-size: 2.2rem;
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 0 3px 15px rgba(0,0,0,0.5);
            animation: textBlink 0.6s ease-in-out infinite alternate;
        }
        
        @keyframes textBlink {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .emergency-type {
            font-size: 1.4rem;
            background: rgba(0,0,0,0.5);
            padding: 8px 25px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .instruction-box {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 15px;
            margin: 8px 0;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .instruction-box h2 {
            font-size: 1.2rem;
            margin-bottom: 5px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .instruction-box .location {
            font-size: 1.8rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 3px 10px rgba(0,0,0,0.5);
        }
        
        .muster-point {
            background: rgba(34,197,94,0.3);
            padding: 10px;
            border-radius: 12px;
            margin-top: 8px;
            border: 2px solid rgba(34,197,94,0.5);
        }
        
        .muster-point h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .muster-point .point-name {
            font-size: 1.5rem;
            font-weight: 900;
            color: #86efac;
        }
        
        .timer {
            margin-top: 8px;
            font-size: 1rem;
        }
        
        .timer .time-display {
            font-size: 2rem;
            font-weight: 900;
            font-family: monospace;
        }
        
        .emergency-numbers {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .emergency-number {
            background: rgba(0,0,0,0.4);
            padding: 6px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .emergency-number i {
            font-size: 0.9rem;
        }
        
        .emergency-number span {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .footer {
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.7;
            background: rgba(0,0,0,0.2);
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .logo-container {
                width: 120px;
                height: 120px;
            }
            
            .logo-container img {
                width: 90px;
            }
            
            .status-badge {
                padding: 10px 25px;
            }
            
            .status-badge i {
                font-size: 1.8rem;
            }
            
            .status-badge span {
                font-size: 1.8rem;
            }
            
            .clinic-name {
                font-size: 1.4rem;
            }
            
            .current-time {
                font-size: 3rem;
            }
            
            .emergency-screen h1 {
                font-size: 2.5rem;
            }
            
            .emergency-type {
                font-size: 1.5rem;
                padding: 12px 25px;
            }
            
            .instruction-box .location {
                font-size: 2rem;
            }
            
            .emergency-icon {
                font-size: 5rem;
            }
            
            .timer .time-display {
                font-size: 3rem;
            }
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        .start-screen {
          position: fixed;
          inset: 0;
          background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          text-align: center;
          padding: 20px;
        }
        .start-screen.hidden { display: none; }
        
        .start-logo {
          width: 120px;
          height: 120px;
          background: rgba(255,255,255,0.1);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 25px;
          border: 3px solid rgba(201, 169, 98, 0.5);
        }
        .start-logo img {
          width: 80px;
          height: auto;
        }
        
        .start-title {
          font-size: 1.8rem;
          font-weight: 900;
          color: #c9a962;
          margin-bottom: 10px;
        }
        
        .start-subtitle {
          font-size: 1.1rem;
          color: rgba(255,255,255,0.8);
          margin-bottom: 30px;
          line-height: 1.6;
        }
        
        .start-btn {
          background: linear-gradient(135deg, #22c55e, #16a34a);
          color: #fff;
          border: none;
          padding: 20px 50px;
          font-size: 1.4rem;
          font-weight: 900;
          border-radius: 60px;
          cursor: pointer;
          box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4);
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .start-btn:hover {
          transform: scale(1.05);
          box-shadow: 0 12px 40px rgba(34, 197, 94, 0.5);
        }
        .start-btn i {
          margin-left: 10px;
        }
        
        .start-note {
          margin-top: 25px;
          font-size: 0.9rem;
          color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body class="safe">
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div class="start-screen" id="startScreen">
      <div class="start-logo">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹">
      </div>
      <div class="start-title">Ù†Ø¸Ø§Ù… Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</div>
      <div class="start-subtitle">
        Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©<br>
        Ø³ÙŠØµØ¯Ø± ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø£ÙŠ Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦
      </div>
      <button class="start-btn" id="startBtn">
        <i class="fas fa-bell"></i>
        Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
      </button>
      <div class="start-note">Ø§ØªØ±Ùƒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø©</div>
    </div>
    <div class="container">
        <div class="safe-screen" id="safeScreen">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹" id="logoImg">
            </div>
            
            <div class="status-badge">
                <i class="fas fa-shield-check"></i>
                <span>Ø§Ù„ÙˆØ¶Ø¹ Ø¢Ù…Ù†</span>
            </div>
            
            <div class="clinic-name">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</div>
            
            <div class="current-time" id="currentTime">--:--</div>
            <div class="date-display" id="currentDate">--</div>
        </div>
        
        <div class="emergency-screen" id="emergencyScreen">
            <div class="emergency-logo">
                <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¬Ù…Ø¹">
            </div>
            <div class="drill-badge" id="drillBadge" style="display: none;">
                ğŸ¯ ØªÙ…Ø±ÙŠÙ† - DRILL
            </div>
            <div class="emergency-icon" id="emergencyIcon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h1 id="emergencyTitle">ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦</h1>
            <div class="emergency-type" id="emergencyType">-</div>
            
            <div class="instruction-box">
                <h2 id="instructionTitle">Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª:</h2>
                <div class="location" id="emergencyLocation">-</div>
            </div>
            
            <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø®Ø·ÙˆØ§Øª -->
            <div class="steps-summary" id="stepsSummary" style="display: none;">
                <h3><i class="fas fa-list-ol"></i> Ø§Ù„Ø®Ø·ÙˆØ§Øª:</h3>
                <div id="stepsContent"></div>
            </div>
            
            <div class="muster-point" id="musterSection" style="display: none;">
                <h3><i class="fas fa-map-marker-alt"></i> Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¬Ù…Ø¹:</h3>
                <div class="point-name" id="musterPoint">-</div>
            </div>
            
            <div class="timer">
                <span>Ø§Ù„ÙˆÙ‚Øª Ù…Ù†Ø° Ø§Ù„Ø¨Ù„Ø§Øº:</span>
                <span class="time-display" id="elapsedTime">00:00</span>
            </div>
            
            <div class="emergency-numbers" id="emergencyNumbers">
                <div class="emergency-number">
                    <i class="fas fa-phone"></i>
                    <span>911</span>
                </div>
                <div class="emergency-number">
                    <i class="fas fa-fire-extinguisher"></i>
                    <span>998</span>
                </div>
                <div class="emergency-number">
                    <i class="fas fa-ambulance"></i>
                    <span>997</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø± - Ù†Ø¸Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
    </div>

    <!-- Ø²Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„) -->
    <div id="soundGate" class="sound-gate hidden">
      <button id="enableSoundBtn" class="sound-btn">
        <i class="fas fa-volume-up"></i> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª
      </button>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbztSmY_O_ITwKYXVNzs2wH8Wsid05XEZ5bEG6KJf4453dlFE8JHG_zRmuJbOksa6UgogQ/exec';

        let currentCommand = null;
        let sirenInterval = null;
        let timerInterval = null;
        let commandStartTime = null;

        // Web Audio API Siren System
        let audioCtx = null;
        let sirenOsc1 = null;
        let sirenOsc2 = null;
        let sirenGain = null;
        let sirenPlaying = false;

        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function startSiren() {
            try {
                initAudioContext();
                if (sirenPlaying) return;
                sirenPlaying = true;

                sirenGain = audioCtx.createGain();
                sirenGain.gain.value = 0.6;
                sirenGain.connect(audioCtx.destination);

                sirenOsc1 = audioCtx.createOscillator();
                sirenOsc1.type = 'sawtooth';
                sirenOsc1.frequency.value = 600;
                sirenOsc1.connect(sirenGain);
                sirenOsc1.start();

                sirenOsc2 = audioCtx.createOscillator();
                sirenOsc2.type = 'square';
                sirenOsc2.frequency.value = 800;
                sirenOsc2.connect(sirenGain);
                sirenOsc2.start();

                let ascending = true;
                sirenInterval = setInterval(() => {
                    if (!sirenOsc1 || !sirenOsc2) return;
                    const now = audioCtx.currentTime;
                    if (ascending) {
                        sirenOsc1.frequency.linearRampToValueAtTime(1200, now + 0.5);
                        sirenOsc2.frequency.linearRampToValueAtTime(1400, now + 0.5);
                    } else {
                        sirenOsc1.frequency.linearRampToValueAtTime(400, now + 0.5);
                        sirenOsc2.frequency.linearRampToValueAtTime(600, now + 0.5);
                    }
                    ascending = !ascending;
                }, 500);

            } catch(e) {
                console.error('Siren error:', e);
                showSoundGate();
            }
        }

        function stopSiren() {
            sirenPlaying = false;
            if (sirenInterval) {
                clearInterval(sirenInterval);
                sirenInterval = null;
            }
            try {
                if (sirenOsc1) { sirenOsc1.stop(); sirenOsc1.disconnect(); sirenOsc1 = null; }
                if (sirenOsc2) { sirenOsc2.stop(); sirenOsc2.disconnect(); sirenOsc2 = null; }
                if (sirenGain) { sirenGain.disconnect(); sirenGain = null; }
            } catch(e) {}
        }

        function isTrue(v){
          const s = String(v).toLowerCase().trim();
          return v === true || s === 'true' || s === 'yes' || s === '1';
        }

        let audioUnlocked = false;

        function showSoundGate(){
          const g = document.getElementById('soundGate');
          if (g) g.classList.remove('hidden');
        }
        function hideSoundGate(){
          const g = document.getElementById('soundGate');
          if (g) g.classList.add('hidden');
        }

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø£ÙŠ Ù†Ù‚Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
        function unlockAudioOnInteraction() {
          if (audioUnlocked) return;
          try {
            initAudioContext();
            audioUnlocked = true;
            hideSoundGate();
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ù†Ø°Ø§Ø± Ù†Ø´Ø·ØŒ Ø´ØºÙ„ Ø§Ù„ØµÙˆØª ÙÙˆØ±Ø§Ù‹
            if (currentCommand && !sirenPlaying) {
              startSiren();
            }
            // Ø£Ø²Ù„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
            document.removeEventListener('click', unlockAudioOnInteraction);
            document.removeEventListener('touchstart', unlockAudioOnInteraction);
            document.removeEventListener('keydown', unlockAudioOnInteraction);
          } catch(e) {
            console.warn('Audio unlock failed:', e);
          }
        }

        // Ø§Ø³ØªÙ…Ø¹ Ù„Ø£ÙŠ ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('click', unlockAudioOnInteraction);
        document.addEventListener('touchstart', unlockAudioOnInteraction);
        document.addEventListener('keydown', unlockAudioOnInteraction);

        let monitoringStarted = false;

        function startMonitoring() {
          if (monitoringStarted) return;
          monitoringStarted = true;
          
          // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª
          try {
            initAudioContext();
            audioUnlocked = true;
          } catch(e) {}
          
          // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          const startScreen = document.getElementById('startScreen');
          if (startScreen) startScreen.classList.add('hidden');
          
          // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
          checkActiveCommand();
          setInterval(checkActiveCommand, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
          // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
          const startBtn = document.getElementById('startBtn');
          if (startBtn) startBtn.addEventListener('click', startMonitoring);
          
          // Ø²Ø± Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
          const soundBtn = document.getElementById('enableSoundBtn');
          if (soundBtn) soundBtn.addEventListener('click', unlockAudioOnInteraction);
        });

        function jsonp(action, params = {}) {
            return new Promise((resolve, reject) => {
                const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
                params.action = action;
                params.callback = cb;

                const s = document.createElement("script");
                s.src = WEB_APP_URL + "?" + new URLSearchParams(params).toString();

                window[cb] = (data) => { cleanup(); resolve(data); };
                s.onerror = () => { cleanup(); reject(new Error("jsonp failed")); };

                function cleanup() {
                    try { delete window[cb]; } catch(e) {}
                    if (s.parentNode) s.parentNode.removeChild(s);
                }
                document.body.appendChild(s);
            });
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            document.getElementById('currentDate').textContent =
                now.toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        async function checkActiveCommand() {
            try {
                const data = await jsonp('getActiveCommand', {});
                const cmd = data && data.ok ? data.command : null;

                if (cmd && isTrue(cmd.active)) {
                    if (!currentCommand || currentCommand.timestamp !== cmd.timestamp) {
                        activateEmergency(cmd);
                    }
                } else {
                    if (currentCommand) deactivateEmergency();
                }
            } catch (e) {
                console.error('checkActiveCommand:', e);
            }
        }

        // Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø·ÙˆØ§Ø±Ø¦
        const scenarioSteps = {
            'fire': ['Ø£Ù†Ù‚Ø° Ø£ÙŠ Ø´Ø®Øµ ÙÙŠ Ø®Ø·Ø±', 'Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ÙˆØ£Ø¨Ù„Øº 998', 'Ø£ØºÙ„Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®Ø§Ù†', 'Ø£Ø®Ù„Ù Ø§Ù„Ù…Ø¨Ù†Ù‰ ÙÙˆØ±Ø§Ù‹', 'Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ¹Ø¯!'],
            'Ø­Ø±ÙŠÙ‚': ['Ø£Ù†Ù‚Ø° Ø£ÙŠ Ø´Ø®Øµ ÙÙŠ Ø®Ø·Ø±', 'Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ÙˆØ£Ø¨Ù„Øº 998', 'Ø£ØºÙ„Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®Ø§Ù†', 'Ø£Ø®Ù„Ù Ø§Ù„Ù…Ø¨Ù†Ù‰ ÙÙˆØ±Ø§Ù‹', 'Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ¹Ø¯!'],
            'power': ['ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ„Ø¯', 'ØªØ­Ù‚Ù‚ Ù…Ù† UPS ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø©', 'Ø·Ù…Ø¦Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰', 'Ø£Ø¨Ù„Øº ÙØ±ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù†Ø©'],
            'ÙƒÙ‡Ø±Ø¨Ø§Ø¡': ['ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ„Ø¯', 'ØªØ­Ù‚Ù‚ Ù…Ù† UPS ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø©', 'Ø·Ù…Ø¦Ù† Ø§Ù„Ù…Ø±Ø¶Ù‰', 'Ø£Ø¨Ù„Øº ÙØ±ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù†Ø©'],
            'water': ['Ø£ØºÙ„Ù‚ Ù…Ø­Ø¨Ø³ Ø§Ù„Ù…ÙŠØ§Ù‡', 'Ø£Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', 'Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ­Ø°ÙŠØ±ÙŠØ©', 'Ø£Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©'],
            'Ù…ÙŠØ§Ù‡': ['Ø£ØºÙ„Ù‚ Ù…Ø­Ø¨Ø³ Ø§Ù„Ù…ÙŠØ§Ù‡', 'Ø£Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', 'Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ­Ø°ÙŠØ±ÙŠØ©', 'Ø£Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø©'],
            'injury': ['ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØ§Ù†', 'Ø§ÙØ­Øµ Ø§Ù„ÙˆØ¹ÙŠ ÙˆØ§Ù„ØªÙ†ÙØ³', 'Ø§ØªØµÙ„ Ø¨Ù€ 997', 'Ù‚Ø¯Ù… Ø§Ù„Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©'],
            'Ø¥ØºÙ…Ø§Ø¡': ['ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØ§Ù†', 'Ø§ÙØ­Øµ Ø§Ù„ÙˆØ¹ÙŠ ÙˆØ§Ù„ØªÙ†ÙØ³', 'Ø§ØªØµÙ„ Ø¨Ù€ 997', 'Ù‚Ø¯Ù… Ø§Ù„Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©'],
            'Ø¥ØµØ§Ø¨Ø©': ['ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØ§Ù†', 'Ø§ÙØ­Øµ Ø§Ù„ÙˆØ¹ÙŠ ÙˆØ§Ù„ØªÙ†ÙØ³', 'Ø§ØªØµÙ„ Ø¨Ù€ 997', 'Ù‚Ø¯Ù… Ø§Ù„Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©'],
            'infection': ['Ø§Ø¹Ø²Ù„ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹', 'Ø§Ø±ØªØ¯Ù Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©', 'Ø£Ø¨Ù„Øº Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰', 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø§Ù„Ø·ÙŠÙ†'],
            'Ø¹Ø¯ÙˆÙ‰': ['Ø§Ø¹Ø²Ù„ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹', 'Ø§Ø±ØªØ¯Ù Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©', 'Ø£Ø¨Ù„Øº Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø¹Ø¯ÙˆÙ‰', 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø§Ù„Ø·ÙŠÙ†']
        };

        function activateEmergency(command) {
            currentCommand = command;
            commandStartTime = new Date(command.timestamp || Date.now());

            document.getElementById('safeScreen').classList.add('hidden');
            document.getElementById('emergencyScreen').classList.add('active');

            const resp = String(command.responseType || '').toLowerCase().trim();
            const rt = String(command.reportType || '');
            const isDrill = command.isDrill === true || command.isDrill === 'true' || resp === 'drill' || rt.includes('ØªÙ…Ø±ÙŠÙ†');
            let bodyClass = 'other';
            let iconHtml = '<i class="fas fa-exclamation-triangle"></i>';
            
            // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ badge Ø§Ù„ØªÙ…Ø±ÙŠÙ†
            const drillBadge = document.getElementById('drillBadge');
            if (isDrill) {
                drillBadge.style.display = 'block';
                bodyClass = 'drill';
                iconHtml = '<i class="fas fa-clipboard-check"></i>';
                document.getElementById('emergencyTitle').textContent = 'ØªÙ…Ø±ÙŠÙ† Ø·ÙˆØ§Ø±Ø¦';
            } else {
                drillBadge.style.display = 'none';
            }

            // Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù…Ø± (responseType) Ø£ÙˆÙ„Ø§Ù‹
            if (resp.includes('full_evacuation') || resp.includes('Ø¥Ø®Ù„Ø§Ø¡') || resp.includes('Ø§Ø®Ù„Ø§Ø¡')) {
                bodyClass = 'fire'; // Ø£Ø­Ù…Ø± Ù„Ù„Ø¥Ø®Ù„Ø§Ø¡
                document.getElementById('emergencyTitle').textContent = 'Ø£Ù…Ø± Ø¥Ø®Ù„Ø§Ø¡';
                document.getElementById('instructionTitle').textContent = 'Ø¥Ø®Ù„Ø§Ø¡ ÙÙˆØ±ÙŠ - Ø§ØªØ¬Ù‡ Ø¥Ù„Ù‰:';
                iconHtml = '<i class="fas fa-running"></i>';
            } else if (resp.includes('send_team') || resp.includes('ØªÙˆØ¬ÙŠÙ‡') || resp.includes('ØªÙˆØ¬Ù‡')) {
                bodyClass = 'injury'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„ØªÙˆØ¬ÙŠÙ‡
                document.getElementById('emergencyTitle').textContent = 'Ø£Ù…Ø± ØªÙˆØ¬ÙŠÙ‡';
                document.getElementById('instructionTitle').textContent = 'Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª:';
                iconHtml = '<i class="fas fa-user-shield"></i>';
            } else if (resp.includes('isolation_evacuation') || resp.includes('Ø¹Ø²Ù„')) {
                bodyClass = 'infection'; // Ø¨Ù†ÙØ³Ø¬ÙŠ Ù„Ù„Ø¹Ø²Ù„
                document.getElementById('emergencyTitle').textContent = 'Ø£Ù…Ø± Ø¹Ø²Ù„';
                document.getElementById('instructionTitle').textContent = 'Ø¹Ø²Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙˆØ±Ù‹Ø§ - Ø§Ù„Ù…ÙˆÙ‚Ø¹:';
                iconHtml = '<i class="fas fa-virus"></i>';
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ responseTypeØŒ Ù†Ø³ØªØ®Ø¯Ù… reportType Ù„Ù„ÙˆÙ†
                if (rt.includes('Ø­Ø±ÙŠÙ‚') || rt.includes('Ø¯Ø®Ø§Ù†')) {
                    bodyClass = 'fire';
                    iconHtml = '<i class="fas fa-fire"></i>';
                } else if (rt.includes('Ø¥ØºÙ…Ø§Ø¡') || rt.includes('Ø¥ØµØ§Ø¨Ø©')) {
                    bodyClass = 'injury';
                    iconHtml = '<i class="fas fa-user-injured"></i>';
                } else if (rt.includes('Ø¹Ø¯ÙˆÙ‰')) {
                    bodyClass = 'infection';
                    iconHtml = '<i class="fas fa-virus"></i>';
                } else if (rt.includes('ÙƒÙ‡Ø±Ø¨Ø§Ø¡')) {
                    bodyClass = 'power';
                    iconHtml = '<i class="fas fa-bolt"></i>';
                } else if (rt.includes('Ù…ÙŠØ§Ù‡') || rt.includes('ØªØ³Ø±Ø¨')) {
                    bodyClass = 'water';
                    iconHtml = '<i class="fas fa-water"></i>';
                }
                document.getElementById('emergencyTitle').textContent = 'ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦';
                document.getElementById('instructionTitle').textContent = 'Ø§Ù„ØªÙˆØ¬ÙŠÙ‡Ø§Øª:';
            }

            document.body.className = bodyClass;
            document.getElementById('emergencyIcon').innerHTML = iconHtml;
            document.getElementById('emergencyType').textContent = command.reportType || 'Ø·ÙˆØ§Ø±Ø¦';
            document.getElementById('emergencyLocation').textContent = command.location || '-';

            if (command.muster || command.musterPoint) {
                document.getElementById('musterSection').style.display = 'block';
                document.getElementById('musterPoint').textContent = command.muster || command.musterPoint;
            } else {
                document.getElementById('musterSection').style.display = 'none';
                document.getElementById('musterPoint').textContent = '-';
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ§Øª
            const stepsContainer = document.getElementById('stepsSummary');
            const stepsContent = document.getElementById('stepsContent');
            let steps = scenarioSteps[resp] || scenarioSteps[rt] || null;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†Øµ
            if (!steps) {
                for (let key in scenarioSteps) {
                    if (rt.includes(key) || resp.includes(key)) {
                        steps = scenarioSteps[key];
                        break;
                    }
                }
            }
            
            if (steps && steps.length > 0) {
                stepsContent.innerHTML = steps.map((step, i) => `
                    <div class="step-item-mini">
                        <span class="step-num-mini">${i + 1}</span>
                        <span class="step-text-mini">${step}</span>
                    </div>
                `).join('');
                stepsContainer.style.display = 'block';
            } else {
                stepsContainer.style.display = 'none';
            }

            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ØªÙ…Ø±ÙŠÙ†
            if (!isDrill) {
                startSiren();
            }
            startTimer();
        }

        function deactivateEmergency() {
            currentCommand = null;
            document.getElementById('safeScreen').classList.remove('hidden');
            document.getElementById('emergencyScreen').classList.remove('active');
            document.body.className = 'safe';
            stopSiren();
            hideSoundGate();
            document.getElementById('musterSection').style.display = 'none';
            document.getElementById('musterPoint').textContent = '-';
            stopTimer();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!commandStartTime) return;
                const diff = Math.floor((Date.now() - commandStartTime.getTime()) / 1000);
                const mins = Math.floor(diff / 60).toString().padStart(2, '0');
                const secs = (diff % 60).toString().padStart(2, '0');
                document.getElementById('elapsedTime').textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('elapsedTime').textContent = '00:00';
        }

        // Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ¨Ø¯Ø£ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©"
    </script>
</body>
</html>
