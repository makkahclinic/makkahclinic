<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مركز القيادة والتحكم - EOC | مجمع مكة الطبي</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e3a5f;
            --secondary: #c9a962;
            --danger: #DC143C;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
            min-height: 100vh;
            color: #fff;
        }

        .header {
            background: rgba(30, 58, 95, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--secondary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title img {
            height: 50px;
        }

        .header-title h1 {
            font-size: 1.5rem;
            color: #fff;
        }

        .header-title h1 span {
            color: var(--secondary);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-normal {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .status-alert {
            background: rgba(220, 20, 60, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: var(--secondary);
            color: var(--primary);
        }

        .report-emergency-btn {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s;
            animation: pulse-btn 2s infinite;
        }

        .report-emergency-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(220, 20, 60, 0.4);
        }

        @keyframes pulse-btn {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(220, 20, 60, 0); }
        }

        .main-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .building-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            order: 2;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--secondary);
        }

        .building-view {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .floor {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .floor:hover {
            border-color: var(--secondary);
            transform: translateX(-5px);
        }

        .floor.active {
            border-color: var(--secondary);
            background: rgba(201, 169, 98, 0.1);
        }

        .floor.evacuating {
            border-color: var(--danger);
            background: rgba(220, 20, 60, 0.15);
            animation: floorPulse 1s infinite;
        }

        @keyframes floorPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(220, 20, 60, 0.2); }
        }

        .floor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .floor-name {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .floor-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .floor-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .floor-status.safe {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .floor-status.evacuating {
            background: rgba(220, 20, 60, 0.2);
            color: var(--danger);
        }

        .departments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
        }

        .dept-card {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .dept-card:hover {
            background: rgba(201, 169, 98, 0.2);
            border-color: var(--secondary);
        }

        .dept-card.selected {
            background: var(--secondary);
            color: var(--primary);
            font-weight: 600;
        }

        .dept-card i {
            display: block;
            font-size: 1.3rem;
            margin-bottom: 5px;
            color: var(--secondary);
        }

        .dept-card.selected i {
            color: var(--primary);
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            order: 1;
        }

        .panel-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .emergency-scenarios {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .scenario-btn {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .scenario-btn:hover {
            transform: scale(1.02);
        }

        .scenario-btn i {
            font-size: 2rem;
            display: block;
            margin-bottom: 8px;
        }

        .scenario-btn.fire { border-color: #ef4444; }
        .scenario-btn.fire:hover, .scenario-btn.fire.active { background: rgba(239, 68, 68, 0.2); }
        .scenario-btn.fire i { color: #ef4444; }

        .scenario-btn.power { border-color: #f59e0b; }
        .scenario-btn.power:hover, .scenario-btn.power.active { background: rgba(245, 158, 11, 0.2); }
        .scenario-btn.power i { color: #f59e0b; }

        .scenario-btn.outbreak { border-color: #8b5cf6; }
        .scenario-btn.outbreak:hover, .scenario-btn.outbreak.active { background: rgba(139, 92, 246, 0.2); }
        .scenario-btn.outbreak i { color: #8b5cf6; }

        .scenario-btn.evacuate { border-color: #3b82f6; }
        .scenario-btn.evacuate:hover, .scenario-btn.evacuate.active { background: rgba(59, 130, 246, 0.2); }
        .scenario-btn.evacuate i { color: #3b82f6; }

        .response-panel {
            display: none;
        }

        .response-panel.active {
            display: block;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .response-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-response {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .close-response:hover {
            opacity: 1;
        }

        .response-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .step-item {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border-right: 3px solid var(--secondary);
        }

        .step-number {
            background: var(--secondary);
            color: var(--primary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .step-content h4 {
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .step-content p {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .emergency-contacts {
            display: grid;
            gap: 8px;
        }

        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            border-radius: 8px;
        }

        .contact-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contact-info i {
            color: var(--secondary);
        }

        .contact-number {
            font-weight: 700;
            color: var(--secondary);
            font-size: 1.1rem;
            direction: ltr;
        }

        .activate-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: 'Tajawal', sans-serif;
        }

        .activate-btn.danger {
            background: linear-gradient(135deg, #DC143C 0%, #b91c1c 100%);
            color: #fff;
        }

        .activate-btn.danger:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(220, 20, 60, 0.4);
        }

        .activate-btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
        }

        .muster-points {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .muster-card {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .muster-card i {
            font-size: 1.5rem;
            color: var(--success);
            margin-bottom: 5px;
        }

        .muster-card h4 {
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .muster-card p {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .drill-log {
            max-height: 200px;
            overflow-y: auto;
        }

        .drill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .drill-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drill-date {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .reports-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .report-item {
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border-right: 3px solid var(--secondary);
        }

        .report-item.new {
            border-right-color: var(--danger);
            background: rgba(220, 20, 60, 0.1);
        }

        .report-item.pending {
            border-right-color: var(--warning);
        }

        .report-item.resolved {
            border-right-color: var(--success);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .report-type {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-type i {
            color: var(--danger);
        }

        .report-status {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .report-status.new {
            background: var(--danger);
            color: #fff;
        }

        .report-status.pending {
            background: var(--warning);
            color: #000;
        }

        .report-status.resolved {
            background: var(--success);
            color: #fff;
        }

        .report-location, .report-time {
            font-size: 0.85rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 5px;
        }

        .no-reports {
            text-align: center;
            padding: 30px;
            opacity: 0.7;
        }

        .no-reports i {
            font-size: 2rem;
            color: var(--success);
            margin-bottom: 10px;
        }

        .error-state {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.8);
        }

        .error-state i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .error-state small {
            display: block;
            margin-top: 5px;
        }
        
        /* Emergency Alert Popup */
        .new-report-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #DC143C, #b91c1c);
            color: #fff;
            padding: 30px 40px;
            border-radius: 20px;
            z-index: 10000;
            box-shadow: 0 0 50px rgba(220,20,60,0.8);
            animation: alertPulse 0.5s ease-in-out infinite alternate;
            text-align: center;
            min-width: 350px;
        }
        
        @keyframes alertPulse {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 50px rgba(220,20,60,0.8); }
            100% { transform: translate(-50%, -50%) scale(1.02); box-shadow: 0 0 80px rgba(220,20,60,1); }
        }
        
        .new-report-alert .alert-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .new-report-alert .alert-content > i {
            font-size: 3rem;
            animation: shake 0.3s ease-in-out infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        
        .new-report-alert strong {
            font-size: 1.5rem;
        }
        
        .new-report-alert p {
            font-size: 1.1rem;
            margin: 5px 0;
        }
        
        /* Emergency Location Highlight */
        .room-btn.emergency-highlight {
            background: linear-gradient(135deg, #DC143C, #ff4444) !important;
            color: #fff !important;
            animation: emergencyBlink 0.5s ease-in-out infinite alternate;
            border: 3px solid #fff !important;
            transform: scale(1.1);
            z-index: 100;
        }
        
        @keyframes emergencyBlink {
            0% { opacity: 1; box-shadow: 0 0 20px #DC143C; }
            100% { opacity: 0.7; box-shadow: 0 0 40px #ff0000; }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--info); }
        
        /* Action Buttons */
        .report-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .action-btn.respond {
            background: var(--warning);
            color: #000;
        }
        
        .action-btn.resolve {
            background: var(--success);
            color: #fff;
        }
        
        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .resolved-badge {
            color: var(--success);
            font-size: 0.85rem;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 30px;
        }
        
        .loading-spinner i {
            font-size: 2rem;
            color: var(--secondary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .report-notes {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* زر تفعيل الإخلاء */
        .activate-evacuation-btn {
            width: 100%;
            padding: 20px;
            margin-top: 20px;
            background: linear-gradient(135deg, #DC143C, #b91c1c);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(220,20,60,0.4);
        }
        
        .activate-evacuation-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 30px rgba(220,20,60,0.6);
        }
        
        /* نافذة تفعيل الإخلاء */
        .evacuation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .evacuation-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .evacuation-content {
            background: linear-gradient(135deg, #1e3a5f, #0f172a);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            margin: 20px;
            border: 2px solid var(--secondary);
        }
        
        .evacuation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .evacuation-header h2 {
            color: var(--danger);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .evac-step {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .evac-step h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--secondary);
        }
        
        .step-num {
            background: var(--secondary);
            color: var(--primary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .step-hint {
            opacity: 0.7;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .evac-type-grid, .floor-select-grid, .muster-select-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .floor-select-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .muster-select-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .evac-type-btn, .floor-select-btn, .muster-select-btn {
            padding: 18px 15px;
            background: rgba(30, 58, 95, 0.8);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .evac-type-btn:hover, .floor-select-btn:hover, .muster-select-btn:hover {
            background: rgba(201, 169, 98, 0.3);
            border-color: var(--secondary);
            transform: scale(1.03);
        }
        
        .evac-type-btn i {
            font-size: 1.8rem;
        }
        
        .floor-select-btn i {
            font-size: 1.3rem;
            opacity: 0.7;
        }
        
        /* تأثير اللمبة - عند التحديد */
        .evac-type-btn.selected, .floor-select-btn.selected, .muster-select-btn.selected {
            background: linear-gradient(135deg, var(--danger), #ff6b6b) !important;
            border-color: #fff !important;
            color: #fff !important;
            box-shadow: 0 0 25px rgba(220, 20, 60, 0.6), 0 0 50px rgba(220, 20, 60, 0.3);
            transform: scale(1.05);
            animation: glowPulse 1.5s ease-in-out infinite;
        }
        
        .evac-type-btn.selected i, .floor-select-btn.selected i {
            animation: iconBounce 0.5s ease;
        }
        
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 25px rgba(220, 20, 60, 0.6), 0 0 50px rgba(220, 20, 60, 0.3); }
            50% { box-shadow: 0 0 35px rgba(220, 20, 60, 0.8), 0 0 70px rgba(220, 20, 60, 0.4); }
        }
        
        @keyframes iconBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .floor-select-btn.danger {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(220, 20, 60, 0.15);
        }
        
        .floor-select-btn.danger:hover {
            background: rgba(220, 20, 60, 0.3);
        }
        
        .floor-select-btn.danger.selected {
            background: linear-gradient(135deg, var(--danger), #b91c1c) !important;
            color: #fff !important;
            box-shadow: 0 0 30px rgba(220, 20, 60, 0.7);
        }
        
        /* أزرار الاختيار السريع للأدوار */
        .quick-floor-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .quick-floor-btn {
            padding: 10px 15px;
            background: rgba(30, 58, 95, 0.8);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .quick-floor-btn:hover {
            background: rgba(201, 169, 98, 0.3);
            border-color: var(--secondary);
        }
        
        .quick-floor-btn.active {
            background: var(--secondary);
            border-color: var(--secondary);
            color: var(--primary);
            font-weight: 700;
        }
        
        /* شبكة التفعيل المبسط */
        .simple-evac-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .simple-evac-btn {
            padding: 25px 15px;
            background: rgba(30, 58, 95, 0.8);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            color: #fff;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .simple-evac-btn i {
            font-size: 2.5rem;
        }
        
        .simple-evac-btn.fire { border-color: #ef4444; }
        .simple-evac-btn.fire i { color: #ef4444; }
        .simple-evac-btn.fire:hover { background: rgba(239, 68, 68, 0.3); }
        
        .simple-evac-btn.power { border-color: #f59e0b; }
        .simple-evac-btn.power i { color: #f59e0b; }
        .simple-evac-btn.power:hover { background: rgba(245, 158, 11, 0.3); }
        
        .simple-evac-btn.water { border-color: #3b82f6; }
        .simple-evac-btn.water i { color: #3b82f6; }
        .simple-evac-btn.water:hover { background: rgba(59, 130, 246, 0.3); }
        
        .simple-evac-btn.injury { border-color: #dc2626; }
        .simple-evac-btn.injury i { color: #dc2626; }
        .simple-evac-btn.injury:hover { background: rgba(220, 38, 38, 0.3); }
        
        .simple-evac-btn.infection { border-color: #8b5cf6; }
        .simple-evac-btn.infection i { color: #8b5cf6; }
        .simple-evac-btn.infection:hover { background: rgba(139, 92, 246, 0.3); }
        
        .simple-evac-btn.drill { 
            border-color: #22c55e; 
            background: rgba(34, 197, 94, 0.1);
        }
        .simple-evac-btn.drill i { color: #22c55e; }
        .simple-evac-btn.drill:hover { background: rgba(34, 197, 94, 0.3); }
        
        @media (max-width: 600px) {
            .simple-evac-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* شبكة أقسام toggle */
        .dept-toggle-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .dept-group {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 12px;
        }
        
        .dept-group-title {
            color: var(--secondary);
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .dept-toggle-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .dept-toggle-btn {
            padding: 10px 16px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .dept-toggle-btn:hover {
            background: rgba(201, 169, 98, 0.2);
            border-color: var(--secondary);
            color: #fff;
            transform: scale(1.02);
        }
        
        /* تأثير اللمبة المضاءة */
        .dept-toggle-btn.active {
            background: linear-gradient(135deg, var(--danger), #ff6b6b);
            border-color: #fff;
            color: #fff;
            font-weight: 700;
            box-shadow: 0 0 15px rgba(220, 20, 60, 0.5), 0 0 30px rgba(220, 20, 60, 0.3);
            animation: btnGlow 1.5s ease-in-out infinite alternate;
        }
        
        .dept-toggle-btn.active::before {
            content: '✓';
            margin-left: 6px;
        }
        
        @keyframes btnGlow {
            0% { box-shadow: 0 0 15px rgba(220, 20, 60, 0.5), 0 0 30px rgba(220, 20, 60, 0.3); }
            100% { box-shadow: 0 0 20px rgba(220, 20, 60, 0.7), 0 0 40px rgba(220, 20, 60, 0.4); }
        }
        
        /* عداد المحدد */
        .selection-counter {
            margin-top: 15px;
            padding: 12px 20px;
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid var(--success);
            border-radius: 10px;
            color: var(--success);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
        }
        
        .selection-counter.has-selection {
            background: rgba(220, 20, 60, 0.15);
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .evacuation-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .cancel-btn {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            border-radius: 10px;
            font-size: 1.1rem;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
        }
        
        .activate-btn.danger {
            flex: 2;
            padding: 15px;
            background: linear-gradient(135deg, #DC143C, #b91c1c);
            border: none;
            color: #fff;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .activate-btn.danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* شاشة الإخلاء النشط */
        .active-evacuation-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #DC143C, #7f1d1d);
            z-index: 20000;
            overflow-y: auto;
        }
        
        .active-evacuation-screen.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .evac-screen-content {
            text-align: center;
            padding: 40px;
            max-width: 800px;
        }
        
        .evac-alert-icon {
            font-size: 5rem;
            animation: iconPulse 0.5s ease-in-out infinite alternate;
            margin-bottom: 20px;
        }
        
        @keyframes iconPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        .evac-screen-content h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: textBlink 0.8s ease-in-out infinite alternate;
        }
        
        @keyframes textBlink {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .evac-type-display {
            font-size: 2rem;
            background: rgba(0,0,0,0.3);
            padding: 15px 40px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 30px;
        }
        
        .evac-locations, .evac-muster {
            background: rgba(0,0,0,0.3);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .evac-locations h3, .evac-muster h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .locations-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .locations-list span {
            background: rgba(255,255,255,0.2);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 1.1rem;
        }
        
        .muster-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fef08a;
        }
        
        .evac-timer {
            font-size: 1.5rem;
            margin: 30px 0;
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: 700;
            font-family: monospace;
        }
        
        .end-evacuation-btn {
            padding: 20px 50px;
            background: #16a34a;
            border: none;
            color: #fff;
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            border-radius: 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        /* تحديد الأقسام للإخلاء - تأثير اللمبة */
        .dept-card.evac-selected {
            background: linear-gradient(135deg, var(--danger), #ff6b6b) !important;
            border: 3px solid #fff !important;
            color: #fff !important;
            transform: scale(1.08);
            animation: deptGlow 1s ease-in-out infinite alternate;
            box-shadow: 0 0 20px rgba(220, 20, 60, 0.7), 0 0 40px rgba(220, 20, 60, 0.4);
        }
        
        .dept-card.evac-selected::before {
            content: '✓';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid #fff;
            animation: checkPop 0.3s ease;
        }
        
        @keyframes deptGlow {
            0% { box-shadow: 0 0 20px rgba(220, 20, 60, 0.7), 0 0 40px rgba(220, 20, 60, 0.4); }
            100% { box-shadow: 0 0 30px rgba(220, 20, 60, 0.9), 0 0 60px rgba(220, 20, 60, 0.5); }
        }
        
        @keyframes checkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        @keyframes evacuatePulse {
            0% { box-shadow: 0 0 10px var(--danger); }
            100% { box-shadow: 0 0 25px var(--danger); }
        }
        
        /* نافذة اختيار الاستجابة */
        .response-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 15000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .response-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .response-modal-content {
            background: linear-gradient(135deg, #1e3a5f, #0f172a);
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            margin: 20px;
            border: 3px solid var(--danger);
            animation: modalPulse 1s ease-in-out infinite alternate;
        }
        
        @keyframes modalPulse {
            0% { box-shadow: 0 0 20px var(--danger); }
            100% { box-shadow: 0 0 40px var(--danger); }
        }
        
        .response-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .response-modal-header h2 {
            color: var(--danger);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: textBlink 0.5s ease-in-out infinite alternate;
        }
        
        .report-details-box {
            background: rgba(220,20,60,0.1);
            border: 1px solid var(--danger);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #94a3b8;
        }
        
        .detail-value {
            color: #fff;
            font-weight: 600;
        }
        
        .response-modal-content h3 {
            color: var(--secondary);
            margin: 20px 0 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .response-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .response-type-btn {
            padding: 20px 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
        }
        
        .response-type-btn i {
            font-size: 2rem;
        }
        
        .response-type-btn span {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .response-type-btn small {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        
        .response-type-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--secondary);
        }
        
        .response-type-btn.selected {
            background: var(--danger);
            border-color: var(--danger);
        }
        
        .response-type-btn[data-response="send_team"].selected {
            background: #f59e0b;
            border-color: #f59e0b;
        }
        
        .response-type-btn[data-response="isolation_evacuation"].selected {
            background: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        /* أزرار اختيار المواقع المتعددة */
        .location-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .location-btn {
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            color: #fff;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .location-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--secondary);
        }
        
        .location-btn.selected {
            background: rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
            color: #22c55e;
        }
        
        .location-btn i {
            font-size: 0.85rem;
        }
        
        /* أزرار نقاط التجمع */
        .muster-buttons-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .muster-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            color: #fff;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .muster-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--secondary);
        }
        
        .muster-btn.selected {
            background: rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
            color: #22c55e;
        }
        
        #responseTarget select, #responseTarget input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: #fff;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        .response-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .issue-command-btn {
            flex: 2;
            padding: 18px;
            background: linear-gradient(135deg, #DC143C, #b91c1c);
            border: none;
            color: #fff;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .issue-command-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* شاشة عرض الأمر المركزية */
        .command-display-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #DC143C, #7f1d1d);
            z-index: 25000;
            overflow-y: auto;
        }
        
        .command-display-screen.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .command-content {
            text-align: center;
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }
        
        .command-alert-icon {
            font-size: 6rem;
            animation: iconPulse 0.4s ease-in-out infinite alternate;
            margin-bottom: 20px;
        }
        
        .command-content h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            animation: textBlink 0.6s ease-in-out infinite alternate;
        }
        
        .command-type-badge {
            font-size: 2.5rem;
            background: rgba(0,0,0,0.4);
            padding: 20px 50px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 30px;
            font-weight: 700;
        }
        
        .command-info-box {
            background: rgba(0,0,0,0.3);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 25px;
        }
        
        .command-info-row {
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .command-muster-box {
            background: rgba(0,0,0,0.4);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 25px;
        }
        
        .command-muster-box h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .command-muster-box .muster-display {
            font-size: 2.2rem;
            font-weight: 700;
            color: #fef08a;
        }
        
        .command-timer {
            font-size: 1.8rem;
            margin: 35px 0;
        }
        
        .command-timer .timer-display {
            font-size: 4rem;
            font-weight: 700;
            font-family: monospace;
        }
        
        .end-command-btn {
            padding: 25px 60px;
            background: #16a34a;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            border-radius: 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .response-type-grid {
                grid-template-columns: 1fr;
            }
            
            .command-content h1 {
                font-size: 2rem;
            }
            
            .command-type-badge {
                font-size: 1.5rem;
                padding: 15px 30px;
            }
            
            .command-info-row {
                font-size: 1.3rem;
            }
        }

        .resolved-badge {
            color: var(--success);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .new-report-alert {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--danger), #b91c1c);
            color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(220, 20, 60, 0.4);
            z-index: 1000;
            animation: slideIn 0.3s ease-out, pulse 1s infinite;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-content i {
            font-size: 2rem;
        }

        .alert-content strong {
            display: block;
            font-size: 1.1rem;
        }

        .alert-content p {
            margin-top: 5px;
            opacity: 0.9;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: toastIn 0.3s ease-out;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .drill-result {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .drill-result.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .loading-spinner i {
            font-size: 2rem;
            color: var(--secondary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .departments-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .emergency-scenarios {
                grid-template-columns: 1fr;
            }
        }

        /* ===== Quick Actions (3 أيقونات) ===== */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .quick-action {
            background: rgba(255,255,255,0.06);
            border: 2px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 18px 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .quick-action:hover {
            transform: translateY(-3px);
            border-color: var(--secondary);
            box-shadow: 0 10px 30px rgba(201, 169, 98, 0.2);
        }
        
        .quick-action .qa-ico {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 12px;
        }
        
        .quick-action.training .qa-ico {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }
        
        .quick-action.training-log .qa-ico {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .quick-action.reports-log .qa-ico {
            background: linear-gradient(135deg, #DC143C, #b91c1c);
            box-shadow: 0 8px 25px rgba(220, 20, 60, 0.4);
        }
        
        .quick-action .qa-title {
            font-weight: 800;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .quick-action .qa-sub {
            opacity: 0.7;
            font-size: 0.8rem;
        }

        /* ===== Training Modal ===== */
        .training-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.92);
            z-index: 25000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .training-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .training-modal-content {
            background: linear-gradient(135deg, #1e3a5f, #0f172a);
            border-radius: 20px;
            padding: 25px;
            max-width: 1100px;
            width: 100%;
            margin: 20px;
            border: 2px solid var(--secondary);
        }
        
        .training-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .training-modal-header h2 {
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            flex-wrap: wrap;
        }
        
        .drill-badge {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            animation: pulse-badge 1.5s infinite;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
        }
        
        @keyframes pulse-badge {
            0%, 100% { box-shadow: 0 0 15px rgba(220, 38, 38, 0.5); }
            50% { box-shadow: 0 0 25px rgba(220, 38, 38, 0.8); }
        }
        
        .session-timer-display {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            padding: 10px 25px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #000;
            direction: ltr;
            font-family: monospace;
        }

        /* تعليمات التدريب - أصفر/أحمر */
        .training-instructions-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 3px solid #f59e0b;
            display: none;
        }
        
        .training-instructions-box.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .training-instructions-box .instr-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
            color: #dc2626;
            font-size: 1.4rem;
            font-weight: 800;
        }
        
        .training-instructions-box .instr-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #fff;
            border-radius: 10px;
            border-right: 5px solid #dc2626;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .training-instructions-box .instr-step:hover {
            transform: translateX(-5px);
        }
        
        .training-instructions-box .instr-step:last-child {
            margin-bottom: 0;
        }
        
        .training-instructions-box .step-num {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: #fff;
            min-width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .training-instructions-box .step-icon {
            font-size: 1.5rem;
        }
        
        .training-instructions-box .step-text {
            flex: 1;
            font-size: 1.2rem;
            color: #1f2937;
            line-height: 1.5;
        }
        
        .training-instructions-box .step-text strong {
            color: #dc2626;
        }
        
        .training-instructions-box .instr-step.danger-step {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border-right: 5px solid #991b1b;
            animation: pulseDanger 2s infinite;
        }
        
        @keyframes pulseDanger {
            0%, 100% { box-shadow: 0 2px 8px rgba(185, 28, 28, 0.3); }
            50% { box-shadow: 0 4px 15px rgba(185, 28, 28, 0.5); }
        }

        /* قائمة المتدربين */
        .trainees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        
        .trainee-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(255,255,255,0.06);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .trainee-card:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .trainee-card.selected {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
        }
        
        .trainee-card .check-box {
            width: 22px;
            height: 22px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.8rem;
        }
        
        .trainee-card.selected .check-box {
            background: var(--success);
            border-color: var(--success);
        }
        
        .trainee-card .trainee-info {
            flex: 1;
        }
        
        .trainee-card .trainee-name {
            font-weight: 600;
        }
        
        .trainee-card .trainee-dept {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .training-content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .training-content-grid {
                grid-template-columns: 1fr;
            }
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        .scenario-select-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 700px) {
            .scenario-select-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .scenario-select-btn {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.15);
            padding: 15px 10px;
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-family: 'Tajawal', sans-serif;
        }
        
        .scenario-select-btn i {
            font-size: 2rem;
            display: block;
            margin-bottom: 8px;
        }
        
        .scenario-select-btn span {
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .scenario-select-btn.fire { border-color: #ef4444; }
        .scenario-select-btn.fire:hover, .scenario-select-btn.fire.active { background: rgba(239, 68, 68, 0.25); }
        .scenario-select-btn.fire i { color: #ef4444; }
        
        .scenario-select-btn.power { border-color: #f59e0b; }
        .scenario-select-btn.power:hover, .scenario-select-btn.power.active { background: rgba(245, 158, 11, 0.25); }
        .scenario-select-btn.power i { color: #f59e0b; }
        
        .scenario-select-btn.water { border-color: #0ea5e9; }
        .scenario-select-btn.water:hover, .scenario-select-btn.water.active { background: rgba(14, 165, 233, 0.25); }
        .scenario-select-btn.water i { color: #0ea5e9; }
        
        .scenario-select-btn.medical { border-color: #10b981; }
        .scenario-select-btn.medical:hover, .scenario-select-btn.medical.active { background: rgba(16, 185, 129, 0.25); }
        .scenario-select-btn.medical i { color: #10b981; }
        
        .scenario-select-btn.infection { border-color: #8b5cf6; }
        .scenario-select-btn.infection:hover, .scenario-select-btn.infection.active { background: rgba(139, 92, 246, 0.25); }
        .scenario-select-btn.infection i { color: #8b5cf6; }

        .trainer-input-group {
            margin-bottom: 15px;
        }
        
        .trainer-input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary);
            font-weight: 600;
        }
        
        .trainer-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
        }
        
        .trainer-input-group input:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .selected-count-box {
            text-align: center;
            padding: 12px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success);
            border-radius: 10px;
            color: var(--success);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .save-training-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--success), #059669);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .save-training-btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 5px 25px rgba(16, 185, 129, 0.4);
        }
        
        .save-training-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }

        /* سجل التدريب/البلاغات Modal */
        .log-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.92);
            z-index: 25000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .log-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .log-modal-content {
            background: linear-gradient(135deg, #1e3a5f, #0f172a);
            border-radius: 20px;
            padding: 25px;
            max-width: 1000px;
            width: 100%;
            margin: 20px;
            border: 2px solid var(--secondary);
        }

        .log-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .log-filters input, .log-filters select {
            padding: 10px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-family: 'Tajawal', sans-serif;
        }
        
        .log-filters .print-btn {
            background: var(--secondary);
            color: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Tajawal', sans-serif;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .log-table th, .log-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .log-table th {
            background: rgba(59, 130, 246, 0.2);
            color: var(--secondary);
            font-weight: 700;
        }
        
        .log-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .scenario-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .scenario-tag.fire { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .scenario-tag.power { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .scenario-tag.water { background: rgba(14, 165, 233, 0.2); color: #0ea5e9; }
        .scenario-tag.medical { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .scenario-tag.infection { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }

        .status-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-tag.new { background: rgba(220, 20, 60, 0.2); color: #DC143C; }
        .status-tag.pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-tag.resolved { background: rgba(16, 185, 129, 0.2); color: #10b981; }

        .view-btn {
            background: var(--secondary);
            color: var(--primary);
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
        }

        @media print {
            body { background: #fff !important; color: #000 !important; }
            .header, .quick-actions, .building-section, .control-panel { display: none !important; }
            .log-modal, .training-modal { position: static !important; background: #fff !important; }
            .log-modal-content, .training-modal-content { border: 1px solid #ccc !important; background: #fff !important; color: #000 !important; }
            .log-table th { background: #f3f4f6 !important; color: #000 !important; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-title">
            <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Logo">
            <h1><i class="fas fa-shield-alt"></i> مركز القيادة <span>والتحكم EOC</span></h1>
        </div>
        <div class="header-status">
            <a href="emergency-report.html" class="report-emergency-btn">
                <i class="fas fa-exclamation-triangle"></i>
                إبلاغ طوارئ
            </a>
            <div class="status-badge status-normal" id="systemStatus">
                <i class="fas fa-check-circle"></i>
                <span>الوضع طبيعي</span>
            </div>
            <a href="emergency-plan.html" class="back-btn">
                <i class="fas fa-arrow-right"></i>
                خطة الطوارئ
            </a>
        </div>
    </header>

    <div class="main-container">
        <div class="building-section">
            <h2 class="section-title"><i class="fas fa-building"></i> خريطة المبنى التفاعلية</h2>
            
            <div class="building-view">
                <div class="floor" data-floor="2" onclick="selectFloor(2)">
                    <div class="floor-header">
                        <div class="floor-name">
                            <div class="floor-icon"><i class="fas fa-tooth"></i></div>
                            <span>الدور الثاني</span>
                        </div>
                        <span class="floor-status safe" id="floor2-status">آمن</span>
                    </div>
                    <div class="departments-grid">
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('dental')">
                            <i class="fas fa-tooth"></i>
                            الأسنان
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('internal2')">
                            <i class="fas fa-stethoscope"></i>
                            الباطنية 2
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('internal3')">
                            <i class="fas fa-stethoscope"></i>
                            الباطنية 3
                        </div>
                    </div>
                </div>

                <div class="floor" data-floor="1" onclick="selectFloor(1)">
                    <div class="floor-header">
                        <div class="floor-name">
                            <div class="floor-icon"><i class="fas fa-procedures"></i></div>
                            <span>الدور الأول</span>
                        </div>
                        <span class="floor-status safe" id="floor1-status">آمن</span>
                    </div>
                    <div class="departments-grid">
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('reception')">
                            <i class="fas fa-concierge-bell"></i>
                            الاستقبال
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('internal1')">
                            <i class="fas fa-stethoscope"></i>
                            الباطنية
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('ortho')">
                            <i class="fas fa-bone"></i>
                            العظام
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('emergency')">
                            <i class="fas fa-ambulance"></i>
                            الطوارئ
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('general')">
                            <i class="fas fa-user-md"></i>
                            الطب العام
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('dressing')">
                            <i class="fas fa-band-aid"></i>
                            الضماد
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('obgyn')">
                            <i class="fas fa-baby"></i>
                            النساء والولادة
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('menreception')">
                            <i class="fas fa-male"></i>
                            استقبال رجال
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('womenreception')">
                            <i class="fas fa-female"></i>
                            استقبال نساء
                        </div>
                    </div>
                </div>

                <div class="floor" data-floor="0" onclick="selectFloor(0)">
                    <div class="floor-header">
                        <div class="floor-name">
                            <div class="floor-icon"><i class="fas fa-flask"></i></div>
                            <span>الدور الأرضي</span>
                        </div>
                        <span class="floor-status safe" id="floor0-status">آمن</span>
                    </div>
                    <div class="departments-grid">
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('lab')">
                            <i class="fas fa-flask"></i>
                            المختبر
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('admin')">
                            <i class="fas fa-building"></i>
                            مكاتب إدارية
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('physio')">
                            <i class="fas fa-walking"></i>
                            العلاج الطبيعي
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('xray')">
                            <i class="fas fa-x-ray"></i>
                            الأشعة
                        </div>
                        <div class="dept-card" onclick="event.stopPropagation(); selectDept('ultrasound')">
                            <i class="fas fa-wave-square"></i>
                            الألتراساوند
                        </div>
                    </div>
                </div>
            </div>

            <div class="muster-points">
                <div class="muster-card" id="musterA" onclick="toggleMusterPoint('A')">
                    <i class="fas fa-map-marker-alt"></i>
                    <h4>نقطة تجمع A</h4>
                    <p>الموقف الأمامي</p>
                </div>
                <div class="muster-card" id="musterB" onclick="toggleMusterPoint('B')">
                    <i class="fas fa-map-marker-alt"></i>
                    <h4>نقطة تجمع B</h4>
                    <p>الساحة الخلفية</p>
                </div>
            </div>
            
            <!-- زر تفعيل الإخلاء الرئيسي -->
            <button class="activate-evacuation-btn" onclick="openEvacuationPanel()">
                <i class="fas fa-bullhorn"></i>
                تفعيل سيناريو إخلاء
            </button>
        </div>
        
        <!-- نافذة تفعيل حالة الطوارئ - مبسطة -->
        <div class="evacuation-modal" id="evacuationModal">
            <div class="evacuation-content" style="max-width: 600px;">
                <div class="evacuation-header">
                    <h2><i class="fas fa-bullhorn"></i> تفعيل حالة طوارئ</h2>
                    <button class="close-modal" onclick="closeEvacuationPanel()"><i class="fas fa-times"></i></button>
                </div>
                
                <p style="text-align: center; color: #94a3b8; margin-bottom: 20px;">اختر نوع الطوارئ للتفعيل الفوري</p>
                
                <div class="simple-evac-grid">
                    <button class="simple-evac-btn fire" onclick="quickActivate('fire')">
                        <i class="fas fa-fire"></i>
                        <span>حريق</span>
                    </button>
                    <button class="simple-evac-btn power" onclick="quickActivate('power')">
                        <i class="fas fa-bolt"></i>
                        <span>انقطاع كهرباء</span>
                    </button>
                    <button class="simple-evac-btn water" onclick="quickActivate('water')">
                        <i class="fas fa-tint"></i>
                        <span>تسرب مياه</span>
                    </button>
                    <button class="simple-evac-btn injury" onclick="quickActivate('injury')">
                        <i class="fas fa-heartbeat"></i>
                        <span>إغماء/إصابة</span>
                    </button>
                    <button class="simple-evac-btn infection" onclick="quickActivate('infection')">
                        <i class="fas fa-virus"></i>
                        <span>تفشي عدوى</span>
                    </button>
                    <button class="simple-evac-btn drill" onclick="quickActivate('drill')">
                        <i class="fas fa-clipboard-check"></i>
                        <span>🎯 تمرين</span>
                    </button>
                </div>
                
                <div class="evacuation-actions" style="margin-top: 20px;">
                    <button class="cancel-btn" onclick="closeEvacuationPanel()" style="width: 100%;">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>
        
        <!-- نافذة اختيار الاستجابة -->
        <div class="response-modal" id="responseModal">
            <div class="response-modal-content">
                <div class="response-modal-header">
                    <h2><i class="fas fa-bell"></i> بلاغ طوارئ جديد!</h2>
                    <button class="close-modal" onclick="closeResponseModal()"><i class="fas fa-times"></i></button>
                </div>
                
                <!-- تفاصيل البلاغ -->
                <div class="report-details-box">
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-exclamation-circle"></i> نوع الطوارئ:</span>
                        <span class="detail-value" id="reportTypeDisplay">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-map-marker-alt"></i> الموقع:</span>
                        <span class="detail-value" id="reportLocationDisplay">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-clock"></i> الوقت:</span>
                        <span class="detail-value" id="reportTimeDisplay">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label"><i class="fas fa-sticky-note"></i> ملاحظات:</span>
                        <span class="detail-value" id="reportNotesDisplay">-</span>
                    </div>
                </div>
                
                <!-- اختيار نوع الاستجابة -->
                <h3><i class="fas fa-hand-pointer"></i> اختر نوع الاستجابة:</h3>
                <div class="response-type-grid">
                    <button class="response-type-btn" data-response="full_evacuation" onclick="selectResponseType('full_evacuation')">
                        <i class="fas fa-running"></i>
                        <span>إخلاء شامل</span>
                        <small>إخلاء المبنى أو دور كامل</small>
                    </button>
                    <button class="response-type-btn" data-response="send_team" onclick="selectResponseType('send_team')">
                        <i class="fas fa-users"></i>
                        <span>توجيه فريق</span>
                        <small>إرسال فريق لموقع معين</small>
                    </button>
                    <button class="response-type-btn" data-response="isolation_evacuation" onclick="selectResponseType('isolation_evacuation')">
                        <i class="fas fa-shield-virus"></i>
                        <span>إخلاء عزل</span>
                        <small>إخلاء مع عزل (للعدوى)</small>
                    </button>
                </div>
                
                <!-- تحديد الهدف (أزرار متعددة الاختيار) -->
                <div id="responseTarget" style="display: none;">
                    <h3 id="locationSelectionTitle"><i class="fas fa-crosshairs"></i> حدد المواقع (يمكن اختيار أكثر من موقع):</h3>
                    <div class="location-buttons-grid" id="locationButtonsGrid">
                        <!-- سيتم ملؤها بالجافاسكربت -->
                    </div>
                    <input type="text" id="responseTargetLocation" placeholder="اكتب كود الموقع أو وصفه..." style="margin-top: 10px;" onkeyup="updateIssueButtonState()">
                    
                    <div id="responseMusterDiv" style="display: none; margin-top: 15px;">
                        <h3><i class="fas fa-map-marker-alt"></i> نقطة التجمع:</h3>
                        <div class="muster-buttons-grid">
                            <button type="button" class="muster-btn" data-muster="A" onclick="toggleMuster('A')">
                                <i class="fas fa-map-marker-alt"></i> نقطة A - الموقف الأمامي
                            </button>
                            <button type="button" class="muster-btn" data-muster="B" onclick="toggleMuster('B')">
                                <i class="fas fa-map-marker-alt"></i> نقطة B - الساحة الخلفية
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="response-actions">
                    <button class="cancel-btn" onclick="closeResponseModal()">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                    <button class="issue-command-btn" id="issueCommandBtn" onclick="issueCommand()" disabled>
                        <i class="fas fa-bullhorn"></i> إصدار الأمر
                    </button>
                </div>
            </div>
        </div>
        
        <!-- شاشة عرض الأمر المركزية -->
        <div class="command-display-screen" id="commandDisplayScreen">
            <div class="command-content">
                <div class="command-alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h1 id="commandTitle"><i class="fas fa-running"></i> إخلاء شامل</h1>
                <div class="command-type-badge" id="commandReportType">حريق</div>
                
                <div class="command-info-box">
                    <div class="command-info-row">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="commandLocation">-</span>
                    </div>
                </div>
                
                <div class="command-muster-box" id="commandMusterSection">
                    <h3><i class="fas fa-map-marker-alt"></i> التوجه إلى:</h3>
                    <div class="muster-display" id="commandMuster">-</div>
                </div>
                
                <div class="command-timer">
                    <span>الوقت المنقضي:</span>
                    <span class="timer-display" id="commandTimer">00:00</span>
                </div>
                
                <button class="end-command-btn" onclick="endCommand()">
                    <i class="fas fa-check-circle"></i> إنهاء الأمر
                </button>
            </div>
        </div>
        
        <!-- شاشة الإخلاء النشط -->
        <div class="active-evacuation-screen" id="activeEvacScreen">
            <div class="evac-screen-content">
                <div class="evac-alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h1 id="evacTitle">إخلاء طارئ!</h1>
                <div class="evac-type-display" id="evacTypeDisplay">حريق</div>
                <div class="evac-locations" id="evacLocations">
                    <h3>الأماكن المطلوب إخلاؤها:</h3>
                    <div class="locations-list" id="locationsList"></div>
                </div>
                <div class="evac-muster" id="evacMuster">
                    <h3><i class="fas fa-map-marker-alt"></i> التوجه إلى:</h3>
                    <div class="muster-display" id="musterDisplay">نقطة تجمع A - الموقف الأمامي</div>
                </div>
                <div class="evac-timer">
                    <span>الوقت المنقضي:</span>
                    <span class="timer-display" id="evacTimer">00:00</span>
                </div>
                <button class="end-evacuation-btn" onclick="endEvacuation()">
                    <i class="fas fa-check-circle"></i> إنهاء الإخلاء
                </button>
            </div>
        </div>

        <div class="control-panel">
            <!-- 3 أيقونات Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action training" onclick="openTrainingModal()">
                    <div class="qa-ico"><i class="fas fa-chalkboard-teacher"></i></div>
                    <div class="qa-title">جلسة تدريب عملي</div>
                    <div class="qa-sub">ابدأ تدريب على الطوارئ</div>
                </div>
                <div class="quick-action training-log" onclick="openTrainingLogModal()">
                    <div class="qa-ico"><i class="fas fa-clipboard-list"></i></div>
                    <div class="qa-title">سجل التدريب</div>
                    <div class="qa-sub">عرض جلسات التدريب</div>
                </div>
                <div class="quick-action reports-log" onclick="openReportsLogModal()">
                    <div class="qa-ico"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="qa-title">سجل البلاغات</div>
                    <div class="qa-sub">البلاغات الحقيقية</div>
                </div>
            </div>

            <div class="panel-card">
                <h3 class="section-title"><i class="fas fa-exclamation-triangle"></i> سيناريوهات الطوارئ</h3>
                <div class="emergency-scenarios">
                    <button class="scenario-btn fire" onclick="showScenario('fire')">
                        <i class="fas fa-fire"></i>
                        حريق
                    </button>
                    <button class="scenario-btn power" onclick="showScenario('power')">
                        <i class="fas fa-bolt"></i>
                        انقطاع كهرباء
                    </button>
                    <button class="scenario-btn water" onclick="showScenario('water')">
                        <i class="fas fa-tint"></i>
                        تسرب مياه
                    </button>
                    <button class="scenario-btn medical" onclick="showScenario('medical')">
                        <i class="fas fa-heartbeat"></i>
                        إغماء/إصابة
                    </button>
                    <button class="scenario-btn outbreak" onclick="showScenario('outbreak')">
                        <i class="fas fa-virus"></i>
                        تفشي عدوى
                    </button>
                </div>
            </div>

            <div class="panel-card response-panel" id="responsePanel">
                <div class="response-header">
                    <div class="response-title" id="responseTitle">
                        <i class="fas fa-fire"></i>
                        <span>خطة الاستجابة للحريق</span>
                    </div>
                    <button class="close-response" onclick="closeResponse()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="response-steps" id="responseSteps">
                </div>
                <button class="activate-btn danger" onclick="activateEmergency()" id="activateBtn" style="margin-top: 15px;">
                    <i class="fas fa-bell"></i>
                    تفعيل حالة الطوارئ
                </button>
            </div>

            <div class="panel-card">
                <h3 class="section-title"><i class="fas fa-phone-alt"></i> أرقام الطوارئ</h3>
                <div class="emergency-contacts">
                    <div class="contact-item">
                        <div class="contact-info">
                            <i class="fas fa-phone-alt"></i>
                            <span>الرقم الموحد للطوارئ</span>
                        </div>
                        <span class="contact-number">911</span>
                    </div>
                    <div class="contact-item">
                        <div class="contact-info">
                            <i class="fas fa-ambulance"></i>
                            <span>الهلال الأحمر</span>
                        </div>
                        <span class="contact-number">997</span>
                    </div>
                    <div class="contact-item">
                        <div class="contact-info">
                            <i class="fas fa-fire-extinguisher"></i>
                            <span>الدفاع المدني</span>
                        </div>
                        <span class="contact-number">998</span>
                    </div>
                    <div class="contact-item">
                        <div class="contact-info">
                            <i class="fas fa-hospital"></i>
                            <span>وزارة الصحة</span>
                        </div>
                        <span class="contact-number">937</span>
                    </div>
                </div>
            </div>

            <div class="panel-card">
                <h3 class="section-title"><i class="fas fa-clipboard-list"></i> سجل التمارين</h3>
                <div class="drill-log" id="drillLog">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                    </div>
                </div>
            </div>

            <div class="panel-card">
                <h3 class="section-title"><i class="fas fa-bell"></i> البلاغات الواردة</h3>
                <div class="reports-log" id="reportsLog">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal جلسة التدريب العملي -->
    <div class="training-modal" id="trainingModal">
        <div class="training-modal-content">
            <div class="training-modal-header">
                <h2><i class="fas fa-chalkboard-teacher"></i> جلسة تدريب عملي <span class="drill-badge">🎯 تمرين - DRILL</span></h2>
                <div class="session-timer-display" id="sessionTimerDisplay">00:00:00</div>
                <button class="close-modal" onclick="closeTrainingModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="training-content-grid">
                <div class="training-main">
                    <h3 class="section-title"><i class="fas fa-fire-alt"></i> اختر سيناريو التدريب</h3>
                    <div class="scenario-select-grid">
                        <button class="scenario-select-btn fire" onclick="selectTrainingScenario('fire')">
                            <i class="fas fa-fire"></i><span>حريق</span>
                        </button>
                        <button class="scenario-select-btn power" onclick="selectTrainingScenario('power')">
                            <i class="fas fa-bolt"></i><span>انقطاع كهرباء</span>
                        </button>
                        <button class="scenario-select-btn water" onclick="selectTrainingScenario('water')">
                            <i class="fas fa-tint"></i><span>تسرب مياه</span>
                        </button>
                        <button class="scenario-select-btn medical" onclick="selectTrainingScenario('medical')">
                            <i class="fas fa-heartbeat"></i><span>إغماء/إصابة</span>
                        </button>
                        <button class="scenario-select-btn infection" onclick="selectTrainingScenario('infection')">
                            <i class="fas fa-virus"></i><span>تفشي عدوى</span>
                        </button>
                    </div>

                    <!-- تعليمات التدريب - أصفر/أحمر -->
                    <div class="training-instructions-box" id="trainingInstructionsBox">
                        <div class="instr-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="trainingInstrTitle">التعليمات</span>
                        </div>
                        <div id="trainingInstrContent"></div>
                    </div>
                </div>

                <div class="trainees-panel">
                    <div class="trainer-input-group">
                        <label><i class="fas fa-user-tie"></i> اسم المدرب</label>
                        <input type="text" id="trainerNameInput" placeholder="أدخل اسم المدرب...">
                    </div>
                    
                    <h4 style="color: var(--secondary); margin-bottom: 10px;"><i class="fas fa-users"></i> اختر الحاضرين</h4>
                    <div class="trainees-grid" id="traineesGrid"></div>
                    
                    <div class="selected-count-box">
                        <i class="fas fa-check-circle"></i>
                        تم اختيار <span id="traineesCount">0</span> متدرب
                    </div>
                    
                    <button class="save-training-btn" id="saveTrainingBtn" onclick="saveTrainingSession()" disabled>
                        <i class="fas fa-save"></i> حفظ جلسة التدريب
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal سجل التدريب -->
    <div class="log-modal" id="trainingLogModal">
        <div class="log-modal-content">
            <div class="training-modal-header">
                <h2><i class="fas fa-clipboard-list"></i> سجل جلسات التدريب</h2>
                <button class="close-modal" onclick="closeTrainingLogModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="log-filters">
                <input type="date" id="trainingLogFromDate" onchange="filterTrainingLog()">
                <input type="date" id="trainingLogToDate" onchange="filterTrainingLog()">
                <button class="print-btn" onclick="window.print()"><i class="fas fa-print"></i> طباعة</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>التاريخ</th>
                            <th>الوقت</th>
                            <th>السيناريو</th>
                            <th>المدرب</th>
                            <th>عدد المتدربين</th>
                            <th>المدة</th>
                            <th>تفاصيل</th>
                        </tr>
                    </thead>
                    <tbody id="trainingLogBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal سجل البلاغات -->
    <div class="log-modal" id="reportsLogModal">
        <div class="log-modal-content">
            <div class="training-modal-header">
                <h2 style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> سجل البلاغات الحقيقية</h2>
                <button class="close-modal" onclick="closeReportsLogModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="log-filters">
                <input type="date" id="reportsLogFromDate" onchange="filterReportsLog()">
                <input type="date" id="reportsLogToDate" onchange="filterReportsLog()">
                <select id="reportsStatusFilter" onchange="filterReportsLog()">
                    <option value="">كل الحالات</option>
                    <option value="جديد">جديد</option>
                    <option value="قيد المعالجة">قيد المعالجة</option>
                    <option value="تم الحل">تم الحل</option>
                </select>
                <button class="print-btn" onclick="window.print()"><i class="fas fa-print"></i> طباعة</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>رقم البلاغ</th>
                            <th>التاريخ</th>
                            <th>الوقت</th>
                            <th>نوع الطوارئ</th>
                            <th>الموقع</th>
                            <th>الحالة</th>
                            <th>إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="reportsLogBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal تفاصيل التدريب -->
    <div class="log-modal" id="trainingDetailsModal">
        <div class="log-modal-content" style="max-width: 700px;">
            <div class="training-modal-header">
                <h2><i class="fas fa-info-circle"></i> تفاصيل جلسة التدريب</h2>
                <button class="close-modal" onclick="document.getElementById('trainingDetailsModal').classList.remove('active')"><i class="fas fa-times"></i></button>
            </div>
            <div id="trainingDetailsContent"></div>
            <button class="print-btn" style="width:100%; margin-top: 15px; padding: 15px; font-size: 1.1rem;" onclick="window.print()">
                <i class="fas fa-print"></i> طباعة التفاصيل
            </button>
        </div>
    </div>

    <script>
        const API_BASE = '/api/eoc';
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbztSmY_O_ITwKYXVNzs2wH8Wsid05XEZ5bEG6KJf4453dlFE8JHG_zRmuJbOksa6UgogQ/exec';

        const scenarios = {
            fire: {
                title: 'خطة الاستجابة للحريق',
                icon: 'fas fa-fire',
                color: '#ef4444',
                steps: [
                    { title: 'R - Rescue (إنقاذ)', desc: 'أنقذ أي شخص في خطر مباشر' },
                    { title: 'A - Alarm (إنذار)', desc: 'اضغط زر الإنذار وأبلغ 998' },
                    { title: 'C - Confine (احتواء)', desc: 'أغلق الأبواب لمنع انتشار الدخان' },
                    { title: 'E - Extinguish/Evacuate', desc: 'أطفئ إن أمكن أو أخلِ المبنى' },
                    { title: 'P - Pull (اسحب)', desc: 'اسحب مسمار الأمان من الطفاية' },
                    { title: 'A - Aim (صوّب)', desc: 'صوّب الخرطوم نحو قاعدة النار' },
                    { title: 'S - Squeeze (اضغط)', desc: 'اضغط على المقبض' },
                    { title: 'S - Sweep (امسح)', desc: 'حرّك يميناً ويساراً' }
                ]
            },
            power: {
                title: 'خطة انقطاع الكهرباء',
                icon: 'fas fa-bolt',
                color: '#f59e0b',
                steps: [
                    { title: 'التحقق الفوري', desc: 'تأكد من تشغيل المولد الاحتياطي' },
                    { title: 'الأنظمة الحرجة', desc: 'تحقق من UPS وثلاجات الأدوية' },
                    { title: 'إبلاغ الصيانة', desc: 'تواصل مع فريق الصيانة فوراً' },
                    { title: 'المرضى', desc: 'طمئن المرضى وأمّن الأجهزة الطبية' },
                    { title: 'التوثيق', desc: 'سجّل وقت الانقطاع والإجراءات المتخذة' },
                    { title: 'التواصل', desc: 'أبلغ الإدارة والجهات المعنية' }
                ]
            },
            water: {
                title: 'خطة تسرب المياه',
                icon: 'fas fa-tint',
                color: '#3b82f6',
                steps: [
                    { title: 'إيقاف المصدر', desc: 'أغلق محبس المياه الرئيسي فوراً' },
                    { title: 'إبلاغ الصيانة', desc: 'تواصل مع فريق الصيانة فوراً' },
                    { title: 'إزالة الأجهزة', desc: 'أبعد الأجهزة الكهربائية عن المياه' },
                    { title: 'تحذير الآخرين', desc: 'ضع علامات تحذيرية للانزلاق' },
                    { title: 'التنظيف', desc: 'جفف المنطقة المتأثرة' },
                    { title: 'التوثيق', desc: 'سجّل الحادث والإجراءات المتخذة' }
                ]
            },
            medical: {
                title: 'خطة الإغماء/الإصابة',
                icon: 'fas fa-heartbeat',
                color: '#dc2626',
                steps: [
                    { title: 'تأمين المكان', desc: 'تأكد من سلامة المحيط' },
                    { title: 'تقييم الحالة', desc: 'افحص الوعي والتنفس والنبض' },
                    { title: 'طلب المساعدة', desc: 'اتصل بالطوارئ 997 أو فريق الطوارئ الداخلي' },
                    { title: 'الإسعافات الأولية', desc: 'قدم الإسعافات الأولية المناسبة' },
                    { title: 'المراقبة', desc: 'راقب العلامات الحيوية باستمرار' },
                    { title: 'التوثيق', desc: 'سجّل الحادث والإجراءات المتخذة' }
                ]
            },
            outbreak: {
                title: 'خطة تفشي العدوى',
                icon: 'fas fa-virus',
                color: '#8b5cf6',
                steps: [
                    { title: 'العزل الفوري', desc: 'اعزل الحالة المشتبهة فوراً' },
                    { title: 'الإبلاغ', desc: 'أبلغ مكافحة العدوى و937' },
                    { title: 'الحماية الشخصية', desc: 'ارتدِ معدات الوقاية المناسبة' },
                    { title: 'تتبع المخالطين', desc: 'حدد جميع المخالطين للحالة' },
                    { title: 'التطهير', desc: 'طهّر المنطقة المتأثرة' },
                    { title: 'المتابعة', desc: 'راقب الأعراض لدى المخالطين' }
                ]
            }
        };

        let currentScenario = null;
        let emergencyActive = false;

        function selectFloor(floorNum) {
            document.querySelectorAll('.floor').forEach(f => f.classList.remove('active'));
            document.querySelector(`[data-floor="${floorNum}"]`).classList.add('active');
        }

        function selectDept(deptId) {
            document.querySelectorAll('.dept-card').forEach(d => d.classList.remove('selected'));
            event.target.closest('.dept-card').classList.add('selected');
        }

        function showScenario(type) {
            currentScenario = type;
            const scenario = scenarios[type];
            
            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.scenario-btn.${type}`).classList.add('active');
            
            document.getElementById('responseTitle').innerHTML = `
                <i class="${scenario.icon}" style="color: ${scenario.color}"></i>
                <span>${scenario.title}</span>
            `;
            
            const stepsHtml = scenario.steps.map((step, i) => `
                <div class="step-item">
                    <div class="step-number">${i + 1}</div>
                    <div class="step-content">
                        <h4>${step.title}</h4>
                        <p>${step.desc}</p>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('responseSteps').innerHTML = stepsHtml;
            document.getElementById('responsePanel').classList.add('active');
        }

        function closeResponse() {
            document.getElementById('responsePanel').classList.remove('active');
            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
            currentScenario = null;
        }

        async function activateEmergency() {
            if (!emergencyActive) {
                emergencyActive = true;
                document.getElementById('systemStatus').className = 'status-badge status-alert';
                document.getElementById('systemStatus').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>حالة طوارئ!</span>
                `;
                
                document.querySelectorAll('.floor').forEach(f => {
                    f.classList.add('evacuating');
                    f.querySelector('.floor-status').className = 'floor-status evacuating';
                    f.querySelector('.floor-status').textContent = 'إخلاء';
                });
                
                document.getElementById('activateBtn').className = 'activate-btn success';
                document.getElementById('activateBtn').innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    إنهاء حالة الطوارئ
                `;
                
                // إرسال الأمر للـ Backend ليظهر في Emergency.html
                const typeNames = {
                    'fire': 'حريق',
                    'power': 'انقطاع كهرباء',
                    'water': 'تسرب مياه',
                    'medical': 'إغماء/إصابة',
                    'outbreak': 'تفشي عدوى'
                };
                const commandData = {
                    type: currentScenario || 'general',
                    reportType: typeNames[currentScenario] || 'طوارئ عامة',
                    location: 'جميع الأدوار',
                    muster: 'نقطة التجمع الرئيسية'
                };
                
                try {
                    await window.__eocJsonp('setActiveCommand', {
                        responseType: commandData.type,
                        reportType: commandData.reportType,
                        location: commandData.location,
                        muster: commandData.muster
                    });
                    console.log('Command sent to backend successfully');
                } catch(e) {
                    console.error('Error sending command:', e);
                }
                
                alert('تم تفعيل حالة الطوارئ!\nيرجى اتباع إجراءات الإخلاء.');
            } else {
                emergencyActive = false;
                document.getElementById('systemStatus').className = 'status-badge status-normal';
                document.getElementById('systemStatus').innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>الوضع طبيعي</span>
                `;
                
                document.querySelectorAll('.floor').forEach(f => {
                    f.classList.remove('evacuating');
                    f.querySelector('.floor-status').className = 'floor-status safe';
                    f.querySelector('.floor-status').textContent = 'آمن';
                });
                
                document.getElementById('activateBtn').className = 'activate-btn danger';
                document.getElementById('activateBtn').innerHTML = `
                    <i class="fas fa-bell"></i>
                    تفعيل حالة الطوارئ
                `;
                
                // إلغاء الأمر من الـ Backend
                try {
                    await window.__eocJsonp('clearActiveCommand', {});
                    console.log('Command cleared from backend');
                } catch(e) {
                    console.error('Error clearing command:', e);
                }
            }
        }

        async function loadDrillLog() {
            const container = document.getElementById('drillLog');
            try {
                const response = await fetch(`${API_BASE}/drills`);
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                if (data.ok && data.drills && data.drills.length > 0) {
                    container.innerHTML = data.drills.slice(0, 10).map(drill => `
                        <div class="drill-item">
                            <div class="drill-info">
                                <i class="fas fa-clipboard-check" style="color: var(--secondary)"></i>
                                <span>${drill.type || 'تمرين إخلاء'}</span>
                            </div>
                            <span class="drill-date">${drill.date || ''}</span>
                            <span class="drill-result success">${drill.result || 'ناجح'}</span>
                        </div>
                    `).join('');
                } else {
                    showDefaultDrills(container);
                }
            } catch (error) {
                console.error('Error loading drills:', error);
                showDefaultDrills(container);
            }
        }
        
        function showDefaultDrills(container) {
            container.innerHTML = `
                <div class="drill-item">
                    <div class="drill-info">
                        <i class="fas fa-clipboard-check" style="color: var(--secondary)"></i>
                        <span>تمرين إخلاء حريق</span>
                    </div>
                    <span class="drill-date">2025-01-15</span>
                    <span class="drill-result success">ناجح</span>
                </div>
                <div class="drill-item">
                    <div class="drill-info">
                        <i class="fas fa-clipboard-check" style="color: var(--secondary)"></i>
                        <span>تمرين انقطاع كهرباء</span>
                    </div>
                    <span class="drill-date">2024-12-10</span>
                    <span class="drill-result success">ناجح</span>
                </div>
            `;
        }

        window.alertedReportIds = window.alertedReportIds || new Set();
        
        async function loadReports() {
            const container = document.getElementById('reportsLog');
            try {
                const params = new URLSearchParams({ action: 'getEmergencyReports' });
                const response = await fetch(WEB_APP_URL + '?' + params.toString(), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await response.json();
                
                if (!data.ok) {
                    container.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
                            <p>خطأ في جلب البلاغات</p>
                            <small>${data.error || 'يرجى المحاولة لاحقاً'}</small>
                        </div>
                    `;
                    return;
                }
                
                if (data.reports && data.reports.length > 0) {
                    // Check for NEW status reports that we haven't alerted about
                    const pendingAlerts = data.reports.filter(r => r.status === 'جديد' && !window.alertedReportIds.has(r.id));
                    
                    // Alert for each new report
                    if (pendingAlerts.length > 0) {
                        showNewReportAlert(pendingAlerts[0]);
                        pendingAlerts.forEach(r => window.alertedReportIds.add(r.id));
                    }
                    
                    container.innerHTML = data.reports.slice(0, 10).map(report => {
                        const statusClass = report.status === 'جديد' ? 'new' : 
                                           report.status === 'قيد المعالجة' ? 'pending' : 'resolved';
                        const typeIcon = getReportTypeIcon(report.type);
                        const actionBtns = getActionButtons(report);
                        return `
                            <div class="report-item ${statusClass}" data-report-id="${report.id}">
                                <div class="report-header">
                                    <span class="report-type"><i class="${typeIcon}"></i> ${report.type}</span>
                                    <span class="report-status ${statusClass}">${report.status}</span>
                                </div>
                                <div class="report-location"><i class="fas fa-map-marker-alt"></i> ${report.location}</div>
                                <div class="report-time"><i class="fas fa-clock"></i> ${report.date} - ${report.time}</div>
                                ${report.notes ? `<div class="report-notes"><i class="fas fa-sticky-note"></i> ${report.notes}</div>` : ''}
                                <div class="report-actions">${actionBtns}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="no-reports">
                            <i class="fas fa-check-circle"></i>
                            <p>لا توجد بلاغات حالياً</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                container.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-wifi" style="color: var(--danger);"></i>
                        <p>تعذر الاتصال بالخادم</p>
                        <small>تحقق من اتصال الإنترنت</small>
                    </div>
                `;
            }
        }
        
        function getActionButtons(report) {
            if (report.status === 'جديد') {
                return `
                    <button class="action-btn respond" onclick="updateStatus('${report.id}', 'قيد المعالجة')">
                        <i class="fas fa-user-check"></i> استجابة
                    </button>
                `;
            } else if (report.status === 'قيد المعالجة') {
                return `
                    <button class="action-btn resolve" onclick="updateStatus('${report.id}', 'مغلق')">
                        <i class="fas fa-check-circle"></i> إغلاق
                    </button>
                `;
            }
            return '<span class="resolved-badge"><i class="fas fa-check"></i> تم الإغلاق</span>';
        }
        
        async function updateStatus(reportId, newStatus) {
            const responder = prompt('اسم المستجيب:');
            if (!responder) return;
            
            const actionNotes = prompt('ملاحظات الإجراء (اختياري):') || '';
            
            try {
                const params = new URLSearchParams({
                    action: 'updateEmergencyStatus',
                    reportId: reportId,
                    status: newStatus,
                    responder: responder,
                    actionNotes: actionNotes
                });
                
                const response = await fetch(WEB_APP_URL + '?' + params.toString());
                const data = await response.json();
                
                if (data.ok) {
                    showToast('تم تحديث الحالة بنجاح', 'success');
                    loadReports();
                } else {
                    showToast('خطأ: ' + (data.error || 'فشل التحديث'), 'error');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('تعذر الاتصال بالخادم', 'error');
            }
        }
        
        let currentReport = null;
        
        function showNewReportAlert(report) {
            console.log('🚨 New report alert:', report);
            currentReport = report;
            
            // Highlight location on map
            highlightEmergencyLocation(report.location);
            
            // Play loud siren sound
            playEmergencySiren();
            
            // Change page status to alert mode
            const statusBadge = document.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = 'status-badge status-alert';
                statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> حالة طوارئ!';
            }
            
            // Show response modal with report details
            showResponseModal(report);
        }
        
        // متغيرات لتخزين الاختيارات المتعددة
        let selectedLocations = [];
        let selectedMuster = '';

        function showResponseModal(report) {
            const modal = document.getElementById('responseModal');
            if (!modal) {
                console.error('Response modal not found');
                return;
            }
            
            // Fill report details
            const typeDisplay = document.getElementById('reportTypeDisplay');
            const locDisplay = document.getElementById('reportLocationDisplay');
            const timeDisplay = document.getElementById('reportTimeDisplay');
            const notesDisplay = document.getElementById('reportNotesDisplay');
            
            if (typeDisplay) typeDisplay.textContent = report.type;
            if (locDisplay) locDisplay.textContent = report.location;
            if (timeDisplay) timeDisplay.textContent = `${report.date} - ${report.time}`;
            if (notesDisplay) notesDisplay.textContent = report.notes || 'لا توجد ملاحظات';
            
            // Reset selections
            document.querySelectorAll('.response-type-btn').forEach(b => b.classList.remove('selected'));
            
            const responseTarget = document.getElementById('responseTarget');
            const locationGrid = document.getElementById('locationButtonsGrid');
            const targetLocation = document.getElementById('responseTargetLocation');
            const issueBtn = document.getElementById('issueCommandBtn');
            
            if (responseTarget) responseTarget.style.display = 'none';
            if (locationGrid) locationGrid.innerHTML = '';
            if (targetLocation) {
                targetLocation.value = '';
                targetLocation.style.display = 'none';
            }
            document.querySelectorAll('.muster-btn').forEach(b => b.classList.remove('selected'));
            selectedLocations = [];
            selectedMuster = '';
            if (issueBtn) issueBtn.disabled = true;
            
            modal.classList.add('active');
        }
        
        function closeResponseModal() {
            document.getElementById('responseModal').classList.remove('active');
        }
        
        function selectResponseType(type) {
            document.querySelectorAll('.response-type-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector(`[data-response="${type}"]`).classList.add('selected');
            
            const targetDiv = document.getElementById('responseTarget');
            const locationGrid = document.getElementById('locationButtonsGrid');
            const musterDiv = document.getElementById('responseMusterDiv');
            const customInput = document.getElementById('responseTargetLocation');
            const locationTitle = document.getElementById('locationSelectionTitle');
            
            // إعادة تعيين الاختيارات
            selectedLocations = [];
            if (customInput) {
                customInput.style.display = 'block'; // دائماً يظهر لكتابة موقع إضافي
                customInput.value = '';
            }
            
            // إنشاء أزرار المواقع حسب نوع الاستجابة
            let locationOptions = [];
            let titleText = '';
            let placeholder = '';
            
            if (type === 'full_evacuation') {
                titleText = 'حدد موقع الإخلاء (يمكن اختيار أكثر من موقع):';
                placeholder = 'أو اكتب موقع/كود إضافي...';
                locationOptions = [
                    { id: 'building', label: 'المبنى بالكامل', icon: 'fas fa-building' },
                    { id: 'floor2', label: 'الدور الثاني', icon: 'fas fa-arrow-up' },
                    { id: 'floor1', label: 'الدور الأول', icon: 'fas fa-minus' },
                    { id: 'floor0', label: 'الدور الأرضي', icon: 'fas fa-arrow-down' },
                    { id: 'report_location', label: 'موقع البلاغ', icon: 'fas fa-map-pin' }
                ];
                if (musterDiv) musterDiv.style.display = 'block';
            } else if (type === 'send_team') {
                titleText = 'حدد موقع التوجيه (يمكن اختيار أكثر من موقع):';
                placeholder = 'اكتب كود الموقع أو وصفه...';
                locationOptions = [
                    { id: 'report_location', label: 'موقع البلاغ', icon: 'fas fa-map-pin' },
                    { id: 'floor2', label: 'الدور الثاني', icon: 'fas fa-arrow-up' },
                    { id: 'floor1', label: 'الدور الأول', icon: 'fas fa-minus' },
                    { id: 'floor0', label: 'الدور الأرضي', icon: 'fas fa-arrow-down' }
                ];
                if (musterDiv) musterDiv.style.display = 'none';
            } else if (type === 'isolation_evacuation') {
                titleText = 'حدد موقع العزل وعدم الاقتراب (يمكن اختيار أكثر من موقع):';
                placeholder = 'اكتب كود الموقع أو وصفه...';
                locationOptions = [
                    { id: 'report_location', label: 'موقع البلاغ', icon: 'fas fa-map-pin' },
                    { id: 'floor2', label: 'الدور الثاني', icon: 'fas fa-arrow-up' },
                    { id: 'floor1', label: 'الدور الأول', icon: 'fas fa-minus' },
                    { id: 'floor0', label: 'الدور الأرضي', icon: 'fas fa-arrow-down' }
                ];
                if (musterDiv) musterDiv.style.display = 'block';
            }
            
            // تحديث العنوان
            if (locationTitle) {
                locationTitle.innerHTML = `<i class="fas fa-crosshairs"></i> ${titleText}`;
            }
            
            // تحديث placeholder
            if (customInput) {
                customInput.placeholder = placeholder;
            }
            
            // إنشاء الأزرار
            if (locationGrid) {
                locationGrid.innerHTML = locationOptions.map(opt => `
                    <button type="button" class="location-btn" data-location="${opt.id}" onclick="toggleLocation('${opt.id}')">
                        <i class="${opt.icon}"></i> ${opt.label}
                    </button>
                `).join('');
            }
            
            if (targetDiv) targetDiv.style.display = 'block';
            updateIssueButtonState();
        }
        
        function toggleLocation(locationId) {
            const btn = document.querySelector(`.location-btn[data-location="${locationId}"]`);
            
            if (selectedLocations.includes(locationId)) {
                // إلغاء الاختيار
                selectedLocations = selectedLocations.filter(l => l !== locationId);
                btn.classList.remove('selected');
            } else {
                // إضافة الاختيار
                selectedLocations.push(locationId);
                btn.classList.add('selected');
            }
            
            updateIssueButtonState();
        }
        
        function toggleMuster(musterId) {
            document.querySelectorAll('.muster-btn').forEach(b => b.classList.remove('selected'));
            
            if (selectedMuster === musterId) {
                selectedMuster = '';
            } else {
                selectedMuster = musterId;
                document.querySelector(`.muster-btn[data-muster="${musterId}"]`).classList.add('selected');
            }
            
            updateIssueButtonState();
        }
        
        function updateIssueButtonState() {
            const selectedType = document.querySelector('.response-type-btn.selected');
            const customLocation = document.getElementById('responseTargetLocation');
            const musterDiv = document.getElementById('responseMusterDiv');
            const issueBtn = document.getElementById('issueCommandBtn');
            
            if (!issueBtn) return;
            
            // يجب اختيار نوع الاستجابة
            if (!selectedType) {
                issueBtn.disabled = true;
                return;
            }
            
            // يجب اختيار موقع واحد على الأقل أو كتابة موقع مخصص
            const customVal = customLocation ? customLocation.value.trim() : '';
            const hasLocation = selectedLocations.length > 0 || customVal;
            
            // يجب اختيار نقطة تجمع إذا كانت ظاهرة
            const needsMuster = musterDiv && musterDiv.style.display !== 'none';
            const hasMuster = !needsMuster || selectedMuster;
            
            issueBtn.disabled = !(hasLocation && hasMuster);
        }
        
        async function issueCommand() {
            const selectedTypeBtn = document.querySelector('.response-type-btn.selected');
            if (!selectedTypeBtn) return;
            
            const responseType = selectedTypeBtn.dataset.response;
            const customLocation = document.getElementById('responseTargetLocation').value.trim();
            
            // تجميع المواقع المختارة
            const floorNames = { 
                floor0: 'الدور الأرضي', 
                floor1: 'الدور الأول', 
                floor2: 'الدور الثاني',
                building: 'المبنى بالكامل',
                report_location: currentReport?.location || 'موقع البلاغ'
            };
            
            let locationParts = [];
            selectedLocations.forEach(locId => {
                locationParts.push(floorNames[locId] || locId);
            });
            
            // إضافة الموقع المخصص إذا كتبه
            if (customLocation) {
                locationParts.push(customLocation);
            }
            
            let commandData = {
                type: responseType,
                reportType: currentReport?.type || '',
                location: locationParts.join(' + '),
                muster: '',
                timestamp: new Date().toLocaleString('ar-SA')
            };
            
            // نقطة التجمع
            if (selectedMuster === 'A') {
                commandData.muster = 'نقطة تجمع A - الموقف الأمامي';
            } else if (selectedMuster === 'B') {
                commandData.muster = 'نقطة تجمع B - الساحة الخلفية';
            }
            
            closeResponseModal();
            showCommandScreen(commandData);
            
            await sendCommandToBackend(commandData);
            
            // تحديث حالة البلاغ إلى "قيد المعالجة"
            if (currentReport && currentReport.id) {
                try {
                    await jsonp('updateEmergencyStatus', {
                        reportId: currentReport.id,
                        status: 'قيد المعالجة',
                        responder: 'EOC',
                        actionNotes: 'تم إصدار أمر: ' + commandData.type
                    });
                    console.log('Report status updated');
                } catch(e) {
                    console.warn('Failed to update report status:', e);
                }
            }
        }
        
        async function sendCommandToBackend(commandData) {
            try {
                const res = await jsonp('setActiveCommand', {
                    responseType: commandData.type,
                    reportType: commandData.reportType,
                    location: commandData.location,
                    muster: commandData.muster || ''
                });

                if (!res || !res.ok) {
                    throw new Error(res?.error || 'setActiveCommand failed');
                }
                console.log('Command sent to backend successfully');
            } catch (error) {
                console.error('Error sending command:', error);
                showToast('فشل إرسال الأمر للشاشات', 'error');
            }
        }
        
        function showCommandScreen(commandData) {
            const screen = document.getElementById('commandDisplayScreen');
            
            // Set command type title and icon
            let title, icon, bgColor;
            switch(commandData.type) {
                case 'full_evacuation':
                    title = 'إخلاء شامل';
                    icon = 'fas fa-running';
                    bgColor = '#DC143C';
                    break;
                case 'send_team':
                    title = 'توجيه فريق الطوارئ';
                    icon = 'fas fa-users';
                    bgColor = '#f59e0b';
                    break;
                case 'isolation_evacuation':
                    title = 'إخلاء عزل';
                    icon = 'fas fa-shield-virus';
                    bgColor = '#8b5cf6';
                    break;
                default:
                    title = 'أمر طوارئ';
                    icon = 'fas fa-exclamation-triangle';
                    bgColor = '#DC143C';
            }
            
            screen.style.background = `linear-gradient(135deg, ${bgColor}, ${bgColor}aa)`;
            document.getElementById('commandTitle').innerHTML = `<i class="${icon}"></i> ${title}`;
            document.getElementById('commandReportType').textContent = commandData.reportType;
            document.getElementById('commandLocation').textContent = commandData.location;
            
            const musterSection = document.getElementById('commandMusterSection');
            if (commandData.muster) {
                musterSection.style.display = 'block';
                document.getElementById('commandMuster').textContent = commandData.muster;
            } else {
                musterSection.style.display = 'none';
            }
            
            // Start timer
            commandStartTime = Date.now();
            commandTimerInterval = setInterval(updateCommandTimer, 1000);
            
            // Play continuous siren
            startContinuousSiren();
            
            screen.classList.add('active');
        }
        
        let commandStartTime = null;
        let commandTimerInterval = null;
        let continuousSirenInterval = null;
        
        function updateCommandTimer() {
            const elapsed = Math.floor((Date.now() - commandStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('commandTimer').textContent = `${mins}:${secs}`;
        }
        
        function startContinuousSiren() {
            // Play siren every 10 seconds
            playEmergencySiren();
            continuousSirenInterval = setInterval(playEmergencySiren, 10000);
        }
        
        function stopContinuousSiren() {
            if (continuousSirenInterval) {
                clearInterval(continuousSirenInterval);
                continuousSirenInterval = null;
            }
        }
        
        function endCommand() {
            if (!confirm('هل تريد إنهاء الأمر؟')) return;
            
            // Stop timer
            if (commandTimerInterval) {
                clearInterval(commandTimerInterval);
                commandTimerInterval = null;
            }
            
            // Stop siren
            stopContinuousSiren();
            
            // Reset status
            const statusBadge = document.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = 'status-badge status-normal';
                statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> <span>الوضع طبيعي</span>';
            }
            
            // Hide screen
            document.getElementById('commandDisplayScreen').classList.remove('active');
            
            // Clear command from backend
            clearCommandFromBackend();
            
            // Update report status
            if (currentReport) {
                updateStatus(currentReport.id, 'مغلق');
            }
            
            showToast('تم إنهاء الأمر بنجاح', 'success');
        }
        
        async function clearCommandFromBackend() {
            try {
                const res = await jsonp('clearActiveCommand', {});
                if (!res || !res.ok) throw new Error(res?.error || 'clearActiveCommand failed');
                console.log('Command cleared from backend');
            } catch (e) {
                console.error('Error clearing command:', e);
            }
        }
        
        function playEmergencySiren() {
            // Create oscillator-based siren for loud alert
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sawtooth';
                gainNode.gain.value = 0.3;
                
                // Siren effect - alternating frequencies
                oscillator.start();
                let high = true;
                const sirenInterval = setInterval(() => {
                    oscillator.frequency.value = high ? 800 : 600;
                    high = !high;
                }, 300);
                
                // Stop after 3 seconds
                setTimeout(() => {
                    clearInterval(sirenInterval);
                    oscillator.stop();
                    audioContext.close();
                }, 3000);
            } catch(e) {
                console.log('Audio not supported');
            }
        }
        
        function highlightEmergencyLocation(locationText) {
            // Remove previous highlights
            document.querySelectorAll('.room-btn.emergency-highlight').forEach(btn => {
                btn.classList.remove('emergency-highlight');
            });
            
            // Find matching room button and highlight it
            document.querySelectorAll('.room-btn').forEach(btn => {
                if (locationText && locationText.includes(btn.textContent.trim())) {
                    btn.classList.add('emergency-highlight');
                    btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function getReportTypeIcon(type) {
            const icons = {
                'حريق': 'fas fa-fire',
                'انقطاع كهرباء': 'fas fa-bolt',
                'تسرب مياه': 'fas fa-water',
                'إغماء/إصابة': 'fas fa-user-injured',
                'تفشي عدوى': 'fas fa-virus',
                'أخرى': 'fas fa-exclamation-circle'
            };
            return icons[type] || 'fas fa-exclamation-triangle';
        }

        // ============ نظام تفعيل الإخلاء ============
        let evacState = {
            type: null,
            typeLabel: '',
            areas: new Set(),
            muster: null,
            timerInterval: null,
            startTime: null
        };
        
        const deptNames = {
            'dental': 'الأسنان',
            'internal2': 'الباطنية 2',
            'internal3': 'الباطنية 3',
            'reception': 'الاستقبال',
            'internal1': 'الباطنية',
            'ortho': 'العظام',
            'emergency': 'الطوارئ',
            'general': 'الطب العام',
            'dressing': 'الضماد',
            'obgyn': 'النساء والولادة',
            'menreception': 'استقبال رجال',
            'womenreception': 'استقبال نساء',
            'lab': 'المختبر',
            'admin': 'مكاتب إدارية',
            'physio': 'العلاج الطبيعي',
            'xray': 'الأشعة',
            'ultrasound': 'الألتراساوند'
        };
        
        const floorDepts = {
            2: ['dental', 'internal2', 'internal3'],
            1: ['reception', 'internal1', 'ortho', 'emergency', 'general', 'dressing', 'obgyn', 'menreception', 'womenreception'],
            0: ['lab', 'admin', 'physio', 'xray', 'ultrasound']
        };
        
        const typeLabels = {
            'fire': 'حريق',
            'power': 'انقطاع كهرباء',
            'water': 'تسرب مياه',
            'injury': 'إغماء/إصابة',
            'infection': 'تفشي عدوى',
            'drill': 'تمرين'
        };
        
        /* تفعيل سريع بنقرة واحدة */
        async function quickActivate(type) {
            const isDrill = (type === 'drill');
            const typeLabel = typeLabels[type] || type;
            
            // تأكيد التفعيل
            const confirmMsg = isDrill 
                ? `هل تريد تفعيل تمرين طوارئ؟\n\nسيظهر في شاشة الطوارئ مع علامة "تمرين" واضحة.`
                : `هل تريد تفعيل حالة طوارئ: ${typeLabel}؟\n\n⚠️ سيتم إشعار جميع الموظفين!`;
            
            if (!confirm(confirmMsg)) return;
            
            closeEvacuationPanel();
            
            // تحديث evacState للتوافق مع النظام الحالي
            evacState.type = type;
            evacState.typeLabel = typeLabel;
            evacState.areas = new Set(['all']);
            evacState.muster = 'A';
            
            // تحديث الحالة في الصفحة
            const statusEl = document.getElementById('systemStatus');
            if (statusEl) {
                statusEl.className = 'status-badge status-alert';
                statusEl.innerHTML = isDrill
                    ? `<i class="fas fa-clipboard-check"></i><span>🎯 تمرين جاري</span>`
                    : `<i class="fas fa-exclamation-triangle"></i><span>حالة طوارئ!</span>`;
            }
            
            // إرسال للـ Backend
            const payload = {
                responseType: type,
                reportType: typeLabel,
                location: 'جميع الأدوار',
                muster: 'نقطة التجمع A - الموقف الأمامي',
                isDrill: isDrill
            };
            
            try {
                if (typeof window.__eocJsonp === 'function') {
                    await window.__eocJsonp('setActiveCommand', payload);
                    const successMsg = isDrill 
                        ? '✅ تم تفعيل التمرين!\n\nشاشة الطوارئ ستعرض "تمرين" بوضوح.'
                        : '🚨 تم تفعيل حالة الطوارئ!\n\nيرجى اتباع الإجراءات المناسبة.';
                    alert(successMsg);
                } else {
                    console.warn('__eocJsonp not available, local activation only');
                    alert('تم التفعيل محلياً (Backend غير متاح).');
                }
            } catch(e) {
                console.error('Error activating:', e);
                // استعادة الحالة الطبيعية في حالة الفشل
                if (statusEl) {
                    statusEl.className = 'status-badge status-normal';
                    statusEl.innerHTML = `<i class="fas fa-check-circle"></i><span>الوضع طبيعي</span>`;
                }
                alert('حدث خطأ في التفعيل. يرجى المحاولة مرة أخرى.');
            }
        }
        
        const musterInfo = {
            'A': 'نقطة تجمع A - الموقف الأمامي',
            'B': 'نقطة تجمع B - الساحة الخلفية'
        };
        
        function openEvacuationPanel() {
            // Reset state
            evacState = {
                type: null,
                typeLabel: '',
                areas: new Set(),
                muster: null,
                timerInterval: null,
                startTime: null
            };
            
            // Reset UI
            document.querySelectorAll('.evac-type-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.floor-select-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.muster-select-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.dept-card').forEach(d => d.classList.remove('evac-selected'));
            updateSelectedAreasDisplay();
            updateEvacButtonState();
            
            document.getElementById('evacuationModal').classList.add('active');
        }
        
        function closeEvacuationPanel() {
            document.getElementById('evacuationModal').classList.remove('active');
        }
        
        function selectEvacType(type) {
            evacState.type = type;
            evacState.typeLabel = typeLabels[type];
            
            document.querySelectorAll('.evac-type-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            
            updateEvacButtonState();
        }
        
        function selectEvacFloor(floor) {
            if (floor === 'all') {
                // Select all departments
                Object.values(floorDepts).flat().forEach(dept => evacState.areas.add(dept));
                document.querySelectorAll('.dept-card').forEach(d => d.classList.add('evac-selected'));
            } else {
                // Select departments of this floor
                floorDepts[floor].forEach(dept => evacState.areas.add(dept));
                // Highlight the floor's departments
                const floorEl = document.querySelector(`[data-floor="${floor}"]`);
                if (floorEl) {
                    floorEl.querySelectorAll('.dept-card').forEach(d => d.classList.add('evac-selected'));
                }
            }
            
            updateSelectedAreasDisplay();
            updateEvacButtonState();
        }
        
        // Toggle قسم فردي (لمبة)
        function toggleDept(deptId) {
            const btn = document.querySelector(`.dept-toggle-btn[data-dept="${deptId}"]`);
            
            if (evacState.areas.has(deptId)) {
                // إلغاء التحديد
                evacState.areas.delete(deptId);
                btn.classList.remove('active');
            } else {
                // تحديد
                evacState.areas.add(deptId);
                btn.classList.add('active');
            }
            
            updateSelectionCounter();
            updateEvacButtonState();
        }
        
        // Toggle اختيار سريع للأدوار
        function toggleQuickFloor(floor) {
            const allBtns = document.querySelectorAll('.quick-floor-btn');
            let floorDeptList;
            
            if (floor === 'all') {
                floorDeptList = Object.values(floorDepts).flat();
            } else {
                floorDeptList = floorDepts[floor] || [];
            }
            
            // Check if all depts of this floor are selected
            const allSelected = floorDeptList.every(d => evacState.areas.has(d));
            
            if (allSelected) {
                // Deselect all
                floorDeptList.forEach(d => {
                    evacState.areas.delete(d);
                    const btn = document.querySelector(`.dept-toggle-btn[data-dept="${d}"]`);
                    if (btn) btn.classList.remove('active');
                });
            } else {
                // Select all
                floorDeptList.forEach(d => {
                    evacState.areas.add(d);
                    const btn = document.querySelector(`.dept-toggle-btn[data-dept="${d}"]`);
                    if (btn) btn.classList.add('active');
                });
            }
            
            updateSelectionCounter();
            updateEvacButtonState();
        }
        
        // تحديث عداد المحدد
        function updateSelectionCounter() {
            const counter = document.getElementById('selectionCounter');
            const countEl = document.getElementById('selectedCount');
            const count = evacState.areas.size;
            
            countEl.textContent = count;
            
            if (count > 0) {
                counter.classList.add('has-selection');
            } else {
                counter.classList.remove('has-selection');
            }
        }
        
        function selectMusterForEvac(point) {
            evacState.muster = point;
            
            document.querySelectorAll('.muster-select-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector(`[data-muster="${point}"]`).classList.add('selected');
            
            updateEvacButtonState();
        }
        
        function updateSelectedAreasDisplay() {
            const container = document.getElementById('selectedAreas');
            
            if (evacState.areas.size === 0) {
                container.innerHTML = '<span class="placeholder">لم يتم تحديد أي مكان</span>';
                return;
            }
            
            let html = '';
            evacState.areas.forEach(area => {
                const name = deptNames[area] || area;
                html += `<span class="selected-area-tag">${name} <i class="fas fa-times remove-tag" onclick="removeEvacArea('${area}')"></i></span>`;
            });
            container.innerHTML = html;
        }
        
        function removeEvacArea(area) {
            evacState.areas.delete(area);
            
            // Find and unselect the dept card
            document.querySelectorAll('.dept-card').forEach(d => {
                if (d.textContent.trim().includes(deptNames[area])) {
                    d.classList.remove('evac-selected');
                }
            });
            
            updateSelectedAreasDisplay();
            updateEvacButtonState();
        }
        
        function updateEvacButtonState() {
            const btn = document.getElementById('confirmEvacBtn');
            const canActivate = evacState.type && evacState.areas.size > 0 && evacState.muster;
            btn.disabled = !canActivate;
        }
        
        function activateEvacuation() {
            if (!evacState.type || evacState.areas.size === 0 || !evacState.muster) {
                alert('يرجى استكمال جميع الخطوات');
                return;
            }
            
            // Close modal
            closeEvacuationPanel();
            
            // Update system status
            document.getElementById('systemStatus').className = 'status-badge status-alert';
            document.getElementById('systemStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> حالة طوارئ!';
            
            // Prepare evacuation screen
            document.getElementById('evacTitle').textContent = evacState.type === 'drill' ? 'تمرين إخلاء!' : 'إخلاء طارئ!';
            document.getElementById('evacTypeDisplay').textContent = evacState.typeLabel;
            
            // Show locations
            let locationsHtml = '';
            evacState.areas.forEach(area => {
                locationsHtml += `<span>${deptNames[area]}</span>`;
            });
            document.getElementById('locationsList').innerHTML = locationsHtml;
            
            // Show muster point
            document.getElementById('musterDisplay').textContent = musterInfo[evacState.muster];
            
            // Highlight muster point
            const musterCard = document.getElementById('muster' + evacState.muster);
            if (musterCard) {
                musterCard.classList.add('active-muster');
            }
            
            // Mark floors as evacuating
            document.querySelectorAll('.floor').forEach(f => {
                const floorNum = parseInt(f.getAttribute('data-floor'));
                const floorDeptList = floorDepts[floorNum] || [];
                const hasEvacArea = floorDeptList.some(d => evacState.areas.has(d));
                
                if (hasEvacArea) {
                    f.querySelector('.floor-status').className = 'floor-status evacuating';
                    f.querySelector('.floor-status').textContent = 'إخلاء';
                }
            });
            
            // Start timer
            evacState.startTime = Date.now();
            evacState.timerInterval = setInterval(updateEvacTimer, 1000);
            
            // Play siren
            playEmergencySiren();
            
            // Show evacuation screen
            document.getElementById('activeEvacScreen').classList.add('active');
        }
        
        function updateEvacTimer() {
            const elapsed = Math.floor((Date.now() - evacState.startTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('evacTimer').textContent = `${mins}:${secs}`;
        }
        
        function endEvacuation() {
            if (!confirm('هل تريد إنهاء الإخلاء؟')) return;
            
            // Stop timer
            if (evacState.timerInterval) {
                clearInterval(evacState.timerInterval);
            }
            
            // Reset UI
            document.getElementById('activeEvacScreen').classList.remove('active');
            document.getElementById('systemStatus').className = 'status-badge status-normal';
            document.getElementById('systemStatus').innerHTML = '<i class="fas fa-check-circle"></i> <span>الوضع طبيعي</span>';
            
            document.querySelectorAll('.floor-status').forEach(s => {
                s.className = 'floor-status safe';
                s.textContent = 'آمن';
            });
            
            document.querySelectorAll('.dept-card').forEach(d => d.classList.remove('evac-selected'));
            document.querySelectorAll('.muster-card').forEach(m => m.classList.remove('active-muster'));
            
            // Reset state
            evacState = {
                type: null,
                typeLabel: '',
                areas: new Set(),
                muster: null,
                timerInterval: null,
                startTime: null
            };
            
            showToast('تم إنهاء الإخلاء بنجاح', 'success');
        }
        
        function toggleMusterPoint(point) {
            // Toggle selection for muster points in main view
            const card = document.getElementById('muster' + point);
            card.classList.toggle('selected');
        }

        /************* EOC PATCH BLOCK *************/
        const EOC_WEB = (typeof WEB_APP_URL !== 'undefined') ? WEB_APP_URL : '';

        function jsonp(action, params = {}) {
            return new Promise((resolve, reject) => {
                const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
                params.action = action;
                params.callback = cb;

                const qs = new URLSearchParams(params).toString();
                const s = document.createElement("script");
                s.src = EOC_WEB + "?" + qs;

                window[cb] = (data) => { cleanup(); resolve(data); };
                s.onerror = () => { cleanup(); reject(new Error("jsonp failed")); };

                function cleanup() {
                    try { delete window[cb]; } catch(e) {}
                    if (s.parentNode) s.parentNode.removeChild(s);
                }
                document.body.appendChild(s);
            });
        }

        function updateSelectedAreasDisplay() {
            const container = document.getElementById('selectedAreas');
            if (!container) return;
        }

        function highlightEmergencyLocation(locationText) {
            document.querySelectorAll('.dept-card, .dept-toggle-btn')
                .forEach(el => el.classList.remove('emergency-highlight'));

            if (!locationText) return;

            document.querySelectorAll('.dept-card').forEach(card => {
                const label = card.textContent.trim();
                if (label && locationText.includes(label)) {
                    card.classList.add('emergency-highlight');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });

            document.querySelectorAll('.dept-toggle-btn').forEach(btn => {
                const label = btn.textContent.trim();
                if (label && locationText.includes(label)) btn.classList.add('emergency-highlight');
            });
        }

        function applyEvacVisual(scope) {
            const floors = [
                { n: 2, name: 'floor2-status' },
                { n: 1, name: 'floor1-status' },
                { n: 0, name: 'floor0-status' },
            ];

            floors.forEach(f => {
                const el = document.getElementById(f.name);
                if (!el) return;

                const shouldEvac =
                    scope.kind === 'building' ||
                    (scope.kind === 'floor2' && f.n === 2) ||
                    (scope.kind === 'floor1' && f.n === 1) ||
                    (scope.kind === 'floor0' && f.n === 0);

                if (shouldEvac) {
                    el.className = 'floor-status evacuating';
                    el.textContent = 'إخلاء';
                    const floorBox = document.querySelector(`.floor[data-floor="${f.n}"]`);
                    if (floorBox) floorBox.classList.add('evacuating');
                } else {
                    el.className = 'floor-status safe';
                    el.textContent = 'آمن';
                    const floorBox = document.querySelector(`.floor[data-floor="${f.n}"]`);
                    if (floorBox) floorBox.classList.remove('evacuating');
                }
            });
        }

        async function updateStatus(reportId, newStatus) {
            const responder = prompt('اسم المستجيب:');
            if (!responder) return;
            const actionNotes = prompt('ملاحظات الإجراء (اختياري):') || '';

            try {
                const data = await jsonp('updateEmergencyStatus', {
                    reportId,
                    status: newStatus,
                    responder,
                    actionNotes
                });

                if (data && data.ok) {
                    showToast('تم تحديث الحالة بنجاح', 'success');
                    loadReports();
                } else {
                    showToast('فشل التحديث: ' + (data.error || ''), 'error');
                }
            } catch (e) {
                showToast('خطأ في الاتصال', 'error');
            }
        }

        async function loadReportsJSONP() {
            const container = document.getElementById('reportsLog');
            try {
                const data = await jsonp('getEmergencyReports', { limit: 20 });

                if (!data.ok) throw new Error(data.error || 'API error');

                const reports = data.reports || [];
                if (!reports.length) {
                    container.innerHTML = '<div class="no-reports"><i class="fas fa-check-circle"></i><p>لا توجد بلاغات حالياً</p></div>';
                    return;
                }

                const newOnes = reports.filter(r => r.status === 'جديد' && !window.alertedReportIds.has(r.id));
                if (newOnes.length) {
                    newOnes.forEach(r => window.alertedReportIds.add(r.id));
                    showNewReportAlert(newOnes[0]);
                }

                container.innerHTML = reports.slice(0, 10).map(report => {
                    const statusClass = report.status === 'جديد' ? 'new'
                        : report.status === 'قيد المعالجة' ? 'pending' : 'resolved';

                    const typeIcon = getReportTypeIcon(report.type);

                    return `
                        <div class="report-item ${statusClass}" data-report-id="${report.id}">
                            <div class="report-header">
                                <span class="report-type"><i class="${typeIcon}"></i> ${report.type}</span>
                                <span class="report-status ${statusClass}">${report.status}</span>
                            </div>
                            <div class="report-location"><i class="fas fa-map-marker-alt"></i> ${report.location}</div>
                            <div class="report-time"><i class="fas fa-clock"></i> ${report.date} - ${report.time}</div>
                            ${report.notes ? '<div class="report-notes"><i class="fas fa-sticky-note"></i> ' + report.notes + '</div>' : ''}
                            <div class="report-actions">
                                ${getActionButtons(report)}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="error-state"><i class="fas fa-wifi" style="color: var(--danger);"></i><p>تعذر الاتصال بخادم البلاغات</p><small>تأكد من Web App Deployment</small></div>';
            }
        }

        async function loadDrillLogJSONP() {
            const container = document.getElementById('drillLog');
            try {
                const data = await jsonp('getEocDrills', { limit: 10 });
                if (data.ok && data.drills && data.drills.length) {
                    container.innerHTML = data.drills.map(d => `
                        <div class="drill-item">
                            <div class="drill-info">
                                <i class="fas fa-clipboard-check" style="color: var(--secondary)"></i>
                                <span>${d.type || 'تمرين'}</span>
                            </div>
                            <span class="drill-date">${d.date || ''}</span>
                            <span class="drill-result success">${d.result || 'ناجح'}</span>
                        </div>
                    `).join('');
                } else {
                    showDefaultDrills(container);
                }
            } catch (e) {
                showDefaultDrills(container);
            }
        }

        async function sendCommandToBackend(commandData) {
            await jsonp('setActiveCommand', {
                commandId: 'CMD-' + Date.now(),
                responseType: commandData.type,
                reportType: commandData.reportType,
                location: commandData.location,
                muster: commandData.muster || '',
                issuedBy: 'EOC',
                reportId: commandData.reportId || '',
                mode: 'real'
            });
        }

        async function clearCommandFromBackend() {
            await jsonp('clearActiveCommand', {});
        }

        async function pollActiveCommand() {
            try {
                const data = await jsonp('getActiveCommand', {});
                if (data.ok && data.active && data.command) {
                    console.log('Active command:', data.command);
                }
            } catch(e) {}
        }
        /************* END PATCH *************/

        /* ===== EOC PATCH v2 ===== */
        (function () {
            if (window.__EOC_PATCH_V2__) return;
            window.__EOC_PATCH_V2__ = true;

            if (!window.WEB_APP_URL) {
                console.error('WEB_APP_URL is missing');
                return;
            }

            const css = `
            .dept-card.emergency-highlight, .dept-toggle-btn.emergency-highlight{
                background: linear-gradient(135deg,#DC143C,#ff4444) !important;
                color:#fff !important;
                border:3px solid #fff !important;
                box-shadow:0 0 30px rgba(220,20,60,.7) !important;
                animation: emergencyBlink .6s ease-in-out infinite alternate;
            }`;
            const st = document.createElement('style');
            st.textContent = css;
            document.head.appendChild(st);

            window.__eocJsonp = function(action, params = {}) {
                return new Promise((resolve, reject) => {
                    const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
                    params.action = action;
                    params.callback = cb;

                    const s = document.createElement("script");
                    s.src = window.WEB_APP_URL + "?" + new URLSearchParams(params).toString();

                    window[cb] = (data) => { cleanup(); resolve(data); };
                    s.onerror = () => { cleanup(); reject(new Error("jsonp failed")); };

                    function cleanup() {
                        try { delete window[cb]; } catch(e) {}
                        if (s.parentNode) s.parentNode.removeChild(s);
                    }
                    document.body.appendChild(s);
                });
            };

            function ensureSelectedAreasContainer() {
                if (document.getElementById('selectedAreas')) return;
                const counter = document.getElementById('selectionCounter');
                if (!counter) return;
                const div = document.createElement('div');
                div.id = 'selectedAreas';
                div.style.marginTop = '12px';
                div.style.opacity = '0.95';
                div.style.fontSize = '0.95rem';
                counter.insertAdjacentElement('afterend', div);
            }

            window.updateSelectedAreasDisplay = function() {
                ensureSelectedAreasContainer();
                const container = document.getElementById('selectedAreas');
                if (!container || !window.evacState) return;

                if (window.evacState.areas.size === 0) {
                    container.innerHTML = '<div style="opacity:.7">لم يتم تحديد أي مكان</div>';
                    return;
                }

                let html = '<div style="margin-bottom:6px;color:#c9a962;font-weight:700">المحدد:</div>';
                window.evacState.areas.forEach(area => {
                    const name = (window.deptNames && window.deptNames[area]) ? window.deptNames[area] : area;
                    html += '<span style="display:inline-block;margin:4px;padding:6px 12px;border:1px solid rgba(255,255,255,.2);border-radius:999px;background:rgba(0,0,0,.25)">' + name + '</span>';
                });
                container.innerHTML = html;
            };

            window.highlightEmergencyLocation = function(locationText) {
                document.querySelectorAll('.dept-card, .dept-toggle-btn')
                    .forEach(el => el.classList.remove('emergency-highlight'));

                if (!locationText) return;

                document.querySelectorAll('.dept-card').forEach(card => {
                    const label = card.textContent.trim();
                    if (label && locationText.includes(label)) card.classList.add('emergency-highlight');
                });
                document.querySelectorAll('.dept-toggle-btn').forEach(btn => {
                    const label = btn.textContent.trim();
                    if (label && locationText.includes(label)) btn.classList.add('emergency-highlight');
                });
            };

            const lastAlertKey = 'eoc_last_alerted';
            const remembered = localStorage.getItem(lastAlertKey);
            if (remembered) window.alertedReportIds = new Set(JSON.parse(remembered));

            const origLoadReports = window.loadReportsJSONP;
            window.loadReportsJSONP = async function() {
                const container = document.getElementById('reportsLog');
                try {
                    const data = await window.__eocJsonp('getEmergencyReports', { limit: 20 });
                    if (!data.ok) throw new Error(data.error || 'API error');

                    const reports = data.reports || [];
                    if (!reports.length) {
                        container.innerHTML = '<div class="no-reports"><i class="fas fa-check-circle"></i><p>لا توجد بلاغات حالياً</p></div>';
                        return;
                    }

                    const newOnes = reports.filter(r => r.status === 'جديد' && !window.alertedReportIds.has(r.id));
                    if (newOnes.length) {
                        newOnes.forEach(r => window.alertedReportIds.add(r.id));
                        localStorage.setItem(lastAlertKey, JSON.stringify(Array.from(window.alertedReportIds)));

                        const t = String(newOnes[0].type || '');
                        if (t.includes('حريق') || t.includes('دخان')) window.showScenario && window.showScenario('fire');
                        else if (t.includes('كهرباء')) window.showScenario && window.showScenario('power');
                        else if (t.includes('عدوى')) window.showScenario && window.showScenario('outbreak');
                        else if (t.includes('إخلاء')) window.showScenario && window.showScenario('evacuate');

                        window.showNewReportAlert && window.showNewReportAlert(newOnes[0]);
                    }

                    container.innerHTML = reports.slice(0, 10).map(report => {
                        const statusClass = report.status === 'جديد' ? 'new'
                            : report.status === 'قيد المعالجة' ? 'pending' : 'resolved';

                        const typeIcon = window.getReportTypeIcon ? window.getReportTypeIcon(report.type) : 'fas fa-exclamation-triangle';
                        return `
                            <div class="report-item ${statusClass}" data-report-id="${report.id}">
                                <div class="report-header">
                                    <span class="report-type"><i class="${typeIcon}"></i> ${report.type}</span>
                                    <span class="report-status ${statusClass}">${report.status}</span>
                                </div>
                                <div class="report-location"><i class="fas fa-map-marker-alt"></i> ${report.location}</div>
                                <div class="report-time"><i class="fas fa-clock"></i> ${report.date} - ${report.time}</div>
                                ${report.notes ? `<div class="report-notes"><i class="fas fa-sticky-note"></i> ${report.notes}</div>` : ''}
                                <div class="report-actions">${window.getActionButtons ? window.getActionButtons(report) : ''}</div>
                            </div>
                        `;
                    }).join('');
                } catch(e) {
                    console.error(e);
                    container.innerHTML = '<div class="error-state"><i class="fas fa-wifi" style="color: var(--danger);"></i><p>تعذر الاتصال بخادم البلاغات</p></div>';
                }
            };

            window.updateStatus = async function(reportId, newStatus) {
                const responder = prompt('اسم المستجيب:');
                if (!responder) return;
                const actionNotes = prompt('ملاحظات الإجراء (اختياري):') || '';

                const data = await window.__eocJsonp('updateEmergencyReportStatus', {
                    reportId, status: newStatus, responder, actionNotes
                });

                if (data && data.ok) {
                    window.showToast && window.showToast('تم تحديث الحالة بنجاح', 'success');
                    window.loadReportsJSONP();
                } else {
                    window.showToast && window.showToast('فشل التحديث', 'error');
                }
            };

            window.sendCommandToBackend = async function(commandData) {
                await window.__eocJsonp('setActiveCommand', {
                    responseType: commandData.type,
                    reportType: commandData.reportType,
                    location: commandData.location,
                    muster: commandData.muster || ''
                });
            };

            window.clearCommandFromBackend = async function() {
                await window.__eocJsonp('clearActiveCommand', {});
            };

            window.activateEvacuation = function() {
                if (!window.evacState || !window.evacState.type || window.evacState.areas.size === 0 || !window.evacState.muster) {
                    alert('يرجى استكمال جميع الخطوات');
                    return;
                }

                const areas = Array.from(window.evacState.areas).map(a => (window.deptNames && window.deptNames[a]) || a);
                let location = 'مناطق محددة: ' + areas.join('، ');

                if (window.floorDepts) {
                    const all = Object.values(window.floorDepts).flat();
                    const allSelected = all.every(d => window.evacState.areas.has(d));
                    if (allSelected) location = 'المبنى بالكامل';
                }

                const commandData = {
                    type: 'full_evacuation',
                    reportType: (window.typeLabels && window.typeLabels[window.evacState.type]) || 'إخلاء',
                    location,
                    muster: (window.musterInfo && window.musterInfo[window.evacState.muster]) || '',
                    reportId: (window.currentReport && window.currentReport.id) ? window.currentReport.id : ''
                };

                window.closeEvacuationPanel && window.closeEvacuationPanel();
                window.showCommandScreen && window.showCommandScreen(commandData);
                window.sendCommandToBackend(commandData);

                if (window.currentReport && window.currentReport.id) {
                    window.updateStatus(window.currentReport.id, 'قيد المعالجة');
                }
            };

            setTimeout(() => {
                window.loadDrillLogJSONP && window.loadDrillLogJSONP();
                window.loadReportsJSONP && window.loadReportsJSONP();
            }, 300);

            setInterval(() => window.loadReportsJSONP && window.loadReportsJSONP(), 5000);
        })();
        /* ===== END PATCH v2 ===== */

        document.addEventListener('DOMContentLoaded', () => {
            loadDrillLogJSONP();
            loadReportsJSONP();
            
            setInterval(loadReportsJSONP, 5000);
            setInterval(pollActiveCommand, 5000);
        });

        /* ===== نظام التدريب العملي ===== */
        const traineesData = [
            { id: 1, name: 'أحمد محمد علي', dept: 'الاستقبال' },
            { id: 2, name: 'فاطمة عبدالله', dept: 'التمريض' },
            { id: 3, name: 'محمد خالد', dept: 'المختبر' },
            { id: 4, name: 'نورة سعيد', dept: 'الصيدلية' },
            { id: 5, name: 'عبدالرحمن أحمد', dept: 'الأشعة' },
            { id: 6, name: 'سارة محمود', dept: 'الطوارئ' },
            { id: 7, name: 'خالد عمر', dept: 'العلاج الطبيعي' },
            { id: 8, name: 'مريم حسن', dept: 'النساء والولادة' },
            { id: 9, name: 'يوسف إبراهيم', dept: 'العظام' },
            { id: 10, name: 'هدى علي', dept: 'الأسنان' },
            { id: 11, name: 'عمر سالم', dept: 'الباطنية' },
            { id: 12, name: 'ليلى محمد', dept: 'الإدارة' }
        ];

        const trainingScenarios = {
            fire: {
                name: 'حريق',
                title: 'خطوات الاستجابة للحريق',
                icon: 'fas fa-fire',
                steps: [
                    { num: 1, icon: '🔥', text: '<strong>R - Rescue (إنقاذ):</strong> أنقذ أي شخص في خطر مباشر' },
                    { num: 2, icon: '🚨', text: '<strong>A - Alarm (إنذار):</strong> فعّل زر الإنذار واتصل بـ 998' },
                    { num: 3, icon: '🚪', text: '<strong>C - Confine (احتواء):</strong> أغلق الأبواب لمنع انتشار الدخان' },
                    { num: 4, icon: '🏃', text: '<strong>E - Extinguish/Evacuate:</strong> أطفئ الحريق إن أمكن أو أخلِ المبنى' },
                    { num: 5, icon: '⚠️', text: '<strong>تحذير هام:</strong> لا تستخدم المصعد - استخدم الدرج فقط!', danger: true },
                    { num: 6, icon: '🧯', text: '<strong>P - Pull:</strong> اسحب مسمار الأمان من الطفاية' },
                    { num: 7, icon: '🎯', text: '<strong>A - Aim:</strong> صوّب الخرطوم نحو قاعدة النار' },
                    { num: 8, icon: '✊', text: '<strong>S - Squeeze:</strong> اضغط على المقبض' },
                    { num: 9, icon: '↔️', text: '<strong>S - Sweep:</strong> حرّك يميناً ويساراً' }
                ]
            },
            power: {
                name: 'انقطاع كهرباء',
                title: 'خطوات التعامل مع انقطاع الكهرباء',
                icon: 'fas fa-bolt',
                steps: [
                    { num: 1, icon: '⚡', text: '<strong>التحقق الفوري:</strong> تأكد من تشغيل المولد الاحتياطي تلقائياً' },
                    { num: 2, icon: '🔋', text: '<strong>الأنظمة الحرجة:</strong> تحقق من UPS وأجهزة الإنعاش' },
                    { num: 3, icon: '💊', text: '<strong>الأدوية:</strong> افحص ثلاجات الأدوية واللقاحات' },
                    { num: 4, icon: '🛠️', text: '<strong>إبلاغ الصيانة:</strong> تواصل مع فريق الصيانة فوراً' },
                    { num: 5, icon: '👨‍⚕️', text: '<strong>المرضى:</strong> طمئن المرضى وأمّن الأجهزة الطبية' },
                    { num: 6, icon: '📝', text: '<strong>التوثيق:</strong> سجّل وقت الانقطاع والإجراءات المتخذة' }
                ]
            },
            water: {
                name: 'تسرب مياه',
                title: 'خطوات التعامل مع تسرب المياه',
                icon: 'fas fa-tint',
                steps: [
                    { num: 1, icon: '⚠️', text: '<strong>السلامة أولاً:</strong> أبعد الأشخاص عن منطقة التسرب' },
                    { num: 2, icon: '🔌', text: '<strong>الكهرباء:</strong> افصل التيار عن المنطقة المتأثرة', danger: true },
                    { num: 3, icon: '🚰', text: '<strong>إيقاف المصدر:</strong> أغلق محبس المياه الرئيسي' },
                    { num: 4, icon: '📞', text: '<strong>الإبلاغ:</strong> أبلغ فريق الصيانة والإدارة' },
                    { num: 5, icon: '🪣', text: '<strong>الاحتواء:</strong> استخدم الممسحات والدلاء لاحتواء المياه' },
                    { num: 6, icon: '📄', text: '<strong>التوثيق:</strong> سجّل الحادثة والأضرار' }
                ]
            },
            medical: {
                name: 'إغماء/إصابة',
                title: 'خطوات التعامل مع حالة إغماء أو إصابة',
                icon: 'fas fa-heartbeat',
                steps: [
                    { num: 1, icon: '🏥', text: '<strong>التقييم:</strong> تحقق من وعي المصاب والتنفس' },
                    { num: 2, icon: '📢', text: '<strong>النداء:</strong> اطلب المساعدة ونادِ على الطبيب' },
                    { num: 3, icon: '📞', text: '<strong>الإسعاف:</strong> اتصل بـ 997 إذا لزم الأمر' },
                    { num: 4, icon: '💓', text: '<strong>الإنعاش:</strong> ابدأ CPR إذا لم يكن هناك نبض', danger: true },
                    { num: 5, icon: '🛏️', text: '<strong>الوضعية:</strong> ضع المصاب في وضع الإفاقة إذا كان فاقداً للوعي' },
                    { num: 6, icon: '📝', text: '<strong>التوثيق:</strong> سجّل الحادثة والإجراءات المتخذة' }
                ]
            },
            infection: {
                name: 'تفشي عدوى',
                title: 'خطوات التعامل مع تفشي العدوى',
                icon: 'fas fa-virus',
                steps: [
                    { num: 1, icon: '🔒', text: '<strong>العزل الفوري:</strong> اعزل الحالة المشتبهة فوراً' },
                    { num: 2, icon: '📞', text: '<strong>الإبلاغ:</strong> أبلغ مكافحة العدوى و937' },
                    { num: 3, icon: '🧤', text: '<strong>الحماية:</strong> ارتدِ معدات الوقاية الشخصية (PPE)', danger: true },
                    { num: 4, icon: '👥', text: '<strong>تتبع المخالطين:</strong> حدد جميع المخالطين للحالة' },
                    { num: 5, icon: '🧹', text: '<strong>التطهير:</strong> طهّر المنطقة المتأثرة بالكامل' },
                    { num: 6, icon: '👁️', text: '<strong>المراقبة:</strong> راقب الأعراض لدى المخالطين' }
                ]
            }
        };

        let selectedTrainingScenario = null;
        let selectedTrainees = new Set();
        let sessionTimer = null;
        let sessionSeconds = 0;
        let allTrainingSessions = [];
        let allReportsData = [];

        function openTrainingModal() {
            document.getElementById('trainingModal').classList.add('active');
            renderTraineesGrid();
            sessionSeconds = 0;
            updateTimerDisplay();
            startSessionTimer();
        }

        function closeTrainingModal() {
            document.getElementById('trainingModal').classList.remove('active');
            stopSessionTimer();
            resetTrainingForm();
        }

        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                sessionSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }

        function updateTimerDisplay() {
            const h = String(Math.floor(sessionSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((sessionSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(sessionSeconds % 60).padStart(2, '0');
            document.getElementById('sessionTimerDisplay').textContent = `${h}:${m}:${s}`;
        }

        function renderTraineesGrid() {
            const grid = document.getElementById('traineesGrid');
            grid.innerHTML = traineesData.map(t => `
                <div class="trainee-card ${selectedTrainees.has(t.id) ? 'selected' : ''}" onclick="toggleTrainee(${t.id})">
                    <div class="check-box">${selectedTrainees.has(t.id) ? '<i class="fas fa-check"></i>' : ''}</div>
                    <div class="trainee-info">
                        <div class="trainee-name">${t.name}</div>
                        <div class="trainee-dept">${t.dept}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleTrainee(id) {
            if (selectedTrainees.has(id)) {
                selectedTrainees.delete(id);
            } else {
                selectedTrainees.add(id);
            }
            renderTraineesGrid();
            document.getElementById('traineesCount').textContent = selectedTrainees.size;
            updateSaveButton();
        }

        function selectTrainingScenario(scenarioKey) {
            selectedTrainingScenario = scenarioKey;
            document.querySelectorAll('.scenario-select-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.scenario-select-btn.${scenarioKey}`).classList.add('active');
            
            const scenario = trainingScenarios[scenarioKey];
            const box = document.getElementById('trainingInstructionsBox');
            document.getElementById('trainingInstrTitle').textContent = scenario.title;
            
            document.getElementById('trainingInstrContent').innerHTML = scenario.steps.map(step => `
                <div class="instr-step ${step.danger ? 'danger-step' : ''}">
                    <span class="step-num">${step.num}</span>
                    <span class="step-icon">${step.icon}</span>
                    <span class="step-text">${step.text}</span>
                </div>
            `).join('');
            
            box.classList.add('active');
            updateSaveButton();
        }

        function updateSaveButton() {
            const trainerName = document.getElementById('trainerNameInput').value.trim();
            const canSave = selectedTrainingScenario && selectedTrainees.size > 0 && trainerName;
            document.getElementById('saveTrainingBtn').disabled = !canSave;
        }

        document.getElementById('trainerNameInput')?.addEventListener('input', updateSaveButton);

        async function saveTrainingSession() {
            const trainerName = document.getElementById('trainerNameInput').value.trim();
            if (!selectedTrainingScenario || selectedTrainees.size === 0 || !trainerName) {
                showToast('يرجى استكمال جميع البيانات', 'error');
                return;
            }

            const traineesNames = Array.from(selectedTrainees).map(id => 
                traineesData.find(t => t.id === id)?.name || ''
            ).filter(Boolean);

            const sessionData = {
                date: new Date().toLocaleDateString('ar-SA'),
                time: new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
                scenario: trainingScenarios[selectedTrainingScenario].name,
                trainer: trainerName,
                traineesCount: selectedTrainees.size,
                trainees: traineesNames.join('، '),
                duration: document.getElementById('sessionTimerDisplay').textContent
            };

            try {
                const data = await window.__eocJsonp('saveTrainingSession', sessionData);
                if (data && data.ok) {
                    showToast('تم حفظ جلسة التدريب بنجاح!', 'success');
                    closeTrainingModal();
                    loadDrillLogJSONP();
                } else {
                    showToast('خطأ في حفظ الجلسة', 'error');
                }
            } catch(e) {
                console.error(e);
                showToast('تم حفظ الجلسة محلياً', 'success');
                closeTrainingModal();
            }
        }

        function resetTrainingForm() {
            selectedTrainingScenario = null;
            selectedTrainees.clear();
            sessionSeconds = 0;
            document.getElementById('trainerNameInput').value = '';
            document.querySelectorAll('.scenario-select-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('trainingInstructionsBox').classList.remove('active');
            document.getElementById('traineesCount').textContent = '0';
            document.getElementById('saveTrainingBtn').disabled = true;
        }

        /* سجل التدريب */
        function openTrainingLogModal() {
            document.getElementById('trainingLogModal').classList.add('active');
            loadTrainingLogData();
        }

        function closeTrainingLogModal() {
            document.getElementById('trainingLogModal').classList.remove('active');
        }

        async function loadTrainingLogData() {
            const tbody = document.getElementById('trainingLogBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';

            try {
                const data = await window.__eocJsonp('getDrillLog', { limit: 50 });
                if (data && data.ok && data.drills) {
                    allTrainingSessions = data.drills;
                    renderTrainingLogTable(allTrainingSessions);
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;">لا توجد جلسات تدريب</td></tr>';
                }
            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--danger);">خطأ في تحميل البيانات</td></tr>';
            }
        }

        function renderTrainingLogTable(sessions) {
            const tbody = document.getElementById('trainingLogBody');
            if (!sessions.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;">لا توجد جلسات تدريب</td></tr>';
                return;
            }

            tbody.innerHTML = sessions.map((s, i) => {
                const scenarioClass = getScenarioClass(s.scenario || s.type);
                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${s.date || '-'}</td>
                        <td>${s.time || '-'}</td>
                        <td><span class="scenario-tag ${scenarioClass}">${s.scenario || s.type || '-'}</span></td>
                        <td>${s.trainer || s.coordinator || '-'}</td>
                        <td>${s.traineesCount || s.participants || '-'}</td>
                        <td>${s.duration || '-'}</td>
                        <td><button class="view-btn" onclick="showTrainingDetails(${i})"><i class="fas fa-eye"></i></button></td>
                    </tr>
                `;
            }).join('');
        }

        function getScenarioClass(scenario) {
            if (!scenario) return '';
            const s = scenario.toLowerCase();
            if (s.includes('حريق') || s.includes('fire')) return 'fire';
            if (s.includes('كهرباء') || s.includes('power')) return 'power';
            if (s.includes('مياه') || s.includes('water')) return 'water';
            if (s.includes('إغماء') || s.includes('إصابة') || s.includes('medical')) return 'medical';
            if (s.includes('عدوى') || s.includes('infection')) return 'infection';
            return '';
        }

        function filterTrainingLog() {
            const from = document.getElementById('trainingLogFromDate').value;
            const to = document.getElementById('trainingLogToDate').value;
            
            let filtered = [...allTrainingSessions];
            if (from) filtered = filtered.filter(s => s.date >= from);
            if (to) filtered = filtered.filter(s => s.date <= to);
            
            renderTrainingLogTable(filtered);
        }

        function showTrainingDetails(index) {
            const session = allTrainingSessions[index];
            if (!session) return;

            const content = document.getElementById('trainingDetailsContent');
            content.innerHTML = `
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <h3 style="color: var(--secondary); margin-bottom: 15px;"><i class="fas fa-calendar"></i> بيانات الجلسة</h3>
                    <p><strong>التاريخ:</strong> ${session.date || '-'}</p>
                    <p><strong>الوقت:</strong> ${session.time || '-'}</p>
                    <p><strong>السيناريو:</strong> ${session.scenario || session.type || '-'}</p>
                    <p><strong>المدة:</strong> ${session.duration || '-'}</p>
                    <p><strong>المدرب:</strong> ${session.trainer || session.coordinator || '-'}</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px;">
                    <h3 style="color: var(--secondary); margin-bottom: 15px;"><i class="fas fa-users"></i> المتدربون (${session.traineesCount || session.participants || 0})</h3>
                    <p>${session.trainees || session.notes || 'لا توجد أسماء'}</p>
                </div>
            `;

            document.getElementById('trainingDetailsModal').classList.add('active');
        }

        /* سجل البلاغات */
        function openReportsLogModal() {
            document.getElementById('reportsLogModal').classList.add('active');
            loadReportsLogData();
        }

        function closeReportsLogModal() {
            document.getElementById('reportsLogModal').classList.remove('active');
        }

        async function loadReportsLogData() {
            const tbody = document.getElementById('reportsLogBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';

            try {
                const data = await window.__eocJsonp('getEmergencyReports', { limit: 100 });
                if (data && data.ok && data.reports) {
                    allReportsData = data.reports;
                    renderReportsLogTable(allReportsData);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;">لا توجد بلاغات</td></tr>';
                }
            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--danger);">خطأ في تحميل البيانات</td></tr>';
            }
        }

        function renderReportsLogTable(reports) {
            const tbody = document.getElementById('reportsLogBody');
            if (!reports.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;">لا توجد بلاغات</td></tr>';
                return;
            }

            tbody.innerHTML = reports.map(r => {
                const statusClass = r.status === 'جديد' ? 'new' : r.status === 'قيد المعالجة' ? 'pending' : 'resolved';
                const scenarioClass = getScenarioClass(r.type);
                return `
                    <tr>
                        <td>${r.id || '-'}</td>
                        <td>${r.date || '-'}</td>
                        <td>${r.time || '-'}</td>
                        <td><span class="scenario-tag ${scenarioClass}">${r.type || '-'}</span></td>
                        <td>${r.location || '-'}</td>
                        <td><span class="status-tag ${statusClass}">${r.status || '-'}</span></td>
                        <td>
                            ${r.status !== 'تم الحل' ? 
                                `<button class="view-btn" onclick="updateStatus('${r.id}', '${r.status === 'جديد' ? 'قيد المعالجة' : 'تم الحل'}')">
                                    ${r.status === 'جديد' ? 'معالجة' : 'إغلاق'}
                                </button>` : 
                                '<span style="color:var(--success);"><i class="fas fa-check"></i></span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterReportsLog() {
            const from = document.getElementById('reportsLogFromDate').value;
            const to = document.getElementById('reportsLogToDate').value;
            const status = document.getElementById('reportsStatusFilter').value;
            
            let filtered = [...allReportsData];
            if (from) filtered = filtered.filter(r => r.date >= from);
            if (to) filtered = filtered.filter(r => r.date <= to);
            if (status) filtered = filtered.filter(r => r.status === status);
            
            renderReportsLogTable(filtered);
        }
    </script>
</body>
</html>
