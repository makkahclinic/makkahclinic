<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ูุฑูุฒ ุงูููุงุฏุฉ ูุงูุชุญูู - EOC | ูุฌูุน ููุฉ ุงูุทุจู</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#1e3a5f;
      --secondary:#c9a962;
      --danger:#DC143C;
      --success:#10b981;
      --warning:#f59e0b;
      --info:#3b82f6;
      --muted:#94a3b8;
      --bg1:#0f172a;
      --bg2:#1e3a5f;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Tajawal',sans-serif;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh;color:#fff;
    }

    .header{
      background:rgba(30,58,95,.95);
      backdrop-filter: blur(10px);
      padding:15px 30px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:2px solid var(--secondary);
      position:sticky;top:0;z-index:100;
      gap:12px;flex-wrap:wrap;
    }
    .header-title{display:flex;align-items:center;gap:15px}
    .header-title img{height:50px}
    .header-title h1{font-size:1.35rem;color:#fff}
    .header-title h1 span{color:var(--secondary)}
    .header-status{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .back-btn,.report-emergency-btn{
      text-decoration:none;display:flex;align-items:center;gap:8px;
      padding:10px 18px;border-radius:10px;font-weight:700;transition:.2s;
    }
    .back-btn{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
    }
    .back-btn:hover{background:var(--secondary);color:var(--primary)}
    .report-emergency-btn{
      background:linear-gradient(135deg,var(--danger),#b91c1c);
      color:#fff;border:0;
      box-shadow:0 0 0 0 rgba(220,20,60,.35);
      animation:pulseBtn 2s infinite;
    }
    .report-emergency-btn:hover{transform:scale(1.02);box-shadow:0 10px 30px rgba(220,20,60,.35)}
    @keyframes pulseBtn{
      0%,100%{box-shadow:0 0 0 0 rgba(220,20,60,.35)}
      50%{box-shadow:0 0 0 10px rgba(220,20,60,0)}
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}

    .status-badge{
      display:flex;align-items:center;gap:8px;
      padding:8px 14px;border-radius:999px;font-weight:800;font-size:.95rem;
      border:1px solid rgba(16,185,129,.45);
      color:var(--success);
      background:rgba(16,185,129,.12);
      cursor:pointer;user-select:none;
    }
    .status-badge:hover{filter:brightness(1.06)}
    .status-badge.alert{
      border-color:rgba(220,20,60,.6);
      color:var(--danger);
      background:rgba(220,20,60,.14);
      animation:pulse 1.5s infinite;
    }
    .status-badge.alert:hover{filter:brightness(1.10)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

    .main-container{
      display:grid;
      grid-template-columns: 410px 1fr;
      gap:18px;
      padding:18px;
      max-width:1700px;
      margin:0 auto;
    }
    @media(max-width:1024px){.main-container{grid-template-columns:1fr}}

    .panel-card{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:18px;
      padding:18px;
    }
    .section-title{
      display:flex;align-items:center;gap:10px;
      color:var(--secondary);
      font-weight:900;font-size:1.15rem;
      margin-bottom:14px;
    }

    /* Left column - control */
    .control-panel{display:flex;flex-direction:column;gap:14px}
    .quick-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.quick-actions{grid-template-columns:1fr}}
    .quick-action{
      background:rgba(255,255,255,.06);
      border:2px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px 12px;
      cursor:pointer;
      transition:.2s;
      text-align:center;
    }
    .quick-action:hover{
      transform:translateY(-2px);
      border-color:var(--secondary);
      box-shadow:0 12px 30px rgba(201,169,98,.16);
    }
    .qa-ico{
      width:58px;height:58px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:1.6rem;margin:0 auto 10px;
    }
    .quick-action.training .qa-ico{background:linear-gradient(135deg,#f59e0b,#d97706);box-shadow:0 8px 22px rgba(245,158,11,.35)}
    .quick-action.training-log .qa-ico{background:linear-gradient(135deg,#3b82f6,#1d4ed8);box-shadow:0 8px 22px rgba(59,130,246,.35)}
    .quick-action.reports-log .qa-ico{background:linear-gradient(135deg,#DC143C,#b91c1c);box-shadow:0 8px 22px rgba(220,20,60,.35)}
    .qa-title{font-weight:900}
    .qa-sub{opacity:.75;font-size:.85rem;margin-top:3px}

    .activate-emergency-card{
      border:2px solid rgba(220,20,60,.7);
      background:linear-gradient(135deg, rgba(220,20,60,.22), rgba(185,28,28,.25));
    }
    .main-cancel-btn{
      background:linear-gradient(135deg,#6b7280,#4b5563);
      border:none;
      color:#fff;
      padding:16px 24px;
      border-radius:12px;
      font-size:1.1rem;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:all .3s;
    }
    .main-cancel-btn:hover{
      background:linear-gradient(135deg,#4b5563,#374151);
      transform:scale(1.02);
    }
    .main-activate-btn{
      width:100%;
      padding:18px;
      background:linear-gradient(135deg,#dc2626,#b91c1c);
      border:0;border-radius:16px;
      color:#fff;
      font-size:1.2rem;
      font-weight:900;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
      box-shadow:0 0 0 0 rgba(220,38,38,.35);
      animation:emPulse 2s infinite;
    }
    @keyframes emPulse{
      0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,.35)}
      50%{box-shadow:0 0 0 12px rgba(220,38,38,0)}
    }

    /* Scenario guide icons */
    .scenario-icons{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media(max-width:600px){.scenario-icons{grid-template-columns:repeat(2,1fr)}}
    .scenario-icon{
      background:rgba(255,255,255,.06);
      border:2px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px 10px;
      cursor:pointer;
      transition:.2s;
      text-align:center;
      font-weight:800;
      font-size:.9rem;
    }
    .scenario-icon i{display:block;font-size:1.6rem;margin-bottom:8px}
    .scenario-icon:hover{transform:scale(1.02);border-color:var(--secondary)}
    .scenario-icon.active{background:rgba(201,169,98,.12);border-color:var(--secondary)}
    .scenario-icon.fire i{color:#ef4444}
    .scenario-icon.power i{color:#f59e0b}
    .scenario-icon.water i{color:#0ea5e9}
    .scenario-icon.injury i{color:#10b981}
    .scenario-icon.outbreak i{color:#8b5cf6}
    .scenario-icon.bls i{color:#ec4899}

    /* Guide panel */
    .guide-wrap{display:none}
    .guide-wrap.active{display:block}
    .guide-title{
      display:flex;align-items:center;gap:10px;
      font-weight:900;font-size:1.05rem;margin-bottom:12px;
    }
    .guide-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:700px){.guide-grid{grid-template-columns:1fr}}
    .guide-box{
      border-radius:16px;
      padding:14px;
      border:2px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.22);
    }
    .guide-box.do{
      background:linear-gradient(135deg,#fef3c7,#fde68a);
      border-color:#f59e0b;
      color:#111827;
    }
    .guide-box.dont{
      background:linear-gradient(135deg,#fee2e2,#fecaca);
      border-color:#dc2626;
      color:#111827;
    }
    .guide-box h4{
      display:flex;align-items:center;gap:10px;
      font-weight:900;margin-bottom:10px;
    }
    .guide-step{
      display:flex;align-items:flex-start;gap:10px;
      padding:10px 10px;
      border-radius:12px;
      background:rgba(255,255,255,.7);
      margin-bottom:8px;
      border-right:5px solid rgba(0,0,0,.2);
    }
    .guide-step:last-child{margin-bottom:0}
    .guide-step .num{
      width:28px;height:28px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;flex:0 0 auto;
    }
    .guide-box.do .num{background:#f59e0b}
    .guide-box.dont .num{background:#dc2626}
    .guide-step .txt{font-weight:700;line-height:1.5}
    .guide-step i{margin-top:2px}

    /* Right column - building */
    .building-section{order:2}
    .building-view{display:flex;flex-direction:column;gap:12px}
    .floor{
      background:rgba(255,255,255,.04);
      border:2px solid rgba(255,255,255,.1);
      border-radius:16px;
      padding:14px;
      transition:.2s;cursor:pointer;
    }
    .floor:hover{border-color:var(--secondary);transform:translateX(-3px)}
    .floor.active{border-color:var(--secondary);background:rgba(201,169,98,.1)}
    .floor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .floor-name{display:flex;align-items:center;gap:10px;font-weight:900}
    .floor-icon{
      width:40px;height:40px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .floor-status{
      padding:6px 12px;border-radius:999px;font-weight:900;font-size:.85rem;
      background:rgba(16,185,129,.14);color:var(--success);
      border:1px solid rgba(16,185,129,.4);
    }
    .departments-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
    .dept-card{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:10px;
      text-align:center;
      font-weight:800;
      font-size:.85rem;
      transition:.2s;
      position:relative;
    }
    .dept-card i{display:block;font-size:1.2rem;margin-bottom:6px;color:var(--secondary)}
    .dept-card:hover{background:rgba(201,169,98,.18);border-color:var(--secondary)}
    .dept-card.emergency-highlight{
      background:linear-gradient(135deg,#DC143C,#ff4444) !important;
      border:3px solid #fff !important;
      box-shadow:0 0 30px rgba(220,20,60,.7) !important;
      color:#fff !important;
      animation: blink .6s ease-in-out infinite alternate;
    }
    .dept-card.emergency-highlight i{color:#fff}
    @keyframes blink{from{opacity:1}to{opacity:.75}}

    .muster-points{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .muster-card{
      background:rgba(16,185,129,.1);
      border:1px solid rgba(16,185,129,.35);
      border-radius:14px;
      padding:12px;
      text-align:center;
      cursor:pointer;
      transition:.2s;
    }
    .muster-card:hover{transform:translateY(-2px);border-color:var(--secondary)}
    .muster-card i{font-size:1.35rem;color:var(--success);margin-bottom:6px}
    .muster-card h4{font-weight:900;font-size:.95rem}
    .muster-card p{opacity:.75;font-size:.82rem;margin-top:2px}

    .activate-evacuation-btn{
      width:100%;
      margin-top:14px;
      padding:16px;
      border:0;border-radius:14px;
      background:linear-gradient(135deg,var(--danger),#b91c1c);
      color:#fff;
      font-weight:900;font-size:1.1rem;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:10px;
      box-shadow:0 10px 28px rgba(220,20,60,.25);
      transition:.2s;
    }
    .activate-evacuation-btn:hover{transform:scale(1.01);box-shadow:0 14px 34px rgba(220,20,60,.32)}

    /* mini lists */
    .mini-list{max-height:260px;overflow:auto}
    .mini-item{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
    }
    .mini-item:last-child{margin-bottom:0}
    .mini-row{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .pill{
      padding:4px 10px;border-radius:999px;font-weight:900;font-size:.78rem;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.2);
    }
    .pill.new{color:#fff;background:rgba(220,20,60,.25);border-color:rgba(220,20,60,.45)}
    .pill.pending{color:#111827;background:rgba(245,158,11,.35);border-color:rgba(245,158,11,.6)}
    .pill.closed{color:#fff;background:rgba(16,185,129,.25);border-color:rgba(16,185,129,.45)}

    /* Modals */
    .modal{
      display:none;
      position:fixed;inset:0;
      background:rgba(0,0,0,.92);
      z-index:30000;
      overflow:auto;
      padding:18px;
    }
    .modal.active{display:flex;align-items:flex-start;justify-content:center}
    .modal-card{
      width:min(1100px,96vw);
      margin:12px auto;
      background:linear-gradient(135deg,#1e3a5f,#0f172a);
      border-radius:20px;
      border:2px solid rgba(201,169,98,.65);
      padding:18px;
    }
    .modal-header{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding-bottom:12px;margin-bottom:14px;border-bottom:1px solid rgba(255,255,255,.16);
    }
    .modal-header h2{display:flex;align-items:center;gap:10px;color:var(--secondary);font-weight:900;font-size:1.25rem;flex-wrap:wrap}
    .close-modal{
      width:44px;height:44px;border-radius:50%;
      border:0;background:rgba(255,255,255,.1);color:#fff;cursor:pointer;
      display:flex;align-items:center;justify-content:center;font-size:1.15rem;
    }

    /* Activation modal (6 buttons) */
    .simple-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:650px){.simple-grid{grid-template-columns:repeat(2,1fr)}}
    .simple-btn{
      border-radius:16px;
      padding:18px 12px;
      cursor:pointer;
      border:2px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-family:'Tajawal',sans-serif;
      font-weight:900;
      display:flex;flex-direction:column;align-items:center;gap:10px;
      transition:.2s;
    }
    .simple-btn i{font-size:2.1rem}
    .simple-btn:hover{transform:scale(1.02);border-color:var(--secondary)}
    .simple-btn.fire{border-color:#ef4444}
    .simple-btn.fire i{color:#ef4444}
    .simple-btn.power{border-color:#f59e0b}
    .simple-btn.power i{color:#f59e0b}
    .simple-btn.water{border-color:#0ea5e9}
    .simple-btn.water i{color:#0ea5e9}
    .simple-btn.injury{border-color:#10b981}
    .simple-btn.injury i{color:#10b981}
    .simple-btn.outbreak{border-color:#8b5cf6}
    .simple-btn.outbreak i{color:#8b5cf6}
    .simple-btn.drill{
      border-color:#22c55e;background:rgba(34,197,94,.08)
    }
    .simple-btn.drill i{color:#22c55e}

    /* Response modal */
    .report-details{
      background:rgba(220,20,60,.12);
      border:1px solid rgba(220,20,60,.5);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
    }
    .detail-row{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08)}
    .detail-row:last-child{border-bottom:0}
    .detail-label{color:var(--muted);font-weight:800}
    .detail-value{font-weight:900}

    .response-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    @media(max-width:800px){.response-type-grid{grid-template-columns:1fr}}
    .rtype-btn{
      border-radius:16px;
      padding:16px 12px;
      border:2px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      text-align:center;
      transition:.2s;
      font-weight:900;
    }
    .rtype-btn i{font-size:2rem;display:block;margin-bottom:8px}
    .rtype-btn small{display:block;opacity:.75;margin-top:4px;font-weight:700}
    .rtype-btn:hover{border-color:var(--secondary);transform:scale(1.01)}
    .rtype-btn.selected{border-color:#fff}
    .rtype-btn.selected.full{background:linear-gradient(135deg,#dc2626,#b91c1c)}
    .rtype-btn.selected.team{background:linear-gradient(135deg,#f59e0b,#d97706);color:#111827}
    .rtype-btn.selected.iso{background:linear-gradient(135deg,#8b5cf6,#6d28d9)}

    .location-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:10px}
    .loc-btn{
      border-radius:14px;
      padding:12px 12px;
      border:2px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;align-items:center;gap:10px;
      transition:.2s;
    }
    .loc-btn:hover{border-color:var(--secondary)}
    .loc-btn.selected{background:rgba(34,197,94,.25);border-color:rgba(34,197,94,.75);color:#eafff5}
    .loc-custom{
      width:100%;
      margin-top:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:#fff;
      font-family:'Tajawal',sans-serif;
      font-weight:800;
      outline:none;
    }

    .muster-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .muster-btn{
      flex:1;min-width:240px;
      border-radius:14px;
      padding:12px 12px;
      border:2px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:10px;
      transition:.2s;
    }
    .muster-btn:hover{border-color:var(--secondary)}
    .muster-btn.selected{background:rgba(34,197,94,.25);border-color:rgba(34,197,94,.75)}

    .modal-actions{display:flex;gap:12px;margin-top:16px}
    .btn{
      border:0;border-radius:14px;
      padding:14px 14px;
      cursor:pointer;
      font-weight:900;
      font-family:'Tajawal',sans-serif;
      display:flex;align-items:center;justify-content:center;gap:10px;
      transition:.2s;
      width:100%;
    }
    .btn.secondary{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.18)}
    .btn.primary{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
    .btn.primary:disabled{opacity:.5;cursor:not-allowed}
    .btn.success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}
    .btn.warn{background:linear-gradient(135deg,var(--warning),#d97706);color:#111827}

    /* System Test Buttons */
    .system-test-btn{
      background:rgba(255,255,255,.06);
      border:2px solid rgba(255,255,255,.15);
      border-radius:12px;
      padding:12px 10px;
      cursor:pointer;
      text-align:center;
      color:#fff;
      font-family:'Tajawal',sans-serif;
      font-weight:700;
      transition:.2s;
    }
    .system-test-btn:hover{border-color:var(--secondary);transform:translateY(-2px)}
    .system-test-btn i{font-size:1.3rem;display:block;margin-bottom:6px;color:var(--secondary)}
    .system-test-btn span{display:block;font-size:.85rem}
    .system-test-btn .test-status{
      margin-top:6px;
      padding:4px 8px;
      border-radius:6px;
      font-size:.75rem;
      font-weight:900;
      background:rgba(148,163,184,.2);
      color:#94a3b8;
    }
    .system-test-btn .test-status.pass{background:rgba(16,185,129,.2);color:#10b981}
    .system-test-btn .test-status.fail{background:rgba(220,38,38,.2);color:#ef4444}
    .system-test-btn .test-status.testing{background:rgba(59,130,246,.2);color:#3b82f6}
    .system-test-btn.pass{border-color:rgba(16,185,129,.5)}
    .system-test-btn.fail{border-color:rgba(220,38,38,.5)}

    /* BLS Training Tabs */
    .bls-tab{
      flex:1;
      background:transparent;
      border:none;
      color:rgba(255,255,255,.6);
      padding:14px 20px;
      font-family:'Tajawal',sans-serif;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      transition:.2s;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .bls-tab:hover{background:rgba(255,255,255,.1);color:#fff}
    .bls-tab.active{background:rgba(236,72,153,.3);color:#fff;border-bottom:3px solid #ec4899}
    .bls-tab-content{animation:fadeIn .3s ease}
    @media(max-width:900px){
      .bls-tab{font-size:.85rem;padding:12px 10px}
      .bls-tab i{display:none}
      #tabCompressions > div{grid-template-columns:1fr !important}
      #tabAed > div > div{grid-template-columns:1fr !important}
    }

    /* Logs */
    .filters{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px
    }
    .filters input,.filters select{
      padding:10px 12px;border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.1);
      color:#fff;font-family:'Tajawal',sans-serif;font-weight:800;
    }
    .range-btns{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:9px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      font-family:'Tajawal',sans-serif;
      transition:.15s;
    }
    .chip:hover{border-color:var(--secondary)}
    .chip.active{background:rgba(201,169,98,.2);border-color:var(--secondary)}

    .table-wrap{overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.1)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:right;white-space:nowrap}
    th{background:rgba(59,130,246,.18);color:var(--secondary);font-weight:900}
    tr:hover td{background:rgba(255,255,255,.04)}
    .view-btn{
      background:var(--secondary);color:var(--primary);
      border:0;border-radius:10px;padding:8px 10px;
      cursor:pointer;font-weight:900;
      font-family:'Tajawal',sans-serif;
      display:inline-flex;align-items:center;gap:8px;
    }

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
      padding:12px 16px;border-radius:12px;
      color:#fff;font-weight:900;
      background:rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.15);
      z-index:50000;
      display:flex;align-items:center;gap:10px;
      max-width:min(90vw,520px);
    }
    .toast.success{background:rgba(16,185,129,.25);border-color:rgba(16,185,129,.5)}
    .toast.error{background:rgba(220,20,60,.25);border-color:rgba(220,20,60,.55)}
    .toast.warn{background:rgba(245,158,11,.25);border-color:rgba(245,158,11,.55)}

    /* Print Header for all modals */
    .print-header{
      display:none;
      text-align:center;
      padding:20px 0;
      border-bottom:3px solid #1e3a5f;
      margin-bottom:20px;
    }
    .print-header img{height:80px;margin-bottom:10px}
    .print-header h1{color:#1e3a5f;font-size:1.5rem;margin:8px 0}
    .print-header h2{color:#c9a962;font-size:1.1rem;font-weight:700}
    .print-header .clinic-info{color:#666;font-size:.9rem;margin-top:8px}
    .print-footer{
      display:none;
      text-align:center;
      padding:15px 0;
      border-top:2px solid #eee;
      margin-top:20px;
      color:#666;
      font-size:.85rem;
    }

    @media print{
      *{-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important}
      body{background:#fff !important;color:#000 !important;font-size:10pt}
      .header,.main-container,.filters,.range-btns,.close-modal,.modal-actions,.view-btn,
      button:not(.no-hide-print),.chip,.quick-action{display:none !important}
      
      .modal{
        position:static !important;
        display:block !important;
        background:#fff !important;
        padding:0 !important;
        overflow:visible !important;
      }
      .modal:not(.active){display:none !important}
      .modal-card{
        background:#fff !important;
        color:#000 !important;
        border:none !important;
        box-shadow:none !important;
        max-width:100% !important;
        padding:0 !important;
      }
      .modal-header{display:none !important}
      
      .print-header{display:block !important}
      .print-footer{display:block !important}
      
      .table-wrap{border:1px solid #ddd !important;border-radius:8px !important;overflow:visible !important}
      table{width:100% !important;table-layout:fixed !important}
      th,td{
        white-space:normal !important;
        word-wrap:break-word !important;
        overflow-wrap:break-word !important;
        font-size:9pt !important;
        padding:8px 5px !important;
      }
      th{background:#1e3a5f !important;color:#fff !important}
      td{color:#000 !important;border-bottom:1px solid #eee !important}
      tr:nth-child(even) td{background:#f8f9fa !important}
      
      /* Hide details column in print */
      th:last-child, td:last-child{display:none !important}
      
      .mini-item{
        background:#f8f9fa !important;
        border:1px solid #ddd !important;
        border-radius:10px !important;
        padding:15px !important;
        margin-bottom:12px !important;
        page-break-inside:avoid;
      }
      .mini-item div{color:#000 !important}
      
      @page{margin:1cm;size:A4 landscape}
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-title">
      <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="Logo">
      <h1><i class="fas fa-shield-alt"></i> ูุฑูุฒ ุงูููุงุฏุฉ <span>ูุงูุชุญูู EOC</span></h1>
    </div>

    <div class="header-status">
      <a href="emergency-report.html" class="report-emergency-btn">
        <i class="fas fa-exclamation-triangle"></i> ุฅุจูุงุบ ุทูุงุฑุฆ
      </a>

      <button type="button" class="status-badge" id="systemStatus" onclick="onStatusBadgeClick()">
        <i class="fas fa-check-circle"></i><span>ุงููุถุน ุทุจูุนู</span>
      </button>

      <a href="emergency-plan.html" class="back-btn">
        <i class="fas fa-arrow-right"></i> ุฎุทุฉ ุงูุทูุงุฑุฆ
      </a>
    </div>
  </header>

  <div class="main-container">
    <!-- LEFT: CONTROL -->
    <div class="control-panel">
      <div class="quick-actions">
        <div class="quick-action training" onclick="openTrainingModal()">
          <div class="qa-ico"><i class="fas fa-chalkboard-teacher"></i></div>
          <div class="qa-title">ุฌูุณุฉ ุชุฏุฑูุจ ุนููู</div>
          <div class="qa-sub">ุงุฎุชุฑ ุณููุงุฑูู + ุญุถูุฑ</div>
        </div>
        <div class="quick-action training-log" onclick="openTrainingLogModal()">
          <div class="qa-ico"><i class="fas fa-clipboard-list"></i></div>
          <div class="qa-title">ุณุฌู ุงูุชุฏุฑูุจ</div>
          <div class="qa-sub">ููุชุฑุฉ + ุทุจุงุนุฉ</div>
        </div>
        <div class="quick-action reports-log" onclick="openReportsLogModal()">
          <div class="qa-ico"><i class="fas fa-exclamation-triangle"></i></div>
          <div class="qa-title">ุณุฌู ุงูุจูุงุบุงุช</div>
          <div class="qa-sub">ุงูุญูููู + ููุชุฑุฉ</div>
        </div>
      </div>

      <!-- ูุธุงู ุงุฎุชุจุงุฑ ุณูุงูุฉ ุงููุธุงู -->
      <div class="panel-card" style="background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(59,130,246,.1));border:2px solid rgba(16,185,129,.3)">
        <div class="section-title" style="color:#10b981"><i class="fas fa-shield-check"></i> ุงุฎุชุจุงุฑ ุณูุงูุฉ ุงููุธุงู</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
          <button id="testServerBtn" onclick="runSystemTest('server')" class="system-test-btn">
            <i class="fas fa-server"></i>
            <span>ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ</span>
            <div class="test-status" id="testServerStatus">โ</div>
          </button>
          <button id="testAlertBtn" onclick="runSystemTest('alert')" class="system-test-btn">
            <i class="fas fa-bell"></i>
            <span>ูุธุงู ุงูุฅูุฐุงุฑ</span>
            <div class="test-status" id="testAlertStatus">โ</div>
          </button>
          <button id="testSaveBtn" onclick="runSystemTest('save')" class="system-test-btn">
            <i class="fas fa-save"></i>
            <span>ุญูุธ ุงูุจูุงูุงุช</span>
            <div class="test-status" id="testSaveStatus">โ</div>
          </button>
          <button id="testLoadBtn" onclick="runSystemTest('load')" class="system-test-btn">
            <i class="fas fa-download"></i>
            <span>ุณุญุจ ุงูุจูุงูุงุช</span>
            <div class="test-status" id="testLoadStatus">โ</div>
          </button>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button onclick="runAllSystemTests()" class="btn success" style="flex:1">
            <i class="fas fa-play-circle"></i> ุงุฎุชุจุงุฑ ุดุงูู
          </button>
          <button onclick="openSystemTestLog()" class="btn secondary" style="flex:1">
            <i class="fas fa-history"></i> ุณุฌู ุงูุงุฎุชุจุงุฑุงุช
          </button>
        </div>
        <div id="lastTestResult" style="margin-top:8px;font-size:.8rem;color:var(--muted);text-align:center">
          ุขุฎุฑ ุงุฎุชุจุงุฑ: ูู ูุชู ุจุนุฏ
        </div>
      </div>

      <div class="panel-card activate-emergency-card">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="main-activate-btn" onclick="openActivationModal()" style="flex:1;min-width:150px">
            <i class="fas fa-bell"></i>
            <span>ุชูุนูู ุญุงูุฉ ุงูุทูุงุฑุฆ</span>
          </button>
        </div>
        <div style="margin-top:10px;color:var(--muted);font-weight:800;font-size:.9rem;line-height:1.6">
          <i class="fas fa-info-circle"></i>
          ุงูุชูุนูู ุงููุฏูู ููุชุญ ููุณ ุดุงุดุฉ ุงููุฑุงุฑ ูุซู ุงูุจูุงุบ ุงูุญูููู (ุงุฎุชูุงุฑ ููุน ุงูุงุณุชุฌุงุจุฉ + ูููุน + ููุทุฉ ุชุฌูุน) ุซู ูุฑุณู ุฃูุฑ ุงูุดุงุดุงุช.
        </div>
      </div>

      <div class="panel-card">
        <div class="section-title"><i class="fas fa-book-open"></i> ุฏููู ุงูุณููุงุฑูููุงุช</div>
        <div class="scenario-icons" id="scenarioIcons">
          <div class="scenario-icon fire" data-s="fire" onclick="showScenarioGuide('fire')">
            <i class="fas fa-fire"></i><span id="lbl_fire">ุญุฑูู</span>
          </div>
          <div class="scenario-icon power" data-s="power" onclick="showScenarioGuide('power')">
            <i class="fas fa-bolt"></i><span id="lbl_power">ุงููุทุงุน ููุฑุจุงุก</span>
          </div>
          <div class="scenario-icon water" data-s="water" onclick="showScenarioGuide('water')">
            <i class="fas fa-tint"></i><span id="lbl_water">ุชุณุฑุจ ููุงู</span>
          </div>
          <div class="scenario-icon injury" data-s="injury" onclick="showScenarioGuide('injury')">
            <i class="fas fa-heartbeat"></i><span id="lbl_injury">ุฅุบูุงุก/ุฅุตุงุจุฉ</span>
          </div>
          <div class="scenario-icon outbreak" data-s="outbreak" onclick="showScenarioGuide('outbreak')">
            <i class="fas fa-virus"></i><span id="lbl_outbreak">ุชูุดู ุนุฏูู</span>
          </div>
        </div>

        <div class="guide-wrap" id="guideWrap" style="margin-top:14px">
          <div class="guide-title" id="guideTitle"></div>
          <div class="guide-grid">
            <div class="guide-box do">
              <h4><i class="fas fa-circle-check"></i> ุงูุนู (DO)</h4>
              <div id="guideDo"></div>
            </div>
            <div class="guide-box dont">
              <h4><i class="fas fa-triangle-exclamation"></i> ุชุฌูุจ (DON'T)</h4>
              <div id="guideDont"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-card">
        <div class="section-title"><i class="fas fa-clipboard-check"></i> ุณุฌู ุงูุชูุงุฑูู (ุขุฎุฑ 10)</div>
        <div class="mini-list" id="miniTrainingList">
          <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
            <i class="fas fa-spinner fa-spin"></i> ุชุญููู...
          </div>
        </div>
      </div>

      <div class="panel-card">
        <div class="section-title"><i class="fas fa-bell"></i> ุงูุจูุงุบุงุช ุงููุงุฑุฏุฉ (ุขุฎุฑ 10)</div>
        <div class="mini-list" id="miniReportsList">
          <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
            <i class="fas fa-spinner fa-spin"></i> ุชุญููู...
          </div>
        </div>
      </div>

      <div class="panel-card">
        <div class="section-title"><i class="fas fa-phone-alt"></i> ุฃุฑูุงู ุงูุทูุงุฑุฆ</div>
        <div style="display:grid;gap:10px">
          <div class="mini-item"><div class="mini-row"><span><i class="fas fa-phone-alt" style="color:var(--secondary)"></i> ุงูุฑูู ุงูููุญุฏ</span><b dir="ltr">911</b></div></div>
          <div class="mini-item"><div class="mini-row"><span><i class="fas fa-ambulance" style="color:var(--secondary)"></i> ุงูููุงู ุงูุฃุญูุฑ</span><b dir="ltr">997</b></div></div>
          <div class="mini-item"><div class="mini-row"><span><i class="fas fa-fire-extinguisher" style="color:var(--secondary)"></i> ุงูุฏูุงุน ุงููุฏูู</span><b dir="ltr">998</b></div></div>
          <div class="mini-item"><div class="mini-row"><span><i class="fas fa-hospital" style="color:var(--secondary)"></i> ูุฒุงุฑุฉ ุงูุตุญุฉ</span><b dir="ltr">937</b></div></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: BUILDING -->
    <div class="panel-card building-section">
      <div class="section-title"><i class="fas fa-building"></i> ุฎุฑูุทุฉ ุงููุจูู</div>
      <div class="building-view" id="buildingView">
        <div style="text-align:center;padding:30px;color:var(--muted)">
          <i class="fas fa-spinner fa-spin" style="font-size:2rem;margin-bottom:10px"></i><br>
          ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงููุจูู...
        </div>
      </div>

      <div class="muster-points" id="musterPoints"></div>

      <div style="margin-top:10px;color:var(--muted);font-weight:800;font-size:.9rem;line-height:1.6">
        <i class="fas fa-database"></i>
        ุชุนุฏูู ุงูุฃุฏูุงุฑ/ุงูุฃูุณุงู/ููุงุท ุงูุชุฌูุน ูุชู ูู ุงูุฅูุณู (EOC_MAP / EOC_MUSTER) ููุธูุฑ ููุง ุชููุงุฆููุง.
      </div>
    </div>
  </div>

  <!-- Activation Modal -->
  <div class="modal" id="activationModal">
    <div class="modal-card">
      <div class="modal-header">
        <h2><i class="fas fa-bullhorn"></i> ุชูุนูู ุญุงูุฉ ุทูุงุฑุฆ / ุชูุฑูู</h2>
        <button class="close-modal" onclick="closeActivationModal()"><i class="fas fa-times"></i></button>
      </div>

      <div style="text-align:center;color:var(--muted);font-weight:800;margin-bottom:14px;line-height:1.6">
        ุงุฎุชุฑ ุงูุญุฏุซ ุซู ุณููุชุญ ุดุงุดุฉ ุงููุฑุงุฑ ูุฅุตุฏุงุฑ ุฃูุฑ ููุดุงุดุงุช.
      </div>

      <div class="simple-grid">
        <button class="simple-btn fire" onclick="manualStart('fire')"><i class="fas fa-fire"></i><span id="btn_fire">ุญุฑูู</span></button>
        <button class="simple-btn power" onclick="manualStart('power')"><i class="fas fa-bolt"></i><span id="btn_power">ุงููุทุงุน ููุฑุจุงุก</span></button>
        <button class="simple-btn water" onclick="manualStart('water')"><i class="fas fa-tint"></i><span id="btn_water">ุชุณุฑุจ ููุงู</span></button>
        <button class="simple-btn injury" onclick="manualStart('injury')"><i class="fas fa-heartbeat"></i><span id="btn_injury">ุฅุบูุงุก/ุฅุตุงุจุฉ</span></button>
        <button class="simple-btn outbreak" onclick="manualStart('outbreak')"><i class="fas fa-virus"></i><span id="btn_outbreak">ุชูุดู ุนุฏูู</span></button>
        <button class="simple-btn drill" onclick="manualStart('drill')"><i class="fas fa-clipboard-check"></i><span>๐ฏ ุชูุฑูู</span></button>
      </div>

      <div class="modal-actions" style="margin-top:14px">
        <button class="btn secondary" onclick="closeActivationModal()"><i class="fas fa-times"></i> ุฅูุบุงุก</button>
      </div>
    </div>
  </div>

  <!-- Response Modal (issue command) -->
  <div class="modal" id="responseModal">
    <div class="modal-card" style="max-width:900px">
      <div class="modal-header">
        <h2 style="color:var(--danger)"><i class="fas fa-bell"></i> ูุฑุงุฑ ุงูุงุณุชุฌุงุจุฉ</h2>
      </div>

      <div class="report-details">
        <div class="detail-row"><span class="detail-label">ููุน ุงูุญุฏุซ</span><span class="detail-value" id="rmType">-</span></div>
        <div class="detail-row"><span class="detail-label">ุงููููุน</span><span class="detail-value" id="rmLocation">-</span></div>
        <div class="detail-row"><span class="detail-label">ููุงุญุธุงุช</span><span class="detail-value" id="rmNotes">-</span></div>
        <div class="detail-row"><span class="detail-label">ุฑูู ุงูุจูุงุบ</span><span class="detail-value" id="rmId">-</span></div>
      </div>

      <div style="font-weight:900;color:var(--secondary)"><i class="fas fa-hand-pointer"></i> ุงุฎุชุฑ ููุน ุงูุงุณุชุฌุงุจุฉ</div>
      <div class="response-type-grid">
        <div class="rtype-btn" data-rt="full_evacuation" onclick="selectResponseType('full_evacuation')">
          <i class="fas fa-running"></i><span>ุฅุฎูุงุก</span><small>ุฅุฎูุงุก ุงููุจูู/ุฏูุฑ/ููุงุทู</small>
        </div>
        <div class="rtype-btn" data-rt="send_team" onclick="selectResponseType('send_team')">
          <i class="fas fa-users"></i><span>ุชูุฌูู ูุฑูู</span><small>ุชูุฌูู ูุฑูู ููููุน</small>
        </div>
        <div class="rtype-btn" data-rt="isolation_evacuation" onclick="selectResponseType('isolation_evacuation')">
          <i class="fas fa-shield-virus"></i><span>ุนุฒู</span><small>ุนุฒู ููุทูุฉ + ููุน ุงูุงูุชุฑุงุจ</small>
        </div>
      </div>

      <div id="locationBlock" style="display:none;margin-top:14px">
        <div style="font-weight:900;color:var(--secondary)"><i class="fas fa-crosshairs"></i> ุญุฏุฏ ุงูููุงูุน (ูููู ุงุฎุชูุงุฑ ุฃูุซุฑ ูู ูููุน)</div>
        <div class="location-grid" id="locationGrid"></div>
        <input class="loc-custom" id="customLocation" placeholder="ูููุน ุฅุถุงูู (ุงุฎุชูุงุฑู)..." oninput="updateIssueButtonState()">
      </div>

      <div id="musterBlock" style="display:none;margin-top:14px">
        <div style="font-weight:900;color:var(--secondary)"><i class="fas fa-map-marker-alt"></i> ููุทุฉ ุงูุชุฌูุน</div>
        <div class="muster-grid" id="musterGrid"></div>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="closeResponseModal()"><i class="fas fa-arrow-right"></i> ุฑุฌูุน ุจุฏูู ุฅุฌุฑุงุก</button>
        <button class="btn primary" id="issueBtn" onclick="issueCommand()" disabled><i class="fas fa-bullhorn"></i> ุฅุตุฏุงุฑ ุงูุฃูุฑ ููุดุงุดุงุช</button>
      </div>

      <div style="margin-top:10px;color:var(--muted);font-weight:800;font-size:.9rem;line-height:1.6">
        <i class="fas fa-volume-high"></i>
        ุชูุจูู: ุชุดุบูู ุงูุตูุช ุชููุงุฆููุง ูุฏ ููููุน ุจุฏูู ุชูุงุนู ุงููุณุชุฎุฏู ุจุณุจุจ ุณูุงุณุฉ Autoplay ูู ุงููุชุตูุญ.
      </div>
    </div>
  </div>

  <!-- Command Display Screen (local display) -->
  <div class="modal" id="commandScreen">
    <div class="modal-card" style="max-width:900px;border-color:rgba(220,20,60,.8)">
      <div class="modal-header">
        <h2 style="color:var(--danger)"><i class="fas fa-triangle-exclamation"></i> ุฃูุฑ ุชู ุฅุฑุณุงูู ููุดุงุดุงุช</h2>
        <button class="close-modal" onclick="endCommand(false)"><i class="fas fa-times"></i></button>
      </div>

      <div style="text-align:center;padding:10px 0">
        <div style="font-weight:1000;font-size:2rem" id="cmdTitle">-</div>
        <div style="margin-top:10px;font-weight:900;font-size:1.2rem;color:var(--secondary)" id="cmdReportType">-</div>

        <div style="margin-top:14px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px">
          <div style="display:flex;justify-content:center;align-items:center;gap:10px;font-weight:900;font-size:1.2rem">
            <i class="fas fa-map-marker-alt" style="color:var(--secondary)"></i>
            <span id="cmdLocation">-</span>
          </div>
          <div style="margin-top:10px;display:none" id="cmdMusterWrap">
            <div style="font-weight:900;color:var(--secondary);margin-bottom:6px"><i class="fas fa-location-dot"></i> ุงูุชูุฌู ุฅูู</div>
            <div style="font-weight:1000;font-size:1.2rem" id="cmdMuster">-</div>
          </div>
        </div>

        <div style="margin-top:14px;font-weight:900;color:var(--muted)">ุงูููุช ุงููููุถู</div>
        <div style="font-family:monospace;font-size:2.4rem;font-weight:1000" id="cmdTimer">00:00</div>

        <div class="modal-actions" style="margin-top:16px">
          <button class="btn success" onclick="endCommand(true)"><i class="fas fa-check-circle"></i> ุฅููุงุก ุงูุฃูุฑ (Clear)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Modal -->
  <div class="modal" id="trainingModal">
    <div class="modal-card">
      <div class="modal-header">
        <h2><i class="fas fa-chalkboard-teacher"></i> ุฌูุณุฉ ุชุฏุฑูุจ ุนููู <span style="color:#fff;background:linear-gradient(135deg,#dc2626,#991b1b);padding:5px 12px;border-radius:999px;font-size:.9rem">๐ฏ DRILL</span></h2>
        <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#111827;font-family:monospace;font-weight:1000;padding:10px 16px;border-radius:12px" id="trainTimer">00:00:00</div>
        <button class="close-modal" onclick="closeTrainingModal()"><i class="fas fa-times"></i></button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 360px;gap:14px">
        <div>
          <div class="section-title"><i class="fas fa-list-check"></i> ุงุฎุชุฑ ุณููุงุฑูู ุงูุชุฏุฑูุจ</div>

          <div class="scenario-icons" style="grid-template-columns:repeat(6,1fr)" id="trainScenarioIcons">
            <div class="scenario-icon fire" data-s="fire" onclick="selectTrainingScenario('fire')"><i class="fas fa-fire"></i><span id="t_fire">ุญุฑูู</span></div>
            <div class="scenario-icon power" data-s="power" onclick="selectTrainingScenario('power')"><i class="fas fa-bolt"></i><span id="t_power">ุงููุทุงุน ููุฑุจุงุก</span></div>
            <div class="scenario-icon water" data-s="water" onclick="selectTrainingScenario('water')"><i class="fas fa-tint"></i><span id="t_water">ุชุณุฑุจ ููุงู</span></div>
            <div class="scenario-icon injury" data-s="injury" onclick="selectTrainingScenario('injury')"><i class="fas fa-heartbeat"></i><span id="t_injury">ุฅุบูุงุก/ุฅุตุงุจุฉ</span></div>
            <div class="scenario-icon outbreak" data-s="outbreak" onclick="selectTrainingScenario('outbreak')"><i class="fas fa-virus"></i><span id="t_outbreak">ุชูุดู ุนุฏูู</span></div>
            <div class="scenario-icon bls" data-s="bls" onclick="selectTrainingScenario('bls')"><i class="fas fa-heart-pulse"></i><span id="t_bls">ุฅูุนุงุด ููุจู</span></div>
          </div>

          <div id="trainingGuide" style="margin-top:14px;display:none">
            <div class="guide-title" id="trainingGuideTitle"></div>
            <div class="guide-grid">
              <div class="guide-box do">
                <h4><i class="fas fa-circle-check"></i> ุงูุนู (DO)</h4>
                <div id="trainingDo"></div>
              </div>
              <div class="guide-box dont">
                <h4><i class="fas fa-triangle-exclamation"></i> ุชุฌูุจ (DON'T)</h4>
                <div id="trainingDont"></div>
              </div>
            </div>
          </div>

          <div id="metronomeContainer" style="display:none;margin-top:12px">
            <!-- ุฒุฑ ูุชุญ ุงูุชุฏุฑูุจ ุงููุงูู -->
            <button onclick="openBLSFullTraining()" class="btn" style="background:linear-gradient(135deg,#ec4899,#db2777);width:100%;padding:16px;font-size:1.1rem">
              <i class="fas fa-expand"></i> ูุชุญ ุชุฏุฑูุจ BLS ุงููุงูู (ููุก ุงูุดุงุดุฉ)
            </button>
            <div style="font-size:.8rem;margin-top:8px;color:var(--muted);text-align:center">
              ูุดูู: ุถุบุทุงุช ุงูุตุฏุฑ + ุงูุชููุณ ุงูุฅููุงุฐู + ุฌูุงุฒ AED
            </div>
          </div>
          
          <div style="margin-top:12px;color:var(--muted);font-weight:800;line-height:1.6">
            <i class="fas fa-bullhorn"></i>
            ุนูุฏ ุงุฎุชูุงุฑ ุงูุณููุงุฑูู ููููู ุฅุฑุณุงู ุงูุชูุฑูู ููุดุงุดุงุช (Training Mode) โ ุจุฏูู ุฃู ูุคุซุฑ ุนูู ุงูุจูุงุบุงุช ุงูุญููููุฉ.
          </div>
        </div>

        <div>
          <div style="margin-bottom:12px">
            <div style="color:var(--secondary);font-weight:900;margin-bottom:8px"><i class="fas fa-user-tie"></i> ุงุณู ุงููุฏุฑุจ</div>
            <select id="trainerSelect" class="loc-custom" onchange="onTrainerSelectChange()" style="margin-bottom:8px">
              <option value="">-- ุงุฎุชุฑ ุงููุฏุฑุจ --</option>
            </select>
            <input id="trainerName" class="loc-custom" placeholder="ุงูุชุจ ุงุณู ุงููุฏุฑุจ ุงูุฎุงุฑุฌู..." oninput="updateTrainingSaveState()" style="display:none">
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
            <button class="btn warn" style="width:auto" onclick="broadcastTrainingToScreens()">
              <i class="fas fa-tower-broadcast"></i> ุฅุฑุณุงู ุงูุชูุฑูู ููุดุงุดุงุช
            </button>
            <button class="btn secondary" style="width:auto" onclick="stopTrainingOnScreens()">
              <i class="fas fa-stop"></i> ุฅููุงู ุงูุนุฑุถ
            </button>
          </div>

          <div style="color:var(--secondary);font-weight:900;margin-bottom:8px"><i class="fas fa-users"></i> ุงุฎุชุฑ ุงูุญุงุถุฑูู</div>
          <div class="mini-list" style="max-height:320px" id="rosterList">
            <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
              <i class="fas fa-spinner fa-spin"></i> ุชุญููู...
            </div>
          </div>

          <div style="margin-top:10px;text-align:center;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.35);border-radius:12px;padding:10px;font-weight:900;color:var(--success)">
            ุชู ุงุฎุชูุงุฑ <span id="rosterCount">0</span> ูุชุฏุฑุจ
          </div>

          <button class="btn success" id="saveTrainingBtn" onclick="saveTrainingSession()" disabled style="margin-top:10px">
            <i class="fas fa-save"></i> ุญูุธ ุฌูุณุฉ ุงูุชุฏุฑูุจ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Log Modal -->
  <div class="modal" id="trainingLogModal">
    <div class="modal-card" style="max-width:1100px">
      <!-- Print Header -->
      <div class="print-header">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="ุดุนุงุฑ ุงููุฌูุน">
        <h1>ูุฌูุน ููุฉ ุงูุทุจู ุจุงูุฒุงูุฑ</h1>
        <h2>ุณุฌู ุฌูุณุงุช ุงูุชุฏุฑูุจ ุนูู ุงูุทูุงุฑุฆ</h2>
        <div class="clinic-info">ููุฉ ุงูููุฑูุฉ - ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ | ูุงุชู: 012-XXXXXXX</div>
      </div>
      
      <div class="modal-header">
        <h2><i class="fas fa-clipboard-list"></i> ุณุฌู ุฌูุณุงุช ุงูุชุฏุฑูุจ</h2>
        <button class="close-modal" onclick="closeTrainingLogModal()"><i class="fas fa-times"></i></button>
      </div>

      <div class="filters">
        <div class="range-btns" id="trainRangeBtns"></div>
        <input type="date" id="trainFrom" onchange="applyTrainingFilter()">
        <input type="date" id="trainTo" onchange="applyTrainingFilter()">
        <button class="view-btn" onclick="printTrainingDetails()"><i class="fas fa-print"></i> ุทุจุงุนุฉ</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>ุงูุชุงุฑูุฎ</th>
              <th>ุงูุจุฏุงูุฉ</th>
              <th>ุงูููุงูุฉ</th>
              <th>ุงููุฏุฉ (ุฏ)</th>
              <th>ุงูุณููุงุฑูู</th>
              <th>ุงููุฏุฑุจ</th>
              <th>ุงูุญุถูุฑ</th>
              <th>ุชูุงุตูู</th>
            </tr>
          </thead>
          <tbody id="trainLogBody"></tbody>
        </table>
      </div>
      
      <!-- Print Footer -->
      <div class="print-footer">
        <div>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <span id="printDateTrain"></span></div>
        <div style="margin-top:5px">ูุฌูุน ููุฉ ุงูุทุจู ุจุงูุฒุงูุฑ - ูุธุงู ุฅุฏุงุฑุฉ ุงูุทูุงุฑุฆ EOC</div>
      </div>
    </div>
  </div>

  <!-- Reports Log Modal -->
  <div class="modal" id="reportsLogModal">
    <div class="modal-card" style="max-width:1100px">
      <!-- Print Header -->
      <div class="print-header">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="ุดุนุงุฑ ุงููุฌูุน">
        <h1>ูุฌูุน ููุฉ ุงูุทุจู ุจุงูุฒุงูุฑ</h1>
        <h2>ุณุฌู ุจูุงุบุงุช ุงูุทูุงุฑุฆ</h2>
        <div class="clinic-info">ููุฉ ุงูููุฑูุฉ - ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ | ูุงุชู: 012-XXXXXXX</div>
      </div>
      
      <div class="modal-header">
        <h2 style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> ุณุฌู ุงูุจูุงุบุงุช ุงูุญููููุฉ</h2>
        <button class="close-modal" onclick="closeReportsLogModal()"><i class="fas fa-times"></i></button>
      </div>

      <div class="filters">
        <div class="range-btns" id="repRangeBtns"></div>
        <input type="date" id="repFrom" onchange="applyReportsFilter()">
        <input type="date" id="repTo" onchange="applyReportsFilter()">
        <select id="repStatus" onchange="applyReportsFilter()">
          <option value="">ูู ุงูุญุงูุงุช</option>
          <option value="ุฌุฏูุฏ">ุฌุฏูุฏ</option>
          <option value="ููุฏ ุงููุนุงูุฌุฉ">ููุฏ ุงููุนุงูุฌุฉ</option>
          <option value="ูุบูู">ูุบูู</option>
        </select>
        <button class="view-btn" onclick="printTrainingDetails()"><i class="fas fa-print"></i> ุทุจุงุนุฉ</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ุฑูู ุงูุจูุงุบ</th>
              <th>ุงูุชุงุฑูุฎ</th>
              <th>ุงูููุช</th>
              <th>ุงูููุน</th>
              <th>ุงููููุน</th>
              <th>ุงูุญุงูุฉ</th>
              <th>ุฅุฌุฑุงุก</th>
            </tr>
          </thead>
          <tbody id="repLogBody"></tbody>
        </table>
      </div>
      
      <!-- Print Footer -->
      <div class="print-footer">
        <div>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <span id="printDateRep"></span></div>
        <div style="margin-top:5px">ูุฌูุน ููุฉ ุงูุทุจู ุจุงูุฒุงูุฑ - ูุธุงู ุฅุฏุงุฑุฉ ุงูุทูุงุฑุฆ EOC</div>
      </div>
    </div>
  </div>

  <!-- Training Details Modal -->
  <div class="modal" id="trainingDetailsModal">
    <div class="modal-card" style="max-width:800px">
      <!-- Print Header -->
      <div class="print-header">
        <img src="https://raw.githubusercontent.com/makkahclinic/makkahclinic/main/logo-new.png" alt="ุดุนุงุฑ ุงููุฌูุน">
        <h1>ูุฌูุน ููุฉ ุงูุทุจู ุจุงูุฒุงูุฑ</h1>
        <h2>ุชูุฑูุฑ ุฌูุณุฉ ุชุฏุฑูุจ ุนูู ุงูุทูุงุฑุฆ</h2>
        <div class="clinic-info">ููุฉ ุงูููุฑูุฉ - ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ | ูุงุชู: 012-XXXXXXX</div>
      </div>
      
      <div class="modal-header">
        <h2><i class="fas fa-info-circle"></i> ุชูุงุตูู ุฌูุณุฉ ุงูุชุฏุฑูุจ</h2>
        <button class="close-modal" onclick="closeTrainingDetails()"><i class="fas fa-times"></i></button>
      </div>
      <div id="trainingDetailsContent"></div>
      
      <!-- Print Footer -->
      <div class="print-footer">
        <div>ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: <span id="printDateDetails"></span></div>
        <div style="margin-top:5px">ูุฌูุน ููุฉ ุงูุทุจู ุจุงูุฒุงูุฑ - ูุธุงู ุฅุฏุงุฑุฉ ุงูุทูุงุฑุฆ EOC</div>
        <div style="margin-top:8px;font-size:.75rem">ุชูููุน ุงููุฏุฑุจ: _________________ | ุชูููุน ุงููุดุฑู: _________________</div>
      </div>
      
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeTrainingDetails()"><i class="fas fa-times"></i> ุฅุบูุงู</button>
        <button class="btn success" onclick="printTrainingDetails()"><i class="fas fa-print"></i> ุทุจุงุนุฉ</button>
      </div>
    </div>
  </div>

  <!-- BLS Full Training Modal -->
  <div class="modal" id="blsTrainingModal" style="z-index:10000">
    <div class="modal-card" style="max-width:100%;width:100%;height:100vh;margin:0;border-radius:0;display:flex;flex-direction:column">
      <div class="modal-header" style="background:linear-gradient(135deg,#ec4899,#db2777);flex-shrink:0">
        <h2 style="color:#fff"><i class="fas fa-heart-pulse"></i> ุชุฏุฑูุจ ุงูุฅูุนุงุด ุงูููุจู ุงูุฑุฆูู (BLS)</h2>
        <div style="display:flex;align-items:center;gap:12px">
          <div id="blsCompressionCounter" style="background:rgba(0,0,0,.3);padding:8px 16px;border-radius:999px;font-weight:900;font-size:1.2rem">
            <i class="fas fa-hand-fist"></i> <span id="compressionCount">0</span>/30
          </div>
          <button class="close-modal" onclick="closeBLSTraining()" style="background:rgba(0,0,0,.3)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      
      <!-- ุงูุชุจููุจุงุช -->
      <div style="display:flex;background:rgba(0,0,0,.3);flex-shrink:0">
        <button class="bls-tab active" data-tab="compressions" onclick="switchBLSTab('compressions')">
          <i class="fas fa-hand-fist"></i> ุงูุถุบุทุงุช
        </button>
        <button class="bls-tab" data-tab="breathing" onclick="switchBLSTab('breathing')">
          <i class="fas fa-lungs"></i> ุงูุชููุณ
        </button>
        <button class="bls-tab" data-tab="aed" onclick="switchBLSTab('aed')">
          <i class="fas fa-bolt"></i> ุฌูุงุฒ AED
        </button>
      </div>
      
      <!-- ูุญุชูู ุงูุชุจููุจุงุช -->
      <div style="flex:1;overflow:auto;padding:20px">
        <!-- ุชุจููุจ ุงูุถุบุทุงุช -->
        <div id="tabCompressions" class="bls-tab-content active">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:1200px;margin:0 auto">
            <!-- ุงูุฑุณูุฉ ุงูุชูุถูุญูุฉ -->
            <div style="background:#1a1a2e;border-radius:20px;padding:20px;text-align:center">
              <h3 style="color:#ec4899;margin-bottom:16px"><i class="fas fa-crosshairs"></i> ููุงู ุงูุถุบุท ุงูุตุญูุญ</h3>
              <svg viewBox="0 0 300 280" style="max-width:280px;margin:0 auto;display:block">
                <!-- ุฎูููุฉ -->
                <rect x="0" y="0" width="300" height="280" fill="#1a1a2e"/>
                <!-- ุงูุฌุณู -->
                <ellipse cx="150" cy="160" rx="80" ry="100" fill="#fce7f3" stroke="#ec4899" stroke-width="3"/>
                <!-- ุงูุฑูุจุฉ -->
                <rect x="130" y="55" width="40" height="30" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
                <!-- ุงูุฑุฃุณ -->
                <circle cx="150" cy="35" r="25" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
                <!-- ุงูุฃุถูุงุน -->
                <path d="M90,110 Q150,100 210,110" fill="none" stroke="#db2777" stroke-width="2" opacity=".5"/>
                <path d="M80,135 Q150,125 220,135" fill="none" stroke="#db2777" stroke-width="2" opacity=".5"/>
                <path d="M75,160 Q150,150 225,160" fill="none" stroke="#db2777" stroke-width="2" opacity=".5"/>
                <!-- ุนุธูุฉ ุงููุต (sternum) -->
                <rect x="140" y="90" width="20" height="80" rx="5" fill="#fbbf24" opacity=".4"/>
                <text x="150" y="85" text-anchor="middle" fill="#fbbf24" font-size="11" font-weight="900">ุนุธูุฉ ุงููุต</text>
                <!-- ููุทุฉ ุงูุถุบุท -->
                <circle cx="150" cy="145" r="25" fill="#dc2626" stroke="#fff" stroke-width="4">
                  <animate attributeName="r" values="25;30;25" dur="0.6s" repeatCount="indefinite"/>
                </circle>
                <text x="150" y="150" text-anchor="middle" fill="#fff" font-size="14" font-weight="900">ุงุถุบุท</text>
                <!-- ุงูุณูู -->
                <path d="M220,90 L175,130" stroke="#fbbf24" stroke-width="4" fill="none" marker-end="url(#blsArrow)"/>
                <defs>
                  <marker id="blsArrow" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
                    <path d="M0,0 L0,12 L12,6 z" fill="#fbbf24"/>
                  </marker>
                </defs>
                <text x="235" y="85" fill="#fbbf24" font-size="12" font-weight="900">ููุชุตู</text>
                <text x="235" y="100" fill="#fbbf24" font-size="12" font-weight="900">ุงูุตุฏุฑ</text>
              </svg>
              
              <div style="margin-top:16px;background:rgba(251,191,36,.15);border:2px solid #fbbf24;border-radius:12px;padding:12px;text-align:right">
                <div style="font-weight:900;color:#fbbf24;margin-bottom:8px"><i class="fas fa-hand-point-up"></i> ุทุฑููุฉ ุงูุถุบุท:</div>
                <div style="font-size:.95rem;line-height:1.8">
                  โข ุถุน <strong>ูุนุจ ุงููุฏ</strong> ุนูู ููุชุตู ุงูุตุฏุฑ<br>
                  โข ุงููุฏ ุงูุซุงููุฉ <strong>ููู ุงูุฃููู</strong> ูุชุดุงุจูุฉ<br>
                  โข ุงูุฐุฑุงุนูู <strong>ูุณุชูููุชูู</strong> ุชูุงูุงู<br>
                  โข ุนูู ุงูุถุบุท: <strong style="color:#ec4899">5-6 ุณู</strong><br>
                  โข ุงูุณุฑุนุฉ: <strong style="color:#ec4899">100-120 ุถุบุทุฉ/ุฏูููุฉ</strong>
                </div>
              </div>
            </div>
            
            <!-- ุงูุชุญูู ุจุงูุชุฏุฑูุจ -->
            <div>
              <div style="background:#1a1a2e;border-radius:20px;padding:20px;margin-bottom:16px">
                <h3 style="color:#10b981;margin-bottom:16px"><i class="fas fa-drum"></i> ุชุฏุฑูุจ ุงูุฅููุงุน</h3>
                <div style="text-align:center;font-size:4rem;font-weight:900;color:#ec4899;margin:20px 0" id="blsBeatDisplay">
                  <i class="fas fa-heart-pulse"></i>
                </div>
                <button id="blsMetronomeBtn" onclick="toggleBLSMetronome()" class="btn" style="width:100%;background:linear-gradient(135deg,#ec4899,#db2777);font-size:1.1rem;padding:16px">
                  <i class="fas fa-play"></i> ุงุจุฏุฃ ุงูุชุฏุฑูุจ
                </button>
                <div style="margin-top:12px;font-size:.9rem;color:var(--muted);text-align:center">
                  ุงุถุบุท ูุน ูู ูุจุถุฉ ุตูุชูุฉ (110/ุฏูููุฉ)
                </div>
              </div>
              
              <div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:20px;padding:20px">
                <h3 style="margin-bottom:12px"><i class="fas fa-info-circle"></i> ุชุฐูุฑ ุฏุงุฆูุงู</h3>
                <div style="font-size:1rem;line-height:1.8">
                  โ <strong>30 ุถุบุทุฉ</strong> ุซู <strong>ููุณูู</strong> ุฅููุงุฐ<br>
                  โ ูุง ุชุชููู ุฃูุซุฑ ูู <strong>10 ุซูุงูู</strong><br>
                  โ ุงุถุบุท <strong>ุจููุฉ ูุจุณุฑุนุฉ</strong><br>
                  โ ุงุณูุญ ููุตุฏุฑ <strong>ุจุงูุงุฑุชูุงุน</strong> ุชูุงูุงู
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- overlay ุงูุชููุณ (ูุธูุฑ ูู 30 ุถุบุทุฉ) -->
        <div id="breathOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(59,130,246,.95);z-index:10001;display:none;align-items:center;justify-content:center;flex-direction:column">
          <div style="text-align:center;color:#fff">
            <div style="font-size:6rem;margin-bottom:20px">๐ซ</div>
            <h1 style="font-size:3rem;margin-bottom:20px">ุฃุนุทู ููุณูู ุฅููุงุฐ</h1>
            <div style="font-size:5rem;font-weight:900" id="breathCountdown">5</div>
            <div style="font-size:1.5rem;margin-top:20px">
              <i class="fas fa-hand-point-up"></i> ุงุฑูุน ุงูุฐูู ูุฃูู ุงูุฑุฃุณ ููุฎูู
            </div>
          </div>
        </div>
        
        <!-- ุชุจููุจ ุงูุชููุณ -->
        <div id="tabBreathing" class="bls-tab-content" style="display:none">
          <div style="max-width:800px;margin:0 auto">
            <div style="background:#1a1a2e;border-radius:20px;padding:24px;margin-bottom:20px">
              <h3 style="color:#3b82f6;margin-bottom:20px;font-size:1.3rem"><i class="fas fa-lungs"></i> ุงูุชููุณ ุงูุฅููุงุฐู (Rescue Breaths)</h3>
              
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px">
                <div style="background:rgba(59,130,246,.15);border:2px solid #3b82f6;border-radius:16px;padding:16px">
                  <div style="font-size:2rem;text-align:center;margin-bottom:10px">1๏ธโฃ</div>
                  <h4 style="color:#3b82f6;margin-bottom:8px">ุงูุชุญ ูุฌุฑู ุงูููุงุก</h4>
                  <p style="font-size:.95rem;line-height:1.6">ุถุน ูุฏู ุนูู ุฌุจูุฉ ุงููุตุงุจ ูุงุฑูุน ุฐููู ุจุงูุฃุฎุฑู (Head-tilt Chin-lift)</p>
                </div>
                <div style="background:rgba(59,130,246,.15);border:2px solid #3b82f6;border-radius:16px;padding:16px">
                  <div style="font-size:2rem;text-align:center;margin-bottom:10px">2๏ธโฃ</div>
                  <h4 style="color:#3b82f6;margin-bottom:8px">ุฃุบูู ุงูุฃูู</h4>
                  <p style="font-size:.95rem;line-height:1.6">ุงูุฑุต ุฃูู ุงููุตุงุจ ุจุฅุจูุงูู ูุณุจุงุจุชู ูููุน ุชุณุฑุจ ุงูููุงุก</p>
                </div>
                <div style="background:rgba(59,130,246,.15);border:2px solid #3b82f6;border-radius:16px;padding:16px">
                  <div style="font-size:2rem;text-align:center;margin-bottom:10px">3๏ธโฃ</div>
                  <h4 style="color:#3b82f6;margin-bottom:8px">ุฃุนุทู ููุณุงู</h4>
                  <p style="font-size:.95rem;line-height:1.6">ุถุน ููู ุนูู ูู ุงููุตุงุจ ูุงููุฎ ููุฏุฉ <strong style="color:#fbbf24">ุซุงููุฉ ูุงุญุฏุฉ</strong> ููุท</p>
                </div>
                <div style="background:rgba(59,130,246,.15);border:2px solid #3b82f6;border-radius:16px;padding:16px">
                  <div style="font-size:2rem;text-align:center;margin-bottom:10px">4๏ธโฃ</div>
                  <h4 style="color:#3b82f6;margin-bottom:8px">ุฑุงูุจ ุงูุตุฏุฑ</h4>
                  <p style="font-size:.95rem;line-height:1.6">ุชุฃูุฏ ุฃู ุตุฏุฑ ุงููุตุงุจ <strong style="color:#10b981">ูุฑุชูุน</strong> ูุน ูู ููุณ</p>
                </div>
              </div>
              
              <div style="margin-top:20px;background:rgba(239,68,68,.15);border:2px solid #ef4444;border-radius:12px;padding:14px">
                <div style="font-weight:900;color:#ef4444;margin-bottom:8px"><i class="fas fa-exclamation-triangle"></i> ุชุญุฐูุฑุงุช ูููุฉ:</div>
                <div style="font-size:.95rem;line-height:1.8">
                  โ๏ธ ูุง ุชููุฎ <strong>ุจููุฉ ุฒุงุฆุฏุฉ</strong> - ูุฏ ูุณุจุจ ุงูุชูุงุฎ ุงููุนุฏุฉ<br>
                  โ๏ธ ุฅุฐุง ูู ูุฑุชูุน ุงูุตุฏุฑ - ุฃุนุฏ ูุชุญ ูุฌุฑู ุงูููุงุก<br>
                  โ๏ธ ูุง ุชุชููู ุฃูุซุฑ ูู <strong>10 ุซูุงูู</strong> ููุชููุณ
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ุชุจููุจ AED -->
        <div id="tabAed" class="bls-tab-content" style="display:none">
          <div style="max-width:1000px;margin:0 auto">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
              <!-- ูุง ูู AED -->
              <div style="background:#1a1a2e;border-radius:20px;padding:24px">
                <h3 style="color:#fbbf24;margin-bottom:16px;font-size:1.2rem"><i class="fas fa-question-circle"></i> ูุง ูู ุฌูุงุฒ AEDุ</h3>
                <div style="text-align:center;font-size:4rem;margin:20px 0">โก๐ซ</div>
                <p style="font-size:1rem;line-height:1.8">
                  <strong style="color:#fbbf24">AED</strong> = Automated External Defibrillator<br>
                  <strong style="color:#fbbf24">ูุฒูู ุงูุฑุฌูุงู ุงูุฎุงุฑุฌู ุงูุขูู</strong><br><br>
                  ุฌูุงุฒ ููุญูู ูุธู ุงูููุจ ูููุนุทู ุตุฏูุฉ ููุฑุจุงุฆูุฉ ูุฅุนุงุฏุฉ ุงูููุจ ููุนูู ุงูุทุจูุนู.
                </p>
              </div>
              
              <!-- ูุชู ูุณุชุฎุฏูู -->
              <div style="background:#1a1a2e;border-radius:20px;padding:24px">
                <h3 style="color:#10b981;margin-bottom:16px;font-size:1.2rem"><i class="fas fa-clock"></i> ูุชู ูุณุชุฎุฏููุ</h3>
                <div style="font-size:1rem;line-height:2">
                  โ ุงููุตุงุจ <strong style="color:#ef4444">ูุง ูุณุชุฌูุจ</strong><br>
                  โ ุงููุตุงุจ <strong style="color:#ef4444">ูุง ูุชููุณ</strong> ุทุจูุนูุงู<br>
                  โ <strong style="color:#ef4444">ูุง ููุฌุฏ ูุจุถ</strong> (ุงุฎุชูุงุฑู ุงููุญุต)<br>
                  โ <strong>ููุฑ ุชููุฑ</strong> ุงูุฌูุงุฒ!
                </div>
                <div style="margin-top:16px;background:rgba(16,185,129,.15);border:2px solid #10b981;border-radius:10px;padding:12px;font-weight:900;text-align:center">
                  <i class="fas fa-bolt"></i> ูู ุฏูููุฉ ุชุฃุฎูุฑ = 10% ุงูุฎูุงุถ ูุฑุตุฉ ุงููุฌุงุฉ
                </div>
              </div>
              
              <!-- ููู ูุณุชุฎุฏูู -->
              <div style="background:#1a1a2e;border-radius:20px;padding:24px;grid-column:span 2">
                <h3 style="color:#3b82f6;margin-bottom:16px;font-size:1.2rem"><i class="fas fa-list-ol"></i> ุฎุทูุงุช ุงุณุชุฎุฏุงู AED</h3>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
                  <div style="background:rgba(59,130,246,.15);border-radius:14px;padding:14px;text-align:center">
                    <div style="font-size:2.5rem;margin-bottom:10px">1๏ธโฃ</div>
                    <div style="font-weight:900;color:#3b82f6">ุดุบูู ุงูุฌูุงุฒ</div>
                    <div style="font-size:.85rem;margin-top:6px">ุงูุชุญ ุงูุบุทุงุก ูุงุถุบุท ุฒุฑ ุงูุชุดุบูู</div>
                  </div>
                  <div style="background:rgba(59,130,246,.15);border-radius:14px;padding:14px;text-align:center">
                    <div style="font-size:2.5rem;margin-bottom:10px">2๏ธโฃ</div>
                    <div style="font-weight:900;color:#3b82f6">ุฃูุตู ุงููุณุงุฏุงุช</div>
                    <div style="font-size:.85rem;margin-top:6px">ุนูู ุตุฏุฑ ุฌุงู - ุงุชุจุน ุงูุตูุฑ ุนูู ุงููุณุงุฏุงุช</div>
                  </div>
                  <div style="background:rgba(59,130,246,.15);border-radius:14px;padding:14px;text-align:center">
                    <div style="font-size:2.5rem;margin-bottom:10px">3๏ธโฃ</div>
                    <div style="font-weight:900;color:#3b82f6">ุงุจุชุนุฏ</div>
                    <div style="font-size:.85rem;margin-top:6px">"ุงุจุชุนุฏูุง ุฌููุนุงู" ุฃุซูุงุก ุงูุชุญููู ูุงูุตุฏูุฉ</div>
                  </div>
                  <div style="background:rgba(59,130,246,.15);border-radius:14px;padding:14px;text-align:center">
                    <div style="font-size:2.5rem;margin-bottom:10px">4๏ธโฃ</div>
                    <div style="font-weight:900;color:#3b82f6">ุงุถุบุท ุงูุฒุฑ</div>
                    <div style="font-size:.85rem;margin-top:6px">ุฅุฐุง ุทูุจ ุงูุฌูุงุฒ ุตุฏูุฉ - ุงุถุบุท ุงูุฒุฑ</div>
                  </div>
                </div>
              </div>
              
              <!-- ูู ูุณุชุฎุฏูู -->
              <div style="background:#1a1a2e;border-radius:20px;padding:24px">
                <h3 style="color:#ec4899;margin-bottom:16px;font-size:1.2rem"><i class="fas fa-users"></i> ูู ูุณุชุฎุฏููุ</h3>
                <div style="font-size:1rem;line-height:2">
                  โ <strong>ุฃู ุดุฎุต!</strong> - ุงูุฌูุงุฒ ููุฑุดุฏู ุตูุชูุงู<br>
                  โ ูุง ูุญุชุงุฌ ุชุฏุฑูุจ ูุชูุฏู<br>
                  โ ุขูู ูููุณุชุฎุฏู ูุงููุตุงุจ<br>
                  โ ูู ููุนุทู ุตุฏูุฉ ุฅูุง ุฅุฐุง ุงุญุชุงุฌูุง ุงูููุจ
                </div>
              </div>
              
              <!-- ูุงุฐุง ูู ุงุณุชุฎุฏููุงู ุจุงูุบูุท -->
              <div style="background:linear-gradient(135deg,rgba(239,68,68,.2),rgba(220,38,38,.2));border:2px solid #ef4444;border-radius:20px;padding:24px">
                <h3 style="color:#ef4444;margin-bottom:16px;font-size:1.2rem"><i class="fas fa-exclamation-triangle"></i> ูุงุฐุง ูู ูุงู ุนูุฏู ูุจุถุ</h3>
                <div style="font-size:1rem;line-height:1.8">
                  <strong style="color:#10b981;font-size:1.2rem">ูุง ุชููู! ๐ก๏ธ</strong><br><br>
                  ุฌูุงุฒ AED <strong>ุฐูู</strong> - ููุญูู ูุธู ุงูููุจ ุฃููุงู:<br><br>
                  โ ุฅุฐุง ุงูููุจ <strong>ูุนูู ุทุจูุนู</strong> = <strong style="color:#10b981">ูู ููุนุทู ุตุฏูุฉ</strong><br>
                  โ ูููู: "ูุง ุญุงุฌุฉ ููุตุฏูุฉ - ุงุณุชูุฑ ุจุงูุฅูุนุงุด"<br>
                  โ <strong style="color:#fbbf24">ูู ุงููุณุชุญูู</strong> ุฃู ููุนุทู ุตุฏูุฉ ูููุจ ุณููู<br><br>
                  <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:10px;font-weight:900;text-align:center">
                    ๐ก ุงููุงุนุฏุฉ: ุฅุฐุง ุดููุช - ุงุณุชุฎุฏู ุงูุฌูุงุฒ!
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /******************************************************
     * CONFIG
     ******************************************************/
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbytslZrI7jIgUY0iavZPfgOiEPZKgkjFaNgTBCcWByHLARdEFb4Qkzi4Ecad0v_Q7SL1w/exec';

    const SCENARIO_META = {
      fire:    { icon:'fa-fire',          fa:'fas', color:'fire' },
      power:   { icon:'fa-bolt',          fa:'fas', color:'power' },
      water:   { icon:'fa-tint',          fa:'fas', color:'water' },
      injury:  { icon:'fa-heartbeat',     fa:'fas', color:'injury' },
      outbreak:{ icon:'fa-virus',         fa:'fas', color:'outbreak' },
      bls:     { icon:'fa-heart-pulse',   fa:'fas', color:'bls' },
    };

    const TYPE_LABELS_FALLBACK = {
      fire: 'ุญุฑูู',
      power: 'ุงููุทุงุน ููุฑุจุงุก',
      water: 'ุชุณุฑุจ ููุงู',
      injury: 'ุฅุบูุงุก/ุฅุตุงุจุฉ',
      outbreak: 'ุชูุดู ุนุฏูู',
      bls: 'ุฅูุนุงุด ููุจู (BLS)',
      drill: 'ุชูุฑูู'
    };

    const APP = {
      building: { floors: [], muster: [] },
      scenarios: {},        // {key:{key,label,DO[],DONT[]}}
      roster: [],           // [{name,department,role}]
      alerted: new Set(JSON.parse(localStorage.getItem('eoc_alerted_reports') || '[]')),
      currentReport: null,

      // response modal state
      responseType: '',
      selectedLocations: new Set(),
      selectedMuster: '',

      // training state
      train: {
        active: false,
        startMs: 0,
        timer: null,
        scenarioKey: '',
        selectedRoster: new Set(),
      },

      caches: {
        trainingSessions: [],
        reports: [],
      }
    };

    /******************************************************
     * JSONP helper (Apps Script ContentService JSONP)
     ******************************************************/
    function jsonp(action, params = {}, timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        params.action = action;
        params.callback = cb;

        const s = document.createElement("script");
        s.src = WEB_APP_URL + "?" + new URLSearchParams(params).toString();

        let timeoutId = null;
        
        function cleanup() {
          if (timeoutId) clearTimeout(timeoutId);
          try { delete window[cb]; } catch(e) {}
          if (s.parentNode) s.parentNode.removeChild(s);
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        s.onerror = () => { cleanup(); reject(new Error("jsonp script error: " + action)); };
        
        // Timeout
        timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error("jsonp timeout: " + action));
        }, timeoutMs);
        
        document.body.appendChild(s);
      });
    }

    /******************************************************
     * UI helpers
     ******************************************************/
    function toast(message, type='info') {
      const t = document.createElement('div');
      t.className = 'toast ' + (type || '');
      let icon = 'fa-circle-info';
      if (type === 'success') icon = 'fa-check-circle';
      else if (type === 'error') icon = 'fa-triangle-exclamation';
      else if (type === 'warn') icon = 'fa-circle-exclamation';
      t.innerHTML = '<i class="fas ' + icon + '"></i> ' + escapeHtml(message);
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 3200);
    }

    function showBigSuccess(message) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:99999;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s';
      overlay.innerHTML = `
        <div style="background:linear-gradient(135deg,#059669,#10b981);color:#fff;padding:40px 50px;border-radius:24px;text-align:center;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,.5);animation:popIn .4s">
          <div style="font-size:4rem;margin-bottom:20px">โ</div>
          <div style="font-size:1.4rem;font-weight:900;white-space:pre-line;line-height:1.8">${escapeHtml(message)}</div>
          <button onclick="this.closest('div').parentElement.remove()" style="margin-top:25px;background:#fff;color:#059669;border:0;padding:14px 40px;border-radius:12px;font-weight:900;font-size:1.1rem;cursor:pointer;font-family:Tajawal">
            <i class="fas fa-check"></i> ุญุณูุงู
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
      setTimeout(() => overlay.remove(), 8000);
    }

    function showBigError(message) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:99999;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s';
      overlay.innerHTML = `
        <div style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;padding:40px 50px;border-radius:24px;text-align:center;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,.5);animation:popIn .4s">
          <div style="font-size:4rem;margin-bottom:20px">โ</div>
          <div style="font-size:1.2rem;font-weight:900;white-space:pre-line;line-height:1.8">${escapeHtml(message)}</div>
          <button onclick="this.closest('div').parentElement.remove()" style="margin-top:25px;background:#fff;color:#dc2626;border:0;padding:14px 40px;border-radius:12px;font-weight:900;font-size:1.1rem;cursor:pointer;font-family:Tajawal">
            <i class="fas fa-times"></i> ุฅุบูุงู
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function escapeHtml(str){
      return String(str || '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    function setStatusAlert(on, label){
      const el = document.getElementById('systemStatus');
      if (!el) return;
      if (on){
        el.classList.add('alert');
        el.innerHTML = `<i class="fas fa-stop-circle"></i><span>${escapeHtml(label || 'ุฅูุบุงุก ุญุงูุฉ ุงูุทูุงุฑุฆ')}</span>`;
      } else {
        el.classList.remove('alert');
        el.innerHTML = `<i class="fas fa-check-circle"></i><span>ุงููุถุน ุทุจูุนู</span>`;
      }
    }

    /******************************************************
     * Emergency Alarm Sound System
     ******************************************************/
    let alarmAudioCtx = null;
    let alarmOscillator = null;
    let alarmGain = null;
    let alarmInterval = null;

    function playAlarmSound(){
      try {
        // Stop any existing alarm
        stopAlarmSound();

        alarmAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        alarmGain = alarmAudioCtx.createGain();
        alarmGain.connect(alarmAudioCtx.destination);
        alarmGain.gain.value = 0.8;

        let isHigh = true;
        function beep(){
          if (alarmOscillator) {
            try { alarmOscillator.stop(); } catch(e){}
          }
          alarmOscillator = alarmAudioCtx.createOscillator();
          alarmOscillator.type = 'square';
          alarmOscillator.frequency.value = isHigh ? 880 : 440;
          alarmOscillator.connect(alarmGain);
          alarmOscillator.start();
          isHigh = !isHigh;
        }

        beep();
        alarmInterval = setInterval(beep, 500);

        // ุงูุตูุช ูุณุชูุฑ ุญุชู ูุชู ุงูุชุนุงูู ูุน ุงูุจูุงุบ (ูุง ูุชููู ุชููุงุฆูุงู)
      } catch(e){
        console.warn('Could not play alarm:', e);
      }
    }

    function stopAlarmSound(){
      if (alarmInterval) {
        clearInterval(alarmInterval);
        alarmInterval = null;
      }
      if (alarmOscillator) {
        try { alarmOscillator.stop(); } catch(e){}
        alarmOscillator = null;
      }
      if (alarmAudioCtx) {
        try { alarmAudioCtx.close(); } catch(e){}
        alarmAudioCtx = null;
      }
    }

    /******************************************************
     * Active Command Sync & Status Badge Click
     ******************************************************/
    let ACTIVE_CMD_CACHE = null;

    async function syncActiveCommandUI() {
      try {
        const ac = await jsonp('getActiveCommand', {});
        const cmd = (ac && ac.ok) ? ac.command : null;

        if (cmd && (cmd.active === true || String(cmd.active).toLowerCase() === 'true' || String(cmd.active) === '1')) {
          ACTIVE_CMD_CACHE = cmd;

          const isTraining =
            String(cmd.mode || '').toLowerCase() === 'training' ||
            String(cmd.reportType || '').includes('ุชูุฑูู') ||
            String(cmd.reportType || '').includes('๐ฏ');

          setStatusAlert(true, isTraining ? 'ุฅููุงู ุงูุชูุฑูู' : 'ุฅูุบุงุก ุญุงูุฉ ุงูุทูุงุฑุฆ');
        } else {
          ACTIVE_CMD_CACHE = null;
          setStatusAlert(false);
        }
      } catch (e) {
        console.error('syncActiveCommandUI:', e);
      }
    }

    async function onStatusBadgeClick(){
      try {
        const ac = await jsonp('getActiveCommand', {});
        const cmd = (ac && ac.ok) ? ac.command : null;

        if (!cmd || !(cmd.active === true || String(cmd.active).toLowerCase() === 'true' || String(cmd.active) === '1')) {
          toast('ูุง ุชูุฌุฏ ุญุงูุฉ ุทูุงุฑุฆ ูุดุทุฉ ุญุงููุงู', 'info');
          return;
        }

        const isTraining =
          String(cmd.mode || '').toLowerCase() === 'training' ||
          String(cmd.reportType || '').includes('ุชูุฑูู') ||
          String(cmd.reportType || '').includes('๐ฏ');

        const who = prompt(isTraining ? 'ุงุณู ูู ูุฑูุฏ ุฅููุงู ุงูุชูุฑูู:' : 'ุงุณู ูู ูุฑูุฏ ุฅูุบุงุก ุญุงูุฉ ุงูุทูุงุฑุฆ:');
        if (!who) return;
        const reason = prompt('ุณุจุจ ุงูุฅุบูุงู (ุงุฎุชูุงุฑู):') || '';

        const res = await jsonp('closeActiveCommand', {
          closedBy: who,
          closeReason: reason
        });

        if (!res || !res.ok) throw new Error(res?.error || 'closeActiveCommand failed');

        stopAlarmSound();
        toast(isTraining ? 'ุชู ุฅููุงู ุงูุชูุฑูู' : 'ุชู ุฅูุบุงุก ุญุงูุฉ ุงูุทูุงุฑุฆ', 'success');
        await syncActiveCommandUI();
        await refreshLists();
      } catch (e) {
        console.error(e);
        toast('ูุดู ุงูุฅูุบุงุก โ ุชุฃูุฏ ูู ุฅุถุงูุฉ closeActiveCommand ูู Apps Script', 'error');
      }
    }

    function fmtYMD(d){
      const x = new Date(d);
      const y = x.getFullYear();
      const m = String(x.getMonth()+1).padStart(2,'0');
      const day = String(x.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function nowYMD(){
      return fmtYMD(new Date());
    }

    function setRangeInputs(fromId, toId, daysBack){
      const to = new Date();
      const from = new Date();
      from.setDate(from.getDate() - daysBack);
      document.getElementById(fromId).value = fmtYMD(from);
      document.getElementById(toId).value = fmtYMD(to);
    }

    function buildRangeButtons(containerId, onPick){
      const host = document.getElementById(containerId);
      const presets = [
        {k:'today', label:'ุงูููู', days:0},
        {k:'7d', label:'7 ุฃูุงู', days:6},
        {k:'14d', label:'14 ููู', days:13},
        {k:'1m', label:'ุดูุฑ', days:29},
        {k:'2m', label:'ุดูุฑูู', days:59},
      ];
      host.innerHTML = presets.map(p=>`<button class="chip" data-k="${p.k}">${p.label}</button>`).join('');
      host.querySelectorAll('.chip').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          host.querySelectorAll('.chip').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          onPick(presets.find(x=>x.k===btn.dataset.k));
        });
      });
      // default: 14d
      const def = host.querySelector('[data-k="14d"]');
      if (def){ def.click(); }
    }

    function scenarioLabel(key){
      const s = APP.scenarios[key];
      if (s && s.label) return s.label;
      return TYPE_LABELS_FALLBACK[key] || key;
    }

    function faIcon(icon){
      // icon might be like "fa-bolt" or already "fas fa-bolt"
      const s = String(icon||'').trim();
      if (!s) return 'fas fa-circle-info';
      if (s.includes('fa ' ) || s.startsWith('fas ') || s.startsWith('far ') || s.startsWith('fa-solid ')) return s;
      if (s.startsWith('fa-')) return 'fas ' + s;
      return 'fas ' + s;
    }

    /******************************************************
     * Load data from Sheets (Excel) - building/scenarios/roster
     ******************************************************/
    async function loadCoreData(){
      try{
        console.log('loadCoreData: ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...');
        const [b, sg, ro] = await Promise.all([
          jsonp('getBuildingConfig', {}),
          jsonp('getScenarioGuides', {}),
          jsonp('getTrainingRoster', {}),
        ]);
        console.log('loadCoreData: ุงูุจูุงูุงุช ูุตูุช', { building: b, scenarios: sg, roster: ro });

        if (b && b.ok){
          APP.building.floors = Array.isArray(b.floors) ? b.floors : [];
          APP.building.muster = Array.isArray(b.muster) ? b.muster : [];
        }

        if (sg && sg.ok && sg.scenarios){
          APP.scenarios = sg.scenarios;
          // update labels in UI
          ['fire','power','water','injury','outbreak','bls'].forEach(k=>{
            const lbl = scenarioLabel(k);
            const a = document.getElementById('lbl_'+k);
            const b = document.getElementById('btn_'+k);
            const t = document.getElementById('t_'+k);
            if (a) a.textContent = lbl;
            if (b) b.textContent = lbl;
            if (t) t.textContent = lbl;
          });
        }
        
        // ุฅุถุงูุฉ BLS ูู fallback ุฅุฐุง ูู ููู ููุฌูุฏุงู
        if (!APP.scenarios.bls) {
          APP.scenarios.bls = {
            key: 'bls',
            label: 'ุฅูุนุงุด ููุจู ุฑุฆูู (BLS)',
            DO: [
              { stepNo: '1', icon: 'fa-shield', text: 'ุชุฃูุฏ ูู ุณูุงูุฉ ุงูููุงู ูุจู ุงูุงูุชุฑุงุจ' },
              { stepNo: '2', icon: 'fa-hand', text: 'ุงุฑุจุช ุนูู ูุชู ุงููุตุงุจ ูุงุณุฃู: ูู ุฃูุช ุจุฎูุฑุ' },
              { stepNo: '3', icon: 'fa-phone', text: 'ุงุทูุจ ุงููุณุงุนุฏุฉ: ุงุชุตู 997 ุฃู ุฃุฑุณู ุดุฎุต ูุฅุญุถุงุฑ AED' },
              { stepNo: '4', icon: 'fa-lungs', text: 'ุงูุชุญ ูุฌุฑู ุงูููุงุก: ุงุฑูุน ุงูุฐูู ูุฃูู ุงูุฑุฃุณ ููุฎูู' },
              { stepNo: '5', icon: 'fa-eye', text: 'ุงูุธุฑ ูุงุณูุน ูุชุญุณุณ ุงูุชููุณ ููุฏุฉ 10 ุซูุงูู' },
              { stepNo: '6', icon: 'fa-hands', text: 'ุงุจุฏุฃ ุถุบุทุงุช ุงูุตุฏุฑ: 30 ุถุบุทุฉ ุจุนูู 5-6 ุณู' },
              { stepNo: '7', icon: 'fa-wind', text: 'ุฃุนุท ููุณูู ุฅููุงุฐ (ุฅุฐุง ูุฏุฑุจ)' },
              { stepNo: '8', icon: 'fa-repeat', text: 'ูุฑุฑ ุฏูุฑุฉ 30:2 ุญุชู ูุตูู AED ุฃู ุงูุฅุณุนุงู' },
              { stepNo: '9', icon: 'fa-bolt', text: 'ุงุณุชุฎุฏู AED ููุฑ ูุตููู ูุงุชุจุน ุงูุชุนูููุงุช ุงูุตูุชูุฉ' },
              { stepNo: '10', icon: 'fa-clock', text: 'ูุง ุชุชููู ุญุชู ูุณุชุนูุฏ ุงููุตุงุจ ูุนูู ุฃู ูุตู ุงูุฅุณุนุงู' }
            ],
            DONT: [
              { stepNo: '1', icon: 'fa-running', text: 'ูุง ุชุชุฑู ุงููุตุงุจ ูุญุฏู ุฃุจุฏุงู' },
              { stepNo: '2', icon: 'fa-hourglass', text: 'ูุง ุชุถูุน ุงูููุช ูู ูุญูุตุงุช ุบูุฑ ุถุฑูุฑูุฉ' },
              { stepNo: '3', icon: 'fa-hand-paper', text: 'ูุง ุชุถุบุท ุนูู ุงูุจุทู ุฃู ุงูุฃุถูุงุน' },
              { stepNo: '4', icon: 'fa-pause', text: 'ูุง ุชุชููู ุนู ุงูุถุบุทุงุช ูุฃูุซุฑ ูู 10 ุซูุงูู' },
              { stepNo: '5', icon: 'fa-water', text: 'ูุง ุชุนุทู ุงููุงุก ุฃู ุงูุทุนุงู ูููุตุงุจ' }
            ]
          };
        }

        if (ro && ro.ok){
          APP.roster = Array.isArray(ro.roster) ? ro.roster : [];
        }

        renderBuilding();
        renderMuster();
        renderRoster();
        populateTrainerDropdown();

        // default show fire guide
        showScenarioGuide('fire');

      } catch(e){
        console.error('loadCoreData ERROR:', e);
        toast('โ๏ธ ุชุนุฐุฑ ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ: ' + e.message, 'error');
        // fallback minimal render
        renderBuildingFallback();
        renderMusterFallback();
        renderRosterFallback();
      }
    }

    function renderBuilding(){
      const host = document.getElementById('buildingView');
      if (!host) return;

      if (!APP.building.floors || APP.building.floors.length === 0){
        renderBuildingFallback();
        return;
      }

      host.innerHTML = APP.building.floors.map(f=>{
        const deptHtml = (f.departments||[]).map(d=>{
          return `
            <div class="dept-card" data-dept="${escapeHtml(d.name)}" data-id="${escapeHtml(d.id)}" onclick="selectDept(event,'${escapeHtml(d.id)}')">
              <i class="${faIcon(d.icon)}"></i>
              ${escapeHtml(d.name)}
            </div>
          `;
        }).join('');

        return `
          <div class="floor" data-floor="${escapeHtml(f.floorKey)}" onclick="selectFloor('${escapeHtml(f.floorKey)}')">
            <div class="floor-header">
              <div class="floor-name">
                <div class="floor-icon"><i class="fas fa-layer-group"></i></div>
                <span>${escapeHtml(f.floorName)}</span>
              </div>
              <span class="floor-status">ุขูู</span>
            </div>
            <div class="departments-grid">${deptHtml}</div>
          </div>
        `;
      }).join('');
    }

    function renderBuildingFallback(){
      const host = document.getElementById('buildingView');
      if (!host) return;
      host.innerHTML = `
        <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
          ูุง ุชูุฌุฏ ุจูุงูุงุช ูุจูู ูู ุงูุฅูุณู (EOC_MAP).
        </div>
      `;
    }

    function renderMuster(){
      const host = document.getElementById('musterPoints');
      if (!host) return;

      if (!APP.building.muster || APP.building.muster.length === 0){
        renderMusterFallback();
        return;
      }

      host.innerHTML = APP.building.muster.map(m=>{
        return `
          <div class="muster-card" data-key="${escapeHtml(m.key)}">
            <i class="fas fa-map-marker-alt"></i>
            <h4>${escapeHtml(m.name)}</h4>
            <p>${escapeHtml(m.desc || '')}</p>
          </div>
        `;
      }).join('');
    }

    function renderMusterFallback(){
      const host = document.getElementById('musterPoints');
      if (!host) return;
      host.innerHTML = `
        <div class="muster-card" data-key="A">
          <i class="fas fa-map-marker-alt"></i><h4>ููุทุฉ ุชุฌูุน A</h4><p>ุงููููู ุงูุฃูุงูู</p>
        </div>
        <div class="muster-card" data-key="B">
          <i class="fas fa-map-marker-alt"></i><h4>ููุทุฉ ุชุฌูุน B</h4><p>ุงูุณุงุญุฉ ุงูุฎูููุฉ</p>
        </div>
      `;
    }

    function renderRoster(){
      const host = document.getElementById('rosterList');
      if (!host) return;

      if (!APP.roster || APP.roster.length === 0){
        renderRosterFallback();
        return;
      }

      host.innerHTML = APP.roster.map((p, idx)=>{
        const id = 'r_' + idx;
        const selected = APP.train.selectedRoster.has(id);
        const borderColor = selected ? 'rgba(16,185,129,.55)' : 'rgba(255,255,255,.1)';
        const bgColor = selected ? 'rgba(16,185,129,.12)' : 'rgba(255,255,255,.05)';
        const checkBg = selected ? 'rgba(16,185,129,.9)' : 'transparent';
        const checkIcon = selected ? '<i class="fas fa-check" style="font-size:.8rem"></i>' : '';
        const roleText = p.role ? (' โข ' + escapeHtml(p.role)) : '';
        return '<div class="mini-item" style="cursor:pointer;border-color:' + borderColor + ';background:' + bgColor + '" onclick="toggleRoster(\'' + id + '\')">' +
          '<div class="mini-row">' +
            '<div style="display:flex;align-items:center;gap:10px">' +
              '<span style="width:22px;height:22px;border-radius:6px;border:2px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;background:' + checkBg + '">' +
                checkIcon +
              '</span>' +
              '<div>' +
                '<div style="font-weight:1000">' + escapeHtml(p.name || '') + '</div>' +
                '<div style="opacity:.75;font-weight:800;font-size:.85rem">' + escapeHtml(p.department || '') + roleText + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');

      updateRosterCount();
    }

    function renderRosterFallback(){
      const host = document.getElementById('rosterList');
      if (!host) return;
      host.innerHTML = `
        <div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">
          ูุง ุชูุฌุฏ ูุงุฆูุฉ ูุชุฏุฑุจูู ูู ุงูุฅูุณู (Training_Roster).
        </div>
      `;
      updateRosterCount();
    }

    /******************************************************
     * Building interactions
     ******************************************************/
    function selectFloor(floorKey){
      document.querySelectorAll('.floor').forEach(f=>f.classList.remove('active'));
      const el = document.querySelector(`.floor[data-floor="${CSS.escape(String(floorKey))}"]`);
      if (el) el.classList.add('active');
    }

    function selectDept(ev, deptId){
      ev.stopPropagation();
      document.querySelectorAll('.dept-card').forEach(d=>d.classList.remove('selected'));
      const card = ev.currentTarget;
      if (card) card.classList.add('selected');
    }

    function highlightLocation(text){
      document.querySelectorAll('.dept-card').forEach(d=>d.classList.remove('emergency-highlight'));
      const t = String(text||'').trim();
      if (!t) return;

      document.querySelectorAll('.dept-card').forEach(card=>{
        const label = card.textContent.trim();
        if (label && t.includes(label)){
          card.classList.add('emergency-highlight');
          card.scrollIntoView({behavior:'smooth',block:'center'});
        }
      });
    }

    /******************************************************
     * Scenario guide
     ******************************************************/
    function showScenarioGuide(key){
      document.querySelectorAll('.scenario-icon').forEach(x=>x.classList.remove('active'));
      const btn = document.querySelector(`.scenario-icon[data-s="${CSS.escape(key)}"]`);
      if (btn) btn.classList.add('active');

      const wrap = document.getElementById('guideWrap');
      const title = document.getElementById('guideTitle');
      const doBox = document.getElementById('guideDo');
      const dontBox = document.getElementById('guideDont');

      const s = APP.scenarios[key];
      const lbl = scenarioLabel(key);

      title.innerHTML = `<i class="fas ${SCENARIO_META[key]?.icon || 'fa-circle-info'}"></i> ${escapeHtml(lbl)}`;

      const DO = (s && s.DO) ? s.DO : [];
      const DONT = (s && s.DONT) ? s.DONT : [];

      doBox.innerHTML = DO.length ? DO.map(step=>`
        <div class="guide-step">
          <div class="num">${escapeHtml(step.stepNo)}</div>
          <i class="${faIcon(step.icon)}"></i>
          <div class="txt">${escapeHtml(step.text)}</div>
        </div>
      `).join('') : `<div style="opacity:.85;font-weight:900">ูุง ุชูุฌุฏ ุฎุทูุงุช (DO) ูู ุงูุฅูุณู.</div>`;

      dontBox.innerHTML = DONT.length ? DONT.map(step=>`
        <div class="guide-step">
          <div class="num">${escapeHtml(step.stepNo)}</div>
          <i class="${faIcon(step.icon)}"></i>
          <div class="txt">${escapeHtml(step.text)}</div>
        </div>
      `).join('') : `<div style="opacity:.85;font-weight:900">ูุง ุชูุฌุฏ ุฎุทูุงุช (DON'T) ูู ุงูุฅูุณู.</div>`;

      wrap.classList.add('active');
    }

    /******************************************************
     * Activation flow (manual start = same as real report)
     ******************************************************/
    function openActivationModal(){ document.getElementById('activationModal').classList.add('active'); }
    function closeActivationModal(){ document.getElementById('activationModal').classList.remove('active'); }

    function manualStart(type){
      closeActivationModal();

      const isDrill = (type === 'drill');
      const scenarioKey = isDrill ? (APP.train.scenarioKey || 'fire') : type;

      // pseudo-report object (same flow as real report)
      const report = {
        id: 'MANUAL-' + Date.now(),
        date: nowYMD(),
        time: new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
        type: isDrill ? ('๐ฏ ุชูุฑูู - ' + scenarioLabel(scenarioKey)) : scenarioLabel(scenarioKey),
        location: 'ุฌููุน ุงูุฃุฏูุงุฑ',
        notes: isDrill ? 'ุชูุฑูู ูููุนูู ูู EOC' : 'ุชูุนูู ูุฏูู ูู EOC',
        status: 'ุฌุฏูุฏ',
        isDrill,
        scenarioKey
      };

      openResponseForReport(report, true);
    }

    /******************************************************
     * Response modal
     ******************************************************/
    function openResponseForReport(report, isManual=false){
      APP.currentReport = report;
      APP.responseType = '';
      APP.selectedLocations = new Set();
      APP.selectedMuster = '';

      document.getElementById('rmType').textContent = report.type || '-';
      document.getElementById('rmLocation').textContent = report.location || '-';
      document.getElementById('rmNotes').textContent = report.notes || '-';
      document.getElementById('rmId').textContent = report.id || '-';

      document.querySelectorAll('.rtype-btn').forEach(b=>{
        b.classList.remove('selected','full','team','iso');
      });

      document.getElementById('locationBlock').style.display = 'none';
      document.getElementById('musterBlock').style.display = 'none';
      document.getElementById('locationGrid').innerHTML = '';
      document.getElementById('musterGrid').innerHTML = '';
      document.getElementById('customLocation').value = '';

      document.getElementById('issueBtn').disabled = true;

      // helpful highlight
      highlightLocation(report.location);

      document.getElementById('responseModal').classList.add('active');
    }

    function closeResponseModal(){
      document.getElementById('responseModal').classList.remove('active');
      // ุฅููุงู ุงูุตูุช ุนูุฏ ุงูุฑุฌูุน ุจุฏูู ุฅุฌุฑุงุก
      stopAlarmSound();
      // ุฅุนุงุฏุฉ ุงูุญุงูุฉ ูููุถุน ุงูุขูู
      setStatusAlert(false);
    }

    function selectResponseType(rt){
      APP.responseType = rt;

      document.querySelectorAll('.rtype-btn').forEach(b=>{
        b.classList.remove('selected','full','team','iso');
      });
      const btn = document.querySelector(`.rtype-btn[data-rt="${CSS.escape(rt)}"]`);
      if (btn){
        btn.classList.add('selected');
        if (rt==='full_evacuation') btn.classList.add('full');
        if (rt==='send_team') btn.classList.add('team');
        if (rt==='isolation_evacuation') btn.classList.add('iso');
      }

      // build location options dynamically from building config
      const locGrid = document.getElementById('locationGrid');
      const options = [];

      // always include "ูููุน ุงูุจูุงุบ" if real report and has location
      options.push({ id:'report_location', label:'ูููุน ุงูุจูุงุบ', icon:'fa-location-dot' });
      // building
      options.push({ id:'building', label:'ุงููุจูู ุจุงููุงูู', icon:'fa-building' });

      // floors
      (APP.building.floors||[]).forEach(f=>{
        options.push({ id:'floor_'+f.floorKey, label:f.floorName, icon:'fa-layer-group' });
      });

      locGrid.innerHTML = options.map(o=>`
        <button type="button" class="loc-btn" data-loc="${escapeHtml(o.id)}" onclick="toggleLocation('${escapeHtml(o.id)}')">
          <i class="fas ${escapeHtml(o.icon)}"></i> ${escapeHtml(o.label)}
        </button>
      `).join('');

      // muster required for evac + isolation
      const needsMuster = (rt === 'full_evacuation' || rt === 'isolation_evacuation');

      document.getElementById('locationBlock').style.display = 'block';
      document.getElementById('musterBlock').style.display = needsMuster ? 'block' : 'none';

      if (needsMuster){
        renderMusterChoices();
      }

      updateIssueButtonState();
    }

    function toggleLocation(locId){
      const id = String(locId);
      const btn = document.querySelector(`.loc-btn[data-loc="${CSS.escape(id)}"]`);
      if (APP.selectedLocations.has(id)){
        APP.selectedLocations.delete(id);
        if (btn) btn.classList.remove('selected');
      } else {
        APP.selectedLocations.add(id);
        if (btn) btn.classList.add('selected');
      }
      updateIssueButtonState();
    }

    function renderMusterChoices(){
      const host = document.getElementById('musterGrid');
      const ms = (APP.building.muster && APP.building.muster.length) ? APP.building.muster : [
        {key:'A',name:'ููุทุฉ ุชุฌูุน A',desc:'ุงููููู ุงูุฃูุงูู'},
        {key:'B',name:'ููุทุฉ ุชุฌูุน B',desc:'ุงูุณุงุญุฉ ุงูุฎูููุฉ'},
      ];

      host.innerHTML = ms.map(m=>`
        <button type="button" class="muster-btn" data-m="${escapeHtml(m.key)}" onclick="selectMuster('${escapeHtml(m.key)}')">
          <i class="fas fa-map-marker-alt"></i> ${escapeHtml(m.name)}
        </button>
      `).join('');
    }

    function selectMuster(key){
      APP.selectedMuster = String(key);
      document.querySelectorAll('.muster-btn').forEach(b=>b.classList.remove('selected'));
      const btn = document.querySelector(`.muster-btn[data-m="${CSS.escape(APP.selectedMuster)}"]`);
      if (btn) btn.classList.add('selected');
      updateIssueButtonState();
    }

    function updateIssueButtonState(){
      const issue = document.getElementById('issueBtn');
      if (!issue) return;

      if (!APP.responseType){
        issue.disabled = true;
        return;
      }

      const custom = document.getElementById('customLocation').value.trim();
      const hasLocation = APP.selectedLocations.size > 0 || !!custom;

      const needsMuster = (APP.responseType === 'full_evacuation' || APP.responseType === 'isolation_evacuation');
      const hasMuster = !needsMuster || !!APP.selectedMuster;

      issue.disabled = !(hasLocation && hasMuster);
    }

    function resolveLocationLabel(locId){
      if (locId === 'report_location') return APP.currentReport?.location || 'ูููุน ุงูุจูุงุบ';
      if (locId === 'building') return 'ุงููุจูู ุจุงููุงูู';
      if (locId.startsWith('floor_')){
        const k = locId.replace('floor_','');
        const f = (APP.building.floors||[]).find(x=>String(x.floorKey)===String(k));
        return f ? f.floorName : ('ุงูุฏูุฑ ' + k);
      }
      return locId;
    }

    function resolveMusterLabel(key){
      const m = (APP.building.muster||[]).find(x=>String(x.key)===String(key));
      if (m) return `${m.name}${m.desc ? ' - ' + m.desc : ''}`;
      return key;
    }

    async function issueCommand(){
      const report = APP.currentReport;
      if (!report) return;

      const custom = document.getElementById('customLocation').value.trim();
      const locParts = Array.from(APP.selectedLocations).map(resolveLocationLabel);
      if (custom) locParts.push(custom);

      const location = locParts.join(' + ');
      const muster = APP.selectedMuster ? resolveMusterLabel(APP.selectedMuster) : '';

      // determine scenarioKey for reports
      const scenarioKey = report.scenarioKey || scenarioKeyFromReportType(report.type) || 'fire';
      const scenarioLabel = scenarioLabelFromReportType(report.type) || scenarioLabel(scenarioKey);

      const mode = report.isDrill ? 'training' : 'real';

      const cmd = {
        responseType: APP.responseType,
        reportType: report.type,
        location,
        muster,
        mode,
        scenarioKey,
        scenarioLabel
      };

      try{
        const res = await jsonp('setActiveCommand', cmd);
        if (!res || !res.ok) throw new Error(res?.error || 'setActiveCommand failed');

        // update report status only for real EMR reports
        if (!report.id.startsWith('MANUAL-') && !report.isDrill){
          await safeUpdateReportStatus(report.id, 'ููุฏ ุงููุนุงูุฌุฉ', 'EOC', 'ุชู ุฅุตุฏุงุฑ ุฃูุฑ: ' + APP.responseType);
        }

        // ุฅููุงู ุงูุตูุช ุจุนุฏ ุงูุชุนุงูู ูุน ุงูุจูุงุบ
        stopAlarmSound();
        
        closeResponseModal();
        openCommandScreen(cmd, report);
        toast('ุชู ุฅุฑุณุงู ุงูุฃูุฑ ููุดุงุดุงุช ุจูุฌุงุญ', 'success');
        setStatusAlert(true, report.isDrill ? '๐ฏ ุชูุฑูู ุฌุงุฑู' : 'ุญุงูุฉ ุทูุงุฑุฆ!');

      } catch(e){
        console.error(e);
        toast('ูุดู ุฅุฑุณุงู ุงูุฃูุฑ ููุดุงุดุงุช: ' + (e.message || ''), 'error');
      }
    }

    function openCommandScreen(cmd, report){
      // title by response type
      const map = {
        full_evacuation: {t:'ุฅุฎูุงุก', i:'fa-running'},
        send_team: {t:'ุชูุฌูู ูุฑูู', i:'fa-users'},
        isolation_evacuation: {t:'ุนุฒู', i:'fa-shield-virus'}
      };
      const x = map[cmd.responseType] || {t:'ุฃูุฑ', i:'fa-bullhorn'};

      document.getElementById('cmdTitle').innerHTML = `<i class="fas ${x.i}"></i> ${escapeHtml(x.t)}`;
      document.getElementById('cmdReportType').textContent = cmd.reportType || '-';
      document.getElementById('cmdLocation').textContent = cmd.location || '-';

      const mw = document.getElementById('cmdMusterWrap');
      if (cmd.muster){
        mw.style.display = 'block';
        document.getElementById('cmdMuster').textContent = cmd.muster;
      } else {
        mw.style.display = 'none';
      }

      window.__CMD_STATE__ = {
        startedAt: Date.now(),
        reportId: report?.id || '',
        isDrill: !!report?.isDrill,
        timer: null
      };

      const timerEl = document.getElementById('cmdTimer');
      timerEl.textContent = '00:00';
      if (window.__CMD_STATE__.timer) clearInterval(window.__CMD_STATE__.timer);
      window.__CMD_STATE__.timer = setInterval(()=>{
        const diff = Math.floor((Date.now() - window.__CMD_STATE__.startedAt)/1000);
        const mm = String(Math.floor(diff/60)).padStart(2,'0');
        const ss = String(diff%60).padStart(2,'0');
        timerEl.textContent = `${mm}:${ss}`;
      }, 1000);

      document.getElementById('commandScreen').classList.add('active');
    }

    async function endCommand(clearRemote){
      // close modal
      document.getElementById('commandScreen').classList.remove('active');

      try{
        if (window.__CMD_STATE__ && window.__CMD_STATE__.timer){
          clearInterval(window.__CMD_STATE__.timer);
        }
      } catch(e){}

      if (!clearRemote) return;

      try{
        const res = await jsonp('clearActiveCommand', {});
        if (!res || !res.ok) throw new Error(res?.error || 'clearActiveCommand failed');

        // if there was a real report, close it
        const st = window.__CMD_STATE__ || {};
        if (st.reportId && !String(st.reportId).startsWith('MANUAL-') && !st.isDrill){
          await safeUpdateReportStatus(st.reportId, 'ูุบูู', 'EOC', 'ุชู ุฅููุงุก ุงูุฃูุฑ');
        }

        // ุฅููุงู ุงูุตูุช ุนูุฏ ุฅููุงุก ุงูุฃูุฑ
        stopAlarmSound();
        
        setStatusAlert(false);
        toast('ุชู ุฅููุงุก ุงูุฃูุฑ ููุณุญู ูู ุงูุดุงุดุงุช', 'success');
        await refreshLists();
      } catch(e){
        console.error(e);
        toast('ุชุนุฐุฑ ูุณุญ ุงูุฃูุฑ ูู ุงูุดุงุดุงุช', 'error');
      }
    }

    function scenarioKeyFromReportType(type){
      const t = String(type||'');
      if (t.includes('ุญุฑูู')) return 'fire';
      if (t.includes('ููุฑุจุงุก')) return 'power';
      if (t.includes('ููุงู')) return 'water';
      if (t.includes('ุฅุบูุงุก') || t.includes('ุฅุตุงุจุฉ')) return 'injury';
      if (t.includes('ุนุฏูู')) return 'outbreak';
      if (t.includes('ุชูุฑูู')) return 'fire';
      return 'fire';
    }
    function scenarioLabelFromReportType(type){
      // if reportType already Arabic label, keep it
      return String(type||'').replace('๐ฏ','').trim();
    }

    /******************************************************
     * Reports (real) polling
     ******************************************************/
    async function fetchEmergencyReports(limit=30){
      const res = await jsonp('getEmergencyReports', { limit: String(limit) });
      if (!res || !res.ok) throw new Error(res?.error || 'getEmergencyReports failed');
      return Array.isArray(res.reports) ? res.reports : [];
    }

    async function safeUpdateReportStatus(reportId, status, responder, actionNotes){
      // doGet action name is updateEmergencyStatus in your script
      const res = await jsonp('updateEmergencyStatus', {
        reportId: String(reportId),
        status: String(status),
        responder: String(responder || ''),
        actionNotes: String(actionNotes || '')
      });
      if (!res || !res.ok) throw new Error(res?.error || 'updateEmergencyStatus failed');
      return res;
    }

    function statusPillClass(s){
      const t = String(s||'').trim();
      if (t === 'ุฌุฏูุฏ') return 'new';
      if (t === 'ููุฏ ุงููุนุงูุฌุฉ') return 'pending';
      if (t === 'ูุบูู') return 'closed';
      return 'pending';
    }

    async function pollReports(){
      try{
        const reports = await fetchEmergencyReports(60);
        APP.caches.reports = reports;

        // detect new
        const newOnes = reports.filter(r=> String(r.status||'')==='ุฌุฏูุฏ' && !APP.alerted.has(String(r.id)));
        if (newOnes.length){
          newOnes.forEach(r=>APP.alerted.add(String(r.id)));
          localStorage.setItem('eoc_alerted_reports', JSON.stringify(Array.from(APP.alerted)));

          const r = newOnes[0];
          // alert with loud sound
          playAlarmSound();
          toast('๐จ ุจูุงุบ ุทูุงุฑุฆ ุฌุฏูุฏ: ' + (r.type || ''), 'error');
          highlightLocation(r.location);

          // open response flow
          const report = {
            id: String(r.id||''),
            date: String(r.date||''),
            time: String(r.time||''),
            type: String(r.type||''),
            location: String(r.location||''),
            notes: String(r.notes||''),
            status: String(r.status||'ุฌุฏูุฏ'),
            isDrill: false,
            scenarioKey: scenarioKeyFromReportType(r.type)
          };
          openResponseForReport(report);
        }

        renderMiniReports();
      } catch(e){
        console.error(e);
        // do not spam
      }
    }

    function renderMiniReports(){
      const host = document.getElementById('miniReportsList');
      if (!host) return;

      const list = (APP.caches.reports || []).slice(0,10);
      if (!list.length){
        host.innerHTML = `<div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">ูุง ุชูุฌุฏ ุจูุงุบุงุช</div>`;
        return;
      }

      host.innerHTML = list.map(r=>{
        const st = String(r.status||'ุฌุฏูุฏ');
        return `
          <div class="mini-item">
            <div class="mini-row">
              <div style="font-weight:1000"><i class="fas ${getReportIcon(r.type)}" style="color:var(--secondary)"></i> ${escapeHtml(r.type||'')}</div>
              <span class="pill ${statusPillClass(st)}">${escapeHtml(st)}</span>
            </div>
            <div style="margin-top:6px;opacity:.85;font-weight:800">
              <i class="fas fa-map-marker-alt"></i> ${escapeHtml(r.location||'')}
            </div>
            <div style="margin-top:4px;opacity:.75;font-weight:800;font-size:.9rem">
              <i class="fas fa-clock"></i> ${escapeHtml(r.date||'')} - ${escapeHtml(r.time||'')}
            </div>
          </div>
        `;
      }).join('');
    }

    function getReportIcon(type){
      const t = String(type||'');
      if (t.includes('ุญุฑูู')) return 'fa-fire';
      if (t.includes('ููุฑุจุงุก')) return 'fa-bolt';
      if (t.includes('ููุงู')) return 'fa-tint';
      if (t.includes('ุฅุบูุงุก') || t.includes('ุฅุตุงุจุฉ')) return 'fa-heartbeat';
      if (t.includes('ุนุฏูู')) return 'fa-virus';
      return 'fa-triangle-exclamation';
    }

    /******************************************************
     * Training sessions (log)
     ******************************************************/
    function toYMD(value){
      if (!value) return '';
      const s = String(value).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(value);
      if (!isNaN(d.getTime())){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }
      return s;
    }

    async function fetchTrainingSessions(limit=250){
      const res = await jsonp('getTrainingSessions', { limit:String(limit) });
      if (!res || !res.ok) throw new Error(res?.error || 'getTrainingSessions failed');
      const sessions = Array.isArray(res.sessions) ? res.sessions : [];
      return sessions.map(s => ({
        ...s,
        _dateYMD: toYMD(s.date),
      }));
    }

    async function refreshMiniTraining(){
      try{
        const list = await fetchTrainingSessions(30);
        APP.caches.trainingSessions = list;
        renderMiniTraining();
      } catch(e){
        console.error(e);
        document.getElementById('miniTrainingList').innerHTML =
          `<div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">ุชุนุฐุฑ ุชุญููู ุณุฌู ุงูุชุฏุฑูุจ</div>`;
      }
    }

    function renderMiniTraining(){
      const host = document.getElementById('miniTrainingList');
      const list = (APP.caches.trainingSessions||[]).slice(0,10);
      if (!list.length){
        host.innerHTML = `<div class="mini-item" style="text-align:center;color:var(--muted);font-weight:900">ูุง ุชูุฌุฏ ุฌูุณุงุช</div>`;
        return;
      }
      host.innerHTML = list.map(s=>{
        const label = s.scenarioLabel || scenarioLabel(s.scenarioKey) || '-';
        const dur = (s.durationMin!=null) ? String(s.durationMin) : '';
        return `
          <div class="mini-item">
            <div class="mini-row">
              <div style="font-weight:1000"><i class="fas fa-clipboard-check" style="color:var(--secondary)"></i> ${escapeHtml(label)}</div>
              <span class="pill closed">${escapeHtml(dur ? (dur+' ุฏ') : '')}</span>
            </div>
            <div style="margin-top:6px;opacity:.85;font-weight:800">
              <i class="fas fa-user-tie"></i> ${escapeHtml(s.trainer||'-')}
            </div>
            <div style="margin-top:4px;opacity:.75;font-weight:800;font-size:.9rem">
              <i class="fas fa-clock"></i> ${escapeHtml(s._dateYMD || toYMD(s.date) || '')} - ${escapeHtml(s.startTime||'')}
            </div>
          </div>
        `;
      }).join('');
    }

    /******************************************************
     * Training modal logic
     ******************************************************/
    function openTrainingModal(){
      APP.train.active = true;
      APP.train.startMs = Date.now();
      APP.train.scenarioKey = '';
      APP.train.selectedRoster = new Set();

      updateTrainingTimer(true);
      APP.train.timer = setInterval(()=>updateTrainingTimer(false), 1000);

      // reset UI
      document.getElementById('trainerName').value = '';
      document.getElementById('trainingGuide').style.display = 'none';
      document.querySelectorAll('#trainScenarioIcons .scenario-icon').forEach(x=>x.classList.remove('active'));

      renderRoster(); // refresh selection state
      updateTrainingSaveState();

      document.getElementById('trainingModal').classList.add('active');
    }

    function closeTrainingModal(){
      document.getElementById('trainingModal').classList.remove('active');
      APP.train.active = false;
      if (APP.train.timer) clearInterval(APP.train.timer);
      APP.train.timer = null;
      APP.train.startMs = 0;
      APP.train.scenarioKey = '';
      APP.train.selectedRoster = new Set();
      updateRosterCount();
    }

    function updateTrainingTimer(reset){
      if (!APP.train.active) return;
      const elapsed = Math.floor((Date.now() - APP.train.startMs)/1000);
      const hh = String(Math.floor(elapsed/3600)).padStart(2,'0');
      const mm = String(Math.floor((elapsed%3600)/60)).padStart(2,'0');
      const ss = String(elapsed%60).padStart(2,'0');
      document.getElementById('trainTimer').textContent = `${hh}:${mm}:${ss}`;
    }

    function toggleRoster(id){
      if (APP.train.selectedRoster.has(id)) APP.train.selectedRoster.delete(id);
      else APP.train.selectedRoster.add(id);
      renderRoster();
      updateTrainingSaveState();
    }

    function updateRosterCount(){
      const c = document.getElementById('rosterCount');
      if (c) c.textContent = String(APP.train.selectedRoster.size || 0);
    }

    function selectTrainingScenario(key){
      APP.train.scenarioKey = key;
      document.querySelectorAll('#trainScenarioIcons .scenario-icon').forEach(x=>x.classList.remove('active'));
      const el = document.querySelector(`#trainScenarioIcons .scenario-icon[data-s="${CSS.escape(key)}"]`);
      if (el) el.classList.add('active');

      // render guide
      const s = APP.scenarios[key] || null;
      const title = document.getElementById('trainingGuideTitle');
      const doBox = document.getElementById('trainingDo');
      const dontBox = document.getElementById('trainingDont');

      title.innerHTML = `<i class="fas ${SCENARIO_META[key]?.icon || 'fa-circle-info'}"></i> ${escapeHtml('ุชูุฑูู: ' + scenarioLabel(key))}`;
      const DO = (s && s.DO) ? s.DO : [];
      const DONT = (s && s.DONT) ? s.DONT : [];

      doBox.innerHTML = DO.length ? DO.map(step=>`
        <div class="guide-step">
          <div class="num">${escapeHtml(step.stepNo)}</div>
          <i class="${faIcon(step.icon)}"></i>
          <div class="txt">${escapeHtml(step.text)}</div>
        </div>
      `).join('') : `<div style="opacity:.85;font-weight:900">ูุง ุชูุฌุฏ ุฎุทูุงุช (DO).</div>`;

      dontBox.innerHTML = DONT.length ? DONT.map(step=>`
        <div class="guide-step">
          <div class="num">${escapeHtml(step.stepNo)}</div>
          <i class="${faIcon(step.icon)}"></i>
          <div class="txt">${escapeHtml(step.text)}</div>
        </div>
      `).join('') : `<div style="opacity:.85;font-weight:900">ูุง ุชูุฌุฏ ุฎุทูุงุช (DON'T).</div>`;

      document.getElementById('trainingGuide').style.display = 'block';
      
      // ุฅุถุงูุฉ ุฒุฑ Metronome ูุชุฏุฑูุจ BLS
      const metronomeContainer = document.getElementById('metronomeContainer');
      if (metronomeContainer) {
        if (key === 'bls') {
          metronomeContainer.style.display = 'block';
        } else {
          metronomeContainer.style.display = 'none';
          stopMetronome();
        }
      }
      
      updateTrainingSaveState();
    }

    // ========== ุตูุช Metronome ููุชุฏุฑูุจ ุนูู ุถุบุทุงุช ุงูุตุฏุฑ ==========
    let metronomeAudioCtx = null;
    let metronomeInterval = null;
    let metronomePlaying = false;
    
    function startMetronome() {
      if (metronomePlaying) return;
      
      try {
        if (!metronomeAudioCtx) {
          metronomeAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (metronomeAudioCtx.state === 'suspended') {
          metronomeAudioCtx.resume();
        }
        
        metronomePlaying = true;
        const btn = document.getElementById('metronomeBtn');
        if (btn) {
          btn.innerHTML = '<i class="fas fa-stop"></i> ุฅููุงู ุงูุฅููุงุน';
          btn.classList.add('active');
        }
        
        let beatCount = 0;
        
        function playBeat() {
          if (!metronomePlaying) return;
          
          beatCount++;
          const osc = metronomeAudioCtx.createOscillator();
          const gain = metronomeAudioCtx.createGain();
          
          // ูู 30 ุถุบุทุฉ ูุนุทู ุตูุช ูุฎุชูู (ููุชุฐููุฑ ุจุงูููุณูู)
          if (beatCount % 30 === 0) {
            osc.type = 'sine';
            osc.frequency.value = 880; // ุตูุช ุนุงูู ููุชุฐููุฑ
            gain.gain.value = 0.5;
          } else {
            osc.type = 'square';
            osc.frequency.value = 440;
            gain.gain.value = 0.3;
          }
          
          osc.connect(gain);
          gain.connect(metronomeAudioCtx.destination);
          
          const now = metronomeAudioCtx.currentTime;
          gain.gain.setValueAtTime(gain.gain.value, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
          
          osc.start(now);
          osc.stop(now + 0.1);
        }
        
        playBeat();
        // 110 ูุจุถุฉ/ุฏูููุฉ = 545ms ุจูู ูู ูุจุถุฉ (ูุนุฏู ุถุบุทุงุช ุงูุตุฏุฑ ุงููุซุงูู)
        metronomeInterval = setInterval(playBeat, 545);
        
        toast('๐ต Metronome: 110 ูุจุถุฉ/ุฏูููุฉ - ุงุถุบุท ูุน ุงูุฅููุงุน!', 'info');
        
      } catch(e) {
        console.error('Metronome error:', e);
        toast('ุชุนุฐุฑ ุชุดุบูู ุตูุช ุงูุฅููุงุน', 'warn');
      }
    }
    
    function stopMetronome() {
      metronomePlaying = false;
      if (metronomeInterval) {
        clearInterval(metronomeInterval);
        metronomeInterval = null;
      }
      const btn = document.getElementById('metronomeBtn');
      if (btn) {
        btn.innerHTML = '<i class="fas fa-drum"></i> ุชุดุบูู ุฅููุงุน ุงูุถุบุทุงุช';
        btn.classList.remove('active');
      }
    }
    
    function toggleMetronome() {
      if (metronomePlaying) {
        stopMetronome();
      } else {
        startMetronome();
      }
    }

    /******************************************************
     * BLS Full Training Modal
     ******************************************************/
    let blsAudioCtx = null;
    let blsMetronomeInterval = null;
    let blsPlaying = false;
    let blsCompressionCount = 0;
    let breathOverlayTimeout = null;
    
    function openBLSFullTraining() {
      document.getElementById('blsTrainingModal').classList.add('active');
      document.body.style.overflow = 'hidden';
      blsCompressionCount = 0;
      updateCompressionCounter();
    }
    
    function closeBLSTraining() {
      stopBLSMetronome();
      document.getElementById('blsTrainingModal').classList.remove('active');
      document.body.style.overflow = '';
      hideBreathOverlay();
    }
    
    function switchBLSTab(tab) {
      document.querySelectorAll('.bls-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.bls-tab[data-tab="${tab}"]`).classList.add('active');
      
      document.getElementById('tabCompressions').style.display = tab === 'compressions' ? 'block' : 'none';
      document.getElementById('tabBreathing').style.display = tab === 'breathing' ? 'block' : 'none';
      document.getElementById('tabAed').style.display = tab === 'aed' ? 'block' : 'none';
    }
    
    function updateCompressionCounter() {
      const el = document.getElementById('compressionCount');
      if (el) el.textContent = blsCompressionCount;
    }
    
    function toggleBLSMetronome() {
      if (blsPlaying) {
        stopBLSMetronome();
      } else {
        startBLSMetronome();
      }
    }
    
    function startBLSMetronome() {
      if (blsPlaying) return;
      
      try {
        if (!blsAudioCtx) {
          blsAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (blsAudioCtx.state === 'suspended') {
          blsAudioCtx.resume();
        }
        
        blsPlaying = true;
        blsCompressionCount = 0;
        updateCompressionCounter();
        
        const btn = document.getElementById('blsMetronomeBtn');
        if (btn) btn.innerHTML = '<i class="fas fa-stop"></i> ุฅููุงู ุงูุชุฏุฑูุจ';
        
        function playBeat() {
          if (!blsPlaying) return;
          
          blsCompressionCount++;
          updateCompressionCounter();
          
          // ุชุญุฏูุซ ุงูุนุฑุถ ุงูุจุตุฑู
          const display = document.getElementById('blsBeatDisplay');
          if (display) {
            display.style.transform = 'scale(1.2)';
            setTimeout(() => { if (display) display.style.transform = 'scale(1)'; }, 100);
          }
          
          // ุนูุฏ 30 ุถุบุทุฉ - ุฅุธูุงุฑ overlay ุงูุชููุณ
          if (blsCompressionCount >= 30) {
            stopBLSMetronome();
            showBreathOverlay();
            return;
          }
          
          const osc = blsAudioCtx.createOscillator();
          const gain = blsAudioCtx.createGain();
          
          osc.type = 'square';
          osc.frequency.value = 440;
          gain.gain.value = 0.4;
          
          osc.connect(gain);
          gain.connect(blsAudioCtx.destination);
          
          const now = blsAudioCtx.currentTime;
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
          
          osc.start(now);
          osc.stop(now + 0.1);
        }
        
        playBeat();
        blsMetronomeInterval = setInterval(playBeat, 545);
        
      } catch(e) {
        console.error('BLS Metronome error:', e);
        toast('ุชุนุฐุฑ ุชุดุบูู ุตูุช ุงูุฅููุงุน', 'warn');
      }
    }
    
    function stopBLSMetronome() {
      blsPlaying = false;
      if (blsMetronomeInterval) {
        clearInterval(blsMetronomeInterval);
        blsMetronomeInterval = null;
      }
      const btn = document.getElementById('blsMetronomeBtn');
      if (btn) btn.innerHTML = '<i class="fas fa-play"></i> ุงุจุฏุฃ ุงูุชุฏุฑูุจ';
    }
    
    function showBreathOverlay() {
      const overlay = document.getElementById('breathOverlay');
      if (!overlay) return;
      
      overlay.style.display = 'flex';
      let countdown = 5;
      const countEl = document.getElementById('breathCountdown');
      
      function tick() {
        if (countEl) countEl.textContent = countdown;
        if (countdown <= 0) {
          hideBreathOverlay();
          // ุฅุนุงุฏุฉ ุงูุนุฏุงุฏ ูุจุฏุก ุงูุชุฏุฑูุจ ูุฑุฉ ุฃุฎุฑู
          blsCompressionCount = 0;
          updateCompressionCounter();
          setTimeout(() => {
            if (document.getElementById('blsTrainingModal').classList.contains('active')) {
              startBLSMetronome();
            }
          }, 500);
          return;
        }
        countdown--;
        breathOverlayTimeout = setTimeout(tick, 1000);
      }
      
      tick();
    }
    
    function hideBreathOverlay() {
      const overlay = document.getElementById('breathOverlay');
      if (overlay) overlay.style.display = 'none';
      if (breathOverlayTimeout) {
        clearTimeout(breathOverlayTimeout);
        breathOverlayTimeout = null;
      }
    }

    function updateTrainingSaveState(){
      updateRosterCount();
      const trainer = getSelectedTrainer();
      const can = !!APP.train.scenarioKey && APP.train.selectedRoster.size>0 && !!trainer;
      document.getElementById('saveTrainingBtn').disabled = !can;
    }

    function getSelectedTrainer(){
      const sel = document.getElementById('trainerSelect');
      const inp = document.getElementById('trainerName');
      if (sel.value === '__external__') {
        return inp.value.trim();
      }
      return sel.value;
    }

    function onTrainerSelectChange(){
      const sel = document.getElementById('trainerSelect');
      const inp = document.getElementById('trainerName');
      if (sel.value === '__external__') {
        inp.style.display = 'block';
        inp.focus();
      } else {
        inp.style.display = 'none';
        inp.value = '';
      }
      updateTrainingSaveState();
    }

    function populateTrainerDropdown(){
      const sel = document.getElementById('trainerSelect');
      sel.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุฏุฑุจ --</option>';
      
      // Add staff from roster
      APP.roster.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name + (p.department ? ' - ' + p.department : '');
        sel.appendChild(opt);
      });
      
      // Add external trainer option
      const extOpt = document.createElement('option');
      extOpt.value = '__external__';
      extOpt.textContent = '๐ค ูุฏุฑุจ ุฎุงุฑุฌู (ุงูุชุจ ุงูุงุณู)';
      extOpt.style.fontWeight = '900';
      sel.appendChild(extOpt);
    }

    async function broadcastTrainingToScreens(){
      if (!APP.train.scenarioKey){
        toast('ุงุฎุชุฑ ุณููุงุฑูู ุงูุชุฏุฑูุจ ุฃููุงู', 'warn');
        return;
      }
      const btn = event?.target?.closest('button');
      const originalHTML = btn ? btn.innerHTML : '';
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุฅุฑุณุงู...';
      }
      
      const trainer = getSelectedTrainer() || 'TRAINER';
      const payload = {
        responseType: 'training',
        reportType: '๐ฏ ุชูุฑูู - ' + scenarioLabel(APP.train.scenarioKey),
        location: 'ุชุฏุฑูุจ ุนููู - ุฑุงุฌุน ุงูุชุนูููุงุช',
        muster: '',
        mode: 'training',
        scenarioKey: APP.train.scenarioKey,
        scenarioLabel: scenarioLabel(APP.train.scenarioKey),
        trainer: trainer
      };
      try{
        const r = await jsonp('setActiveCommand', payload);
        if (!r || !r.ok) throw new Error(r?.error || 'setActiveCommand failed');
        showBigSuccess('ุชู ุฅุฑุณุงู ุงูุชูุฑูู ููุดุงุดุงุช ุจูุฌุงุญ! ๐บ');
        setStatusAlert(true, '๐ฏ ุชูุฑูู ุฌุงุฑู');
      } catch(e){
        console.error(e);
        toast('ูุดู ุฅุฑุณุงู ุงูุชูุฑูู ููุดุงุดุงุช', 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      }
    }

    async function stopTrainingOnScreens(){
      const btn = event?.target?.closest('button');
      const originalHTML = btn ? btn.innerHTML : '';
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุฅููุงู...';
      }
      
      try{
        const ac = await jsonp('getActiveCommand', {});
        const cmd = (ac && ac.ok) ? ac.command : null;
        if (!cmd) {
          toast('ูุง ููุฌุฏ ุฃูุฑ ูุดุท', 'warn');
          return;
        }
        if (String(cmd.mode || '').toLowerCase() !== 'training'){
          toast('ุงูุฃูุฑ ุงููุดุท ููุณ ุชูุฑูููุง (ูู ูุชู ูุณุญู ููุง)', 'warn');
          return;
        }
        const r = await jsonp('clearActiveCommand', {});
        if (!r || !r.ok) throw new Error(r?.error || 'clearActiveCommand failed');
        showBigSuccess('ุชู ุฅููุงู ุนุฑุถ ุงูุชูุฑูู! โน๏ธ');
        setStatusAlert(false);
        await syncActiveCommandUI();
      } catch(e){
        console.error(e);
        toast('ุชุนุฐุฑ ุฅููุงู ุงูุนุฑุถ', 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        }
      }
    }

    async function saveTrainingSession(){
      const trainer = getSelectedTrainer();
      if (!APP.train.scenarioKey || !trainer || APP.train.selectedRoster.size===0){
        toast('ุฃููู ุจูุงูุงุช ุงูุชุฏุฑูุจ', 'error');
        return;
      }

      const btn = document.getElementById('saveTrainingBtn');
      const originalHTML = btn ? btn.innerHTML : '';
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุญูุธ...';
        btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
      }

      const attendees = Array.from(APP.train.selectedRoster).map(id=>{
        const idx = Number(String(id).replace('r_',''));
        const p = APP.roster[idx];
        return p ? p.name : '';
      }).filter(Boolean).join('ุ ');

      const now = new Date();
      const start = new Date(APP.train.startMs);
      const durationMin = Math.max(0, Math.round((now.getTime()-start.getTime())/60000));

      const payload = {
        startTime: start.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
        endTime: now.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
        durationMin: String(durationMin),
        scenarioKey: APP.train.scenarioKey,
        scenarioLabel: scenarioLabel(APP.train.scenarioKey),
        trainer: trainer,
        attendees: attendees,
        notes: 'ุชูุฑูู ุนููู',
        startIso: start.toISOString(),
        endIso: now.toISOString()
      };

      console.log('=== SAVING TRAINING SESSION ===');
      console.log('Payload:', JSON.stringify(payload, null, 2));

      try{
        const res = await jsonp('logTrainingSession', payload);
        console.log('Response:', JSON.stringify(res, null, 2));
        if (!res || !res.ok) throw new Error(res?.error || 'logTrainingSession failed');
        
        const sid = res.sessionId || res.session_id || '';
        showBigSuccess('ุชู ุญูุธ ุฌูุณุฉ ุงูุชุฏุฑูุจ ุจูุฌุงุญ! โ\n\nุงูุณููุงุฑูู: ' + scenarioLabel(APP.train.scenarioKey) + '\nุงููุฏุฑุจ: ' + trainer + '\nุงูุญุถูุฑ: ' + APP.train.selectedRoster.size + ' ูุชุฏุฑุจ' + (sid ? '\n\nุฑูู ุงูุฌูุณุฉ: ' + sid : ''));
        
        closeTrainingModal();
        
        // ุชุญุฏูุซ ุงูุณุฌู ูุจุงุดุฑุฉ
        setTimeout(async () => {
          await refreshMiniTraining();
          console.log('Mini training refreshed after save');
        }, 500);
        
      } catch(e){
        console.error('SAVE ERROR:', e);
        showBigError('ูุดู ุงูุญูุธ!\n\n' + e.message + '\n\nโ๏ธ ุชุฃูุฏ ูู ูุดุฑ Apps Script ุฌุฏูุฏ:\nDeploy โ Manage deployments โ โ๏ธ โ New version');
      } finally {
        if (btn) {
          btn.innerHTML = originalHTML;
          btn.style.background = '';
          updateTrainingSaveState();
        }
      }
    }

    /******************************************************
     * Training Log modal
     ******************************************************/
    function openTrainingLogModal(){
      document.getElementById('trainingLogModal').classList.add('active');
      loadTrainingLog();
    }
    function closeTrainingLogModal(){
      document.getElementById('trainingLogModal').classList.remove('active');
    }

    async function loadTrainingLog(){
      const body = document.getElementById('trainLogBody');
      body.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:22px"><i class="fas fa-spinner fa-spin"></i> ุชุญููู...</td></tr>`;
      try{
        console.log('Loading training log...');
        const list = await fetchTrainingSessions(250);
        console.log('Training sessions loaded:', list.length, 'sessions');
        APP.caches.trainingSessions = list;
        applyTrainingFilter();
      } catch(e){
        console.error('Load training log error:', e);
        body.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:22px;color:var(--danger)">ุชุนุฐุฑ ุชุญููู ุณุฌู ุงูุชุฏุฑูุจ<br><small style="opacity:.7">ุชุฃูุฏ ูู ูุดุฑ Apps Script</small></td></tr>`;
      }
    }

    function renderTrainingTable(list){
      const body = document.getElementById('trainLogBody');
      if (!list || !list.length){
        body.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:22px">ูุง ุชูุฌุฏ ุฌูุณุงุช</td></tr>`;
        return;
      }
      body.innerHTML = list.map((s,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${escapeHtml(s._dateYMD || toYMD(s.date) || '')}</td>
          <td>${escapeHtml(s.startTime||'')}</td>
          <td>${escapeHtml(s.endTime||'')}</td>
          <td>${escapeHtml(String(s.durationMin ?? ''))}</td>
          <td>${escapeHtml(s.scenarioLabel || scenarioLabel(s.scenarioKey) || '')}</td>
          <td>${escapeHtml(s.trainer||'')}</td>
          <td>${escapeHtml(s.attendees || '-')}</td>
          <td><button class="view-btn" onclick="showTrainingDetails(${i})"><i class="fas fa-eye"></i> ุนุฑุถ</button></td>
        </tr>
      `).join('');
    }

    function applyTrainingFilter(){
      const from = document.getElementById('trainFrom').value;
      const to = document.getElementById('trainTo').value;
      const filtered = (APP.caches.trainingSessions||[]).filter(s=>{
        const d = s._dateYMD || toYMD(s.date);
        if (from && d < from) return false;
        if (to && d > to) return false;
        return true;
      });
      renderTrainingTable(filtered);
    }

    function showTrainingDetails(index){
      const s = (APP.caches.trainingSessions||[])[index];
      if (!s) return;

      const html = `
        <div class="mini-item" style="border-radius:16px;padding:14px">
          <div style="font-weight:1000;color:var(--secondary);margin-bottom:10px"><i class="fas fa-calendar"></i> ุจูุงูุงุช ุงูุฌูุณุฉ</div>
          <div style="display:grid;gap:6px;font-weight:900">
            <div>ุงูุชุงุฑูุฎ: ${escapeHtml(s._dateYMD || toYMD(s.date) || '-')}</div>
            <div>ุงูุจุฏุงูุฉ: ${escapeHtml(s.startTime||'-')}</div>
            <div>ุงูููุงูุฉ: ${escapeHtml(s.endTime||'-')}</div>
            <div>ุงููุฏุฉ: ${escapeHtml(String(s.durationMin ?? '-'))} ุฏูููุฉ</div>
            <div>ุงูุณููุงุฑูู: ${escapeHtml(s.scenarioLabel || scenarioLabel(s.scenarioKey) || '-')}</div>
            <div>ุงููุฏุฑุจ: ${escapeHtml(s.trainer||'-')}</div>
          </div>
        </div>
        <div class="mini-item" style="border-radius:16px;padding:14px;margin-top:10px">
          <div style="font-weight:1000;color:var(--secondary);margin-bottom:10px"><i class="fas fa-users"></i> ุงูุญุถูุฑ</div>
          <div style="font-weight:800;line-height:1.8">${escapeHtml(s.attendees || '-')}</div>
        </div>
        <div class="mini-item" style="border-radius:16px;padding:14px;margin-top:10px">
          <div style="font-weight:1000;color:var(--secondary);margin-bottom:10px"><i class="fas fa-note-sticky"></i> ููุงุญุธุงุช</div>
          <div style="font-weight:800;line-height:1.8">${escapeHtml(s.notes || '-')}</div>
        </div>
      `;
      document.getElementById('trainingDetailsContent').innerHTML = html;
      document.getElementById('trainingDetailsModal').classList.add('active');
    }

    function closeTrainingDetails(){
      document.getElementById('trainingDetailsModal').classList.remove('active');
    }
    
    function printTrainingDetails(){
      // Set print date
      const now = new Date();
      const dateStr = now.toLocaleDateString('ar-SA', {year:'numeric',month:'long',day:'numeric'}) + ' - ' + now.toLocaleTimeString('ar-SA');
      const printDateEl = document.getElementById('printDateDetails');
      if(printDateEl) printDateEl.textContent = dateStr;
      
      // Also set for other modals if open
      const trainEl = document.getElementById('printDateTrain');
      const repEl = document.getElementById('printDateRep');
      if(trainEl) trainEl.textContent = dateStr;
      if(repEl) repEl.textContent = dateStr;
      
      window.print();
    }

    /******************************************************
     * Reports Log modal
     ******************************************************/
    function openReportsLogModal(){
      document.getElementById('reportsLogModal').classList.add('active');
      loadReportsLog();
    }
    function closeReportsLogModal(){
      document.getElementById('reportsLogModal').classList.remove('active');
    }

    async function loadReportsLog(){
      const body = document.getElementById('repLogBody');
      body.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:22px"><i class="fas fa-spinner fa-spin"></i> ุชุญููู...</td></tr>`;
      try{
        const list = await fetchEmergencyReports(200);
        APP.caches.reports = list;
        renderReportsTable(list);
      } catch(e){
        console.error(e);
        body.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:22px;color:var(--danger)">ุชุนุฐุฑ ุชุญููู ุณุฌู ุงูุจูุงุบุงุช</td></tr>`;
      }
    }

    function renderReportsTable(list){
      const body = document.getElementById('repLogBody');
      if (!list || !list.length){
        body.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:22px">ูุง ุชูุฌุฏ ุจูุงุบุงุช</td></tr>`;
        return;
      }
      body.innerHTML = list.map(r=>{
        const st = String(r.status||'ุฌุฏูุฏ');
        const pill = statusPillClass(st);
        const action =
          st === 'ุฌุฏูุฏ' ? `<button class="view-btn" onclick="updateReportFlow('${escapeHtml(r.id)}','ููุฏ ุงููุนุงูุฌุฉ')">ุงุณุชุฌุงุจุฉ</button>` :
          st === 'ููุฏ ุงููุนุงูุฌุฉ' ? `<button class="view-btn" onclick="updateReportFlow('${escapeHtml(r.id)}','ูุบูู')">ุฅุบูุงู</button>` :
          `<span style="color:var(--success);font-weight:1000"><i class="fas fa-check"></i></span>`;

        return `
          <tr>
            <td>${escapeHtml(r.id||'')}</td>
            <td>${escapeHtml(r.date||'')}</td>
            <td>${escapeHtml(r.time||'')}</td>
            <td>${escapeHtml(r.type||'')}</td>
            <td>${escapeHtml(r.location||'')}</td>
            <td><span class="pill ${pill}">${escapeHtml(st)}</span></td>
            <td>${action}</td>
          </tr>
        `;
      }).join('');
    }

    async function updateReportFlow(id, newStatus){
      const responder = prompt('ุงุณู ุงููุณุชุฌูุจ:');
      if (!responder) return;
      const actionNotes = prompt('ููุงุญุธุงุช ุงูุฅุฌุฑุงุก (ุงุฎุชูุงุฑู):') || '';
      try{
        await safeUpdateReportStatus(id, newStatus, responder, actionNotes);
        toast('ุชู ุชุญุฏูุซ ุงูุญุงูุฉ', 'success');
        await refreshLists();
        await loadReportsLog();
      } catch(e){
        console.error(e);
        toast('ูุดู ุชุญุฏูุซ ุงูุญุงูุฉ', 'error');
      }
    }

    function applyReportsFilter(){
      const from = document.getElementById('repFrom').value;
      const to = document.getElementById('repTo').value;
      const st = document.getElementById('repStatus').value;

      const filtered = (APP.caches.reports||[]).filter(r=>{
        const d = String(r.date||'');
        if (from && d < from) return false;
        if (to && d > to) return false;
        if (st && String(r.status||'') !== st) return false;
        return true;
      });
      renderReportsTable(filtered);
    }

    /******************************************************
     * Init & refresh
     ******************************************************/
    async function refreshLists(){
      await Promise.allSettled([refreshMiniTraining(), pollReports()]);
    }

    async function init(){
      // range buttons
      buildRangeButtons('trainRangeBtns', (p)=>{ setRangeInputs('trainFrom','trainTo', p.days); applyTrainingFilter(); });
      buildRangeButtons('repRangeBtns', (p)=>{ setRangeInputs('repFrom','repTo', p.days); applyReportsFilter(); });

      // core sheet data
      await loadCoreData();

      // initial lists
      await refreshMiniTraining();
      await pollReports();

      // check if emergency is active
      await syncActiveCommandUI();

      // polling every 5 seconds
      setInterval(pollReports, 5000);

      // small refresh training list every 30s
      setInterval(refreshMiniTraining, 30000);

      // sync active command every 5 seconds
      setInterval(syncActiveCommandUI, 5000);
    }

    document.addEventListener('DOMContentLoaded', init);

    /******************************************************
     * ูุธุงู ุงุฎุชุจุงุฑ ุณูุงูุฉ ุงููุธุงู
     ******************************************************/
    const systemTestLog = JSON.parse(localStorage.getItem('eoc_system_tests') || '[]');
    
    function updateTestStatus(testId, status, message) {
      const statusEl = document.getElementById(`test${testId}Status`);
      const btnEl = document.getElementById(`test${testId}Btn`);
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = 'test-status ' + status;
      }
      if (btnEl) {
        btnEl.classList.remove('pass', 'fail');
        if (status === 'pass' || status === 'fail') {
          btnEl.classList.add(status);
        }
      }
    }
    
    async function runSystemTest(type) {
      const testNames = {
        server: 'Server',
        alert: 'Alert',
        save: 'Save',
        load: 'Load'
      };
      const testId = testNames[type];
      updateTestStatus(testId, 'testing', 'ุฌุงุฑู ุงูุงุฎุชุจุงุฑ...');
      
      let passed = false;
      let details = '';
      const startTime = Date.now();
      
      try {
        switch(type) {
          case 'server':
            const pingRes = await jsonp('ping', {});
            passed = pingRes && pingRes.ok;
            details = passed ? 'ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ ูุงุฌุญ' : 'ูุดู ุงูุงุชุตุงู';
            break;
            
          case 'alert':
            try {
              const ctx = new (window.AudioContext || window.webkitAudioContext)();
              if (ctx.state === 'suspended') await ctx.resume();
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.connect(gain);
              gain.connect(ctx.destination);
              gain.gain.value = 0.3;
              osc.frequency.value = 440;
              osc.start();
              setTimeout(() => { osc.stop(); ctx.close(); }, 500);
              passed = true;
              details = 'ูุธุงู ุงูุตูุช ูุนูู';
            } catch(e) {
              passed = false;
              details = 'ูุดู ูุธุงู ุงูุตูุช: ' + e.message;
            }
            break;
            
          case 'save':
            const saveRes = await jsonp('systemTest', { testType: 'save', testData: 'test_' + Date.now() });
            passed = saveRes && saveRes.ok;
            details = passed ? 'ุงูุญูุธ ูุนูู' : (saveRes?.error || 'ูุดู ุงูุญูุธ');
            break;
            
          case 'load':
            const loadRes = await jsonp('getTrainingSessions', { limit: '1' });
            passed = loadRes && loadRes.ok;
            details = passed ? 'ุงูุณุญุจ ูุนูู (' + (loadRes.sessions?.length || 0) + ' ุณุฌู)' : 'ูุดู ุงูุณุญุจ';
            break;
        }
      } catch(e) {
        passed = false;
        details = 'ุฎุทุฃ: ' + e.message;
      }
      
      const duration = Date.now() - startTime;
      updateTestStatus(testId, passed ? 'pass' : 'fail', passed ? 'โ ูุฌุญ' : 'โ ูุดู');
      
      // ุญูุธ ุงููุชูุฌุฉ
      const testResult = {
        type,
        passed,
        details,
        duration,
        timestamp: new Date().toISOString()
      };
      systemTestLog.unshift(testResult);
      if (systemTestLog.length > 100) systemTestLog.pop();
      localStorage.setItem('eoc_system_tests', JSON.stringify(systemTestLog));
      
      // ุชุญุฏูุซ ุขุฎุฑ ุงุฎุชุจุงุฑ
      updateLastTestResult();
      
      toast(details, passed ? 'success' : 'error');
      return { passed, details };
    }
    
    async function runAllSystemTests() {
      toast('ุฌุงุฑู ุชุดุบูู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู...', 'info');
      const results = [];
      
      for (const type of ['server', 'alert', 'save', 'load']) {
        const result = await runSystemTest(type);
        results.push(result);
        await new Promise(r => setTimeout(r, 300));
      }
      
      const passed = results.filter(r => r.passed).length;
      const total = results.length;
      
      if (passed === total) {
        toast('โ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช! (' + passed + '/' + total + ')', 'success');
      } else {
        toast('โ๏ธ ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุดูุช (' + passed + '/' + total + ')', 'warn');
      }
    }
    
    function updateLastTestResult() {
      const el = document.getElementById('lastTestResult');
      if (!el || systemTestLog.length === 0) return;
      
      const last = systemTestLog[0];
      const date = new Date(last.timestamp);
      const timeStr = date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
      const dateStr = date.toLocaleDateString('ar-SA');
      const color = last.passed ? 'var(--success)' : 'var(--danger)';
      const status = last.passed ? 'ูุฌุญ' : 'ูุดู';
      el.innerHTML = 'ุขุฎุฑ ุงุฎุชุจุงุฑ: ' + dateStr + ' ' + timeStr + ' - <span style="color:' + color + '">' + status + '</span>';
    }
    
    function openSystemTestLog() {
      let html = '<div style="max-height:400px;overflow:auto">';
      
      if (systemTestLog.length === 0) {
        html += '<div style="text-align:center;padding:40px;color:var(--muted)"><i class="fas fa-clipboard-check" style="font-size:3rem;margin-bottom:10px"></i><br>ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุณุงุจูุฉ</div>';
      } else {
        html += '<table style="width:100%"><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงููุชูุฌุฉ</th><th>ุงูุชูุงุตูู</th><th>ุงููุฏุฉ</th></tr></thead><tbody>';
        
        const typeLabels = { server: 'ุงูุณูุฑูุฑ', alert: 'ุงูุฅูุฐุงุฑ', save: 'ุงูุญูุธ', load: 'ุงูุณุญุจ' };
        
        systemTestLog.slice(0, 50).forEach(t => {
          const date = new Date(t.timestamp);
          const timeStr = date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
          const dateStr = date.toLocaleDateString('ar-SA');
          const color = t.passed ? 'var(--success)' : 'var(--danger)';
          const icon = t.passed ? 'fa-check-circle' : 'fa-times-circle';
          const status = t.passed ? 'ูุฌุญ' : 'ูุดู';
          const typeLabel = typeLabels[t.type] || t.type;
          html += '<tr>' +
            '<td>' + dateStr + ' ' + timeStr + '</td>' +
            '<td>' + typeLabel + '</td>' +
            '<td style="color:' + color + '"><i class="fas ' + icon + '"></i> ' + status + '</td>' +
            '<td style="font-size:.85rem">' + escapeHtml(t.details) + '</td>' +
            '<td>' + t.duration + 'ms</td>' +
          '</tr>';
        });
        
        html += '</tbody></table>';
      }
      
      html += '</div>';
      html += '<div style="margin-top:12px;display:flex;gap:10px">';
      html += '<button class="btn secondary" style="flex:1" onclick="clearSystemTestLog()"><i class="fas fa-trash"></i> ูุณุญ ุงูุณุฌู</button>';
      html += '<button class="btn success" style="flex:1" onclick="closeSystemTestLogModal()"><i class="fas fa-check"></i> ุฅุบูุงู</button>';
      html += '</div>';
      
      showBigModal('ุณุฌู ุงุฎุชุจุงุฑุงุช ุงูุณูุงูุฉ', html);
    }
    
    function clearSystemTestLog() {
      if (confirm('ูู ุชุฑูุฏ ูุณุญ ุณุฌู ุงูุงุฎุชุจุงุฑุงุชุ')) {
        systemTestLog.length = 0;
        localStorage.setItem('eoc_system_tests', '[]');
        toast('ุชู ูุณุญ ุงูุณุฌู', 'info');
        openSystemTestLog();
      }
    }
    
    function closeSystemTestLogModal() {
      const modal = document.querySelector('.big-modal-overlay');
      if (modal) modal.remove();
    }
    
    function showBigModal(title, content) {
      const overlay = document.createElement('div');
      overlay.className = 'big-modal-overlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
      overlay.innerHTML = `
        <div style="background:var(--bg1);border:2px solid var(--secondary);border-radius:18px;max-width:800px;width:100%;max-height:90vh;overflow:auto;padding:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 style="color:var(--secondary);font-weight:900"><i class="fas fa-shield-check"></i> ${title}</h2>
            <button onclick="closeSystemTestLogModal()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer"><i class="fas fa-times"></i></button>
          </div>
          ${content}
        </div>
      `;
      document.body.appendChild(overlay);
    }

    // ุชุญุฏูุซ ุขุฎุฑ ุงุฎุชุจุงุฑ ุนูุฏ ุงูุชุญููู
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(updateLastTestResult, 1000);
    });

    /******************************************************
     * Notes:
     * - Apps Script Web Apps doGet/doPost support JSONP via callback parameter.
     * - LockService recommended for concurrent sheet writes.
     ******************************************************/
  </script>
</body>
</html>
