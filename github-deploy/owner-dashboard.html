<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مركز القيادة والسيطرة - المالك</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-dark: #152a45;
            --gold: #c9a962;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --bg-light: #f8f9fa;
            --sidebar-width: 260px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            display: flex;
        }
        .sidebar, .main-content { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        body.authenticated .sidebar, body.authenticated .main-content { visibility: visible; opacity: 1; }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 100;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 1.2rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            padding: 5px;
        }
        .sidebar-header h3 {
            color: white;
            margin-top: 0.6rem;
            font-size: 0.95rem;
        }
        .sidebar-header .role-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: var(--primary-dark);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-top: 0.4rem;
            font-weight: 700;
        }
        .nav-menu { padding: 0.8rem 0; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-right: 4px solid transparent;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-right-color: var(--gold);
        }
        .nav-item i { width: 22px; text-align: center; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 0.8rem 0; }
        
        .main-content {
            margin-right: var(--sidebar-width);
            flex: 1;
            padding: 1.2rem;
            min-height: 100vh;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.2rem;
        }
        .welcome-text h2 { color: var(--primary); font-size: 1.2rem; }
        .welcome-text p { color: #666; font-size: 0.85rem; }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.2rem;
        }
        .kpi-card {
            background: white;
            border-radius: 14px;
            padding: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            border: 1px solid rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--gold);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        .kpi-card:hover::before { opacity: 1; }
        .kpi-icon {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .kpi-icon.eoc { background: linear-gradient(135deg, #10b981, #059669); transition: all 0.3s; }
        .kpi-icon.eoc.active { background: linear-gradient(135deg, #dc2626, #991b1b); animation: eocPulse 1s infinite; }
        @keyframes eocPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.6); }
            50% { transform: scale(1.08); box-shadow: 0 0 20px 5px rgba(220, 38, 38, 0.4); }
        }
        .kpi-icon.complaints { background: linear-gradient(135deg, #667eea, #764ba2); }
        .kpi-icon.incidents { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .kpi-icon.risks { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .kpi-icon.rounds { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .kpi-icon.calibration { background: linear-gradient(135deg, #fa709a, #fee140); }
        .kpi-icon.maintenance { background: linear-gradient(135deg, #667eea, #764ba2); }
        .kpi-icon.needlestick { background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333; }
        .kpi-info h3 { font-size: 1.6rem; color: var(--primary); line-height: 1; font-weight: 700; }
        .kpi-info p { font-size: 0.8rem; color: #555; margin-top: 4px; font-weight: 500; }
        .kpi-info .sub { font-size: 0.75rem; color: #999; display: block; margin-top: 2px; }
        .kpi-info .sub.danger { color: #DC143C !important; font-weight: 700; }
        
        .alerts-section {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid #eee;
        }
        .section-header h3 { font-size: 1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .alert-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .alert-item.danger { background: #fff5f5; border-right: 4px solid var(--danger); }
        .alert-item.warning { background: #fffbeb; border-right: 4px solid var(--warning); }
        .alert-item.info { background: #f0f9ff; border-right: 4px solid var(--info); }
        .no-alerts { text-align: center; padding: 1.5rem; color: #999; font-size: 0.9rem; }
        
        .stats-grid-detailed {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.2rem;
        }
        .stats-box {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stats-box h4 {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }
        .stats-row:last-child { border-bottom: none; }
        .stats-row .label { color: #666; }
        .stats-row .value { font-weight: 700; color: var(--primary); }
        .stats-row .value.danger { color: var(--danger); }
        .stats-row .value.warning { color: var(--warning); }
        .stats-row .value.success { color: var(--success); }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .refresh-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .refresh-btn:hover { background: #f0f0f0; }
        .refresh-btn.loading i { animation: spin 1s linear infinite; }
        
        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
        }
        .quick-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            text-decoration: none;
            color: var(--primary);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 0.8rem;
            text-align: center;
        }
        .quick-link:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        .quick-link i { font-size: 1.5rem; }
        
        @media (max-width: 992px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; padding: 1rem; }
            .menu-toggle { display: block !important; }
        }
        .menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .access-denied {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-align: center;
            padding: 20px;
        }
        .access-denied i { font-size: 80px; margin-bottom: 20px; color: var(--danger); }
        .access-denied h1 { font-size: 2rem; margin-bottom: 10px; }
        .access-denied .btn-back {
            background: var(--gold);
            color: var(--primary);
            padding: 12px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="margin-top: 15px; color: var(--primary);">جاري تحميل مركز القيادة...</p>
    </div>
    
    <div class="access-denied" id="accessDenied" style="display: none;">
        <i class="fas fa-lock"></i>
        <h1>الوصول مرفوض</h1>
        <p>عذراً، هذه الصفحة مخصصة للمالك فقط</p>
        <a href="portal.html" class="btn-back"><i class="fas fa-arrow-right"></i> العودة للبوابة</a>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo-transparent.png" alt="Logo" onerror="this.style.display='none'">
            <h3 id="ownerName">المالك</h3>
            <span class="role-badge"><i class="fas fa-crown"></i> المالك</span>
        </div>
        <nav class="nav-menu">
            <a class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>مركز القيادة</span>
            </a>
            <a class="nav-item" href="cbahi-portal.html" target="_blank">
                <i class="fas fa-award"></i>
                <span>بوابة سباهي</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" href="eoc-command.html" target="_blank">
                <i class="fas fa-broadcast-tower"></i>
                <span>مركز القيادة EOC</span>
            </a>
            <a class="nav-item" href="complaint_analysis.html" target="_blank">
                <i class="fas fa-comment-dots"></i>
                <span>تحليل الشكاوى</span>
            </a>
            <a class="nav-item" href="incident-report-analysis.html" target="_blank">
                <i class="fas fa-exclamation-triangle"></i>
                <span>تحليل الحوادث</span>
            </a>
            <a class="nav-item" href="risk-register.html" target="_blank">
                <i class="fas fa-shield-alt"></i>
                <span>سجل المخاطر</span>
            </a>
            <a class="nav-item" href="Round.html" target="_blank">
                <i class="fas fa-clipboard-check"></i>
                <span>جولات السلامة</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" href="calibration.html" target="_blank">
                <i class="fas fa-cogs"></i>
                <span>المعايرة</span>
            </a>
            <a class="nav-item" href="maintenance.html" target="_blank">
                <i class="fas fa-wrench"></i>
                <span>الصيانة</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" href="admin-dashboard.html" target="_blank">
                <i class="fas fa-users-cog"></i>
                <span>لوحة الإدارة</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>تسجيل الخروج</span>
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="welcome-text">
                <h2>مركز القيادة والسيطرة</h2>
                <p id="dateDisplay">مجمع مكة الطبي بالزاهر</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="refresh-btn" id="refreshBtn" title="تحديث البيانات" onclick="loadDashboardData()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <a href="index.html" class="btn btn-outline">
                    <i class="fas fa-external-link-alt"></i>
                    الموقع
                </a>
            </div>
        </div>

        <section class="content-section active" id="section-dashboard">
            <div class="kpi-grid">
                <a href="eoc-command.html" target="_blank" class="kpi-card" id="eocSmartCard">
                    <div class="kpi-icon eoc" id="eocSmartIcon"><i class="fas fa-triangle-exclamation"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-eoc-count">0</h3>
                        <p id="kpi-eoc-label">حالة طوارئ</p>
                        <span class="sub" id="kpi-eoc-status">الوضع طبيعي ✓</span>
                    </div>
                </a>
                <a href="complaint_analysis.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon complaints"><i class="fas fa-comment-dots"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-complaints-open">-</h3>
                        <p>شكوى مفتوحة</p>
                        <span class="sub" id="kpi-complaints-escalated"></span>
                    </div>
                </a>
                <a href="incident-report-analysis.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon incidents"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-incidents-open">-</h3>
                        <p>حادثة مفتوحة</p>
                        <span class="sub" id="kpi-incidents-escalated"></span>
                    </div>
                </a>
                <a href="risk-register.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon risks"><i class="fas fa-shield-alt"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-risks-active">-</h3>
                        <p>خطر نشط</p>
                        <span class="sub" id="kpi-risks-high"></span>
                    </div>
                </a>
                <a href="Round.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon rounds"><i class="fas fa-clipboard-check"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-rounds-today">-</h3>
                        <p>جولة اليوم</p>
                        <span class="sub" id="kpi-rounds-delayed"></span>
                    </div>
                </a>
                <a href="calibration.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon calibration"><i class="fas fa-cogs"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-calibration-compliance">-</h3>
                        <p>نسبة المعايرة</p>
                        <span class="sub" id="kpi-calibration-overdue"></span>
                    </div>
                </a>
                <a href="maintenance.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon maintenance"><i class="fas fa-wrench"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-maintenance-total">-</h3>
                        <p>أجهزة بدون صيانة</p>
                        <span class="sub" id="kpi-maintenance-completed" style="color:#28a745"></span>
                        <span class="sub" id="kpi-maintenance-overdue"></span>
                    </div>
                </a>
                <a href="pages/needlestick_analysis.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon needlestick"><i class="fas fa-syringe"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-needlestick">-</h3>
                        <p>حالة وخز إبري</p>
                        <span class="sub" id="kpi-needlestick-month"></span>
                    </div>
                </a>
            </div>

            <div class="alerts-section">
                <div class="section-header">
                    <h3><i class="fas fa-bell"></i> التنبيهات والتصعيدات</h3>
                    <button class="refresh-btn" onclick="loadDashboardData()"><i class="fas fa-sync-alt"></i> تحديث</button>
                </div>
                <div id="alertsContainer">
                    <div class="no-alerts">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success);"></i>
                        <p>جاري تحميل التنبيهات...</p>
                    </div>
                </div>
            </div>

            <div class="stats-grid-detailed">
                <div class="stats-box">
                    <h4><i class="fas fa-comment-dots"></i> الشكاوى</h4>
                    <div class="stats-row">
                        <span class="label">جديدة</span>
                        <span class="value" id="stat-complaints-new">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">قيد المعالجة</span>
                        <span class="value warning" id="stat-complaints-progress">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مصعّدة</span>
                        <span class="value danger" id="stat-complaints-escalated">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مغلقة</span>
                        <span class="value success" id="stat-complaints-closed">-</span>
                    </div>
                </div>
                <div class="stats-box">
                    <h4><i class="fas fa-exclamation-triangle"></i> الحوادث</h4>
                    <div class="stats-row">
                        <span class="label">جديدة</span>
                        <span class="value" id="stat-incidents-new">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">قيد التحقيق</span>
                        <span class="value warning" id="stat-incidents-progress">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مصعّدة</span>
                        <span class="value danger" id="stat-incidents-escalated">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مغلقة</span>
                        <span class="value success" id="stat-incidents-closed">-</span>
                    </div>
                </div>
                <div class="stats-box">
                    <h4><i class="fas fa-shield-alt"></i> سجل المخاطر</h4>
                    <div class="stats-row">
                        <span class="label">خطر عالي</span>
                        <span class="value danger" id="stat-risks-high">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">خطر متوسط</span>
                        <span class="value warning" id="stat-risks-medium">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">خطر منخفض</span>
                        <span class="value" id="stat-risks-low">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مُعالجة</span>
                        <span class="value success" id="stat-risks-resolved">-</span>
                    </div>
                </div>
            </div>

            <div class="stats-box">
                <h4><i class="fas fa-rocket"></i> الوصول السريع</h4>
                <div class="quick-links-grid">
                    <a href="report.html" class="quick-link" target="_blank">
                        <i class="fas fa-comment-alt"></i>
                        <span>رفع شكوى</span>
                    </a>
                    <a href="incident-report.html" class="quick-link" target="_blank">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>بلاغ حادثة</span>
                    </a>
                    <a href="risk-register.html?action=new" class="quick-link" target="_blank">
                        <i class="fas fa-shield-virus"></i>
                        <span>تسجيل خطر</span>
                    </a>
                    <a href="ipc/incidents/report-needlestick.html" class="quick-link" target="_blank">
                        <i class="fas fa-syringe"></i>
                        <span>بلاغ وخز</span>
                    </a>
                    <a href="mega.html" class="quick-link" target="_blank">
                        <i class="fas fa-th-large"></i>
                        <span>المركز الرقمي</span>
                    </a>
                    <a href="cbahi-portal.html" class="quick-link" target="_blank">
                        <i class="fas fa-award"></i>
                        <span>بوابة سباهي</span>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const OWNER_EMAIL = 'husseinbabsail@gmail.com';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
            authDomain: "insurance-check-6cec9.firebaseapp.com",
            projectId: "insurance-check-6cec9",
            storageBucket: "insurance-check-6cec9.appspot.com",
            messagingSenderId: "992769471393",
            appId: "1:992769471393:web:c8a9400210a0e7901011e0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const APIs = {
            complaints: "https://script.google.com/macros/s/AKfycbyE0nbyfYrDZeOHr6TuEQP7ivpOLF1pLmBFoF7fkDmNjQp5g6dW4i0xkcSBJJRaoOCVAw/exec",
            incidents: "https://script.google.com/macros/s/AKfycbxHW20iOESJdvDuGBjKBVGZ7ZVlNy-PfRY8tJvmsIvtdcSxhbiBYL0CXLVwCjIJz-y8/exec",
            risks: "https://script.google.com/macros/s/AKfycbyDLVS-KI6_EEVE68f9O9ubgUhZtA9LBVofWJ4l6cEDnYTuDvvyQf4cEwQxDFC532Pf/exec",
            rounds: "https://script.google.com/macros/s/AKfycbwjoTetIgrjnESeW3gJlezUbm4ReK3nF1nS5xbs1oItrHMsfTlMfkWCfn45S9sSjf3y/exec",
            needlestick: "https://script.google.com/macros/s/AKfycbyWPna2RXgl_P8xYfnIxG634pS8fVoAtW6X8Ch8-fzM0ASZNz49OIORmYwxjbiVapHEyg/exec",
            calibration: "https://script.google.com/macros/s/AKfycbxhKSq0qMIT85_pUfiba5V5Pi-kO_Df4Qw98MRIM4fmCb-XcheI8uGQccFxuKjigATHlQ/exec",
            maintenance: "https://script.google.com/macros/s/AKfycbxw6oWSHKDjeZI6dsspS3PVVwbO9KO5UnjKGqDa_yP9cYAVjNHh6WMfQrdlpkF_A25--A/exec",
            eoc: "https://script.google.com/macros/s/AKfycbytslZrI7jIgUY0iavZPfgOiEPZKgkjFaNgTBCcWByHLARdEFb4Qkzi4Ecad0v_Q7SL1w/exec"
        };

        const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
        }).format(new Date());
        document.getElementById('dateDisplay').textContent = hijriDate;

        function calculateCalibrationStats(data) {
            if (!data || data.status !== 'success' || !data.data) {
                return { compliance: 0, overdue: 0, pass: 0, fail: 0, total: 0, upcoming: 0 };
            }
            const assetsMap = data.data.assetsMap || {};
            const records = data.data.records || [];
            let totalTasks = 0;
            Object.values(assetsMap).forEach(arr => totalTasks += arr.length);
            let pass = 0, fail = 0, overdue = 0, upcoming = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const upcomingThreshold = new Date(today);
            upcomingThreshold.setDate(upcomingThreshold.getDate() + 30);
            const latestRecords = {};
            records.forEach(r => {
                const assetID = r.AssetID || r.assetID || r.asset_id;
                const recordDate = r.TestDate || r.Timestamp || r.date;
                if (!assetID) return;
                if (!latestRecords[assetID] || new Date(recordDate) > new Date(latestRecords[assetID].recordDate)) {
                    latestRecords[assetID] = { ...r, recordDate };
                }
            });
            Object.values(latestRecords).forEach(r => {
                const result = r.Result || r.result;
                if (result === 'Pass') pass++;
                else if (result === 'Fail') fail++;
                const nd = r.NextDue || r.nextDue || r.next_due;
                if (nd) {
                    const nextDue = new Date(nd);
                    if (nextDue < today) overdue++;
                    else if (nextDue <= upcomingThreshold) upcoming++;
                }
            });
            const compliance = totalTasks > 0 ? Math.round((pass / totalTasks) * 100) : 0;
            return { compliance, overdue, pass, fail, total: totalTasks, upcoming };
        }

        async function apiCall(url, action, payload = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, payload }),
                    redirect: 'follow'
                });
                const text = await response.text();
                try { return JSON.parse(text); }
                catch (e) { return { ok: false, error: 'Invalid response' }; }
            } catch (e) {
                console.error(`API Error (${action}):`, e);
                return { ok: false, error: e.message };
            }
        }

        async function fetchJsonp(url) {
            const r = await fetch(url, { redirect: 'follow' });
            const text = await r.text();
            const m = text.match(/^[a-zA-Z_$][\w$]*\s*\((.*)\)\s*;?\s*$/s);
            if (m && m[1]) return JSON.parse(m[1]);
            return JSON.parse(text);
        }

        window.loadDashboardData = async function() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            console.log('Loading dashboard data...');

            try {
                const [complaintsRes, incidentsRes, risksRes, roundsRes, needlestickRes, calibrationRes, maintenanceRes] = await Promise.all([
                    apiCall(APIs.complaints, 'getComplaintStats', {}),
                    apiCall(APIs.incidents, 'getIncidentStats', {}),
                    fetch(APIs.risks + '?action=metrics').then(r => r.json()).catch(e => ({ success: false })),
                    apiCall(APIs.rounds, 'getMetrics', {}),
                    fetchJsonp(APIs.needlestick + '?action=data').catch(e => ({ success: false })),
                    fetch(APIs.calibration).then(r => r.json()).catch(e => ({ status: 'error' })),
                    apiCall(APIs.maintenance, 'getKPIs', {})
                ]);

                console.log('Complaints:', complaintsRes);
                console.log('Incidents:', incidentsRes);
                console.log('Risks:', risksRes);
                console.log('Rounds:', roundsRes);
                console.log('Calibration:', calibrationRes);
                console.log('Maintenance:', maintenanceRes);

                if (complaintsRes.ok) {
                    const s = complaintsRes;
                    const openComplaints = (s.new || 0) + (s.in_progress || 0);
                    document.getElementById('kpi-complaints-open').textContent = openComplaints;
                    const escEl = document.getElementById('kpi-complaints-escalated');
                    if (s.escalated > 0) {
                        escEl.textContent = `${s.escalated} مصعّدة`;
                        escEl.classList.add('danger');
                    } else { escEl.textContent = ''; escEl.classList.remove('danger'); }
                    document.getElementById('stat-complaints-new').textContent = s.new || 0;
                    document.getElementById('stat-complaints-progress').textContent = s.in_progress || 0;
                    document.getElementById('stat-complaints-escalated').textContent = s.escalated || 0;
                    document.getElementById('stat-complaints-closed').textContent = s.closed || 0;
                }

                if (incidentsRes.ok) {
                    const s = incidentsRes;
                    const openIncidents = s.open || ((s.new || 0) + (s.in_progress || 0) + (s.under_review || 0));
                    const escalatedCount = s.byStatus?.escalated?.count || s.escalated || 0;
                    document.getElementById('kpi-incidents-open').textContent = openIncidents;
                    const incEscEl = document.getElementById('kpi-incidents-escalated');
                    if (escalatedCount > 0) {
                        incEscEl.textContent = `${escalatedCount} مصعّدة`;
                        incEscEl.classList.add('danger');
                    } else { incEscEl.textContent = ''; incEscEl.classList.remove('danger'); }
                    document.getElementById('stat-incidents-new').textContent = s.new || s.open || 0;
                    document.getElementById('stat-incidents-progress').textContent = s.in_progress || 0;
                    document.getElementById('stat-incidents-escalated').textContent = escalatedCount;
                    document.getElementById('stat-incidents-closed').textContent = s.closed || 0;
                }

                if (risksRes.ok) {
                    const r = risksRes;
                    const activeRisks = r.total || (r.high || 0) + (r.med || 0) + (r.low || 0);
                    document.getElementById('kpi-risks-active').textContent = activeRisks;
                    document.getElementById('kpi-risks-high').textContent = r.high ? `${r.high} عالي` : '';
                    document.getElementById('stat-risks-high').textContent = r.high || 0;
                    document.getElementById('stat-risks-medium').textContent = r.med || r.medium || 0;
                    document.getElementById('stat-risks-low').textContent = r.low || 0;
                    document.getElementById('stat-risks-resolved').textContent = r.resolved || r.closed || 0;
                }

                if (roundsRes.ok) {
                    const rd = roundsRes;
                    document.getElementById('kpi-rounds-today').textContent = rd.completed || 0;
                    if (rd.delayed > 0) {
                        document.getElementById('kpi-rounds-delayed').textContent = `${rd.delayed} متأخرة`;
                        document.getElementById('kpi-rounds-delayed').style.color = '#DC143C';
                    } else if (rd.violations > 0) {
                        document.getElementById('kpi-rounds-delayed').textContent = `${rd.violations} مخالفة`;
                        document.getElementById('kpi-rounds-delayed').style.color = '#f0ad4e';
                    } else {
                        document.getElementById('kpi-rounds-delayed').textContent = '';
                    }
                }

                const needleData = needlestickRes.rows || needlestickRes.data;
                if ((needlestickRes.success || needlestickRes.status === 'success') && Array.isArray(needleData)) {
                    const records = needleData;
                    const total = records.length;
                    const now = new Date();
                    const thisMonth = records.filter(r => {
                        const d = new Date(r.date || r.timestamp);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    }).length;
                    document.getElementById('kpi-needlestick').textContent = total;
                    document.getElementById('kpi-needlestick-month').textContent = thisMonth > 0 ? `${thisMonth} هذا الشهر` : '';
                } else if (needlestickRes.total !== undefined) {
                    document.getElementById('kpi-needlestick').textContent = needlestickRes.total || 0;
                    document.getElementById('kpi-needlestick-month').textContent = needlestickRes.thisMonth ? `${needlestickRes.thisMonth} هذا الشهر` : '';
                } else {
                    document.getElementById('kpi-needlestick').textContent = '0';
                }

                const calStats = calculateCalibrationStats(calibrationRes);
                console.log('Calibration Stats:', calStats);
                if (calStats.total > 0) {
                    const compEl = document.getElementById('kpi-calibration-compliance');
                    compEl.textContent = calStats.compliance + '%';
                    if (calStats.compliance >= 80) compEl.style.color = '#28a745';
                    else if (calStats.compliance >= 70) compEl.style.color = '#ff9800';
                    else compEl.style.color = '#DC143C';
                    const overdueEl = document.getElementById('kpi-calibration-overdue');
                    if (calStats.overdue > 0) {
                        overdueEl.textContent = `${calStats.overdue} جهاز متأخر`;
                        overdueEl.classList.add('danger');
                    } else {
                        overdueEl.textContent = `${calStats.total} جهاز مُصان`;
                        overdueEl.classList.remove('danger');
                        overdueEl.style.color = '#28a745';
                    }
                } else {
                    document.getElementById('kpi-calibration-compliance').textContent = '--';
                    document.getElementById('kpi-calibration-overdue').textContent = 'لا توجد بيانات';
                }

                if (maintenanceRes && (maintenanceRes.success || maintenanceRes.ok || maintenanceRes.notServiced !== undefined)) {
                    const m = maintenanceRes.data || maintenanceRes;
                    const notServiced = m.notServiced ?? m.notServicedDevices ?? 0;
                    const completed = m.completed ?? m.servicedDevices ?? 0;
                    const overdue = m.overdue ?? m.overdueDevices ?? 0;
                    document.getElementById('kpi-maintenance-total').textContent = notServiced;
                    const completedEl = document.getElementById('kpi-maintenance-completed');
                    const overdueEl = document.getElementById('kpi-maintenance-overdue');
                    completedEl.textContent = `مكتملة ${completed}`;
                    completedEl.style.color = '#28a745';
                    if (overdue > 0) {
                        overdueEl.textContent = `متأخرة ${overdue}`;
                        overdueEl.style.color = '#DC143C';
                    } else { overdueEl.textContent = ''; }
                } else {
                    document.getElementById('kpi-maintenance-total').textContent = '--';
                    document.getElementById('kpi-maintenance-completed').textContent = '';
                    document.getElementById('kpi-maintenance-overdue').textContent = 'لا توجد بيانات';
                }

                updateAlerts(complaintsRes, incidentsRes, risksRes, roundsRes, calStats);
                updateEocSmartCard();

            } catch (e) {
                console.error('Dashboard load error:', e);
            } finally {
                refreshBtn.classList.remove('loading');
            }
        };

        function updateAlerts(complaints, incidents, risks, rounds, cal) {
            const container = document.getElementById('alertsContainer');
            const alerts = [];

            if (complaints.ok && complaints.escalated > 0) {
                alerts.push({ type: 'danger', icon: 'fas fa-comment-dots', text: `${complaints.escalated} شكوى مصعّدة تحتاج مراجعة` });
            }
            if (incidents.ok) {
                const escCount = incidents.byStatus?.escalated?.count || incidents.escalated || 0;
                if (escCount > 0) alerts.push({ type: 'danger', icon: 'fas fa-exclamation-triangle', text: `${escCount} حادثة مصعّدة تحتاج تدخل` });
            }
            if (risks.ok && risks.high > 0) {
                alerts.push({ type: 'warning', icon: 'fas fa-shield-alt', text: `${risks.high} مخاطر عالية المستوى` });
            }
            if (rounds.ok && rounds.delayed > 0) {
                alerts.push({ type: 'warning', icon: 'fas fa-clipboard-check', text: `${rounds.delayed} جولات متأخرة` });
            }
            if (cal && cal.overdue > 0) {
                alerts.push({ type: 'info', icon: 'fas fa-cogs', text: `${cal.overdue} جهاز متأخر في المعايرة` });
            }

            if (alerts.length > 0) {
                container.innerHTML = alerts.map(a => `
                    <div class="alert-item ${a.type}">
                        <i class="${a.icon}"></i>
                        <span>${a.text}</span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="no-alerts">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success);"></i>
                        <p>لا توجد تنبيهات عاجلة - كل شيء تحت السيطرة</p>
                    </div>
                `;
            }
        }

        async function updateEocSmartCard() {
            const card = document.getElementById('eocSmartCard');
            const icon = document.getElementById('eocSmartIcon');
            const countEl = document.getElementById('kpi-eoc-count');
            const labelEl = document.getElementById('kpi-eoc-label');
            const statusEl = document.getElementById('kpi-eoc-status');

            try {
                const [activeRes, reportsRes] = await Promise.all([
                    fetchJsonp(APIs.eoc + '?action=getActiveCommand'),
                    fetchJsonp(APIs.eoc + '?action=getEmergencyReports&limit=100')
                ]);

                const cmd = activeRes.command || {};
                const isActive = activeRes.ok && (cmd.status === 'active' || activeRes.status === 'active') && cmd.sessionId;

                let totalReports = 0;
                if (reportsRes.ok && Array.isArray(reportsRes.reports)) {
                    totalReports = reportsRes.reports.length;
                }

                if (isActive) {
                    icon.classList.add('active');
                    countEl.textContent = '⚠️';
                    labelEl.textContent = cmd.responseType || 'طوارئ نشطة';
                    statusEl.textContent = cmd.location || 'تحقق الآن!';
                    statusEl.classList.add('danger');
                } else {
                    icon.classList.remove('active');
                    countEl.textContent = totalReports;
                    labelEl.textContent = 'حالة طوارئ';
                    statusEl.textContent = 'الوضع طبيعي ✓';
                    statusEl.classList.remove('danger');
                }
            } catch (e) {
                console.error('EOC error:', e);
                countEl.textContent = '0';
                statusEl.textContent = 'الوضع طبيعي ✓';
            }
        }

        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = 'portal.html');
        });

        onAuthStateChanged(auth, async (user) => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const accessDenied = document.getElementById('accessDenied');

            if (user) {
                try {
                    if (user.email === OWNER_EMAIL) {
                        document.getElementById('ownerName').textContent = user.displayName || user.email.split('@')[0];
                        document.body.classList.add('authenticated');
                        loadingOverlay.style.display = 'none';
                        loadDashboardData();
                    } else {
                        const roleDoc = await getDoc(doc(db, "staff_roles", user.uid));
                        if (roleDoc.exists() && roleDoc.data().role === 'owner') {
                            document.getElementById('ownerName').textContent = user.displayName || roleDoc.data().name || user.email.split('@')[0];
                            document.body.classList.add('authenticated');
                            loadingOverlay.style.display = 'none';
                            loadDashboardData();
                        } else {
                            loadingOverlay.style.display = 'none';
                            accessDenied.style.display = 'flex';
                        }
                    }
                } catch (e) {
                    console.error('Auth error:', e);
                    loadingOverlay.style.display = 'none';
                    accessDenied.style.display = 'flex';
                }
            } else {
                window.location.href = 'admin-login.html?redirect=owner-dashboard.html';
            }
        });
    </script>
</body>
</html>
