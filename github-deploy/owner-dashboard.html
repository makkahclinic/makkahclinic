<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø© - Ø§Ù„Ù…Ø§Ù„Ùƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-dark: #152a45;
            --gold: #c9a962;
            --success: #10b981;
            --danger: #dc3545;
            --warning: #f59e0b;
            --info: #17a2b8;
            --bg-light: #f8f9fa;
            --sidebar-width: 260px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            display: flex;
        }
        .sidebar, .main-content { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        body.authenticated .sidebar, body.authenticated .main-content { visibility: visible; opacity: 1; }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 100;
            transition: transform 0.3s;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 1.2rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            padding: 5px;
        }
        .sidebar-header h3 {
            color: white;
            margin-top: 0.6rem;
            font-size: 0.95rem;
        }
        .sidebar-header .role-badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: var(--primary-dark);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-top: 0.4rem;
            font-weight: 700;
        }
        .nav-menu { padding: 0.8rem 0; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-right: 4px solid transparent;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-right-color: var(--gold);
        }
        .nav-item i { width: 22px; text-align: center; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 0.8rem 0; }
        
        .main-content {
            margin-right: var(--sidebar-width);
            flex: 1;
            padding: 1.2rem;
            min-height: 100vh;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.2rem;
        }
        .welcome-text h2 { color: var(--primary); font-size: 1.2rem; }
        .welcome-text p { color: #666; font-size: 0.85rem; }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.2rem;
        }
        .kpi-card {
            background: white;
            border-radius: 14px;
            padding: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            border: 1px solid rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--gold);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        .kpi-card:hover::before { opacity: 1; }
        .kpi-icon {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .kpi-icon.eoc { background: linear-gradient(135deg, #10b981, #059669); }
        .kpi-icon.eoc.active { background: linear-gradient(135deg, #dc2626, #991b1b); animation: pulse 1s infinite; }
        .kpi-icon.complaints { background: linear-gradient(135deg, #667eea, #764ba2); }
        .kpi-icon.incidents { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .kpi-icon.risks { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .kpi-icon.rounds { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .kpi-icon.calibration { background: linear-gradient(135deg, #fa709a, #fee140); }
        .kpi-icon.maintenance { background: linear-gradient(135deg, #667eea, #764ba2); }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .kpi-info h3 { font-size: 1.6rem; color: var(--primary); line-height: 1; font-weight: 700; }
        .kpi-info p { font-size: 0.8rem; color: #555; margin-top: 4px; font-weight: 500; }
        .kpi-info .sub { font-size: 0.75rem; color: #999; display: block; margin-top: 2px; }
        .kpi-info .sub.danger { color: var(--danger) !important; font-weight: 700; }
        
        .alerts-section {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid #eee;
        }
        .section-header h3 { font-size: 1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .alert-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .alert-item.danger { background: #fff5f5; border-right: 4px solid var(--danger); }
        .alert-item.warning { background: #fffbeb; border-right: 4px solid var(--warning); }
        .alert-item.info { background: #f0f9ff; border-right: 4px solid var(--info); }
        .no-alerts { text-align: center; padding: 1.5rem; color: #999; font-size: 0.9rem; }
        
        .stats-grid-detailed {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.2rem;
        }
        .stats-box {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stats-box h4 {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }
        .stats-row:last-child { border-bottom: none; }
        .stats-row .label { color: #666; }
        .stats-row .value { font-weight: 700; color: var(--primary); }
        .stats-row .value.danger { color: var(--danger); }
        .stats-row .value.warning { color: var(--warning); }
        .stats-row .value.success { color: var(--success); }
        
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .refresh-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .refresh-btn:hover { background: #f0f0f0; }
        .refresh-btn.loading i { animation: spin 1s linear infinite; }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
        }
        .users-table th {
            background: var(--bg-light);
            padding: 12px;
            text-align: right;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid #e2e8f0;
        }
        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .users-table tr:hover { background: #f8fafc; }
        .role-badge-small {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .role-owner { background: #fef3c7; color: #92400e; }
        .role-admin { background: #dbeafe; color: #1e40af; }
        .role-staff { background: #e5e7eb; color: #374151; }
        
        .action-btns { display: flex; gap: 5px; }
        .action-btns button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: right;
            font-weight: 600;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table tr:hover { background: #f1f5f9; }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-new { background: #dbeafe; color: #1e40af; }
        .status-progress { background: #fef3c7; color: #92400e; }
        .status-escalated { background: #fee2e2; color: #991b1b; }
        .status-closed { background: #d1fae5; color: #065f46; }
        .status-high { background: #fee2e2; color: #991b1b; }
        .status-medium { background: #fef3c7; color: #92400e; }
        .status-low { background: #d1fae5; color: #065f46; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .filter-bar input, .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
        }
        .filter-bar input { flex: 1; min-width: 200px; }
        
        @media (max-width: 992px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; padding: 1rem; }
            .menu-toggle { display: block !important; }
        }
        .menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .access-denied {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-align: center;
            padding: 20px;
        }
        .access-denied i { font-size: 80px; margin-bottom: 20px; color: var(--danger); }
        .access-denied h1 { font-size: 2rem; margin-bottom: 10px; }
        .access-denied .btn-back {
            background: var(--gold);
            color: var(--primary);
            padding: 12px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700;
            margin-top: 20px;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 9999;
            font-weight: 600;
        }
        .toast.error { background: var(--danger); }
        .toast.show { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="margin-top: 15px; color: var(--primary);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©...</p>
    </div>
    
    <div class="access-denied" id="accessDenied" style="display: none;">
        <i class="fas fa-lock"></i>
        <h1>Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶</h1>
        <p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·</p>
        <a href="portal.html" class="btn-back"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨ÙˆØ§Ø¨Ø©</a>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo-transparent.png" alt="Logo" onerror="this.src='https://via.placeholder.com/60?text=M'">
            <h3 id="ownerName">Ø§Ù„Ù…Ø§Ù„Ùƒ</h3>
            <span class="role-badge"><i class="fas fa-crown"></i> Ø§Ù„Ù…Ø§Ù„Ùƒ</span>
        </div>
        <nav class="nav-menu">
            <a class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</span>
            </a>
            <a class="nav-item" data-section="eoc">
                <i class="fas fa-broadcast-tower"></i>
                <span>Ù…Ø±ÙƒØ² EOC</span>
            </a>
            <a class="nav-item" href="cbahi-portal.html" target="_blank">
                <i class="fas fa-award"></i>
                <span>Ø¨ÙˆØ§Ø¨Ø© Ø³Ø¨Ø§Ù‡ÙŠ</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" data-section="complaints">
                <i class="fas fa-comment-dots"></i>
                <span>Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</span>
            </a>
            <a class="nav-item" data-section="incidents">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</span>
            </a>
            <a class="nav-item" data-section="risks">
                <i class="fas fa-shield-alt"></i>
                <span>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span>
            </a>
            <a class="nav-item" data-section="rounds">
                <i class="fas fa-clipboard-check"></i>
                <span>Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" data-section="users">
                <i class="fas fa-users-cog"></i>
                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
            </a>
            <a class="nav-item" data-section="permissions">
                <i class="fas fa-user-shield"></i>
                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="welcome-text">
                <h2>Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø©</h2>
                <p id="dateDisplay">Ù…Ø¬Ù…Ø¹ Ù…ÙƒØ© Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ø²Ø§Ù‡Ø±</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="refresh-btn" id="refreshBtn" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" onclick="loadAllData()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <a href="index.html" class="btn btn-outline">
                    <i class="fas fa-external-link-alt"></i>
                    Ø§Ù„Ù…ÙˆÙ‚Ø¹
                </a>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <section class="content-section active" id="section-dashboard">
            <div class="kpi-grid">
                <div class="kpi-card" onclick="switchSection('eoc')">
                    <div class="kpi-icon eoc" id="eocIcon"><i class="fas fa-broadcast-tower"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-eoc">Ø·Ø¨ÙŠØ¹ÙŠ</h3>
                        <p>Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</p>
                        <span class="sub" id="kpi-eoc-status">Ø§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ âœ“</span>
                    </div>
                </div>
                <div class="kpi-card" onclick="switchSection('complaints')">
                    <div class="kpi-icon complaints"><i class="fas fa-comment-dots"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-complaints">0</h3>
                        <p>Ø´ÙƒÙˆÙ‰ Ù…ÙØªÙˆØ­Ø©</p>
                        <span class="sub" id="kpi-complaints-sub">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
                    </div>
                </div>
                <div class="kpi-card" onclick="switchSection('incidents')">
                    <div class="kpi-icon incidents"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-incidents">0</h3>
                        <p>Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø©</p>
                        <span class="sub" id="kpi-incidents-sub">ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</span>
                    </div>
                </div>
                <div class="kpi-card" onclick="switchSection('risks')">
                    <div class="kpi-icon risks"><i class="fas fa-shield-alt"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-risks">0</h3>
                        <p>Ø®Ø·Ø± Ù†Ø´Ø·</p>
                        <span class="sub danger" id="kpi-risks-sub">ÙŠØ­ØªØ§Ø¬ ØªÙ‚ÙŠÙŠÙ…</span>
                    </div>
                </div>
                <div class="kpi-card" onclick="switchSection('rounds')">
                    <div class="kpi-icon rounds"><i class="fas fa-clipboard-check"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-rounds">0</h3>
                        <p>Ø¬ÙˆÙ„Ø© Ø§Ù„ÙŠÙˆÙ…</p>
                        <span class="sub" id="kpi-rounds-sub">Ù…ÙƒØªÙ…Ù„Ø©</span>
                    </div>
                </div>
            </div>

            <div class="alerts-section">
                <div class="section-header">
                    <h3><i class="fas fa-bell"></i> Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„ØªØµØ¹ÙŠØ¯Ø§Øª</h3>
                    <button class="refresh-btn" onclick="loadAlerts()"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <div id="alertsContainer">
                    <div class="no-alerts">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success);"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ø§Ø¬Ù„Ø© - ÙƒÙ„ Ø´ÙŠØ¡ ØªØ­Øª Ø§Ù„Ø³ÙŠØ·Ø±Ø©</p>
                    </div>
                </div>
            </div>

            <div class="stats-grid-detailed">
                <div class="stats-box">
                    <h4><i class="fas fa-comment-dots"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h4>
                    <div class="stats-row">
                        <span class="label">Ø¬Ø¯ÙŠØ¯Ø©</span>
                        <span class="value" id="stat-complaints-new">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
                        <span class="value warning" id="stat-complaints-progress">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ØµØ¹Ù‘Ø¯Ø©</span>
                        <span class="value danger" id="stat-complaints-escalated">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ØºÙ„Ù‚Ø©</span>
                        <span class="value success" id="stat-complaints-closed">0</span>
                    </div>
                </div>
                <div class="stats-box">
                    <h4><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</h4>
                    <div class="stats-row">
                        <span class="label">Ø¬Ø¯ÙŠØ¯Ø©</span>
                        <span class="value" id="stat-incidents-new">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</span>
                        <span class="value warning" id="stat-incidents-progress">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ØµØ¹Ù‘Ø¯Ø©</span>
                        <span class="value danger" id="stat-incidents-escalated">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ØºÙ„Ù‚Ø©</span>
                        <span class="value success" id="stat-incidents-closed">0</span>
                    </div>
                </div>
                <div class="stats-box">
                    <h4><i class="fas fa-shield-alt"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h4>
                    <div class="stats-row">
                        <span class="label">Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ</span>
                        <span class="value danger" id="stat-risks-high">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·</span>
                        <span class="value warning" id="stat-risks-medium">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶</span>
                        <span class="value" id="stat-risks-low">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">Ù…ÙØ¹Ø§Ù„Ø¬Ø©</span>
                        <span class="value success" id="stat-risks-resolved">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ù…Ø±ÙƒØ² EOC -->
        <section class="content-section" id="section-eoc">
            <div class="stats-box">
                <h4><i class="fas fa-broadcast-tower"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© EOC - Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h4>
                <div id="eocStatusCard" style="padding: 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; color: white; text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <h3 style="font-size: 1.5rem;">Ø§Ù„ÙˆØ¶Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ</h3>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·Ø©</p>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    <a href="eoc-command.html" target="_blank" class="btn btn-primary"><i class="fas fa-external-link-alt"></i> ÙØªØ­ EOC ÙƒØ§Ù…Ù„</a>
                    <a href="emergency-report.html" target="_blank" class="btn btn-danger"><i class="fas fa-exclamation-circle"></i> Ø¥Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦</a>
                    <a href="Emergency.html" target="_blank" class="btn btn-outline"><i class="fas fa-tv"></i> Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶</a>
                </div>
                <h4 style="margin-top: 20px;"><i class="fas fa-history"></i> Ø¢Ø®Ø± Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h4>
                <div id="eocReportsContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ -->
        <section class="content-section" id="section-complaints">
            <div class="stats-box">
                <h4><i class="fas fa-comment-dots"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h4>
                <div class="filter-bar">
                    <input type="text" id="complaintsSearch" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰...">
                    <select id="complaintsFilter">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                        <option value="new">Ø¬Ø¯ÙŠØ¯Ø©</option>
                        <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                        <option value="escalated">Ù…ØµØ¹Ù‘Ø¯Ø©</option>
                        <option value="closed">Ù…ØºÙ„Ù‚Ø©</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadComplaints()"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
                    <a href="complaint_analysis.html" target="_blank" class="btn btn-outline"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„</a>
                </div>
                <div id="complaintsContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø­ÙˆØ§Ø¯Ø« -->
        <section class="content-section" id="section-incidents">
            <div class="stats-box">
                <h4><i class="fas fa-exclamation-triangle"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</h4>
                <div class="filter-bar">
                    <input type="text" id="incidentsSearch" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«...">
                    <select id="incidentsFilter">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                        <option value="new">Ø¬Ø¯ÙŠØ¯Ø©</option>
                        <option value="under_investigation">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</option>
                        <option value="escalated">Ù…ØµØ¹Ù‘Ø¯Ø©</option>
                        <option value="closed">Ù…ØºÙ„Ù‚Ø©</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadIncidents()"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
                    <a href="incident-report-analysis.html" target="_blank" class="btn btn-outline"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„</a>
                </div>
                <div id="incidentsContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø§Ø·Ø± -->
        <section class="content-section" id="section-risks">
            <div class="stats-box">
                <h4><i class="fas fa-shield-alt"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h4>
                <div class="filter-bar">
                    <input type="text" id="risksSearch" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø§Ø·Ø±...">
                    <select id="risksFilter">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</option>
                        <option value="high">Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ</option>
                        <option value="medium">Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·</option>
                        <option value="low">Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadRisks()"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
                    <a href="risk-register.html" target="_blank" class="btn btn-outline"><i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø±</a>
                </div>
                <div id="risksContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¬ÙˆÙ„Ø§Øª -->
        <section class="content-section" id="section-rounds">
            <div class="stats-box">
                <h4><i class="fas fa-clipboard-check"></i> Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©</h4>
                <div class="filter-bar">
                    <input type="date" id="roundsDate">
                    <button class="btn btn-primary" onclick="loadRounds()"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
                    <a href="Round.html" target="_blank" class="btn btn-outline"><i class="fas fa-external-link-alt"></i> Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</a>
                </div>
                <div id="roundsContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
        <section class="content-section" id="section-users">
            <div class="stats-box">
                <h4><i class="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„</h4>
                <div id="usersStats" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; padding:15px; background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius:12px;">
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #10b981;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#10b981;" id="usersActiveCount">0</div>
                        <div style="font-size:0.8rem; color:#666;">Ù†Ø´Ø·</div>
                    </div>
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #f59e0b;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#f59e0b;" id="usersSuspendedCount">0</div>
                        <div style="font-size:0.8rem; color:#666;">Ù…Ø¹Ù„Ù‚</div>
                    </div>
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #1e3a5f;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#1e3a5f;" id="usersTotalCount">0</div>
                        <div style="font-size:0.8rem; color:#666;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                    </div>
                </div>
                <div class="filter-bar">
                    <input type="text" id="usersSearch" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯...">
                    <select id="usersRoleFilter">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>
                        <option value="owner">Ù…Ø§Ù„Ùƒ</option>
                        <option value="admin">Ù…Ø¯ÙŠØ±</option>
                        <option value="staff">Ù…ÙˆØ¸Ù</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadUsers()"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <div id="usersContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>

        <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
        <section class="content-section" id="section-permissions">
            <div class="stats-box">
                <h4><i class="fas fa-user-shield"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h4>
                <p style="color:#666; margin-bottom:15px;">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
                <div id="permissionsContainer">
                    <div class="no-alerts">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </div>
        </section>
    </main>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</span>
    </div>

    <script>
        const OWNER_EMAIL = 'husseinbabsail@gmail.com';
        const API_URL = 'https://script.google.com/macros/s/AKfycbytslZrI7jIgUY0iavZPfgOiEPZKgkjFaNgTBCcWByHLARdEFb4Qkzi4Ecad0v_Q7SL1w/exec';
        
        const APIs = {
            main: API_URL,
            complaints: "https://script.google.com/macros/s/AKfycbyE0nbyfYrDZeOHr6TuEQP7ivpOLF1pLmBBF7fkDmNjQp5g6dW4i0xkcSBJJRaoOCVAw/exec",
            incidents: "https://script.google.com/macros/s/AKfycbxHW20iOESJdvDuGBjKBVGZ7ZVlNy-PfRY8tJvmsIvtdcSxhbiBYL0CXLVwCjIJz-y8/exec",
            risks: "https://script.google.com/macros/s/AKfycbyDLVS-KI6_EEVE68f9O9ubgUhZtA9LBVofWJ4l6cEDnYTuDvvyQf4cEwQxDFC532Pf/exec",
            rounds: "https://script.google.com/macros/s/AKfycbwjoTetIgrjnESeW3gJlezUbm4ReK3nF1nS5xbs1oItrHMsfTlMfkWCfn45S9sSjf3y/exec"
        };
        
        const firebaseConfig = {
            apiKey: "AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
            authDomain: "insurance-check-6cec9.firebaseapp.com",
            projectId: "insurance-check-6cec9",
            storageBucket: "insurance-check-6cec9.appspot.com",
            messagingSenderId: "992769471393",
            appId: "1:992769471393:web:c8a9400210a0e7901011e0"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let idToken = null;
        
        const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        }).format(new Date());
        document.getElementById('dateDisplay').textContent = hijriDate;
        
        function jsonpCall(url, callback) {
            const callbackName = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(null, data);
            };
            
            script.onerror = function() {
                delete window[callbackName];
                document.body.removeChild(script);
                callback(new Error('JSONP request failed'), null);
            };
            
            const separator = url.includes('?') ? '&' : '?';
            script.src = url + separator + 'callback=' + callbackName;
            document.body.appendChild(script);
        }
        
        function apiCall(action, params = {}) {
            return new Promise((resolve, reject) => {
                let url = API_URL + '?action=' + action;
                for (const key in params) {
                    url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
                }
                if (idToken) {
                    url += '&idToken=' + encodeURIComponent(idToken);
                }
                
                jsonpCall(url, (err, data) => {
                    if (err) reject(err);
                    else resolve(data);
                });
            });
        }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function switchSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            const section = document.getElementById('section-' + sectionName);
            if (section) {
                section.classList.add('active');
                const navItem = document.querySelector(`.nav-item[data-section="${sectionName}"]`);
                if (navItem) navItem.classList.add('active');
                
                if (sectionName === 'complaints') loadComplaints();
                else if (sectionName === 'incidents') loadIncidents();
                else if (sectionName === 'risks') loadRisks();
                else if (sectionName === 'rounds') loadRounds();
                else if (sectionName === 'users') loadUsers();
                else if (sectionName === 'permissions') loadPermissions();
                else if (sectionName === 'eoc') loadEocData();
            }
        }
        
        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section;
                if (section) switchSection(section);
            });
        });
        
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'portal.html';
            });
        });
        
        async function loadAllData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            
            try {
                await Promise.all([
                    loadDashboardStats(),
                    loadAlerts()
                ]);
            } catch (e) {
                console.error('Error loading data:', e);
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }
        
        async function loadDashboardStats() {
            try {
                const data = await apiCall('getOwnerDashboardStats');
                console.log('Dashboard stats:', data);
                
                if (data.success) {
                    const stats = data.stats || data;
                    
                    if (stats.emergency && stats.emergency.active) {
                        document.getElementById('kpi-eoc').textContent = 'Ø·ÙˆØ§Ø±Ø¦!';
                        document.getElementById('kpi-eoc-status').textContent = stats.emergency.type || 'Ø­Ø§Ù„Ø© Ù†Ø´Ø·Ø©';
                        document.getElementById('kpi-eoc-status').classList.add('danger');
                        document.getElementById('eocIcon').classList.add('active');
                    }
                    
                    if (stats.complaints) {
                        document.getElementById('kpi-complaints').textContent = stats.complaints.open || 0;
                        document.getElementById('stat-complaints-new').textContent = stats.complaints.new || 0;
                        document.getElementById('stat-complaints-progress').textContent = stats.complaints.inProgress || 0;
                        document.getElementById('stat-complaints-escalated').textContent = stats.complaints.escalated || 0;
                        document.getElementById('stat-complaints-closed').textContent = stats.complaints.closed || 0;
                        if (stats.complaints.escalated > 0) {
                            document.getElementById('kpi-complaints-sub').textContent = stats.complaints.escalated + ' Ù…ØµØ¹Ù‘Ø¯Ø©';
                            document.getElementById('kpi-complaints-sub').classList.add('danger');
                        }
                    }
                    
                    if (stats.incidents) {
                        document.getElementById('kpi-incidents').textContent = stats.incidents.open || 0;
                        document.getElementById('stat-incidents-new').textContent = stats.incidents.new || 0;
                        document.getElementById('stat-incidents-progress').textContent = stats.incidents.investigation || 0;
                        document.getElementById('stat-incidents-escalated').textContent = stats.incidents.escalated || 0;
                        document.getElementById('stat-incidents-closed').textContent = stats.incidents.closed || 0;
                    }
                    
                    if (stats.risks) {
                        document.getElementById('kpi-risks').textContent = stats.risks.active || 0;
                        document.getElementById('stat-risks-high').textContent = stats.risks.high || 0;
                        document.getElementById('stat-risks-medium').textContent = stats.risks.medium || 0;
                        document.getElementById('stat-risks-low').textContent = stats.risks.low || 0;
                        document.getElementById('stat-risks-resolved').textContent = stats.risks.resolved || 0;
                        if (stats.risks.high > 0) {
                            document.getElementById('kpi-risks-sub').textContent = stats.risks.high + ' Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ';
                        }
                    }
                    
                    if (stats.rounds) {
                        document.getElementById('kpi-rounds').textContent = stats.rounds.today || 0;
                        document.getElementById('kpi-rounds-sub').textContent = (stats.rounds.delayed || 0) + ' Ù…ØªØ£Ø®Ø±Ø©';
                    }
                    
                    if (stats.users) {
                        document.getElementById('usersActiveCount').textContent = stats.users.active || 0;
                        document.getElementById('usersSuspendedCount').textContent = stats.users.suspended || 0;
                        document.getElementById('usersTotalCount').textContent = stats.users.total || 0;
                    }
                }
            } catch (e) {
                console.error('Error loading dashboard stats:', e);
            }
        }
        
        function loadAlerts() {
            const container = document.getElementById('alertsContainer');
            apiCall('getOwnerDashboardStats').then(data => {
                if (data.success) {
                    const alerts = [];
                    const stats = data.stats || data;
                    
                    if (stats.complaints && stats.complaints.escalated > 0) {
                        alerts.push({ type: 'danger', icon: 'fas fa-comment-dots', text: `${stats.complaints.escalated} Ø´ÙƒÙˆÙ‰ Ù…ØµØ¹Ù‘Ø¯Ø© ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©`, count: stats.complaints.escalated });
                    }
                    if (stats.incidents && stats.incidents.escalated > 0) {
                        alerts.push({ type: 'danger', icon: 'fas fa-exclamation-triangle', text: `${stats.incidents.escalated} Ø­Ø§Ø¯Ø«Ø© Ù…ØµØ¹Ù‘Ø¯Ø© ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„`, count: stats.incidents.escalated });
                    }
                    if (stats.risks && stats.risks.high > 0) {
                        alerts.push({ type: 'warning', icon: 'fas fa-shield-alt', text: `${stats.risks.high} Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰`, count: stats.risks.high });
                    }
                    if (stats.rounds && stats.rounds.delayed > 0) {
                        alerts.push({ type: 'warning', icon: 'fas fa-clipboard-check', text: `${stats.rounds.delayed} Ø¬ÙˆÙ„Ø§Øª Ù…ØªØ£Ø®Ø±Ø©`, count: stats.rounds.delayed });
                    }
                    
                    if (alerts.length > 0) {
                        container.innerHTML = alerts.map(a => `
                            <div class="alert-item ${a.type}">
                                <i class="${a.icon}"></i>
                                <span class="alert-text">${a.text}</span>
                                <span class="alert-count">${a.count}</span>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div class="no-alerts">
                                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success);"></i>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ø§Ø¬Ù„Ø© - ÙƒÙ„ Ø´ÙŠØ¡ ØªØ­Øª Ø§Ù„Ø³ÙŠØ·Ø±Ø©</p>
                            </div>
                        `;
                    }
                }
            }).catch(e => {
                container.innerHTML = '<div class="no-alerts">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>';
            });
        }
        
        function loadEocData() {
            const container = document.getElementById('eocReportsContainer');
            container.innerHTML = '<div class="no-alerts"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            apiCall('getEmergencyReports').then(data => {
                if (data.success && data.reports && data.reports.length > 0) {
                    const statusCard = document.getElementById('eocStatusCard');
                    const activeReport = data.reports.find(r => r.Status === 'active' || r.Status === 'Ù†Ø´Ø·');
                    
                    if (activeReport) {
                        statusCard.style.background = 'linear-gradient(135deg, #dc2626, #991b1b)';
                        statusCard.innerHTML = `
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 10px; animation: pulse 1s infinite;"></i>
                            <h3 style="font-size: 1.5rem;">Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·Ø©!</h3>
                            <p>${activeReport.Type || activeReport.Ø§Ù„Ù†ÙˆØ¹ || 'Ø·ÙˆØ§Ø±Ø¦'} - ${activeReport.Location || activeReport.Ø§Ù„Ù…ÙˆÙ‚Ø¹ || ''}</p>
                        `;
                    }
                    
                    let html = '<table class="data-table"><thead><tr>';
                    html += '<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.reports.slice(0, 10).forEach(r => {
                        const status = r.Status || r.Ø§Ù„Ø­Ø§Ù„Ø© || 'Ø¬Ø¯ÙŠØ¯';
                        const statusClass = status === 'active' || status === 'Ù†Ø´Ø·' ? 'status-escalated' : 'status-closed';
                        html += `<tr>
                            <td>${r.Timestamp || r.Ø§Ù„ØªØ§Ø±ÙŠØ® || '-'}</td>
                            <td>${r.Type || r.Ø§Ù„Ù†ÙˆØ¹ || '-'}</td>
                            <td>${r.Location || r.Ø§Ù„Ù…ÙˆÙ‚Ø¹ || '-'}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-alerts">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ø·ÙˆØ§Ø±Ø¦ Ø³Ø§Ø¨Ù‚Ø©</div>';
                }
            }).catch(e => {
                container.innerHTML = '<div class="no-alerts">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
            });
        }
        
        function loadComplaints() {
            const container = document.getElementById('complaintsContainer');
            container.innerHTML = '<div class="no-alerts"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            apiCall('getComplaints').then(data => {
                if (data.success && data.complaints && data.complaints.length > 0) {
                    let html = '<table class="data-table"><thead><tr>';
                    html += '<th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø´Ø§ÙƒÙŠ</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.complaints.forEach(c => {
                        const status = c.Status || c.Ø§Ù„Ø­Ø§Ù„Ø© || 'Ø¬Ø¯ÙŠØ¯';
                        let statusClass = 'status-new';
                        if (status.includes('progress') || status.includes('Ù…Ø¹Ø§Ù„Ø¬Ø©')) statusClass = 'status-progress';
                        else if (status.includes('escalat') || status.includes('Ù…ØµØ¹Ø¯')) statusClass = 'status-escalated';
                        else if (status.includes('closed') || status.includes('Ù…ØºÙ„Ù‚')) statusClass = 'status-closed';
                        
                        html += `<tr>
                            <td>${c.ID || c.Ø§Ù„Ø±Ù‚Ù… || '-'}</td>
                            <td>${c.Date || c.Ø§Ù„ØªØ§Ø±ÙŠØ® || '-'}</td>
                            <td>${c.Name || c.Ø§Ù„Ø§Ø³Ù… || '-'}</td>
                            <td>${c.Department || c.Ø§Ù„Ù‚Ø³Ù… || '-'}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>
                                <button class="btn btn-primary" style="padding:5px 10px; font-size:0.75rem;" onclick="viewComplaint('${c.ID || c.Ø§Ù„Ø±Ù‚Ù…}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-alerts">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰</div>';
                }
            }).catch(e => {
                console.error('Error loading complaints:', e);
                container.innerHTML = '<div class="no-alerts">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</div>';
            });
        }
        
        function loadIncidents() {
            const container = document.getElementById('incidentsContainer');
            container.innerHTML = '<div class="no-alerts"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            apiCall('getIncidents').then(data => {
                if (data.success && data.incidents && data.incidents.length > 0) {
                    let html = '<table class="data-table"><thead><tr>';
                    html += '<th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.incidents.forEach(i => {
                        const status = i.Status || i.Ø§Ù„Ø­Ø§Ù„Ø© || 'Ø¬Ø¯ÙŠØ¯';
                        let statusClass = 'status-new';
                        if (status.includes('investigation') || status.includes('ØªØ­Ù‚ÙŠÙ‚')) statusClass = 'status-progress';
                        else if (status.includes('escalat') || status.includes('Ù…ØµØ¹Ø¯')) statusClass = 'status-escalated';
                        else if (status.includes('closed') || status.includes('Ù…ØºÙ„Ù‚')) statusClass = 'status-closed';
                        
                        html += `<tr>
                            <td>${i.ID || i.Ø§Ù„Ø±Ù‚Ù… || '-'}</td>
                            <td>${i.Date || i.Ø§Ù„ØªØ§Ø±ÙŠØ® || '-'}</td>
                            <td>${i.Type || i.Ø§Ù„Ù†ÙˆØ¹ || '-'}</td>
                            <td>${i.Location || i.Ø§Ù„Ù…ÙˆÙ‚Ø¹ || '-'}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-alerts">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø«</div>';
                }
            }).catch(e => {
                console.error('Error loading incidents:', e);
                container.innerHTML = '<div class="no-alerts">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</div>';
            });
        }
        
        function loadRisks() {
            const container = document.getElementById('risksContainer');
            container.innerHTML = '<div class="no-alerts"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            apiCall('getRisks').then(data => {
                if (data.success && data.risks && data.risks.length > 0) {
                    let html = '<table class="data-table"><thead><tr>';
                    html += '<th>Ø§Ù„Ø®Ø·Ø±</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.risks.forEach(r => {
                        const level = r.Level || r.Ø§Ù„Ù…Ø³ØªÙˆÙ‰ || 'medium';
                        let levelClass = 'status-medium';
                        if (level.includes('high') || level.includes('Ø¹Ø§Ù„ÙŠ')) levelClass = 'status-high';
                        else if (level.includes('low') || level.includes('Ù…Ù†Ø®ÙØ¶')) levelClass = 'status-low';
                        
                        html += `<tr>
                            <td>${r.Description || r.Ø§Ù„ÙˆØµÙ || '-'}</td>
                            <td>${r.Department || r.Ø§Ù„Ù‚Ø³Ù… || '-'}</td>
                            <td><span class="status-badge ${levelClass}">${level}</span></td>
                            <td>${r.Status || r.Ø§Ù„Ø­Ø§Ù„Ø© || '-'}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-alerts">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ø·Ø± Ù…Ø³Ø¬Ù„Ø©</div>';
                }
            }).catch(e => {
                console.error('Error loading risks:', e);
                container.innerHTML = '<div class="no-alerts">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</div>';
            });
        }
        
        function loadRounds() {
            const container = document.getElementById('roundsContainer');
            container.innerHTML = '<div class="no-alerts"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            apiCall('getRounds').then(data => {
                if (data.success && data.rounds && data.rounds.length > 0) {
                    let html = '<table class="data-table"><thead><tr>';
                    html += '<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.rounds.forEach(r => {
                        const status = r.Status || r.Ø§Ù„Ø­Ø§Ù„Ø© || 'Ù…ÙƒØªÙ…Ù„';
                        let statusClass = status.includes('delayed') || status.includes('Ù…ØªØ£Ø®Ø±') ? 'status-escalated' : 'status-closed';
                        
                        html += `<tr>
                            <td>${r.Date || r.Ø§Ù„ØªØ§Ø±ÙŠØ® || '-'}</td>
                            <td>${r.Inspector || r.Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ || '-'}</td>
                            <td>${r.Department || r.Ø§Ù„Ù‚Ø³Ù… || '-'}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>${r.Notes || r.Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª || '-'}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-alerts">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬ÙˆÙ„Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
                }
            }).catch(e => {
                console.error('Error loading rounds:', e);
                container.innerHTML = '<div class="no-alerts">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</div>';
            });
        }
        
        function loadUsers() {
            const container = document.getElementById('usersContainer');
            container.innerHTML = '<div class="no-alerts"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            apiCall('getStaffList').then(data => {
                if (data.success && data.staff && data.staff.length > 0) {
                    let active = 0, suspended = 0;
                    data.staff.forEach(u => {
                        if (u.Status === 'suspended' || u.Status === 'Ù…Ø¹Ù„Ù‚') suspended++;
                        else active++;
                    });
                    
                    document.getElementById('usersActiveCount').textContent = active;
                    document.getElementById('usersSuspendedCount').textContent = suspended;
                    document.getElementById('usersTotalCount').textContent = data.staff.length;
                    
                    let html = '<table class="users-table"><thead><tr>';
                    html += '<th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.staff.forEach(u => {
                        const role = u.Role || u.Ø§Ù„Ø¯ÙˆØ± || 'staff';
                        let roleClass = 'role-staff';
                        let roleText = 'Ù…ÙˆØ¸Ù';
                        if (role === 'owner' || role === 'Ù…Ø§Ù„Ùƒ') { roleClass = 'role-owner'; roleText = 'Ù…Ø§Ù„Ùƒ'; }
                        else if (role === 'admin' || role === 'Ù…Ø¯ÙŠØ±') { roleClass = 'role-admin'; roleText = 'Ù…Ø¯ÙŠØ±'; }
                        
                        const status = u.Status || 'active';
                        const statusText = status === 'suspended' || status === 'Ù…Ø¹Ù„Ù‚' ? 'Ù…Ø¹Ù„Ù‚' : 'Ù†Ø´Ø·';
                        const statusColor = status === 'suspended' || status === 'Ù…Ø¹Ù„Ù‚' ? '#f59e0b' : '#10b981';
                        
                        html += `<tr>
                            <td>${u.Name || u.Ø§Ù„Ø§Ø³Ù… || '-'}</td>
                            <td>${u.Email || u.Ø§Ù„Ø¨Ø±ÙŠØ¯ || '-'}</td>
                            <td><span class="role-badge-small ${roleClass}">${roleText}</span></td>
                            <td style="color:${statusColor}; font-weight:600;">${statusText}</td>
                            <td class="action-btns">
                                <button onclick="toggleUserStatus('${u.Email || u.Ø§Ù„Ø¨Ø±ÙŠØ¯}')" style="background:#f59e0b; color:white;" title="${status === 'suspended' ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ù„ÙŠÙ‚'}">
                                    <i class="fas fa-${status === 'suspended' ? 'check' : 'pause'}"></i>
                                </button>
                                <button onclick="changeUserRole('${u.Email || u.Ø§Ù„Ø¨Ø±ÙŠØ¯}')" style="background:#3b82f6; color:white;" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±">
                                    <i class="fas fa-user-tag"></i>
                                </button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-alerts">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>';
                }
            }).catch(e => {
                console.error('Error loading users:', e);
                container.innerHTML = '<div class="no-alerts">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>';
            });
        }
        
        function loadPermissions() {
            const container = document.getElementById('permissionsContainer');
            container.innerHTML = '<div class="no-alerts">Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø§Ø³ØªØ®Ø¯Ù… ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±</div>';
        }
        
        function toggleUserStatus(email) {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                apiCall('toggleUserStatus', { email: email }).then(data => {
                    if (data.success) {
                        showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
                        loadUsers();
                    } else {
                        showToast('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', true);
                    }
                }).catch(e => showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true));
            }
        }
        
        function changeUserRole(email) {
            const newRole = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (owner, admin, staff):');
            if (newRole && ['owner', 'admin', 'staff'].includes(newRole.toLowerCase())) {
                apiCall('changeUserRole', { email: email, role: newRole.toLowerCase() }).then(data => {
                    if (data.success) {
                        showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
                        loadUsers();
                    } else {
                        showToast('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±', true);
                    }
                }).catch(e => showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true));
            }
        }
        
        function viewComplaint(id) {
            window.open('complaint_analysis.html?id=' + id, '_blank');
        }
        
        auth.onAuthStateChanged(async (user) => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const accessDenied = document.getElementById('accessDenied');
            
            if (user) {
                currentUser = user;
                
                try {
                    idToken = await user.getIdToken();
                    
                    if (user.email === OWNER_EMAIL) {
                        document.getElementById('ownerName').textContent = user.displayName || user.email.split('@')[0];
                        document.body.classList.add('authenticated');
                        loadingOverlay.style.display = 'none';
                        loadAllData();
                    } else {
                        const roleDoc = await db.collection('staff_roles').doc(user.uid).get();
                        if (roleDoc.exists && roleDoc.data().role === 'owner') {
                            document.getElementById('ownerName').textContent = user.displayName || roleDoc.data().name || user.email.split('@')[0];
                            document.body.classList.add('authenticated');
                            loadingOverlay.style.display = 'none';
                            loadAllData();
                        } else {
                            loadingOverlay.style.display = 'none';
                            accessDenied.style.display = 'flex';
                        }
                    }
                } catch (e) {
                    console.error('Auth error:', e);
                    loadingOverlay.style.display = 'none';
                    accessDenied.style.display = 'flex';
                }
            } else {
                window.location.href = 'admin-login.html?redirect=owner-dashboard.html';
            }
        });
    </script>
</body>
</html>
