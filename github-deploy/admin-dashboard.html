<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مركز القيادة - مجمع مكة الطبي</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-dark: #152a45;
            --gold: #c9a962;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --bg-light: #f8f9fa;
            --sidebar-width: 260px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            display: flex;
        }
        .sidebar, .main-content { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        body.authenticated .sidebar, body.authenticated .main-content { visibility: visible; opacity: 1; }
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 100;
            transition: transform 0.3s;
        }
        .sidebar-header {
            padding: 1.2rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            padding: 5px;
        }
        .sidebar-header h3 {
            color: white;
            margin-top: 0.6rem;
            font-size: 0.95rem;
        }
        .sidebar-header .role-badge {
            display: inline-block;
            background: var(--gold);
            color: var(--primary-dark);
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            margin-top: 0.4rem;
            font-weight: 700;
        }
        .nav-menu { padding: 0.8rem 0; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-right: 4px solid transparent;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-right-color: var(--gold);
        }
        .nav-item i { width: 22px; text-align: center; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 0.8rem 0; }
        .main-content {
            margin-right: var(--sidebar-width);
            flex: 1;
            padding: 1.2rem;
            min-height: 100vh;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.2rem;
        }
        .welcome-text h2 { color: var(--primary); font-size: 1.2rem; }
        .welcome-text p { color: #666; font-size: 0.85rem; }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }

        /* مؤشرات رئيسية */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.2rem;
        }
        .kpi-card {
            background: white;
            border-radius: 14px;
            padding: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            border: 1px solid rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--gold);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        .kpi-card:hover::before { opacity: 1; }
        .kpi-icon {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .kpi-icon.complaints { background: linear-gradient(135deg, #667eea, #764ba2); }
        .kpi-icon.incidents { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .kpi-icon.risks { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .kpi-icon.rounds { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .kpi-icon.calibration { background: linear-gradient(135deg, #fa709a, #fee140); }
        .kpi-icon.maintenance { background: linear-gradient(135deg, #667eea, #764ba2); }
        .kpi-icon.needlestick { background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333; }
        .kpi-info h3 { font-size: 1.6rem; color: var(--primary); line-height: 1; font-weight: 700; }
        .kpi-info p { font-size: 0.8rem; color: #555; margin-top: 4px; font-weight: 500; }
        .kpi-info .sub { font-size: 0.75rem; color: #999; display: block; margin-top: 2px; }
        .kpi-info .sub.danger { color: #DC143C !important; font-weight: 700; }

        /* قسم التنبيهات */
        .alerts-section {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid #eee;
        }
        .section-header h3 { font-size: 1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .alert-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .alert-item:last-child { margin-bottom: 0; }
        .alert-item.danger { background: #fff5f5; border-right: 4px solid var(--danger); }
        .alert-item.warning { background: #fffbeb; border-right: 4px solid var(--warning); }
        .alert-item.info { background: #f0f9ff; border-right: 4px solid var(--info); }
        .alert-item i { font-size: 1.1rem; }
        .alert-item.danger i { color: var(--danger); }
        .alert-item.warning i { color: var(--warning); }
        .alert-item.info i { color: var(--info); }
        .alert-item .alert-text { flex: 1; }
        .alert-item .alert-count { font-weight: 700; font-size: 1.1rem; }
        .no-alerts { text-align: center; padding: 1.5rem; color: #999; font-size: 0.9rem; }

        /* جدول الإحصائيات */
        .stats-grid-detailed {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.2rem;
        }
        .stats-box {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stats-box h4 {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }
        .stats-row:last-child { border-bottom: none; }
        .stats-row .label { color: #666; }
        .stats-row .value { font-weight: 700; color: var(--primary); }
        .stats-row .value.danger { color: var(--danger); }
        .stats-row .value.warning { color: var(--warning); }
        .stats-row .value.success { color: var(--success); }

        /* روابط سريعة */
        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
        }
        .quick-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            text-decoration: none;
            color: var(--primary);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 0.8rem;
            text-align: center;
        }
        .quick-link:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        .quick-link i { font-size: 1.5rem; }

        .content-section { display: none; }
        .content-section.active { display: block; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #eee;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }

        .users-section .user-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
        }
        .user-card:last-child { border-bottom: none; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }
        .user-details h4 { color: var(--primary); font-size: 0.9rem; }
        .user-details p { color: #666; font-size: 0.75rem; }
        select.role-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
        }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; }
            .menu-toggle { display: block !important; }
        }
        .menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .refresh-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .refresh-btn:hover { background: #f0f0f0; }
        .refresh-btn.loading i { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p>جاري تحميل مركز القيادة...</p>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo-transparent.png" alt="Logo" onerror="this.style.display='none'">
            <h3 id="staffName">الموظف</h3>
            <span class="role-badge" id="roleBadge">موظف</span>
        </div>
        <nav class="nav-menu">
            <a class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>مركز القيادة</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" href="complaint_mentoring.html" target="_blank">
                <i class="fas fa-comment-dots"></i>
                <span>نظام الشكاوى</span>
            </a>
            <a class="nav-item" href="incident-report-analysis.html" target="_blank">
                <i class="fas fa-exclamation-triangle"></i>
                <span>نظام الحوادث</span>
            </a>
            <a class="nav-item" href="risk-register.html" target="_blank">
                <i class="fas fa-shield-alt"></i>
                <span>سجل المخاطر</span>
            </a>
            <a class="nav-item" href="Round.html" target="_blank">
                <i class="fas fa-clipboard-check"></i>
                <span>نظام الجولات</span>
            </a>
            <a class="nav-item" href="calibration.html" target="_blank">
                <i class="fas fa-tools"></i>
                <span>معايرة الأجهزة</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" href="cbahi-portal.html" target="_blank">
                <i class="fas fa-award"></i>
                <span>بوابة سباهي</span>
            </a>
            <a class="nav-item admin-only" data-section="users">
                <i class="fas fa-users-cog"></i>
                <span>إدارة المستخدمين</span>
            </a>
            <a class="nav-item admin-only" data-section="requests">
                <i class="fas fa-user-clock"></i>
                <span>طلبات العضوية</span>
                <span class="badge-count" id="requestsBadge" style="display:none; background:#ef4444; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem; margin-right:auto;"></span>
            </a>
            <a class="nav-item admin-only" data-section="permissions">
                <i class="fas fa-user-shield"></i>
                <span>إدارة الصلاحيات</span>
            </a>
            <div class="nav-divider"></div>
            <a class="nav-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>تسجيل الخروج</span>
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="welcome-text">
                <h2>مركز القيادة والسيطرة</h2>
                <p id="dateDisplay"></p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="refresh-btn" id="refreshBtn" title="تحديث البيانات">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <a href="index.html" class="btn btn-outline">
                    <i class="fas fa-external-link-alt"></i>
                    الموقع
                </a>
            </div>
        </div>

        <section class="content-section active" id="section-dashboard">
            <!-- مؤشرات رئيسية -->
            <div class="kpi-grid">
                <a href="complaint_mentoring.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon complaints"><i class="fas fa-comment-dots"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-complaints-open">-</h3>
                        <p>شكوى مفتوحة</p>
                        <span class="sub" id="kpi-complaints-escalated"></span>
                    </div>
                </a>
                <a href="incident-report-analysis.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon incidents"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-incidents-open">-</h3>
                        <p>حادثة مفتوحة</p>
                        <span class="sub" id="kpi-incidents-escalated"></span>
                    </div>
                </a>
                <a href="risk-register.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon risks"><i class="fas fa-shield-alt"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-risks-active">-</h3>
                        <p>خطر نشط</p>
                        <span class="sub" id="kpi-risks-high"></span>
                    </div>
                </a>
                <a href="Round.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon rounds"><i class="fas fa-clipboard-check"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-rounds-today">-</h3>
                        <p>جولة اليوم</p>
                        <span class="sub" id="kpi-rounds-delayed"></span>
                    </div>
                </a>
                <a href="calibration.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon calibration"><i class="fas fa-cogs"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-calibration-compliance">-</h3>
                        <p>نسبة المعايرة</p>
                        <span class="sub" id="kpi-calibration-overdue"></span>
                    </div>
                </a>
                <a href="maintenance.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon maintenance"><i class="fas fa-wrench"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-maintenance-total">-</h3>
                        <p>صيانة الأجهزة</p>
                        <span class="sub" id="kpi-maintenance-completed" style="color:#28a745"></span>
                        <span class="sub" id="kpi-maintenance-overdue"></span>
                    </div>
                </a>
                <a href="pages/needleـstickـanalysis.html" target="_blank" class="kpi-card">
                    <div class="kpi-icon needlestick"><i class="fas fa-syringe"></i></div>
                    <div class="kpi-info">
                        <h3 id="kpi-needlestick">-</h3>
                        <p>حالة وخز إبري</p>
                        <span class="sub" id="kpi-needlestick-month"></span>
                    </div>
                </a>
            </div>

            <!-- قسم التنبيهات العاجلة -->
            <div class="alerts-section">
                <div class="section-header">
                    <h3><i class="fas fa-bell"></i> التنبيهات والتصعيدات</h3>
                </div>
                <div id="alertsContainer">
                    <div class="no-alerts">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                        <p>جاري تحميل التنبيهات...</p>
                    </div>
                </div>
            </div>

            <!-- إحصائيات تفصيلية -->
            <div class="stats-grid-detailed">
                <div class="stats-box">
                    <h4><i class="fas fa-comment-dots"></i> الشكاوى</h4>
                    <div class="stats-row">
                        <span class="label">جديدة</span>
                        <span class="value" id="stat-complaints-new">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">قيد المعالجة</span>
                        <span class="value warning" id="stat-complaints-progress">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مصعّدة</span>
                        <span class="value danger" id="stat-complaints-escalated">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مغلقة</span>
                        <span class="value success" id="stat-complaints-closed">-</span>
                    </div>
                </div>
                <div class="stats-box">
                    <h4><i class="fas fa-exclamation-triangle"></i> الحوادث</h4>
                    <div class="stats-row">
                        <span class="label">جديدة</span>
                        <span class="value" id="stat-incidents-new">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">قيد التحقيق</span>
                        <span class="value warning" id="stat-incidents-progress">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مصعّدة</span>
                        <span class="value danger" id="stat-incidents-escalated">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مغلقة</span>
                        <span class="value success" id="stat-incidents-closed">-</span>
                    </div>
                </div>
                <div class="stats-box">
                    <h4><i class="fas fa-shield-alt"></i> سجل المخاطر</h4>
                    <div class="stats-row">
                        <span class="label">خطر عالي</span>
                        <span class="value danger" id="stat-risks-high">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">خطر متوسط</span>
                        <span class="value warning" id="stat-risks-medium">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">خطر منخفض</span>
                        <span class="value" id="stat-risks-low">-</span>
                    </div>
                    <div class="stats-row">
                        <span class="label">مُعالجة</span>
                        <span class="value success" id="stat-risks-resolved">-</span>
                    </div>
                </div>
            </div>

            <!-- روابط سريعة -->
            <div class="stats-box">
                <h4><i class="fas fa-rocket"></i> الوصول السريع</h4>
                <div class="quick-links-grid">
                    <a href="report.html" class="quick-link" target="_blank">
                        <i class="fas fa-plus-circle"></i>
                        <span>رفع شكوى</span>
                    </a>
                    <a href="incident-report.html" class="quick-link" target="_blank">
                        <i class="fas fa-file-medical"></i>
                        <span>بلاغ حادثة</span>
                    </a>
                    <a href="risk-register.html?action=new" class="quick-link" target="_blank">
                        <i class="fas fa-shield-virus"></i>
                        <span>تسجيل خطر</span>
                    </a>
                    <a href="ipc/incidents/report-needlestick.html" class="quick-link" target="_blank">
                        <i class="fas fa-syringe"></i>
                        <span>بلاغ وخز</span>
                    </a>
                    <a href="mega.html" class="quick-link" target="_blank">
                        <i class="fas fa-th-large"></i>
                        <span>المركز الرقمي</span>
                    </a>
                    <a href="cbahi-portal.html" class="quick-link" target="_blank">
                        <i class="fas fa-award"></i>
                        <span>بوابة سباهي</span>
                    </a>
                </div>
            </div>
        </section>

        <section class="content-section" id="section-users">
            <div class="stats-box users-section">
                <h4><i class="fas fa-users-cog"></i> إدارة المستخدمين</h4>
                <div id="usersContainer">
                    <div class="no-alerts">جاري التحميل...</div>
                </div>
            </div>
        </section>

        <section class="content-section" id="section-requests">
            <div class="stats-box">
                <h4><i class="fas fa-user-clock"></i> طلبات العضوية الإدارية</h4>
                <div id="requestsContainer">
                    <div class="no-alerts">جاري التحميل...</div>
                </div>
            </div>
        </section>

        <section class="content-section" id="section-permissions">
            <div class="stats-box">
                <h4><i class="fas fa-user-shield"></i> إدارة الصلاحيات - تحكم كامل</h4>
                <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">تعيين اللجان والأنظمة المسموحة لكل موظف</p>
                
                <div id="permissionsStats" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; padding:15px; background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius:12px;">
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #10b981;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#10b981;" id="statsActive">0</div>
                        <div style="font-size:0.8rem; color:#666;">فعال</div>
                    </div>
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid #f59e0b;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#f59e0b;" id="statsSuspended">0</div>
                        <div style="font-size:0.8rem; color:#666;">معلق</div>
                    </div>
                    <div style="flex:1; min-width:100px; text-align:center; padding:10px; background:#fff; border-radius:8px; border-right:3px solid:#1e3a5f;">
                        <div style="font-size:1.5rem; font-weight:bold; color:#1e3a5f;" id="statsTotal">0</div>
                        <div style="font-size:0.8rem; color:#666;">الإجمالي</div>
                    </div>
                </div>
                
                <div id="permissionsContainer">
                    <div class="no-alerts">جاري التحميل...</div>
                </div>
            </div>
        </section>
    </main>
    
    <div id="toastNotification" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:15px 30px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.2); display:none; z-index:9999; font-weight:600;">
        <i class="fas fa-check-circle" style="margin-left:8px;"></i>
        <span id="toastMessage">تم الحفظ بنجاح</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",
            authDomain: "insurance-check-6cec9.firebaseapp.com",
            projectId: "insurance-check-6cec9",
            storageBucket: "insurance-check-6cec9.appspot.com",
            messagingSenderId: "992769471393",
            appId: "1:992769471393:web:c8a9400210a0e7901011e0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        let currentUserRole = null;

        // API URLs
        const APIs = {
            complaints: "https://script.google.com/macros/s/AKfycbyE0nbyfYrDZeOHr6TuEQP7ivpOLF1pLmBFoF7fkDmNjQp5g6dW4i0xkcSBJJRaoOCVAw/exec",
            incidents: "https://script.google.com/macros/s/AKfycbxHW20iOESJdvDuGBjKBVGZ7ZVlNy-PfRY8tJvmsIvtdcSxhbiBYL0CXLVwCjIJz-y8/exec",
            risks: "https://script.google.com/macros/s/AKfycbyDLVS-KI6_EEVE68f9O9ubgUhZtA9LBVofWJ4l6cEDnYTuDvvyQf4cEwQxDFC532Pf/exec",
            rounds: "https://script.google.com/macros/s/AKfycbwjoTetIgrjnESeW3gJlezUbm4ReK3nF1nS5xbs1oItrHMsfTlMfkWCfn45S9sSjf3y/exec",
            needlestick: "https://script.google.com/macros/s/AKfycbyWPna2RXgl_P8xYfnIxG634pS8fVoAtW6X8Ch8-fzM0ASZNz49OIORmYwxjbiVapHEyg/exec",
            calibration: "https://script.google.com/macros/s/AKfycbxhKSq0qMIT85_pUfiba5V5Pi-kO_Df4Qw98MRIM4fmCb-XcheI8uGQccFxuKjigATHlQ/exec",
            maintenance: "https://script.google.com/macros/s/AKfycbxw6oWSHKDjeZI6dsspS3PVVwbO9KO5UnjKGqDa_yP9cYAVjNHh6WMfQrdlpkF_A25--A/exec"
        };
        
        // دالة حساب إحصائيات المعايرة (نفس منطق calibration.html)
        function calculateCalibrationStats(data) {
            if (!data || data.status !== 'success' || !data.data) {
                return { compliance: 0, overdue: 0, pass: 0, fail: 0, total: 0, upcoming: 0 };
            }
            
            const assetsMap = data.data.assetsMap || {};
            const records = data.data.records || [];
            
            // حساب إجمالي المهام من قائمة الأجهزة
            let totalTasks = 0;
            Object.values(assetsMap).forEach(arr => totalTasks += arr.length);
            
            // حساب المطابق والمتأخر
            let pass = 0, fail = 0, overdue = 0, upcoming = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // حد الـ 30 يوم للقادم
            const upcomingThreshold = new Date(today);
            upcomingThreshold.setDate(upcomingThreshold.getDate() + 30);
            
            // تجميع أحدث سجل لكل جهاز (الحقول بحروف كبيرة من الـ API)
            const latestRecords = {};
            records.forEach(r => {
                const assetID = r.AssetID || r.assetID || r.asset_id;
                const recordDate = r.TestDate || r.Timestamp || r.date;
                if (!assetID) return;
                if (!latestRecords[assetID] || new Date(recordDate) > new Date(latestRecords[assetID].recordDate)) {
                    latestRecords[assetID] = { ...r, recordDate };
                }
            });
            
            Object.values(latestRecords).forEach(r => {
                // حساب Pass/Fail (Result بحرف كبير)
                const result = r.Result || r.result;
                if (result === 'Pass') pass++;
                else if (result === 'Fail') fail++;
                
                // حساب Overdue و Upcoming (NextDue بحرف كبير)
                const nd = r.NextDue || r.nextDue || r.next_due;
                if (nd) {
                    const nextDue = new Date(nd);
                    if (nextDue < today) {
                        overdue++;
                    } else if (nextDue <= upcomingThreshold) {
                        upcoming++;
                    }
                }
            });
            
            // حساب نسبة الامتثال = (المطابق / إجمالي المهام) * 100
            const compliance = totalTasks > 0 ? Math.round((pass / totalTasks) * 100) : 0;
            
            console.log(`Calibration: Pass=${pass}, Fail=${fail}, Overdue=${overdue}, Total=${totalTasks}, Compliance=${compliance}%`);
            
            return { compliance, overdue, pass, fail, total: totalTasks, upcoming };
        }

        // التاريخ الهجري
        const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        }).format(new Date());
        document.getElementById('dateDisplay').textContent = hijriDate;

        async function getUserRole(uid) {
            try {
                const docRef = doc(db, "staff_roles", uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) return docSnap.data().role;
                const reqRef = doc(db, "role_requests", uid);
                const reqSnap = await getDoc(reqRef);
                if (reqSnap.exists() && ['doctor', 'pharmacist'].includes(reqSnap.data().role)) return 'viewer';
                return null;
            } catch (e) {
                console.error('Role check error:', e);
                return null;
            }
        }

        async function apiCall(url, action, payload = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, payload }),
                    redirect: 'follow'
                });
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('Parse error:', text.substring(0, 200));
                    return { ok: false, error: 'Invalid response' };
                }
            } catch (e) {
                console.error(`API Error (${action}):`, e);
                return { ok: false, error: e.message };
            }
        }

        async function fetchJsonp(url) {
            const r = await fetch(url, { redirect: 'follow' });
            const text = await r.text();
            const m = text.match(/^[a-zA-Z_$][\w$]*\s*\((.*)\)\s*;?\s*$/s);
            if (m && m[1]) return JSON.parse(m[1]);
            return JSON.parse(text);
        }

        async function loadDashboardData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            
            console.log('Loading dashboard data...');

            try {
                const [complaintsRes, incidentsRes, risksRes, roundsRes, needlestickRes, calibrationRes, maintenanceRes] = await Promise.all([
                    apiCall(APIs.complaints, 'getComplaintStats', {}),
                    apiCall(APIs.incidents, 'getIncidentStats', {}),
                    fetch(APIs.risks + '?action=metrics').then(r => r.json()).catch(e => { console.error('Risks error:', e); return { success: false }; }),
                    apiCall(APIs.rounds, 'getMetrics', {}),
                    fetchJsonp(APIs.needlestick + '?action=data').catch(e => { console.error('Needlestick error:', e); return { success: false }; }),
                    fetch(APIs.calibration).then(r => r.json()).catch(e => { console.error('Calibration error:', e); return { status: 'error' }; }),
                    apiCall(APIs.maintenance, 'getKPIs', {})
                ]);

                console.log('Complaints:', complaintsRes);
                console.log('Incidents:', incidentsRes);
                console.log('Risks:', risksRes);
                console.log('Rounds:', roundsRes);
                console.log('Calibration:', calibrationRes);
                console.log('Maintenance:', maintenanceRes);

                // الشكاوى - البيانات ترجع مباشرة وليس في stats
                if (complaintsRes.ok) {
                    const s = complaintsRes;
                    const openComplaints = (s.new || 0) + (s.in_progress || 0);
                    document.getElementById('kpi-complaints-open').textContent = openComplaints;
                    const escEl = document.getElementById('kpi-complaints-escalated');
                    if (s.escalated > 0) {
                        escEl.textContent = `${s.escalated} مصعّدة`;
                        escEl.classList.add('danger');
                    } else {
                        escEl.textContent = '';
                        escEl.classList.remove('danger');
                    }
                    document.getElementById('stat-complaints-new').textContent = s.new || 0;
                    document.getElementById('stat-complaints-progress').textContent = s.in_progress || 0;
                    document.getElementById('stat-complaints-escalated').textContent = s.escalated || 0;
                    document.getElementById('stat-complaints-closed').textContent = s.closed || 0;
                } else {
                    console.warn('Complaints API failed:', complaintsRes);
                }

                // الحوادث - البيانات ترجع مباشرة مع byStatus للتصعيدات
                if (incidentsRes.ok) {
                    const s = incidentsRes;
                    const openIncidents = s.open || ((s.new || 0) + (s.in_progress || 0) + (s.under_review || 0));
                    const escalatedCount = s.byStatus?.escalated?.count || s.escalated || 0;
                    
                    document.getElementById('kpi-incidents-open').textContent = openIncidents;
                    const incEscEl = document.getElementById('kpi-incidents-escalated');
                    if (escalatedCount > 0) {
                        incEscEl.textContent = `${escalatedCount} مصعّدة`;
                        incEscEl.classList.add('danger');
                    } else {
                        incEscEl.textContent = '';
                        incEscEl.classList.remove('danger');
                    }
                    document.getElementById('stat-incidents-new').textContent = s.new || s.open || 0;
                    document.getElementById('stat-incidents-progress').textContent = s.in_progress || 0;
                    document.getElementById('stat-incidents-escalated').textContent = escalatedCount;
                    document.getElementById('stat-incidents-closed').textContent = s.closed || 0;
                } else {
                    console.warn('Incidents API failed:', incidentsRes);
                }

                // سجل المخاطر - يستخدم ok وليس success
                if (risksRes.ok) {
                    const r = risksRes;
                    // ext = خارجي، total = الإجمالي، high/med/low = المستويات
                    const activeRisks = r.total || (r.high || 0) + (r.med || 0) + (r.low || 0);
                    document.getElementById('kpi-risks-active').textContent = activeRisks;
                    document.getElementById('kpi-risks-high').textContent = r.high ? `${r.high} عالي` : (r.ext ? `${r.ext} خارجي` : '');
                    document.getElementById('stat-risks-high').textContent = r.high || 0;
                    document.getElementById('stat-risks-medium').textContent = r.med || r.medium || 0;
                    document.getElementById('stat-risks-low').textContent = r.low || 0;
                    document.getElementById('stat-risks-resolved').textContent = r.resolved || r.closed || 0;
                } else {
                    console.warn('Risks API failed:', risksRes);
                }

                // الجولات - البيانات ترجع مباشرة
                if (roundsRes.ok) {
                    const rd = roundsRes;
                    // عرض المكتملة في البطاقة الرئيسية
                    document.getElementById('kpi-rounds-today').textContent = rd.completed || 0;
                    // عرض المتأخرة بوضوح
                    if (rd.delayed > 0) {
                        document.getElementById('kpi-rounds-delayed').textContent = `${rd.delayed} متأخرة`;
                        document.getElementById('kpi-rounds-delayed').style.color = '#DC143C';
                    } else if (rd.violations > 0) {
                        document.getElementById('kpi-rounds-delayed').textContent = `${rd.violations} مخالفة`;
                        document.getElementById('kpi-rounds-delayed').style.color = '#f0ad4e';
                    } else {
                        document.getElementById('kpi-rounds-delayed').textContent = '';
                    }
                } else {
                    console.warn('Rounds API failed:', roundsRes);
                }

                // الوخز الإبري - البيانات ترجع كـ array في rows أو data
                console.log('Needlestick:', needlestickRes);
                const needleData = needlestickRes.rows || needlestickRes.data;
                if ((needlestickRes.success || needlestickRes.status === 'success') && Array.isArray(needleData)) {
                    const records = needleData;
                    const total = records.length;
                    const now = new Date();
                    const thisMonth = records.filter(r => {
                        const d = new Date(r.date || r.timestamp);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    }).length;
                    document.getElementById('kpi-needlestick').textContent = total;
                    document.getElementById('kpi-needlestick-month').textContent = thisMonth > 0 ? `${thisMonth} هذا الشهر` : '';
                } else if (needlestickRes.total !== undefined) {
                    document.getElementById('kpi-needlestick').textContent = needlestickRes.total || 0;
                    document.getElementById('kpi-needlestick-month').textContent = needlestickRes.thisMonth ? `${needlestickRes.thisMonth} هذا الشهر` : '';
                } else {
                    document.getElementById('kpi-needlestick').textContent = '-';
                    console.warn('Needlestick API failed:', needlestickRes);
                }

                // المعايرة/الصيانة - حساب الإحصائيات من البيانات
                const calStats = calculateCalibrationStats(calibrationRes);
                console.log('Calibration Stats:', calStats);
                
                if (calStats.total > 0) {
                    // نسبة الامتثال كرقم رئيسي مع علامة %
                    const compEl = document.getElementById('kpi-calibration-compliance');
                    compEl.textContent = calStats.compliance + '%';
                    
                    // تلوين النسبة حسب القيمة
                    if (calStats.compliance >= 80) {
                        compEl.style.color = '#28a745'; // أخضر
                    } else if (calStats.compliance >= 70) {
                        compEl.style.color = '#ff9800'; // برتقالي
                    } else {
                        compEl.style.color = '#DC143C'; // أحمر
                    }
                    
                    // التفاصيل: عدد المتأخرات بالأحمر
                    const overdueEl = document.getElementById('kpi-calibration-overdue');
                    if (calStats.overdue > 0) {
                        overdueEl.textContent = `${calStats.overdue} جهاز متأخر`;
                        overdueEl.classList.add('danger');
                    } else {
                        overdueEl.textContent = `${calStats.total} جهاز مُصان`;
                        overdueEl.classList.remove('danger');
                        overdueEl.style.color = '#28a745';
                    }
                } else {
                    document.getElementById('kpi-calibration-compliance').textContent = '--';
                    document.getElementById('kpi-calibration-overdue').textContent = 'لا توجد بيانات';
                }

                // الصيانة - عرض إحصائيات الصيانة
                console.log('Processing Maintenance:', maintenanceRes);
                if (maintenanceRes && (maintenanceRes.success || maintenanceRes.ok || maintenanceRes.totalDevices !== undefined || maintenanceRes.total !== undefined)) {
                    const m = maintenanceRes.data || maintenanceRes;
                    const totalDevices = m.totalDevices || m.total || 0;
                    const servicedDevices = m.servicedDevices || m.completed || m.done || 0;
                    const overdueDevices = m.overdueDevices || m.overdue || 0;
                    
                    document.getElementById('kpi-maintenance-total').textContent = totalDevices;
                    
                    const completedEl = document.getElementById('kpi-maintenance-completed');
                    const overdueEl = document.getElementById('kpi-maintenance-overdue');
                    
                    completedEl.textContent = `مصان ${servicedDevices}`;
                    completedEl.style.color = '#28a745';
                    
                    if (overdueDevices > 0) {
                        overdueEl.textContent = `متأخر ${overdueDevices}`;
                        overdueEl.style.color = '#DC143C';
                        overdueEl.classList.add('danger');
                    } else {
                        overdueEl.textContent = '';
                        overdueEl.classList.remove('danger');
                    }
                } else {
                    document.getElementById('kpi-maintenance-total').textContent = '--';
                    document.getElementById('kpi-maintenance-completed').textContent = '';
                    document.getElementById('kpi-maintenance-overdue').textContent = 'لا توجد بيانات';
                }

                // تحديث التنبيهات - إرسال كل البيانات
                updateAlerts(complaintsRes, incidentsRes, risksRes, roundsRes, calStats);

            } catch (e) {
                console.error('Dashboard load error:', e);
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        function updateAlerts(complaints, incidents, risks, rounds, calibration) {
            const container = document.getElementById('alertsContainer');
            const alerts = [];

            // تنبيهات الشكاوى المصعّدة
            if (complaints.ok && complaints.escalated > 0) {
                alerts.push({
                    type: 'danger',
                    icon: 'fa-comment-dots',
                    text: 'شكاوى مصعّدة تحتاج اهتمام فوري',
                    count: complaints.escalated,
                    link: 'complaint_mentoring.html'
                });
            }

            // تنبيهات الحوادث المصعّدة - قراءة من byStatus.escalated.count
            const incidentEscalated = incidents.byStatus?.escalated?.count || incidents.escalated || 0;
            if (incidents.ok && incidentEscalated > 0) {
                alerts.push({
                    type: 'danger',
                    icon: 'fa-exclamation-triangle',
                    text: 'حوادث مصعّدة تحتاج متابعة',
                    count: incidentEscalated,
                    link: 'incident-report-analysis.html'
                });
            }

            // تنبيهات المخاطر العالية
            const risksHigh = risks.high || risks.data?.high || 0;
            if (risksHigh > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fa-shield-alt',
                    text: 'مخاطر عالية في السجل',
                    count: risksHigh,
                    link: 'risk-register.html'
                });
            }

            // تنبيهات الجولات المتأخرة
            if (rounds && rounds.ok && rounds.delayed > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fa-clipboard-check',
                    text: 'جولات متأخرة تحتاج متابعة',
                    count: rounds.delayed,
                    link: 'Round.html'
                });
            }

            // تنبيهات المعايرة المتأخرة
            if (calibration && calibration.overdue > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fa-tools',
                    text: 'أجهزة تجاوزت موعد المعايرة',
                    count: calibration.overdue,
                    link: 'calibration.html'
                });
            }

            // شكاوى جديدة
            if (complaints.ok && complaints.new > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'fa-inbox',
                    text: 'شكاوى جديدة بانتظار المعالجة',
                    count: complaints.new,
                    link: 'complaint_mentoring.html'
                });
            }

            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="no-alerts">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 10px; display: block;"></i>
                        <p>لا توجد تنبيهات عاجلة - كل شيء تحت السيطرة</p>
                    </div>
                `;
            } else {
                container.innerHTML = alerts.map(a => `
                    <a href="${a.link}" target="_blank" class="alert-item ${a.type}" style="text-decoration: none;">
                        <i class="fas ${a.icon}"></i>
                        <span class="alert-text">${a.text}</span>
                        <span class="alert-count">${a.count}</span>
                    </a>
                `).join('');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user || !user.emailVerified) {
                window.location.href = 'admin-login.html';
                return;
            }

            const role = await getUserRole(user.uid);
            
            if (!role || !['admin', 'staff', 'viewer'].includes(role)) {
                await signOut(auth);
                window.location.href = 'admin-login.html';
                return;
            }

            currentUserRole = role;
            
            const roleLabels = { admin: 'مدير النظام', staff: 'موظف جودة', viewer: 'مشاهد' };
            
            document.getElementById('staffName').textContent = user.email.split('@')[0];
            document.getElementById('roleBadge').textContent = roleLabels[role];
            
            if (role === 'admin') document.body.classList.add('is-admin');

            document.body.classList.add('authenticated');
            loadingOverlay.classList.add('hidden');
            loadDashboardData();
            
            // التحديث التلقائي كل 3 دقائق (180000 ملي ثانية)
            setInterval(() => {
                console.log('تحديث تلقائي للبيانات...');
                loadDashboardData();
            }, 180000);
        });

        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.getElementById('section-' + section).classList.add('active');
                if (window.innerWidth < 992) document.getElementById('sidebar').classList.remove('open');
            });
        });

        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });

        document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            localStorage.clear();
            window.location.href = 'admin-login.html';
        });

        async function loadUsers() {
            if (currentUserRole !== 'admin') return;
            const container = document.getElementById('usersContainer');
            
            try {
                const rolesSnap = await getDocs(collection(db, "staff_roles"));
                const requestsSnap = await getDocs(collection(db, "role_requests"));
                
                const users = [];
                rolesSnap.forEach(doc => users.push({ uid: doc.id, ...doc.data(), source: 'staff_roles' }));
                requestsSnap.forEach(doc => {
                    if (!users.find(u => u.uid === doc.id)) {
                        users.push({ uid: doc.id, role: doc.data().role, email: doc.data().email || 'غير معروف', source: 'role_requests' });
                    }
                });
                
                if (users.length === 0) {
                    container.innerHTML = `<div class="no-alerts"><p>لا يوجد مستخدمين</p></div>`;
                    return;
                }
                
                container.innerHTML = users.map(u => `
                    <div class="user-card">
                        <div class="user-info">
                            <div class="user-avatar">${(u.email || u.uid).charAt(0).toUpperCase()}</div>
                            <div class="user-details">
                                <h4>${u.email || u.uid}</h4>
                                <p>${u.source === 'role_requests' ? 'طلب جديد' : 'مسجل'}</p>
                            </div>
                        </div>
                        <select class="role-select" data-uid="${u.uid}">
                            <option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>مشاهد</option>
                            <option value="staff" ${u.role === 'staff' ? 'selected' : ''}>موظف جودة</option>
                            <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>مدير</option>
                        </select>
                    </div>
                `).join('');
                
                container.querySelectorAll('.role-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const uid = e.target.dataset.uid;
                        try {
                            await setDoc(doc(db, "staff_roles", uid), {
                                role: e.target.value,
                                updatedAt: new Date().toISOString(),
                                updatedBy: auth.currentUser.email
                            }, { merge: true });
                            alert('تم تحديث الصلاحية');
                        } catch (err) {
                            alert('فشل التحديث');
                        }
                    });
                });
            } catch (e) {
                container.innerHTML = `<div class="no-alerts"><p>تعذر تحميل المستخدمين</p></div>`;
            }
        }

        document.querySelector('[data-section="users"]')?.addEventListener('click', loadUsers);

        // ===== طلبات العضوية =====
        async function loadMembershipRequests() {
            if (currentUserRole !== 'admin') return;
            const container = document.getElementById('requestsContainer');
            
            try {
                const requestsSnap = await getDocs(collection(db, "membershipRequests"));
                const requests = [];
                requestsSnap.forEach(doc => requests.push({ id: doc.id, ...doc.data() }));
                
                // ترتيب: المعلقة أولاً، ثم الأحدث
                requests.sort((a, b) => {
                    if (a.status === 'pending' && b.status !== 'pending') return -1;
                    if (a.status !== 'pending' && b.status === 'pending') return 1;
                    return (b.requestedAt?.toDate?.() || 0) - (a.requestedAt?.toDate?.() || 0);
                });
                
                // تحديث العداد
                const pendingCount = requests.filter(r => r.status === 'pending').length;
                const badge = document.getElementById('requestsBadge');
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
                
                if (requests.length === 0) {
                    container.innerHTML = `<div class="no-alerts"><p>لا توجد طلبات عضوية</p></div>`;
                    return;
                }
                
                container.innerHTML = requests.map(r => {
                    const statusColors = { pending: '#f59e0b', approved: '#10b981', rejected: '#ef4444' };
                    const statusLabels = { pending: 'قيد المراجعة', approved: 'مقبول', rejected: 'مرفوض' };
                    const date = r.requestedAt?.toDate?.() ? r.requestedAt.toDate().toLocaleDateString('ar-SA') : '-';
                    
                    return `
                        <div class="request-card" style="background:#fff; border-radius:12px; padding:20px; margin-bottom:15px; border-right:4px solid ${statusColors[r.status]}; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:15px;">
                                <div style="flex:1; min-width:200px;">
                                    <h4 style="color:var(--primary); margin-bottom:8px; font-size:1.1rem;">
                                        <i class="fas fa-user" style="margin-left:8px; color:var(--gold);"></i>
                                        ${r.fullName || 'غير محدد'}
                                    </h4>
                                    <p style="margin:5px 0; color:#666; font-size:0.9rem;">
                                        <i class="fas fa-envelope" style="margin-left:5px; width:16px;"></i> ${r.email}
                                    </p>
                                    <p style="margin:5px 0; color:#666; font-size:0.9rem;">
                                        <i class="fas fa-phone" style="margin-left:5px; width:16px;"></i> ${r.phone || '-'}
                                    </p>
                                    <p style="margin:5px 0; color:#666; font-size:0.9rem;">
                                        <i class="fas fa-building" style="margin-left:5px; width:16px;"></i> ${r.department} - ${r.jobTitle}
                                    </p>
                                    ${r.reason ? `<p style="margin:10px 0 5px; color:#555; font-size:0.85rem; background:#f8f9fa; padding:8px; border-radius:6px;"><strong>السبب:</strong> ${r.reason}</p>` : ''}
                                </div>
                                <div style="text-align:center;">
                                    <span style="display:inline-block; padding:5px 15px; border-radius:20px; font-size:0.8rem; font-weight:600; background:${statusColors[r.status]}20; color:${statusColors[r.status]};">
                                        ${statusLabels[r.status]}
                                    </span>
                                    <p style="color:#999; font-size:0.75rem; margin-top:8px;">
                                        <i class="fas fa-calendar"></i> ${date}
                                    </p>
                                </div>
                            </div>
                            ${r.status === 'pending' ? `
                                <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; display:flex; gap:10px; flex-wrap:wrap;">
                                    <button onclick="approveRequest('${r.id}', '${r.uid}', '${r.email}')" style="flex:1; min-width:120px; padding:10px 20px; background:#10b981; color:white; border:none; border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600;">
                                        <i class="fas fa-check"></i> قبول
                                    </button>
                                    <button onclick="rejectRequest('${r.id}')" style="flex:1; min-width:120px; padding:10px 20px; background:#ef4444; color:white; border:none; border-radius:8px; cursor:pointer; font-family:inherit; font-weight:600;">
                                        <i class="fas fa-times"></i> رفض
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Error loading requests:', e);
                container.innerHTML = `<div class="no-alerts"><p>تعذر تحميل الطلبات</p></div>`;
            }
        }
        
        // دوال الموافقة والرفض
        window.approveRequest = async function(requestId, uid, email) {
            if (!confirm(`هل تريد قبول طلب ${email}؟`)) return;
            
            try {
                // تحديث حالة الطلب
                await updateDoc(doc(db, "membershipRequests", requestId), {
                    status: 'approved',
                    reviewedAt: new Date(),
                    reviewedBy: auth.currentUser.email
                });
                
                // إضافة صلاحية للمستخدم
                await setDoc(doc(db, "staff_roles", uid), {
                    role: 'staff',
                    email: email,
                    approvedAt: new Date().toISOString(),
                    approvedBy: auth.currentUser.email
                });
                
                alert('تم قبول الطلب بنجاح! يمكن للمستخدم الآن الدخول.');
                loadMembershipRequests();
            } catch (e) {
                console.error('Error approving:', e);
                alert('حدث خطأ أثناء القبول');
            }
        };
        
        window.rejectRequest = async function(requestId) {
            const reason = prompt('سبب الرفض (اختياري):');
            if (reason === null) return; // ألغى المستخدم
            
            try {
                await updateDoc(doc(db, "membershipRequests", requestId), {
                    status: 'rejected',
                    reviewedAt: new Date(),
                    reviewedBy: auth.currentUser.email,
                    rejectionReason: reason || ''
                });
                
                alert('تم رفض الطلب');
                loadMembershipRequests();
            } catch (e) {
                console.error('Error rejecting:', e);
                alert('حدث خطأ أثناء الرفض');
            }
        };

        document.querySelector('[data-section="requests"]')?.addEventListener('click', loadMembershipRequests);
        
        // تحميل عدد الطلبات المعلقة عند فتح الصفحة
        setTimeout(async () => {
            if (currentUserRole === 'admin') {
                try {
                    const snap = await getDocs(collection(db, "membershipRequests"));
                    const pending = [];
                    snap.forEach(d => { if (d.data().status === 'pending') pending.push(d); });
                    const badge = document.getElementById('requestsBadge');
                    if (pending.length > 0) {
                        badge.textContent = pending.length;
                        badge.style.display = 'inline';
                    }
                } catch(e) {}
            }
        }, 2000);

        // ===== إدارة الصلاحيات الكاملة =====
        function showToast(message, isError = false) {
            const toast = document.getElementById('toastNotification');
            const toastMsg = document.getElementById('toastMessage');
            toastMsg.textContent = message;
            toast.style.background = isError ? '#ef4444' : '#10b981';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }
        
        const COMMITTEES = [
            { id: 'RM', name: 'لجنة إدارة المخاطر' },
            { id: 'FMS', name: 'لجنة السلامة والمرافق' },
            { id: 'PSC', name: 'لجنة سلامة المرضى' },
            { id: 'IPC', name: 'لجنة مكافحة العدوى' },
            { id: 'QI', name: 'لجنة الجودة والتحسين' },
            { id: 'EOC', name: 'لجنة الطوارئ والكوارث' },
            { id: 'OTHER', name: 'أخرى' }
        ];
        
        const SYSTEMS = [
            { id: 'complaints', name: 'نظام الشكاوى', icon: 'comment-dots' },
            { id: 'incidents', name: 'نظام الحوادث', icon: 'exclamation-triangle' },
            { id: 'risks', name: 'سجل المخاطر', icon: 'shield-alt' },
            { id: 'rounds', name: 'نظام الجولات', icon: 'clipboard-check' },
            { id: 'calibration', name: 'المعايرة', icon: 'tools' },
            { id: 'maintenance', name: 'الصيانة', icon: 'wrench' },
            { id: 'needlestick', name: 'التعرض الوخزي', icon: 'syringe' },
            { id: 'cbahi', name: 'بوابة سباهي', icon: 'award' },
            { id: 'dashboard', name: 'لوحة التحكم', icon: 'tachometer-alt' }
        ];
        
        const ROLES = [
            { id: 'admin', name: 'مدير عام', color: '#dc3545' },
            { id: 'chair', name: 'رئيس لجنة', color: '#c9a962' },
            { id: 'member', name: 'عضو', color: '#17a2b8' },
            { id: 'viewer', name: 'مشاهد فقط', color: '#6c757d' }
        ];
        
        async function loadPermissions() {
            if (currentUserRole !== 'admin') return;
            const container = document.getElementById('permissionsContainer');
            
            // إظهار حالة التحميل
            container.innerHTML = `<div style="text-align:center; padding:40px;"><i class="fas fa-spinner fa-spin fa-2x" style="color:var(--gold);"></i><p style="margin-top:15px;">جاري تحميل البيانات...</p></div>`;
            
            try {
                console.log('Loading permissions from Firestore...');
                const rolesSnap = await getDocs(collection(db, "staff_roles"));
                const users = [];
                rolesSnap.forEach(docSnap => users.push({ uid: docSnap.id, ...docSnap.data() }));
                console.log('Loaded users:', users.length, users);
                
                // حساب الإحصائيات
                const activeCount = users.filter(u => u.status !== 'suspended').length;
                const suspendedCount = users.filter(u => u.status === 'suspended').length;
                
                const statsActiveEl = document.getElementById('statsActive');
                const statsSuspendedEl = document.getElementById('statsSuspended');
                const statsTotalEl = document.getElementById('statsTotal');
                
                if (statsActiveEl) statsActiveEl.textContent = activeCount;
                if (statsSuspendedEl) statsSuspendedEl.textContent = suspendedCount;
                if (statsTotalEl) statsTotalEl.textContent = users.length;
                
                if (users.length === 0) {
                    container.innerHTML = `<div class="no-alerts"><p>لا يوجد موظفين مسجلين</p></div>`;
                    return;
                }
                
                container.innerHTML = users.map(u => {
                    const currentRole = ROLES.find(r => r.id === u.role) || ROLES[3];
                    const allowedSystems = u.allowedSystems || [];
                    const committee = u.committee || '';
                    const isSuspended = u.status === 'suspended';
                    const statusColor = isSuspended ? '#f59e0b' : '#10b981';
                    const statusText = isSuspended ? 'معلق' : 'فعال';
                    const statusBg = isSuspended ? '#fef3c7' : '#d1fae5';
                    
                    return `
                        <div class="permission-card" style="background:#fff; border-radius:12px; padding:20px; margin-bottom:15px; border-right:4px solid ${isSuspended ? '#f59e0b' : currentRole.color}; box-shadow:0 2px 8px rgba(0,0,0,0.08); ${isSuspended ? 'opacity:0.7;' : ''}">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
                                <div>
                                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                                        <h4 style="color:var(--primary); margin:0;">
                                            <i class="fas fa-user" style="margin-left:8px; color:var(--gold);"></i>
                                            ${u.fullName || u.email || u.uid}
                                        </h4>
                                        <span style="background:${statusBg}; color:${statusColor}; padding:3px 10px; border-radius:20px; font-size:0.75rem; font-weight:600;">
                                            <i class="fas fa-${isSuspended ? 'pause-circle' : 'check-circle'}"></i> ${statusText}
                                        </span>
                                    </div>
                                    <p style="color:#666; font-size:0.85rem;">${u.email || ''}</p>
                                    <p style="color:#999; font-size:0.8rem;">${u.department || ''} - ${u.jobTitle || ''}</p>
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <button onclick="toggleUserStatus('${u.uid}', ${isSuspended})" style="background:${isSuspended ? '#d1fae5' : '#fef3c7'}; color:${isSuspended ? '#10b981' : '#f59e0b'}; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-family:inherit;">
                                        <i class="fas fa-${isSuspended ? 'play-circle' : 'pause-circle'}"></i> ${isSuspended ? 'تفعيل' : 'تعليق'}
                                    </button>
                                    <button onclick="deleteUser('${u.uid}')" style="background:#fee2e2; color:#dc3545; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-family:inherit;">
                                        <i class="fas fa-trash"></i> حذف
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
                                <div>
                                    <label style="font-weight:600; color:var(--primary); display:block; margin-bottom:8px;">
                                        <i class="fas fa-user-tag"></i> الدور
                                    </label>
                                    <select onchange="updateUserField('${u.uid}', 'role', this.value)" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-family:inherit;">
                                        ${ROLES.map(r => `<option value="${r.id}" ${u.role === r.id ? 'selected' : ''}>${r.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:var(--primary); display:block; margin-bottom:8px;">
                                        <i class="fas fa-users"></i> اللجنة
                                    </label>
                                    <select onchange="updateUserField('${u.uid}', 'committee', this.value)" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-family:inherit;">
                                        <option value="">-- بدون لجنة --</option>
                                        ${COMMITTEES.map(c => `<option value="${c.id}" ${committee === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-weight:600; color:var(--primary); display:block; margin-bottom:10px;">
                                    <i class="fas fa-th-large"></i> الأنظمة المسموحة (اختر ما تريد)
                                </label>
                                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                    ${SYSTEMS.map(s => `
                                        <label style="display:flex; align-items:center; gap:6px; background:${allowedSystems.includes(s.id) ? '#d1fae5' : '#f3f4f6'}; padding:8px 12px; border-radius:8px; cursor:pointer; transition:all 0.2s;">
                                            <input type="checkbox" ${allowedSystems.includes(s.id) ? 'checked' : ''} onchange="toggleSystem('${u.uid}', '${s.id}', this.checked)" style="cursor:pointer;">
                                            <i class="fas fa-${s.icon}" style="color:${allowedSystems.includes(s.id) ? '#10b981' : '#9ca3af'};"></i>
                                            <span style="font-size:0.85rem;">${s.name}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Error loading permissions:', e);
                container.innerHTML = `
                    <div class="no-alerts" style="text-align:center; padding:30px;">
                        <i class="fas fa-exclamation-triangle fa-2x" style="color:#f59e0b; margin-bottom:15px;"></i>
                        <p style="margin-bottom:10px;">تعذر تحميل الصلاحيات</p>
                        <p style="font-size:0.85rem; color:#888;">${e.message || 'خطأ في الاتصال بقاعدة البيانات'}</p>
                        <button onclick="loadPermissions()" style="margin-top:15px; padding:10px 25px; background:var(--gold); color:#fff; border:none; border-radius:8px; cursor:pointer; font-family:inherit;">
                            <i class="fas fa-sync"></i> إعادة المحاولة
                        </button>
                    </div>`;
            }
        }
        
        window.updateUserField = async function(uid, field, value) {
            if (currentUserRole !== 'admin') {
                showToast('ليس لديك صلاحية لهذا الإجراء', true);
                return;
            }
            try {
                await updateDoc(doc(db, "staff_roles", uid), {
                    [field]: value,
                    updatedAt: new Date().toISOString(),
                    updatedBy: auth.currentUser.email
                });
                showToast('تم الحفظ بنجاح');
            } catch (e) {
                console.error('Error updating:', e);
                showToast('حدث خطأ أثناء التحديث', true);
            }
        };
        
        window.toggleUserStatus = async function(uid, currentlySuspended) {
            if (currentUserRole !== 'admin') {
                showToast('ليس لديك صلاحية لهذا الإجراء', true);
                return;
            }
            const newStatus = currentlySuspended ? 'active' : 'suspended';
            const message = currentlySuspended ? 'تفعيل' : 'تعليق';
            
            if (!confirm(`هل تريد ${message} هذا العضو؟`)) return;
            
            try {
                await updateDoc(doc(db, "staff_roles", uid), {
                    status: newStatus,
                    updatedAt: new Date().toISOString(),
                    updatedBy: auth.currentUser.email
                });
                showToast(currentlySuspended ? 'تم تفعيل العضو' : 'تم تعليق العضو');
                loadPermissions();
            } catch (e) {
                console.error('Error toggling status:', e);
                showToast('حدث خطأ', true);
            }
        };
        
        window.toggleSystem = async function(uid, systemId, checked) {
            if (currentUserRole !== 'admin') {
                showToast('ليس لديك صلاحية لهذا الإجراء', true);
                return;
            }
            try {
                const docRef = doc(db, "staff_roles", uid);
                const docSnap = await getDoc(docRef);
                let allowedSystems = docSnap.exists() ? (docSnap.data().allowedSystems || []) : [];
                
                if (checked && !allowedSystems.includes(systemId)) {
                    allowedSystems.push(systemId);
                } else if (!checked) {
                    allowedSystems = allowedSystems.filter(s => s !== systemId);
                }
                
                await updateDoc(docRef, {
                    allowedSystems: allowedSystems,
                    updatedAt: new Date().toISOString(),
                    updatedBy: auth.currentUser.email
                });
                showToast('تم الحفظ');
            } catch (e) {
                console.error('Error toggling system:', e);
                showToast('حدث خطأ', true);
            }
        };
        
        window.deleteUser = async function(uid) {
            if (currentUserRole !== 'admin') {
                showToast('ليس لديك صلاحية لهذا الإجراء', true);
                return;
            }
            if (!confirm('هل أنت متأكد من حذف هذا المستخدم نهائياً؟ لن يتمكن من الدخول بعد الحذف.')) return;
            
            try {
                await deleteDoc(doc(db, "staff_roles", uid));
                showToast('تم حذف المستخدم');
                loadPermissions();
            } catch (e) {
                console.error('Error deleting:', e);
                showToast('حدث خطأ أثناء الحذف', true);
            }
        };
        
        document.querySelector('[data-section="permissions"]')?.addEventListener('click', loadPermissions);
    </script>
</body>
</html>
