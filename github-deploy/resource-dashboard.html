<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRIS - Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø¨ÙƒØ± Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8a;
            --gold: #c9a962;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1a1a2e;
            --darker: #0f0f1a;
            --card-bg: rgba(30, 58, 95, 0.3);
            --border: rgba(201, 169, 98, 0.2);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, var(--primary) 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }
        
        .header {
            background: rgba(30, 58, 95, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-section img {
            height: 50px;
        }
        
        .system-title {
            display: flex;
            flex-direction: column;
        }
        
        .system-title h1 {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--gold);
        }
        
        .system-title span {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .mode-selector {
            display: flex;
            gap: 0.5rem;
            background: rgba(0,0,0,0.3);
            padding: 0.3rem;
            border-radius: 10px;
        }
        
        .mode-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: var(--primary-light);
        }
        
        .mode-btn.normal.active { background: var(--success); }
        .mode-btn.peak.active { background: var(--warning); }
        .mode-btn.emergency.active { background: var(--danger); }
        .mode-btn.survey.active { background: var(--info); }
        
        .header-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .live-time {
            text-align: center;
        }
        
        .live-time .time {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
        }
        
        .live-time .date {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
        }
        
        .kpi-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.2rem;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gold);
        }
        
        .kpi-card.success::before { background: var(--success); }
        .kpi-card.warning::before { background: var(--warning); }
        .kpi-card.danger::before { background: var(--danger); }
        
        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .kpi-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gold);
        }
        
        .kpi-card.success .kpi-value { color: var(--success); }
        .kpi-card.warning .kpi-value { color: var(--warning); }
        .kpi-card.danger .kpi-value { color: var(--danger); }
        
        .kpi-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0.3rem;
        }
        
        .kpi-trend {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            display: inline-block;
        }
        
        .kpi-trend.up { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .kpi-trend.down { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .kpi-trend.stable { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        
        .heatmap-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            flex: 1;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--gold);
        }
        
        .heatmap-tabs {
            display: flex;
            gap: 0.5rem;
        }
        
        .heatmap-tab {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border);
            background: transparent;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .heatmap-tab.active {
            background: var(--gold);
            color: var(--dark);
            border-color: var(--gold);
        }
        
        .floor-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .floor-section {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 1rem;
        }
        
        .floor-label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .floor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.8rem;
        }
        
        .dept-cell {
            background: rgba(16, 185, 129, 0.3);
            border: 2px solid rgba(16, 185, 129, 0.5);
            border-radius: 10px;
            padding: 1rem 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .dept-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .dept-cell.green {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.6);
        }
        
        .dept-cell.yellow {
            background: rgba(245, 158, 11, 0.3);
            border-color: rgba(245, 158, 11, 0.6);
        }
        
        .dept-cell.red {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.6);
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        .dept-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .dept-stats {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        .dept-coverage {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.5);
        }
        
        .timeline-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem 1.5rem;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .timeline-title {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .timeline-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .timeline-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--border);
            background: transparent;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75rem;
        }
        
        .timeline-btn.active {
            background: var(--gold);
            color: var(--dark);
            border-color: var(--gold);
        }
        
        .timeline-slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .timeline-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }
        
        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--gold);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .timeline-value {
            min-width: 80px;
            text-align: center;
            font-weight: 600;
            color: var(--gold);
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .alerts-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.2rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alerts-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .alert-badge {
            background: var(--danger);
            color: #fff;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .alert-item {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            border-right: 3px solid var(--warning);
        }
        
        .alert-item.critical {
            border-right-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .alert-item.info {
            border-right-color: var(--info);
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .alert-type {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--warning);
        }
        
        .alert-item.critical .alert-type { color: var(--danger); }
        .alert-item.info .alert-type { color: var(--info); }
        
        .alert-time {
            font-size: 0.7rem;
            opacity: 0.6;
        }
        
        .alert-message {
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .alert-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }
        
        .alert-action-btn {
            flex: 1;
            padding: 0.4rem;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .alert-action-btn.primary {
            background: var(--gold);
            color: var(--dark);
        }
        
        .alert-action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .recommendations-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.2rem;
            flex: 1;
        }
        
        .rec-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--gold);
        }
        
        .rec-item {
            background: rgba(201, 169, 98, 0.1);
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.8rem;
        }
        
        .rec-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .rec-icon {
            font-size: 1.2rem;
        }
        
        .rec-label {
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .rec-description {
            font-size: 0.8rem;
            opacity: 0.8;
            line-height: 1.5;
        }
        
        .rec-impact {
            display: flex;
            gap: 1rem;
            margin-top: 0.8rem;
            font-size: 0.7rem;
        }
        
        .impact-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .impact-item.positive { color: var(--success); }
        .impact-item.negative { color: var(--danger); }
        .impact-item.neutral { color: var(--info); }
        
        .indices-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.2rem;
        }
        
        .indices-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .index-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .index-item:last-child {
            border-bottom: none;
        }
        
        .index-name {
            font-size: 0.85rem;
        }
        
        .index-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .index-bar {
            width: 60px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .index-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }
        
        .index-fill.good { background: var(--success); }
        .index-fill.medium { background: var(--warning); }
        .index-fill.bad { background: var(--danger); }
        
        .index-percent {
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 40px;
            text-align: left;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 26, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1.5rem;
            font-size: 1rem;
            color: var(--gold);
        }
        
        .tooltip {
            position: absolute;
            background: var(--dark);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 0.8rem;
            font-size: 0.8rem;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: none;
        }
        
        .tooltip.visible {
            display: block;
        }
        
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .kpi-row {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .right-panel {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .kpi-row {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .right-panel {
                grid-template-columns: 1fr;
            }
            
            .floor-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ========== Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„ÙÙˆØ±Ù…Ø§Øª ========== */
        .uploads-section {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.95), rgba(15, 15, 26, 0.95));
            padding: 2rem;
            margin-top: 1rem;
            border-top: 2px solid var(--gold);
        }
        
        .section-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section-header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .section-header-main h2 {
            font-size: 1.5rem;
            color: var(--gold);
        }
        
        .current-period {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0,0,0,0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
        }
        
        .current-period span:first-child {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .period-status {
            background: var(--warning);
            color: #000;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .upload-monitoring h3,
        .delays-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: #fff;
        }
        
        .upload-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .upload-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s;
        }
        
        .upload-card:hover {
            border-color: var(--gold);
            transform: translateY(-3px);
        }
        
        .upload-card-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .upload-icon {
            font-size: 1.8rem;
        }
        
        .upload-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .upload-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .upload-status.pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .upload-status.uploaded {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .upload-status.delayed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .upload-info {
            margin-bottom: 1rem;
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }
        
        .info-label {
            color: rgba(255,255,255,0.6);
            min-width: 70px;
        }
        
        .info-value {
            flex: 1;
        }
        
        .assign-btn {
            background: var(--primary-light);
            color: #fff;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .assign-btn:hover {
            background: var(--gold);
            color: var(--dark);
        }
        
        .upload-actions {
            display: flex;
            gap: 0.8rem;
        }
        
        .upload-btn, .history-btn {
            flex: 1;
            padding: 0.7rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .upload-btn {
            background: var(--gold);
            color: var(--dark);
        }
        
        .upload-btn:hover {
            background: #e0c07a;
        }
        
        .history-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .history-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ±Ø§Øª */
        .delays-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }
        
        .delays-table-container {
            overflow-x: auto;
        }
        
        .delays-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .delays-table th {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            text-align: right;
            font-weight: 600;
            color: var(--gold);
        }
        
        .delays-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .delays-table tr:hover {
            background: rgba(255,255,255,0.03);
        }
        
        .no-delays-msg {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--success);
        }
        
        .delay-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .delay-badge.critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .delay-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .remind-btn {
            background: var(--info);
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--dark);
            border: 1px solid var(--gold);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content.modal-large {
            max-width: 800px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h3 {
            color: var(--gold);
            font-size: 1.2rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #fff;
            font-family: inherit;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
        }
        
        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }
        
        .btn-cancel, .btn-confirm {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .btn-cancel {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .btn-confirm {
            background: var(--gold);
            color: var(--dark);
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th {
            background: rgba(0,0,0,0.3);
            padding: 0.8rem;
            text-align: right;
            font-size: 0.85rem;
        }
        
        .history-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            .upload-cards {
                grid-template-columns: 1fr;
            }
            
            .section-header-main {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… MRIS...</div>
    </div>

    <header class="header">
        <div class="logo-section">
            <img src="logo-transparent.png" alt="Logo" onerror="this.style.display='none'">
            <div class="system-title">
                <h1>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø¨ÙƒØ± Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ©</h1>
                <span>Medical Resource Intelligence System - MRIS</span>
            </div>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn normal active" data-mode="normal">ğŸŸ¢ Ø¹Ø§Ø¯ÙŠ</button>
            <button class="mode-btn peak" data-mode="peak">ğŸŸ¡ Ø°Ø±ÙˆØ©</button>
            <button class="mode-btn emergency" data-mode="emergency">ğŸ”´ Ø·ÙˆØ§Ø±Ø¦</button>
            <button class="mode-btn survey" data-mode="survey">ğŸ“‹ Ø³Ø¨Ø§Ù‡ÙŠ</button>
        </div>
        
        <div class="header-info">
            <div class="live-time">
                <div class="time" id="liveTime">--:--:--</div>
                <div class="date" id="liveDate">--</div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <div class="left-panel">
            <div class="kpi-row">
                <div class="kpi-card success" id="kpi-coverage">
                    <div class="kpi-icon">ğŸ‘¥</div>
                    <div class="kpi-value" id="coverageValue">--%</div>
                    <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
                    <div class="kpi-trend stable" id="coverageTrend">âŸ· Ù…Ø³ØªÙ‚Ø±</div>
                </div>
                
                <div class="kpi-card" id="kpi-understaffed">
                    <div class="kpi-icon">âš ï¸</div>
                    <div class="kpi-value" id="understaffedValue">--</div>
                    <div class="kpi-label">Ø£Ù‚Ø³Ø§Ù… ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</div>
                    <div class="kpi-trend" id="understaffedTrend">--</div>
                </div>
                
                <div class="kpi-card" id="kpi-stress">
                    <div class="kpi-icon">ğŸ’ª</div>
                    <div class="kpi-value" id="stressValue">--%</div>
                    <div class="kpi-label">Ù…Ø¤Ø´Ø± Ø¥Ø±Ù‡Ø§Ù‚ Ø§Ù„Ø·Ø§Ù‚Ù…</div>
                    <div class="kpi-trend" id="stressTrend">--</div>
                </div>
                
                <div class="kpi-card" id="kpi-consumption">
                    <div class="kpi-icon">ğŸ“¦</div>
                    <div class="kpi-value" id="consumptionValue">--%</div>
                    <div class="kpi-label">Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</div>
                    <div class="kpi-trend" id="consumptionTrend">--</div>
                </div>
                
                <div class="kpi-card" id="kpi-risk">
                    <div class="kpi-icon">ğŸ›¡ï¸</div>
                    <div class="kpi-value" id="riskValue">--</div>
                    <div class="kpi-label">ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</div>
                    <div class="kpi-trend" id="riskTrend">--</div>
                </div>
            </div>
            
            <div class="heatmap-section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø­ÙŠØ©</h2>
                    <div class="heatmap-tabs">
                        <button class="heatmap-tab active" data-view="coverage">Ø§Ù„ØªØºØ·ÙŠØ©</button>
                        <button class="heatmap-tab" data-view="workload">Ø§Ù„Ø¶ØºØ·</button>
                        <button class="heatmap-tab" data-view="consumption">Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</button>
                    </div>
                </div>
                
                <div class="floor-container" id="floorContainer">
                    <div class="floor-section">
                        <div class="floor-label">ğŸ¢ Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
                        <div class="floor-grid" id="floor2"></div>
                    </div>
                    
                    <div class="floor-section">
                        <div class="floor-label">ğŸ¢ Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„</div>
                        <div class="floor-grid" id="floor1"></div>
                    </div>
                    
                    <div class="floor-section">
                        <div class="floor-label">ğŸ¢ Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ</div>
                        <div class="floor-grid" id="floor0"></div>
                    </div>
                </div>
            </div>
            
            <div class="timeline-section">
                <div class="timeline-header">
                    <span class="timeline-title">â±ï¸ Ø§Ù„Ø®Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ</span>
                    <div class="timeline-controls">
                        <button class="timeline-btn active" data-range="today">Ø§Ù„ÙŠÙˆÙ…</button>
                        <button class="timeline-btn" data-range="week">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                        <button class="timeline-btn" data-range="month">Ø§Ù„Ø´Ù‡Ø±</button>
                    </div>
                </div>
                <div class="timeline-slider-container">
                    <span>00:00</span>
                    <input type="range" class="timeline-slider" id="timelineSlider" min="0" max="23" value="12">
                    <span>23:59</span>
                    <div class="timeline-value" id="timelineValue">12:00</div>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="alerts-section">
                <h3 class="alerts-title">
                    ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
                    <span class="alert-badge" id="alertCount">0</span>
                </h3>
                <div id="alertsList">
                    <div class="alert-item critical">
                        <div class="alert-header">
                            <span class="alert-type">âš ï¸ Ù†Ù‚Øµ ØªØºØ·ÙŠØ©</span>
                            <span class="alert-time">Ù…Ù†Ø° 5 Ø¯Ù‚Ø§Ø¦Ù‚</span>
                        </div>
                        <div class="alert-message">Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ù†Ø§Ù† 2 - Ø§Ù„ØªØºØ·ÙŠØ© 60% ÙÙ‚Ø·</div>
                        <div class="alert-actions">
                            <button class="alert-action-btn primary">Ø§Ù‚ØªØ±Ø§Ø­ Ø­Ù„</button>
                            <button class="alert-action-btn secondary">ØªØ£Ø¬ÙŠÙ„</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="recommendations-section">
                <h3 class="rec-title">ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                <div id="recommendationsList">
                    <div class="rec-item">
                        <div class="rec-header">
                            <span class="rec-icon">ğŸ”„</span>
                            <span class="rec-label">Ù†Ù‚Ù„ Ù…ÙˆØ¸Ù</span>
                        </div>
                        <div class="rec-description">Ù†Ù‚Ù„ Ø§Ù„Ù…Ù…Ø±Ø¶Ø© (Ø£) Ù…Ù† Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ© 1 Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³Ù†Ø§Ù† 2 Ø³ÙŠØ­Ø³Ù† Ø§Ù„ØªØºØ·ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© 20%</div>
                        <div class="rec-impact">
                            <span class="impact-item positive">ğŸ“ˆ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØºØ·ÙŠØ©</span>
                            <span class="impact-item neutral">â±ï¸ 10 Ø¯Ù‚Ø§Ø¦Ù‚</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="indices-section">
                <h3 class="indices-title">ğŸ“Š Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                <div id="indicesList">
                    <div class="index-item">
                        <span class="index-name">Staff Stress Index</span>
                        <div class="index-value">
                            <div class="index-bar">
                                <div class="index-fill good" style="width: 25%"></div>
                            </div>
                            <span class="index-percent">25%</span>
                        </div>
                    </div>
                    <div class="index-item">
                        <span class="index-name">Service Strain Index</span>
                        <div class="index-value">
                            <div class="index-bar">
                                <div class="index-fill medium" style="width: 55%"></div>
                            </div>
                            <span class="index-percent">55%</span>
                        </div>
                    </div>
                    <div class="index-item">
                        <span class="index-name">Consumption Integrity</span>
                        <div class="index-value">
                            <div class="index-bar">
                                <div class="index-fill good" style="width: 92%"></div>
                            </div>
                            <span class="index-percent">92%</span>
                        </div>
                    </div>
                    <div class="index-item">
                        <span class="index-name">Safety Risk Projection</span>
                        <div class="index-value">
                            <div class="index-bar">
                                <div class="index-fill good" style="width: 15%"></div>
                            </div>
                            <span class="index-percent">15%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="tooltip" id="tooltip"></div>

    <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„ÙÙˆØ±Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© -->
    <section class="uploads-section" id="uploadsSection">
        <div class="section-container">
            <div class="section-header-main">
                <h2>ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ÙÙˆØ±Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
                <div class="current-period">
                    <span id="currentMonth">--</span>
                    <span class="period-status" id="periodStatus">Ø¬Ø§Ø±ÙŠ</span>
                </div>
            </div>
            
            <!-- Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ -->
            <div class="upload-monitoring">
                <h3>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
                <div class="upload-cards" id="uploadCards">
                    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª -->
                    <div class="upload-card" data-type="revenue">
                        <div class="upload-card-header">
                            <span class="upload-icon">ğŸ’°</span>
                            <span class="upload-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>
                        </div>
                        <div class="upload-status pending">
                            <span class="status-icon">â³</span>
                            <span class="status-text">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±ÙØ¹</span>
                        </div>
                        <div class="upload-info">
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span>
                                <span class="info-value assignee" data-type="revenue">Ù„Ù… ÙŠÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯</span>
                                <button class="assign-btn" onclick="assignEmployee('revenue')">ØªÙƒÙ„ÙŠÙ</button>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù…ÙˆØ¹Ø¯:</span>
                                <span class="info-value deadline">ÙŠÙˆÙ… 5 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø¢Ø®Ø± Ø±ÙØ¹:</span>
                                <span class="info-value last-upload" data-type="revenue">--</span>
                            </div>
                        </div>
                        <div class="upload-actions">
                            <input type="file" id="file-revenue" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload('revenue', this)">
                            <button class="upload-btn" onclick="document.getElementById('file-revenue').click()">
                                <span>ğŸ“</span> Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                            </button>
                            <button class="history-btn" onclick="showUploadHistory('revenue')">
                                ğŸ“œ Ø§Ù„Ø³Ø¬Ù„
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø±ÙØ¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰ -->
                    <div class="upload-card" data-type="patients">
                        <div class="upload-card-header">
                            <span class="upload-icon">ğŸ‘¥</span>
                            <span class="upload-title">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰</span>
                        </div>
                        <div class="upload-status pending">
                            <span class="status-icon">â³</span>
                            <span class="status-text">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±ÙØ¹</span>
                        </div>
                        <div class="upload-info">
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span>
                                <span class="info-value assignee" data-type="patients">Ù„Ù… ÙŠÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯</span>
                                <button class="assign-btn" onclick="assignEmployee('patients')">ØªÙƒÙ„ÙŠÙ</button>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù…ÙˆØ¹Ø¯:</span>
                                <span class="info-value deadline">ÙŠÙˆÙ… 5 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø¢Ø®Ø± Ø±ÙØ¹:</span>
                                <span class="info-value last-upload" data-type="patients">--</span>
                            </div>
                        </div>
                        <div class="upload-actions">
                            <input type="file" id="file-patients" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload('patients', this)">
                            <button class="upload-btn" onclick="document.getElementById('file-patients').click()">
                                <span>ğŸ“</span> Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                            </button>
                            <button class="history-btn" onclick="showUploadHistory('patients')">
                                ğŸ“œ Ø§Ù„Ø³Ø¬Ù„
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ -->
                    <div class="upload-card" data-type="consumption">
                        <div class="upload-card-header">
                            <span class="upload-icon">ğŸ“¦</span>
                            <span class="upload-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</span>
                        </div>
                        <div class="upload-status pending">
                            <span class="status-icon">â³</span>
                            <span class="status-text">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±ÙØ¹</span>
                        </div>
                        <div class="upload-info">
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span>
                                <span class="info-value assignee" data-type="consumption">Ù„Ù… ÙŠÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯</span>
                                <button class="assign-btn" onclick="assignEmployee('consumption')">ØªÙƒÙ„ÙŠÙ</button>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù…ÙˆØ¹Ø¯:</span>
                                <span class="info-value deadline">ÙŠÙˆÙ… 5 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø¢Ø®Ø± Ø±ÙØ¹:</span>
                                <span class="info-value last-upload" data-type="consumption">--</span>
                            </div>
                        </div>
                        <div class="upload-actions">
                            <input type="file" id="file-consumption" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload('consumption', this)">
                            <button class="upload-btn" onclick="document.getElementById('file-consumption').click()">
                                <span>ğŸ“</span> Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                            </button>
                            <button class="history-btn" onclick="showUploadHistory('consumption')">
                                ğŸ“œ Ø§Ù„Ø³Ø¬Ù„
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø±ÙØ¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© -->
                    <div class="upload-card" data-type="assets">
                        <div class="upload-card-header">
                            <span class="upload-icon">ğŸ”§</span>
                            <span class="upload-title">Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</span>
                        </div>
                        <div class="upload-status pending">
                            <span class="status-icon">â³</span>
                            <span class="status-text">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±ÙØ¹</span>
                        </div>
                        <div class="upload-info">
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span>
                                <span class="info-value assignee" data-type="assets">Ù„Ù… ÙŠÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯</span>
                                <button class="assign-btn" onclick="assignEmployee('assets')">ØªÙƒÙ„ÙŠÙ</button>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù…ÙˆØ¹Ø¯:</span>
                                <span class="info-value deadline">ÙŠÙˆÙ… 10 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø¢Ø®Ø± Ø±ÙØ¹:</span>
                                <span class="info-value last-upload" data-type="assets">--</span>
                            </div>
                        </div>
                        <div class="upload-actions">
                            <input type="file" id="file-assets" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileUpload('assets', this)">
                            <button class="upload-btn" onclick="document.getElementById('file-assets').click()">
                                <span>ğŸ“</span> Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                            </button>
                            <button class="history-btn" onclick="showUploadHistory('assets')">
                                ğŸ“œ Ø§Ù„Ø³Ø¬Ù„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ±Ø§Øª -->
            <div class="delays-section" id="delaysSection">
                <h3>âš ï¸ Ø§Ù„ØªØ£Ø®ÙŠØ±Ø§Øª</h3>
                <div class="delays-table-container">
                    <table class="delays-table" id="delaysTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
                                <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                <th>Ø§Ù„Ù…ÙˆØ¹Ø¯</th>
                                <th>Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody id="delaysBody">
                            <tr class="no-delays">
                                <td colspan="6">
                                    <div class="no-delays-msg">
                                        <span>âœ…</span>
                                        <span>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Modal ØªÙƒÙ„ÙŠÙ Ù…ÙˆØ¸Ù -->
    <div class="modal-overlay" id="assignModal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ‘¤ ØªÙƒÙ„ÙŠÙ Ù…ÙˆØ¸Ù</h3>
                <button class="modal-close" onclick="closeAssignModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</label>
                    <input type="text" id="assignReportType" readonly>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                    <input type="text" id="assignEmployeeName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                    <input type="email" id="assignEmployeeEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                </div>
                <div class="form-group">
                    <label>Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…:</label>
                    <select id="assignDeadline">
                        <option value="5">ÙŠÙˆÙ… 5 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</option>
                        <option value="10">ÙŠÙˆÙ… 10 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</option>
                        <option value="15">ÙŠÙˆÙ… 15 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</option>
                        <option value="20">ÙŠÙˆÙ… 20 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</option>
                        <option value="25">ÙŠÙˆÙ… 25 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAssignModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn-confirm" onclick="confirmAssignment()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙƒÙ„ÙŠÙ</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Ø³Ø¬Ù„ Ø§Ù„Ø±ÙØ¹Ø§Øª -->
    <div class="modal-overlay" id="historyModal" style="display:none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø±ÙØ¹Ø§Øª</h3>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…Ù„Ù</th>
                            <th>Ø±ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==================== API CONFIGURATION ====================
        const API_URL = 'https://script.google.com/macros/s/AKfycbysDVVd26WYP02PcGvoSncf-H6lY1zlfumzwRXvySvAeKXVXVhr3b2hKqte_VkssbxA9A/exec';
        let API_TOKEN = localStorage.getItem('mris_token') || '';
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ØªØ³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API)
        let DEPARTMENTS = [
            { id: 'reception', name: 'Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„', floor: 1, required: 2, actual: 2 },
            { id: 'batiniya1', name: 'Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ© 1', floor: 2, required: 3, actual: 3 },
            { id: 'batiniya2', name: 'Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ© 2', floor: 2, required: 3, actual: 2 },
            { id: 'batiniya3', name: 'Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠØ© 3', floor: 2, required: 2, actual: 2 },
            { id: 'dental', name: 'Ø§Ù„Ø£Ø³Ù†Ø§Ù†', floor: 2, required: 4, actual: 3 },
            { id: 'emergency', name: 'Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', floor: 1, required: 3, actual: 3 },
            { id: 'general', name: 'Ø§Ù„Ø·Ø¨ Ø§Ù„Ø¹Ø§Ù…', floor: 1, required: 2, actual: 2 },
            { id: 'pharmacy', name: 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©', floor: 1, required: 2, actual: 2 },
            { id: 'nursery', name: 'Ø§Ù„Ù†Ø³Ø§Ø¡ ÙˆØ§Ù„ÙˆÙ„Ø§Ø¯Ø©', floor: 1, required: 2, actual: 1 },
            { id: 'reception1', name: 'Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ 1', floor: 1, required: 1, actual: 1 },
            { id: 'reception2', name: 'Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ 2', floor: 2, required: 1, actual: 1 },
            { id: 'admin', name: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', floor: 0, required: 2, actual: 2 },
            { id: 'lab', name: 'Ø§Ù„Ù…Ø®ØªØ¨Ø±', floor: 0, required: 2, actual: 2 }
        ];
        
        // ==================== API FUNCTIONS ====================
        async function apiCall(action, params = {}) {
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({
                    action,
                    payload: {
                        ...params,
                        token: API_TOKEN
                    }
                }),
                redirect: "follow"
            });
            
            const text = await res.text();
            let json;
            try { 
                json = JSON.parse(text); 
            } catch (e) { 
                throw new Error("Invalid JSON: " + text.slice(0, 120)); 
            }
            
            if (json.ok === true || json.success === true || json.saved === true || json.data || json.monthKey || json.lastByType) {
                return json.data ?? json;
            }
            throw new Error(json.error || "API Error");
        }
        
        async function loadLiveData() {
            if (!API_TOKEN) {
                console.log('No token - using demo data');
                return;
            }
            
            try {
                const heatmapData = await apiCall('getHeatmap');
                if (heatmapData && heatmapData.length > 0) {
                    DEPARTMENTS = heatmapData.map(d => ({
                        id: d.deptId,
                        name: d.name,
                        floor: parseInt(d.floor) || 1,
                        required: d.required,
                        actual: d.actual
                    }));
                    renderHeatmap();
                    await updateKPIs();
                    console.log('Live data loaded successfully');
                }
            } catch (error) {
                console.warn('Failed to load live data:', error.message);
            }
        }
        
        function promptForToken() {
            const token = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (Token):');
            if (token) {
                API_TOKEN = token;
                localStorage.setItem('mris_token', token);
                loadLiveData();
            }
        }
        
        let currentMode = 'normal';
        let currentView = 'coverage';
        let currentHour = new Date().getHours();
        
        function updateLiveTime() {
            const now = new Date();
            document.getElementById('liveTime').textContent = now.toLocaleTimeString('ar-SA');
            document.getElementById('liveDate').textContent = now.toLocaleDateString('ar-SA', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function getCoverageClass(coverage) {
            if (coverage >= 90) return 'green';
            if (coverage >= 70) return 'yellow';
            return 'red';
        }
        
        function renderHeatmap() {
            const floors = { 0: [], 1: [], 2: [] };
            
            DEPARTMENTS.forEach(dept => {
                const coverage = Math.round((dept.actual / dept.required) * 100);
                const colorClass = getCoverageClass(coverage);
                
                const cell = `
                    <div class="dept-cell ${colorClass}" data-dept="${dept.id}" onclick="showDeptDetails('${dept.id}')">
                        <span class="dept-coverage">${coverage}%</span>
                        <div class="dept-name">${dept.name}</div>
                        <div class="dept-stats">
                            <span>ğŸ‘¤ ${dept.actual}/${dept.required}</span>
                        </div>
                    </div>
                `;
                floors[dept.floor].push(cell);
            });
            
            document.getElementById('floor0').innerHTML = floors[0].join('');
            document.getElementById('floor1').innerHTML = floors[1].join('');
            document.getElementById('floor2').innerHTML = floors[2].join('');
        }
        
        async function updateKPIs() {
            let totalRequired = 0;
            let totalActual = 0;
            let understaffed = 0;
            
            DEPARTMENTS.forEach(dept => {
                totalRequired += dept.required;
                totalActual += dept.actual;
                if (dept.actual < dept.required) understaffed++;
            });
            
            const coverage = Math.round((totalActual / totalRequired) * 100);
            
            document.getElementById('coverageValue').textContent = coverage + '%';
            document.getElementById('understaffedValue').textContent = understaffed;
            
            const coverageCard = document.getElementById('kpi-coverage');
            coverageCard.className = 'kpi-card ' + (coverage >= 90 ? 'success' : coverage >= 70 ? 'warning' : 'danger');
            
            const understaffedCard = document.getElementById('kpi-understaffed');
            understaffedCard.className = 'kpi-card ' + (understaffed === 0 ? 'success' : understaffed <= 2 ? 'warning' : 'danger');
            
            // Ø¬Ù„Ø¨ KPIs Ùˆ Indices Ù…Ù† Ø§Ù„Ù€ API
            let stressIndex = 25, consumptionIntegrity = 92, riskLevel = 'Ù…Ù†Ø®ÙØ¶';
            
            try {
                const kpis = await apiCall('getKpis');
                if (kpis) {
                    stressIndex = kpis.stressIndex || 25;
                    consumptionIntegrity = kpis.consumptionIntegrity || 92;
                    riskLevel = kpis.riskLevel === 'high' ? 'Ù…Ø±ØªÙØ¹' : 
                               kpis.riskLevel === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶';
                }
            } catch (e) {
                console.warn('KPIs fallback:', e.message);
            }
            
            document.getElementById('stressValue').textContent = stressIndex + '%';
            document.getElementById('consumptionValue').textContent = consumptionIntegrity + '%';
            document.getElementById('riskValue').textContent = riskLevel;
            
            // Trends Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…
            document.getElementById('stressTrend').textContent = stressIndex <= 30 ? 'â†“ ØªØ­Ø³Ù†' : stressIndex <= 50 ? 'âŸ· Ù…ØªÙˆØ³Ø·' : 'â†‘ Ø­Ø±Ø¬';
            document.getElementById('stressTrend').className = 'kpi-trend ' + (stressIndex <= 30 ? 'up' : stressIndex <= 50 ? 'stable' : 'down');
            
            document.getElementById('consumptionTrend').textContent = consumptionIntegrity >= 80 ? 'âœ“ Ù…Ù…ØªØ§Ø²' : consumptionIntegrity >= 60 ? 'âŸ· Ø·Ø¨ÙŠØ¹ÙŠ' : 'â†“ Ù†Ù‚Øµ';
            document.getElementById('consumptionTrend').className = 'kpi-trend ' + (consumptionIntegrity >= 80 ? 'up' : consumptionIntegrity >= 60 ? 'stable' : 'down');
            
            document.getElementById('riskTrend').textContent = riskLevel === 'Ù…Ù†Ø®ÙØ¶' ? 'âœ“ Ø¢Ù…Ù†' : riskLevel === 'Ù…ØªÙˆØ³Ø·' ? 'âš  Ù…Ø±Ø§Ù‚Ø¨Ø©' : 'â›” ØªØ¯Ø®Ù„';
            document.getElementById('riskTrend').className = 'kpi-trend ' + (riskLevel === 'Ù…Ù†Ø®ÙØ¶' ? 'up' : riskLevel === 'Ù…ØªÙˆØ³Ø·' ? 'stable' : 'down');
            
            document.getElementById('understaffedTrend').textContent = understaffed > 0 ? 'â†‘ ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©' : 'âœ“ Ù…Ù…ØªØ§Ø²';
            document.getElementById('understaffedTrend').className = 'kpi-trend ' + (understaffed > 0 ? 'down' : 'up');
        }
        
        function showDeptDetails(deptId) {
            const dept = DEPARTMENTS.find(d => d.id === deptId);
            if (!dept) return;
            
            const coverage = Math.round((dept.actual / dept.required) * 100);
            
            alert(`
${dept.name}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ø§Ù„ØªØºØ·ÙŠØ©: ${coverage}%
Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†: ${dept.actual}
Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${dept.required}
Ø§Ù„Ø·Ø§Ø¨Ù‚: ${dept.floor === 0 ? 'Ø§Ù„Ø£Ø±Ø¶ÙŠ' : dept.floor === 1 ? 'Ø§Ù„Ø£ÙˆÙ„' : 'Ø§Ù„Ø«Ø§Ù†ÙŠ'}
            `);
        }
        
        async function loadEvidencePack(deptId = '', standardRef = 'LD4.5') {
            if (!API_TOKEN) return [];
            
            try {
                const items = await apiCall('getEvidencePack', {
                    deptId: deptId,
                    standardRef: standardRef,
                    status: ''
                });
                
                return Array.isArray(items) ? items : [];
            } catch (err) {
                console.error('Failed to load evidence:', err);
                return [];
            }
        }
        
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            if (mode === 'survey') {
                document.querySelector('.alerts-section').style.display = 'none';
                
                document.querySelector('.recommendations-section').innerHTML = `
                    <h3 class="rec-title">ğŸ“‹ Ø£Ø¯Ù„Ø© Ø³Ø¨Ø§Ù‡ÙŠ Ø§Ù„Ø­ÙŠØ©</h3>
                    <div id="evidenceList" style="display:flex; flex-direction:column; gap:0.8rem;">
                        <div class="rec-item"><div class="rec-description">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù„Ø©...</div></div>
                    </div>
                `;
                
                loadEvidencePack('', 'LD4.5').then(items => {
                    const box = document.getElementById('evidenceList');
                    if (!items.length) {
                        box.innerHTML = `
                            <div class="rec-item">
                                <div class="rec-description">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯Ù„Ø© Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø±Ø¨Ø· Ø£ÙˆÙ„ Ø¯Ù„ÙŠÙ„ Ø¹Ø¨Ø± API.</div>
                                <div style="margin-top:10px; font-size:0.75rem; opacity:0.7;">
                                    Ø§Ø³ØªØ®Ø¯Ù… action=linkEvidence Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø± ÙˆØ³ÙŠØ§Ø³Ø§Øª ÙˆØ£ÙˆØ§Ù…Ø± Ø´Ø±Ø§Ø¡
                                </div>
                            </div>`;
                        return;
                    }
                    
                    box.innerHTML = items.slice().reverse().slice(0, 20).map(ev => {
                        const statusColor = ev.status === 'Verified' ? '#28a745' : 
                                          ev.status === 'Ready' ? 'var(--gold)' : '#888';
                        const statusIcon = ev.status === 'Verified' ? 'âœ…' : 
                                         ev.status === 'Ready' ? 'ğŸ“‹' : 'ğŸ“';
                        
                        const att = (ev.attachments || []).map(a => `
                            <div style="margin-top:6px; font-size:0.75rem; opacity:0.85;">
                                ğŸ“ <a href="${a.docLink}" target="_blank" style="color:var(--gold); text-decoration:none;">${a.docType}</a>
                                ${a.notes ? `<span style="opacity:0.7;"> - ${a.notes}</span>` : ''}
                            </div>
                        `).join('');
                        
                        return `
                            <div class="rec-item" style="border-right: 3px solid ${statusColor};">
                                <div class="rec-header">
                                    <span class="rec-icon">${statusIcon}</span>
                                    <span class="rec-label">${ev.standardRef} â€” ${ev.evidenceType}</span>
                                    <span style="margin-right:auto; font-size:0.7rem; color:${statusColor};">${ev.status}</span>
                                </div>
                                <div class="rec-description">${ev.summary}</div>
                                <div style="margin-top:8px; font-size:0.8rem;">
                                    ğŸ”— <a href="${ev.evidenceLink}" target="_blank" style="color:var(--gold); text-decoration:none;">ÙØªØ­ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</a>
                                </div>
                                ${att}
                                <div style="margin-top:8px; font-size:0.7rem; opacity:0.6;">
                                    Ø§Ù„Ù‚Ø³Ù…: ${ev.deptId || 'Ø§Ù„ÙƒÙ„'} | Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡: ${ev.alertId || '-'} | Ø§Ù„Ù‚Ø±Ø§Ø±: ${ev.decisionId || '-'}
                                    ${ev.verifiedBy ? `| ØªØ­Ù‚Ù‚: ${ev.verifiedBy}` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }).catch(err => {
                    const box = document.getElementById('evidenceList');
                    if (box) box.innerHTML = `<div class="rec-item"><div class="rec-description">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù„Ø©: ${err.message}</div></div>`;
                });
                
            } else {
                document.querySelector('.alerts-section').style.display = 'block';
            }
        }
        
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => setMode(btn.dataset.mode));
        });
        
        document.querySelectorAll('.heatmap-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.heatmap-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentView = tab.dataset.view;
                renderHeatmap();
            });
        });
        
        document.getElementById('timelineSlider').addEventListener('input', (e) => {
            currentHour = parseInt(e.target.value);
            document.getElementById('timelineValue').textContent = 
                String(currentHour).padStart(2, '0') + ':00';
        });
        
        document.querySelectorAll('.timeline-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.timeline-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
        
        async function init() {
            updateLiveTime();
            setInterval(updateLiveTime, 1000);
            
            renderHeatmap();
            await updateKPIs();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ© Ù…Ù† API
            await loadLiveData();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(loadLiveData, 30000);
            
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 1500);
            
            document.getElementById('alertCount').textContent = '3';
        }
        
        init();
        
        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        document.querySelector('.header-info').insertAdjacentHTML('beforeend', 
            '<button onclick="promptForToken()" style="background: var(--gold); color: var(--primary); border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-family: inherit; font-weight: 600;">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>'
        );
        
        // ==================== Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„ÙÙˆØ±Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ====================
        
        const reportTypes = {
            revenue: { name: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', deadline: 5 },
            patients: { name: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰', deadline: 5 },
            consumption: { name: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ', deadline: 5 },
            assets: { name: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©', deadline: 10 }
        };
        
        let uploadAssignments = {};
        let uploadHistory = {};
        let uploadStatusMeta = { monthKey: '' };
        let currentAssignType = null;
        
        function arDateShort(iso) {
            if (!iso) return '--';
            try {
                return new Date(iso).toLocaleDateString('ar-SA');
            } catch (e) {
                return '--';
            }
        }
        
        function computeDelayDays(deadlineDay) {
            const now = new Date();
            const currentDay = now.getDate();
            const d = Number(deadlineDay || 5);
            return currentDay > d ? (currentDay - d) : 0;
        }
        
        async function syncUploadsFromServer() {
            if (!API_TOKEN) {
                console.warn('No API_TOKEN; uploads will show as demo');
                return;
            }
            
            try {
                const res = await apiCall('getUploadStatus');
                uploadStatusMeta.monthKey = res.monthKey || '';
                
                const lastByType = res.lastByType || res.status || {};
                uploadHistory = {};
                
                Object.keys(reportTypes).forEach(type => {
                    const last = lastByType[type];
                    if (last) {
                        uploadHistory[type] = [{
                            date: arDateShort(last.timestamp),
                            fileName: last.fileName || '',
                            uploadedBy: last.uploadedBy || '',
                            timestamp: last.timestamp,
                            driveUrl: last.driveUrl || ''
                        }];
                    } else {
                        uploadHistory[type] = [];
                    }
                    
                    if (!uploadAssignments[type]) {
                        uploadAssignments[type] = {
                            name: '',
                            email: '',
                            deadline: reportTypes[type].deadline
                        };
                    }
                });
                
                renderUploadsUIFromServer();
            } catch (e) {
                console.warn('Failed to sync uploads:', e.message);
            }
        }
        
        function renderUploadsUIFromServer() {
            if (uploadStatusMeta.monthKey) {
                const [yy, mm] = uploadStatusMeta.monthKey.split('-').map(x => Number(x));
                const monthNames = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
                if (yy && mm) {
                    document.getElementById('currentMonth').textContent = `${monthNames[mm - 1]} ${yy}`;
                }
            }
            
            Object.keys(reportTypes).forEach(type => {
                const asg = uploadAssignments[type] || {};
                const hist = uploadHistory[type] || [];
                
                const assigneeEl = document.querySelector(`.assignee[data-type="${type}"]`);
                if (assigneeEl) {
                    assigneeEl.textContent = asg.name ? asg.name : 'Ù„Ù… ÙŠÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯';
                }
                
                const lastUploadEl = document.querySelector(`.last-upload[data-type="${type}"]`);
                if (lastUploadEl) {
                    lastUploadEl.textContent = hist[0]?.date || '--';
                }
                
                const isUploadedThisMonth = !!hist[0]?.timestamp && hist[0]?.timestamp.startsWith(uploadStatusMeta.monthKey);
                if (isUploadedThisMonth) updateCardStatus(type, 'uploaded');
                else updateCardStatus(type, 'pending');
            });
            
            checkDelays();
        }
        
        async function initUploadsSection() {
            const now = new Date();
            const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                              'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            document.getElementById('currentMonth').textContent = 
                monthNames[now.getMonth()] + ' ' + now.getFullYear();
            
            try {
                await syncUploadsFromServer();
            } catch (e) {
                console.warn('Uploads sync failed:', e.message);
                checkDelays();
            }
        }
        
        function updateCardStatus(type, status) {
            const card = document.querySelector(`.upload-card[data-type="${type}"]`);
            if (!card) return;
            
            const statusDiv = card.querySelector('.upload-status');
            statusDiv.className = 'upload-status ' + status;
            
            if (status === 'uploaded') {
                statusDiv.innerHTML = '<span class="status-icon">âœ…</span><span class="status-text">ØªÙ… Ø§Ù„Ø±ÙØ¹</span>';
            } else if (status === 'delayed') {
                statusDiv.innerHTML = '<span class="status-icon">ğŸš¨</span><span class="status-text">Ù…ØªØ£Ø®Ø±</span>';
            } else {
                statusDiv.innerHTML = '<span class="status-icon">â³</span><span class="status-text">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±ÙØ¹</span>';
            }
        }
        
        function assignEmployee(type) {
            currentAssignType = type;
            document.getElementById('assignReportType').value = reportTypes[type].name;
            
            const existing = uploadAssignments[type];
            if (existing) {
                document.getElementById('assignEmployeeName').value = existing.name || '';
                document.getElementById('assignEmployeeEmail').value = existing.email || '';
                document.getElementById('assignDeadline').value = existing.deadline || reportTypes[type].deadline;
            } else {
                document.getElementById('assignEmployeeName').value = '';
                document.getElementById('assignEmployeeEmail').value = '';
                document.getElementById('assignDeadline').value = reportTypes[type].deadline;
            }
            
            document.getElementById('assignModal').style.display = 'flex';
        }
        
        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
            currentAssignType = null;
        }
        
        async function confirmAssignment() {
            const name = document.getElementById('assignEmployeeName').value.trim();
            const email = document.getElementById('assignEmployeeEmail').value.trim();
            const deadline = parseInt(document.getElementById('assignDeadline').value, 10);
            
            if (!name) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù');
                return;
            }
            if (!API_TOKEN) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Token. Ø§Ø¶ØºØ· "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            
            try {
                await apiCall('setAssignment', {
                    reportType: currentAssignType,
                    name,
                    email,
                    deadlineDay: deadline
                });
                
                closeAssignModal();
                await syncUploadsFromServer();
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
            } catch (e) {
                console.error(e);
                alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙŠÙ: ' + e.message);
            }
        }
        
        async function handleFileUpload(type, input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!API_TOKEN) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Token. Ø§Ø¶ØºØ· "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" Ø£ÙˆÙ„Ø§Ù‹.');
                input.value = '';
                return;
            }
            
            const MAX_MB = 8;
            if (file.size > MAX_MB * 1024 * 1024) {
                alert(`Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± (${(file.size/1024/1024).toFixed(1)}MB). Ø§Ù„Ø­Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ${MAX_MB}MB.`);
                input.value = '';
                return;
            }
            
            try {
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const dataUrl = String(reader.result || '');
                        const idx = dataUrl.indexOf('base64,');
                        if (idx === -1) return reject(new Error('Invalid DataURL'));
                        resolve(dataUrl.slice(idx + 7));
                    };
                    reader.onerror = () => reject(new Error('File read error'));
                    reader.readAsDataURL(file);
                });
                
                const uploader = uploadAssignments[type]?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const uploaderEmail = uploadAssignments[type]?.email || '';
                
                const out = await apiCall('uploadFile', {
                    reportType: type,
                    fileName: file.name,
                    mimeType: file.type || 'application/octet-stream',
                    base64,
                    uploadedBy: uploader,
                    uploadedByEmail: uploaderEmail
                });
                
                const lastUploadEl = document.querySelector(`.last-upload[data-type="${type}"]`);
                if (lastUploadEl && out.timestamp) {
                    lastUploadEl.textContent = new Date(out.timestamp).toLocaleDateString('ar-SA');
                }
                
                updateCardStatus(type, 'uploaded');
                checkDelays();
                
                alert(`âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Drive ÙˆØªØ³Ø¬ÙŠÙ„Ù‡\n\nØ§Ù„Ø±Ø§Ø¨Ø·:\n${out.fileUrl || 'ØªÙ… Ø§Ù„Ø­ÙØ¸'}`);
            } catch (e) {
                console.error(e);
                alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + e.message);
            } finally {
                input.value = '';
            }
        }
        
        function showUploadHistory(type) {
            const history = uploadHistory[type] || [];
            const tbody = document.getElementById('historyBody');
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙØ¹Ø§Øª (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</td></tr>';
            } else {
                tbody.innerHTML = history.map(h => `
                    <tr>
                        <td>${h.date}</td>
                        <td>${h.fileName || '-'}</td>
                        <td>${h.uploadedBy || '-'}</td>
                        <td><span style="color: var(--success);">âœ… Ù…Ø³Ø¬Ù„</span></td>
                    </tr>
                `).join('');
            }
            
            document.getElementById('historyModal').style.display = 'flex';
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        function checkDelays() {
            const now = new Date();
            const currentDay = now.getDate();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const delays = [];
            
            Object.keys(reportTypes).forEach(type => {
                const assignment = uploadAssignments[type];
                const deadline = assignment?.deadline || reportTypes[type].deadline;
                const lastUpload = uploadHistory[type]?.[0];
                
                let isUploaded = false;
                if (lastUpload) {
                    const uploadDate = new Date(lastUpload.timestamp);
                    isUploaded = uploadDate.getMonth() === currentMonth && 
                                uploadDate.getFullYear() === currentYear;
                }
                
                if (!isUploaded && currentDay > deadline) {
                    const delayDays = currentDay - deadline;
                    delays.push({
                        type: type,
                        name: reportTypes[type].name,
                        assignee: assignment?.name || 'Ù„Ù… ÙŠÙØ­Ø¯Ø¯',
                        deadline: `ÙŠÙˆÙ… ${deadline}`,
                        delayDays: delayDays,
                        severity: delayDays > 5 ? 'critical' : 'warning'
                    });
                    updateCardStatus(type, 'delayed');
                } else if (!isUploaded) {
                    updateCardStatus(type, 'pending');
                }
            });
            
            renderDelaysTable(delays);
        }
        
        function renderDelaysTable(delays) {
            const tbody = document.getElementById('delaysBody');
            
            if (delays.length === 0) {
                tbody.innerHTML = `
                    <tr class="no-delays">
                        <td colspan="6">
                            <div class="no-delays-msg">
                                <span>âœ…</span>
                                <span>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = delays.map(d => `
                <tr>
                    <td>${d.name}</td>
                    <td>${d.assignee}</td>
                    <td>${d.deadline}</td>
                    <td><span class="delay-badge ${d.severity}">${d.delayDays} ÙŠÙˆÙ…</span></td>
                    <td><span class="delay-badge ${d.severity}">${d.severity === 'critical' ? 'Ø­Ø±Ø¬' : 'ØªØ­Ø°ÙŠØ±'}</span></td>
                    <td><button class="remind-btn" onclick="sendReminder('${d.type}')">ğŸ“§ ØªØ°ÙƒÙŠØ±</button></td>
                </tr>
            `).join('');
        }
        
        function sendReminder(type) {
            const assignment = uploadAssignments[type];
            if (assignment?.email) {
                alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ø¥Ù„Ù‰: ${assignment.name}\n${assignment.email}`);
            } else {
                alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù');
            }
        }
        
        initUploadsSection().catch(console.error);
    </script>
</body>
</html>
