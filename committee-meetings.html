<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>نظام اجتماعات اللجان – مجمع مكة الطبي بالزاهر</title>

  <link rel="icon" type="image/png" href="logo-new.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;800;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --crimson:#7d0024;
      --crimson-2:#5b001a;
      --gold:#d4af37;
      --bg:#1a0b10;
      --muted:rgba(255,255,255,.7);
      --emerald:#10b981;
      --ruby:#ef4444;
      --sapphire:#3b82f6;
      --amber:#f59e0b;
      --amethyst:#8b5cf6;
      --pearl:#f8fafc;
      --rm:#e74c3c;
      --fms:#3498db;
      --psc:#9b59b6;
      --ipc:#e91e63;
      --qi:#2ecc71;
      --eoc:#f39c12;
    }

    * { box-sizing:border-box; }

    body{
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(ellipse at 20% 10%, rgba(212,175,55,.08) 0%, transparent 50%),
                  radial-gradient(ellipse at 80% 60%, rgba(125,0,36,.06) 0%, transparent 50%),
                  linear-gradient(135deg, #2a0b14 0%, #18060a 55%, #110306 100%);
      color: var(--pearl);
      min-height: 100vh;
    }

    h1,h2,h3,h4,h5{font-family:'Cairo',Tajawal,Arial;letter-spacing:.2px}

    .navbar{
      background: linear-gradient(135deg, var(--crimson), var(--crimson-2));
      border-bottom: 2px solid var(--gold);
      box-shadow:0 10px 30px rgba(0,0,0,.5);
    }

    .brand{
      display:flex;align-items:center;gap:.75rem;color:#fff;text-decoration:none
    }
    .brand img{
      width:48px;height:48px;border-radius:50%;background:#fff;object-fit:cover;
      box-shadow:0 0 0 3px rgba(212,175,55,.4)
    }
    .brand span{font-family:'Cairo';font-weight:800}

    .committee-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .tabbar{
      background: rgba(255,255,255,.08);
      border-bottom: 1px solid rgba(255,255,255,.2);
      backdrop-filter: blur(8px);
    }

    .tabbar .nav-link{
      color:rgba(255,255,255,0.85);
      border:none;
      border-bottom:3px solid transparent;
      border-radius:8px 8px 0 0;
      font-weight:700;
      padding:10px 18px;
      transition:all .25s ease;
    }
    .tabbar .nav-link:hover{
      background:rgba(255,255,255,0.08);
      color:#fff;
    }
    .tabbar .nav-link.active{
      border-color:var(--gold);
      background:rgba(212,175,55,0.18);
      color:#fff;
    }

    .card-glass{
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:20px;
      box-shadow:0 14px 32px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }

    .kpi{
      padding:20px;
      border-radius:18px;
      border:1px solid transparent;
    }
    .kpi-icon{
      width:44px;height:44px;
      border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-size:1.4rem;
      margin-bottom:10px;
      background:rgba(0,0,0,0.2);
    }
    .kpi .value{
      font-family:'Cairo';
      font-size:40px;
      font-weight:900;
      line-height:1.1;
    }
    .kpi .hint{color:var(--muted);font-size:.85rem;}

    .kpi.emerald{background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(15,23,42,0.8));border-color:rgba(16,185,129,0.7);}
    .kpi.emerald .value{color:#bbf7d0;}
    .kpi.ruby{background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(15,23,42,0.8));border-color:rgba(239,68,68,0.7);}
    .kpi.ruby .value{color:#fecaca;}
    .kpi.sapphire{background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(15,23,42,0.8));border-color:rgba(59,130,246,0.6);}
    .kpi.sapphire .value{color:#bfdbfe;}
    .kpi.amber{background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(15,23,42,0.8));border-color:rgba(245,158,11,0.7);}
    .kpi.amber .value{color:#fef3c7;}

    .member-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .member-card:hover {
      background: rgba(255,255,255,0.12);
    }
    .member-card.selected {
      background: rgba(16,185,129,0.2);
      border-color: rgba(16,185,129,0.6);
    }
    .member-card .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold), #f5d86c);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #331a00;
    }
    .member-card .check-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: auto;
    }
    .member-card.selected .check-icon {
      background: var(--emerald);
      border-color: var(--emerald);
    }

    .recommendation-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 20px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.2);
      cursor: pointer;
      transition: all 0.2s;
      margin: 4px;
    }
    .recommendation-chip:hover {
      background: rgba(255,255,255,0.15);
    }
    .recommendation-chip.selected {
      background: rgba(212,175,55,0.25);
      border-color: var(--gold);
    }

    .schedule-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
    }
    .schedule-card.current {
      border-color: var(--amber);
      box-shadow: 0 0 20px rgba(245,158,11,0.3);
      background: rgba(245,158,11,0.1);
    }
    .schedule-card.completed {
      border-color: var(--emerald);
      background: rgba(16,185,129,0.15);
    }
    .schedule-card.missed {
      border-color: var(--ruby);
      background: rgba(239,68,68,0.15);
    }
    .schedule-card.future {
      border-color: var(--sapphire);
      background: rgba(59,130,246,0.08);
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
    }
    .progress-segment {
      height: 100%;
      transition: width 0.5s ease;
    }
    .progress-segment.completed { background: var(--emerald); }
    .progress-segment.missed { background: var(--ruby); }
    .progress-segment.future { background: var(--sapphire); }
    .progress-segment.current { background: var(--amber); }

    .status-legend {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 15px;
      font-size: 0.85rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .legend-dot.completed { background: var(--emerald); }
    .legend-dot.missed { background: var(--ruby); }
    .legend-dot.current { background: var(--amber); }
    .legend-dot.future { background: var(--sapphire); }

    .month-status-icon {
      margin-top: 10px;
      font-size: 1.2rem;
    }
    .month-status-text {
      font-size: 0.75rem;
      margin-top: 5px;
      color: var(--muted);
    }

    .quick-date-btn {
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .quick-date-btn:hover {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
      color: #fff;
    }
    .quick-date-btn.current-month {
      background: rgba(245,158,11,0.2);
      border-color: var(--amber);
      color: #fff;
    }

    .meeting-row {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .meeting-row:hover {
      background: rgba(255,255,255,0.1);
    }

    .btn-gold{
      background:linear-gradient(135deg,var(--gold),#f5d86c);
      color:#331a00;
      border:none;
      font-weight:800;
      border-radius:10px;
    }
    .btn-crimson{
      background:linear-gradient(135deg,var(--crimson),var(--crimson-2));
      border:none;
      color:#fff;
      border-radius:10px;
    }

    .form-control,.form-select{
      background:rgba(0,0,0,.45) !important;
      color:#f9fafb !important;
      border:1px solid rgba(255,255,255,.25) !important;
      border-radius:10px;
    }
    .form-control:focus,.form-select:focus{
      border-color:var(--gold) !important;
      box-shadow:0 0 0 3px rgba(212,175,55,.35) !important;
    }

    .quorum-indicator {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 700;
      text-align: center;
    }
    .quorum-indicator.met {
      background: rgba(16,185,129,0.2);
      border: 2px solid var(--emerald);
      color: #bbf7d0;
    }
    .quorum-indicator.not-met {
      background: rgba(239,68,68,0.2);
      border: 2px solid var(--ruby);
      color: #fecaca;
    }

    .recommendation-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .recommendation-status.open {
      background: rgba(245,158,11,0.2);
      color: #fbbf24;
    }
    .recommendation-status.closed {
      background: rgba(16,185,129,0.2);
      color: #34d399;
    }
    .recommendation-status.overdue {
      background: rgba(239,68,68,0.2);
      color: #f87171;
    }

    .committee-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      padding: 20px;
    }
    .committee-btn {
      padding: 12px 24px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    .committee-btn:hover {
      transform: translateY(-3px);
    }
    .committee-btn.active {
      border-color: var(--gold);
      box-shadow: 0 0 20px rgba(212,175,55,0.4);
    }

    .loading-spinner{
      display:inline-block;
      width:2rem;height:2rem;
      border:.25em solid currentColor;
      border-right-color:transparent;
      border-radius:50%;
      animation:spinner-border .75s linear infinite;
    }
    @keyframes spinner-border{to{transform:rotate(360deg);}}

    .chart-container{position:relative;height:220px;width:100%;}

    .toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="brand" href="mega.html">
      <img src="logo-new.png" alt="شعار">
      <span>نظام اجتماعات اللجان</span>
    </a>
    <div id="committeeBadge" class="committee-badge ms-3"></div>
    <div class="ms-auto d-flex gap-2">
      <button id="btnRefresh" class="btn btn-gold btn-sm">
        <i class="fa-solid fa-rotate ms-1"></i> تحديث
      </button>
    </div>
  </div>
</nav>

<section class="tabbar">
  <div class="container">
    <ul class="nav nav-tabs" id="tabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-home" type="button">
          <i class="fa-solid fa-home me-1"></i> الرئيسية
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-meeting" type="button">
          <i class="fa-solid fa-users me-1"></i> الاجتماع
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-delayed" type="button">
          <i class="fa-solid fa-clock me-1"></i> المتأخرة
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-recommendations" type="button">
          <i class="fa-solid fa-list-check me-1"></i> التوصيات
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-archive" type="button">
          <i class="fa-solid fa-archive me-1"></i> السجل
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button">
          <i class="fa-solid fa-chart-pie me-1"></i> Dashboard
        </button>
      </li>
    </ul>
  </div>
</section>

<div class="tab-content">
  <div id="tab-home" class="tab-pane fade show active">
    <div class="container py-4">
      <div id="committeeSelector" class="committee-selector mb-4">
        <button class="committee-btn" data-committee="RM" style="--comm-color: var(--rm);">
          <i class="fa-solid fa-exclamation-circle me-2"></i> إدارة المخاطر (RM)
        </button>
        <button class="committee-btn" data-committee="FMS" style="--comm-color: var(--fms);">
          <i class="fa-solid fa-building me-2"></i> السلامة والمرافق (FMS)
        </button>
        <button class="committee-btn" data-committee="PSC" style="--comm-color: var(--psc);">
          <i class="fa-solid fa-heart me-2"></i> سلامة المرضى (PSC)
        </button>
        <button class="committee-btn" data-committee="IPC" style="--comm-color: var(--ipc);">
          <i class="fa-solid fa-shield-virus me-2"></i> مكافحة العدوى (IPC)
        </button>
        <button class="committee-btn" data-committee="QI" style="--comm-color: var(--qi);">
          <i class="fa-solid fa-chart-line me-2"></i> الجودة والتحسين (QI)
        </button>
        <button class="committee-btn" data-committee="EOC" style="--comm-color: var(--eoc);">
          <i class="fa-solid fa-first-aid me-2"></i> الطوارئ والكوارث (EOC)
        </button>
        <button class="committee-btn" data-committee="EXEC" style="--comm-color: var(--gold);">
          <i class="fa-solid fa-crown me-2"></i> الإدارة العليا (EXEC)
        </button>
      </div>

      <div id="homeContent" class="d-none">
        <div class="row g-3 mb-4">
          <div class="col-6 col-lg-3">
            <div class="card-glass kpi emerald h-100">
              <div class="kpi-icon"><i class="fa-solid fa-check-circle"></i></div>
              <div class="hint">الاجتماعات المنجزة</div>
              <div id="kpiCompleted" class="value">0</div>
              <div class="hint">من <span id="kpiRequired">10</span> مطلوبة</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="card-glass kpi ruby h-100">
              <div class="kpi-icon"><i class="fa-solid fa-clock"></i></div>
              <div class="hint">الاجتماعات المتأخرة</div>
              <div id="kpiDelayed" class="value">0</div>
              <div class="hint">تجاوزت موعدها</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="card-glass kpi amber h-100">
              <div class="kpi-icon"><i class="fa-solid fa-list-check"></i></div>
              <div class="hint">التوصيات المفتوحة</div>
              <div id="kpiOpenRecs" class="value">0</div>
              <div class="hint">تحتاج متابعة</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="card-glass kpi sapphire h-100">
              <div class="kpi-icon"><i class="fa-solid fa-users"></i></div>
              <div class="hint">متوسط الحضور</div>
              <div id="kpiAttendance" class="value">0%</div>
              <div class="hint">نسبة الحضور</div>
            </div>
          </div>
        </div>

        <div class="card-glass p-4 mb-4">
          <h5 class="mb-3"><i class="fa-solid fa-calendar me-2"></i> جدول الاجتماعات السنوي <span id="currentYear">2025</span></h5>
          
          <div class="mb-4">
            <div class="d-flex justify-content-between mb-2">
              <span class="small">التقدم السنوي</span>
              <span id="progressText" class="small fw-bold">0 / 0</span>
            </div>
            <div class="progress-bar-container" id="yearProgressBar"></div>
            <div class="status-legend">
              <div class="legend-item"><div class="legend-dot completed"></div> تم الاجتماع</div>
              <div class="legend-item"><div class="legend-dot missed"></div> لم يتم</div>
              <div class="legend-item"><div class="legend-dot current"></div> جاري</div>
              <div class="legend-item"><div class="legend-dot future"></div> لم يحن الاستحقاق</div>
            </div>
          </div>
          
          <div id="scheduleGrid" class="row g-3"></div>
        </div>

        <div class="card-glass p-4">
          <h5 class="mb-3"><i class="fa-solid fa-users me-2"></i> أعضاء اللجنة</h5>
          <div id="membersPreview" class="row g-3"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-meeting" class="tab-pane fade">
    <div class="container py-4">
      <!-- رسالة اختيار اللجنة -->
      <div id="selectCommitteePrompt" class="card-glass p-5 text-center">
        <i class="fa-solid fa-hand-pointer fa-4x mb-4" style="color: var(--gold);"></i>
        <h3 class="mb-4">اختر اللجنة أولاً</h3>
        <p class="text-muted mb-4">يجب اختيار اللجنة لتسجيل الاجتماع</p>
        <div class="committee-selector mb-0">
          <button class="committee-btn meeting-comm-btn" data-committee="RM" style="--comm-color: var(--rm);">
            <i class="fa-solid fa-exclamation-circle me-2"></i> إدارة المخاطر
          </button>
          <button class="committee-btn meeting-comm-btn" data-committee="FMS" style="--comm-color: var(--fms);">
            <i class="fa-solid fa-building me-2"></i> السلامة والمرافق
          </button>
          <button class="committee-btn meeting-comm-btn" data-committee="PSC" style="--comm-color: var(--psc);">
            <i class="fa-solid fa-heart me-2"></i> سلامة المرضى
          </button>
          <button class="committee-btn meeting-comm-btn" data-committee="IPC" style="--comm-color: var(--ipc);">
            <i class="fa-solid fa-shield-virus me-2"></i> مكافحة العدوى
          </button>
          <button class="committee-btn meeting-comm-btn" data-committee="QI" style="--comm-color: var(--qi);">
            <i class="fa-solid fa-chart-line me-2"></i> الجودة والتحسين
          </button>
          <button class="committee-btn meeting-comm-btn" data-committee="EOC" style="--comm-color: var(--eoc);">
            <i class="fa-solid fa-first-aid me-2"></i> الطوارئ والكوارث
          </button>
          <button class="committee-btn meeting-comm-btn" data-committee="EXEC" style="--comm-color: var(--gold);">
            <i class="fa-solid fa-crown me-2"></i> الإدارة العليا
          </button>
        </div>
      </div>

      <!-- نموذج تسجيل الاجتماع (يظهر بعد اختيار اللجنة) -->
      <div id="meetingFormContainer" class="card-glass p-4 d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="fa-solid fa-users me-2"></i> تسجيل الاجتماع</h4>
          <div id="meetingDateBadge" class="badge bg-warning text-dark fs-6"></div>
        </div>

        <div class="row g-4">
          <div class="col-md-6">
            <label class="form-label"><i class="fa-solid fa-calendar me-1"></i> تاريخ الاجتماع</label>
            <div class="input-group">
              <input type="date" id="meetingDate" class="form-control" required>
              <button type="button" class="btn btn-outline-warning" onclick="document.getElementById('meetingDate').showPicker()">
                <i class="fa-solid fa-calendar-days"></i>
              </button>
            </div>
            <div id="quickDatePicker" class="mt-2 d-flex flex-wrap gap-2">
              <small class="text-muted w-100 mb-1">اختيار سريع:</small>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label"><i class="fa-solid fa-video me-1"></i> نوع الاجتماع</label>
            <select id="meetingType" class="form-select">
              <option value="حضوري">حضوري</option>
              <option value="زوم">عن بُعد (Zoom)</option>
              <option value="مختلط">مختلط</option>
            </select>
          </div>
          <div class="col-12" id="zoomLinkContainer" style="display:none;">
            <label class="form-label"><i class="fa-solid fa-link me-1"></i> رابط Zoom</label>
            <input type="url" id="zoomLink" class="form-control" placeholder="https://zoom.us/j/...">
          </div>
        </div>

        <hr class="my-4" style="border-color: rgba(255,255,255,0.2);">

        <h5 class="mb-3"><i class="fa-solid fa-user-check me-2"></i> تسجيل الحضور</h5>
        <div id="attendanceGrid" class="row g-3 mb-4"></div>
        
        <div id="quorumStatus" class="quorum-indicator not-met mb-4">
          <i class="fa-solid fa-exclamation-triangle me-2"></i>
          النصاب غير مكتمل (0 من 0)
        </div>

        <hr class="my-4" style="border-color: rgba(255,255,255,0.2);">

        <h5 class="mb-3"><i class="fa-solid fa-list-check me-2"></i> التوصيات</h5>
        <p class="text-muted small mb-3">انقر لاختيار التوصيات المطلوبة:</p>
        <div id="recommendationsGrid" class="mb-4"></div>
        
        <div class="mb-4">
          <label class="form-label"><i class="fa-solid fa-plus me-1"></i> توصية إضافية (اختياري)</label>
          <textarea id="customRecommendation" class="form-control" rows="2" placeholder="أضف توصية غير موجودة في القائمة..."></textarea>
        </div>

        <hr class="my-4" style="border-color: rgba(255,255,255,0.2);">

        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label class="form-label"><i class="fa-solid fa-user me-1"></i> المقرر</label>
            <select id="recorderName" class="form-select" required>
              <option value="">— اختر المقرر —</option>
            </select>
          </div>
        </div>

        <div class="d-grid gap-2">
          <button id="btnSaveMeeting" class="btn btn-gold btn-lg" disabled>
            <i class="fa-solid fa-save me-2"></i> حفظ وإغلاق الاجتماع
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-delayed" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-4">
        <h4 class="mb-4"><i class="fa-solid fa-clock me-2" style="color: var(--ruby);"></i> الاجتماعات المتأخرة</h4>
        <div id="delayedList"></div>
        <div id="noDelayed" class="text-center py-5 text-muted d-none">
          <i class="fa-solid fa-check-circle fa-3x mb-3" style="color: var(--emerald);"></i>
          <p class="fs-5">ممتاز! لا توجد اجتماعات متأخرة</p>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-recommendations" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="fa-solid fa-list-check me-2"></i> متابعة التوصيات</h4>
          <select id="recFilter" class="form-select" style="width: auto;">
            <option value="all">جميع التوصيات</option>
            <option value="open">مفتوحة</option>
            <option value="closed">مغلقة</option>
            <option value="overdue">متأخرة</option>
          </select>
        </div>
        <div id="recommendationsList"></div>
      </div>
    </div>
  </div>

  <div id="tab-archive" class="tab-pane fade">
    <div class="container py-4">
      <div class="card-glass p-4 mb-4">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">السنة</label>
            <select id="archiveYear" class="form-select">
              <option value="2025">2025</option>
              <option value="2024">2024</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">الفترة</label>
            <select id="archivePeriod" class="form-select">
              <option value="">كل السنة</option>
              <option value="1">آخر شهر</option>
              <option value="2">آخر شهرين</option>
              <option value="3">آخر 3 شهور</option>
              <option value="6">آخر 6 شهور</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">الحالة</label>
            <select id="archiveStatus" class="form-select">
              <option value="">الكل</option>
              <option value="completed">مكتمل</option>
              <option value="delayed">متأخر</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end gap-2">
            <button id="btnSearchArchive" class="btn btn-gold flex-grow-1">
              <i class="fa-solid fa-search me-1"></i> بحث
            </button>
            <button id="btnPrintArchive" class="btn btn-crimson" title="طباعة التقرير">
              <i class="fa-solid fa-print"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="card-glass p-4">
        <div id="archiveList"></div>
      </div>
    </div>
  </div>

  <div id="tab-dashboard" class="tab-pane fade">
    <div class="container py-4">
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card-glass p-4 h-100">
            <h5 class="mb-3"><i class="fa-solid fa-chart-bar me-2"></i> الإنجاز حسب اللجنة</h5>
            <div class="chart-container"><canvas id="chartCommittees"></canvas></div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card-glass p-4 h-100">
            <h5 class="mb-3"><i class="fa-solid fa-chart-pie me-2"></i> حالة التوصيات</h5>
            <div class="chart-container"><canvas id="chartRecommendations"></canvas></div>
          </div>
        </div>
        <div class="col-12">
          <div class="card-glass p-4">
            <h5 class="mb-3"><i class="fa-solid fa-chart-line me-2"></i> نسبة الحضور الشهرية</h5>
            <div class="chart-container" style="height: 280px;"><canvas id="chartAttendance"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="modal fade" id="successModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background: linear-gradient(135deg, #1a0b10, #2a0b14); border: 2px solid var(--emerald);">
      <div class="modal-body text-center py-5">
        <i class="fa-solid fa-check-circle fa-5x mb-4" style="color: var(--emerald);"></i>
        <h3 class="mb-3">تم حفظ الاجتماع بنجاح!</h3>
        <p class="text-muted">تم تسجيل الاجتماع والتوصيات</p>
        <button class="btn btn-gold mt-3" data-bs-dismiss="modal">إغلاق</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const COMMITTEES = {
  RM: {
    name: 'إدارة المخاطر',
    nameEn: 'Risk Management',
    icon: 'fa-exclamation-circle',
    color: '#e74c3c',
    frequency: 'شهري',
    required: 10,
    quorum: 3,
    members: [
      { name: 'د. حسين بابصيل', role: 'رئيس', isChair: true },
      { name: 'أ. عدنان الرفاعي', role: 'منسق/سكرتير', isSecretary: true },
      { name: 'أ. بلال نتو', role: 'عضو' },
      { name: 'أ. صابر عبده', role: 'عضو' },
      { name: 'د. معاذ البيوش', role: 'عضو' },
      { name: 'د. خالد الخطيب', role: 'عضو' }
    ],
    recommendations: [
      'تحليل حادثة متكررة',
      'تحديث سجل المخاطر',
      'تدريب توعوي للموظفين',
      'مراجعة إجراءات السلامة',
      'إضافة خطر جديد للسجل',
      'إغلاق خطر تمت معالجته',
      'تشكيل فريق تحقيق RCA',
      'رفع تقرير للإدارة العليا'
    ]
  },
  FMS: {
    name: 'السلامة والمرافق',
    nameEn: 'Facility Management & Safety',
    icon: 'fa-building',
    color: '#3498db',
    frequency: 'شهري',
    required: 10,
    quorum: 3,
    members: [
      { name: 'أ. صابر عبده', role: 'رئيس', isChair: true },
      { name: 'أ. بلال نتو', role: 'منسق التدريب' },
      { name: 'أ. عدنان الرفاعي', role: 'عضو' },
      { name: 'د. خالد الخطيب', role: 'عضو' },
      { name: 'مندوب الأمن', role: 'عضو' }
    ],
    recommendations: [
      'صيانة تصحيحية عاجلة',
      'مراجعة خطة الإخلاء',
      'تدقيق أنظمة الغازات الطبية',
      'فحص معدات الإطفاء',
      'صيانة وقائية مجدولة',
      'تحديث سجل المعايرة',
      'تدريب على السلامة من الحريق',
      'مراجعة نظام التكييف HVAC'
    ]
  },
  PSC: {
    name: 'سلامة المرضى',
    nameEn: 'Patient Safety Committee',
    icon: 'fa-heart',
    color: '#9b59b6',
    frequency: 'شهري',
    required: 10,
    quorum: 3,
    members: [
      { name: 'د. معاذ البيوش', role: 'رئيس', isChair: true },
      { name: 'د. خالد الخطيب', role: 'نائب الرئيس' },
      { name: 'د. حسين بابصيل', role: 'عضو' },
      { name: 'أ. هيثم الجعلي', role: 'عضو' },
      { name: 'أ. بلال نتو', role: 'عضو' },
      { name: 'أ. عدنان الرفاعي', role: 'سكرتير', isSecretary: true }
    ],
    recommendations: [
      'تحسين عملية التعرف على المريض',
      'مراجعة مؤشرات السلامة',
      'تحليل حادثة سقوط',
      'تدريب على أهداف IPSG',
      'مراجعة بروتوكول الأدوية عالية الخطورة',
      'تحسين التواصل بين الفرق',
      'مراجعة حالات Near Miss',
      'تحديث سياسة التوثيق'
    ]
  },
  IPC: {
    name: 'مكافحة العدوى',
    nameEn: 'Infection Prevention & Control',
    icon: 'fa-shield-virus',
    color: '#e91e63',
    frequency: 'شهري',
    required: 10,
    quorum: 3,
    members: [
      { name: 'د. مجدي عسكر', role: 'رئيس', isChair: true },
      { name: 'د. خالد الخطيب', role: 'عضو' },
      { name: 'ممثل التمريض', role: 'عضو' },
      { name: 'ممثل المختبر', role: 'عضو' },
      { name: 'ممثل التعقيم', role: 'عضو' },
      { name: 'أ. عدنان الرفاعي', role: 'سكرتير', isSecretary: true }
    ],
    recommendations: [
      'حملة نظافة اليدين',
      'مراجعة تقارير العدوى',
      'تدريب على العزل',
      'تحديث بروتوكول التعقيم',
      'مراجعة حالات التعرض الوخزي',
      'تدقيق ممارسات التطهير',
      'مراجعة مخزون معدات الوقاية',
      'تحديث خطة مكافحة الأوبئة'
    ]
  },
  QI: {
    name: 'الجودة والتحسين',
    nameEn: 'Quality Improvement',
    icon: 'fa-chart-line',
    color: '#2ecc71',
    frequency: 'ربع سنوي',
    required: 4,
    quorum: 3,
    members: [
      { name: 'د. حسين بابصيل', role: 'رئيس', isChair: true },
      { name: 'ممثلين الأقسام', role: 'أعضاء' },
      { name: 'أ. عدنان الرفاعي', role: 'سكرتير', isSecretary: true }
    ],
    recommendations: [
      'إطلاق مشروع تحسين',
      'تحليل مؤشر جودة',
      'مراجعة نتائج KPIs',
      'تقييم رضا المرضى',
      'دراسة Benchmark',
      'تحديث خطة الجودة السنوية',
      'مراجعة الإجراءات المعيارية',
      'إعداد تقرير ربع سنوي'
    ]
  },
  EOC: {
    name: 'الطوارئ والكوارث',
    nameEn: 'Emergency Operations',
    icon: 'fa-first-aid',
    color: '#f39c12',
    frequency: 'نصف سنوي',
    required: 2,
    quorum: 3,
    members: [
      { name: 'أ. بلال نتو', role: 'رئيس', isChair: true },
      { name: 'أ. صابر عبده', role: 'عضو' },
      { name: 'د. معاذ البيوش', role: 'عضو' },
      { name: 'د. خالد الخطيب', role: 'عضو' },
      { name: 'ممثل الأمن', role: 'عضو' },
      { name: 'ممثل التمريض', role: 'عضو' }
    ],
    recommendations: [
      'تنفيذ تمرين إخلاء',
      'مراجعة خطة الطوارئ',
      'تحديث بيانات الاتصال',
      'فحص معدات الطوارئ',
      'تدريب على الاستجابة للكوارث',
      'مراجعة خطة استمرارية العمل',
      'تحديث خريطة الإخلاء',
      'تقييم جاهزية الفريق'
    ]
  },
  EXEC: {
    name: 'الإدارة العليا',
    nameEn: 'Executive Management',
    icon: 'fa-crown',
    color: '#d4af37',
    frequency: 'شهري',
    required: 12,
    quorum: 4,
    members: [
      { name: 'د. حسين بابصيل', role: 'المدير الطبي / رئيس', isChair: true },
      { name: 'أ. عدنان الرفاعي', role: 'مسؤول الجودة / سكرتير', isSecretary: true },
      { name: 'أ. صابر عبده', role: 'رئيس لجنة FMS' },
      { name: 'د. معاذ البيوش', role: 'رئيس لجنة PSC' },
      { name: 'أ. هيثم الجعلي', role: 'رئيس لجنة IPC' },
      { name: 'أ. بلال نتو', role: 'رئيس لجنة EOC' }
    ],
    recommendations: [
      'مراجعة تقارير اللجان الفرعية',
      'اعتماد قرارات اللجان',
      'مراجعة مؤشرات الأداء الشاملة',
      'مناقشة التحديات والمخاطر الاستراتيجية',
      'اعتماد الميزانيات والموارد',
      'مراجعة خطة التدريب السنوية',
      'متابعة مشاريع التحسين',
      'إعداد تقرير للجهات الرقابية',
      'مراجعة شكاوى واقتراحات المرضى',
      'تقييم الاستعداد للاعتماد'
    ]
  }
};

const API_URL = 'https://script.google.com/macros/s/AKfycbz-vImcmRIh0M86i44V5Rm1C0m23lrN4q1aql9R7HNfQZUgShVyg7JlYlD5xLK2H9Gurg/exec';

let currentCommittee = null;
let selectedMembers = new Set();
let selectedRecommendations = new Set();
let meetingsData = [];
let recommendationsData = [];

async function apiCall(action, payload = {}) {
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      redirect: 'follow',
      body: JSON.stringify({ action, payload })
    });
    const result = await response.json();
    if (!result.ok) throw new Error(result.error || 'API Error');
    return result;
  } catch (err) {
    console.error('API Error:', err);
    throw err;
  }
}

document.querySelectorAll('.committee-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    selectCommittee(btn.dataset.committee);
  });
});

document.querySelectorAll('.meeting-comm-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    selectCommittee(btn.dataset.committee);
  });
});

document.getElementById('meetingType').addEventListener('change', (e) => {
  document.getElementById('zoomLinkContainer').style.display = 
    e.target.value === 'زوم' || e.target.value === 'مختلط' ? 'block' : 'none';
});

document.getElementById('btnRefresh').addEventListener('click', () => {
  if (currentCommittee) loadCommitteeData(currentCommittee);
});

document.getElementById('btnSaveMeeting').addEventListener('click', saveMeeting);

function selectCommittee(code) {
  currentCommittee = code;
  const comm = COMMITTEES[code];
  
  document.querySelectorAll('.committee-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.meeting-comm-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll(`[data-committee="${code}"]`).forEach(b => b.classList.add('active'));
  
  document.getElementById('committeeBadge').innerHTML = `
    <span style="background: ${comm.color}; padding: 8px 16px; border-radius: 20px;">
      <i class="fa-solid ${comm.icon} me-2"></i> ${comm.name} (${code})
    </span>
  `;
  
  document.getElementById('homeContent').classList.remove('d-none');
  document.getElementById('kpiRequired').textContent = comm.required;
  document.getElementById('currentYear').textContent = new Date().getFullYear();
  
  document.getElementById('selectCommitteePrompt').classList.add('d-none');
  document.getElementById('meetingFormContainer').classList.remove('d-none');
  
  renderScheduleGrid(comm, []);
  renderMembersPreview(comm);
  renderAttendanceGrid(comm);
  renderRecommendationsGrid(comm);
  renderRecorderOptions(comm);
  renderQuickDatePicker(comm);
  
  loadCommitteeData(code);
}

function renderQuickDatePicker(comm) {
  const container = document.getElementById('quickDatePicker');
  const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                  'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
  
  let meetingMonths = [];
  if (comm.frequency === 'شهري') {
    meetingMonths = [0, 1, 2, 3, 4, 5, 6, 8, 9, 10];
  } else if (comm.frequency === 'ربع سنوي') {
    meetingMonths = [2, 5, 8, 11];
  } else {
    meetingMonths = [5, 11];
  }
  
  const currentMonth = new Date().getMonth();
  const currentYear = new Date().getFullYear();
  
  let html = '<small class="text-muted w-100 mb-1">اختيار سريع:</small>';
  
  meetingMonths.filter(m => m <= currentMonth).forEach(m => {
    const isCurrentMonth = m === currentMonth;
    const day = 15;
    const dateStr = `${currentYear}-${String(m + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    html += `
      <button type="button" class="quick-date-btn ${isCurrentMonth ? 'current-month' : ''}" 
              onclick="setQuickDate('${dateStr}')">
        ${months[m]}
      </button>
    `;
  });
  
  html += `
    <button type="button" class="quick-date-btn" style="background: rgba(59,130,246,0.2); border-color: var(--sapphire);"
            onclick="document.getElementById('meetingDate').showPicker()">
      <i class="fa-solid fa-calendar-plus me-1"></i> تاريخ آخر
    </button>
  `;
  
  container.innerHTML = html;
}

function setQuickDate(dateStr) {
  document.getElementById('meetingDate').value = dateStr;
}

let completedMeetingMonths = [];
let meetingsPerMonth = {}; // عدد الاجتماعات لكل شهر

function renderScheduleGrid(comm, completedMonths = [], monthCounts = {}, monthDates = {}) {
  const grid = document.getElementById('scheduleGrid');
  const progressBar = document.getElementById('yearProgressBar');
  const progressText = document.getElementById('progressText');
  
  meetingsPerMonth = monthCounts;
  
  const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                  'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
  
  let meetingMonths = [];
  if (comm.frequency === 'شهري') {
    meetingMonths = [0, 1, 2, 3, 4, 5, 6, 8, 9, 10];
  } else if (comm.frequency === 'ربع سنوي') {
    meetingMonths = [2, 5, 8, 11];
  } else {
    meetingMonths = [5, 11];
  }
  
  const currentMonth = new Date().getMonth();
  const total = meetingMonths.length;
  
  let completedCount = 0;
  let missedCount = 0;
  let currentCount = 0;
  let futureCount = 0;
  let exceptionalCount = 0;
  
  let cardsHtml = '';
  
  meetingMonths.forEach((m, idx) => {
    const isCompleted = completedMonths.includes(m);
    const monthMeetingCount = monthCounts[m] || 0;
    const hasExceptional = monthMeetingCount > 1;
    
    let status = '';
    let icon = '';
    let statusText = '';
    
    if (isCompleted) {
      status = 'completed';
      icon = '<i class="fa-solid fa-check-circle month-status-icon" style="color: var(--emerald);"></i>';
      statusText = 'تم الاجتماع';
      completedCount++;
    } else if (m < currentMonth) {
      status = 'missed';
      icon = '<i class="fa-solid fa-times-circle month-status-icon" style="color: var(--ruby);"></i>';
      statusText = 'لم يتم';
      missedCount++;
    } else if (m === currentMonth) {
      status = 'current';
      icon = '<i class="fa-solid fa-clock month-status-icon" style="color: var(--amber);"></i>';
      statusText = 'جاري';
      currentCount++;
    } else {
      status = 'future';
      icon = '<i class="fa-solid fa-hourglass-start month-status-icon" style="color: var(--sapphire);"></i>';
      statusText = 'لم يحن الاستحقاق';
      futureCount++;
    }
    
    cardsHtml += `
      <div class="col-6 col-md-4 col-lg-2">
        <div class="schedule-card ${status}">
          <div class="fs-5 fw-bold">${months[m]}</div>
          <div class="small text-muted">اجتماع ${idx + 1}</div>
          ${icon}
          <div class="month-status-text">${statusText}</div>
        </div>
      </div>
    `;
    
    // إضافة عدد الاجتماعات الإضافية في نفس الشهر
    if (hasExceptional) {
      const extraMeetings = monthMeetingCount - 1;
      exceptionalCount += extraMeetings;
    }
  });
  
  // إضافة مربعات للأشهر الاستثنائية (خارج الجدول)
  const exceptionalMonthsHtml = [];
  for (const [monthStr, count] of Object.entries(monthCounts)) {
    const m = parseInt(monthStr);
    if (!meetingMonths.includes(m)) {
      // هذا شهر خارج الجدول = كل اجتماعاته استثنائية
      const dates = (monthDates[m] || []).join(' | ');
      exceptionalCount += count;
      exceptionalMonthsHtml.push(`
        <div class="col-6 col-md-4 col-lg-2">
          <div class="schedule-card" style="border-color: #22c55e; background: rgba(34,197,94,0.2); box-shadow: 0 0 15px rgba(34,197,94,0.3);">
            <div class="fs-5 fw-bold" style="color: #86efac;">${months[m]}</div>
            <div class="small" style="color: #22c55e;">اجتماع استثنائي</div>
            <div class="badge bg-success mt-2" style="font-size: 1.1rem;">${count}</div>
            <div class="month-status-text" style="color: #86efac; font-size: 0.7rem;">${dates || 'استثنائي'}</div>
          </div>
        </div>
      `);
    }
  }
  
  grid.innerHTML = cardsHtml + exceptionalMonthsHtml.join('');
  
  const completedPct = (completedCount / total) * 100;
  const missedPct = (missedCount / total) * 100;
  const currentPct = (currentCount / total) * 100;
  const futurePct = (futureCount / total) * 100;
  
  progressBar.innerHTML = `
    <div class="progress-segment completed" style="width: ${completedPct}%"></div>
    <div class="progress-segment missed" style="width: ${missedPct}%"></div>
    <div class="progress-segment current" style="width: ${currentPct}%"></div>
    <div class="progress-segment future" style="width: ${futurePct}%"></div>
  `;
  
  const totalWithExceptional = completedCount + exceptionalCount;
  progressText.textContent = `${totalWithExceptional} / ${total} اجتماع${exceptionalCount > 0 ? ` (${exceptionalCount} استثنائي)` : ''}`;
}

function renderMembersPreview(comm) {
  const container = document.getElementById('membersPreview');
  container.innerHTML = comm.members.map(m => `
    <div class="col-6 col-md-4 col-lg-3">
      <div class="member-card">
        <div class="avatar">${m.name.charAt(0)}</div>
        <div>
          <div class="fw-bold">${m.name}</div>
          <div class="small text-muted">${m.role}</div>
        </div>
        ${m.isChair ? '<img src="logo-new.png" alt="رئيس" class="ms-auto" style="width: 28px; height: 28px; border-radius: 50%;">' : ''}
      </div>
    </div>
  `).join('');
}

function renderAttendanceGrid(comm) {
  const grid = document.getElementById('attendanceGrid');
  selectedMembers.clear();
  
  grid.innerHTML = comm.members.map((m, idx) => `
    <div class="col-6 col-md-4">
      <div class="member-card" data-member="${idx}" onclick="toggleMember(${idx})">
        <div class="avatar">${m.name.charAt(0)}</div>
        <div>
          <div class="fw-bold">${m.name}</div>
          <div class="small text-muted">${m.role}</div>
        </div>
        <div class="check-icon">
          <i class="fa-solid fa-check" style="display: none;"></i>
        </div>
      </div>
    </div>
  `).join('');
  
  updateQuorumStatus();
}

function toggleMember(idx) {
  const card = document.querySelector(`[data-member="${idx}"]`);
  const icon = card.querySelector('.fa-check');
  
  if (selectedMembers.has(idx)) {
    selectedMembers.delete(idx);
    card.classList.remove('selected');
    icon.style.display = 'none';
  } else {
    selectedMembers.add(idx);
    card.classList.add('selected');
    icon.style.display = 'block';
  }
  
  updateQuorumStatus();
}

function updateQuorumStatus() {
  const comm = COMMITTEES[currentCommittee];
  const count = selectedMembers.size;
  const required = comm.quorum;
  const total = comm.members.length;
  
  const status = document.getElementById('quorumStatus');
  const saveBtn = document.getElementById('btnSaveMeeting');
  
  if (count >= required) {
    status.className = 'quorum-indicator met';
    status.innerHTML = `<i class="fa-solid fa-check-circle me-2"></i> النصاب مكتمل (${count} من ${total})`;
    saveBtn.disabled = false;
  } else {
    status.className = 'quorum-indicator not-met';
    status.innerHTML = `<i class="fa-solid fa-exclamation-triangle me-2"></i> النصاب غير مكتمل (${count} من ${total}) - مطلوب ${required} على الأقل`;
    saveBtn.disabled = true;
  }
}

function renderRecommendationsGrid(comm) {
  const grid = document.getElementById('recommendationsGrid');
  selectedRecommendations.clear();
  
  grid.innerHTML = comm.recommendations.map((rec, idx) => `
    <span class="recommendation-chip" data-rec="${idx}" onclick="toggleRecommendation(${idx})">
      <i class="fa-solid fa-circle-check" style="display: none; color: var(--gold);"></i>
      <i class="fa-regular fa-circle"></i>
      ${rec}
    </span>
  `).join('');
}

function toggleRecommendation(idx) {
  const chip = document.querySelector(`[data-rec="${idx}"]`);
  const checkIcon = chip.querySelector('.fa-circle-check');
  const emptyIcon = chip.querySelector('.fa-circle');
  
  if (selectedRecommendations.has(idx)) {
    selectedRecommendations.delete(idx);
    chip.classList.remove('selected');
    checkIcon.style.display = 'none';
    emptyIcon.style.display = 'inline';
  } else {
    selectedRecommendations.add(idx);
    chip.classList.add('selected');
    checkIcon.style.display = 'inline';
    emptyIcon.style.display = 'none';
  }
}

function renderRecorderOptions(comm) {
  const select = document.getElementById('recorderName');
  select.innerHTML = '<option value="">— اختر المقرر —</option>' +
    comm.members.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
}

async function loadCommitteeData(code) {
  showToast('جاري تحميل البيانات...', 'info');
  const comm = COMMITTEES[code];
  
  try {
    const data = await apiCall('getMeetingData', { committee: code });
    
    document.getElementById('kpiCompleted').textContent = data.completed || 0;
    document.getElementById('kpiDelayed').textContent = data.delayed || 0;
    document.getElementById('kpiOpenRecs').textContent = data.openRecommendations || 0;
    document.getElementById('kpiAttendance').textContent = (data.avgAttendance || 0) + '%';
    
    meetingsData = data.meetings || [];
    
    completedMeetingMonths = [];
    const monthCounts = {}; // عدد الاجتماعات لكل شهر
    const monthDates = {}; // تواريخ الاجتماعات لكل شهر
    
    if (meetingsData.length > 0) {
      const currentYear = new Date().getFullYear();
      meetingsData.forEach(m => {
        if (m.date) {
          const meetingDate = new Date(m.date);
          if (meetingDate.getFullYear() === currentYear) {
            const month = meetingDate.getMonth();
            if (!completedMeetingMonths.includes(month)) {
              completedMeetingMonths.push(month);
            }
            monthCounts[month] = (monthCounts[month] || 0) + 1;
            // حفظ التاريخ
            if (!monthDates[month]) monthDates[month] = [];
            const day = meetingDate.getDate();
            monthDates[month].push(day);
          }
        }
      });
    }
    
    renderScheduleGrid(comm, completedMeetingMonths, monthCounts, monthDates);
    
    showToast('تم تحميل البيانات بنجاح', 'success');
  } catch (err) {
    console.error('Load error:', err);
    document.getElementById('kpiCompleted').textContent = '0';
    document.getElementById('kpiDelayed').textContent = '0';
    document.getElementById('kpiOpenRecs').textContent = '0';
    document.getElementById('kpiAttendance').textContent = '0%';
    
    renderScheduleGrid(comm, []);
  }
  
  loadDelayedMeetings(code);
  loadRecommendationsData(code);
}

async function loadDelayedMeetings(code) {
  try {
    const data = await apiCall('getDelayedMeetings', { committee: code });
    const list = document.getElementById('delayedList');
    const noDelayed = document.getElementById('noDelayed');
    
    if (!data.delayed || data.delayed.length === 0) {
      list.innerHTML = '';
      noDelayed.classList.remove('d-none');
    } else {
      noDelayed.classList.add('d-none');
      list.innerHTML = data.delayed.map(d => `
        <div class="meeting-row">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="fw-bold" style="color: ${COMMITTEES[d.committee]?.color || '#fff'};">
                <i class="fa-solid ${COMMITTEES[d.committee]?.icon || 'fa-users'} me-2"></i>
                ${d.committeeName}
              </span>
              <div class="small text-muted mt-1">
                مكتمل: ${d.completed} | مطلوب: ${d.required} | متأخر: ${d.delayed}
              </div>
            </div>
            <div class="text-end">
              <span class="badge bg-danger">${d.delayed} متأخر</span>
              <div class="small text-muted mt-1">آخر اجتماع: ${d.lastMeeting}</div>
            </div>
          </div>
        </div>
      `).join('');
    }
  } catch (err) {
    console.error('Delayed error:', err);
  }
}

async function loadRecommendationsData(code) {
  try {
    const data = await apiCall('getMeetingRecommendations', { committee: code });
    recommendationsData = data.recommendations || [];
    renderRecommendationsList();
  } catch (err) {
    console.error('Recommendations error:', err);
  }
}

function renderRecommendationsList(filter = 'all') {
  const list = document.getElementById('recommendationsList');
  
  let filtered = recommendationsData;
  if (filter === 'open') filtered = recommendationsData.filter(r => r.status.toLowerCase() !== 'closed');
  if (filter === 'closed') filtered = recommendationsData.filter(r => r.status.toLowerCase() === 'closed');
  if (filter === 'overdue') filtered = recommendationsData.filter(r => {
    if (r.status.toLowerCase() === 'closed') return false;
    if (!r.dueDate) return false;
    return new Date(r.dueDate) < new Date();
  });
  
  if (filtered.length === 0) {
    list.innerHTML = '<div class="text-center py-4 text-muted">لا توجد توصيات</div>';
    return;
  }
  
  list.innerHTML = filtered.map(r => {
    let statusClass = 'open';
    let statusText = 'مفتوحة';
    if (r.status.toLowerCase() === 'closed') {
      statusClass = 'closed';
      statusText = 'مغلقة';
    } else if (r.dueDate && new Date(r.dueDate) < new Date()) {
      statusClass = 'overdue';
      statusText = 'متأخرة';
    }
    
    return `
      <div class="meeting-row">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-bold">${r.recommendation}</div>
            <div class="small text-muted mt-1">
              <i class="fa-solid fa-calendar me-1"></i> ${r.meetingDate || 'غير محدد'}
              ${r.assignedTo ? `<span class="ms-3"><i class="fa-solid fa-user me-1"></i> ${r.assignedTo}</span>` : ''}
            </div>
          </div>
          <div class="text-end">
            <span class="recommendation-status ${statusClass}">${statusText}</span>
            ${r.status.toLowerCase() !== 'closed' ? `
              <button class="btn btn-sm btn-outline-success mt-2" onclick="closeRecommendation(${r.rowIndex})">
                <i class="fa-solid fa-check"></i> إغلاق
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

async function closeRecommendation(rowIndex) {
  const recorder = prompt('اسم من أغلق التوصية:');
  if (!recorder) return;
  
  try {
    await apiCall('closeMeetingRecommendation', { rowIndex, closedBy: recorder });
    showToast('تم إغلاق التوصية', 'success');
    loadRecommendationsData(currentCommittee);
  } catch (err) {
    showToast('فشل إغلاق التوصية', 'error');
  }
}

document.getElementById('recFilter').addEventListener('change', (e) => {
  renderRecommendationsList(e.target.value);
});

// Archive Functions
let archiveData = [];

async function loadArchiveData() {
  const year = document.getElementById('archiveYear').value;
  const period = document.getElementById('archivePeriod').value;
  const status = document.getElementById('archiveStatus').value;
  const container = document.getElementById('archiveList');
  
  container.innerHTML = '<div class="text-center py-5"><div class="loading-spinner"></div><p class="mt-2">جاري تحميل السجل...</p></div>';
  
  try {
    const result = await apiCall('getMeetingsArchive', { 
      committee: currentCommittee || '', 
      year: year,
      period: period,
      status: status
    });
    
    archiveData = result.meetings || [];
    renderArchiveList();
  } catch (err) {
    console.error('Archive error:', err);
    container.innerHTML = `<div class="text-center py-5 text-danger"><i class="fa-solid fa-exclamation-triangle fa-3x mb-3"></i><p>خطأ في تحميل البيانات</p></div>`;
  }
}

function renderArchiveList() {
  const container = document.getElementById('archiveList');
  
  if (!archiveData || archiveData.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5 text-muted">
        <i class="fa-solid fa-inbox fa-3x mb-3"></i>
        <p class="fs-5">لا توجد اجتماعات مسجلة</p>
      </div>`;
    return;
  }
  
  let html = '';
  archiveData.forEach(meeting => {
    const comm = COMMITTEES[meeting.committee] || {};
    const statusClass = meeting.status === 'completed' ? 'emerald' : 'ruby';
    const statusText = meeting.status === 'completed' ? 'مكتمل' : 'متأخر';
    const attendeesList = meeting.attendees ? meeting.attendees.split(',').join(' • ') : '-';
    
    html += `
      <div class="meeting-row">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="badge" style="background: ${comm.color || '#666'};">${comm.name || meeting.committee}</span>
            <span class="ms-2 fw-bold">${meeting.date}</span>
            <span class="ms-2 small text-muted">(${meeting.type || 'حضوري'})</span>
          </div>
          <span class="badge" style="background: var(--${statusClass});">${statusText}</span>
        </div>
        <div class="mt-2 small">
          <div class="text-muted mb-1">
            <i class="fa-solid fa-users me-1"></i> الحضور (${meeting.attendeesCount || 0}): 
            <span class="text-light">${attendeesList}</span>
          </div>
          ${meeting.recommendations ? `<div class="text-muted"><i class="fa-solid fa-list-check me-1"></i> التوصيات: ${meeting.recommendationsCount || 0}</div>` : ''}
        </div>
      </div>`;
  });
  
  container.innerHTML = html;
}

function printArchiveReport() {
  if (!archiveData || archiveData.length === 0) {
    showToast('لا توجد بيانات للطباعة', 'warning');
    return;
  }
  
  const year = document.getElementById('archiveYear').value;
  const period = document.getElementById('archivePeriod').value;
  const periodText = period ? `آخر ${period} شهر` : 'كامل السنة';
  const commName = currentCommittee ? COMMITTEES[currentCommittee]?.name : 'جميع اللجان';
  
  let tableRows = '';
  let completedCount = 0;
  let delayedCount = 0;
  
  archiveData.forEach((meeting, idx) => {
    const comm = COMMITTEES[meeting.committee] || {};
    const statusText = meeting.status === 'completed' ? 'مكتمل' : 'متأخر';
    const statusColor = meeting.status === 'completed' ? '#10b981' : '#ef4444';
    if (meeting.status === 'completed') completedCount++; else delayedCount++;
    
    tableRows += `
      <tr>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${idx + 1}</td>
        <td style="padding: 10px; border: 1px solid #ddd;">${comm.name || meeting.committee}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${meeting.date}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${meeting.type || 'حضوري'}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${meeting.attendeesCount || 0}</td>
        <td style="padding: 10px; border: 1px solid #ddd;">${meeting.attendees || '-'}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${meeting.recommendationsCount || 0}</td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: ${statusColor}; font-weight: bold;">${statusText}</td>
      </tr>`;
  });
  
  const printContent = `
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8">
      <title>تقرير اجتماعات اللجان - مجمع مكة الطبي</title>
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        * { box-sizing: border-box; }
        body { 
          font-family: 'Tajawal', Arial, sans-serif; 
          padding: 20px; 
          color: #333;
          background: #fff;
        }
        .header { 
          text-align: center; 
          margin-bottom: 30px; 
          border-bottom: 3px solid #7d0024;
          padding-bottom: 20px;
        }
        .logo { width: 80px; height: 80px; margin-bottom: 10px; }
        .title { color: #7d0024; font-size: 24px; font-weight: bold; margin: 10px 0; }
        .subtitle { color: #666; font-size: 16px; }
        .info-box {
          background: #f8f9fa;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 20px;
          display: flex;
          justify-content: space-around;
        }
        .info-item { text-align: center; }
        .info-label { color: #666; font-size: 12px; }
        .info-value { font-size: 18px; font-weight: bold; color: #7d0024; }
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin-top: 20px;
          font-size: 12px;
        }
        th { 
          background: #7d0024; 
          color: white; 
          padding: 12px 8px; 
          border: 1px solid #5b001a;
          font-weight: bold;
        }
        tr:nth-child(even) { background: #f8f9fa; }
        .summary { 
          margin-top: 30px; 
          padding: 15px; 
          background: #f0f0f0; 
          border-radius: 8px;
          display: flex;
          justify-content: space-around;
        }
        .summary-item { text-align: center; }
        .summary-num { font-size: 28px; font-weight: bold; }
        .summary-num.green { color: #10b981; }
        .summary-num.red { color: #ef4444; }
        .footer { 
          margin-top: 40px; 
          text-align: center; 
          color: #666; 
          font-size: 11px;
          border-top: 1px solid #ddd;
          padding-top: 15px;
        }
        @media print {
          body { padding: 10px; }
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <img src="logo-new.png" class="logo" alt="شعار المجمع">
        <div class="title">مجمع مكة الطبي بالزاهر</div>
        <div class="subtitle">تقرير سجل اجتماعات اللجان</div>
      </div>
      
      <div class="info-box">
        <div class="info-item">
          <div class="info-label">اللجنة</div>
          <div class="info-value">${commName}</div>
        </div>
        <div class="info-item">
          <div class="info-label">السنة</div>
          <div class="info-value">${year}</div>
        </div>
        <div class="info-item">
          <div class="info-label">الفترة</div>
          <div class="info-value">${periodText}</div>
        </div>
        <div class="info-item">
          <div class="info-label">تاريخ التقرير</div>
          <div class="info-value">${new Date().toLocaleDateString('ar-SA')}</div>
        </div>
      </div>
      
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>اللجنة</th>
            <th>التاريخ</th>
            <th>النوع</th>
            <th>عدد الحضور</th>
            <th>أسماء الحضور</th>
            <th>التوصيات</th>
            <th>الحالة</th>
          </tr>
        </thead>
        <tbody>
          ${tableRows}
        </tbody>
      </table>
      
      <div class="summary">
        <div class="summary-item">
          <div class="summary-num">${archiveData.length}</div>
          <div>إجمالي الاجتماعات</div>
        </div>
        <div class="summary-item">
          <div class="summary-num green">${completedCount}</div>
          <div>مكتملة</div>
        </div>
        <div class="summary-item">
          <div class="summary-num red">${delayedCount}</div>
          <div>متأخرة</div>
        </div>
      </div>
      
      <div class="footer">
        <p>مجمع مكة الطبي بالزاهر - مكة المكرمة</p>
        <p>تم إنشاء هذا التقرير آلياً من نظام إدارة اجتماعات اللجان</p>
      </div>
      
      <script>window.onload = function() { window.print(); }</script>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
}

document.getElementById('btnSearchArchive').addEventListener('click', loadArchiveData);
document.getElementById('btnPrintArchive').addEventListener('click', printArchiveReport);

async function saveMeeting() {
  const comm = COMMITTEES[currentCommittee];
  const date = document.getElementById('meetingDate').value;
  const type = document.getElementById('meetingType').value;
  const zoomLink = document.getElementById('zoomLink').value;
  const recorder = document.getElementById('recorderName').value;
  const customRec = document.getElementById('customRecommendation').value;
  
  if (!date || !recorder) {
    showToast('يرجى تعبئة جميع الحقول المطلوبة', 'error');
    return;
  }
  
  const attendees = Array.from(selectedMembers).map(idx => comm.members[idx].name);
  const recommendations = Array.from(selectedRecommendations).map(idx => comm.recommendations[idx]);
  if (customRec.trim()) recommendations.push(customRec.trim());
  
  const meetingData = {
    committee: currentCommittee,
    date: date,
    type: type,
    zoomLink: zoomLink,
    attendees: attendees,
    attendeesCount: attendees.length,
    quorumMet: selectedMembers.size >= comm.quorum,
    recommendations: recommendations,
    recorder: recorder
  };
  
  const saveBtn = document.getElementById('btnSaveMeeting');
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<span class="loading-spinner"></span> جاري الحفظ...';
  
  try {
    const result = await apiCall('saveMeeting', meetingData);
    
    if (result.success) {
      const modal = new bootstrap.Modal(document.getElementById('successModal'));
      modal.show();
      
      document.getElementById('meetingDate').value = '';
      document.getElementById('zoomLink').value = '';
      document.getElementById('customRecommendation').value = '';
      selectedMembers.clear();
      selectedRecommendations.clear();
      renderAttendanceGrid(comm);
      renderRecommendationsGrid(comm);
      
      loadCommitteeData(currentCommittee);
      
      showToast('تم حفظ الاجتماع بنجاح!', 'success');
    } else {
      throw new Error(result.error || 'Failed to save');
    }
  } catch (err) {
    console.error('Save error:', err);
    showToast('فشل حفظ الاجتماع: ' + err.message, 'error');
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fa-solid fa-save me-2"></i> حفظ وإغلاق الاجتماع';
    updateQuorumStatus();
  }
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const colors = {
    success: 'var(--emerald)',
    error: 'var(--ruby)',
    info: 'var(--sapphire)',
    warning: 'var(--amber)'
  };
  
  const toast = document.createElement('div');
  toast.style.cssText = `
    background: linear-gradient(135deg, ${colors[type]}, rgba(0,0,0,0.8));
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    margin-bottom: 10px;
    font-weight: 600;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  `;
  toast.textContent = message;
  container.appendChild(toast);
  
  setTimeout(() => toast.remove(), 3000);
}

const urlParams = new URLSearchParams(window.location.search);
const committeeParam = urlParams.get('committee');
if (committeeParam && COMMITTEES[committeeParam]) {
  selectCommittee(committeeParam);
}

document.getElementById('meetingDate').valueAsDate = new Date();

// Dashboard Charts
let chartCommittees = null;
let chartRecommendations = null;
let chartAttendance = null;

async function loadDashboardData() {
  try {
    const result = await apiCall('getMeetingsDashboard', {});
    renderDashboardCharts(result);
  } catch (err) {
    console.error('Dashboard error:', err);
    renderDashboardCharts({});
  }
}

function renderDashboardCharts(data) {
  const committeesCtx = document.getElementById('chartCommittees').getContext('2d');
  const recsCtx = document.getElementById('chartRecommendations').getContext('2d');
  const attendanceCtx = document.getElementById('chartAttendance').getContext('2d');
  
  if (chartCommittees) chartCommittees.destroy();
  if (chartRecommendations) chartRecommendations.destroy();
  if (chartAttendance) chartAttendance.destroy();
  
  const commData = data.byCommittee || {
    RM: { completed: 0, required: 10 },
    FMS: { completed: 0, required: 10 },
    PSC: { completed: 0, required: 10 },
    IPC: { completed: 0, required: 10 },
    QI: { completed: 0, required: 10 },
    EOC: { completed: 0, required: 10 },
    EXEC: { completed: 0, required: 4 }
  };
  
  const commLabels = Object.keys(commData).map(k => COMMITTEES[k]?.name || k);
  const commCompleted = Object.values(commData).map(v => v.completed || 0);
  const commRequired = Object.values(commData).map(v => v.required || 10);
  const commColors = Object.keys(commData).map(k => COMMITTEES[k]?.color || '#666');
  
  chartCommittees = new Chart(committeesCtx, {
    type: 'bar',
    data: {
      labels: commLabels,
      datasets: [
        {
          label: 'المنجزة',
          data: commCompleted,
          backgroundColor: commColors.map(c => c + '99'),
          borderColor: commColors,
          borderWidth: 2
        },
        {
          label: 'المطلوبة',
          data: commRequired,
          backgroundColor: 'rgba(255,255,255,0.1)',
          borderColor: 'rgba(255,255,255,0.3)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#fff' } } },
      scales: {
        x: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      }
    }
  });
  
  const recsData = data.recommendations || { open: 0, closed: 0, overdue: 0 };
  chartRecommendations = new Chart(recsCtx, {
    type: 'doughnut',
    data: {
      labels: ['مفتوحة', 'مغلقة', 'متأخرة'],
      datasets: [{
        data: [recsData.open || 0, recsData.closed || 0, recsData.overdue || 0],
        backgroundColor: ['#f59e0b', '#10b981', '#ef4444'],
        borderColor: '#1a0b10',
        borderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#fff' } } }
    }
  });
  
  const monthlyData = data.monthlyAttendance || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
  const monthLabels = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
  
  chartAttendance = new Chart(attendanceCtx, {
    type: 'line',
    data: {
      labels: monthLabels,
      datasets: [{
        label: 'متوسط نسبة الحضور %',
        data: monthlyData,
        borderColor: '#d4af37',
        backgroundColor: 'rgba(212,175,55,0.2)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#fff' } } },
      scales: {
        x: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { 
          ticks: { color: '#ccc' }, 
          grid: { color: 'rgba(255,255,255,0.1)' },
          min: 0,
          max: 100
        }
      }
    }
  });
}

document.querySelector('[data-bs-target="#tab-dashboard"]').addEventListener('shown.bs.tab', loadDashboardData);
</script>
</body>
</html>
