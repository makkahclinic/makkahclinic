<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>المساعد الصحي الذكي • بوابة المريض</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
:root{
  --primary:#0b63c2; --accent:#00a7c7; --danger:#dc3545;
  --text:#243143; --muted:#6b7a90; --border:#e2e8f0;
  --card:#fff; --bg1:#e9f3ff; --bg2:#f6fbff; --shadow:0 10px 25px rgba(15,57,105,.08);
  --radius:16px; --container:1100px;
}

/* الصفحة والزر العائم */
html,body{height:100%}
body{
  margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  color:var(--text); background: radial-gradient(1200px 800px at 80% 0%, var(--bg1), var(--bg2));
  padding: 2.5rem .9rem 1.5rem;
}
.home-fab{
  position:fixed; top:16px; right:16px; z-index:1000;
  width:56px; height:56px; border-radius:14px;
  background:linear-gradient(135deg,#0b63c2,#00a7c7);
  color:#fff; display:flex; align-items:center; justify-content:center;
  font-size:24px; box-shadow:0 8px 22px rgba(11,99,194,.28); text-decoration:none;
  transition:transform .14s ease, filter .25s ease;
}
.home-fab:hover{ transform:translateY(-1px) scale(1.04); filter:brightness(.98) }

/* الحاوية */
.container{
  max-width:var(--container); margin:56px auto 0; background:var(--card);
  border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  position:relative; overflow:hidden;
}
.top-ribbon{ position:absolute; inset:0 0 auto 0; height:6px; background:linear-gradient(90deg,var(--primary),var(--accent)); }
.shell{ padding: 28px 26px 30px; }

.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:6px 0 10px; }
.title{ margin:0; font-weight:800; color:#0b4c9c; letter-spacing:.2px; font-size:1.45rem; }
.subtext{ color:var(--muted); font-size:.95rem; margin-top:2px; }

/* أدوات أعلى */
.toolbar{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
.seg{ display:inline-flex; background:#f3f7fb; border:1px solid var(--border); border-radius:999px; padding:4px; }
.seg button{ border:none; background:transparent; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-weight:700; color:#3b5168; }
.seg button.active{ background:#fff; border:1px solid var(--border); color:#0b63c2; }
.btn{ border:none; border-radius:10px; color:#fff; padding:.55rem .9rem; font-weight:700; font-size:.95rem; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.08); }
.btn-print{ background:#0f766e; }

/* بطاقات وأدوات الإدخال */
.card{ border:1px solid var(--border); border-radius:14px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.03); padding:16px; margin:14px 0; }
.section-title{ font-size:1.05rem; font-weight:800; color:#243143; display:flex; align-items:center; gap:.5rem; margin-bottom:12px; border-bottom:2px solid #dbe8f5; padding-bottom:.5rem; }
.dot{ width:8px; height:8px; background:var(--accent); border-radius:50%; display:inline-block; }

label{ font-weight:700; display:block; margin:.65rem 0 .35rem; }
.hint{ font-size:.85rem; color:#8496ab; margin-top:.15rem; }
input,select,textarea{
  width:100%; box-sizing:border-box; border:1px solid var(--border); border-radius:10px; padding:.72rem .9rem; background:#fff;
  transition:border-color .2s, box-shadow .2s, background .2s; font-size:1rem;
}
input::placeholder,textarea::placeholder{ color:#9aa8b8; }
input:focus,select:focus,textarea:focus{ outline:none; border-color:#0b63c2; box-shadow:0 0 0 3px rgba(11,99,194,.18); background:#fbfdff; }
textarea{ min-height:120px; resize:vertical; }

.grid{ display:grid; gap:14px; }
.grid-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
.grid-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
.span-2{ grid-column: 1 / -1; }
@media (max-width:920px){ .grid-3{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
@media (max-width:720px){ .grid-2,.grid-3{ grid-template-columns: 1fr; } }

/* الرفع */
.drop{
  border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; color:#6c7f95;
  transition:border-color .25s, background .25s; cursor:pointer;
}
.drop:hover{ border-color:var(--primary); background:#f6fbff; }
#file-input{ display:none; }
.file-list{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin-top:10px; }
.thumb{ position:relative; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; min-height:140px; }
.thumb img{ max-width:100%; max-height:200px; display:block; object-fit:contain; }
.thumb .badge{ position:absolute; inset-block-start:8px; inset-inline-start:8px; background:#eef5ff; color:#1e3a8a; border:1px solid #cfe6ff; font-size:.78rem; padding:.12rem .45rem; border-radius:999px; }
.thumb .remove{ position:absolute; inset-block-start:8px; inset-inline-end:8px; width:30px;height:30px; border:none; border-radius:50%; background:var(--danger); color:#fff; font-size:18px; cursor:pointer; box-shadow:0 4px 10px rgba(220,53,69,.25); }
.thumb .meta{ position:absolute; inset-block-end:8px; inset-inline-start:8px; color:#4b5563; background:#ffffffd0; border-radius:6px; padding:.15rem .4rem; font-size:.78rem; }

/* تنبيهات والنتيجة */
.actions{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top: 14px; flex-wrap:wrap; }
.notification{ margin-top:16px; padding:12px 14px; border-radius:10px; display:none; text-align:center; font-weight:600; }
.notification.info{ background:#e9f4ff; color:#114a86; border:1px solid #cfe6ff; }
.notification.error{ background:#fde8ea; color:#7a1f27; border:1px solid #f5c6cb; }
#response-container{ margin-top: 18px; border:1px solid var(--border); border-radius:12px; background:#fff; display:none; box-shadow: var(--shadow); }

/* طباعة */
@media print{
  body{ padding:0; background:#fff; }
  .home-fab, .toolbar, .actions, .notification{ display:none !important; }
  .container{ border:none; box-shadow:none; }
  #response-container{ display:block !important; border:none; box-shadow:none; margin-top:0; }
}

.hidden{ display:none !important; }
</style>
</head>

<body>

<!-- زر الصفحة الرئيسية (ثابت، لا يغطي المحتوى) -->
<a class="home-fab" href="https://www.m2020m.org/portal.html" title="العودة إلى البوابة">🏠</a>

<div class="container">
  <div class="top-ribbon"></div>
  <div class="shell">
    <div class="header">
      <div>
        <h1 class="title">المساعد الصحي الذكي • بوابة المريض</h1>
        <div class="subtext">واجهة إدخال سريرية — Clinical Intake</div>
      </div>
      <div class="toolbar">
        <div class="seg">
          <button id="lang-ar" class="active" type="button" onclick="setLang('ar')">العربية</button>
          <button id="lang-en" type="button" onclick="setLang('en')">English</button>
        </div>
        <button class="btn btn-print" type="button" onclick="window.print()"><i class="fa-solid fa-print"></i>&nbsp; PDF / طباعة</button>
      </div>
    </div>

    <!-- معلومات المريض -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> معلومات المريض</div>
      <div class="grid grid-3">
        <div>
          <label for="gender">الجنس</label>
          <select id="gender">
            <option value="" disabled selected>اختر</option>
            <option value="male">ذكر</option>
            <option value="female">أنثى</option>
          </select>
        </div>

        <div>
          <label for="age">العمر</label>
          <input id="age" type="number" placeholder="مثال: 45" min="0" max="120">
        </div>

        <div id="pregnancy-status-wrap" class="hidden">
          <label for="pregnancy-status">هل المريضة حامل؟</label>
          <select id="pregnancy-status">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="pregnancy-month-wrap" class="hidden">
          <label for="pregnancy-month">شهر الحمل</label>
          <input id="pregnancy-month" type="number" min="1" max="9" placeholder="مثال: 5">
        </div>
      </div>
    </div>

    <!-- تفاصيل الحالة -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> تفاصيل الحالة الطبية</div>
      <div class="grid grid-2">
        <div class="span-2">
          <label for="symptoms">وصف الحالة / الأعراض</label>
          <textarea id="symptoms" class="tall" placeholder="مثال: سعال مزمن منذ 12 أسبوعًا يزيد ليلًا، مع تعب..."></textarea>
        </div>
        <div>
          <label for="history">التاريخ المرضي</label>
          <textarea id="history" placeholder="مثال: سكري، ارتفاع ضغط"></textarea>
        </div>
        <div>
          <label for="diagnosis">تشخيصات سابقة (اختياري)</label>
          <textarea id="diagnosis" placeholder="مثال: COPD؟ التهاب جيوب"></textarea>
        </div>
        <div class="span-2">
          <label for="medications">الأدوية الحالية (اختياري)</label>
          <textarea id="medications" placeholder="Metformin 1000 mg..."></textarea>
        </div>
        <div class="span-2">
          <label for="labs">تحاليل / أشعة متوفرة (اختياري)</label>
          <textarea id="labs" placeholder="HbA1c 8.2%، eGFR 52، صورة صدر..."></textarea>
        </div>
      </div>
    </div>

    <!-- أسئلة بصرية -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> الأعراض البصرية</div>
      <div class="grid grid-3">
        <div>
          <label for="visual-symptoms">هل توجد أعراض بصرية؟</label>
          <select id="visual-symptoms">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="va-wrap" class="hidden">
          <label for="visual-acuity">قياس حدة البصر</label>
          <input id="visual-acuity" type="text" placeholder="مثال: 6/12 أو 20/40">
          <div class="hint">أدخل القياس إن وجد (مثال فقط).</div>
        </div>

        <div id="eye-exam-wrap" class="hidden">
          <label for="last-eye-exam">تاريخ آخر فحص عين</label>
          <input id="last-eye-exam" type="date">
        </div>
      </div>
    </div>

    <!-- نمط الحياة: التدخين والسعال -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> نمط الحياة والأعراض التنفسية</div>
      <div class="grid grid-3">
        <div>
          <label for="smoker">هل المريض مُدخّن؟</label>
          <select id="smoker">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="smoking-years-wrap" class="hidden">
          <label for="smoking-years">مدة التدخين (بالسنوات)</label>
          <input id="smoking-years" type="number" min="0" max="80" placeholder="مثال: 20">
        </div>

        <div>
          <label for="cough">هل يوجد سعال؟</label>
          <select id="cough">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="cough-blood-wrap" class="hidden">
          <label for="cough-blood">هل يوجد دم في السعال؟</label>
          <select id="cough-blood">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="cough-yellow-wrap" class="hidden">
          <label for="cough-yellow">هل البلغم أصفر اللون؟</label>
          <select id="cough-yellow">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="cough-dry-wrap" class="hidden">
          <label for="cough-dry">هل السعال جاف؟</label>
          <select id="cough-dry">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>
      </div>
    </div>

    <!-- الرفع -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> رفع ملفات (صور/PDF)</div>
      <div class="drop" onclick="document.getElementById('file-input').click()" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
        <div>اضغط أو اسحب صور (PNG/JPG) أو PDF هنا</div>
        <input id="file-input" type="file" accept="image/*,.pdf" multiple>
        <div class="hint">ننصح بصورة أو صورتين واضحتين — الصور تُضغط تلقائيًا</div>
      </div>
      <div id="file-list" class="file-list"></div>
    </div>

    <!-- أزرار -->
    <div class="actions">
      <button id="analyzeBtn" class="btn" style="background:#0b63c2" onclick="analyzeCase()"><i class="fa-solid fa-magnifying-glass"></i>&nbsp; تحليل الحالة</button>
    </div>

    <div id="notification-area" class="notification info"></div>
    <div id="response-container"></div>
  </div>
</div>

<script>
// لغة الواجهة
let currentLang = 'ar';
function setLang(lang){
  currentLang = lang;
  document.documentElement.dir = (lang==='en') ? 'ltr' : 'rtl';
  document.documentElement.lang = lang;
  document.getElementById('lang-ar').classList.toggle('active', lang==='ar');
  document.getElementById('lang-en').classList.toggle('active', lang==='en');
}

// إظهار الحقول الشرطية
const genderEl = document.getElementById('gender');
const pregWrap = document.getElementById('pregnancy-status-wrap');
const pregMonthWrap = document.getElementById('pregnancy-month-wrap');
const pregStatusEl = document.getElementById('pregnancy-status');

genderEl.addEventListener('change', ()=>{
  const isFemale = genderEl.value === 'female';
  pregWrap.classList.toggle('hidden', !isFemale);
  pregMonthWrap.classList.add('hidden');
  pregStatusEl.value = "";
  document.getElementById('pregnancy-month').value = "";
});

pregStatusEl.addEventListener('change', ()=>{
  const showMonth = pregStatusEl.value === 'yes';
  pregMonthWrap.classList.toggle('hidden', !showMonth);
  if(!showMonth) document.getElementById('pregnancy-month').value = "";
});

// بصريات
const visualSel = document.getElementById('visual-symptoms');
visualSel.addEventListener('change', ()=>{
  const show = visualSel.value === 'yes';
  document.getElementById('va-wrap').classList.toggle('hidden', !show);
  document.getElementById('eye-exam-wrap').classList.toggle('hidden', !show);
  if (!show){
    document.getElementById('visual-acuity').value = "";
    document.getElementById('last-eye-exam').value = "";
  }
});

// تدخين وسعال
const smokerSel = document.getElementById('smoker');
smokerSel.addEventListener('change', ()=>{
  const show = smokerSel.value === 'yes';
  document.getElementById('smoking-years-wrap').classList.toggle('hidden', !show);
  if(!show) document.getElementById('smoking-years').value = "";
});

const coughSel = document.getElementById('cough');
coughSel.addEventListener('change', ()=>{
  const show = coughSel.value === 'yes';
  document.getElementById('cough-blood-wrap').classList.toggle('hidden', !show);
  document.getElementById('cough-yellow-wrap').classList.toggle('hidden', !show);
  document.getElementById('cough-dry-wrap').classList.toggle('hidden', !show);
  if(!show){
    ['cough-blood','cough-yellow','cough-dry'].forEach(id => document.getElementById(id).value = "");
  }
});

// الرفع
const fileInput = document.getElementById('file-input');
const fileListEl = document.getElementById('file-list');
const noteArea = document.getElementById('notification-area');
let filesState = []; // {id,name,type,base64,sizeKB,isImage}
let nextId = 1;

fileInput.addEventListener('change', async (e)=>{
  if (!e.target.files?.length) return;
  await addFiles([...(e.target.files)]);
  fileInput.value = "";
});
async function handleDrop(ev){
  ev.preventDefault();
  await addFiles([...(ev.dataTransfer?.files || [])]);
}
async function addFiles(files){
  for (const file of files){
    const type = file.type || '';
    try{
      if (type.startsWith('image/')){
        const { base64, info } = await compressImage(file, { maxW: 1600, maxH: 1600, quality: 0.75 });
        filesState.push({ id: nextId++, name:file.name, type:'image/jpeg', base64, sizeKB:info.sizeKB, isImage:true });
      } else if (type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')){
        const base64 = await fileToBase64(file);
        const sizeKB = (base64.length * 3) / 4 / 1024;
        filesState.push({ id: nextId++, name:file.name, type:'application/pdf', base64, sizeKB, isImage:false });
      } else {
        showNote('error','يدعم فقط صور و PDF');
      }
    } catch(err){
      console.error(err);
      showNote('error','تعذّر معالجة الملف.');
    }
  }
  renderFiles();
}
function renderFiles(){
  fileListEl.innerHTML = '';
  filesState.forEach(f=>{
    const card = document.createElement('div'); card.className='thumb';
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = f.isImage?'IMAGE':'PDF'; card.appendChild(badge);
    const remove = document.createElement('button'); remove.className='remove'; remove.innerHTML='&times;'; remove.onclick=()=>{ filesState = filesState.filter(x=>x.id!==f.id); renderFiles(); }; card.appendChild(remove);
    if (f.isImage){ const img = new Image(); img.src = 'data:image/jpeg;base64,' + f.base64; card.appendChild(img); }
    else { const ico = document.createElement('div'); ico.style.fontSize='56px'; ico.style.color='#64748b'; ico.textContent='📄'; card.appendChild(ico); }
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${f.name.substring(0,24)} • ${f.sizeKB.toFixed(0)} KB`; card.appendChild(meta);
    fileListEl.appendChild(card);
  });
}
function fileToBase64(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file); });
}
async function compressImage(file,{maxW=1600,maxH=1600,quality=0.75}={}){
  const dataURL = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL; });
  let { width:w, height:h } = img;
  const ratio = Math.min(maxW/w, maxH/h, 1); w=Math.round(w*ratio); h=Math.round(h*ratio);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const out=canvas.toDataURL('image/jpeg',quality); const base64=out.split(',')[1];
  const sizeKB=(base64.length*3)/4/1024; return { base64, info:{ sizeKB } };
}

// تنبيهات
function showNote(type, text){
  noteArea.className = 'notification ' + (type==='error' ? 'error' : 'info');
  noteArea.textContent = text; noteArea.style.display='block';
}
function clearNote(){ noteArea.style.display='none'; noteArea.textContent=''; }

// بناء الحمولة
function val(id){ return (document.getElementById(id)?.value || '').trim() || undefined; }
function sel(id){
  const v = document.getElementById(id)?.value;
  if (v==='yes') return true; if (v==='no') return false; return undefined;
}
function num(id){ const v = val(id); if (v===undefined) return undefined; const n = Number(v); return Number.isFinite(n)? n : undefined; }

function buildPayload(){
  return {
    uiLang: currentLang,
    // عام
    age: num('age'),
    gender: val('gender'),
    pregnancyStatus: val('pregnancy-status'), // yes/no
    pregnancyMonth: num('pregnancy-month'),

    // بصري
    visualSymptoms: sel('visual-symptoms'),
    visualAcuity: val('visual-acuity'),
    lastEyeExamDate: val('last-eye-exam'),

    // تدخين/سعال
    isSmoker: sel('smoker'),
    smokingYears: num('smoking-years'),
    hasCough: sel('cough'),
    coughBlood: sel('cough-blood'),
    coughYellowSputum: sel('cough-yellow'),
    coughDry: sel('cough-dry'),

    // نصوص
    symptoms: val('symptoms'),
    history: val('history'),
    diagnosis: val('diagnosis'),
    medications: val('medications'),
    labs: val('labs'),

    // ملفات
    files: filesState.map(f=>({ name:f.name, type:f.type, base64:f.base64 }))
  };
}

// الاستدعاء الخلفي
async function analyzeCase(){
  const responseContainer = document.getElementById('response-container');
  const btn = document.getElementById('analyzeBtn');
  clearNote(); responseContainer.style.display='none'; responseContainer.innerHTML='';

  const payload = buildPayload();
  if (!payload.symptoms && (!payload.files || payload.files.length===0)){
    showNote('error','يرجى كتابة وصف الحالة أو إرفاق ملف واحد على الأقل.');
    return;
  }

  showNote('info','جاري التحليل…');
  btn.disabled = true;
  const controller = new AbortController();
  const to = setTimeout(()=>controller.abort(), 90000);

  try{
    const res = await fetch('/api/patient-analyzer.js', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    const text = await res.text();
    if (!res.ok){
      let detail = text;
      try { const j = JSON.parse(text); detail = j.detail || j.error || text; } catch {}
      if (res.status === 413) detail = 'حجم الملفات كبير جدًا. قلّل العدد أو الحجم.';
      throw new Error(detail);
    }
    const data = JSON.parse(text);
    if (data?.htmlReport){
      clearNote();
      responseContainer.innerHTML = data.htmlReport;
      responseContainer.style.display = 'block';
      responseContainer.scrollIntoView({ behavior:'smooth', block:'start' });
    } else {
      throw new Error('الرد لم يحتوِ على تقرير HTML.');
    }
  } catch(err){
    console.error(err);
    showNote('error','حدث خطأ: ' + err.message);
  } finally {
    clearTimeout(to);
    btn.disabled = false;
  }
}

// تهيئة مبدئية
setLang('ar');
window.setLang = setLang;
window.handleDrop = handleDrop;
window.analyzeCase = analyzeCase;
</script>
</body>
</html>
