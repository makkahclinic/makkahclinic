<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€¢ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±ÙŠØ¶</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
:root{
  --primary:#0b63c2; --accent:#00a7c7; --danger:#dc3545;
  --text:#243143; --muted:#6b7a90; --border:#e2e8f0;
  --card:#fff; --bg1:#e9f3ff; --bg2:#f6fbff; --shadow:0 10px 25px rgba(15,57,105,.08);
  --radius:16px; --container:1100px;
}

/* Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
html,body{height:100%}
body{
  margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  color:var(--text); background: radial-gradient(1200px 800px at 80% 0%, var(--bg1), var(--bg2));
  padding: 2.5rem .9rem 1.5rem;
}
.home-fab{
  position:fixed; top:16px; right:16px; z-index:1000;
  width:56px; height:56px; border-radius:14px;
  background:linear-gradient(135deg,#0b63c2,#00a7c7);
  color:#fff; display:flex; align-items:center; justify-content:center;
  font-size:24px; box-shadow:0 8px 22px rgba(11,99,194,.28); text-decoration:none;
  transition:transform .14s ease, filter .25s ease;
}
.home-fab:hover{ transform:translateY(-1px) scale(1.04); filter:brightness(.98) }

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
.container{
  max-width:var(--container); margin:56px auto 0; background:var(--card);
  border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  position:relative; overflow:hidden;
}
.top-ribbon{ position:absolute; inset:0 0 auto 0; height:6px; background:linear-gradient(90deg,var(--primary),var(--accent)); }
.shell{ padding: 28px 26px 30px; }

.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:6px 0 10px; }
.title{ margin:0; font-weight:800; color:#0b4c9c; letter-spacing:.2px; font-size:1.45rem; }
.subtext{ color:var(--muted); font-size:.95rem; margin-top:2px; }

/* Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰ */
.toolbar{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
.seg{ display:inline-flex; background:#f3f7fb; border:1px solid var(--border); border-radius:999px; padding:4px; }
.seg button{ border:none; background:transparent; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-weight:700; color:#3b5168; }
.seg button.active{ background:#fff; border:1px solid var(--border); color:#0b63c2; }
.btn{ border:none; border-radius:10px; color:#fff; padding:.55rem .9rem; font-weight:700; font-size:.95rem; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.08); }
.btn-print{ background:#0f766e; }

/* Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
.card{ border:1px solid var(--border); border-radius:14px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.03); padding:16px; margin:14px 0; }
.section-title{ font-size:1.05rem; font-weight:800; color:#243143; display:flex; align-items:center; gap:.5rem; margin-bottom:12px; border-bottom:2px solid #dbe8f5; padding-bottom:.5rem; }
.dot{ width:8px; height:8px; background:var(--accent); border-radius:50%; display:inline-block; }

label{ font-weight:700; display:block; margin:.65rem 0 .35rem; }
.hint{ font-size:.85rem; color:#8496ab; margin-top:.15rem; }
input,select,textarea{
  width:100%; box-sizing:border-box; border:1px solid var(--border); border-radius:10px; padding:.72rem .9rem; background:#fff;
  transition:border-color .2s, box-shadow .2s, background .2s; font-size:1rem;
}
input::placeholder,textarea::placeholder{ color:#9aa8b8; }
input:focus,select:focus,textarea:focus{ outline:none; border-color:#0b63c2; box-shadow:0 0 0 3px rgba(11,99,194,.18); background:#fbfdff; }
textarea{ min-height:120px; resize:vertical; }

.grid{ display:grid; gap:14px; }
.grid-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
.grid-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
.span-2{ grid-column: 1 / -1; }
@media (max-width:920px){ .grid-3{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
@media (max-width:720px){ .grid-2,.grid-3{ grid-template-columns: 1fr; } }

/* Ø§Ù„Ø±ÙØ¹ */
.drop{
  border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; color:#6c7f95;
  transition:border-color .25s, background .25s; cursor:pointer;
}
.drop:hover{ border-color:var(--primary); background:#f6fbff; }
#file-input{ display:none; }
.file-list{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin-top:10px; }
.thumb{ position:relative; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; min-height:140px; }
.thumb img{ max-width:100%; max-height:200px; display:block; object-fit:contain; }
.thumb .badge{ position:absolute; inset-block-start:8px; inset-inline-start:8px; background:#eef5ff; color:#1e3a8a; border:1px solid #cfe6ff; font-size:.78rem; padding:.12rem .45rem; border-radius:999px; }
.thumb .remove{ position:absolute; inset-block-start:8px; inset-inline-end:8px; width:30px;height:30px; border:none; border-radius:50%; background:var(--danger); color:#fff; font-size:18px; cursor:pointer; box-shadow:0 4px 10px rgba(220,53,69,.25); }
.thumb .meta{ position:absolute; inset-block-end:8px; inset-inline-start:8px; color:#4b5563; background:#ffffffd0; border-radius:6px; padding:.15rem .4rem; font-size:.78rem; }

/* ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø© */
.actions{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top: 14px; flex-wrap:wrap; }
.notification{ margin-top:16px; padding:12px 14px; border-radius:10px; display:none; text-align:center; font-weight:600; }
.notification.info{ background:#e9f4ff; color:#114a86; border:1px solid #cfe6ff; }
.notification.error{ background:#fde8ea; color:#7a1f27; border:1px solid #f5c6cb; }
#response-container{ margin-top: 18px; border:1px solid var(--border); border-radius:12px; background:#fff; display:none; box-shadow: var(--shadow); }

/* Ø·Ø¨Ø§Ø¹Ø© */
@media print{
  body{ padding:0; background:#fff; }
  .home-fab, .toolbar, .actions, .notification{ display:none !important; }
  .container{ border:none; box-shadow:none; }
  #response-container{ display:block !important; border:none; box-shadow:none; margin-top:0; }
}

.hidden{ display:none !important; }
</style>
</head>

<body>

<!-- Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø«Ø§Ø¨ØªØŒ Ù„Ø§ ÙŠØºØ·ÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰) -->
<a class="home-fab" href="https://www.m2020m.org/portal.html" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©">ğŸ </a>

<div class="container">
  <div class="top-ribbon"></div>
  <div class="shell">
    <div class="header">
      <div>
        <h1 class="title">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€¢ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø±ÙŠØ¶</h1>
        <div class="subtext">ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ±ÙŠØ© â€” Clinical Intake</div>
      </div>
      <div class="toolbar">
        <div class="seg">
          <button id="lang-ar" class="active" type="button" onclick="setLang('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button id="lang-en" type="button" onclick="setLang('en')">English</button>
        </div>
        <button class="btn btn-print" type="button" onclick="window.print()"><i class="fa-solid fa-print"></i>&nbsp; PDF / Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</div>
      <div class="grid grid-3">
        <div>
          <label for="gender">Ø§Ù„Ø¬Ù†Ø³</label>
          <select id="gender">
            <option value="" disabled selected>Ø§Ø®ØªØ±</option>
            <option value="male">Ø°ÙƒØ±</option>
            <option value="female">Ø£Ù†Ø«Ù‰</option>
          </select>
        </div>

        <div>
          <label for="age">Ø§Ù„Ø¹Ù…Ø±</label>
          <input id="age" type="number" placeholder="Ù…Ø«Ø§Ù„: 45" min="0" max="120">
        </div>

        <div id="pregnancy-status-wrap" class="hidden">
          <label for="pregnancy-status">Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶Ø© Ø­Ø§Ù…Ù„ØŸ</label>
          <select id="pregnancy-status">
            <option value="" disabled selected>Ø§Ø®ØªØ±</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </div>

        <div id="pregnancy-month-wrap" class="hidden">
          <label for="pregnancy-month">Ø´Ù‡Ø± Ø§Ù„Ø­Ù…Ù„</label>
          <input id="pregnancy-month" type="number" min="1" max="9" placeholder="Ù…Ø«Ø§Ù„: 5">
        </div>
      </div>
    </div>

    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</div>
      <div class="grid grid-2">
        <div class="span-2">
          <label for="symptoms">ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</label>
          <textarea id="symptoms" class="tall" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¹Ø§Ù„ Ù…Ø²Ù…Ù† Ù…Ù†Ø° 12 Ø£Ø³Ø¨ÙˆØ¹Ù‹Ø§ ÙŠØ²ÙŠØ¯ Ù„ÙŠÙ„Ù‹Ø§ØŒ Ù…Ø¹ ØªØ¹Ø¨..."></textarea>
        </div>
        <div>
          <label for="history">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø¶ÙŠ</label>
          <textarea id="history" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙƒØ±ÙŠØŒ Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ·"></textarea>
        </div>
        <div>
          <label for="diagnosis">ØªØ´Ø®ÙŠØµØ§Øª Ø³Ø§Ø¨Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="diagnosis" placeholder="Ù…Ø«Ø§Ù„: COPDØŸ Ø§Ù„ØªÙ‡Ø§Ø¨ Ø¬ÙŠÙˆØ¨"></textarea>
        </div>
        <div class="span-2">
          <label for="medications">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="medications" placeholder="Metformin 1000 mg..."></textarea>
        </div>
        <div class="span-2">
          <label for="labs">ØªØ­Ø§Ù„ÙŠÙ„ / Ø£Ø´Ø¹Ø© Ù…ØªÙˆÙØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="labs" placeholder="HbA1c 8.2%ØŒ eGFR 52ØŒ ØµÙˆØ±Ø© ØµØ¯Ø±..."></textarea>
        </div>
      </div>
    </div>

    <!-- Ø£Ø³Ø¦Ù„Ø© Ø¨ØµØ±ÙŠØ© -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø¨ØµØ±ÙŠØ©</div>
      <div class="grid grid-3">
        <div>
          <label for="visual-symptoms">Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø±Ø§Ø¶ Ø¨ØµØ±ÙŠØ©ØŸ</label>
          <select id="visual-symptoms">
            <option value="" disabled selected>Ø§Ø®ØªØ±</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </div>

        <div id="va-wrap" class="hidden">
          <label for="visual-acuity">Ù‚ÙŠØ§Ø³ Ø­Ø¯Ø© Ø§Ù„Ø¨ØµØ±</label>
          <input id="visual-acuity" type="text" placeholder="Ù…Ø«Ø§Ù„: 6/12 Ø£Ùˆ 20/40">
          <div class="hint">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¥Ù† ÙˆØ¬Ø¯ (Ù…Ø«Ø§Ù„ ÙÙ‚Ø·).</div>
        </div>

        <div id="eye-exam-wrap" class="hidden">
          <label for="last-eye-exam">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ÙØ­Øµ Ø¹ÙŠÙ†</label>
          <input id="last-eye-exam" type="date">
        </div>
      </div>
    </div>

    <!-- Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©: Ø§Ù„ØªØ¯Ø®ÙŠÙ† ÙˆØ§Ù„Ø³Ø¹Ø§Ù„ -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„ØªÙ†ÙØ³ÙŠØ©</div>
      <div class="grid grid-3">
        <div>
          <label for="smoker">Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…ÙØ¯Ø®Ù‘Ù†ØŸ</label>
          <select id="smoker">
            <option value="" disabled selected>Ø§Ø®ØªØ±</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </div>

        <div id="smoking-years-wrap" class="hidden">
          <label for="smoking-years">Ù…Ø¯Ø© Ø§Ù„ØªØ¯Ø®ÙŠÙ† (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª)</label>
          <input id="smoking-years" type="number" min="0" max="80" placeholder="Ù…Ø«Ø§Ù„: 20">
        </div>

        <div>
          <label for="cough">Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø³Ø¹Ø§Ù„ØŸ</label>
          <select id="cough">
            <option value="" disabled selected>Ø§Ø®ØªØ±</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </div>

        <div id="cough-blood-wrap" class="hidden">
          <label for="cough-blood">Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø¯Ù… ÙÙŠ Ø§Ù„Ø³Ø¹Ø§Ù„ØŸ</label>
          <select id="cough-blood">
            <option value="" disabled selected>Ø§Ø®ØªØ±</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </div>

        <div id="cough-yellow-wrap" class="hidden">
          <label for="cough-yellow">Ù‡Ù„ Ø§Ù„Ø¨Ù„ØºÙ… Ø£ØµÙØ± Ø§Ù„Ù„ÙˆÙ†ØŸ</label>
          <select id="cough-yellow">
            <option value="" disabled selected>Ø§Ø®ØªØ±</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </div>

        <div id="cough-dry-wrap" class="hidden">
          <label for="cough-dry">Ù‡Ù„ Ø§Ù„Ø³Ø¹Ø§Ù„ Ø¬Ø§ÙØŸ</label>
          <select id="cough-dry">
            <option value="" disabled selected>Ø§Ø®ØªØ±</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø±ÙØ¹ -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> Ø±ÙØ¹ Ù…Ù„ÙØ§Øª (ØµÙˆØ±/PDF)</div>
      <div class="drop" onclick="document.getElementById('file-input').click()" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
        <div>Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ ØµÙˆØ± (PNG/JPG) Ø£Ùˆ PDF Ù‡Ù†Ø§</div>
        <input id="file-input" type="file" accept="image/*,.pdf" multiple>
        <div class="hint">Ù†Ù†ØµØ­ Ø¨ØµÙˆØ±Ø© Ø£Ùˆ ØµÙˆØ±ØªÙŠÙ† ÙˆØ§Ø¶Ø­ØªÙŠÙ† â€” Ø§Ù„ØµÙˆØ± ØªÙØ¶ØºØ· ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
      </div>
      <div id="file-list" class="file-list"></div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± -->
    <div class="actions">
      <button id="analyzeBtn" class="btn" style="background:#0b63c2" onclick="analyzeCase()"><i class="fa-solid fa-magnifying-glass"></i>&nbsp; ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
    </div>

    <div id="notification-area" class="notification info"></div>
    <div id="response-container"></div>
  </div>
</div>

<script>
// Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
let currentLang = 'ar';
function setLang(lang){
  currentLang = lang;
  document.documentElement.dir = (lang==='en') ? 'ltr' : 'rtl';
  document.documentElement.lang = lang;
  document.getElementById('lang-ar').classList.toggle('active', lang==='ar');
  document.getElementById('lang-en').classList.toggle('active', lang==='en');
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø´Ø±Ø·ÙŠØ©
const genderEl = document.getElementById('gender');
const pregWrap = document.getElementById('pregnancy-status-wrap');
const pregMonthWrap = document.getElementById('pregnancy-month-wrap');
const pregStatusEl = document.getElementById('pregnancy-status');

genderEl.addEventListener('change', ()=>{
  const isFemale = genderEl.value === 'female';
  pregWrap.classList.toggle('hidden', !isFemale);
  pregMonthWrap.classList.add('hidden');
  pregStatusEl.value = "";
  document.getElementById('pregnancy-month').value = "";
});

pregStatusEl.addEventListener('change', ()=>{
  const showMonth = pregStatusEl.value === 'yes';
  pregMonthWrap.classList.toggle('hidden', !showMonth);
  if(!showMonth) document.getElementById('pregnancy-month').value = "";
});

// Ø¨ØµØ±ÙŠØ§Øª
const visualSel = document.getElementById('visual-symptoms');
visualSel.addEventListener('change', ()=>{
  const show = visualSel.value === 'yes';
  document.getElementById('va-wrap').classList.toggle('hidden', !show);
  document.getElementById('eye-exam-wrap').classList.toggle('hidden', !show);
  if (!show){
    document.getElementById('visual-acuity').value = "";
    document.getElementById('last-eye-exam').value = "";
  }
});

// ØªØ¯Ø®ÙŠÙ† ÙˆØ³Ø¹Ø§Ù„
const smokerSel = document.getElementById('smoker');
smokerSel.addEventListener('change', ()=>{
  const show = smokerSel.value === 'yes';
  document.getElementById('smoking-years-wrap').classList.toggle('hidden', !show);
  if(!show) document.getElementById('smoking-years').value = "";
});

const coughSel = document.getElementById('cough');
coughSel.addEventListener('change', ()=>{
  const show = coughSel.value === 'yes';
  document.getElementById('cough-blood-wrap').classList.toggle('hidden', !show);
  document.getElementById('cough-yellow-wrap').classList.toggle('hidden', !show);
  document.getElementById('cough-dry-wrap').classList.toggle('hidden', !show);
  if(!show){
    ['cough-blood','cough-yellow','cough-dry'].forEach(id => document.getElementById(id).value = "");
  }
});

// Ø§Ù„Ø±ÙØ¹
const fileInput = document.getElementById('file-input');
const fileListEl = document.getElementById('file-list');
const noteArea = document.getElementById('notification-area');
let filesState = []; // {id,name,type,base64,sizeKB,isImage}
let nextId = 1;

fileInput.addEventListener('change', async (e)=>{
  if (!e.target.files?.length) return;
  await addFiles([...(e.target.files)]);
  fileInput.value = "";
});
async function handleDrop(ev){
  ev.preventDefault();
  await addFiles([...(ev.dataTransfer?.files || [])]);
}
async function addFiles(files){
  for (const file of files){
    const type = file.type || '';
    try{
      if (type.startsWith('image/')){
        const { base64, info } = await compressImage(file, { maxW: 1600, maxH: 1600, quality: 0.75 });
        filesState.push({ id: nextId++, name:file.name, type:'image/jpeg', base64, sizeKB:info.sizeKB, isImage:true });
      } else if (type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')){
        const base64 = await fileToBase64(file);
        const sizeKB = (base64.length * 3) / 4 / 1024;
        filesState.push({ id: nextId++, name:file.name, type:'application/pdf', base64, sizeKB, isImage:false });
      } else {
        showNote('error','ÙŠØ¯Ø¹Ù… ÙÙ‚Ø· ØµÙˆØ± Ùˆ PDF');
      }
    } catch(err){
      console.error(err);
      showNote('error','ØªØ¹Ø°Ù‘Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù.');
    }
  }
  renderFiles();
}
function renderFiles(){
  fileListEl.innerHTML = '';
  filesState.forEach(f=>{
    const card = document.createElement('div'); card.className='thumb';
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = f.isImage?'IMAGE':'PDF'; card.appendChild(badge);
    const remove = document.createElement('button'); remove.className='remove'; remove.innerHTML='&times;'; remove.onclick=()=>{ filesState = filesState.filter(x=>x.id!==f.id); renderFiles(); }; card.appendChild(remove);
    if (f.isImage){ const img = new Image(); img.src = 'data:image/jpeg;base64,' + f.base64; card.appendChild(img); }
    else { const ico = document.createElement('div'); ico.style.fontSize='56px'; ico.style.color='#64748b'; ico.textContent='ğŸ“„'; card.appendChild(ico); }
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${f.name.substring(0,24)} â€¢ ${f.sizeKB.toFixed(0)} KB`; card.appendChild(meta);
    fileListEl.appendChild(card);
  });
}
function fileToBase64(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file); });
}
async function compressImage(file,{maxW=1600,maxH=1600,quality=0.75}={}){
  const dataURL = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL; });
  let { width:w, height:h } = img;
  const ratio = Math.min(maxW/w, maxH/h, 1); w=Math.round(w*ratio); h=Math.round(h*ratio);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const out=canvas.toDataURL('image/jpeg',quality); const base64=out.split(',')[1];
  const sizeKB=(base64.length*3)/4/1024; return { base64, info:{ sizeKB } };
}

// ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
function showNote(type, text){
  noteArea.className = 'notification ' + (type==='error' ? 'error' : 'info');
  noteArea.textContent = text; noteArea.style.display='block';
}
function clearNote(){ noteArea.style.display='none'; noteArea.textContent=''; }

// Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ù…ÙˆÙ„Ø©
function val(id){ return (document.getElementById(id)?.value || '').trim() || undefined; }
function sel(id){
  const v = document.getElementById(id)?.value;
  if (v==='yes') return true; if (v==='no') return false; return undefined;
}
function num(id){ const v = val(id); if (v===undefined) return undefined; const n = Number(v); return Number.isFinite(n)? n : undefined; }

function buildPayload(){
  return {
    uiLang: currentLang,
    // Ø¹Ø§Ù…
    age: num('age'),
    gender: val('gender'),
    pregnancyStatus: val('pregnancy-status'), // yes/no
    pregnancyMonth: num('pregnancy-month'),

    // Ø¨ØµØ±ÙŠ
    visualSymptoms: sel('visual-symptoms'),
    visualAcuity: val('visual-acuity'),
    lastEyeExamDate: val('last-eye-exam'),

    // ØªØ¯Ø®ÙŠÙ†/Ø³Ø¹Ø§Ù„
    isSmoker: sel('smoker'),
    smokingYears: num('smoking-years'),
    hasCough: sel('cough'),
    coughBlood: sel('cough-blood'),
    coughYellowSputum: sel('cough-yellow'),
    coughDry: sel('cough-dry'),

    // Ù†ØµÙˆØµ
    symptoms: val('symptoms'),
    history: val('history'),
    diagnosis: val('diagnosis'),
    medications: val('medications'),
    labs: val('labs'),

    // Ù…Ù„ÙØ§Øª
    files: filesState.map(f=>({ name:f.name, type:f.type, base64:f.base64 }))
  };
}

// Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠ
async function analyzeCase(){
  const responseContainer = document.getElementById('response-container');
  const btn = document.getElementById('analyzeBtn');
  clearNote(); responseContainer.style.display='none'; responseContainer.innerHTML='';

  const payload = buildPayload();
  if (!payload.symptoms && (!payload.files || payload.files.length===0)){
    showNote('error','ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙˆØµÙ Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
    return;
  }

  showNote('info','Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„â€¦');
  btn.disabled = true;
  const controller = new AbortController();
  const to = setTimeout(()=>controller.abort(), 90000);

  try{
    const res = await fetch('/api/patient-analyzer.js', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    const text = await res.text();
    if (!res.ok){
      let detail = text;
      try { const j = JSON.parse(text); detail = j.detail || j.error || text; } catch {}
      if (res.status === 413) detail = 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§. Ù‚Ù„Ù‘Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø£Ùˆ Ø§Ù„Ø­Ø¬Ù….';
      throw new Error(detail);
    }
    const data = JSON.parse(text);
    if (data?.htmlReport){
      clearNote();
      responseContainer.innerHTML = data.htmlReport;
      responseContainer.style.display = 'block';
      responseContainer.scrollIntoView({ behavior:'smooth', block:'start' });
    } else {
      throw new Error('Ø§Ù„Ø±Ø¯ Ù„Ù… ÙŠØ­ØªÙˆÙ Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± HTML.');
    }
  } catch(err){
    console.error(err);
    showNote('error','Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.message);
  } finally {
    clearTimeout(to);
    btn.disabled = false;
  }
}

// ØªÙ‡ÙŠØ¦Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ©
setLang('ar');
window.setLang = setLang;
window.handleDrop = handleDrop;
window.analyzeCase = analyzeCase;
</script>
</body>
</html>
