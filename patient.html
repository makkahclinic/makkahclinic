<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>المساعد الصحي الذكي - بوابة المريض</title>

<!-- ============   التنسيق   ============ -->
<style>
 :root{--primary:#28a745;--secondary:#0a4c8b;--bg:#f4f7f9;--text:#333;--card:#fff;--border:#e0e0e0}
 body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:1rem}
 .container{max-width:900px;margin:2rem auto;background:var(--card);padding:2.5rem;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
 .header{text-align:center;margin-bottom:2.5rem;border-bottom:1px solid var(--border);padding-bottom:1.5rem}
 .header h2{color:var(--primary);margin:0;font-size:2rem}
 .header p{color:#555;margin-top:.5rem}
 label{font-weight:600;display:block;margin-top:1.5rem;margin-bottom:.5rem}
 textarea,input,select{width:100%;padding:.9rem 1rem;font-size:1rem;border:1px solid var(--border);border-radius:8px;box-sizing:border-box;transition:border-color .3s,box-shadow .3s}
 textarea:focus,input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(40,167,69,.2)}
 textarea{min-height:120px;resize:vertical}
 .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem 1.5rem}
 .full-width{grid-column:1/-1}
 .conditional-field{display:none;animation:slideDown .4s ease-out}@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
 button{padding:1rem;font-size:1.2rem;font-weight:bold;color:#fff;background:linear-gradient(45deg,var(--primary),#218838);border:none;border-radius:8px;cursor:pointer;transition:transform .2s,box-shadow .2s;margin-top:2.5rem;width:100%;box-shadow:0 4px 15px rgba(40,167,69,.2)}
 button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(40,167,69,.3)}
 /* معاينات الملفات */
 .file-upload-container{margin-top:1.5rem;border:2px dashed var(--border);border-radius:8px;padding:1.5rem;text-align:center;cursor:pointer;transition:border-color .3s,background .3s}
 .file-upload-container:hover{border-color:var(--primary);background:#f8f9fa}
 #file-upload-input{display:none}
 #preview-wrapper{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem}
 .preview-thumb{width:100px;height:100px;object-fit:cover;border:1px solid var(--border);border-radius:6px}
 .preview-pdf{display:flex;align-items:center;justify-content:center;width:100px;height:100px;border:1px solid var(--border);border-radius:6px;background:#fafafa;font-size:.75rem;text-align:center;padding:4px}
 /* إشعارات وتقرير */
 .notification{padding:1rem;margin-top:1rem;border-radius:8px;text-align:center;display:none}
 .notification.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
 .notification.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
 #response-container{margin-top:2.5rem;display:none;animation:fadeIn .5s ease-in-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
 .response-section{padding:1.5rem;margin-bottom:1.5rem;border-radius:12px;background:#fdfdfd;border:1px solid var(--border);text-align:right}
 .response-section h4{margin-top:0;margin-bottom:1rem;color:var(--secondary);display:flex;align-items:center;gap:10px}
 .recommendation-box{padding:1.5rem;border-radius:12px;font-size:1.1rem;font-weight:bold;text-align:center}
 .recommendation-box.red{background:#f8d7da;color:#721c24}.recommendation-box.yellow{background:#fff3cd;color:#856404}.recommendation-box.green{background:#d4edda;color:#155724}
 .back-link{display:block;text-align:center;margin-bottom:1rem;color:var(--secondary)}
 .disclaimer{font-size:.8rem;text-align:center;color:#777;margin-top:2rem}
</style>
</head>
<body>
<div class="container">
  <a href="portal.html" class="back-link">العودة إلى البوابة الرئيسية</a>
  <div class="header">
      <h2>المساعد الصحي الذكي</h2>
      <p>أدخل معلوماتك للحصول على تحليل أولي لحالتك الصحية</p>
  </div>

  <!-- =====   نموذج الإدخال   ===== -->
  <div class="form-grid">
    <div class="full-width">
      <label for="symptoms">صف أعراضك بالتفصيل (مطلوب):</label>
      <textarea id="symptoms" placeholder="مثال: أشعر بصداع شديد ..."></textarea>
    </div>

    <div><label for="age">العمر (مطلوب):</label><input type="number" id="age" placeholder="مثال: 35"></div>
    <div>
      <label for="gender">الجنس (مطلوب):</label>
      <select id="gender">
        <option value="" disabled selected>اختر...</option>
        <option value="male">ذكر</option>
        <option value="female">أنثى</option>
      </select>
    </div>

    <!-- حقول الحمل الشرطية -->
    <div id="pregnancy-section" class="conditional-field full-width">
      <label for="isPregnant">هل أنتِ حامل؟</label>
      <select id="isPregnant"><option value="no" selected>لا</option><option value="yes">نعم</option></select>
    </div>
    <div id="pregnancy-month-section" class="conditional-field full-width">
      <label for="pregnancyMonth">في أي شهر؟</label>
      <select id="pregnancyMonth">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
        <option value="7">7</option><option value="8">8</option><option value="9">9</option>
      </select>
    </div>

    <div><label for="weight">الوزن (كجم):</label><input type="number" id="weight"></div>
    <div><label for="height">الطول (سم):</label><input type="number" id="height"></div>
    <div>
      <label for="smoker">هل أنت مدخن؟ (مطلوب)</label>
      <select id="smoker"><option value="" disabled selected>اختر...</option><option value="yes">نعم</option><option value="no">لا</option></select>
    </div>
    <div><label for="vitals">الحرارة/الضغط:</label><input type="text" id="vitals"></div>

    <div class="full-width"><label for="currentMedications">الأدوية الحالية:</label><textarea id="currentMedications"></textarea></div>
    <div class="full-width"><label for="labs">نتائج تحاليل:</label><textarea id="labs"></textarea></div>
    <div class="full-width"><label for="diagnosis">تشخيص سابق:</label><textarea id="diagnosis"></textarea></div>

    <!-- رفع الملفات -->
    <div class="full-width">
      <label>إرفاق صور أو PDF (اختياري):</label>
      <div class="file-upload-container" onclick="document.getElementById('file-upload-input').click();">
        اضغط لاختيار ملفات
        <input type="file" id="file-upload-input" accept="image/*,application/pdf" multiple>
      </div>
      <div id="preview-wrapper"></div>
    </div>
  </div>

  <button onclick="analyzeSymptoms()">تحليل الأعراض</button>

  <div id="notification-area"></div>
  <div id="response-container"></div>
  <p class="disclaimer"><strong>إخلاء مسؤولية:</strong> هذه الأداة للمعلومات الأولية وليست بديلاً عن استشارة الطبيب.</p>
</div>

<!-- ============   البرمجة   ============ -->
<script type="module">
/* Firebase */
const firebaseConfig={apiKey:"AIzaSyDhrkTwtV3Zwbj2k-PCUeXFqaFvtf_UT7s",authDomain:"insurance-check-6cec9.firebaseapp.com",projectId:"insurance-check-6cec9",storageBucket:"insurance-check-6cec9.appspot.com",messagingSenderId:"992769471393",appId:"1:992769471393:web:c8a9400210a0e7901011e0",measurementId:"G-LMS6VRSTT6"};
const {initializeApp}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
const {getAuth,onAuthStateChanged}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
initializeApp(firebaseConfig);
const auth=getAuth();

/* حماية الصفحة */
onAuthStateChanged(auth,u=>{if(!u)location.href="https://www.m2020m.org/login.html";});

/* حقول الحمل الشرطية */
const genderSel=document.getElementById("gender");
const pregSec=document.getElementById("pregnancy-section");
const pregSel=document.getElementById("isPregnant");
const pregMonthSec=document.getElementById("pregnancy-month-section");
genderSel.addEventListener("change",()=>{if(genderSel.value==="female"){pregSec.style.display="block";if(pregSel.value==="yes")pregMonthSec.style.display="block"}else{pregSec.style.display="none";pregMonthSec.style.display="none"}});
pregSel.addEventListener("change",()=>{pregMonthSec.style.display=pregSel.value==="yes"?"block":"none"});

/* رفع الملفات */
let uploadedFiles=[];               // [{data,mime_type,filename}]
const fileInput=document.getElementById("file-upload-input");
const preview=document.getElementById("preview-wrapper");
const toBase64=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(f)});
fileInput.addEventListener("change",async e=>{
  uploadedFiles=[];preview.innerHTML="";
  const files=Array.from(e.target.files).slice(0,10);
  for(const f of files){
    const b64=await toBase64(f);
    uploadedFiles.push({data:b64.split(",")[1],mime_type:f.type,filename:f.name});
    if(f.type.startsWith("image/")){
      const img=document.createElement("img");img.src=b64;img.className="preview-thumb";preview.appendChild(img);
    }else if(f.type==="application/pdf"){
      const div=document.createElement("div");div.className="preview-pdf";div.textContent=f.name;preview.appendChild(div);
    }
  }
});

/* إشعار صغير */
function notify(type,msg){
  const area=document.getElementById("notification-area");area.innerHTML="";
  const d=document.createElement("div");d.className=`notification ${type}`;d.textContent=msg;area.appendChild(d);d.style.display="block";
}

/* استدعاء GPT */
async function analyzeSymptoms(){
  const get=id=>document.getElementById(id).value;
  const data={
    analysisType:"patient",
    symptoms:get("symptoms"),
    age:get("age"),
    gender:get("gender"),
    smoker:get("smoker")==="yes",
    vitals:get("vitals"),
    labs:get("labs"),
    diagnosis:get("diagnosis"),
    currentMedications:get("currentMedications"),
    weight:get("weight"),height:get("height"),
    isPregnant:(get("isPregnant")==="yes"),
    pregnancyMonth:get("pregnancyMonth"),
    imageData:uploadedFiles
  };
  /* تحقق أساسى */
  if(!data.symptoms||!data.age||!data.gender||get("smoker")===""){
    notify("error","الرجاء ملء الحقول المطلوبة.");return;
  }
  notify("info","جاري التحليل، يرجى الانتظار...");

  try{
    if(!auth.currentUser) throw new Error("المستخدم غير مسجل.");
    const token=await auth.currentUser.getIdToken();
    const res=await fetch("/api/gpt",{method:"POST",headers:{"Content-Type":"application/json","Authorization":`Bearer ${token}`},body:JSON.stringify(data)});
    if(!res.ok){const e=await res.json();throw new Error(e.detail||`خطأ ${res.status}`);}
    const json=await res.json();
    if(json.htmlReport){
      document.getElementById("notification-area").innerHTML="";
      const box=document.getElementById("response-container");box.innerHTML=json.htmlReport;box.style.display="block";
    }else throw new Error("لم يصل تقرير من الخادم.");
  }catch(err){notify("error","حدث خطأ: "+err.message);console.error(err);}
}
window.analyzeSymptoms=analyzeSymptoms;
</script>
</body>
</html>
