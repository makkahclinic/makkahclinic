<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>المساعد الصحي الذكي • بوابة المريض</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
:root{
  --primary:#0b63c2; --accent:#00a7c7; --danger:#dc3545;
  --text:#243143; --muted:#6b7a90; --border:#e2e8f0;
  --card:#fff; --bg1:#e9f3ff; --bg2:#f6fbff; --shadow:0 10px 25px rgba(15,57,105,.08);
  --radius:16px; --container:1100px;
}
html,body{height:100%}
body{
  margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  color:var(--text); background: radial-gradient(1200px 800px at 80% 0%, var(--bg1), var(--bg2));
  padding: 2.5rem .9rem 1.5rem;
}
.home-fab{
  position:fixed; top:16px; right:16px; z-index:1000;
  width:56px; height:56px; border-radius:14px;
  background:linear-gradient(135deg,#0b63c2,#00a7c7);
  color:#fff; display:flex; align-items:center; justify-content:center;
  font-size:24px; box-shadow:0 8px 22px rgba(11,99,194,.28); text-decoration:none;
  transition:transform .14s ease, filter .25s ease;
}
.home-fab:hover{ transform:translateY(-1px) scale(1.04); filter:brightness(.98) }

.container{
  max-width:var(--container); margin:56px auto 0; background:var(--card);
  border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  position:relative; overflow:hidden;
}
.top-ribbon{ position:absolute; inset:0 0 auto 0; height:6px; background:linear-gradient(90deg,var(--primary),var(--accent)); }
.shell{ padding: 28px 26px 30px; }

.header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:6px 0 10px; }
.title{ margin:0; font-weight:800; color:#0b4c9c; letter-spacing:.2px; font-size:1.45rem; }
.subtext{ color:var(--muted); font-size:.95rem; margin-top:2px; }

.toolbar{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
.seg{ display:inline-flex; background:#f3f7fb; border:1px solid var(--border); border-radius:999px; padding:4px; }
.seg button{ border:none; background:transparent; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-weight:700; color:#3b5168; }
.seg button.active{ background:#fff; border:1px solid var(--border); color:#0b63c2; }
.btn{ border:none; border-radius:10px; color:#fff; padding:.55rem .9rem; font-weight:700; font-size:.95rem; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.08); }
.btn-print{ background:#0f766e; }

.card{ border:1px solid var(--border); border-radius:14px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.03); padding:16px; margin:14px 0; }
.section-title{ font-size:1.05rem; font-weight:800; color:#243143; display:flex; align-items:center; gap:.5rem; margin-bottom:12px; border-bottom:2px solid #dbe8f5; padding-bottom:.5rem; }
.dot{ width:8px; height:8px; background:var(--accent); border-radius:50%; display:inline-block; }

label{ font-weight:700; display:block; margin:.65rem 0 .35rem; }
.hint{ font-size:.85rem; color:#8496ab; margin-top:.15rem; }
input,select,textarea{
  width:100%; box-sizing:border-box; border:1px solid var(--border); border-radius:10px; padding:.72rem .9rem; background:#fff;
  transition:border-color .2s, box-shadow .2s, background .2s; font-size:1rem;
}
input::placeholder,textarea::placeholder{ color:#9aa8b8; }
input:focus,select:focus,textarea:focus{ outline:none; border-color:#0b63c2; box-shadow:0 0 0 3px rgba(11,99,194,.18); background:#fbfdff; }
textarea{ min-height:120px; resize:vertical; }

.grid{ display:grid; gap:14px; }
.grid-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
.grid-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
.span-2{ grid-column: 1 / -1; }
@media (max-width:920px){ .grid-3{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
@media (max-width:720px){ .grid-2,.grid-3{ grid-template-columns: 1fr; } }

.drop{
  border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; color:#6c7f95;
  transition:border-color .25s, background .25s; cursor:pointer;
}
.drop:hover{ border-color:var(--primary); background:#f6fbff; }
#file-input{ display:none; }
.file-list{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); margin-top:10px; }
.thumb{ position:relative; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; min-height:140px; }
.thumb img{ max-width:100%; max-height:200px; display:block; object-fit:contain; }
.thumb .badge{ position:absolute; inset-block-start:8px; inset-inline-start:8px; background:#eef5ff; color:#1e3a8a; border:1px solid #cfe6ff; font-size:.78rem; padding:.12rem .45rem; border-radius:999px; }
.thumb .remove{ position:absolute; inset-block-start:8px; inset-inline-end:8px; width:30px;height:30px; border:none; border-radius:50%; background:var(--danger); color:#fff; font-size:18px; cursor:pointer; box-shadow:0 4px 10px rgba(220,53,69,.25); }
.thumb .meta{ position:absolute; inset-block-end:8px; inset-inline-start:8px; color:#4b5563; background:#ffffffd0; border-radius:6px; padding:.15rem .4rem; font-size:.78rem; }

.actions{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top: 14px; flex-wrap:wrap; }
.notification{ margin-top:16px; padding:12px 14px; border-radius:10px; display:none; text-align:center; font-weight:600; }
.notification.info{ background:#e9f4ff; color:#114a86; border:1px solid #cfe6ff; }
.notification.error{ background:#fde8ea; color:#7a1f27; border:1px solid #f5c6cb; }
#response-container{ margin-top: 18px; border:1px solid var(--border); border-radius:12px; background:#fff; display:none; box-shadow: var(--shadow); }

@media print{
  body{ padding:0; background:#fff; }
  .home-fab, .toolbar, .actions, .notification{ display:none !important; }
  .container{ border:none; box-shadow:none; }
  #response-container{ display:block !important; border:none; box-shadow:none; margin-top:0; }
}
.hidden{ display:none !important; }
</style>
</head>

<body>
<a class="home-fab" href="https://www.m2020m.org/portal.html" title="العودة إلى البوابة">🏠</a>

<div class="container">
  <div class="top-ribbon"></div>
  <div class="shell">
    <div class="header">
      <div>
        <h1 class="title" id="t-title">المساعد الصحي الذكي • بوابة المريض</h1>
        <div class="subtext" id="t-sub">واجهة إدخال سريرية — Clinical Intake</div>
      </div>
      <div class="toolbar">
        <div class="seg">
          <button id="lang-ar" class="active" type="button" onclick="setLang('ar')">العربية</button>
          <button id="lang-en" type="button" onclick="setLang('en')">English</button>
        </div>
        <button class="btn btn-print" type="button" onclick="window.print()"><i class="fa-solid fa-print"></i>&nbsp;<span id="t-print">PDF / طباعة</span></button>
      </div>
    </div>

    <!-- معلومات المريض -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> <span id="sec-patient">معلومات المريض</span></div>
      <div class="grid grid-3">
        <div>
          <label id="lbl-gender" for="gender">الجنس</label>
          <select id="gender">
            <option value="" disabled selected>اختر</option>
            <option value="male">ذكر</option>
            <option value="female">أنثى</option>
          </select>
        </div>

        <div>
          <label id="lbl-age" for="age">العمر</label>
          <input id="age" type="number" placeholder="مثال: 45" min="0" max="120">
        </div>

        <div id="pregnancy-status-wrap" class="hidden">
          <label id="lbl-preg" for="pregnancy-status">هل المريضة حامل؟</label>
          <select id="pregnancy-status">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="pregnancy-month-wrap" class="hidden">
          <label id="lbl-preg-month" for="pregnancy-month">شهر الحمل</label>
          <input id="pregnancy-month" type="number" min="1" max="9" placeholder="مثال: 5">
        </div>
      </div>
    </div>

    <!-- تفاصيل الحالة -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> <span id="sec-case">تفاصيل الحالة الطبية</span></div>
      <div class="grid grid-2">
        <div class="span-2">
          <label id="lbl-symptoms" for="symptoms">وصف الحالة / الأعراض</label>
          <textarea id="symptoms" class="tall" placeholder="مثال: سعال مزمن منذ 12 أسبوعًا يزيد ليلًا..."></textarea>
        </div>
        <div>
          <label id="lbl-history" for="history">التاريخ المرضي</label>
          <textarea id="history" placeholder="مثال: سكري، ارتفاع ضغط"></textarea>
        </div>
        <div>
          <label id="lbl-diagnosis" for="diagnosis">تشخيصات سابقة (اختياري)</label>
          <textarea id="diagnosis" placeholder="مثال: COPD؟ التهاب جيوب"></textarea>
        </div>
        <div class="span-2">
          <label id="lbl-meds" for="medications">الأدوية الحالية (اختياري)</label>
          <textarea id="medications" placeholder="Metformin 1000 mg..."></textarea>
        </div>
        <div class="span-2">
          <label id="lbl-labs" for="labs">تحاليل / أشعة متوفرة (اختياري)</label>
          <textarea id="labs" placeholder="HbA1c 8.2%، eGFR 52، صورة صدر..."></textarea>
        </div>
      </div>
    </div>

    <!-- الأعراض البصرية -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> <span id="sec-vision">الأعراض البصرية</span></div>
      <div class="grid grid-3">
        <div>
          <label id="lbl-visual-sx" for="visual-symptoms">هل توجد أعراض بصرية؟</label>
          <select id="visual-symptoms">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="va-wrap" class="hidden">
          <label id="lbl-va" for="visual-acuity">قياس حدة البصر</label>
          <input id="visual-acuity" type="text" placeholder="مثال: 6/12 أو 20/40">
          <div class="hint" id="hint-va">أدخل القياس إن وجد (مثال فقط).</div>
        </div>

        <div id="eye-exam-wrap" class="hidden">
          <label id="lbl-eye-exam" for="last-eye-exam">تاريخ آخر فحص عين</label>
          <input id="last-eye-exam" type="date">
        </div>
      </div>
    </div>

    <!-- نمط الحياة/التنفس -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> <span id="sec-life">نمط الحياة والأعراض التنفسية</span></div>
      <div class="grid grid-3">
        <div>
          <label id="lbl-smoker" for="smoker">هل المريض مُدخّن؟</label>
          <select id="smoker">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="smoking-years-wrap" class="hidden">
          <label id="lbl-smoking-years" for="smoking-years">مدة التدخين (بالسنوات)</label>
          <input id="smoking-years" type="number" min="0" max="80" placeholder="مثال: 20">
        </div>

        <div>
          <label id="lbl-cough" for="cough">هل يوجد سعال؟</label>
          <select id="cough">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="cough-blood-wrap" class="hidden">
          <label id="lbl-cough-blood" for="cough-blood">هل يوجد دم في السعال؟</label>
          <select id="cough-blood">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="cough-yellow-wrap" class="hidden">
          <label id="lbl-cough-yellow" for="cough-yellow">هل البلغم أصفر اللون؟</label>
          <select id="cough-yellow">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>

        <div id="cough-dry-wrap" class="hidden">
          <label id="lbl-cough-dry" for="cough-dry">هل السعال جاف؟</label>
          <select id="cough-dry">
            <option value="" disabled selected>اختر</option>
            <option value="yes">نعم</option>
            <option value="no">لا</option>
          </select>
        </div>
      </div>
    </div>

    <!-- الرفع -->
    <div class="card">
      <div class="section-title"><span class="dot"></span> <span id="sec-upload">رفع ملفات (صور/PDF)</span></div>
      <div class="drop" onclick="document.getElementById('file-input').click()" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
        <div id="drop-text">اضغط أو اسحب صور (PNG/JPG) أو PDF هنا</div>
        <input id="file-input" type="file" accept="image/*,.pdf" multiple>
        <div class="hint" id="drop-hint">ننصح بصورة أو صورتين واضحتين — الصور تُضغط تلقائيًا</div>
      </div>
      <div id="file-list" class="file-list"></div>
    </div>

    <!-- أزرار -->
    <div class="actions">
      <button id="analyzeBtn" class="btn" style="background:#0b63c2" onclick="analyzeCase()">
        <i class="fa-solid fa-magnifying-glass"></i>&nbsp;<span id="btn-analyze">تحليل الحالة</span>
      </button>
    </div>

    <div id="notification-area" class="notification info"></div>
    <div id="response-container"></div>
  </div>
</div>

<script>
// ===== i18n dictionary =====
let currentLang = 'ar';
const i18n = {
  ar: {
    docTitle: "المساعد الصحي الذكي • بوابة المريض",
    title: "المساعد الصحي الذكي • بوابة المريض",
    sub: "واجهة إدخال سريرية — Clinical Intake",
    print: "PDF / طباعة",

    sec_patient: "معلومات المريض",
    sec_case: "تفاصيل الحالة الطبية",
    sec_vision: "الأعراض البصرية",
    sec_life: "نمط الحياة والأعراض التنفسية",
    sec_upload: "رفع ملفات (صور/PDF)",

    lbl_gender: "الجنس",
    lbl_age: "العمر",
    lbl_preg: "هل المريضة حامل؟",
    lbl_preg_month: "شهر الحمل",
    lbl_symptoms: "وصف الحالة / الأعراض",
    lbl_history: "التاريخ المرضي",
    lbl_diagnosis: "تشخيصات سابقة (اختياري)",
    lbl_meds: "الأدوية الحالية (اختياري)",
    lbl_labs: "تحاليل / أشعة متوفرة (اختياري)",
    lbl_visual_sx: "هل توجد أعراض بصرية؟",
    lbl_va: "قياس حدة البصر",
    hint_va: "أدخل القياس إن وجد (مثال فقط).",
    lbl_eye_exam: "تاريخ آخر فحص عين",
    lbl_smoker: "هل المريض مُدخّن؟",
    lbl_smoking_years: "مدة التدخين (بالسنوات)",
    lbl_cough: "هل يوجد سعال؟",
    lbl_cough_blood: "هل يوجد دم في السعال؟",
    lbl_cough_yellow: "هل البلغم أصفر اللون؟",
    lbl_cough_dry: "هل السعال جاف؟",

    choose: "اختر", yes: "نعم", no: "لا", male: "ذكر", female: "أنثى",

    ph_age: "مثال: 45",
    ph_preg_month: "مثال: 5",
    ph_symptoms: "مثال: سعال مزمن منذ 12 أسبوعًا يزيد ليلًا...",
    ph_history: "مثال: سكري، ارتفاع ضغط",
    ph_diagnosis: "مثال: COPD؟ التهاب جيوب",
    ph_meds: "Metformin 1000 mg...",
    ph_labs: "HbA1c 8.2%، eGFR 52، صورة صدر...",
    ph_va: "مثال: 6/12 أو 20/40",

    drop_text: "اضغط أو اسحب صور (PNG/JPG) أو PDF هنا",
    drop_hint: "ننصح بصورة أو صورتين واضحتين — الصور تُضغط تلقائيًا",

    btn_analyze: "تحليل الحالة",

    note_analyzing: "جاري التحليل…",
    note_need_input: "يرجى كتابة وصف الحالة أو إرفاق ملف واحد على الأقل.",
    note_error_prefix: "حدث خطأ: "
  },
  en: {
    docTitle: "Smart Health Assistant • Patient Portal",
    title: "Smart Health Assistant • Patient Portal",
    sub: "Clinical Intake Interface",
    print: "PDF / Print",

    sec_patient: "Patient Information",
    sec_case: "Medical Case Details",
    sec_vision: "Visual Symptoms",
    sec_life: "Lifestyle & Respiratory",
    sec_upload: "Upload Files (Images/PDF)",

    lbl_gender: "Gender",
    lbl_age: "Age",
    lbl_preg: "Is the patient pregnant?",
    lbl_preg_month: "Pregnancy Month",
    lbl_symptoms: "Case Description / Symptoms",
    lbl_history: "Medical History",
    lbl_diagnosis: "Previous Diagnoses (optional)",
    lbl_meds: "Current Medications (optional)",
    lbl_labs: "Available Labs / Imaging (optional)",
    lbl_visual_sx: "Any visual symptoms?",
    lbl_va: "Visual Acuity",
    hint_va: "Enter if available (example only).",
    lbl_eye_exam: "Last Eye Exam Date",
    lbl_smoker: "Is the patient a smoker?",
    lbl_smoking_years: "Smoking Duration (years)",
    lbl_cough: "Is there a cough?",
    lbl_cough_blood: "Any blood in sputum?",
    lbl_cough_yellow: "Is the sputum yellow?",
    lbl_cough_dry: "Is the cough dry?",

    choose: "Choose", yes: "Yes", no: "No", male: "Male", female: "Female",

    ph_age: "e.g., 45",
    ph_preg_month: "e.g., 5",
    ph_symptoms: "e.g., Chronic cough for 12 weeks, worse at night…",
    ph_history: "e.g., Type 2 DM, Hypertension",
    ph_diagnosis: "e.g., COPD? Sinusitis",
    ph_meds: "e.g., Metformin 1000 mg…",
    ph_labs: "e.g., HbA1c 8.2%, eGFR 52, Chest X‑ray…",
    ph_va: "e.g., 20/40 or 6/12",

    drop_text: "Click or drop Images (PNG/JPG) or PDF here",
    drop_hint: "Prefer 1–2 clear files — images are auto‑compressed",

    btn_analyze: "Analyze Case",

    note_analyzing: "Analyzing…",
    note_need_input: "Please enter a case description or attach at least one file.",
    note_error_prefix: "Error: "
  }
};

// ===== Language switcher =====
function setLang(lang){
  currentLang = (lang === 'en') ? 'en' : 'ar';
  document.documentElement.dir = (currentLang === 'en') ? 'ltr' : 'rtl';
  document.documentElement.lang = currentLang;
  document.title = i18n[currentLang].docTitle;

  document.getElementById('lang-ar').classList.toggle('active', currentLang==='ar');
  document.getElementById('lang-en').classList.toggle('active', currentLang==='en');

  // Texts
  const tr = i18n[currentLang];
  document.getElementById('t-title').textContent = tr.title;
  document.getElementById('t-sub').textContent = tr.sub;
  document.getElementById('t-print').textContent = tr.print;

  // Section titles
  document.getElementById('sec-patient').textContent = tr.sec_patient;
  document.getElementById('sec-case').textContent = tr.sec_case;
  document.getElementById('sec-vision').textContent = tr.sec_vision;
  document.getElementById('sec-life').textContent = tr.sec_life;
  document.getElementById('sec-upload').textContent = tr.sec_upload;

  // Labels
  const ids = [
    ['lbl-gender','lbl_gender'], ['lbl-age','lbl_age'], ['lbl-preg','lbl_preg'], ['lbl-preg-month','lbl_preg_month'],
    ['lbl-symptoms','lbl_symptoms'], ['lbl-history','lbl_history'], ['lbl-diagnosis','lbl_diagnosis'],
    ['lbl-meds','lbl_meds'], ['lbl-labs','lbl_labs'],
    ['lbl-visual-sx','lbl_visual_sx'], ['lbl-va','lbl_va'], ['lbl-eye-exam','lbl_eye_exam'],
    ['lbl-smoker','lbl_smoker'], ['lbl-smoking-years','lbl_smoking_years'],
    ['lbl-cough','lbl_cough'], ['lbl-cough-blood','lbl_cough_blood'], ['lbl-cough-yellow','lbl_cough_yellow'], ['lbl-cough-dry','lbl_cough_dry'],
  ];
  ids.forEach(([id,key]) => { const el = document.getElementById(id); if (el) el.textContent = tr[key]; });
  const hintVA = document.getElementById('hint-va'); if (hintVA) hintVA.textContent = tr.hint_va;

  // Placeholders
  document.getElementById('age').placeholder = tr.ph_age;
  document.getElementById('pregnancy-month').placeholder = tr.ph_preg_month;
  document.getElementById('symptoms').placeholder = tr.ph_symptoms;
  document.getElementById('history').placeholder = tr.ph_history;
  document.getElementById('diagnosis').placeholder = tr.ph_diagnosis;
  document.getElementById('medications').placeholder = tr.ph_meds;
  document.getElementById('labs').placeholder = tr.ph_labs;
  document.getElementById('visual-acuity').placeholder = tr.ph_va;

  // Drop zone text
  document.getElementById('drop-text').textContent = tr.drop_text;
  document.getElementById('drop-hint').textContent = tr.drop_hint;

  // Button
  document.getElementById('btn-analyze').textContent = tr.btn_analyze;

  // Options: choose/yes/no + gender
  const setChoice = (selId) => {
    const s = document.getElementById(selId);
    if (!s) return;
    const optChoose = s.querySelector('option[value=""]');
    const optYes = s.querySelector('option[value="yes"]');
    const optNo = s.querySelector('option[value="no"]');
    if (optChoose) optChoose.textContent = tr.choose;
    if (optYes) optYes.textContent = tr.yes;
    if (optNo) optNo.textContent = tr.no;
  };
  ['pregnancy-status','visual-symptoms','smoker','cough','cough-blood','cough-yellow','cough-dry'].forEach(setChoice);

  const genderSel = document.getElementById('gender');
  if (genderSel){
    const c = genderSel.querySelector('option[value=""]');
    const m = genderSel.querySelector('option[value="male"]');
    const f = genderSel.querySelector('option[value="female"]');
    if (c) c.textContent = tr.choose; if (m) m.textContent = tr.male; if (f) f.textContent = tr.female;
  }
}

// ===== Conditional UI =====
const genderEl = document.getElementById('gender');
const pregWrap = document.getElementById('pregnancy-status-wrap');
const pregMonthWrap = document.getElementById('pregnancy-month-wrap');
const pregStatusEl = document.getElementById('pregnancy-status');

genderEl.addEventListener('change', ()=>{
  const isFemale = genderEl.value === 'female';
  pregWrap.classList.toggle('hidden', !isFemale);
  pregMonthWrap.classList.add('hidden');
  pregStatusEl.value = "";
  document.getElementById('pregnancy-month').value = "";
});
pregStatusEl.addEventListener('change', ()=>{
  const showMonth = pregStatusEl.value === 'yes';
  pregMonthWrap.classList.toggle('hidden', !showMonth);
  if(!showMonth) document.getElementById('pregnancy-month').value = "";
});

// Vision
const visualSel = document.getElementById('visual-symptoms');
visualSel.addEventListener('change', ()=>{
  const show = visualSel.value === 'yes';
  document.getElementById('va-wrap').classList.toggle('hidden', !show);
  document.getElementById('eye-exam-wrap').classList.toggle('hidden', !show);
  if (!show){
    document.getElementById('visual-acuity').value = "";
    document.getElementById('last-eye-exam').value = "";
  }
});

// Smoking
const smokerSel = document.getElementById('smoker');
smokerSel.addEventListener('change', ()=>{
  const show = smokerSel.value === 'yes';
  document.getElementById('smoking-years-wrap').classList.toggle('hidden', !show);
  if(!show) document.getElementById('smoking-years').value = "";
});

// Cough
const coughSel = document.getElementById('cough');
coughSel.addEventListener('change', ()=>{
  const show = coughSel.value === 'yes';
  document.getElementById('cough-blood-wrap').classList.toggle('hidden', !show);
  document.getElementById('cough-yellow-wrap').classList.toggle('hidden', !show);
  document.getElementById('cough-dry-wrap').classList.toggle('hidden', !show);
  if(!show){ ['cough-blood','cough-yellow','cough-dry'].forEach(id => document.getElementById(id).value=""); }
});

// ===== Uploads =====
const fileInput = document.getElementById('file-input');
const fileListEl = document.getElementById('file-list');
const noteArea = document.getElementById('notification-area');
let filesState = []; let nextId = 1;

fileInput.addEventListener('change', async (e)=>{
  if (!e.target.files?.length) return;
  await addFiles([...(e.target.files)]);
  fileInput.value = "";
});
async function handleDrop(ev){ ev.preventDefault(); await addFiles([...(ev.dataTransfer?.files || [])]); }
async function addFiles(files){
  for (const file of files){
    const type = file.type || '';
    try{
      if (type.startsWith('image/')){
        const { base64, info } = await compressImage(file, { maxW: 1600, maxH: 1600, quality: 0.75 });
        filesState.push({ id: nextId++, name:file.name, type:'image/jpeg', base64, sizeKB:info.sizeKB, isImage:true });
      } else if (type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')){
        const base64 = await fileToBase64(file);
        const sizeKB = (base64.length * 3) / 4 / 1024;
        filesState.push({ id: nextId++, name:file.name, type:'application/pdf', base64, sizeKB, isImage:false });
      } else {
        showNote('error', currentLang==='ar' ? 'يدعم فقط صور و PDF' : 'Only images and PDF are supported');
      }
    } catch(err){
      console.error(err);
      showNote('error', currentLang==='ar' ? 'تعذّر معالجة الملف.' : 'File could not be processed.');
    }
  }
  renderFiles();
}
function renderFiles(){
  fileListEl.innerHTML = '';
  filesState.forEach(f=>{
    const card = document.createElement('div'); card.className='thumb';
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = f.isImage?'IMAGE':'PDF'; card.appendChild(badge);
    const remove = document.createElement('button'); remove.className='remove'; remove.innerHTML='&times;'; remove.onclick=()=>{ filesState = filesState.filter(x=>x.id!==f.id); renderFiles(); }; card.appendChild(remove);
    if (f.isImage){ const img=new Image(); img.src='data:image/jpeg;base64,'+f.base64; card.appendChild(img); }
    else { const ico=document.createElement('div'); ico.style.fontSize='56px'; ico.style.color='#64748b'; ico.textContent='📄'; card.appendChild(ico); }
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`${f.name.substring(0,24)} • ${f.sizeKB.toFixed(0)} KB`; card.appendChild(meta);
    fileListEl.appendChild(card);
  });
}
function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file); }); }
async function compressImage(file,{maxW=1600,maxH=1600,quality=0.75}={}){
  const dataURL=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL; });
  let {width:w,height:h}=img; const ratio=Math.min(maxW/w,maxH/h,1); w=Math.round(w*ratio); h=Math.round(h*ratio);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const out=canvas.toDataURL('image/jpeg',quality); const base64=out.split(',')[1];
  const sizeKB=(base64.length*3)/4/1024; return { base64, info:{ sizeKB } };
}

// ===== Notes & Helpers =====
function showNote(type, text){
  noteArea.className = 'notification ' + (type==='error' ? 'error' : 'info');
  noteArea.textContent = text; noteArea.style.display='block';
}
function clearNote(){ noteArea.style.display='none'; noteArea.textContent=''; }
function val(id){ return (document.getElementById(id)?.value || '').trim() || undefined; }
function sel(id){ const v=document.getElementById(id)?.value; if(v==='yes')return true; if(v==='no')return false; return undefined; }
function num(id){ const v=val(id); if(v===undefined)return undefined; const n=Number(v); return Number.isFinite(n)? n : undefined; }

// ===== Build payload & call API =====
function buildPayload(){
  return {
    uiLang: currentLang,
    age: num('age'),
    gender: val('gender'),
    pregnancyStatus: val('pregnancy-status'),
    pregnancyMonth: num('pregnancy-month'),

    visualSymptoms: sel('visual-symptoms'),
    visualAcuity: val('visual-acuity'),
    lastEyeExamDate: val('last-eye-exam'),

    isSmoker: sel('smoker'),
    smokingYears: num('smoking-years'),
    hasCough: sel('cough'),
    coughBlood: sel('cough-blood'),
    coughYellowSputum: sel('cough-yellow'),
    coughDry: sel('cough-dry'),

    symptoms: val('symptoms'),
    history: val('history'),
    diagnosis: val('diagnosis'),
    medications: val('medications'),
    labs: val('labs'),

    files: filesState.map(f=>({ name:f.name, type:f.type, base64:f.base64 }))
  };
}

async function analyzeCase(){
  const responseContainer = document.getElementById('response-container');
  const btn = document.getElementById('analyzeBtn');
  clearNote(); responseContainer.style.display='none'; responseContainer.innerHTML='';

  const tr = i18n[currentLang];
  const payload = buildPayload();
  if (!payload.symptoms && (!payload.files || payload.files.length===0)){
    showNote('error', tr.note_need_input);
    return;
  }

  showNote('info', tr.note_analyzing);
  btn.disabled = true;
  const controller=new AbortController(); const to=setTimeout(()=>controller.abort(), 90000);

  try{
    const res = await fetch('/api/patient-analyzer.js', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload), signal: controller.signal
    });
    const text = await res.text();
    if (!res.ok){
      let detail = text; try{ const j=JSON.parse(text); detail=j.detail||j.error||text; }catch{}
      if (res.status === 413) detail = currentLang==='ar' ? 'حجم الملفات كبير جدًا. قلّل العدد أو الحجم.' : 'Files are too large. Please reduce size or number.';
      throw new Error(detail);
    }
    const data = JSON.parse(text);
    if (data?.htmlReport){
      clearNote();
      responseContainer.innerHTML = data.htmlReport;
      responseContainer.style.display = 'block';
      responseContainer.scrollIntoView({ behavior:'smooth', block:'start' });
    } else {
      throw new Error(currentLang==='ar' ? 'الرد لم يحتوِ على تقرير HTML.' : 'Response did not contain HTML report.');
    }
  } catch(err){
    console.error(err);
    showNote('error', i18n[currentLang].note_error_prefix + err.message);
  } finally {
    clearTimeout(to);
    btn.disabled = false;
  }
}

// Init
setLang('ar'); // default
window.setLang = setLang;
window.handleDrop = handleDrop;
window.analyzeCase = analyzeCase;
</script>
</body>
</html>
