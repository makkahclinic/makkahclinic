<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تقييم الحالة الطبية - Medical Case & Insurance</title>
  <style>
    :root{
      --primary:#0b63c2; --primary-dark:#084e97; --accent:#00a7c7;
      --danger:#dc3545; --muted:#66768a; --text:#243143; --border:#e2e8f0;
      --card:#fff; --bg1:#e9f3ff; --bg2:#f6fbff; --shadow:0 10px 25px rgba(15,57,105,.08);
      --radius:16px; --home-offset-y:16px; --home-offset-x:16px; --ta-min:220px;
      --container: 1080px;
    }
    html,body{height:100%}
    body{
      margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--text); background: radial-gradient(1200px 800px at 80% 0%, var(--bg1), var(--bg2));
      padding: 2rem .75rem;
    }
    .container{
      max-width: var(--container); margin:0 auto; background:var(--card);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      position:relative; overflow:hidden;
    }
    .shell{ padding: 28px 26px 30px; }
    .top-ribbon{ position:absolute; inset:0 0 auto 0; height:6px; background:linear-gradient(90deg,var(--primary),var(--accent)); }

    /* header */
    .header{
      display:flex; align-items:center; gap:12px; justify-content:space-between; margin:6px 0 16px;
    }
    .title{
      font-weight:800; color:var(--primary); letter-spacing:.2px; margin:0; font-size:1.35rem;
    }
    .subtext{ color:var(--muted); margin-top:2px; font-size:.92rem; }

    .home-icon{
      position:absolute; inset-block-start:var(--home-offset-y); inset-inline-start:var(--home-offset-x);
      width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,#0b63c2,#00a7c7);
      color:#fff;font-size:24px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 6px 18px rgba(11,99,194,.22); cursor:pointer; user-select:none;
      transition:transform .14s ease, filter .25s ease; z-index:5;
    }
    .home-icon:hover{ transform:translateY(-1px) scale(1.04); filter:brightness(.98); }

    /* toolbar */
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; margin-bottom:6px;
    }
    .seg{
      display:inline-flex; background:#f3f7fb; border:1px solid var(--border); border-radius:999px; padding:4px;
    }
    .seg button{ border:none; background:transparent; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-weight:700; color:#3b5168; }
    .seg button.active{ background:#fff; border:1px solid var(--border); color:var(--primary); }

    .btn{
      display:inline-flex; align-items:center; gap:.5rem; border:none; border-radius:10px; color:#fff;
      padding:.55rem .9rem; font-weight:700; font-size:.95rem; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.08);
      transition:transform .06s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); }
    .btn-primary[disabled]{ background: var(--muted); cursor: not-allowed; }
    .btn-danger{ background:var(--danger); }
    .btn-ghost{ background:#eff5fb; color:#114a86; border:1px solid var(--border); }
    .btn-print{ background:#0f766e; } /* teal */

    .card{
      border:1px solid var(--border); border-radius:14px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.03);
      padding:16px; margin:14px 0;
    }
    .section-title{
      font-size:1.02rem; font-weight:800; color:#243143; display:flex; align-items:center; gap:.5rem; margin-bottom:12px;
      border-bottom:2px solid #dbe8f5; padding-bottom:.5rem;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; }

    label{font-weight:700; display:block; margin:.65rem 0 .35rem;}
    .hint{font-size:.86rem; color:#8496ab; margin-top:.15rem;}

    input, select, textarea{
      width:100%; box-sizing:border-box; border:1px solid var(--border); border-radius:10px; padding:.72rem .9rem; background:#fff;
      transition:border-color .2s, box-shadow .2s, background .2s; font-size:1rem;
    }
    input::placeholder, textarea::placeholder{ color:#9aa8b8; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(11,99,194,.18); background:#fbfdff; }
    textarea{ min-height:120px; resize:vertical; }

    .grid{ display:grid; gap:14px; }
    .grid-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
    .grid-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
    @media (max-width:900px){ .grid-3{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
    @media (max-width:720px){ .grid-2,.grid-3{ grid-template-columns: 1fr; } }

    .tall{ min-height: var(--ta-min); }
    .span-2{ grid-column: 1 / -1; }

    /* uploads */
    .drop{
      border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; color:#6c7f95;
      transition:border-color .25s, background .25s; cursor: pointer;
    }
    .drop:hover{ border-color:var(--primary); background:#f6fbff; }
    #file-input{ display:none; }

    .file-list{ display:grid; gap:10px; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); margin-top:10px; }
    .thumb{
      position:relative; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff;
      display:flex; align-items:center; justify-content:center; min-height:140px;
    }
    .thumb img{ max-width:100%; max-height:200px; display:block; object-fit: contain; }
    .thumb .badge{
      position:absolute; inset-block-start:8px; inset-inline-start:8px; background:#eef5ff; color:#1e3a8a;
      border:1px solid #cfe6ff; font-size:.78rem; padding:.12rem .45rem; border-radius:999px;
    }
    .thumb .remove{
      position:absolute; inset-block-start:8px; inset-inline-end:8px; width:30px;height:30px; border:none; border-radius:50%;
      background:var(--danger); color:#fff; font-size:18px; cursor:pointer; box-shadow:0 4px 10px rgba(220,53,69,.25);
    }
    .thumb .meta{ position:absolute; inset-block-end:8px; inset-inline-start:8px; color:#4b5563; background:#ffffffd0; border-radius:6px; padding:.15rem .4rem; font-size:.78rem; }

    .actions{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top: 20px; flex-wrap:wrap; }

    .notification{ margin-top:16px; padding:12px 14px; border-radius:10px; display:none; text-align:center; font-weight:600; }
    .notification.info{ background:#e9f4ff; color:#114a86; border:1px solid #cfe6ff; }
    .notification.error{ background:#fde8ea; color:#7a1f27; border:1px solid #f5c6cb; }

    #response-container{ margin-top: 24px; border:1px solid var(--border); border-radius:12px; background:#fff; display:none; box-shadow: var(--shadow); }

    /* print/export */
    @media print{
      body{ padding:0; background:#fff; }
      .home-icon, .header, .card, .actions, .notification{ display:none !important; }
      .container{ border:none; box-shadow:none; padding: 0;}
      .shell{ padding: 0; }
      #response-container{ display:block !important; border: none; box-shadow: none; margin-top: 0; }
    }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-ribbon"></div>
    <div class="home-icon" title="الشاشة الرئيسية / Home" onclick="goToHome()">🏠</div>

    <div class="shell">
      <div class="header">
        <div>
          <h1 class="title" id="app-title">تقييم الحالة الطبية • Medical Case</h1>
          <div class="subtext" id="app-sub">واجهة إدخال سريرية — Clinical intake interface</div>
        </div>

        <div class="toolbar">
          <div class="seg" role="tablist" aria-label="Language">
            <button id="lang-ar" class="active" onclick="setLang('ar')" type="button">العربية</button>
            <button id="lang-en" onclick="setLang('en')" type="button">English</button>
          </div>
          <button class="btn-print" type="button" onclick="window.print()">PDF / طباعة</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-t="pinfo">معلومات المريض</span> / <span data-t="pinfo_en" class="hidden">Patient Info</span></div>
        <div class="grid grid-3">
          <div>
            <label for="gender" data-t="genderLbl">الجنس</label><label for="gender" data-t="genderLbl_en" class="hidden">Gender</label>
            <select id="gender">
              <option value="" selected disabled data-t="choose">اختر</option><option value="" selected disabled data-t="choose_en" class="hidden">Choose</option>
              <option value="male" data-t="male">ذكر</option><option value="male" data-t="male_en" class="hidden">Male</option>
              <option value="female" data-t="female">أنثى</option><option value="female" data-t="female_en" class="hidden">Female</option>
            </select>
          </div>

          <div>
            <label for="age" data-t="ageLbl">العمر</label><label for="age" data-t="ageLbl_en" class="hidden">Age</label>
            <input id="age" type="number" placeholder="e.g., 63">
          </div>

          <div id="pregnancy-status-wrap" class="hidden">
            <label for="pregnancy-status" data-t="pregLbl">هل المريضة حامل؟</label><label for="pregnancy-status" data-t="pregLbl_en" class="hidden">Pregnant?</label>
            <select id="pregnancy-status">
              <option value="" selected disabled data-t="choose">اختر</option><option value="" selected disabled data-t="choose_en" class="hidden">Choose</option>
              <option value="yes" data-t="yes">نعم</option><option value="yes" data-t="yes_en" class="hidden">Yes</option>
              <option value="no" data-t="no">لا</option><option value="no" data-t="no_en" class="hidden">No</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-t="details">تفاصيل الحالة الطبية</span> / <span data-t="details_en" class="hidden">Medical Case Details</span></div>
        <div class="grid grid-2">
            <div class="span-2">
                <label for="case-description" data-t="caseLbl">الشكوى الرئيسية ووصف الحالة</label><label for="case-description" data-t="caseLbl_en" class="hidden">Main Complaint & Case Description</label>
                <textarea id="case-description" class="tall" placeholder="مثال: سعال مزمن منذ 3 أشهر مع بلغم، يزداد ليلاً..."></textarea>
            </div>
            <div>
                <label for="history" data-t="histLbl">التاريخ المرضي</label><label for="history" data-t="histLbl_en" class="hidden">Medical History</label>
                <textarea id="history" placeholder="مثال: سكري نوع ثاني، ارتفاع ضغط الدم"></textarea>
            </div>
            <div>
                <label for="medications-procedures" data-t="medLbl">الأدوية الحالية</label><label for="medications-procedures" data-t="medLbl_en" class="hidden">Current Medications</label>
                <textarea id="medications-procedures" placeholder="مثال: Metformin 1000mg, Lisinopril 10mg"></textarea>
            </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title"><span class="dot"></span> <span data-t="uploads">رفع ملفات (وصفات، تقارير، صور)</span> / <span data-t="uploads_en" class="hidden">Upload Files (Rx, Reports, Images)</span></div>
        <div class="drop" onclick="document.getElementById('file-input').click()" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
          <div data-t="drop">اضغط أو اسحب صور (PNG/JPG) أو PDF هنا</div>
          <div class="hidden" data-t="drop_en">Click or drop images (PNG/JPG) or PDF here</div>
          <input id="file-input" type="file" accept="image/*,.pdf" multiple>
          <div class="hint" data-t="dropHint">ملف أو اثنين بوضوح كافٍ.</div>
          <div class="hint hidden" data-t="dropHint_en">1–2 clear files are preferred.</div>
        </div>
        <div id="file-list" class="file-list"></div>
      </div>

      <div class="actions">
        <button id="analyzeBtn" class="btn btn-primary" onclick="analyzeCase()">
          <span data-t="analyze">تحليل الحالة</span><span data-t="analyze_en" class="hidden">Analyze Case</span>
        </button>
        <button class="btn btn-danger" onclick="logout()">
          <span data-t="logout">تسجيل الخروج</span><span data-t="logout_en" class="hidden">Logout</span>
        </button>
      </div>

      <div id="notification-area" class="notification"></div>
      <div id="response-container"></div>
    </div>
  </div>

  <script>
    let currentLang = 'ar';
    const translations = {
        ar: { analyzing: 'جاري التحليل… الرجاء الانتظار.', provideDetails: 'يرجى إدخال وصف للحالة أو إرفاق ملف واحد على الأقل.', error: 'حدث خطأ: ', fileProcessError: 'حدث خطأ أثناء معالجة الملف.', unsupportedFile: 'نوع الملف غير مدعوم. يدعم فقط الصور و PDF.', payloadTooLarge: 'حجم الملفات كبير جدًا. يرجى تقليل حجم أو عدد الملفات.', loggedOut: 'تم تسجيل الخروج.' },
        en: { analyzing: 'Analyzing… Please wait.', provideDetails: 'Please provide a case description or attach at least one file.', error: 'An error occurred: ', fileProcessError: 'File could not be processed.', unsupportedFile: 'Unsupported file type. Only images and PDF are supported.', payloadTooLarge: 'File payload is too large. Please reduce the size or number of files.', loggedOut: 'Logged out.' }
    };

    function T(key) {
        return translations[currentLang][key] || key;
    }

    function setLang(lang){
      currentLang = lang;
      document.querySelectorAll('[data-t]').forEach(el => {
        const key = el.getAttribute('data-t');
        el.classList.toggle('hidden', !key.endsWith(`_${lang}`) && !key.includes('_en') && lang === 'en');
        if (!key.endsWith('_en')) el.classList.toggle('hidden', lang === 'en');
      });
      document.querySelectorAll(`[data-t$="_${lang}"]`).forEach(el => el.classList.remove('hidden'));
      
      document.getElementById('lang-ar').classList.toggle('active', lang==='ar');
      document.getElementById('lang-en').classList.toggle('active', lang==='en');
      
      document.documentElement.dir = (lang==='en') ? 'ltr' : 'rtl';
      document.documentElement.lang = lang;
    }

    /************** conditional fields **************/
    const genderEl = document.getElementById('gender');
    const pregStatWrap = document.getElementById('pregnancy-status-wrap');
    genderEl.addEventListener('change', () => {
      pregStatWrap.classList.toggle('hidden', genderEl.value !== 'female');
      if (genderEl.value !== 'female') {
          document.getElementById('pregnancy-status').value = "";
      }
    });

    /************** uploads (images + PDFs) **************/
    const fileInput = document.getElementById('file-input');
    const fileListEl = document.getElementById('file-list');
    let filesState = [];
    let nextId = 1;

    fileInput.addEventListener('change', async (e) => {
      if (!e.target.files?.length) return;
      await addFiles([...e.target.files]);
      fileInput.value = "";
    });

    async function handleDrop(ev){
      ev.preventDefault();
      await addFiles([...(ev.dataTransfer?.files || [])]);
    }

    async function addFiles(files){
      for (const file of files){
        const type = file.type || '';
        try{
          if (type.startsWith('image/')){
            const { base64, info } = await compressImage(file, { maxW: 1600, maxH: 1600, quality: 0.75 });
            filesState.push({ id: nextId++, name:file.name, type:'image/jpeg', base64, width:info.w, height:info.h, sizeKB:info.sizeKB, isImage:true });
          } else if (type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')){
            const base64 = await fileToBase64(file);
            const sizeKB = (base64.length * 3) / 4 / 1024;
            filesState.push({ id: nextId++, name:file.name, type:'application/pdf', base64, sizeKB, isImage:false });
          } else {
            showNote('error', T('unsupportedFile'));
          }
        }catch(err){
          console.error(err);
          showNote('error', T('fileProcessError'));
        }
      }
      renderFiles();
    }

    function renderFiles(){
      fileListEl.innerHTML = '';
      filesState.forEach(f=>{
        const card = document.createElement('div');
        card.className = 'thumb';
        const badge = document.createElement('div');
        badge.className='badge';
        badge.textContent = f.isImage ? 'IMAGE' : 'PDF';
        card.appendChild(badge);

        const remove = document.createElement('button');
        remove.className='remove'; remove.innerHTML='&times;';
        remove.title='Remove'; remove.onclick=()=>{ filesState = filesState.filter(x=>x.id!==f.id); renderFiles(); };
        card.appendChild(remove);

        if (f.isImage){
          const img = new Image();
          img.src = 'data:image/jpeg;base64,' + f.base64;
          card.appendChild(img);
        } else {
          const pdfIcon = document.createElement('div');
          pdfIcon.style.fontSize='56px'; pdfIcon.style.color='#64748b'; pdfIcon.textContent='📄';
          card.appendChild(pdfIcon);
        }
        const meta = document.createElement('div');
        meta.className='meta';
        meta.textContent = `${f.name.substring(0,20)}... (${f.sizeKB.toFixed(0)} KB)`;
        card.appendChild(meta);
        fileListEl.appendChild(card);
      });
    }

    function fileToBase64(file){
      return new Promise((res, rej) => {
        const r = new FileReader(); r.onload = ()=> res(r.result.split(',')[1]); r.onerror = rej; r.readAsDataURL(file);
      });
    }

    async function compressImage(file, { maxW=1600, maxH=1600, quality=0.75 } = {}){
      const dataURL = await new Promise(res => { const r = new FileReader(); r.onload = ()=> res(r.result); r.readAsDataURL(file); });
      const img = await new Promise(res => { const i = new Image(); i.onload = ()=> res(i); i.src = dataURL; });
      let { width:w, height:h } = img;
      const ratio = Math.min(maxW/w, maxH/h, 1);
      w = Math.round(w*ratio); h = Math.round(h*ratio);
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      const out = canvas.toDataURL('image/jpeg', quality);
      const base64 = out.split(',')[1];
      const sizeKB = (base64.length * 3) / 4 / 1024;
      return { base64, info:{ w,h,sizeKB } };
    }

    /************** notifications & routing **************/
    const noteArea = document.getElementById('notification-area');
    function showNote(type, text, duration = 5000){
      noteArea.className = 'notification ' + (type === 'error' ? 'error' : 'info');
      noteArea.textContent = text;
      noteArea.style.display = 'block';
      if(duration > 0) setTimeout(clearNote, duration);
    }
    function clearNote(){ noteArea.style.display='none'; noteArea.textContent=''; }
    function goToHome(){ window.location.href = 'https://www.m2020m.org/portal.html'; }
    function logout(){ showNote('info', T('loggedOut')); }

    /************** analyze (API call) **************/
    function buildPayload(){
      return {
        uiLang: currentLang,
        caseDescription: val('case-description'),
        medicalHistory: val('history'),
        currentMedications: val('medications-procedures'),
        age: val('age'),
        gender: val('gender'),
        isPregnant: document.getElementById('gender').value === 'female' ? val('pregnancy-status') : undefined,
        files: filesState.map(f=>({name:f.name, type:f.type, base64:f.base64}))
      };
    }
    function val(id){ return (document.getElementById(id)?.value || '').trim() || undefined; }

    async function analyzeCase(){
      const responseContainer = document.getElementById('response-container');
      const btn = document.getElementById('analyzeBtn');
      clearNote(); responseContainer.style.display='none'; responseContainer.innerHTML='';

      const payload = buildPayload();
      if (!payload.caseDescription && (!payload.files || payload.files.length === 0)){
        showNote('error', T('provideDetails'));
        return;
      }

      showNote('info', T('analyzing'), 0); // show indefinitely until cleared
      btn.disabled = true;

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 90000); // 90-second timeout

      try{
        // THIS IS THE CORRECTED API ENDPOINT
        const res = await fetch('/api/patient-analyzer.js', {
          method:'POST', 
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload), 
          signal: controller.signal
        });
        
        const text = await res.text();
        if (!res.ok){
          if (res.status === 413) throw new Error(T('payloadTooLarge'));
          let errorDetail = text;
          try {
              const errorJson = JSON.parse(text);
              errorDetail = errorJson.detail || errorJson.error || text;
          } catch {}
          throw new Error(`HTTP ${res.status}: ${errorDetail}`);
        }
        
        const data = JSON.parse(text);

        if (data?.htmlReport){
          clearNote();
          responseContainer.innerHTML = data.htmlReport;
          responseContainer.style.display = 'block';
          responseContainer.scrollIntoView({ behavior:'smooth', block:'start' });
        } else {
          throw new Error('Server response did not contain the expected report.');
        }
      } catch(err){
        console.error(err);
        showNote('error', T('error') + err.message);
      } finally {
        clearTimeout(timeoutId);
        btn.disabled = false;
        if (noteArea.textContent === T('analyzing')) {
          clearNote();
        }
      }
    }

    // Initial setup
    setLang('ar');
    window.setLang = setLang;
    window.goToHome = goToHome;
    window.logout = logout;
    window.analyzeCase = analyzeCase;
    window.handleDrop = handleDrop;
  </script>
</body>
</html>
